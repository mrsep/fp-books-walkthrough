%!PS-Adobe-2.0
%%Creator: dvips(k) 5.86 Copyright 1999 Radical Eye Software
%%Title: mb.dvi
%%Pages: 426
%%PageOrder: Ascend
%%BoundingBox: 0 0 612 792
%%DocumentFonts: Times-Roman CMMI10 Times-Bold Times-Italic CMTT10
%%+ CMSY10 CMTT9 CMTT8 CMR10 CMTT12 CMMI9 CMR9 CMSY9 CMMI7
%%EndComments
%DVIPSWebPage: (www.radicaleye.com)
%DVIPSCommandLine: dvips mb.dvi
%DVIPSParameters: dpi=600, compressed
%DVIPSSource:  TeX output 2002.02.01:1408
%%BeginProcSet: texc.pro
%!
/TeXDict 300 dict def TeXDict begin/N{def}def/B{bind def}N/S{exch}N/X{S
N}B/A{dup}B/TR{translate}N/isls false N/vsize 11 72 mul N/hsize 8.5 72
mul N/landplus90{false}def/@rigin{isls{[0 landplus90{1 -1}{-1 1}ifelse 0
0 0]concat}if 72 Resolution div 72 VResolution div neg scale isls{
landplus90{VResolution 72 div vsize mul 0 exch}{Resolution -72 div hsize
mul 0}ifelse TR}if Resolution VResolution vsize -72 div 1 add mul TR[
matrix currentmatrix{A A round sub abs 0.00001 lt{round}if}forall round
exch round exch]setmatrix}N/@landscape{/isls true N}B/@manualfeed{
statusdict/manualfeed true put}B/@copies{/#copies X}B/FMat[1 0 0 -1 0 0]
N/FBB[0 0 0 0]N/nn 0 N/IEn 0 N/ctr 0 N/df-tail{/nn 8 dict N nn begin
/FontType 3 N/FontMatrix fntrx N/FontBBox FBB N string/base X array
/BitMaps X/BuildChar{CharBuilder}N/Encoding IEn N end A{/foo setfont}2
array copy cvx N load 0 nn put/ctr 0 N[}B/sf 0 N/df{/sf 1 N/fntrx FMat N
df-tail}B/dfs{div/sf X/fntrx[sf 0 0 sf neg 0 0]N df-tail}B/E{pop nn A
definefont setfont}B/Cw{Cd A length 5 sub get}B/Ch{Cd A length 4 sub get
}B/Cx{128 Cd A length 3 sub get sub}B/Cy{Cd A length 2 sub get 127 sub}
B/Cdx{Cd A length 1 sub get}B/Ci{Cd A type/stringtype ne{ctr get/ctr ctr
1 add N}if}B/id 0 N/rw 0 N/rc 0 N/gp 0 N/cp 0 N/G 0 N/CharBuilder{save 3
1 roll S A/base get 2 index get S/BitMaps get S get/Cd X pop/ctr 0 N Cdx
0 Cx Cy Ch sub Cx Cw add Cy setcachedevice Cw Ch true[1 0 0 -1 -.1 Cx
sub Cy .1 sub]/id Ci N/rw Cw 7 add 8 idiv string N/rc 0 N/gp 0 N/cp 0 N{
rc 0 ne{rc 1 sub/rc X rw}{G}ifelse}imagemask restore}B/G{{id gp get/gp
gp 1 add N A 18 mod S 18 idiv pl S get exec}loop}B/adv{cp add/cp X}B
/chg{rw cp id gp 4 index getinterval putinterval A gp add/gp X adv}B/nd{
/cp 0 N rw exit}B/lsh{rw cp 2 copy get A 0 eq{pop 1}{A 255 eq{pop 254}{
A A add 255 and S 1 and or}ifelse}ifelse put 1 adv}B/rsh{rw cp 2 copy
get A 0 eq{pop 128}{A 255 eq{pop 127}{A 2 idiv S 128 and or}ifelse}
ifelse put 1 adv}B/clr{rw cp 2 index string putinterval adv}B/set{rw cp
fillstr 0 4 index getinterval putinterval adv}B/fillstr 18 string 0 1 17
{2 copy 255 put pop}for N/pl[{adv 1 chg}{adv 1 chg nd}{1 add chg}{1 add
chg nd}{adv lsh}{adv lsh nd}{adv rsh}{adv rsh nd}{1 add adv}{/rc X nd}{
1 add set}{1 add clr}{adv 2 chg}{adv 2 chg nd}{pop nd}]A{bind pop}
forall N/D{/cc X A type/stringtype ne{]}if nn/base get cc ctr put nn
/BitMaps get S ctr S sf 1 ne{A A length 1 sub A 2 index S get sf div put
}if put/ctr ctr 1 add N}B/I{cc 1 add D}B/bop{userdict/bop-hook known{
bop-hook}if/SI save N @rigin 0 0 moveto/V matrix currentmatrix A 1 get A
mul exch 0 get A mul add .99 lt{/QV}{/RV}ifelse load def pop pop}N/eop{
SI restore userdict/eop-hook known{eop-hook}if showpage}N/@start{
userdict/start-hook known{start-hook}if pop/VResolution X/Resolution X
1000 div/DVImag X/IEn 256 array N 2 string 0 1 255{IEn S A 360 add 36 4
index cvrs cvn put}for pop 65781.76 div/vsize X 65781.76 div/hsize X}N
/p{show}N/RMat[1 0 0 -1 0 0]N/BDot 260 string N/Rx 0 N/Ry 0 N/V{}B/RV/v{
/Ry X/Rx X V}B statusdict begin/product where{pop false[(Display)(NeXT)
(LaserWriter 16/600)]{A length product length le{A length product exch 0
exch getinterval eq{pop true exit}if}{pop}ifelse}forall}{false}ifelse
end{{gsave TR -.1 .1 TR 1 1 scale Rx Ry false RMat{BDot}imagemask
grestore}}{{gsave TR -.1 .1 TR Rx Ry scale 1 1 false RMat{BDot}
imagemask grestore}}ifelse B/QV{gsave newpath transform round exch round
exch itransform moveto Rx 0 rlineto 0 Ry neg rlineto Rx neg 0 rlineto
fill grestore}B/a{moveto}B/delta 0 N/tail{A/delta X 0 rmoveto}B/M{S p
delta add tail}B/b{S p tail}B/c{-4 M}B/d{-3 M}B/e{-2 M}B/f{-1 M}B/g{0 M}
B/h{1 M}B/i{2 M}B/j{3 M}B/k{4 M}B/w{0 rmoveto}B/l{p -4 w}B/m{p -3 w}B/n{
p -2 w}B/o{p -1 w}B/q{p 1 w}B/r{p 2 w}B/s{p 3 w}B/t{p 4 w}B/x{0 S
rmoveto}B/y{3 2 roll p a}B/bos{/SS save N}B/eos{SS restore}B end

%%EndProcSet
%%BeginProcSet: 8r.enc
% @@psencodingfile@{
%   author = "S. Rahtz, P. MacKay, Alan Jeffrey, B. Horn, K. Berry",
%   version = "0.6",
%   date = "1 July 1998",
%   filename = "8r.enc",
%   email = "tex-fonts@@tug.org",
%   docstring = "Encoding for TrueType or Type 1 fonts
%                to be used with TeX."
% @}
% 
% Idea is to have all the characters normally included in Type 1 fonts
% available for typesetting. This is effectively the characters in Adobe
% Standard Encoding + ISO Latin 1 + extra characters from Lucida.
% 
% Character code assignments were made as follows:
% 
% (1) the Windows ANSI characters are almost all in their Windows ANSI
% positions, because some Windows users cannot easily reencode the
% fonts, and it makes no difference on other systems. The only Windows
% ANSI characters not available are those that make no sense for
% typesetting -- rubout (127 decimal), nobreakspace (160), softhyphen
% (173). quotesingle and grave are moved just because it's such an
% irritation not having them in TeX positions.
% 
% (2) Remaining characters are assigned arbitrarily to the lower part
% of the range, avoiding 0, 10 and 13 in case we meet dumb software.
% 
% (3) Y&Y Lucida Bright includes some extra text characters; in the
% hopes that other PostScript fonts, perhaps created for public
% consumption, will include them, they are included starting at 0x12.
% 
% (4) Remaining positions left undefined are for use in (hopefully)
% upward-compatible revisions, if someday more characters are generally
% available.
% 
% (5) hyphen appears twice for compatibility with both 
% ASCII and Windows.
% 
/TeXBase1Encoding [
% 0x00 (encoded characters from Adobe Standard not in Windows 3.1)
  /.notdef /dotaccent /fi /fl
  /fraction /hungarumlaut /Lslash /lslash
  /ogonek /ring /.notdef
  /breve /minus /.notdef 
% These are the only two remaining unencoded characters, so may as
% well include them.
  /Zcaron /zcaron 
% 0x10
 /caron /dotlessi 
% (unusual TeX characters available in, e.g., Lucida Bright)
 /dotlessj /ff /ffi /ffl 
 /.notdef /.notdef /.notdef /.notdef
 /.notdef /.notdef /.notdef /.notdef
 % very contentious; it's so painful not having quoteleft and quoteright
 % at 96 and 145 that we move the things normally found there to here.
 /grave /quotesingle 
% 0x20 (ASCII begins)
 /space /exclam /quotedbl /numbersign
 /dollar /percent /ampersand /quoteright
 /parenleft /parenright /asterisk /plus /comma /hyphen /period /slash
% 0x30
 /zero /one /two /three /four /five /six /seven
 /eight /nine /colon /semicolon /less /equal /greater /question
% 0x40
 /at /A /B /C /D /E /F /G /H /I /J /K /L /M /N /O
% 0x50
 /P /Q /R /S /T /U /V /W
 /X /Y /Z /bracketleft /backslash /bracketright /asciicircum /underscore
% 0x60
 /quoteleft /a /b /c /d /e /f /g /h /i /j /k /l /m /n /o
% 0x70
 /p /q /r /s /t /u /v /w
 /x /y /z /braceleft /bar /braceright /asciitilde
 /.notdef % rubout; ASCII ends
% 0x80
 /.notdef /.notdef /quotesinglbase /florin
 /quotedblbase /ellipsis /dagger /daggerdbl
 /circumflex /perthousand /Scaron /guilsinglleft
 /OE /.notdef /.notdef /.notdef
% 0x90
 /.notdef /.notdef /.notdef /quotedblleft
 /quotedblright /bullet /endash /emdash
 /tilde /trademark /scaron /guilsinglright
 /oe /.notdef /.notdef /Ydieresis
% 0xA0
 /.notdef % nobreakspace
 /exclamdown /cent /sterling
 /currency /yen /brokenbar /section
 /dieresis /copyright /ordfeminine /guillemotleft
 /logicalnot
 /hyphen % Y&Y (also at 45); Windows' softhyphen
 /registered
 /macron
% 0xD0
 /degree /plusminus /twosuperior /threesuperior
 /acute /mu /paragraph /periodcentered
 /cedilla /onesuperior /ordmasculine /guillemotright
 /onequarter /onehalf /threequarters /questiondown
% 0xC0
 /Agrave /Aacute /Acircumflex /Atilde /Adieresis /Aring /AE /Ccedilla
 /Egrave /Eacute /Ecircumflex /Edieresis
 /Igrave /Iacute /Icircumflex /Idieresis
% 0xD0
 /Eth /Ntilde /Ograve /Oacute
 /Ocircumflex /Otilde /Odieresis /multiply
 /Oslash /Ugrave /Uacute /Ucircumflex
 /Udieresis /Yacute /Thorn /germandbls
% 0xE0
 /agrave /aacute /acircumflex /atilde
 /adieresis /aring /ae /ccedilla
 /egrave /eacute /ecircumflex /edieresis
 /igrave /iacute /icircumflex /idieresis
% 0xF0
 /eth /ntilde /ograve /oacute
 /ocircumflex /otilde /odieresis /divide
 /oslash /ugrave /uacute /ucircumflex
 /udieresis /yacute /thorn /ydieresis
] def

%%EndProcSet
%%BeginProcSet: texps.pro
%!
TeXDict begin/rf{findfont dup length 1 add dict begin{1 index/FID ne 2
index/UniqueID ne and{def}{pop pop}ifelse}forall[1 index 0 6 -1 roll
exec 0 exch 5 -1 roll VResolution Resolution div mul neg 0 0]/Metrics
exch def dict begin Encoding{exch dup type/integertype ne{pop pop 1 sub
dup 0 le{pop}{[}ifelse}{FontMatrix 0 get div Metrics 0 get div def}
ifelse}forall Metrics/Metrics currentdict end def[2 index currentdict
end definefont 3 -1 roll makefont/setfont cvx]cvx def}def/ObliqueSlant{
dup sin S cos div neg}B/SlantFont{4 index mul add}def/ExtendFont{3 -1
roll mul exch}def/ReEncodeFont{CharStrings rcheck{/Encoding false def
dup[exch{dup CharStrings exch known not{pop/.notdef/Encoding true def}
if}forall Encoding{]exch pop}{cleartomark}ifelse}if/Encoding exch def}
def end

%%EndProcSet
%%BeginProcSet: special.pro
%!
TeXDict begin/SDict 200 dict N SDict begin/@SpecialDefaults{/hs 612 N
/vs 792 N/ho 0 N/vo 0 N/hsc 1 N/vsc 1 N/ang 0 N/CLIP 0 N/rwiSeen false N
/rhiSeen false N/letter{}N/note{}N/a4{}N/legal{}N}B/@scaleunit 100 N
/@hscale{@scaleunit div/hsc X}B/@vscale{@scaleunit div/vsc X}B/@hsize{
/hs X/CLIP 1 N}B/@vsize{/vs X/CLIP 1 N}B/@clip{/CLIP 2 N}B/@hoffset{/ho
X}B/@voffset{/vo X}B/@angle{/ang X}B/@rwi{10 div/rwi X/rwiSeen true N}B
/@rhi{10 div/rhi X/rhiSeen true N}B/@llx{/llx X}B/@lly{/lly X}B/@urx{
/urx X}B/@ury{/ury X}B/magscale true def end/@MacSetUp{userdict/md known
{userdict/md get type/dicttype eq{userdict begin md length 10 add md
maxlength ge{/md md dup length 20 add dict copy def}if end md begin
/letter{}N/note{}N/legal{}N/od{txpose 1 0 mtx defaultmatrix dtransform S
atan/pa X newpath clippath mark{transform{itransform moveto}}{transform{
itransform lineto}}{6 -2 roll transform 6 -2 roll transform 6 -2 roll
transform{itransform 6 2 roll itransform 6 2 roll itransform 6 2 roll
curveto}}{{closepath}}pathforall newpath counttomark array astore/gc xdf
pop ct 39 0 put 10 fz 0 fs 2 F/|______Courier fnt invertflag{PaintBlack}
if}N/txpose{pxs pys scale ppr aload pop por{noflips{pop S neg S TR pop 1
-1 scale}if xflip yflip and{pop S neg S TR 180 rotate 1 -1 scale ppr 3
get ppr 1 get neg sub neg ppr 2 get ppr 0 get neg sub neg TR}if xflip
yflip not and{pop S neg S TR pop 180 rotate ppr 3 get ppr 1 get neg sub
neg 0 TR}if yflip xflip not and{ppr 1 get neg ppr 0 get neg TR}if}{
noflips{TR pop pop 270 rotate 1 -1 scale}if xflip yflip and{TR pop pop
90 rotate 1 -1 scale ppr 3 get ppr 1 get neg sub neg ppr 2 get ppr 0 get
neg sub neg TR}if xflip yflip not and{TR pop pop 90 rotate ppr 3 get ppr
1 get neg sub neg 0 TR}if yflip xflip not and{TR pop pop 270 rotate ppr
2 get ppr 0 get neg sub neg 0 S TR}if}ifelse scaleby96{ppr aload pop 4
-1 roll add 2 div 3 1 roll add 2 div 2 copy TR .96 dup scale neg S neg S
TR}if}N/cp{pop pop showpage pm restore}N end}if}if}N/normalscale{
Resolution 72 div VResolution 72 div neg scale magscale{DVImag dup scale
}if 0 setgray}N/psfts{S 65781.76 div N}N/startTexFig{/psf$SavedState
save N userdict maxlength dict begin/magscale true def normalscale
currentpoint TR/psf$ury psfts/psf$urx psfts/psf$lly psfts/psf$llx psfts
/psf$y psfts/psf$x psfts currentpoint/psf$cy X/psf$cx X/psf$sx psf$x
psf$urx psf$llx sub div N/psf$sy psf$y psf$ury psf$lly sub div N psf$sx
psf$sy scale psf$cx psf$sx div psf$llx sub psf$cy psf$sy div psf$ury sub
TR/showpage{}N/erasepage{}N/copypage{}N/p 3 def @MacSetUp}N/doclip{
psf$llx psf$lly psf$urx psf$ury currentpoint 6 2 roll newpath 4 copy 4 2
roll moveto 6 -1 roll S lineto S lineto S lineto closepath clip newpath
moveto}N/endTexFig{end psf$SavedState restore}N/@beginspecial{SDict
begin/SpecialSave save N gsave normalscale currentpoint TR
@SpecialDefaults count/ocount X/dcount countdictstack N}N/@setspecial{
CLIP 1 eq{newpath 0 0 moveto hs 0 rlineto 0 vs rlineto hs neg 0 rlineto
closepath clip}if ho vo TR hsc vsc scale ang rotate rwiSeen{rwi urx llx
sub div rhiSeen{rhi ury lly sub div}{dup}ifelse scale llx neg lly neg TR
}{rhiSeen{rhi ury lly sub div dup scale llx neg lly neg TR}if}ifelse
CLIP 2 eq{newpath llx lly moveto urx lly lineto urx ury lineto llx ury
lineto closepath clip}if/showpage{}N/erasepage{}N/copypage{}N newpath}N
/@endspecial{count ocount sub{pop}repeat countdictstack dcount sub{end}
repeat grestore SpecialSave restore end}N/@defspecial{SDict begin}N
/@fedspecial{end}B/li{lineto}B/rl{rlineto}B/rc{rcurveto}B/np{/SaveX
currentpoint/SaveY X N 1 setlinecap newpath}N/st{stroke SaveX SaveY
moveto}N/fil{fill SaveX SaveY moveto}N/ellipse{/endangle X/startangle X
/yrad X/xrad X/savematrix matrix currentmatrix N TR xrad yrad scale 0 0
1 startangle endangle arc savematrix setmatrix}N end

%%EndProcSet
%%BeginFont: CMMI7
%!PS-AdobeFont-1.1: CMMI7 1.100
%%CreationDate: 1996 Jul 23 07:53:53

% Copyright (C) 1997 American Mathematical Society.  All Rights Reserved.

11 dict begin
/FontInfo 7 dict dup begin
/version (1.100) readonly def
/Notice (Copyright (C) 1997 American Mathematical Society. All Rights Reserved) readonly def
/FullName (CMMI7) readonly def
/FamilyName (Computer Modern) readonly def
/Weight (Medium) readonly def
/ItalicAngle -14.04 def
/isFixedPitch false def
end readonly def
/FontName /CMMI7 def
/PaintType 0 def
/FontType 1 def
/FontMatrix [0.001 0 0 0.001 0 0] readonly def
/Encoding 256 array
0 1 255 {1 index exch /.notdef put} for
dup 110 /n put
readonly def
/FontBBox{0 -250 1171 750}readonly def
/UniqueXX 5087382 def
currentdict end
currentfile eexec
80347982ab3942d930e069a70d0d48311d725e830d1c76fba12e12486e989c98
74c2b527f0925722787027f44470d484262c360cdfdddf3657533a57bb16f730
48bfbbfcb73a650484015441fdc837add94ac8fbd2022e3ec8f115d4b4bb7b7f
15388f22cc6198efe768bd9fceb3446ee4a8dc27d6cd152485384ef5f59381ff
da43f2d20c8fb08aa27ab2015b774db10dacfdcd33e60f178c461553146ab427
bdd7da12534ba078ad3d780414930f01bdaae649990604a33aa9eaffbe5b5489
e5c7c9ff9d9be01b08220832c41caac64816b53bbc087ae4b621d2b44b21ae5e
3f7fe4ddb05c675abfe30510eee4a7c874bb57b2ffe521a6875eddfdfd18c781
25bfca5a097aad361dd94df46f14026c25ea988194899b95001209cb7009cead
4b4ea03473ea120e7a7e341d4e3926796347fdb3a124c29660ac09f4648b313c
b58e824884382f24ce08d2edc686923acace1201c16a07a42803288cd0b946f7
546510e95b1fa1cc96f0bf72aa823d8e83d7c68c752c82a54c752eed2b1e699d
e9db1830272ffbf2f4996ccc2d6fe2ae272798989525ef3b67b0d09bffcef749
a805e5f76578222b9c4a8a09b13189a16ab746ddef7875f1ecf83e568f493d82
ff729baa1e0834dbec30a35d3c49c9b10c5e1d90c6e3c8fb737df5ceb3299d96
0fb79632f91f257753b4d2e34e3f54a26c7b950981fb7fe4dee3315db63e75b0
24b4d318baec8aac9cde186f6d65767df1dba35124287c2e805bc660a3a22772
0ae4fa097f1d75107441c0a0fbb9eec17d5516fa03b98756b7df7ac7eff9c7a2
364b9f691ed5cb692dfff9dd80c761e9c4d5d6061782b327302c053ce1cd09ba
0605ebf761cf9b730524e1994e7dfaa956799d522ec53d5acba27a35c4d28279
617771938ece58c5ab664aa00c1bc4efba2d15504247a68e3af0f9bd59a387b3
80db88cca083b06f5af70d768d1699826fb12ce12efc2b4c70923e052dbb964f
5fa957c3ce225c0fda64d9b5321ee1ade207c1cc93105096cc73118f4082594c
8ecddeb0d7bfde6f70bc62f10407c26a476ed88be7999d64a15912493829a9de
62c71f5a34fbf5a843e311873cd98817dc9f8a4aeb7e0738b5de10043f5cfea7
147f31c39019afacba581f8351d51c8da6e4e299427be714b0eab7db21e90f6e
dc2cd0930bbdaf53da4b96f73fe03079c38a15bcc10556dc157c54fec3f652fc
49b9daf110fbc62977712f012fecc504b23f2ecd1949bdab1698231438cab20f
e38f60a8b7dc0c5ad09d163086c7212647971a6b4d5e56fe661e9a275d3408c1
86a82c3961b0de3c5830c2b69a3474acae1c9903a6e7b451fa65565cfda5566e
d2f648e24660a42344cce7aa726dddabdb1e039028a622fb0476c9260d3f981c
b05278ebadc9e8a8da25d70005c21a62311960e618b6076caba7539fd8abb054
d89727f9de38f2a99b06bbb2582feac6788127e158616235ff13c5dc3f507298
fba58af0d18671bc9710f181bf769c209e85a13b16b562a360698fc24b874c28
e52a4fe55b3c2764ba0427c9a1d05dfdf8db30e09df0d809e34acc5f554a6c42
3dbaa341ef7d341e68a60ac7abc5c702b31394255bc6dd9e4c4ad6bc0a3559b6
cebf61fd2fe3914f813874c82708c710b929d64834b92a06dd6bd513c537cf2e
7544b36d94213d
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
cleartomark

%%EndFont 
%%BeginFont: CMSY9
%!PS-AdobeFont-1.1: CMSY9 1.0
%%CreationDate: 1991 Aug 15 07:22:27

% Copyright (C) 1997 American Mathematical Society.  All Rights Reserved.

11 dict begin
/FontInfo 7 dict dup begin
/version (1.0) readonly def
/Notice (Copyright (C) 1997 American Mathematical Society. All Rights Reserved) readonly def
/FullName (CMSY9) readonly def
/FamilyName (Computer Modern) readonly def
/Weight (Medium) readonly def
/ItalicAngle -14.035 def
/isFixedPitch false def
end readonly def
/FontName /CMSY9 def
/PaintType 0 def
/FontType 1 def
/FontMatrix [0.001 0 0 0.001 0 0] readonly def
/Encoding 256 array
0 1 255 {1 index exch /.notdef put} for
dup 0 /minus put
dup 14 /openbullet put
dup 102 /braceleft put
readonly def
/FontBBox{-30 -958 1146 777}readonly def
/UniqueXX 5000819 def
currentdict end
currentfile eexec
9b9c1569015f2c1d2bf560f4c0d52257bac8ced9b09a275ab231194ecf829352
05826f4e975dcecec72b2cf3a18899ccde1fd935d09d813b096cc6b83cdf4f23
b9a60db41f9976ac333263c908dcefcdbd4c8402ed00a36e7487634d089fd45a
f4a38a56a4412c3b0baffaeb717bf0de9ffb7a8460bf475a6718b0c73c571145
d026957276530530a2fbefc6c8f67052788e6703bb5ee49533870bca1f113ad8
3750d597b842d8d96c423ba1273ddc63eb43f34fa90ea73a234af35fd9b24eb7
4f19626e9124df7acb92629cc87b2cf81c4a89b27447806db34393ddf0402958
e2daee0b4bf315f9aa0a2650d2e11ee289ffaec940d0af160fe7f29411c1c458
69d1ac3bcfe2ae4da72422549095f1fc9fec606289316f106e719a4ae2fd45ee
868fddf07a80e9a626bb43cdfdaa9dcd208b88fd99af20b27f9d6b5cda6a3fa8
8d5acfce8b5eebb38854378cecc3bfdac526514f1be9fb28ae628918ba942a3e
05b78c3aff808cf416a5ed01be280231b75a7aee0c66b0549713bef6b3cbc188
e625ba8776683e518d45caed940a7282a877ad8c4df1019b0d46ef2f3b0ec9d6
b56ab525ec8d935b40c5877b55b09f66a54385574d2fdcba837bfb1c60662e5b
5bae151902ff2f4d9372222d4a8cb4d4929aca1c2c88dd76211cec736708d2f0
80953dfa793096d874eeb0e1c3850d00faa71070501dfdc6b84de8dcee17e248
ae2715a844b420c1fcd43f076fbaba00d70eea33dc135abdf0374a079d50776c
fd43f74a828aaff8709c500de0a32db832761bf8812007991bb8d301090fc665
7f6f0cf3637812762d2f0df335be61fd63b2e15aadb7e6679aa5da81986a9ff8
b3a082d1a404d92d80fa1fae23a9f1d30aaf916c046e6c2a030574275b2e69fb
f30c552f0192029b2d347fefc15f09814019c105330962d3852d6103bb82d425
b5025d13c6b8a2b6818a9b6d6c71a02ee536e1247c5fdb5b9baf52f06582e97a
2edba56020f77065fb210bc20be6ed80f566f58e5b5e997fda400dbc0ca9e0b0
ea77c48ec7188dad9b94bc94811b7451568057c7b081468eb6e5fa4eeec4a734
851ed2087d4e6033b18e782ebf1e997a12cf4a4202c8c61361ffc229917ba5f1
936bd3ef6948297d286b88be35cd894d93d5854e499ecc7beba32b5650ced980
1b1e99736d448b324a164ebb5e15f4d073f9fbcd7bc0e73c27f51c839c6c88f3
8360bc54d748244611090c4ada7e90508d01d2cc86853c5fdc346e95824dcefd
19549a5fb0ad774581827e7e
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
cleartomark

%%EndFont 
%%BeginFont: CMR9
%!PS-AdobeFont-1.1: CMR9 1.0
%%CreationDate: 1991 Aug 20 16:39:59

% Copyright (C) 1997 American Mathematical Society.  All Rights Reserved.

11 dict begin
/FontInfo 7 dict dup begin
/version (1.0) readonly def
/Notice (Copyright (C) 1997 American Mathematical Society. All Rights Reserved) readonly def
/FullName (CMR9) readonly def
/FamilyName (Computer Modern) readonly def
/Weight (Medium) readonly def
/ItalicAngle 0 def
/isFixedPitch false def
end readonly def
/FontName /CMR9 def
/PaintType 0 def
/FontType 1 def
/FontMatrix [0.001 0 0 0.001 0 0] readonly def
/Encoding 256 array
0 1 255 {1 index exch /.notdef put} for
dup 40 /parenleft put
dup 41 /parenright put
dup 43 /plus put
dup 61 /equal put
readonly def
/FontBBox{-39 -250 1036 750}readonly def
/UniqueXX 5000792 def
currentdict end
currentfile eexec
9b9c1569015f2c1d2bf560f4c0d52257bacdd6500abda5ed9835f6a016cfc8f0
0b6c052ed76a87856b50f4d80dfaeb508c97f8281f3f88b17e4d3b90c0f65ec3
79791aacdc162a66cbbc5be2f53aad8de72dd113b55a022fbfee658cb95f5bb3
2ba0357b5e050fddf264a07470bef1c52119b6fbd5c77ebed964ac5a2bbec9d8
b3e48ae5bb003a63d545774b922b9d5ff6b0066ece43645a131879b032137d6d
823385fe55f3402d557fd3b448685bdd20eb05d5e7c2126132e33a59a7170609
dcf4871a5d023c9ef57d3362d9f2d7a440bb69bf653364105f16f4d0f03582f9
aced3d05cc76489b16e3fa8a446094d30038b06ecceda269f2eab9d19a99c7f9
39f9548f206c5a457a19270b2b82c43b091dfc5573468eaa3e7a4a32f8042891
d85e4b180fcbcb3091d2800e54c87d84ce9cad6869b5aabbbe47f40c68799893
d22b765295e1e69e33aa048b7ed98ba480ceca91f3ebf8ef85fe9a3976909626
b95ac5940d53f9b02215d84a44837ba25ed15cce0d504f1d335065594f3bc824
5405407591cccb11cfd4645da60d960c0b93f187b0cf7b105543c0b70f89af5d
264b6c026e3ae646acf145950202ec73282111e3e601cf2bcde22ce3edf6db23
516481420f26552ff4472d749811f27768150450d0d0ebe3c79f999e99b5c0f2
2eaebb12d97782b1bd91b2a1f62a76412548ad53c0dd411d4a08c0f071c2c218
63d9adb75a4621803ecb84c2bb235b620b658984b2d8e0c4637e2811bc8f0d04
6c8935afc70141e1b2d9c23bdb251d304b3378faf8928bd09686aa0340fb0cb1
dc48c996ef91530ff078666fad227a3589f50b605267212d3a65ebc1019a8eec
9a0739a00279471a01e1505c17658c10030fae32f274fdc8c8774b0d5406c384
a1d17068dcb0c2575c562fdc5a2176609bad9a2c255e426a4325a4fc3053c7b3
2f35f7bbc9aa50135f30223360fa2fbf019294b3af98224c5c05d6038db08bc1
4103010094dc215ef9ccfb96b237851332c8ed81a9184cced4edbda26b381f0c
73a2bc4a92533b0e667e82ce49ddd8ac9e34d9d40fd4b5b9910eab3b1234bbf3
af6608d66eaa424c158eddb75fbe39462708da8f5c18d92fbdb2f534598a844a
e076f96a741f8002af3b38d7e4bfa363f5f5d1193014f71ca5f938110471f6cb
961ae265e571171f17e0b5ad3da33dca5b06c405e3ece81461add6ec02d6bb19
8f08ccf364553366cc90fb77130eb35331ae568736278a47fc5fa3cb02412a36
709e1ff9baaceddce7c55f84b5cc47104c53c745a5a1ee1c3ae813e090fe404c
270eca971c3209b3306cd09793a2771b6d50044698342e691ddf42bf892f9750
f123e08f57f3389a8a8011ffdd4c78c503bb282c691d3cab260882700e1e7dd2
50067fa101379335265eeeba36d1b7761b8bc8cd4766d60f2b1c0bae243f4e7e
99127f6522eac9da58edc7169a2af5e33e915cce9a32b8e30b20efe4d67a5de7
0db4a5744b4bb20cf71682b8a5a6e08f2a8fddca32eb77b7ff963c098a471b50
5db961c56c895377b0b5ed5d315d0cdd04a77c6f8b7015d5e25ea5ef28b45200
691d97381efc83413bf6e1e6fee7910efa45d6cfddccd463c3087c46db29dd48
3a8fc85337631df05811d775fee5d639f5471ce66c20087c0ee147c666e1b3ac
ef12a6ad07d336a2ba06c93855e2c52fe0e496a461ed21edc3c57d563e4025d5
0147211d5cff80c785f2a8d1206eaabb678d1262d762d6b20e43ec50084b7185
86f79cfc05fc81b910542cef6804662b1c8afa940390b6e257005c8a6a2c50f4
7e8d510c0e5ff7d4fe4391bc1380b7735773c1126a0ff9f2cb0ac0b8b60a28f3
53001836ebc67888713275877567f475541e7d905b4e69fa82d22209c1f48ee7
a8f5d44e755a301d6a013b07804abce2497b40d2e577a02b6dff6be92fa3cefa
34f1af5e0448f831ae3388e1db9e7c9317368f9cfdff9aa3719fc90f719d4d2b
821fa9dfb5abf5736e8e082f0f9c1e0fceaf78522ec9b789881319d130f3305e
41ec63af3a977936f232a162fbe186d5c4
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
cleartomark

%%EndFont 
%%BeginFont: CMMI9
%!PS-AdobeFont-1.1: CMMI9 1.100
%%CreationDate: 1996 Jul 23 07:53:55

% Copyright (C) 1997 American Mathematical Society.  All Rights Reserved.

11 dict begin
/FontInfo 7 dict dup begin
/version (1.100) readonly def
/Notice (Copyright (C) 1997 American Mathematical Society. All Rights Reserved) readonly def
/FullName (CMMI9) readonly def
/FamilyName (Computer Modern) readonly def
/Weight (Medium) readonly def
/ItalicAngle -14.04 def
/isFixedPitch false def
end readonly def
/FontName /CMMI9 def
/PaintType 0 def
/FontType 1 def
/FontMatrix [0.001 0 0 0.001 0 0] readonly def
/Encoding 256 array
0 1 255 {1 index exch /.notdef put} for
dup 117 /u put
dup 120 /x put
dup 121 /y put
readonly def
/FontBBox{-29 -250 1075 750}readonly def
/UniqueXX 5087384 def
currentdict end
currentfile eexec
80347982ab3942d930e069a70d0d48311d725e830d1c76fba12e12486e989c98
74c2b527f0925722787027f44470d484262c360cdfdddf3657533a57bb16f730
48bfbbfcb73a650484015441fdc837add94ac8fbd2022e3ec8f115d4b4bb7b7f
15388f22cc6198efe768bd9fceb3446ee4a8dc27d6cd152485384ef5f59381ff
da43f2d20c8fb08aa27ab2015b774db10dacfdcd33e60f178c461553146ab427
bdd7da12534ba078ad3d780414930da4f8d58abefd45db119b10eb409dd89792
3c6e705479464a4b33ae3d31bfe98efe259f07f7950237bbaee4f7b64ffea83a
757fa717d50c3298392891bfd60e34a056b0d6021da3fd9b8b01bf78b0b23dc4
ea3b0605150d20b27ff9ea5f2524661019d982a2e47cd7c21ee5ca9ed9227821
f8d07119397de26838c11d7b35bcedc43e011626e300f8249ed846d7b5ccbd89
02550cda17ddf113df658fb13f8162681013766863784efac128e01ef997e1a4
30312afac8f3d948edecd7d5090ab5c864b91d7f6e80256f0e1fc99f1102b74c
61cc456e2e1bedf0e627d5f70f738f963a13666405c51ebf23ca077e97570a2f
1118536b92e585cf1dbd5fbf36a0a5d197538c05304e93a15f3c931168d91d42
483ef428b1a3f1b7e548fd1d23b80f5523c8b8bf450b02804fb689f915c86693
f7dfb1c43f681627c7f027021aa3a8179148f1819cd94b8890a9ac63dc1e8a68
f254b64f6f173c3d02e3ebc037da05074017c8b113e94f4e2d26b467ef9da07e
afd7ea7c86e025af52c5ceeb835951e67e02a38daf1e9e698bd21996c1071e84
ff7fbe77f6ddf9d06fa92b16ecebcbe0370b5cd9d450d0f2906a105cadf93ed0
0abc7fcf2c996e7c15e452006e35390d99b9cfc59925f1444c20d9c3e1fc2910
32cf9fa9d580eac1bc956334da391b870a757c3bee6aa3e005b20988d8587876
3ced20c6edf2ac2b22890e37ff7aedeb0986d85ae05bc84339bf2116df48c5d1
cc888bb33d409b06dd70ffd0618b2080442aac439aeb39c20a87ad74ef10629c
f1604db8611e8e4224c5b21ab0c7ebddc77fe9a283b3a8c6a2a9508f6836e3fc
3eae1366b4da4f44cb7a77fd81d278c17775d56cb28b70f18d894bfd1ec1827f
fb1099ea73d550aae6858f31b1b18cd32c08de80883632601cd31844be36ae0c
8e30d80ee9b0669762d51f9eb11c73d47000263ba8c50772d5a2bb395ca4b6ca
ef33f5001f5e89bf589b4683807e04203befc75ab2c6adc043fa38db234402cc
af0bd8e0b33086597d6b1459d3402a964f64e0c358fe0fb294d984c675c4a5c9
4b546612f20afe9702d8ddcac57f156daa63936ce6b453b62e5400b77a169efe
7368a4aaa88f0d8a02acdeccf1b3525b70670346c7101a55e9da4671e07d3a91
698f08b615857c4536fdac444c0a2a7eb337b66148cabc72ae4967726182748a
6ddc8a2582dc1b31839b1dab5079fcec9d00d9246b2a6511d567eef4c54db284
6a542926ab347ab4b1efe4b0c6fa65a4a8c3618ff4668366b90dc96665af8358
2bbca116cca4a75e66cf037711e7f43961a63d3cd7b296bad55f0c88023f7d82
ce3d055ca462ff54261990788c9a8d037627b677a9f7228d02e4a31cb637f448
f324799b3bae79be4e455affe2874bdf66baefaa608acde9009242623f26fdbe
7d236495c579dd67295fc9bae8f95943b0bf9e80793fc7d0e7a380f037ecaaf0
eb17ab6b3e879a266f819c1d2d4b0d3607477f688b606f217fd68c3a57b7d3a0
77f8c32979cf7f0e200a4006feaa8e83969bc8e4b300a50fbe7f3a9ec89a2fe5
c8f39c36d83722ddc8c34fb0a81839649903354b0d82613185e6d5e26820de3e
005ce45d148252aa7e322ea106f168c221fefafd9326d1052a5f5320bd540b6b
04747765334d6a3dbe32d5c0eb4e399bea388b22555e3fb11ff967e1894e8017
f8b1deea50240a2f11d8a3b82d34b155c2eb1672cdd609596e1201485f133af6
e3e5d24fdcb8e8ee18f9352927557c4b4b74126f1d396c217485b9d1e7ecf49f
281b88ae94672272eee8bdab14e829c8a1cea68bcb1441ce28b6e94cd4ce50f8
ff7eb614a0d94c4ed4df6a426ed657134c06c0350a28f9db61bb5b87fccec8be
7d961f18ec6e26cce63a08060535b55a605ada02e0f8d3d1ef0563e33b08bcb8
392c5794b831e17cacfc1af99f83b8434d757a1ac585266b1d47ca1cec7aa877
bf55daeddf2457037a816a32aff7eeabd6d4abc27dc76d01faacc1cad424c51d
9f2070ab1a96aad2d3510aa34fe5f7c534d8ae6367c287a38948d9ca2398c799
c5f861c284b540d6c1804f41
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
cleartomark

%%EndFont 
%%BeginFont: CMTT12
%!PS-AdobeFont-1.1: CMTT12 1.0
%%CreationDate: 1991 Aug 20 16:45:46

% Copyright (C) 1997 American Mathematical Society.  All Rights Reserved.

11 dict begin
/FontInfo 7 dict dup begin
/version (1.0) readonly def
/Notice (Copyright (C) 1997 American Mathematical Society. All Rights Reserved) readonly def
/FullName (CMTT12) readonly def
/FamilyName (Computer Modern) readonly def
/Weight (Medium) readonly def
/ItalicAngle 0 def
/isFixedPitch true def
end readonly def
/FontName /CMTT12 def
/PaintType 0 def
/FontType 1 def
/FontMatrix [0.001 0 0 0.001 0 0] readonly def
/Encoding 256 array
0 1 255 {1 index exch /.notdef put} for
dup 45 /hyphen put
dup 104 /h put
dup 105 /i put
dup 116 /t put
dup 119 /w put
readonly def
/FontBBox{-1 -234 524 695}readonly def
/UniqueXX 5000833 def
currentdict end
currentfile eexec
9b9c1569015f2c1d2bf560f4c0d52257bacdd6500abda5ed9835f6a016cfc8f0
0b6c052ed76a87856b50f4d80dfaeb508c97f8281f3f88b17e4d3b90c0f65ec3
79791aacdc162a66cbbc5be2f53aad8de72dd113b55a022fbfee658cb95f5bb3
2ba0357b5e050fddf264a07470bef1c52119b6fbd5c77ebed964ac5a2bbec9d8
b3e48ae5bb003a63d545774b922b9d5ff6b0066ece43645a131879b032137d6d
823385fe55f3402d557fd3b4486be79011d1f5b667eed85fade30ab2ec4e1c2f
4fe750cf9a69506458071de8896261c001b1c290937fa42a1fa87de406e9f86a
4c9c0f03f69fba719114f8ae51040a4c03a58b6f3de027f6726f32743dce7395
14c2c6f3c2de1aeddcfa8eed7da56dd68dbcde33c29ff7a694769049e4325ec9
61b2df16add2ad46f18781fbd63eec62c26f1db41e6a666a09886382dceba91d
8ff7cedd64ddc8a2f15fe34076a064c46febd1f4dc3707aede0ce8af161bcb8e
4ada202d0954baca5be71c28ab8bf32fd72029aa07f27d658a68f454a4bf386f
6314224d16c7f0a8624f6b86319a4e2fd178f596f3b20db032ea28c157a68a69
fad2bc88881658d2286c0d4ef061bc070c3145f2a37ebec03f51de7cda34cd97
7eeebd86b00f9758b3a496f41d9a74279ef3c6322dc54945f95062c5f37a1e51
cf7eaf45f2b3634b2d7d01ec3b298ff35b6616cd3020e096f6c6aa2bf04c4a93
61c19f3c67a28d936ffc8120f1e46980b29bf54047c5f1fa48e67611a74fa434
3384f802a4079b28b94681e119ab0c1692de5bbf426440ad1023506cb80732de
c64d9061869cb34de924d2c26e404b7dbd9be55b9c0c5ae3095c15d278adbb49
12df1484ed2d73128e5d9c1f1a3b9ac19e2ce5366c96644f5b3d3eea589caedb
586fd9b8f4df32ec910e9b7434d5bbe57e03892eb03890567df5b811afa0da5e
929d456af362fda0789aa0cff464e238029294fde86cfc8d7d33d5c98b18c76c
319811e4d3d49560f2ac39103594ec513e0b1377c2c3e22979866c19b61448d5
a7201ca4b7538aa370f6347253b0853d4c5d575a7572f93cb73a598e2e26b11a
d46a1126e44e7e1795dff01562316b6ccc6678663e66a73db285746df3f4405d
d51714679581946ef7261c143e4e5656d559e74b0dbcfeee29a0e24586b955c4
3cffcb9d6bfec838d08c877dcd2cc4e55fc56aed306b47c58bcecf6b62fc461f
80c0074f27481286eebe9349d22d5afcaa75b0d14e35c0b8d58aa63350ef3291
6d898537f266515bfeb44d812457d2a81d1bd23614743f65164a3fc23b89f76b
a3ab30306a73f58ffda200dfe763de3a0ef7c1e6240fc35eb0db6c48d385b8f9
08b41c59e20b51857bc4c6ee6cbb96dd232fd7a45105764c126fd109ab415b2e
4967c5dff1d3e20a0280e458fbe837f6b6059dba4c023132bf12f538cb1fed30
78dff0d22bd1f8b24d2df840be6bbff6879f8445956c789b007a79a473c582af
32425174a143684a713783b96bc6790878209b8bf4de26dd7c864d8017eaa6b2
f51f2be256c520e39468c923317a0e922ece7a49d3f60b06ceab1aeb53b392fb
b6b188d3c11e983c0a6d33da36214ed3e0c2b4b82ff61c49efed10bee8b6f874
2f86dec3d76a0c7cc0a32f06056f4ca8b7203ff936fcd188292990448aae1e71
c82136b6ddffed95aa7d0d642479c1d5e810dbac5ace16e8649a22e63a45d3a5
7326f34c45ddc468d296fab7db7d9a57c71eba6a0715fbc5bc9ace176e9ab8ec
5d08b9ea49f1cceb9f84f208ae7e4113add03fd1b44a73bbfca6f183c51170dd
8f4e6834ffaad98d6fd99c20d8998fe836e99b5bfb97d6aa371bf13f68282de2
8c17bff141cad08532baec038be9fe97100034eede8dca24efdcdf7893124699
da5f6db6dcf0767b752e78acd5b98d8508d973509d6e9659e083968a55d90cfc
39fe904221fc34f955f52600b4b3513c6feddfce65d799161ae7b6d2872f7e0b
f168e3f0174d93baa47646b45a846f636263a585e371db4493bff4d92900dbb5
269bff889901ff530e44943dafeb18bd0094c4a25e83d7d36256082c12cab568
90d18fed9bf315bfcaca4d75d7254c4c1d78926c09169a8e25e26d4ca943ea28
8f144145667bdbf0718c632c391e73cd9e7a236bd56248d0a471c5ac7cba989e
d2d1d321cdeb14b0ca9ccb40419d71479e44a99585049c95c12d6ef5fd837d62
7be8929683ea6b37cce177d1f4acf8947a7223e89f35c45e5fc31de5cba24628
b2f438757e1d4896e3c4c99a6ae04f47ab0f4710c5e5397db02b95a69888302e
602e7f
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
cleartomark

%%EndFont 
%%BeginFont: CMR10
%!PS-AdobeFont-1.1: CMR10 1.00B
%%CreationDate: 1992 Feb 19 19:54:52

% Copyright (C) 1997 American Mathematical Society.  All Rights Reserved.

11 dict begin
/FontInfo 7 dict dup begin
/version (1.00B) readonly def
/Notice (Copyright (C) 1997 American Mathematical Society. All Rights Reserved) readonly def
/FullName (CMR10) readonly def
/FamilyName (Computer Modern) readonly def
/Weight (Medium) readonly def
/ItalicAngle 0 def
/isFixedPitch false def
end readonly def
/FontName /CMR10 def
/PaintType 0 def
/FontType 1 def
/FontMatrix [0.001 0 0 0.001 0 0] readonly def
/Encoding 256 array
0 1 255 {1 index exch /.notdef put} for
dup 40 /parenleft put
dup 41 /parenright put
dup 43 /plus put
readonly def
/FontBBox{-251 -250 1009 969}readonly def
/UniqueXX 5000793 def
currentdict end
currentfile eexec
8053514d28ec28da1630165fab262882d3fca78881823c5537fe6c3dda8ee5b8
97e17cb027f5c73fdbb56b0a7c25fc3512b55fe8f3acfbffcc7f4a382d8299cc
8fd37d3cea49dabdca92847af0560b404ef71134b0f3d99934fc9d0b4e602011
b9cfb856c23f958f3c5a2fbe0ef8587d1f5774879c324e51fcb22888b74f2415
50d7401eb990d4f3a7af635198422283cac1b6cd446ddbcbd915db9bff88844e
784c6bf7389803d9450b0c21756a017306457c7e62c1d269f306bd3402e266de
fc3b5e7d8a8d2f5bf0fe6ddd40d07391df4fad4a6018dce29a2b8f692b29f202
3a7c0e66de8ed85c14f1f8492167357f51a7e84cc5d92e0fee4d81cf7fbc8de5
2d2e7bb57142033993f9c08c315abade8dbc4a732e84e142d3bee51557910e12
cd8aa37c459a5e6b7f5269f59078aba3be4641a11ac48d0b625c8325b38ec08e
4c9e5e7fed976a5650d99d82114f449b9ca14c4ec957702295a39a93ef93f618
99b8ea06b092c3c1e503e6e436e0a9fa22576c8930ab3dc8c20f5d82b69cddf8
ff4dacfa9c54bed5a3aa3ea5b129fe96be632843b9b6bc91b615581a985db56b
1e01ca60ee69ca92cf5c0882ece62edad3e106d835348822400f0b66af658f2a
e56ed08f8b0010571807009b73ab12a8cf14ca6c71f03c2a48c500f9d62266af
154a6375ff600d9bac3f05ce34142d6867a79581c533176bb2f3117336671e2e
44638a97167e2ea9644e31ea16c2ad2990ea33c54001e0c8156e6de8ab6a4d40
a7137ba275f39589fea2e2db8256adc103d6f9cc038037a47e8fd469c5f98a5e
3c15bd4ace40d340018b1cff7d1ed8abb0ac57b5b5a2c20a51957b96c453edb7
dae5affd91a46d938fe0a13363001d844ded4323f1ee6d30012aea19b024a552
315505535c85dc26bad31e09c50e6512802976d298c4e90d0044c362e6bf3ab3
62a454ee93de25ce54411090c29e9d75c80ce26a84404bd9de3aee0e3f921ac5
87f907572b8354a5c3165eea7e8b2ba4e4f834663063e9a307d8ff6f8b61acd8
799bc105cddcf8f95f2160494fc01f7ec3effb95de571b8d7f27a2f9ad203c09
cd4cffd98a119a507460e7fef5c910405e877aa1f8da68d1272e59e3adccef8d
82e692b3229926fbe621080b7831a2ee248948dd3ae55082a939f02875a7a0eb
7ae7d50270a576fbdfde7109c670f51be75b80b6fe3045ea50e2121022b473d0
d3fea17e9d1a4bbf6c305043243b45392b42ee7005ffdd0272fdd8dec2069a12
6b06390a334c7e0335ce67e674ba6d8c394d1da50f023ae1f02b024c2bf90b2f
a0c94d192851d5164c532cf67546f261b97d76e2f8a3f6b611c374cfeaac1d83
3b1fb0cb1ee268a04312219ed724bf78b0f6cedb0cbc7aba7d517e354f631f68
83f100d28cb85e138f31c70c3d9b2ab3820fa0ca9333e3d5febaadca2a2d99db
b246456be4749d6973ce482c4d131ead68bf86ccb0d206f673af4e4c67d5073a
e660ba75a2f5fbd101dd0a8a38ab370190940c594fa3023fe1367d4554ac9d22
103213fe6715e555e46ad72dea8bb78f4a07357f98732bc4a20c312856c9eb3c
389a236235f68e4510ad69d70ee96e13c22a01afc9eb7a83174595e36687382e
7c1fa347568b5f2f360d9d4e500ea80b27a76c17b8bc4dfb116691d096bdd529
0b4b477a45abd73f419c8620644139847a1b257eaaa3e651f8fceeee09efc515
54d5b624eb106f72670ec094c013e785bcaf94c52478fa261ca47584da29d8bb
54f5e44b06ac8fc706ab7bbaa310d2bbe98c0452ba9ccf5e38d73378c47bf894
62b1d81db29b1bf0251aaf1a6b9ca74af13989511584d314f5fefc90c7e988cb
d0aa26e3447e6e3751c9b215d86e3c9e8efcaabf11c49f5799e53ccce99bcc6d
8ec8ea587ca7ecbfc21d380bb171b1a0b85ee279f1090b23b24bcabcc6f8666e
cda2d3e7c3e7ef74dfaaf2fbbff6f3e2af25be243f30261bd2
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
cleartomark

%%EndFont 
%%BeginFont: CMTT8
%!PS-AdobeFont-1.1: CMTT8 1.0
%%CreationDate: 1991 Aug 20 16:46:05

% Copyright (C) 1997 American Mathematical Society.  All Rights Reserved.

11 dict begin
/FontInfo 7 dict dup begin
/version (1.0) readonly def
/Notice (Copyright (C) 1997 American Mathematical Society. All Rights Reserved) readonly def
/FullName (CMTT8) readonly def
/FamilyName (Computer Modern) readonly def
/Weight (Medium) readonly def
/ItalicAngle 0 def
/isFixedPitch true def
end readonly def
/FontName /CMTT8 def
/PaintType 0 def
/FontType 1 def
/FontMatrix [0.001 0 0 0.001 0 0] readonly def
/Encoding 256 array
0 1 255 {1 index exch /.notdef put} for
dup 39 /quoteright put
dup 40 /parenleft put
dup 41 /parenright put
dup 42 /asterisk put
dup 43 /plus put
dup 44 /comma put
dup 45 /hyphen put
dup 49 /one put
dup 50 /two put
dup 51 /three put
dup 53 /five put
dup 58 /colon put
dup 61 /equal put
dup 69 /E put
dup 70 /F put
dup 72 /H put
dup 77 /M put
dup 79 /O put
dup 83 /S put
dup 84 /T put
dup 85 /U put
dup 96 /quoteleft put
dup 97 /a put
dup 98 /b put
dup 99 /c put
dup 100 /d put
dup 101 /e put
dup 102 /f put
dup 104 /h put
dup 105 /i put
dup 107 /k put
dup 108 /l put
dup 109 /m put
dup 110 /n put
dup 111 /o put
dup 112 /p put
dup 113 /q put
dup 114 /r put
dup 115 /s put
dup 116 /t put
dup 117 /u put
dup 118 /v put
dup 120 /x put
dup 121 /y put
dup 122 /z put
readonly def
/FontBBox{-5 -232 545 699}readonly def
/UniqueXX 5000830 def
currentdict end
currentfile eexec
9b9c1569015f2c1d2bf560f4c0d52257bacdd6500abda5ed9835f6a016cfc8f0
0b6c052ed76a87856b50f4d80dfaeb508c97f8281f3f88b17e4d3b90c0f65ec3
79791aacdc162a66cbbc5be2f53aad8de72dd113b55a022fbfee658cb95f5bb3
2ba0357b5e050fddf264a07470bef1c52119b6fbd5c77ebed964ac5a2bbec9d8
b3e48ae5bb003a63d545774b922b9d5ff6b0066ece43645a131879b032137d6d
823385fe55f3402d557fd3b4486be533de8dbe3ccd493ef4c9656d5d5b76d531
9e704539dd76b065f45e6d6f62ec499c9ab91923a364237ef75e1d62d52df3a9
43713cbc63b16c1880feedd1633766248fed9d060ff709951f2ec84ecdc06bbd
9cc4a865e1f275455525e5ac7e2e6289615e98cf7ce3763b6914d3a4c5b75b29
b8043dbd898ccd5be448064cf1af2f80f969a44b4f9b801c42f6d6a6d0c3ff42
e0b1cff748c1fc49b598eadde0c2802dd591c54b802ffd24cb7a7639295713d5
4e639514ac78460672c9c51742ae2014e4137ba4303051c06f686395aaef86c9
9d7f9a97009436c2ff55b770de3e80cef0d53f4df46aacecc21632c0c676e2f5
ca7bb101a239a0ff67ebd37a6b8c4c8246dc2c90b759dc03fb26bde8f134f552
23ef3d6496aa0c4a2d7b6398de6e6a0474ee1b0d78b2d865614609f1db92fc56
4ab5921078b4944e11a2162902f0e04f4b29448aaa22b4ea92fac48f8dc47535
d717dc7acd08b25d391c97c6c540ae0a98be5d6a8da564ab73e8b5d3b5e1989d
6e25c3a35ea44d596b5fd6b2373b30de7d59c1831245edb76d6a67816ab91a80
a27a6597c6dfd274db8b3e45cb01aedee59ba6efa1428e41ed557f051012a389
9b195ea44a4e4d0067398d9d40ea26195efbffd2cf785540bbeb8964f6391361
904fa5e187e4af3baeb4e8cbe7558fb7049c94a1769a2ff0b44f679bf6f14d8a
974bb8bdc735d5a9798c89d7d81176ba98dc22dddf6766acd52020e3ddcbc94b
71ad8a336dbe9262f302d8e8d5ced4481b19a586e1d73d0138ab0b732226185e
8cfb8408890ecb590f032a5633352c42df62a7dd1a3cb4fb12083709edc26146
f31161bae67a54aa5b41ca7af61b515c100b38a01b77f831245a013f804584b7
bb764dab019978bf8edb598eea918ce6ac94e94241a36079a2fe71bd15431e6b
f8afde4c32cbce8dff9ee1467125d2479b7675db7cb8c06c3ebc552a75e768f4
22e1e2c7aca8a2e2b5f743553032b6276c7812f25afa2349ab6b988eb5c23eb6
5aef8089f88953d0a830ef3be25ee530bda21412004588604d86c5589309a180
1866a80b8317aff65c64cf87e1fbce6cce622ebf923257ef0da6c64b9a66ddd6
a23ca8df19b55d4e808bb5efb0d7283928a12253b159b7c7b5644ef6d00a97cc
391de51f124659b4ec69684ed08626ba6897a653898efb85b27b0f1aa46d46e1
80b997c335794f5e90e21167c79acc2d0cfd79c6ffc96315010a72a51df09eba
2971947aef0e05afee5ad855f7597be9069b719074bc6f39293f2d378c32f6ff
c66b4e9b405e9a3dac946bb43c15750873e708e647f99b23cdb1cbe29f4061b1
e35fcc35c181dec68cefa28d277d7c49a6fc15339f6e68fbca73aa8d93162d20
23ec2dfd9a5cbb54a7e3c231819ec11e91123a6cfa6872f233c3c2796e293fab
a3915c07ef2442402bb76d1d7a852f1e200f0f792447a054548520ef94e28640
308b1bb726e7f652d76aa6a145da053225794fd7a52856c2b8eea0bac4cdabdc
f7a952addccc9884618a8e14cc8979f0d97c4dd2202e4a7acefcc427bc2afc03
b65628028e6fcde15ed99b8b74e86e32279e60e1f9a3aef437d33890e5d5586a
f62741199af6e59a52aa023a66a70a2ebcda65e15a4cc341bbc3e419b5b4c6a2
e33cc3b2da9ab22302405a8a90479d39b75b0d5c2339c96424cd083db09c8b68
03539656a09ba821156e6f147a866416814d9f998e661b43591b464b0ea4ba40
42d76dd8fb6a9ee97e7272211acec3a62dd6adee32d49a59eabbe91c4f6ed190
f0caedc71b41b14906fde4a1ffd40b633ae217f61bad48ae77ce6b4e895ccfc0
249476e085d06dc73dec3ddd7b2d05310267abc7c360029b4b6ac3b9ecbcb790
098336e188d053e676eb8056d087392557e0662c7ddd664eddcaf1815f873222
7e5edf326af422cef12bdd51918a2b2f6767140ab9d5548e1e3cb75a5d62fae1
71b87b610f472a4425531fe8c753057fbe45de0dbd18da85361e101906dc5b54
0e9e8050df4b3a758b032f07367046934555b9907cf0197616bc39dd0d2fbc02
12d89cfee1c1341e6d64d84f153dfc13ab683315d321dda70717c38b46e2b35f
54912bae4c627ef1bb2f9f732409ec948d8b2e3c045e75b39faf90b11468dfc3
f79591de095640149baaedfc8f58839600c6a2b79afc67e36cfcc2c0553c77c1
7ec5240e14a880bae30c516b847e748ca1950772ba89bf4dbb4700822b969a66
3face092e8e77778d0a851659537adc0166e42241b1bd57526bb47371bd6c94e
c6c96501aba3b4ad7b09589234daec652971f1bc6aa7b767aa3fca33512aad26
5147f4b1a86ff17a0a895c8945698fa8abf902e66fcc5e8ff623a5dfcceb8aed
54556d51f79b0e8dd263d0230edabe3517757f5ee394923764a2d1a87299b72b
6e30366b722fce1c946f44eadf750402ae0868c4d4732cc51296203f58e505e2
df893a1542e533c2b5f6ff99c317582772717ba29ce037d9efdfb13f5eaba2fa
b8e922b2d0b26297b9a8552395d063266c84dee3e00dd7a5c7e91cdc13037275
671f4034a387fa56ec19510252d3073c50c039361f674a365364a3d8fbda5d5b
28be5ad9ad7ddff3d3367b902d9d036ae976208e36ed455bd1aeefcd58749362
4d4e29c069b4220327a998963c4df8be0dd3f662900da054eba2ec28eb245a21
1298b1fb8ec65fe0a2075f4f216f677ec4cadd06c40756f7698603384ef15f95
ffbb24f3e8d3a314febd8d37a86ef6d08baeed5ab9354b6308990ec0624fad08
88ce366c5a874347313d23e521f29a7f1affc873371ecb7831e87058495efaf9
bf9e0117fce7c70a3bd22beafa062cdb63186a705bdf92c815882d45c5f50dad
30b38a7eecfcab611cfec1a5c9bd1d4eb733f0afbba1e3b752ea51dee800cbf5
9d0b1706066c59247eee59694cea063a2d860f0f0d7c02ce50fc6853ec52d68f
c31e51352412945f2909a07f96571dbc4488ffc96efff8d22f1d9b2748a2eaee
48b2c0b59e8a650d57fedbbb9092cf7dc7bb5eaa3220e335f8b60008810123a5
d45e0baf243daf2060389062f9228219a1ef6d7b6f5c37f9a1a8e9afecd3ce39
4095ac27469f27879fe57277be78793efb5af1733e64591dc215917806c778b8
f8ed68d3502f74a3494e5cdd95a6063a9e50887afd046da777e0c95df0e7df2d
7a20d11e79f902d71bfce0043ce8fb86adfa0e08f6577f77c29bedbb92f80d6c
c0a03e8470da2f8df6011f82f0b6262fac5065674f8357b1677cb9302dce6ca6
af5d6f9e04cd6525425284dbfa604a333243734231b0c831c9235359f2e6fe68
35f10b6714e2be3ab50f38c608d4af8a18e6d03b3575646c85401028fa123aa9
842e17669495ace19d6509c8d84c30fb89c4fb2f6a20770990cd832c37f6ddf0
da9ae3db0392112448af1311079b42683c8220b7ad1a2333edb5c8e44fe2df3d
061cdc305a41d58354756124447c32d99e067dabc0c5886ea57063fa768f6ea6
21b6bfaedb74765072d72216a44a64320e542ef2d2f17cbd210ff36487d3e20e
5e33e745c463f8b10bbf8e049d8d8565c6cb831f1fbadaa639c65e0c4ff3c91a
88945abeb28f86adcef1db396e5cdfdb48b05da9f000ea1a0aaee9813539b337
292c81a10f9f4284707b4f20e83add66fb3bb5c593e987a9c2fc2c8cf6efe780
c78ce9bb80703e3a6cd1f9d4b7c2b7120a28fd106c3cb6a2955a4e799c3c1c97
bd615e45f856849d36432f39e2ef5383be18f399ba2eba0b014f977168d0c871
40833203180cb4dbfd801c1e1e6eed872a5f1db95ca7cacd5987b01b3e6ecde0
91c375a51ef88d942edcc2d9f1dff68749356d72c74b8f73a639421a74a9649c
c384ef60593c0863f4e209c73f928c2aab9449d8e9cb9def7ed7f0ad5efdccad
34075c307ff9db47eadfb7c457cbc47938cb0ccc5afda282bb1c99652e691068
36552ba952a7709a41f69619e54f7e26563b3df3625282f2b10b9a87555781bf
4edc732b7598858b628ad5f6bccde267660265d684a3d6e83a67d1d17fd2f2c3
13084bd30d6f8dc0f04e7ea380c78336f17a7ec5f5c4767b31f1a59bccbc7635
9140599f1b8bf5667daec872e54847c1adb70de72c99c24624bc236d52bd45e0
1351c3b2253cc1252865945f0e3839ba05ec7f9aba0883135b2ed19cb160f670
26ef3e4e43dbbd8e4ba7f790eb88ad95a0a2712f698dfcb653b5cad82361cb95
6a3208efe7c976f4c54cef255eebc17f851a3c6c86f8d70415700744dd8ee62c
ed07509c9152139281ff31607af83b25eca2a1353000f6649c279cad5f7e13d4
37bccd8e10b8395f6fb098c9a765bcec3ffd5614c22d0fc90c9643885ee153a0
17ccc695474393de1a7aa3829bb1ab139beb42e528325ae9045b2871c9000e9e
afdd9b756f72ebf8ec02874687688ec4388ab9f060f416b00511196b0ffa7831
bfbcef3ba092ff72a2cc0611a3b6d8db6e2f8da773a4ae76fc288ead6f68db84
de32e34373e2367f5f31cd2f05cf18e19184bf00154a942366868c108f71c461
75cb1f2391e46490a1413ff55d2ee80e861926ad168cac8043416e24af80299c
14983f86aa007395d847b10b0d70b7d655c743f14d90fc542305c1a8529440a0
b449b0310ac07a1be7fec55adfd3348f01704ac262aeeefba4434ce3f43e908f
b35b900447f9ffbc11d4609a468ce7baf065e7dac30da03dc70f991bd229b7c5
25f03245237e86be3330ed9bf36057bdc271c61cfb509a6026ac8625139230ce
b543e9955e73f7841773ffbe7fbc65a688f2df920eade3b76e62457929f91ea1
0c6598ed16bc1840dee4a363828a8d540b507b337713219cf51864574e4b3e57
41b22fda1b06f3e9299a91a14c68953df1f1409a9d01c0516b1834790910c84a
9f2b06ab1e158c14a5fa4ff22b9e6a4f0cc3a2a14b5378555dbf3cca4ecb86d7
a819c7222ae6e406ff28c4cc15299d2156f8f92d18668d448b2d4961e44688f0
410835851092fa0d0209c813edddc2a6a47a4f03ca1ec595af9abb48585e2c68
5d0fbcc0bcc244c82239ec16eb1a0c01c49800dcc2962c002a248145cf6c0db3
c0a46dd05fcc206b822b9e2be8c8cd5d0bc957530ba2ab068616a29f3bd6b952
3ec99c181331383c044daf219e3e3e04e0ecf16aa100941220ed64518ff4ee10
c139cd58ec7eacd22ebf4758d8a2310a6c6cc6870fac09cb689507be9b6fcadc
023dd8ad4577606b1c00250b2572c0ce78b410c03ad805d844bcccfed0aea232
3eab20a632de7fbf42d367250f42783ffbd46708c1830b489d596e12ec76d2e5
932eafed0488fc3e003a72bb44f3aa3fb8d7fbbdfa35050f58c5c8adc3c282d9
144ad828749cc5fab4ed53065d4b0aa1879c6a184a0bb483c7066c2db2bfd742
465aaf283733448c9d929c2c2db217395280a50374f7bf55b1702efdd4714bc8
c92f7a80e3208ae151ce103e8b8118668cacfdfa379399a94d7eaa26314a8176
4c140067a65b4fe4158e4323dead2d97dc2174f808f08421fe27c9c57742d507
ca64ec0fcf8cd35549216832c55436dba7565e9b539492c2aef974a3de97b8c5
de2c884aadf90edd65bec4a6a44cd9dfb670fa7bfa8d62fef8f90d995f072ce0
5d6bd4ed12b90ba228b780ef99783931209c7b68fc07001c6cb6a6d8e4ca0604
282b0620f825d9c375c5da3d8e39f95cec26f64313525d1afe953b3531292a2a
8fd3b4e7d04b4c6290ea0bfacc17d3904c59b0e12b4743b9826dc38512db235d
913b4ae72abce846197990b97ac644905014b31ee46b370eff033a168eb26061
2fbcaad2ce4e0ad7257090b2be798f15ad13b040d3b0d0b9afc50a22d657f551
e15b269938188bd1171baf721974cc4fd9f03466e38becd8d6c3c2ea5f4c92b0
8a9a0712cfe0ab8d2d76ba5bfbb0927800aed2e33512e9650fdca61da1316e22
a2f9c2cac7eaa67a94ae4f6f16bbcf8a36beb14bee47c98133556250ce43aeac
2df170844bccce81c88131ad368826efd12eed0ba33403779278284aa0438d69
aa28c2717297ee49c54af0f9965e43937ae3e2201ee0b62dcd5815e3443aeeaf
c3682ddc51bcf8f5fd10b47ef2e23a314bc2e35d110b2f213c512f3cccd3c11f
9ba6336bfcc0b72b9cd3244dbc89995cb1be4585c45fd974353253ce08bc73c2
5be23c9860da4f5bed02faaa8d381622439550ab3e80d097f44548b531ef0f88
b78dd5365585b8f987242944ea01a746321be1c9eeb005e96ca9850aa9f210e7
d198a6a0572ae91583351571061a74586409f1a72d3a713cf5072b6dd4991019
bbc28f4c02b2814c9d0f96c7f363cca844cf35735383d59276e9bd58b8c37151
55cf37b84510c2b91f46f35b862db966e6819397bf6b04d2085cd0c8e7049a99
08524d6de1c93a29c880cfe3e2feab367ef144258943739d94694e112fef3529
31747a2c07ba392ffedbae549af5289f464e90844bff7ef2364fdfbf7d793cdb
d845fbbf8d53443473dade7d4878ddc303fb4ed68502a8c8a42a387cfdfa3f53
e13378822d6268e0a7901db60db8567a8dc4883375da4521f0bbdb995b86b9e9
5195d1f1f0f09c81b807b82832aad47f136e8057aeaefb70857138369540f75e
a78254b4036ba4d5bbf757bfb261813d4df033b63e48e4d86b1a59d07c8e37e2
77d2d8436a4fc7a9c759187cf97e449485ec7ec4a1ed7f518cb98126a2464bbe
1e212d01ce2cecbcebb1e4f96b9630c179b0a2b35f271889054628212e35fec9
1cc2bb52d5a2dbdca3ff3b9bd4805807141f2669f791c4cc7f6a2fedb79de72d
3a2ba0eb945543a1950d3d7bab95e8f43206e7aa9c3cab78d10947da405f18e9
a63e22d672b051fbd88e31fd635a011b330a0a44b56d01b6ffe684d5b5504301
0a2ae9060122446a526f1268e44599a0e0192c2f28aca349c346b428902ff7fe
e724a67f3c528a1f2c9c71e6916e3da1f3278b966ad8832c4c3c0eec8132ad89
a9debd51e25b8169f1bdb52f9884985288033967a33482a504962bf4787ef026
382ce1f3707fe00d6ba2eed9013e8a9edebc831b408e6238bea97f45fb4938cf
088d7d26159f0fe4fd20d6694ba32a4ddc794d63738ca7ce73d1241dddc0185c
987f1cf3435be15e890ab237a66c8cd1bc1e84ae7b1f8ce3240268802ca8ac16
4ccbeecd091802af64095d941f763bbfa3c0fbbfd41e2d66b5e609ea74be59a3
9083d2fabe81ca47fdaa413542577733a9908158ae2d82046fe522c53a51c484
5ef0dc2922713d281d65ac584be1e69daf3aa6c3284fea4e3740f7a5aaeda344
ba0650d6ae6dfac20f713c68db4a709e6d8bca9254b3ef51c0d4cb2250fa633f
ec007a110855a62db34d11a049b0c32296373938c78a9cffd122abc2fb1a46be
d61cfa7931ac56cc5b079465fddb807dbd481f8bf13ec63e72464edc37d70529
0c80c3254cc6fe81f3f2e6fdd7b5f79aa2371fa2be45ebb228b86c9d3a860136
5ad60d68c025e6c292656096f04a992f793de39675db230753fc2e7f8998ea92
a16d6c05cd54b49ae2e9988bd104e385abf7d1f08c03a9118ac529ec9f287640
8932550953d24d08d77470d433d0241ab2b479efb4c7d2a0d0840e582dd34b2a
169b6a6869e51da6d170dbccc0ad70c1ba3b58b309474e406404328d6269e9d1
263d47a6d9654ab5a93470865e2dfedb76ee8465a353ffc8a82979192ff22705
2dc9ada5f5ee45189d332fec173dd2693cee81d04ea847c65461eaa1f41bae53
efa6a9e0835b9adee1f38c368e2cd9b8368a2defe938fb70a9876b89b6d83e00
8869859b6c29315bcf8c2b57c5673075bace05e7a42f3a44059d624ddd7e74ac
3f3ffe200bf0de6d2058abb425d1c9cf744847606176a16bb8a8b7fcf2cf75b8
3a9e8778b4e01d1e38bc0f527e11bdf73bfed5273a671dc8b2a4aa048f23c162
04ab8b5c1f9b8864303b14f1616da747fa064671d4dd9d21f228464b77982788
695be9466b19938908c100c3b71a6f766c5e266c2892337be8c71de9c7c324d6
21c3cf09f256f84c1e433053ff8843ece053f64dcce231f5e484a662b4455da0
7de8fcf3a3b34d6e475795e4894e1ddd430a017af513d634622a8feacfc4434b
acce20b7772e8e63edc3eea4fe1f13d4915eba0648753bde8090b63e3508849a
3d0f48c0a7a935fdbf3fbadbc2256e83cb3cab4b98d9442598cef9aa2a785de3
2fa3d7ea71c9283389b8b9717623c328846f4103ec46cb45c3799369d1ca69e9
668e2cff48019e009c752865feb2bf48af4e96a7602076bc22586d6105881aff
da5824d6d066f0f2eb26364bff711e373a5ad57ea7c36231d0a1ebdeeeaa9214
e9fa1415ad599a2c54978df6fa9c0e223d463df711ef37318cde4bc4ed475d89
847d65f84c5772ab005f5e9f4e66f9e584f136978f33f8d38b8123f4c5c2955d
a9435585edd1fb2bfc7332e551f6826de335caf9d5d22b5ae7d569a0ec856805
ec6006fe0a40d4fe8b223f8672028dd7388518844a5b86e2c97fa2038bbb667b
6a6cfefab89727f835eb6e0c72c8450e0bba705627a4d33ead8009d74837b463
4b1514c4324de32298f1c1cd888fe81d3bef80023006897dd0b8a5a0e68daeb6
91e6f563def451337a12a5ad4c8f5e77581466e8f68ebc4f797c2a7c8e46c521
353e036af21c571b7839cbc28adad235f4c442be489761ad6d4fe35a96f654d0
7dade3236029c7006246831523344ef84fbbf0bb4fe3c2281e882ef0b819b68c
352177929b2604ffa703abd5a97b4d2cd420f19f04498893ebef43617362ffab
23bcd763baae589f3eb298ed9c9a3cf362430a7a32a8e47c0fcfa3de96ba1b86
1be0976e38c7a0ada786eb59921358e1bcb7002b2bdd9c0f641065943b7401d8
fe78809b738e7141c3a1a7dc2003f30b0da74cb82ada47d7e7a1f358f9e823c9
fe7f2f5b4aadb0745c33720b7fc396e800d3c0d8a66a55ff8122820b9f049048
f72d624d2855eb2b2d6f5a4aaf90d2e4a1bf7f69ce580ffc0a08f4589674aaff
604d9baddb5e047605048f72d7f13c9697929457356178e8dfbeeb8be865115c
0ec1e4a7ee5bd61d48d6f56c8b6b383fddc4ed54075cea44fab6b7db8f6ae6b3
58e795bf9d7c3f8b99493b838898f403b1abfaee9831fcca8c3280640e1fa284
d1a7c5086bc77a3ece6de35b64ae609d2bdf639fa0efca26fcbf0317e796233d
1cb0061767a0d839bc22e7712886621259304be54b7e7c94e3a9640dc5f88bfb
1cf87dd6d308f2948f374341c569a2bef69f9fcd51020f43b52d54243793b07b
f5ad7e4699218db9a65a656c1d0dddbbd55b2c497acd0772c165c6cacb6d73b4
7c98997d07ed634607d1cf683b5b71a1b3ac65accf87f789255d8ff4ee3c7a07
d9800bfa8936519f978988dc42ce9b3512f90eb7abcad5b674b0acc45cf2d791
e8a4fc01865d04102cfe9af38d3ceb5d45bd373088aa241e16dd6e8615f63a5c
24e865cbc4f5d563e00e8b81d0b4d3bae0cc45d2e298b4745c7d9fe8f42572af
9a667ba62f99fd4f97b7110bc42e44fd29819756a6db394cde7deb47b511379c
a8e31d7df508836a5ea5c735edf32a5ce3ca383b7548d8b3d45efe538929b2c6
32182ad39adbf9036dbfd7c9861afef7b6f2cdeae697bd05a916fa4c3c1b0df1
cbc928b28473afd0ee677c7f98fa2ce139a634dc578e2a92f0a47e1cd475a3fa
e02314163164631b2f81837be9898205e3afd2d91a5b25340e989e8b93916505
dc2c99875f9addf6d50f797996b9d826ffb198c7c4e6fd3bc33793e8b6f947ab
bc5a61a8e9e04cdb06959cf9cbf873eddf53f6408efcd4447752c817cb103afd
7d8c3d28687e4114cfea91ab4beaada6470fe46da66217efa43a9bce7f48e70e
b795191eba34b7df1d38d3a25f531558ae17e321b76598a5bd8232bbaac54156
5164f0ae305135b69973dbc8ae4bce362afd0a4a5c766c993d80016b9763c3f7
99592e9eec8ce2010d2668115d677f3b4e775487771205befedc27778689ee4a
b37eed927563be33f559b331ed48df680aa829df73dfc7b7f7ba2ebec9e619df
ae6b348fe702b6c650da317c94038dddce3cc3c2232bcb3cc4cf730d20321bea
906bb356bebefc39c2d6c04aea098eab999689f99ac72cbff5fd5dd087fb1760
fa2570f138cdc61c9254fc9d69dc4ec68b993a29e72d047fb480ac2a7f66a755
5b8ecc8571790fe8259fd5a3ef50e33db48f64ea7bf2060bc2e9e39d
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
cleartomark

%%EndFont 
%%BeginFont: CMTT9
%!PS-AdobeFont-1.1: CMTT9 1.0
%%CreationDate: 1991 Aug 20 16:46:24

% Copyright (C) 1997 American Mathematical Society.  All Rights Reserved.

11 dict begin
/FontInfo 7 dict dup begin
/version (1.0) readonly def
/Notice (Copyright (C) 1997 American Mathematical Society. All Rights Reserved) readonly def
/FullName (CMTT9) readonly def
/FamilyName (Computer Modern) readonly def
/Weight (Medium) readonly def
/ItalicAngle 0 def
/isFixedPitch true def
end readonly def
/FontName /CMTT9 def
/PaintType 0 def
/FontType 1 def
/FontMatrix [0.001 0 0 0.001 0 0] readonly def
/Encoding 256 array
0 1 255 {1 index exch /.notdef put} for
dup 33 /exclam put
dup 35 /numbersign put
dup 38 /ampersand put
dup 39 /quoteright put
dup 40 /parenleft put
dup 41 /parenright put
dup 42 /asterisk put
dup 43 /plus put
dup 44 /comma put
dup 45 /hyphen put
dup 46 /period put
dup 47 /slash put
dup 48 /zero put
dup 49 /one put
dup 50 /two put
dup 51 /three put
dup 52 /four put
dup 53 /five put
dup 56 /eight put
dup 58 /colon put
dup 60 /less put
dup 61 /equal put
dup 62 /greater put
dup 63 /question put
dup 64 /at put
dup 65 /A put
dup 66 /B put
dup 67 /C put
dup 68 /D put
dup 69 /E put
dup 84 /T put
dup 91 /bracketleft put
dup 92 /backslash put
dup 96 /quoteleft put
dup 97 /a put
dup 98 /b put
dup 99 /c put
dup 100 /d put
dup 101 /e put
dup 102 /f put
dup 103 /g put
dup 104 /h put
dup 105 /i put
dup 106 /j put
dup 107 /k put
dup 108 /l put
dup 109 /m put
dup 110 /n put
dup 111 /o put
dup 112 /p put
dup 113 /q put
dup 114 /r put
dup 115 /s put
dup 116 /t put
dup 117 /u put
dup 118 /v put
dup 119 /w put
dup 120 /x put
dup 121 /y put
dup 122 /z put
dup 124 /bar put
readonly def
/FontBBox{-6 -233 542 698}readonly def
/UniqueXX 5000831 def
currentdict end
currentfile eexec
9b9c1569015f2c1d2bf560f4c0d52257bacdd6500abda5ed9835f6a016cfc8f0
0b6c052ed76a87856b50f4d80dfaeb508c97f8281f3f88b17e4d3b90c0f65ec3
79791aacdc162a66cbbc5be2f53aad8de72dd113b55a022fbfee658cb95f5bb3
2ba0357b5e050fddf264a07470bef1c52119b6fbd5c77ebed964ac5a2bbec9d8
b3e48ae5bb003a63d545774b922b9d5ff6b0066ece43645a131879b032137d6d
823385fe55f3402d557fd3b4486be465959b1188f76df7824c135a7fb382c4e1
1b0ddfe856b6f34552ca48c24b57dd8448fac257c4d93fb122e1218fd36b99b2
d79dadb8a66613ef11039be77816a7a2d6781fe0d69cecc36232ae87a172afe0
95532a8c7ff40bdd4a5fcfb6ccfd8f73c572231734e0609c6743ee11010f6579
820b367c49069ac1d45760c0ce8dc1e67e2beb72be6d287910547e1b4bb52465
b75947d224998223275a2c340a1c14c04328cc2935c53ee2723f1de6357a291e
14863f6c1411477b3ea074052b30a4c1ef03ab324d678307e1cb02c7aaffa90b
73975378b9debcd3f6aab626a361be8068c60edd0b2be4a7bbf4efa21cc23607
bf7e2556c17b5923d7b0fc036d5fea743c55f2bbf72e8a61995bd63d7104a085
b8dd5a83d9077376a4ae8f0c048606bb9e84c640c52d0a95b35d48cfafd6ebe3
d6eb0ed88c1212818ca93e40614740a77c446b792d02945642014a5d55ba970e
f97dcdd5b839f621a052d1085a1e668161d3ac0227c7867324ede883589b39e5
d152793009cb5a08eb6719a44dd01b6147e3436bdbb28215ce3d29a3b1dfc72b
d942f8cb3376b4e12cff53a793d935346ceb2afc3428cd9313c671ec1911252c
19de341556999aaf7417aa5085daa35ee71353fdc2c7d83ec2dedaabb1b89b99
e4cb5282159cbfb45a286f8d6bf3abdedccbdcebaf6994b17f1be07d10f00cba
47f2fbf66c0d83921a5a0a4e2054a8a2dcf492cc40de855b476ae77bfe12ce22
d1195e3f9d51272541e21267b2924e293e7a1090b4eefdb707d2c29ad62a240f
ad89834a3b49e3715ed086a4bcfb0b5118744fda024989692cdf4e88876c2dd4
e1f3dbf5792893854a5c4495c99a9e9e2410ad797d5c79d940621c6e94fd03a3
3430a835efb9f316b5b2e732f2e987d35b2aab1f14dc9a0844e7daecadc836cf
88f60f9a62916a7db26ebe2e678a9b622301d23295fa25dd6320aab95868c984
6d253b25100a9706547c132d77a4712ceb8bc43a78c408a7055438c7e5ccac2f
71a2b57c34e33f41316ceecfad04be332de34ab341c50ba791f7771062f2fe03
8407601c22a9a03e190e38ca69e78a84dfb23dbf616d3d4a36028a78bcdab7f7
f289e6c9207ed739bc4e02a6e0c5ea88d28efac8597aa669037016e25c2b66ac
7bf40bae4706da292b1be32a85b147f1c9853a8db98b80e42b54a963d3d58229
979bef9deffb6a49863b9924f13b5ebdc2db08b760d53ad91a0498209c65e9ae
38fadd97c46a643d640c77aebef34ab7ece22f386e3f725e53b6a0a317800762
14250705baa7b4b54f6941555e1c8aa07c09e123a4e82ec18fd887fd2c8cfccf
473a54911182bf98c42b5bf88a710cc94f6ef435bf55144fefed0c559c521bd6
b1d37a2741d678f1749dfa3b308c6b7e34551749a0aae42fc82c3a4d0390560b
12d05816f68613cbd1771dc1ccdfa251006f39193f0e5008f22dc683bc94e0e0
a36211d692cbd72d0b6abbea1a313f4f4f1193fb20a89674f04d8eec9d7a92d1
d26e92e0bd8007fb6d0d32d6a130c28afae62bdd0bd6af396a677ff57c5af1d3
8ea513bbf670f3161d61ebb95fd9c7ee502dfd19bee78dfe5fc9fa913e9ac1a4
2f49feba1c3240e0d00b8e9000c88430f370cdb9f2a9818f67abbbc9bee3f169
652af4fd6b917b7b4ccbfb1af7ca5ad2056d2ca1a0a42c3449c54b2f3f6d3a55
c86a22afdc52b74148a95c673e3fbea9d8a27997d664fdecefc9107ad54cb29d
dc0300593d30dfa3da2a8f592ff057af516a08ab05a63660a16f1c217993ec60
d8cfded3cc322f8858d0923b066b48a8ccb7f9868ce7576681ac0c034a66fdab
4254a606d2ee47a7177a6f92fc4e057690f8c33cac815e7e32a14acf8c3afa34
efd1c445042818ecd618d8f0a9980870621bde37532404bd0aea23b311a9c550
719ce650e4d626df0c61dac38d2e0df6a542b6af1da4be651c9effef483be4e7
4aed0611fa98d321600a539470d3ae2923d404cf09239e864bf1f18607b74ab5
b881681716dd78add2d0f047806a11f8fcbdef23ced14d821ff6500955929a99
06e238f51661102c88725884041d7cd281860e8c2b4bcb74df63122ef6c78e6b
6adef4840157b71b0e6427c5dd1f721abd314c91b69f9bb7fb493b59f4d1a904
39c861f30ee0d10737242cc0ecb29510e9290a3d9ee6da33aa500eac27ed1466
bf86fe6272e418b7853321a69c410a6b256391f35e7de931128643a94e78e558
2a7412033d6fc19e554ef7d7b07ad13ade96fb583de99998ff87f08c424c79a1
802b4223f49684b1c324320c76e834ae22e680c4c2abe9ce3320f1d6ae3cd8d0
2610ae157396ef3a1b48803751bcd8343ab0936042f97896a4e1760a4f8df769
a097120681cefc514dee75296090a1ae4cc1731d68f24a06ac58f1e8bfa71521
3ae47bcace0a220c9f993cb181311d1e80be06f67f5ad8aed2a1137e4c1d4ca3
c1853ed401d1dc6e195726510b358c0f327cc74111723164a2d1a4c5971df92f
2c85b202db2d196e8c11f9b4d42dbd741028e09c7279f8d5b547067b776267a4
e6eab2f274fb1bec094dbf1a8598fc1e659ea4f3ee8d46b6cfc37954a8cc678c
4a65763de5dc85237cdc9780ee95659b436656b5670d7b00c9aae2c792c9793f
7cab62927736b20f2b83e9c680d14acd5e1aeef9e0b2261fe9d8bebe1e8b6030
bab14fb4c4b5b92177d2365a5eb5e2724ab43c78f724b4a2f85ecfe4d7f7a60e
dd8297ae907332892a302d3681dc76413a644bdfae118747b8c09194108ab2cc
163f86951f1a28746584fae57f2a2c9f2b79bc894aa02beda759a2fbb29a7d2d
e3099e90b8a6b57ab9028f04c9e272d5fba247e19d683dd62e4de0cafcd953e3
c5a7c58e8e09433b266961cecb626520424711e03f399c512cc225fb166f439b
bdebfb06f8cf2998b496446d6d7e84db31a55b5d9288cc31aba40a97b4efdd04
ad067abc92d3bbcd2edf63b5bd00591c4528228a1eed3a3cd95984dd205b367e
93c4fe6bfbd2cb700b7e15deb29cedba6470b0d4b18df56a388b89191fa24d52
857d5882de373df70c355f2018773c22a95ed4b4e111a987701fa100bccef9a1
d55c3a69a2694711d8c80be99f56d41b0a9938be2272ee519743f5cc9f4a11bc
36b612290a07375182f578a559d01ae6ea6d2388fb17588597fef34ed79b0eaa
bc076d6f2f7135c14c77611c495d2ffdcdf2580f94b05424d92395e38dacf8c3
8a7770e7951c502212e54e70f5e447f5d74786369f319f5d6ce543b71f49a9cf
df227ca16579670c90f04431169229b40537b76d57e844819f8ceea7d4929cf4
937d9b1b98162caeb9034d1a79b3497c8bfa091e9668b91a2a35e0ad30916ad2
877ef923e5627ef6398ae5ca3c4dd3b92b5e7461256ce566fb746ce80d923e6a
6a9ae760e03e877f16d19c75a7b43da25374c951e5db8eb5b545d98dac778faa
348bf839c484b9f91a746d3b287a3d5d1508ab4cef96ae00fb2905bed3e88317
630e8507d1949ece92d0fdceceea62d0b51be2fc825512938e56be5a9c3620a8
9ee5d340dea390b1f7f8bd7be3a5d71c93f89d9385ddece7d7292d0af2ff4720
1b06e15bad843505f328a898b98fe00dea49fd96e1fa78c2a5b988667edc23f9
f66064c4a96333cda3221f13abcb38561ed579661f343a30e1d9b402aa7199de
41db615c33056fb20589725ed78958d5b6dbcf3202c8543dbebfb38e4c5727e6
86766100cbe279974512a9a75efa92b60443d654a4cf1e37bc3d0c5d5c204ec6
6663f651dafcb121848d64308f86dc9f32637d59eaa76ffbbdcc0803a38aa1bc
64e286d8f423d551e7c227d61ef3443b1d5a89abda9f9873e198868865aa3410
eb4c1c3593c864a9cf066267b03639c5b4a785d020f4ff70420d380dad6e3ba8
c696eea544ce0af93c039a95928012416dae934ac03205d7b38f550444774a88
744aea3076f1647e12c88062a4e70111cac1f767e5c8998b3dda396dca803d24
aea5c92d583012ed6277a0bab1bf0bd68d2b84d12d24696b80675c2b1baea6e5
da053e512e5d3d7223d05b83790716fdc80ad4e452a4f4f4604cee80e15faee3
bfbf99effb7d3eaebe9a67b2ae6f11035ac7f53012c8c50aa4c99b203a070472
ff47eafa870387514f252ac57ed5d3b42ee366a51a88a861b934aa9132eae760
0c3b2d9ded92482306e0ac2823a0dfce295c21108228889c188693ea677d5d11
4d2c37120866933d306011879ea6da0e52b186b6b8eb71abe715078dfd91fb69
5ea99fdfb6750de8d7a59bd8222b3e9b8e135c5ce95ab2eb06e18a2bff50c807
76f2698c378f2276e0d4fbf6d1f35d1f184486029d806c84f1939a9ee017f2ca
0c126cf62352bcf650409a81a5bd316557903e1cab44b84c86db6dcfc4f2e75b
29ab95962c5984cb84e1522b38c8b4e1fadb3a90d3cc40df351241cb73b3327e
9b115f1a593567fc03fd8f3e4354435f8d0fb1df480cfb7a1b3bdb7a69c7123d
cb6828214baee9bc4e48ad74dff6114807120177bd6f83d310fc8fdb2fbe8155
79493c9fc7cd147d8a9dba2c413a7f46a7695cb8d6c978a8fe83d89f988b519f
b790123539ac15a706c416701bee3a2989b6c39593621a4fa6f2afd25f400921
c6e252daac8c8dc5dd783c3a32bcd1859b35ddea65647b14f33b0f90d5d3f6fc
76ae07977930e5c6c5638e8f194f0502d6c19fd617343b6cfd53ddd23e89f3d6
ab7d3d6608bcfb0106e48e97f712498ce34e14076f7fb2d8200dfe155450e0c2
d4d266e11d56fcac81ec70b07b4e85bef2b45c168c0bf4ab7d3b9acbd42b6362
4edb586f717aa8df332ec6760fa527d7ebb9cf078ae7dda71c485f7f497398d5
6aaac789fc86ca7f9845565b0beb836cf4c5bcc9011b87708d46edaec7cef364
dd765b489f02083ffa2dec4d6e5813e21b0710d729a757a131edb83b58cd6954
45122ccb39b5cd14cc292783ed8cf150c36cab1117ab4d0c1ad8961ceb7e1903
02b5e3154f6b9b34f4708fbe395e9fafdb6b12d8060b73336715f403d8ba0b6f
1e6b90a56914508449495f75385968c018e49a56483a66bb8726a58fbf224261
50e7754624877bc22247f12d07fead9c4a96cc75f1f79b63a2399168bed673b2
102f9e7dc395186f899ad0e7e30e85eaa93b49e19cff61bb110b5c2dbf97576a
6dd4f0690222ed8c9d5ae7a59154acc0f77dc6cd214b28b763ad9ef5690f7b01
304711a91be8e287fa53f985db0753782685577c39ffd30633bed1731c08fcb2
bc2132ed10c6ab00de021b1dd57f46e3323a3266b16aedbf8a0462de0172825d
ea92bdaebce34979a5d9129ce5bfbc7eacf8c6ea04800c293e63dc050018ae2e
8d6f9561a08a8045de82c3c89faf462ed9dc361a7d423858385434b5a8815946
5cb807851d4589764dc9a3ab593ab4372393fef25de0c26bd355e8b80181a445
d68f69a232003a776ee5389fc16fa53cacae1a4127030f7a968b62d14064781b
49eeeebd9e888bfa3743d886d4a226eabd4a75392d92b65c70161994aabeb190
9126a8803da6657193b156e1a37e5dc1f0f1351102b82ab27e0c70630c433d09
acbf67d0545008a7b85367dca7a75113956a1864407e71c882af5db11d984f00
113a700fe67461925c3c212c13b5544f8e0bd6ce86b94f63f5d651f7fbbc5dd9
0466621bc02f1fce4d35a0e8d6ba5a18d49d0865a285e137a281b9a9947f6388
f41f7980f47cd14875854a5bfcd6a99189b8599010980b62a34224a4e5afba59
e766e84709f08fdafc1e8dc985f8eba75c7919ccd35bdd9f30aff94140672dd5
0a10177a44b7b767209ff0e4c0952a70de855469b059aeb472a3e6eb201bcf6d
ccf84e422c528311713ed03b6d6c7c75bc68729705ae210a16df96e8e6029cd7
0a07e73f9a1c3bfe4872b4deeb3dd3686aa9f409522b71e58899be22f19b22bb
423c98d83a2accc5c41b27d81cec50f6fb29a668c809de2b98de9b5071e4d679
86e850dcfd38187bb832fba5770550ba6701822faea287d4791e904114411ee1
e30a797b5ba6fbfa8d25c074201df43f101be49f6a347da483cd957635d489a7
1c08d9b7b6d2b248ebcee76fa231095939ba6c44c7583c318cb11667c99c0912
7101e76289fe5fe0af6389ae882e6d95d45167c3ce61858c83fd1a1669300ddf
24b733b70a55e1af535c670078f55f9efbc53edda7eb104dafc77fdada2ff23c
234c2a59f7c7bbfca65d3e13c5a729d61c1dc8fe95f290ced0128fc6cbc681cc
a1f903bddc410a872179a40befcaa3572f5f0cac995db5409d69606b703a479f
cc42dedcaf0b6b83c9da2985d57c81af54c1ab8be3d8bd30499e0fc31c71ebc0
b28263a293385a84f5f226b92d105a8b70d658dfa86525f9d07cf2dc844fc78a
9c18114d239a2056d714ab04bccf9d2ea452e1101f02e3f55e845cc11915fdd9
b3c9b5710fc47321feef7870f48cdd9980c58643f4b57b14cebb9fc0476cad28
36fd555b0a32f186d06a2ded377dc3c738ba7357d6fb943eb8872e818ae96be3
7406ce06652eb45bd47460f4067988184d5034302536b1b05d202dddc0914871
f3ff837157ec9e4dba1a23aadc30775166a692fb43e306a130776cbc03c10fc5
c83be133643c0ff21dfce16862a38c7690fbe3b4403ad554eb76475daaf0fd2b
1b48350cff176b4949810b4968b0a1ce29e568ac353b6141dfa624d178dfee49
51e9e10e4b1aa6523f60138e0238940a829cfc5b1f79d8919beadbe8a8eb7b65
ce2465048687f645aab630300ea7f2766b1f70529b3bee5851de22bb61886dcc
6713c26377776ed61036d8d4f8bb421c9e203286d561f104b4913879ef53c1e3
31fad41866074dde252fa77d2a2a073a787b90aaf599e8ca982d321c814e7efa
9fcc2721643d5bdd272fb8fb73134d81ea1657a1c1edd90ef53fed6a121e71ba
04422ccf482796cce4b8e62510518384d546ae48cd58917219b2977054f70306
31bd31d689baa8956b4d8da0eb5185330f527510e3b36aad65d76fcafcd83450
0c2e3f8334b26d02b1511665acb343f1455cc076dacff91b32cbf50268863f14
93fcec8c006626eb734b516a666640e6337454f3323b08ada4e17fee1645c7c9
a79bea29eee77bd0710b6e0ee56d4e8355b1ce78d0d1b8cfc53c7e086d1ea085
591f203d4e9a844b94af6f904cdc8299f386a0bdbe6ba038e7c7aef330f47daf
26fca86b60a8ac1e8d234aed58f245b30229ee726f88ef6001b1bf14bc6c1f8f
6d73ca0af787edd2bcea327896cba452dd277d08a2153b6f05ba8244d97a39c2
80b562204a19e9ee0cd5e3127d29f31cf2f3c953961949dec4dfdaab61ae7bce
e0fb9817962d553b2542060466c7e29aa7d8eb346e7a27c904c2161f0f01e5cd
7d955a1d6058f1107634e0daf68e2f83893d96f0488185e98ef856b2a31d41f2
bb9d8de04090734b9c97fe8dc24434a95d839960338b1b5d507c622504bc63a1
601b639026693fe3f56970b6686baad1bfabca3b9f73ac30216d1b3a78f330b6
79f02d045dd6dd3b295f4bb9820451a444aec5ebc1442e49891fbb3eb89ce9ea
baf485aaea761cd55ab0c1d9b473c3e223bec1ba48065ba649bb5801e9f2e7b3
fcd7ca4478b81016160a1b9f1effbbdd6c2a73e76284f259a92fa9d0f88e8cd6
7ac58fdb55fcc58b4868e31f47c00780beae8ab0e8a8ca8005f74dd9ffc83f7c
0e05770a013434034032358a9fd953b63d280f50477b22c1a7674a0d1e516e01
67024d355055255b91ad107f973a5f5a1d81eb07dfdbc7ec981510e2af00bbd7
cae739787073af7da88dd5d418b7fa9c607ae3a7062596bd0c0601137b46beb6
d5e94e182e52d948f17fada0254f8dbb766d8b660318735455d9ac3a29c659b3
804c58a919e7cea8bc1c236098b65f4053d0051baf3f12f7983dc4dc13cd7de9
320f9057cfb512928a87422ba45a1d3c3ba72cc71bf7d581beb99afd23298cf9
256ab7ede2fe7dd894cd77570c01b9a5f53c6a399502f9328f5217732685ef87
2d10b23b1fdfd590079abadb10685101a80026301082af6ab2dbf091ffd7c9d1
064dec4d638a145b4962eca80113e95757d06cb9f133a4ebb5f07aad5ff0b313
708d163d379afe73f82e4d432f62e181e5292edf59cc2159ba985fb0803eaf74
b25c271f492ac0bcd83e4c8412ad489a60a6511c1ac1d85e29b4fb4fad2a9e12
311d2919187c175fcba67db5a2d342c596b43a759c8ecb9c13752cf0d440b54d
51f327e9ae556c3703983eefbcaa5241609bca335806e820c0d405314cb91f53
409b98c548626181fa77196106f83d0e8ac0aace4e5674b89f2105fee7f0771a
cf54ceb4ae7b8a88a35c9d00364b796e97914ea20060379670e59f13979c80ab
e74f48b9e22e73fc673b7af40196df3aa0773ccf41ae5b8898c53bef5e1ec766
887dc1a6d35a985ff8ca9a0827d03dff239885f83af05e445a278145a967368f
a95f54a19dbe88e7e01157e6d43c87c3a1d4871f9a4ae9e9da6abef8d0634c57
d2cd9f6cdcd09e063b895958a0108cd1c8b7d943840e97ef480a95f606c2076a
bb55237fdec09510057eca0f0b83266b1e2258464a79e5bc22e2772c4e407e70
ab2a0292df5dc70e57f0ba47c9f86ebf7162adfe1dcef3613f6328302dcac08f
3630271d5fa17ddb8c559010699c73740efe2c447ab4e7ddddcfd2d52f957b0d
43f83c0c1e0669c5440df0e3b6a95ade51044858bc25bcd941a993df742a12a9
626158ce9e655e5f14feb0296bd829137e623204148bb3d95b4b7e70a416981c
8bcf2993ccf08b8f8254818a3aeb2461e9589df367a6b921b3115f3aa7037fee
e36eb976b92be7fe5d946bc41e574fd625c2dd7d3b331472bc27a6ce75ba4ea4
2e5c05cf49e49f98b09956d6e5ec469ce2ab51ba25981abe434d50aba995f12e
0dd5a215d97036176df3dd864d501054c7504349499a759b40c3c55118015917
16a08c02a2effa4347f60d3b644b3dc521b32cd876b4c3464ca5f95348eca7d3
f770d3535d6bea4db81534732939f8546d7450c2d19f6600efae206291c6f0a9
9d2ad3bcb936aaaad10e13c183245f754d1fd1fb68c7dcbec626a326b1d7fc91
4ed89882f075e70927cf5e3056d039246c6a9adf9738fd1a81d8464530770541
550f7048c866f108745753f93ada24e26bb181582a6715e2d320833726a64500
35a69da12ce24c164661bb89141072ccf5239723772b4c9c4d000c7a743aebdf
20c42c831f9f863f37afbbf03b6486f2898688333ad098b19b318875f6672c50
d2d3dfd033f6ab4a665fc4c3f9a6218443ec85fb9c63187658fd958ee81440dc
459af8102f861a838b19e3b945055102ee135554e3fbfb199f7254eb73e9ec61
b03f37711fc0d2ab44afe305c485496ab9051d81545270b734035c1ef94f12b8
1f7bcfc87ef95790b5e0b72b03221c2088e0e0f98707cdc12e78452ffa579713
43ef570713c60850ae205a9df9ec57df6b6bce7ba24dd65aea275c87f6828137
5d7c9b7ddd7a705eb7f3269240077c3613a94fb189fb68f9d990749b31dd9494
0c766b73e5e5023dfecd18d304f1be3fe57f86b298974cdb34e0dbef95758ed4
479cafc7ee703be31981168eb22092a0539e2cfaa25775d29aa97e0130d42b01
fc818186e7fd1fd2eabfd5be59da7f2b17c8d5ddf2e3aa29c45159af88432af5
0855240108a1ab6d1d3f48a343b1eb45a1fa0f95be1d05fb26af2edf065b6276
159a6f6739716055293a0f631d8ef8c720ca74ede7c4c65c149c71f89a020818
8044b894705af138a192d267bc163b68774b9dbe12da441d9bff971c3997a418
68658f3225866b40d3cf40e7bb1d20be314cda8ceef54f4e88f7fa23ac52e52f
51345fb28aeadf284d7664f8de57b3debd9ab4c39dd070ca76b8f339b76625d3
9b26679b127f0816bb20cb05c553d0fe233df148e0d0d1bdea34f6ae3fe9cebd
f7a4932d6dc9bdde8b91c63e5a3249e61f3d42f89882c863b986edde8fe5f537
124c6b02988b94f7867ce30172d7c84be71891691bd2fc21a2fa99ca7ca1d477
f4314bed25b2ba3d2d973588fb7625e194b6f539c7815f26e7017101b4108358
e6b414cd5849d1a1c3b4e651c2d29adcc2af3144e93aa12efe54d2fa1cf93375
e4c990b68cdd3fe7971b371aa28ba39b8d0b5292ae2dbaa291eb8cbfebd6d37d
dd30450919f3a754b6894f44b2f068d62c2892675cef56ca89645ca0969be0ab
019760ec96a28c9091ba81c05be2d3abc1080ae55f29050f16f60e1c8bba2cd6
93e1ae1cc09d145c2499c4d6d202be9e9a4943853cec80911ea2208a473c45ae
24bfa8d561e5c5342c3ff855364b66426cf08ef6e6d0f8a59fc307cee967a220
f9008515b96711dd019067dc15b83751375c484c858e0727cb13879fdb4c8033
f9fa3a22f77a4264be75bed162b17530b9d24c92d07300d64214bad1dfb55c36
e256dd73828649ef3af8d0466dad11bd52fc7dbce3f5942cc5818a0a94e40cf2
86e24aff4bbdb450248977097b1f95f7a99a408316070913a768057504bbf59f
b252952097b4154b678d9d074112df662d41836cfea460d60bea6edb8615ee8b
3959c1e4e51bcb2523ebe76ea634779a45add4f81f045a734c878acc96e331f6
a26026841ead8f0271c1c785af9cb5afcef0f6fbfbc1f91b33922137bbb05a1e
ad31c99b9c2e872d797b5e4bb34df05ae9b26ff982922fb01f6a54a04f905c1a
c4b3f22a6929881bdacaa2d780abd08e44c6c3711d6dfba8020d692fc8155755
efad315e1b12d86871e35eb58330d3146a236500ad8353ecf7542c642c182dd5
5cc55b52336fb0817583ae65de85245e7f7f611dfcaa6fa28a7b596603686d51
00fee91db6ce50b1562209f011d5d7a9ac8591ff768f75df44ca1767d3b3c403
fd907411a00a391262e94f92f6e1f4afc78f787abbe7f3017113a760ebac9da1
f96014c02facab1f507c6d9eb7761d063c3f496e550351917644eb309edc8dbd
eb6ba0988d3459b1c80ef7563341927de9244da535d68888165d326d7fb269f0
d3a81e5ac3b2dbbda0ea637c03f0844bf8a03877effb4f439478a106e73950ee
41622e2f8f6eab8e6d68ea45c6f3eeeb60a63048f945d62a79c930a94414664f
a61512144d8f13ded2b072806674c3d256e31706c538ec5920f94e4c9071ed5e
c276adb02d1246cfd6a700140b8ee9ff9281e93d91a5d4bf41af3655c8a38a61
6b7b0aa5523fd8c3e6e26b0ab4b21ef57d35bbf49122c75589e99f746761075a
aaa966dbc4b06d15b5f4127e99d5c7e9f398ee992ea1d47ff2eb3ff33079d62d
2a501e304426aff56d77d4af187ba4cfbf453e311435714aca6a07503e248391
db3bfa4e76c9d2d5cc733cde3d5b0058802683176d4958b20c7d9218acb128d2
3aee2f47f987f922ce52e4edb1d480c19f6b3a6f079d2598b16416099df0b62c
e6a4d53bd2d0a259a969798f3a0095a00dc1dcf69e2d6e5c831139e48280af18
101531c9a5b5a509221b8285e1476b7caa6ef5513b2857c4f77280d83c25b55b
f891cacb26880bda81311f2e23b243238ccae38c08b792ff5c99f0df26a08050
59b844efc20a13d906be11ddf0a8184f31feae7138411f779eb02d5a008c4876
f7900e07fd44f436aef07bb446e378ed0c16c8a5d6b6dbbd3957fd07c9fbedec
d52b056e893e16f88e1bacac1e1e0874e4625ed089357772e87bc32e22946fec
8eccd9673ffa9f5f0c11b2061205fc99e20475981ac88014bd585c0c8bfecd0d
d79352aa6b77e0c5e9a28c7da2c22d5f758924c6ddc03f20237e08edc7aef853
e7ae3779a13ab89559a552028d68b04670bc06667c0f8e351d7bada27b1668aa
e774d7d99296610d98f19d0a24b53ff7d89836c46407a4fb27f2071d2d0f4dcd
28214db44f7759ba64f7adc195aaa7fc78ed5fd61f87db89739fb54b30fb3776
b7906ae0315bbf136e7f4d6d4a6f947b423c7b5d9cec0eb24e557eb24a09ba9c
a135b56b648847e3bcca81568b1846db85b93a3ccf3441dda74da13a929f0cea
9426fe2ee2073262c34aff6a0d06c77aee3257f23e85cc6af7050c04595086ca
749b58da7b5a22f43732bae62b670adb88ab48534bd0c460b9220e9d4d429fcc
cb30d3c3260579c7e7b2b122b7a6907063d9496efd62b5b77fc6ed8e6f2337a1
99c303c1810cad40e1827141b78d0518dc2b2e0272a87d16b98006297ca2cfe3
aaa93b6d1643f2a85964cbb65624cdb346f6c4c046c904e1d34f5a67a648261d
d839ac18569a1a550fe4b323312a925ddcb0d0c389e69ae262e3e8e79e3e5666
d2ff88ab3a511bd776df7b22ad9c5970df9e0acbf9ecc8739d831d350f3ccc51
d8c1718c34555e6bdb190befb5089a9a0e7156aef063ea63cb43456e1b6b8d36
a48af51bbe4cc90873ba1adc55717c6e810db8cab265544f04a1cdb123ab962d
5bf1c78c5cdf2f1b06fdc4b3c29fbeebfe20ea5b0131707b7ac07cb541a54891
f9e7cbf2fb5f353d8f4a87ee57d9658cdec8599cd79d12e4064496c6d70b4153
ce43ad12fd309c5595f8d4eab99258cea910c038cd29f2a2d4b6f2471111aab9
d9448347539007be4a988d76d26df0fbd1b349a470b63ec1ccc8e31f8bd57fdb
b4a82919c9ef306747f4699258499c57cde5830d1454e41df6976f627fd322c5
03ba2ff729402cc6b637c7521bf5d24b2eb54bc2aa3170358f70c68c993dba86
7d2142649acff15f1822d91bc412bbabaf61775e67a07dffd8381c98557279e8
9cd4563f32360563d706a6ed5fa1f211357231ad86c448bdf61d4de9fe29f78a
a68c34ce95e16bcdacf0c06008d682eb736f6d575244281ff36dc9a9fd903db9
8fb6
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
cleartomark

%%EndFont 
%%BeginFont: CMSY10
%!PS-AdobeFont-1.1: CMSY10 1.0
%%CreationDate: 1991 Aug 15 07:20:57

% Copyright (C) 1997 American Mathematical Society.  All Rights Reserved.

11 dict begin
/FontInfo 7 dict dup begin
/version (1.0) readonly def
/Notice (Copyright (C) 1997 American Mathematical Society. All Rights Reserved) readonly def
/FullName (CMSY10) readonly def
/FamilyName (Computer Modern) readonly def
/Weight (Medium) readonly def
/ItalicAngle -14.035 def
/isFixedPitch false def
end readonly def
/FontName /CMSY10 def
/PaintType 0 def
/FontType 1 def
/FontMatrix [0.001 0 0 0.001 0 0] readonly def
/Encoding 256 array
0 1 255 {1 index exch /.notdef put} for
dup 0 /minus put
dup 2 /multiply put
dup 14 /openbullet put
dup 24 /similar put
dup 104 /angbracketleft put
dup 105 /angbracketright put
readonly def
/FontBBox{-29 -960 1116 775}readonly def
/UniqueXX 5000820 def
currentdict end
currentfile eexec
9b9c1569015f2c1d2bf560f4c0d52257bac8ced9b09a275ab231194ecf829352
05826f4e975dcecec72b2cf3a18899ccde1fd935d09d813b096cc6b83cdf4f23
b9a60db41f9976ac333263c908dcefcdbd4c8402ed00a36e7487634d089fd45a
f4a38a56a4412c3b0baffaeb717bf0de9ffb7a8460bf475a6718b0c73c571145
d026957276530530a2fbefc6c8f67052788e6703bb5ee49533870bca1f113ad8
3750d597b842d8d96c423ba1273ddd32f3a54a912a443fcd44f7c3a6fe3956b0
aa1e784aaec6fce08dae0c76da9d0a3eba57b98a6233d9e9f0c3f00fcc6b2c6a
9ba23af389e6dfff4efec3de05d6276c6be417703ce508377f25960ef4ed83b4
9b01b873f3a639ce00f356229b6477a081933fef3bb80e2b9dffa7f75567b1fa
4d739b772f8d674e567534c6c5bbf1cf615372be20b18472f7aa58be8c216dbd
df81cc0a86b6d8318ca68fe22c8af13b54d7576fe4ca5a7af9005ea5cc4edb79
c0ab668e4fec4b7f5a9eb5f0e4c088cd818ecc4feb4b40ec8bd2981bf2336074
b64c43046fe6e8a202c241f339425066bbc9f56c37232c6abc503843fd3a8dc1
e0acefd8ef849cc136948ece005ee47648027fe3939d63f663f0bf647dfc622a
7d10685e5451ce813365a9ddfd828ceebbd06ea663e292edb3167c5dc89a3413
613eff463eb9b7d25ae9eee8f0284603b19280b068bfedab909cd3039253678b
150816fb8e0b23fc1d16635c4905b34a0503fe5199040a71e2bcfa88210daf8a
65bac4382a21707ad50284745aa216868231da75739af95c365bd730ab86bdb3
ccf7dc89540aaf51180a3bafdd2f8f13d581431eadc90720b023a91eaf099d90
06fcbdd465a83714214a44d9f8bae48f1e60e6d551a16b2c50715612efe487b0
1c70b9c643091030b069cae54e3c9990f966dce204af43280404a92978444c2f
5c7441c67bff756a78dacbe8d3371821375ef7d1c6f042a31594d5dc196c8a0e
9b85da3d11dc60f806f5fe07783006749e1b6ec0aa8a4c10b7ec1f748677c1c0
e97bef5d031323f1a828ee0cf8fd0d671ff0a53974034d174d1ac080462633e0
634d0a3ef68bff59df52a31deac804a0298011c262ec6e01425ffcb94ed06a24
abc89d902c8c49b4f094910440d0ba44b99eb17efb7aa2c4231db50a5f7e3423
a8d260a4cadcb4ac8da007fd200e0b16252215723c52908ecbde578d8ad3ed64
66208184ead0a445d0030833a752bdeb404a1d81e9a2e660153bf2f86ee05171
66351c59d3d0c76dbaf802dc36c809d38a5dfcc6bb69953b230735f4834f568b
f9b4843e76e20b86919b7d7b1a80d10ad1037d486a4fc66d31d3dc55534b7749
cf1db095bba0eb85486ca18bba11d2a380b189d23360d0d8441987a1f18cf4be
f142d6c2de12576dd787d6d755583189746bbdf6d3bc83e0a700bdc99f7f5b18
0172c58a2e0a2550181402f015d8d22930ada9c68fc9ab63fda9fdde631d18d9
4866b67af45909f0ed31d3036b3ae4b843ce15456d8e79c51078bee9a9c95e8a
d46283e460eea47e50f87edf2faf8279a1d1b8a3bb6e8a2b3a118678969631bf
7a3a8cedd67e88985be41d2528ccc390db8d8fc0c1ddc9c9d11713f0eaad8382
1ec2e0818d8ea328ff294e695d138967816d17e13520ecda6de7004540438018
8dbb5a74c55d59108b3b11ad0ecdb8af70e54b7be3dd4be5e00cc0466d1873c0
c0effaa2e5e2e0d8d90e8c9c1f35623cec8495337d876c3fef3effd03d8175
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
cleartomark

%%EndFont 
%%BeginFont: CMTT10
%!PS-AdobeFont-1.1: CMTT10 1.00B
%%CreationDate: 1992 Apr 26 10:42:42

% Copyright (C) 1997 American Mathematical Society.  All Rights Reserved.

11 dict begin
/FontInfo 7 dict dup begin
/version (1.00B) readonly def
/Notice (Copyright (C) 1997 American Mathematical Society. All Rights Reserved) readonly def
/FullName (CMTT10) readonly def
/FamilyName (Computer Modern) readonly def
/Weight (Medium) readonly def
/ItalicAngle 0 def
/isFixedPitch true def
end readonly def
/FontName /CMTT10 def
/PaintType 0 def
/FontType 1 def
/FontMatrix [0.001 0 0 0.001 0 0] readonly def
/Encoding 256 array
0 1 255 {1 index exch /.notdef put} for
dup 33 /exclam put
dup 34 /quotedbl put
dup 35 /numbersign put
dup 37 /percent put
dup 38 /ampersand put
dup 39 /quoteright put
dup 40 /parenleft put
dup 41 /parenright put
dup 42 /asterisk put
dup 43 /plus put
dup 44 /comma put
dup 45 /hyphen put
dup 46 /period put
dup 47 /slash put
dup 48 /zero put
dup 49 /one put
dup 50 /two put
dup 51 /three put
dup 52 /four put
dup 53 /five put
dup 54 /six put
dup 55 /seven put
dup 56 /eight put
dup 57 /nine put
dup 58 /colon put
dup 59 /semicolon put
dup 60 /less put
dup 61 /equal put
dup 62 /greater put
dup 63 /question put
dup 64 /at put
dup 65 /A put
dup 66 /B put
dup 67 /C put
dup 68 /D put
dup 69 /E put
dup 70 /F put
dup 71 /G put
dup 72 /H put
dup 73 /I put
dup 74 /J put
dup 75 /K put
dup 76 /L put
dup 77 /M put
dup 78 /N put
dup 79 /O put
dup 80 /P put
dup 81 /Q put
dup 82 /R put
dup 83 /S put
dup 84 /T put
dup 85 /U put
dup 86 /V put
dup 87 /W put
dup 88 /X put
dup 89 /Y put
dup 90 /Z put
dup 91 /bracketleft put
dup 92 /backslash put
dup 93 /bracketright put
dup 94 /asciicircum put
dup 95 /underscore put
dup 96 /quoteleft put
dup 97 /a put
dup 98 /b put
dup 99 /c put
dup 100 /d put
dup 101 /e put
dup 102 /f put
dup 103 /g put
dup 104 /h put
dup 105 /i put
dup 106 /j put
dup 107 /k put
dup 108 /l put
dup 109 /m put
dup 110 /n put
dup 111 /o put
dup 112 /p put
dup 113 /q put
dup 114 /r put
dup 115 /s put
dup 116 /t put
dup 117 /u put
dup 118 /v put
dup 119 /w put
dup 120 /x put
dup 121 /y put
dup 122 /z put
dup 123 /braceleft put
dup 124 /bar put
dup 125 /braceright put
dup 126 /asciitilde put
readonly def
/FontBBox{-4 -235 731 800}readonly def
/UniqueXX 5000832 def
currentdict end
currentfile eexec
8053514d28ec28da1630165fab262882d3fca78881823c5537fe6c3dda8ee5b8
97e17cb027f5c73fdbb56b0a7c25fc3512b55fe8f3acfbffcc7f4a382d8299cc
8fd37d3cea49dabdca92847af0560b404ef71134b0f3d99934fc9d0b4e602011
b9cfb856c23f958f3c5a2fbe0ef8587d1f5774879c324e51fcb22888b74f2415
50d7401eb990d4f3a7af635198422283cac1b6cd446ddbcbd915db9bff88844e
784c6bf7389803d9450b0c21756a017306462c563d51ecefaacd079732f12c29
315e4b9623a5752c6f1d8145869e120d910b2644887cea7e30b15676a92537c2
9d3aa80dc30082aba94b40990b82fb1a877e805e0c8c48f61e9f2edac05b944e
e4d8084ec1d5cc517aaeec5b3ea379dd011eeb454cecab3ad2443c887c582789
72355673e503affe0394fc7db31de364e4f56c24033c7df2265c56445ec63a1d
5695a6041ea1b94407e1cdb7c5635603a4fd047e6edcaeb2d0da6c9e0e9396d5
1a4a58e8fdc1578730f992435560a6e2d3e3687703ee2f78f5896389ac8470bc
806169eb01762e89b6dc9adf857ead656620e2589aae722c37a2ed7a2941c360
b067ee34d8d5ca3bf68db725614d936bcb207781f4d4ec2ac67b13a5ad161f3f
059add7b5e3d904831e31c20c04546fae83ca93a35989e65c201756888f727b9
7e5313c9870ec96e4cec3901ea03a5c744754485e7d169bbc98bf872d0796e18
9d43b712950c3786257d8be06ab6080b9d9392313298327549a8a41c00a2cea3
690b4a333e45aa815a64facae1c2b44640860b8b8687afbefdbd5b4a541a7251
4ee7d3e0752af3e96a88c95d31fa16d34ba2f02fdb0088b165844f02611c734a
dbcc2037bf741fdea7e8bcdc130c70c33772f777d8bcddf4611db99001ccff14
d7af2bb05defc3480bdab312a0eff2f375afb4e0df2f803c594b7c93f71ca4af
861ae1711932fef19bfe2f9b7adb69d68e5a70ea4d1a3d5bd85231b16993f65e
fb37a0a823f0542f8c2340a073dc1be4a8347f9d3068a6435cd8278b0db1809e
8af9664c2c989b9f16873c009449b6284b85da4dee11c96a05ba83292f0edbd9
2cf674aad6ac1a5ff966ffc37e88a66048deed053565b55ef6bdb8c2f2f67832
f8939a32442ea54f13d003494d6350a2864b427a9126a9c26a031909fe53fa84
63b80c3ffd536c9a5dd29ceb03148dbc24c0033ae3542e26551168a474b72c73
a7e2c34e90c8b7c4125d8657cd89e0449b5969f05212e64175cce0f9faa61069
ed82a8ef9276f14e2a08d8dc7e5a15f1707902c2b2f41cb1fafaa593385c2ea4
1499e485ac560bdf047680f9ce615f750000e1c30ff1b6ac44e0a4425d941622
24e74d9a481598245aa1a2b368da7c1f71bba518d1327a44d8b4770fa08ff5f9
1134098c0f6d7aa2c2270ca47c418152e453602628fa113422c703ec5648a554
91d86aaaaf1ac92fc3e64e0e403a73c84cb4fb0a0232e1a153b61bc15d3597ca
de297aefdeaa415fa7362d98bd1530cd1d095ee20df9ef192c4b792d0d6fcbab
489cbde3bf9d3d265b49ff4376f18c3b5304b1c1717445719752584a288a3fa3
ac1a6949407ac9bb3b9e1e6c2a146a95369b2a6b80ab35fe2b732c0c0cbcaecc
e44c5878f9f82eabef8bd61fdc1be629f02a222b0ac526e269aeda73d5a86f49
be122b6158308b92cf0d52c67643bd399bc6cd00278b9ffc87e1d36a01ec851c
785de14c19cc5c037ed88981a99e2441ce04f5dc89726918091072bb6bf3b457
37b7ee9662acf6e3b6d6c92c18a1c2e47dcb4e867390ca091ce320cf1a167584
a7f8e1b065c1751cbef485afec38d7dbc4b5817f142611ea09068ce0669554d3
23174c5e507ec1cd5ec794ff3664d0b1075876086265318e7a8edf786c230e5f
bbad1f7d9d6ae0f82bfe10e3470b4b2fda7e06a05c751c6feb894a6d564e4db7
b7a25df48e5456b22413e010d6ed3ecbc342330435c49134342f0d2e0c249682
f168a2816f19f52cf17ddd10d149acb99c941c21fe24b3732b9b7869807f3163
0ecbd763735ebb37360994183d64c06261ea9958151523d330c3d93f7331b85e
8c2db9f8c32d7424f5ef65f95b05e97d07cf1065b770d02e15e1150caede7c70
e9bf1ef924c4c3dd2f5cc6a7afc5418e3d2cf6ca5c5926a7aaf02b6c454dd352
dc85580cef060197352246755ea81b7f34df5c8acc72a4b7087bf35438a8479b
ca84b8f0602e28dc5d89cc5c889384075f342dff394d18db4eaf95370108e284
09f5f6b1f8ff0dd5b72ee490d646198172e4915b7a18984c624ff13f7c90883c
be9744c2315dfd31a187b57b5cf26fe986092c223b861aeaa199ab21bddeae20
db59376e19dacc83fb894b16c359aa38b290f35915708004c7fea1d3a382a94f
4e504dc69570339466551150795adba0a87d63be1243eb20419c3b465dfa2a37
c805519f0cf7811868bb54d3a006c4ab5e7fbdc971a942ff3d87237d3de8b1c7
ab8ae9a00c138bf647d640a227ffe47a2b2045d6913ac3e4bd4ac2d432a248f5
f6272863dbf100179c41ae8d6d78aae8a226b788d6f958ac1d60621e43f3dd2c
30186baba73ef66f861e209cfecc9bdbc098c8d5f15559d76327bb5655dea0f4
bd459fbcd0cb2342fb4927585c80e6fa9211731b3ff019c134d83c401ce339da
523ec9581229591cb70521b208a291096b1b5d008b6873ee04bab83bd5af7003
66bf7e196543b213ddb44ea648ae143a5a388962a61a27df8349ae2e8cfdc9eb
26b07c8fc467a8c67d67d8f7f30a68b2639c6ba4b3e9068fb7e1d7de20a9f5cc
23abe244b5169b2023b1bc4280e4c3684ccea6acae5eae3a6d72dd53c4d9ae30
ba9d8036aacf07897e56ed12710df2a75cd5fc0bd62a6d2ba1ae335a94e9a8af
290f38b7dc25b57ae911149ed43858c2af87a37975d4936ce4db98734b1edf7a
0e3d288f431da6dc38859c2513d311d04e88ff44398691ceb14fef3946e5c7a2
ee9c972290e838e44be2bbe3d3b50de0659b6516c8492c1b5b81063ad88859b0
9040e6032687a4f910269e584f05d82e5927bb3dc3b8db03d93b38d3328ec6e2
03dfe6794c214bfaea359cd318f65514d875a31d55958f1256f1d86653ad38f6
8aa141b14bc8ada10943a92f0031f7ffdfb2a4b04b52e53ed808d97f1309534d
75f1094d871adcaabd8ad439ffbadb24813c9dfd75945116fe2c64b7f7681846
0297dd1be13cc0047c0f28a8bfaf7cbc9f1792ed96b93e88abe7af757ac5e3ff
35c739abd6ac5beb9a9f0f6016927db8280715c3b48a307efc8fc192765caffe
95ca343222c70e16d2e6c129cb2a9fb1461e5e1b344f362d8529a89b15d16b4b
a85818dab603ab5f38d7dbcd23568ba6679689e4ca106e1c8fb97a7bc36de37b
b978448d898203e55a87e86ed0b99ab7377101ed40eeb9e9d00e29d94c9f2c7d
280e4d9fe4e7a3f756b70c8d83b1d45847172a0ce2c834278ea0d655338515af
216b24ec05f5e0ee2d4484eba9af0442f1faeed6e2b7ba24a85ab5b8ddc34c9c
38a4f86e1e391ba0ecb1f5c6d394768878adab8b5cf7dd6d312c7a4cf5557e37
8de3ec35017ec7894094337ae5f6d7da4fa32047b6f84286fac89a5a0bea541e
42a4a5ddedc589fc6cbc3362990b568ca8a0fa3a4051a99417858bc2ccdcc57b
56b05b55099a10852327e51703cb8feced1403f9f1e81f8da1eff8aebac3779f
bc56f57f9d2392da31351c82c9b6fd7ef1d384d3004657a983b78ed4cd081a73
d2c7aca0a7500fce5c496a1ef3e4d5254d69876204e4683d50d223f998767474
0d68035c8d2b2d16aa5d64b3c101f9270f1ceb3c30bf6935ff51c1c0ce39dab6
1f60e95ade4137db180b70f71b70968a8a33f238d4237f4c3570e122b3966d61
4d778e76dd7afe60679cec6030e5d38bbd4fccdddcf55b411a9c0b8d3ca48d79
af447bff0d7c29fbf2c3ab5e5efe3e7828a70be24dc97a013aea4ad7d2a33ba2
425874fd152bf2959514d72c118694984f706b680d9d41c8eb4d5b9095d7708a
91d060e6d1d2cae053a99d6e123b1fdda8661305ab03d3c21a7258a198d5a72b
268b9e838dbe8315d2f4f2d076c4ae4ae62cdfb876bf884141af530a5e0cf603
e384f4ddc6806842ddb9c586636e14ce40605796f8c3296ad43d30232c8ffbac
c5a031cb07826a8efb44271ae4bfce9c748bc368c55fb379dabd4127e262e3e7
663f6b341ff9d4560c350ca4da7a03d7e83904a43a0e2e22de4198b71ae2fea2
bc548291143f26c0001a27271b86a22d162bcecf566aabbf9f6309c14e459a2d
fbfa90728664ba8cddea9cbaf5978aa423da7ed7311e858f4fc69baae7314996
9ede022d06ae3627efb7d72a15b33be2c3395bc2d6dd02cb79d2f0790f38f374
d6468e3a66ea781fb375daebca00374021ff72815247fb29b2dee2c87b2784c5
d9510d1a8a9c084cdda630f9a1a0bc6ad552f9aca3dd1efdd05c75c171337978
79bd82131c5fe5c0d2111bde8016bd1f3d576e05c148c5341dc0ac41193ec372
91d3d10352fef929d1ebf341c69561abc3868210e06a1c251dde5384ac1f7265
272dcd6441262ab39f5b918664b33896e9320ce8aafc5544cb72ea0440a63f9e
c53e7fb302f38c6c0d83451c5d42f8b3f9ce196fb0d9fe22d3407fd4029d4776
a7c4d730fd79109d7943efdfe4c5c2de2e503aaea45961e521222c4bfa833ddd
85a1d79cfa964fda15d6a30c85d311fb7c669981fcfcc69dc19a1aa8d78a0e76
0e63efab9badb7845e1ca4b630d5640e5a56e8db61932ed59427bb3891469eff
67fc63e5141db51e6acafd1223dfd11e08f21477d405899664d8f7f135ce0af5
4edaf68a467ff4f18d8a5b843d983d95643e2efca9609832fc03152ec0bd8aeb
c63523e0e3d6ddb8fea60d57ae71ecee28aa49607e6eca649e25a179caa4489d
32da89bcb73cacbc53f4aec3c25d196b6567c4b1cceec873a6feedb3deb8657d
ce7ddc99f8086f9379ddf48897ea66e56e9ade0beacf3dcf7d77dad35f8b07ee
7e8c2e8d2542743215205134faab53206ea20103f9ce1025f1615cb8093f13d6
f6c4e435114e1377749f882caef0cba30d35e563a673b618d04284cf944c555c
a9680513f1e0fd28b5d642330cb275f827a45dfbeb0157fd1964caec308fbcfa
fba22a018072dacd27d9429cdd648855b8daa0c59e753fadbf61a85b5e2bbc4a
42863a35cfa320a50dbfc6f3065fe66b6676da2ec1995129c3a5e0ea75bb2830
0cad1718564285af2ad8a686d2133dc32703305cccedf7d4f777be58e8ff9fc0
22d96ad5851da47d86ac1d25b435ce23b91db873ac5b61f3ba0043ffecefe41f
78653c111ef6208f53c8460d61500d1b52557f251b5da280581fada630cb760e
38c38bdbffd66401a3f9ede8a3cab3f1457e72fbd92e68ee4ca57edf1bab2678
1159cc15433569c178273c579662a47f6ed8e2631358e0710b1feca7d8d956f4
d215fae8360f2c033762f1b313a804f19f27a515f10ba29eefa75079839d2038
6ece10a338847cd2808f510a9193de6eb128709dabc6cc01caed2d66cc264c11
2775f66e6985650671610d92c288c3d853d79c5cad2ae7898a5d10a4e3203e45
b5f65fc8833bb39d5bb381d064e1a250f52146e1d72301f7cbb3382479c0d447
dd186ce0cd9c53b1f64f2115cd74d41f2053922d2fe18709f8e052e8066c2323
767eabe52d6ca9b92073997fb298a94dbec3b94cbcdbda2de62b725f130de7a2
ee3b69787fa2419882c36ce8591e6d12aaa56320de0e3647583ba5923757e848
7b5f632e9e0538104c7c3cee483ae7c5e48d9a931018522b432e0ee466b80649
3d5984aa046b3bfbdffb56e55f9256b9930aff5d19be1fe05fc49987fe9f10b5
04a99f3272d120d9fa4152bd4a9098d49fbb2e8eebd56ace103a6ec67a67c297
acc287e18a941a2d342a48968267f70d031cf1b82ac6e287aad8cd5952e898ea
9b76d9f3a906cf5e7b91675fe4893e015a76d8d93d7a6b5530a6a512e0670cbc
2e324a0f3e21685d5050b2c912eeaeb2bf822a4624c18eceeac5c0d159cbb19a
15dfdcf2aa81ccaa139d9b41a23da948705e0f6eb9623708a9daeb927966ff6c
f4e494956da5026b2a412aededb671a93c627f6232f027fa8961fd1c3c8036ea
4ee98692561161f4950cf04ee7fbe2d6b4c7c2e8717bd0d55396336fd27040c4
5fd0fd51683ec6882ebf6e50edeba32d1de5d4e56e1416142a2d9a80a5b42c96
9654b28268394aef3c86b56f17b126c3600dbc6e3229d5f7bd3382ac431138e8
d024f8b7f4f5be0263f2dec442ce1ca69eff5b7aa88cd9cb4843d460601ae370
5d11a123b6b4a95d2f78ff50a01f96f79a94121904ce10406a00e5f70963c9b9
ab0706923c35167749ce4f39af01537590ec3ce8c100ec691bcaad400e68d31b
2e46b6c62b463b77a2266f0f1fdc8e0698e903ee85d0c678d52e75ddf80dc7f2
0493e5c1e8b3aaf294d6876b30c849b8f04282ddde2d6fa61b8645198b032d28
ea49d4855065a56fda3fba6e97ca1124b85d0bb3341248e3f7d558a23233bd16
c4949b9222606b7d25857deb51739ab3588ceb94c677040304dc51f1c0c16f10
9226f01440eafe2fc83faf66d742faa3499aee5139e628624cb5f4dc76592306
b7410d82714f38d856337e4def3a7846673e3969857ad613baba35ed1d0ef9e6
bb9b6fa06f2f0444f1718a415fd33d79e296134e16f489540a4fd1df310889cf
112b6aceb47d08282eda291e04e77aed80b70aa9a0208b2c466f4b44a614c766
3bd4647fca66b9c3cb336cfad41b80518498af0fb4a3a0a085fafd2829efc784
54e8eb45f3b2f98d2eb22be7e91592def4eb4becf04c4a7ad0149e04be83f79c
9707797734b3ee9028199a00d732e6dd5de83921ce10ec8756a162abc952e223
d85afe3d6f0a8493d39e7d71892fa91538d737b7bd6e2c01bc5eba2ad64141a7
99ea1def86cc4d2fbd915ddb6e89f19385e0f7ab32a8c5651964ac5e395738a8
ce782313d009ea3ec1b4e78e56147f0a780e0555f4527de3abac03c86854bccd
3e1c4c708cab10102b09fc51ab901a92508ea9a17eec5861590ddeb5856ab587
91840ffb39ad3b0b73726f4a2db1e5b3a60a18c52083cf22da35fd29af9b5493
3fe37564680b29fdbfb017fe76a117288a46400960bc51b9b17eede6d5636ec1
fdf8663e667ded40c95d7c7054e67ad08b91a094fefb8a18b03b12a65096985c
02b32ac2974210600f7d3cfcb369ffde611552a6710bede6888daadf8c0668e4
31eb270bd823612cab5184eafa486f65493a08bdeb35e2d77955471f39fd13f9
b570df710631fae855624c5bb0df295783732afe27b4838887c00a6e8167214e
33e21a25067502d0eb926abe7cc5dc0b22428a9b9e3e9bb08181b61caffba49b
13f0cfdeb8641c65db4b3e7be4c4980bc7ff077ee26335acabc3bd198ca81585
4ed979045cf4baf2d399ae4e18832c6775d48c3dc8e4a0f7917695bcd640b375
302a8c2c9601a93d9dc7cb08d59a839ef09a3a08edc92c400a56705c7cae451a
be2f330eac988aee0cb38bc33bb6a3d294682b8fd6fcc4f120bc6dc4a97f40bb
1a1db90cd50aa085bc0b8a5e355701804825b761aaf7073c6aa467fa696e3b88
045021cd8c2e391d03c2ea4d1b26357d0d000e0d80bb77974f4582b66db831cd
8bbe2b69fa65094af8e06d6d5156009ff112c96ca85fea016c73b1b29f635540
a127f4f4158cdb28479ea724cad390f78a0410ee9dcf509070bb213a91eb9096
0727c1dd9f678264b9078138373c96db9786651b5dca0ac45d17ce815c864841
42b29afefda65d71ce14c33f37a4a45198e76a3f56b43f100857a3cd06ee9e83
e218c3565139390b4faab06103aa498dcc091b1cc9013fda9911abb4d45b2aa8
392b07610b3159399c4bf81dcc76d09a99987b9a8dc99bf694b15c03ea242074
a36feeff8cceaee8d723dc3adfef7afaf4ce1f904189fa8917ae3cc607fc7fcb
6be9c77e309c12836b15100442c0a30cc5b1d593a39914ad3d95f6db4aea5199
4eca83bcc1c9e4745e63338c6badbfb3e99326c5cb2fa37822ba990af0b2fa01
e853a2addfbf5916d97ae0cfd4ef9171ab1a44273aa8737f7e0fbfa91ae97734
5ead67934daad3845dcf45f3c30d9e50488dcd99d4a86671711cdabdb0a4d6f5
0a5a94ff1a422e644c53df6d9644d2a8f5ad60a1c1e518a5a580273ba218f273
e311a04c1db391129f401f2c1ecd25f5d400dc623a342f173ac13318367f2747
ae0edcb70731b2283b126f5d8413467978dd37c9c5a503b47e800f0c99158947
3f5bd04af5388f9f36b519f8919c41f475b225e13daaa50fe24884a66125deee
d96aa514f8281019a329189ade35bdd990da0419ff6a68addfe6e24917ffbd8d
a93df7abd5fbaf0ebb44d23a1c84253f3483ccb010938ba7d3dce7b75a8008be
35c343e8fc3fe2cb5b312b8acaed952ff046d79eb9303c39fe3ccf68e62dd1b0
06127403a0cdd1b8d4c6b6cbf36c7535b7c5cc80f021efe17b7bd7853ecc2f3a
eaba797acb7d7616bb5e2b0d77c76c223d791688f02fede765839d757190e852
3648f6fd2e143b26ccdaa9a17cc88848ac48dfdd8eb9bf66a1528d0c634cd63b
fcb5d6e7900b877075cb2c6e06b5b02428ab0535de8dc423b792dc5a7a952ffb
3e825c9fe615e805ebc0bc4507bf0b6e5d0cfca7d92f44a1b32f4841143cca0d
e5a7317766e59cf559d4d92a0ddebaa8276af1cc7c6a7fee50141311947c43b5
fb8eadd6d24b17441ea3c1fb79ea163ed5ba25eca871fa18de76d01c82d0f3b0
808d0b2b6d55e7da829edb58a054ce2d9586e3886cb7f8da63f3eae64d4d3340
d08c205b1fcb3a7783222dfaae2d4e394a89c110fe191378eb3261ac442741f5
99dd127155760e587a0a8aff688b555d5c87e7556402ae584fec62bb4cbb449d
15d811b130d1aafd050b765d1db0b1b7ae132daf9489b1df56b61e5b9446639a
96091dcbdf2f7da072f2ccc74f5abdaae4078c5c43c8258daa85f8797bd8a20d
548d183b6df1a7e3b7de89dc348ef339c60f567fd6a12781d4a402f604687651
193499289fd053a0b522a07157823e9aafb3d6ae0caf8a5f74e34513647d45d8
2a271dd578fd3b61fd242f9b7cd14677eb8c8bf4b7ccd8c3bbc5f8a6c6f17bdd
b842d2e4d0b10eaf09960e9c28286622de80f829b79defea2ce3a156107d1940
f1037a1e1ea8713bcc63e554a00d895144fd72357d6a87c032954954c4f2aa4c
46870fbe301049caa87ca666a11e9c01eed5d4134836a7b74f21db84806ee1f2
5834c7f925c3fca87dc8826e9a410d387911a25238359bde176c724f41b07d0e
b1f9d97036794b62769394244d55e22351e898c64aae955b7091774a14d70a4e
92d6d6debe1a67aa76dd0e335d0688ae02d62fe9764357bf08515ecb93633282
be4e474a0ac0db5430640f007e697409d1b222ce10aca25549740401592a009e
c4167adca4f869ace696a5c51f36034b4d33c521f3116be431ebcbbd21279009
bbdaefd3996dc00f6928d3b65d6e6f3b835dec5c12a75943bdaa376ce27f84b6
93a7b5d839eaa4da7b6cd63beea4fb3c46daf7f685fabc63ab93265f003bee0d
f2f1deed7faa60f92dafdfd7586826691821d238f02b0ab820eb196032f8bccf
c39d7bb9888c68e9a1c779b53af536b2eb068e6dbe8daf349a241cb8370d6f39
97a38e384c693e59a54cda7d2968cb12b66f1043e5094124c1d2213fcae95f62
414979cd58fcd4a386084a37fa01fcd004ad4b0c668be823265707f7a1dbd838
413f1bdba62e901b845b0f995d0aacc3d1d81aeb21018acd0a12f2c38912bac4
0705043573c946f04482c5fac824ff8ae885d6fdbd80f38bec78999689c3329e
e58b3b6e258fbcd8307adbfa867121f3de83b5b8322ec0248dcacd6a6ae7ba8e
f541912aae2052bc6bf3e9a3614fea209bd0a8886448b423648d111be8e2f196
46441100962266b9d406257e0f66a6d9cd527e9c37b75b6ffd7ea9e6a2ce6f79
61522e344611daa2d63d5a5e5ec0b4f02f1594f131b407bb755c9ac22f1cced2
01abae89c5d6f50be6520e21175dbd8892114923cc32d7f3a0756c5295350fe3
c5b07bb1364ea78ee5fdb83c1814b05ddf72d0a6669bc3476dd65e69407cb489
fe9cb86fe9204aa27442366b0026a322951bccf6a703efced198c2d75abb20e1
6a4c657699bb07a875ddacd1ff3622c05abdca53dbe60129ae0b7a97b6bb2160
30c61e1c58f2350f7d9dc597394a2f32775cea545e693628948f1fc8b618dbef
e2cbcee18f4223046690b553a86e72ccce9e9de88a5e7b37048392bf32e5847f
b84ee08681384c15ffb1a9249d8a4cfcf20ed5a6e3c3f4f7929abbf4cff082dc
451ab91c53ae68f05f2f1f3fb07f3615f3ce8efe24436514846e3c72a8ced181
4665d16f04fb42186a64d6bd89d6194442928dd9efc7690a954066d7194e71a6
684b158123120c10608779568864ca90b15eb0cf426371470ede4941c19e129b
6c9d02b445acc6cb84d8c5f2db1c3c4c4200c37d99937c58089675e792d96874
461e7429428a26cc955b5c025ced8cfa5d98dad4789a0a07941cdc59c513df34
9aecb5a945615367035551dc1001f94ec4f24156c32cd6ec041bc98ff8c35653
25c06e2270e346a6478a878de48879c769d0dca1f6d7d8c7a68c50cd28d87441
728100c2ac4490d00aa54a8ef217d62cbd6c2062a98f2bb478e3e41871b9dbae
43ee4a0000f6d9a7cd767c3003bf82554a974f63e2f1e4c6212278836f83b13b
07d91173c31f003de4c4d134429c48efec418883f835c0a08c5674a7d54b7bdc
217699841151693fad9a26e73735f011a868cfc45a8bb635d8f36538a51ac2af
8fef1b36999f936e922defacc575381e4074453936789a1b31dee7fba0816f93
37e3a3a43d77adf3293619cb335b67779fb2b811ee09fa4af61aa03391ca8aa5
2890c9bd8f60bba93d1f3fb8f0179b944aa606d505310a92ac51e1501a24ec88
02cb127063a709bb6ef058762fdb4fa6aed92e2767f710a407673d670b0d7b21
e8c97990ebc96c16c73d8905836389bf9307a8f31bf7f4218e0e7155d59fb35a
6d7e7e1e747804f256ef3734b529e50b908634ca1e425027ca5ebcf2eb1b0fd4
a7296222cba21ab4f2db19f698ddfd8efdc4c992c19b19fbd9bd07843a0b983a
7cfd390d9e322ea5dd3a07af851fe2001ff6434395f4822d42db1f6f1d886357
68f7040e219ef20eddcc62b59817eb16ae3cfd8b6db95754229990dbb130e8ad
c0122e456af7ea9f46778d5a0b40cbe815f5a0acea287eb8e29806f8e075986a
f94a5ace5dcfac11330539f85c268ad19daf03f293a4ecbbee4f7a8ad9fff83e
9e7a4fac9f394cefebcef0f6fca84f56e8bcc9ed37f808dc9a4a9d88985dc7df
aa224e7f29fc79c5bb5f957457af0934d257610faa941ad9950e1cbd92ed7e36
8c60ba376b2924295b5ad0f756f1cf0efb243fac0729311606da482e458b5f4b
b53be76606c667bff696eb0800a9b4c555e069e54a4454d15adebe6ed1b1119a
820978709dae53231247916b0735760a7eff43db0cd6da44b6719acc9dd12323
d7465bc5c30d2b7220a9af63e7d830c520f5bb806e8ef5e166406d6d82e639ad
65c4b7820bec64ed20ac03e30b8e00e4da77ca522c6769b84afc508d6738917b
e847bfbcfcf615348b499915b53b8844f7e6218993d52f3844671cefaf6af109
06c87fbe82a34a7f682846514cf2f58839221be92cebc9a9fe15f3094fe46aad
9ccbde93d9b3ac93c6b99c982b69f356174e03d2232edebbd5d97e5d8181dbfb
e2e07380207d00b16a800cbb1b88e6cbf25f5fe72b37b5c59c1991e934d69057
8278e2bb978dec4aa9d248b8d5526236656220b2f3861e5b10aa77d1f41ed9ab
d56b57e9ee69abe52bbdc469ff7f4e0e4d746f8b9424abf0d718f2596524e68d
0c246607f8bee819dd6cdcff38ec69a7c5da16d6afd169238696aff1a752635c
fee09a5b1b9bf5df6031808ff7c417215e9d34315c2c28df30575e4a0d9cdece
6aa504a71c69713414539590246e6db53b20974c75bff76b1965cf6253129ed9
38fdfdcfd8226e8cb786e366992c24cb0fa9b527b50aaed28ad1bd8d420bb32d
3f85d248e2ba31f2dde1608789f2540d22f958f09ad9c336d3eec54223d876fe
cbfc63ed31ab230bd4a82ed5bca910666fa55e685d658b49c501853ae98a0f1d
93eccb34854943f84a33009cd9150453a15d8cb036768f7731e44619713779b6
21911b63fcd1850d4cfff3200dee438217564e8634d46c0284a6d40857a713eb
79d2efeea8ce6e0abb8a52ca1a1b32a5a94d9ed63d8cf4df44bd4fa85db79825
b71b1f80eae3e12a5829e9bbdc3c8f838e5816273d854c81d5bedad88bb2fc58
58339c0517c9507ff9c48ac9d575b9caa640f824fc1ea4b77087e0dcb89a9abd
cad3558c2c9c5fe535b6befa5dba0c5498fdfc37fd9525596bb1f7bfbd782460
f7a99e11f9e13a4e2d06a5f15f7b2362959d3a838bf44607ba2f83202318dcd5
ef92403a323171d991f664149e474b04025a5ed1c2f1f5d631c605a4b102e73e
f7f167331f9b7e5ddbdcfae54c9f6274a9dc7fd357a4c21670a8a7be7c4525a5
2e418396f76839071d6dd2408f74cd7afa5fd500cbe50b5652dcd4b3f48e6df1
d7b9a265fc9e30744fac63e22de554e75803f280ce4b806b57439d3d3cee4aab
8ed8f9752b272cb45143e7dd9c1343d1d936ae95b9d3e8bbddd4fb69d6b352b5
7b73e8d5e96cd6f22c8c8577dafc53fa30a15dfdff64a3fd60e19f4cb3e69627
e49d88fb0f7a9c2e49c6eddc66ef047ef62268fbdf2ca5c3cfc74e990b968a8b
5c2bf2c27cb9a700b8b4ed8aa812c202dc62db70b13b47cc43cc433604828cae
26801923b1171016b4ce34e1e7e803cefbc27b4538c3f437ad78d2c6be33d1d5
17f737a8d6bac1a56a4f120ce19b574dda4d53ce004717304791564550dca843
8449f97aca725160e00c63db56383cb2407344d34e77e7b6169cfce6275ce163
972226ed5cf6d40c254de102d21dbe7585073efd41211c5e18c6624ce47bfc44
d060ff25466d441d3f950b0568d14c4185a92294cb9a6b658ec1a42cb3b90555
a1514395ed4a567e04a876ac91332fc2ec383034a53395bfefbbc9293de425b3
2e0c94d9292ac274a84ae98f5bb4fc8e7ba6f95427fe9125d1881595bbfb83a8
a1ad68e03c140d9852c2acf23f9329c817f76465c428e12cecc2a568c45c3f5b
684b2d8c4b3bb13daa553d23d7b5509b3513eccc4c3ab396bb044aaf82307955
1f79e35123e56dfd7b9f8a0280a992fd77231755ea32df9b3792562cd7ae4500
399a90c9ebfaf324f0c1b51989856f4b03de094de9785823a88f1b782275e14e
e11edf8c0de6453ad9ad2836048dc75303bab3a80b0b647ac5fa8036f492bed5
d8eaa497d80435f57fa5c164d9e96cb06d253209d66c9adf3e79f7bac58be4e3
1b8c0ef8b7e674c0173abe70afddb219feb784b9aa0655bf3a15db1db8a92fb1
173cd83674f2dfc992de050416c91d419d60a1f1f6ee7c1323d81fe7244c9ba8
a0aa4ad49c2c5678ac0568dd36424fd57cc28d9513b094c96442288f11a89c6b
85b8bd02a40cfbfe0d5ef4698121d545e08ce6f8defcbb380dd79355546dc921
a5df5aad54bf54cdd0cc8abedf9eb00ed871367a8840f029f1a7f2331f0b34fd
e9e1bdf112cf8567826a94816897c0f14180a12e47e7e8cd932051ab00decdf7
2acc9ceca29ccbcc8f42a2fa6cfe45b890e3c546890c45e9861805dd0761e9c4
3311c7cc7db3db5bc8bdf1cfb0314f4a7b35fec0dd54b89adc925ee234deea8f
c24132c6f31d13947fcf98c0c0dbfe7cfa4fb3c12d0cd9009987fc1b4f82e5f0
e72683d890d4549de2a3a5e8eae26d5b5a262c72d7f63a9f44c901be5065309c
747289e3cfe0b8f550cd8144952506be36a0f2ce43c4e72bd9cf10fd38a1dd44
8b12e2b199b9fcc7928e0ca50e607e6d252ed61a0fbdbcbb2c9d7961d77bbe3c
09a235f31ababbcd3324cd05d92aefa745a4a231b39ff2b463072ba2111333f5
586a9e0ecb39b1cc4dd9c083e5bde7ba8a7271c8526a167ebf11122cde3d1de9
99d2607d3a191a2d3aac85b1a7adf1e4b2341d03c36fd39a4c3f13dc8e250493
9a876745fb9cce962dabaf0d9bf0cac87d1f75122069928f0443d04ac57e7c74
8b09031a0cbc69005c712039dbd34e6654a4cd604b9d5630ce72042cb9a92ca6
d0de7abb6591cebc3c13e0bef33c874b72a85b32692de6c7e7194a01439649c2
cf9e41e9604788b7608b5db84f8102ea9a79a8a13188301a5ae94200f043c976
c770a1e39bc40e48c142a6f70f1656e8782da2bac6e4759954a4fbf366dd85d8
c568ed8fc06a2b7632d2ce3052b4c01b810e4ca9b58f22c02aef26a1cec31c44
9a24710ce870e9f4009b01c6f222ef25e2dc68a96554caf3d0a837389af65c2a
1e6888436b2366c2a09ed268eb2bf667512eb6a241e0601ad3274172dd337912
806e6db4da4d7cd1b81c1e752f13ea8dd7ca2c8b5d2f7f8d5e457df68be0586b
9b159ab2d21f45c289b9b10b9835fa66d04c84b898aacecd98994700de00c10a
0c0b89aa201bf24c0861578e7462d2c0ebc848e64fb5bffd902f0634bb6bf6e8
41b2e1e1b85ebe9bec653779b34d835a0cf8ec691d7b99da30bc65c332a9387c
4624332bd737899318c0a7cc94d7de28ad2323ed938f6fba656438a46ff838b4
d350705010a61584022fac2d2879e5e0c1bd6500e1bf2738ae994fbb447b5242
25543c26321fe282585fd63a22b62f2eb00fa78b5ae25669d741e38b8ad0a825
8b9e84d3ed1f5c2f6c646e7c577e322b7b72e37282213b8916b6edda579f1a51
9074837005552fb1cda44d48721fc2c1bc010721d0335895b6d0eefa6dd82ef7
036e8e90dc095699f68393bc7aadc4cfc2728827c449757e40a900998decbad4
da93efb2dcbd14a612c1d79197d89d598c8a9c6ec3a175cd4025291d78d2c9fa
895f1a98ee04d9bcb539a177c5aa4b737e3aeff9bad3ffa37124149161d18d85
c2a931acf5c5b9b3d4ff70f4f52ee8e7e6da53b6af120e671a534486d4c04e6c
df883ea12f6f1319e979b0845e419c637f559fe3ee97ec81f36925477374d796
28399f81eafd1214c8ecc245978f9904752c6a4e22c10fddc511227b5a2d954f
efd0599026d3524805a59a09facd560a8d46826a174f4c7e9d4277783c114b08
3b000a674e2bdae837d0419229dff1e27d14f29bc3441757eb83cef6a6124244
91220a31f575b83e9ae2f555a3ce3eb061dc9048d0ea41947eae1350a32d828e
cad62416745f752c8480f9558d2e4d582927a67db9e57a3019845ff635a331d0
96c43a12e279d6a162987b26975d7181bb2dc93ff1058ada3db4f6f18c833a29
895638fb5197fd59a6acdfd92a2446b0ee4d1e77919d83bb2c169f46ce48e737
487d7fb536f263255e80eb93e8ac8dcde161f17d222298f7b37018f35a259bd4
6c98585eb8649868fa7e4146b0b3ae2833c5435fe43d4e4a655a2783c1f50c97
e6997e41af696c4d519d7a89ca9f8e3bf30a6d6a9a5c290f1532830fa8776194
c49f4b10cab06f4d496bab1f873f5f7caaae922fd9701a8d46e7892899f3b7fd
e809bc8062e6108ddfd5db04702f1a16fd5e739d54fb1bb3aa6d8180b8c1915b
b0ef6cb1ddc7d586edda41661cc94f9f5f41dc09ed4d8366f68cb16385184328
1ade55f63299935190dcb5b9ac7ecf34cdb26f89b5791a2e4a63a22c2c51d73e
aa8bf33098c7649ce96bbbb941184e9493dfe1a82fd5de99fa6bd9d0baa6f3d2
cae39dd1c64dcbedddc611144a53631133b7097502ac2c2f391ba621a921c465
703d70b1b9e6609d42bcb5b60ad2fedb621997b94efb4773547ee2b80c54dd72
e40f067fb10f152fe152d339693cfcd8977ef427d0c9ba22ea4a494026758275
0342ab671270ffe3fd44986279a0fa60a6c9ecce71849227dc9132dafa21318b
1a92459c9e0c14d0bf0f0f1e57b96c96516cb98f8243eff7eb9a817327fe0826
f6d7acc85c0e7f8b3a7efd317ad9935a3a6afe0e91fefb9a9046a9d7a89c4ebe
00829e726189799a4a0ad4851fdf6a3511a9679c20f6fe8b63715026bfb36a68
7538a6105cdcd84c422651d3cdc8aa63a6b89c597f595f74b46e3073da1431df
b8bf6d212dfec0842a04c654ef65f084600868cc01783826ed1ee0385781fc61
28be0b91f621aaed5156e07abf9f18bf29c662cb858647afc19ab01b9953f1b3
29905d2048493b62d79d657a4cef23b4c1906f13b255137a34c7e7959e7ab739
24b317a9d9cec040b6dcbc979b3183ad2cd5b2c7177ba33d52a5b385949e6591
0b73f0a675e5ef1ca8f8a35ddcea95c35d8e9e03fab833101105d8ff27f171fe
aaf63d56a7c1771c9a0bea769f09efb3d38a826a82653c1826e76bc597c61002
74da6cfb4f0c712770ea02e3be0442788bd5a32e3872e97487c210e81a81617c
72c3d8582967bbda46f335d231f03b17c7a744ba463a8309c02f7d792ea826ce
57e5f3d6c83b558daeea96564a6aeb37c477e31472a8e68404ee4998d1e7fd5e
032cc117c9c3103a169d0d718580979f92d5383c475f4276913c4add85aec975
04ba0765f6499f94c87b90fbbed9d5b292f9fbf5514bd84044c4d674acdc6978
e755c27dfc7d8ecdaf952c77f96c75826a04de6a8fa9b4552cd8c1339ddc9627
c4cd08a79890002d3df5d9b11d42809566abf53374a0b7c8e93c2d7abaa63fc6
56e164206b5042b276b471d12bdfa57d1e2219a9ebfef866194c7262445cca4e
a123920e304dce36a5dc0ab756bb0ef2d1a7522ef6d4f033b8b8de6b90cdcca1
93c44bcdc69ab66fe3ed1a0e2fd47282c205dc0d4da05926c4a0cb804d164408
185dc1dc31c8102979773624951532887ac196034bd04c2523fff0edda98d4c6
958927159ead18b6a56e22fbe64e3d4a2051dc2a194a8ea6bacce437cf43c933
a94c35d952a464a5c38da453297bbd7d971f2ab336618251563f8e858fd5e26e
262ee2a8357493871f1bf97f803947054bc81293737736b01ad9be74e6814bca
664e3aa3c3793afb6e51abdf208cd6a2d85b1277fdea5c11a75b313a0a157490
ddb7ba69197dbcb884c59abf516c26a949f99b3df0f3ec65198748bdafa311e6
d1240b919810b41630a8958f93c602a4a73a3a98910e1125e91b90ad636af357
e54a9e64d755c3ecc1dc510224fabd3b642a8e4b8a0db656b8f10d40cfac5f12
8f2d6f37871c6805aef600c0a0bc1eb42d307fa886fa7187a81699f62b03b61b
cfa97dbcc2d40845f638af327807bfa94c51430b1dd3d82b947ecaa37a04988d
b5713828b188b898e91393a8a4c5aaec84f782c9185f290665299f00fb9c2585
b9126cc07e15fa976b2434d41236e9b30240de62ab6bcb0b7bb90c59ca5c7dc2
ac2501416e3a65c8a35fab5dc5a61a8ceb1446b6a625f2df8a8b35161544dce6
f04171408589d2d1a4d44ba9e749eacc6df85be07c8aac753c0201e27833afc8
06147366077625607ffbfc7d7d61df2f52f964029e7e015536645cfb33f147fe
34cd949ca24de4afe8714854f005be736f906a95811307a201c34267757f6676
b4e21548b3593989dbc3271319af714175ec79d78981cde29c0f3d2cc94c5271
ea4b2b1d1be00015446e03149b49255a290d6cf302d694d5aeaebc78c6d694ac
d42b1b50731017f0f8941419bef0263df864fd0216cb956370c964a005cbb3c6
1f0620778438b6b40565453d6c45bc615082f9ff008c0338cd16ae097d1a6398
08bb82d97ed9a043bac55655325b5eead9ccdd3b8d0f42489c24b1af5fc7804e
e037799c6fbcbb36f172935fd815d40d8552635a9467617440fff001380d76b2
4ea6812e1496acae69ea7dfdc491c07c1a6c7d823fcae948e79b953459ada0f0
6423cc36bd9e7078a5dada2527369651fc4242f6774db733a1a1e8318be95945
b2b60ac5c479467cb7302d5ce879e1cac7a07b4c1338d8e0e625a226f3fbf0da
f0d0f0ee9c6767ee258aec13daaf6c87343ee46c28b1ab983ef935cc1aaa9dc1
1f350e574520462365295aff06e698d5a71cd8dce08c0dabc213ecce2288c184
09b044c9fcbf7d659140b7e9130f1efd990bc21d062bcaf7edcb5efbdbe444e0
4d7486c14a56551d7c6781d8a6436fcf0aeb0539e11938088001f5d4e6b63ccd
255c02ebe97686f954a41b400f2612f2901b83b6ced5660cce2e8cb42b94ba9f
511e7258e19faf4fa43a9bc547b3bad0edb47019901b7eb1d4772f5508a8aca5
f803c927b20a1588fdb150c84ea4f1fcef9dc136d577335779d5326c87247d60
2c7b0437b47a90f7ef0162409f72e1e791f4214ef51fad2621f638f92cc91d1c
195a7f93d688f2b59fe1a67f50403e7e08fca90f46b96880c8e9944a70b70304
2f3fad27edbfee51524f09d29f58e5a6038c918ba147adf4c893a9a061bd9046
05aeb9d24d2ef61fbc5e7ac21cb70d2fbc983cba0595856ea14bbb77c23a57bf
feb81ee84f1f766490ff4858dedce082931e847f1e377fb4c594c8dafa542f55
b52892dcc8948b043cd8009c41f1c7cc6e188a29eb9a8435ba47d0bc3825906b
f67bda13f95e2685c6653cf90ccad4661a4aabeed5f582bb4576a016cb4efdb5
e8c7c4c327f012904c139cf8238247e525ccd5e24aae91d539875d2fecfcd2c6
18c0291a1549dc256012f373171ad047fa1dcd3a970c3bdfd4452061c6bf732c
03d066d952cf90b8bb5f3086f7417c1b3a035505400b0ccb758b3a64aeac4a02
62a68cbfe496c232eb81b53b1773824162a65963a4c57dfdb82e12d2c6d8d6c5
60f8c3e8e5de8540fa56d492e182694503cab3525d1f76a6eba5e403e841480f
df7e7c1c278a2ad19a7b0dbe2d47b19b7a3f2337126fc43335ac9854b8a3f5b9
cf1ea5c1d6d9572bcb4b3ca2471570d50513028c4f15660d3a599ba35770f5ef
e4b8cd217792ba726e2502b10db8d27b682fd7a1204381d31ba91d287c1516b3
3bddcec6c2ceb7bfaee4123a86c715a283a808a386b7b57e6dd1ae499768408f
e2d4e42617edadf0375c9b167941a6b54b7cdb23eac847af7e9b9d72a3a26628
4ed599004442e3f24a3cf946fe60c1a611225334455a3919f09e32ed4250fad8
e3bcd88ac38d35ce39ba3c7ebd9d934127c1c628cc9b930c96c32669c7fa5e6b
ace4b0209fbeaf981378e2b1058d6e1a842cdb6a03ce988f0b26be1ff52d13fa
1fbfec1dab14f817fc0079614075a93c353cb9c3ff7d5aef1e5769a559a3036e
894a1bee76b16cd0acb0c5d921277a9aa6c770e9c74d6b9ad8505853d3ec9774
af4a51075e64b1e67c29a10526c7c0e19278336f00924517afdcf7232d08767e
4cc75844a416e41e4730f362d80580e8c3adf11b47f7ab52780c9630caa93bef
e4fd9d622a380659911c0151cc5bf9ca293334c67a64d45cb46ff61d1f3e6805
bb8ff420eceeb6eb9d5e08fed1e0f021c6d9c24d6a39ad710cd538fb52a952f9
b899acbbb97dc118327760f68646b9c5f31151c908c33914d3c7a1b0143367fd
f945c17f7f0ec7822ec5860290f3594e6cc6aad84a05cc1f623dce578ad2597d
831438d9b860dca889481233a2a2f9e8cd66aa6e5988baab2017b76d539728b9
0225acc6faf044237cab581b1cbe5bf42cfd5e2ef8395894c9386d982166ebc7
a056b9a0c989c8f92f35c7f75579ddcc092a8cc98fc630e73eb3bebb27ee12f3
6478320e1fe54d1f7d8a2504345a19fb31a8b0531b25fce9ecccf21bbb7ab06d
0c6c23316e5170ba537526a02939002fbb5819cd2d3e0b4c98b9bb5f4f13c309
8f635c367e86c99ed8d85b431ad00aa50695180590b832a1e9261519a8b17cd5
b11be9f6a1a078810f3ca6ff092ed3ebf89232b30ab8bd190c06c8b35c6a71f0
e20b815ebd750a00681ca74bbae240fb8bd2e8d5eaa281a936cc39fabb7ae1bd
493bfa94799d0e13e73a3f285390fe5592f17b9402c66b75a42f42eee3e2919f
6af0c95e31f695662cdfa2ea1bb86699691152cdf742004adb08c2412fc110fe
8365c077e38864f5aaef477f1eb7d31062d89b51aae2f630140183674606ddd6
bcb6e9011c9e5c5ee48589b6eb7d108af8d62ca63fba2902c6848dfd616335b3
8f398761c8a4ca80e9095096419bbdcf890e7023c29386034744f645343efbcb
2d03d2c2dcc9ae7ec6866b9137538c5ac69bc89b464b93476f3fee9c50ca8b9c
50357a86ca61a480e21e781a7e66fe6bfa3e4b3dc61f7737c21f36c647ddc750
8c5fb85965ae62a5231450be61f2e48f7721180124732d32a0bd613bed11c79e
32ec9767736a462cca4345fe83f0295c01d7515b2d2b9d73a45fa12526e7fade
79ba8e999b98ce21db79eb39385e172e0e8b3bbf8a08f207539f0f725465fdee
8d35281aa0b262ee1128b9f863ad33cc94eaea2f42cc35892d57737681210dd7
47a187a25831359b782345ed3cfb8e753d610756d28cc89b00e4e0a0ebdd1049
16a6ae749d2d7cc39269704a46e64cc597cd3886920df7f22c80bf0e849e2136
ec03d6032b43dc83546f135b139d6f6433eabdb6d8c2cbaa251436d089492d3c
4a49412110e552d08635761b6c85f3a46c571fb245055951de85d23cd226a74e
a8444a962339248f349b4d8344efd0ebe91b7b793cde44b5dc15aeb0b263104d
44b7096c54981d23291325188896e651090c13eeae245e4bb863244caa805d48
fa88ce8bc8bb99a01c6d7ddc2dc0b4b1d21d269860b6209f4eaae5eccb6d6cfa
43f7d4f806a9a8fbb44405f4827ba0d0808ec1be54009ab642161986db8ce537
622b3ee9bfc995b81573afd5a80a807f2b2cbf1490a69361bfd817e843da2a1a
b035bb89aa5f65528440e231667cbb0e8e457aa2532362d93005f96db1d642fc
7740db5a58bb3c9b55119a4173284767e7c40308d6e0a473fda45bd1dd718f6f
0be7cea54f7d600a6936b58517a184cfc416ad53636fddc89bde2a5a8a13f26c
616aa15f58e9a2c7f6324d229e22755858705d0446c3154539fa3f558000da27
6a9f7309105e84ec635a5741748428fc6a989202abd19adb45ac083e0f602d31
0b60a173fd9103d15022e1ab92bfb500245767878c2280e19091bdfab2e5d7c0
4e7a24d42c53151ed49c57b86c11af6bf1035a4be90e57b5e6359f60f1ea44bf
96c3cb6b48a3e3ed380d728c65ec1f2b4bd6af6aa72f12f807b3cea4fd1a4368
be380ddeeac2e77266f32d2e39cf5fc05b04d1f753713f358364dc4d29654263
1263323865afd8
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
cleartomark

%%EndFont 
%%BeginFont: CMMI10
%!PS-AdobeFont-1.1: CMMI10 1.100
%%CreationDate: 1996 Jul 23 07:53:57

% Copyright (C) 1997 American Mathematical Society.  All Rights Reserved.

11 dict begin
/FontInfo 7 dict dup begin
/version (1.100) readonly def
/Notice (Copyright (C) 1997 American Mathematical Society. All Rights Reserved) readonly def
/FullName (CMMI10) readonly def
/FamilyName (Computer Modern) readonly def
/Weight (Medium) readonly def
/ItalicAngle -14.04 def
/isFixedPitch false def
end readonly def
/FontName /CMMI10 def
/PaintType 0 def
/FontType 1 def
/FontMatrix [0.001 0 0 0.001 0 0] readonly def
/Encoding 256 array
0 1 255 {1 index exch /.notdef put} for
dup 21 /lambda put
dup 58 /period put
dup 59 /comma put
readonly def
/FontBBox{-32 -250 1048 750}readonly def
/UniqueXX 5087385 def
currentdict end
currentfile eexec
80347982ab3942d930e069a70d0d48311d725e830d1c76fba12e12486e989c98
74c2b527f0925722787027f44470d484262c360cdfdddf3657533a57bb16f730
48bfbbfcb73a650484015441fdc837add94ac8fbd2022e3ec8f115d4b4bb7b7f
15388f22cc6198efe768bd9fceb3446ee4a8dc27d6cd152485384ef5f59381ff
da43f2d20c8fb08aa27ab2015b774db10dacfdcd33e60f178c461553146ab427
bdd7da12534ba078ad3d780414930da4f8d58abefd45db119b10eb409dd89792
3c6e705479464a4b310b58348c4b42393988fef4925cf984423aaf65fea9f0e6
4629953bcf50b919d968d99bd185f83112b2759cc411764e9bde677f57c5ee5a
c555448d5f81a16259ded1e11bf4119d53e8ab07a802df900d3a2d5ccc1c6876
d29c5e9effb7af3ef83400b0910c07873a8c56fa7b1eb1ba426043b00cc95dbe
dc6e136cbbbcb3f67509964f9f281ebf81fe5b018122eaf66c4a838487e82e18
6e006093042848a903efb3469ab6b4049767aadb95c30408dfd58d8a10f4cb22
168decd9f3ee100f07b49aa44c92139b669cc312ba20192454eb2375be6284b0
26659d964b96ae82d4942e758027fcf23c25ed01115af27ce7f20efe2a822bb6
84004f20243a49c9e93301fc21b80815c033c3e2ba58ef53da2157d524b395f2
b37abca13bc6a2f42e824ab7e47106176b0d6db267fbb795ac7425582df2e3dc
55863468a9200742bd7b552c48f8cf58bc21343bd3b95abfa140f33f37c6f3f7
8b0d8a5154eb7c1f62ec598267f13e841a3e64172663935ac8b665d86540d316
ddece329c008049c5e74b27d59022c5515059bc3b89370b1bc6a169c888bb325
e0b74282d6f053a50da4024ed1e433271a32ab8c17d41c632b41cf9f3ecd5fe1
24daf7aea7ce8a63047b245822930d517df7baaafa69d2d17f7d93cebd45416d
f3459365434123a76ccf883a4973bab19807e1f0c4bab03a45f7ed69ff2660ff
3963e4def11001eec4238c368a39d874fd30b3c14f4186ec7700fbce22abe468
eb32baf7b0164f8f21a9b5e706b91411faaa44467cb2180ab03de375c1ab93e9
76e11ab92fdd4a7280a6d1a8dc65c4c89d04c8ed6988045a2a3de9a4c7b1efd3
75b1c8221d97f6a1cc0d8fb9b8e17e04704c4bb902315815267de2e6e6a4d7fa
f1703e5fa0d7dcabcc27f025851d85e357f45fc042fae37d85d250097e699446
105c593d6c2fc04ac5bf042011ecb3477c7ff239b65c5472f663cafb19bfb19c
7ba23df14958cf856d2a159c42b82ab17af5f7ea0ed5dd47294b8989ed6ced83
98e37c080fe87dff0d294a080b6fef5508953206beafc91176a407c5c90414a9
39e05190326db2e84925dd69fe149d49368782d5f83d54a3fdd344cdbe4b5a96
2a80878ba65fc633546676f1ab101962943c7c59d8c8d41982bc4f007322d701
b9639100b4cdcae17bb5d259bb715ce7efe116d35d032d86b95a05b3adfb5acb
077b1b98509b7d859751d19d15392a7fa01ee2d832ef7a32ceaaa2c3736e067a
495b3dd94ef0dd9d3605e7854a11c60a14f6058b5cd7296cb8c595d05bd9f19e
efe4062a5366780cbf4ec96cf6abf9321bf9cf941678876e207bd330a9c86c34
befe1ffc6a6c1f29fd0af9d7095c96a31e4fdbe91d109c32ced2cfda50464e85
3291b2cbf7820acbb27106bb731c9022300f7742d0ce2524ed3240466510454c
21ea79e22168dbe55115eda22de3352fd988b692835c28a3e27ddfc00d79e7a3
f99928be006490cac82107dc83303d476e7f22fe
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
cleartomark

%%EndFont 
TeXDict begin 40258431 52099146 1000 600 600 (mb.dvi)
@start /Fa 82[25 50[29 33 2[33 37 21 29 29 37 37 37 37
54 21 33 1[21 37 37 21 33 37 33 37 37 9[62 2[42 37 46
1[46 1[50 62 42 1[33 25 2[46 46 54 50 1[46 6[25 4[37
3[37 2[19 1[19 4[25 36[37 2[{TeXBase1Encoding ReEncodeFont}46
74.7198 /Times-Italic rf /Fb 172[30 3[38 2[32 8[35 67[{
TeXBase1Encoding ReEncodeFont}4 53.134 /Times-Roman rf
/Fc 145[41 110[{}1 58.1154 /CMMI7 rf /Fd 145[29 4[16
105[{TeXBase1Encoding ReEncodeFont}2 58.1154 /Times-Italic
rf /Fe 153[38 87[38 13[60{}3 74.7198 /CMSY9 rf /Ff 194[60
17[60 1[30 30 40[{}4 74.7198 /CMR9 rf /Fg 134[38 44 2[44
117[{}3 74.7198 /CMMI9 rf /Fh 136[51 2[51 10[51 51 58[51
45[{}5 99.6264 /CMTT12 rf /Fi 140[26 26 1[33 33 1[48
18 2[18 2[18 29 33 1[33 33 19[55 32[17 44[{
TeXBase1Encoding ReEncodeFont}14 66.4176 /Times-Italic
rf /Fj 212[65 1[32 32 40[{}3 83.022 /CMR10 rf /Fk 133[35
35 35 1[35 35 35 35 35 35 35 35 35 35 35 35 1[35 35 1[35
35 35 35 35 35 35 10[35 35 35 3[35 1[35 4[35 1[35 35
7[35 2[35 4[35 1[35 35 35 3[35 35 35 35 35 35 35 39[{}45
66.4176 /CMTT8 rf /Fl 201[25 25 25 25 25 25 25 48[{
TeXBase1Encoding ReEncodeFont}7 49.8132 /Times-Roman
rf /Fm 145[29 55[29 29 29 29 29 29 29 48[{TeXBase1Encoding ReEncodeFont}
8 58.1154 /Times-Roman rf /Fn 198[104 104 104 104 104
104 104 104 104 104 48[{TeXBase1Encoding ReEncodeFont}10
207.555 /Times-Bold rf /Fo 131[39 1[39 39 39 39 39 39
39 39 39 39 39 39 39 39 39 39 39 39 39 39 39 39 39 39
39 39 39 3[39 39 6[39 14[39 39 39 39 39 39 39 39 39 39
1[39 1[39 2[39 39 39 39 39 39 39 39 39 39 39 39 39 39
39 39 2[39 1[39 33[{}61 74.7198 /CMTT9 rf /Fp 82[28 50[37
42 42 60 1[46 28 32 37 1[46 42 46 69 23 1[28 23 46 42
28 37 46 37 46 42 9[83 60 60 55 1[60 65 51 65 60 78 55
4[65 51 55 60 60 1[60 7[42 42 42 42 42 42 42 42 42 42
1[21 43[46 2[{TeXBase1Encoding ReEncodeFont}53 83.022
/Times-Bold rf /Fq 150[32 32 79[65 9[42 11[65 1[65{}6
83.022 /CMSY10 rf /Fr 82[22 21[66 2[29 29 24[29 33 33
48 33 33 18 26 22 33 33 33 33 52 18 33 18 18 33 33 22
29 33 29 33 29 7[48 1[63 1[48 41 37 44 1[37 48 48 59
41 2[22 48 1[37 41 48 44 44 48 6[18 33 33 33 1[33 33
33 33 33 33 1[17 1[17 2[22 22 22 36[37 2[{TeXBase1Encoding ReEncodeFont}
65 66.4176 /Times-Roman rf /Fs 129[44 44 44 44 44 44
44 44 44 44 44 44 44 44 44 44 44 44 44 44 44 44 44 44
44 44 44 44 44 44 44 44 44 44 44 44 44 44 44 44 44 44
44 44 44 44 44 44 44 44 44 44 44 44 44 44 44 44 44 44
44 44 44 44 44 44 44 44 44 44 44 44 44 44 44 44 44 44
44 44 44 44 44 44 44 44 44 44 44 44 1[44 44 44 33[{}93
83.022 /CMTT10 rf /Ft 82[28 50[32 37 37 55 37 42 23 32
32 42 42 42 42 60 23 37 23 23 42 42 23 37 42 37 42 42
9[69 51 60 46 42 51 1[51 60 1[69 46 2[28 60 60 51 51
60 55 51 2[42 4[28 42 42 42 42 42 42 42 42 42 42 1[21
1[21 2[28 28 28 36[42 2[{TeXBase1Encoding ReEncodeFont}63
83.022 /Times-Italic rf /Fu 165[37 43 43 56 43 43 37
33 40 43 33 43 43 53 37 43 23 20 43 43 33 37 43 40 40
43 65[{TeXBase1Encoding ReEncodeFont}26 59.7758 /Times-Roman
rf /Fv 71[25 10[25 21[75 2[33 33 24[33 37 37 54 37 37
21 29 25 37 37 37 37 58 21 37 21 21 37 37 25 33 37 33
37 33 7[54 54 71 54 54 46 42 50 54 42 54 54 66 46 54
29 25 54 54 42 46 54 50 50 54 1[33 3[21 21 37 37 37 37
37 37 37 37 37 37 21 19 1[19 42 1[25 25 25 1[62 33[42
42 2[{TeXBase1Encoding ReEncodeFont}79 74.7198 /Times-Roman
rf /Fw 71[33 10[33 50[44 50 50 72 50 55 33 39 44 55 55
50 55 83 28 55 33 28 55 50 33 44 55 44 55 50 9[100 72
72 66 55 72 78 61 78 72 94 66 2[39 78 78 61 66 72 72
66 72 1[50 4[33 50 50 50 50 50 50 50 50 50 50 28 25 4[33
33 37[55 2[{TeXBase1Encoding ReEncodeFont}66 99.6264
/Times-Bold rf /Fx 82[55 50[74 83 83 120 1[92 55 65 74
1[92 83 92 138 46 92 55 46 92 83 55 74 92 74 92 83 9[166
120 120 111 1[120 129 101 129 120 157 111 2[65 1[129
101 111 120 120 1[120 6[55 55[92 2[{TeXBase1Encoding ReEncodeFont}45
166.044 /Times-Bold rf /Fy 196[23 23 36[48 21[{}3 83.022
/CMMI10 rf /Fz 134[50 4[28 4[50 50 78 28 50 1[28 2[33
44 50 44 1[44 12[61 9[39 27[25 1[25 44[{TeXBase1Encoding ReEncodeFont}
17 99.6264 /Times-Roman rf /FA 82[28 21[83 42 1[37 37
24[37 42 42 60 42 42 23 32 28 42 42 42 42 65 23 42 23
23 42 42 28 37 42 37 42 37 28 6[60 60 78 60 60 51 46
55 60 46 60 60 74 51 60 32 28 60 60 46 51 60 55 55 60
1[37 1[47 1[23 23 42 42 42 42 42 42 42 42 42 42 23 21
1[21 47 42 28 28 28 1[69 2[34 28 29[46 46 2[{
TeXBase1Encoding ReEncodeFont}84 83.022 /Times-Roman
rf end
%%EndProlog
%%BeginSetup
%%Feature: *Resolution 600dpi
TeXDict begin

%%EndSetup
%%Page: 1 1
1 0 bop 3217 538 a FA(i)1744 2105 y(title)21 b(page)p
eop
%%Page: 2 2
2 1 bop 555 538 a FA(ii)1650 1967 y(cop)o(yright)18 b(page)p
eop
%%Page: 3 3
3 2 bop 1334 2188 a Fz(T)-8 b(o)24 b(my)h(f)o(amily)-6
b(,)23 b(and)i(to)f(Jackie.)p eop
%%Page: 4 4
4 3 bop 555 538 a FA(i)n(v)1873 2167 y Fy(\025)p eop
%%Page: 5 5
5 4 bop 555 1907 2686 3 v 555 2125 a Fx(Pr)m(eface)555
2562 y FA(This)18 b(book)e(is)j(intended)d(for)h(an)o(yone)e(who)i(w)o
(ants)h(to)g(become)e(a)i(better)g(Lisp)f(programmer)-5
b(.)555 2666 y(It)17 b(assumes)h(some)e(f)o(amiliarity)h(with)g(Lisp,)g
(b)n(ut)g(not)g(necessarily)f(e)o(xtensi)n(v)o(e)g(programming)555
2771 y(e)o(xperience.)44 b(The)25 b(\002rst)i(fe)n(w)f(chapters)f
(contain)g(a)h(f)o(air)g(amount)e(of)i(re)n(vie)n(w)-5
b(.)45 b(I)26 b(hope)e(that)555 2875 y(these)d(sections)f(will)h(be)g
(interesting)e(to)i(more)e(e)o(xperienced)f(Lisp)j(programmers)c(as)k
(well,)555 2980 y(because)f(the)o(y)f(present)h(f)o(amiliar)f(subjects)
i(in)f(a)h(ne)n(w)f(light.)680 3085 y(It')-5 b(s)16 b(dif)n(\002cult)e
(to)i(con)m(v)o(e)o(y)d(the)i(essence)h(of)f(a)h(programming)11
b(language)j(in)i(one)e(sentence,)555 3189 y(b)n(ut)20
b(John)g(F)o(oderaro)e(has)i(come)g(close:)1097 3460
y(Lisp)h(is)g(a)f(programmable)d(programming)g(language.)555
3772 y(There)29 b(is)h(more)f(to)h(Lisp)g(than)f(this,)k(b)n(ut)c(the)h
(ability)f(to)h(bend)f(Lisp)h(to)g(one')-5 b(s)29 b(will)i(is)f(a)555
3877 y(lar)o(ge)23 b(part)g(of)g(what)h(distinguishes)e(a)i(Lisp)g(e)o
(xpert)e(from)h(a)h(no)o(vice.)38 b(As)24 b(well)g(as)g(writing)555
3981 y(their)g(programs)f(do)n(wn)h(to)n(w)o(ard)g(the)g(language,)g(e)
o(xperienced)e(Lisp)j(programmers)d(b)n(uild)555 4086
y(the)e(language)e(up)i(to)n(w)o(ard)f(their)h(programs.)27
b(This)20 b(book)e(teaches)i(ho)n(w)g(to)g(program)d(in)k(the)555
4190 y(bottom\255up)d(style)i(for)g(which)g(Lisp)g(is)h(inherently)d
(well\255suited.)555 4443 y Fw(Bottom\255up)26 b(Design)555
4634 y FA(Bottom\255up)20 b(design)i(is)g(becoming)e(more)h(important)g
(as)h(softw)o(are)g(gro)n(ws)f(in)h(comple)o(xity)-5
b(.)555 4738 y(Programs)25 b(today)g(may)h(ha)n(v)o(e)f(to)i(meet)f
(speci\002cations)f(which)h(are)g(e)o(xtremely)f(comple)o(x,)555
4843 y(or)20 b(e)n(v)o(en)f(open\255ended.)26 b(Under)19
b(such)h(circumstances,)f(the)h(traditional)f(top\255do)n(wn)f(method)
555 4948 y(sometimes)26 b(breaks)f(do)n(wn.)45 b(In)26
b(its)g(place)g(there)f(has)i(e)n(v)n(olv)o(ed)d(a)i(style)g(of)g
(programming)1877 5229 y(v)p eop
%%Page: 6 6
6 5 bop 555 538 a FA(vi)1150 b Fu(PREF)l(A)n(CE)555 801
y FA(quite)26 b(dif)n(ferent)e(from)h(what)h(is)h(currently)e(taught)g
(in)h(most)h(computer)d(science)i(courses:)555 905 y(a)h(bottom\255up)e
(style)i(in)g(which)g(a)g(program)e(is)j(written)e(as)i(a)f(series)h
(of)e(layers,)j(each)d(one)555 1010 y(acting)17 b(as)i(a)f(sort)f(of)h
(programming)c(language)i(for)h(the)h(one)f(abo)o(v)o(e.)26
b(X)19 b(W)m(indo)n(ws)e(and)g(T)3140 1029 y(E)3180 1010
y(X)555 1114 y(are)j(e)o(xamples)f(of)h(programs)e(written)i(in)h(this)
f(style.)680 1219 y(The)14 b(theme)h(of)g(this)h(book)e(is)i(tw)o
(ofold:)26 b(that)15 b(Lisp)g(is)h(a)g(natural)e(language)g(for)g
(programs)555 1324 y(written)27 b(in)g(the)g(bottom\255up)d(style,)29
b(and)d(that)h(the)g(bottom\255up)e(style)i(is)h(a)f(natural)f(w)o(ay)h
(to)555 1428 y(write)e(Lisp)h(programs.)42 b Ft(On)25
b(Lisp)h FA(will)g(thus)f(be)g(of)g(interest)g(to)h(tw)o(o)f(classes)i
(of)e(readers.)555 1533 y(F)o(or)h(people)g(interested)g(in)h(writing)g
(e)o(xtensible)e(programs,)i(this)g(book)e(will)j(sho)n(w)f(what)555
1638 y(you)16 b(can)g(do)g(if)h(you)f(ha)n(v)o(e)f(the)i(right)f
(language.)26 b(F)o(or)16 b(Lisp)h(programmers,)d(this)j(book)e(of)n
(fers)555 1742 y(a)21 b(practical)e(e)o(xplanation)f(of)i(ho)n(w)g(to)g
(use)g(Lisp)h(to)f(its)h(best)g(adv)n(antage.)680 1847
y(The)26 b(title)i(is)g(intended)e(to)h(stress)i(the)e(importance)e(of)
i(bottom\255up)e(programming)e(in)555 1951 y(Lisp.)68
b(Instead)33 b(of)g(just)h(writing)e(your)g(program)g(in)h(Lisp,)j(you)
d(can)g(write)g(your)f(o)n(wn)555 2056 y(language)18
b Ft(on)i(Lisp,)h FA(and)e(write)i(your)e(program)f(in)i(that.)680
2161 y(It)28 b(is)h(possible)f(to)g(write)g(programs)f(bottom\255up)e
(in)k(an)o(y)e(language,)h(b)n(ut)g(Lisp)g(is)i(the)555
2265 y(most)22 b(natural)f(v)o(ehicle)g(for)g(this)i(style)f(of)g
(programming.)31 b(In)22 b(Lisp,)g(bottom\255up)d(design)j(is)555
2370 y(not)k(a)h(special)f(technique)f(reserv)o(ed)g(for)h(unusually)f
(lar)o(ge)g(or)h(dif)n(\002cult)g(programs.)46 b(An)o(y)555
2474 y(substantial)22 b(program)e(will)j(be)f(written)g(partly)f(in)h
(this)h(style.)36 b(Lisp)22 b(w)o(as)h(meant)e(from)h(the)555
2579 y(start)k(to)f(be)g(an)h(e)o(xtensible)e(language.)42
b(The)25 b(language)f(itself)i(is)g(mostly)f(a)h(collection)e(of)555
2684 y(Lisp)18 b(functions,)e(no)i(dif)n(ferent)e(from)h(the)g(ones)h
(you)f(de\002ne)g(yourself.)27 b(What')-5 b(s)18 b(more,)f(Lisp)555
2788 y(functions)24 b(can)i(be)g(e)o(xpressed)e(as)j(lists,)h(which)e
(are)g(Lisp)g(data)f(structures.)46 b(This)26 b(means)555
2893 y(you)19 b(can)h(write)h(Lisp)f(functions)f(which)g(generate)g
(Lisp)i(code.)680 2997 y(A)c(good)e(Lisp)h(programmer)e(must)i(kno)n(w)
g(ho)n(w)g(to)g(tak)o(e)h(adv)n(antage)d(of)j(this)g(possibility)-5
b(.)555 3102 y(The)15 b(usual)g(w)o(ay)g(to)h(do)f(so)g(is)h(by)f
(de\002ning)f(a)i(kind)e(of)h(operator)f(called)h(a)30
b Ft(macr)l(o)p FA(.)d(Mastering)555 3207 y(macros)f(is)h(one)f(of)h
(the)f(most)h(important)e(steps)i(in)g(mo)o(ving)d(from)i(writing)g
(correct)f(Lisp)555 3311 y(programs)g(to)j(writing)e(beautiful)g(ones.)
50 b(Introductory)24 b(Lisp)k(books)e(ha)n(v)o(e)g(room)g(for)h(no)555
3416 y(more)13 b(than)g(a)g(quick)g(o)o(v)o(ervie)n(w)g(o)o(f)g(ma)o
(cro)o(s:)21 b(an)13 b(e)o(xplanation)g(of)g(what)g(macros)g(are,)8
b(together)555 3520 y(with)24 b(a)h(fe)n(w)f(e)o(xamples)f(which)h
(hint)g(at)g(the)h(strange)e(and)h(w)o(onderful)e(things)i(you)f(can)h
(do)555 3625 y(with)16 b(them.)28 b(Those)15 b(strange)g(and)h(w)o
(onderful)e(things)h(will)i(recei)n(v)o(e)e(special)h(attention)f
(here.)555 3730 y(One)k(of)f(the)h(aims)g(of)f(this)i(book)d(is)j(to)e
(collect)h(in)g(one)f(place)h(all)g(that)g(people)e(ha)n(v)o(e)i(till)g
(no)n(w)555 3834 y(had)h(to)g(learn)g(from)f(e)o(xperience)f(about)h
(macros.)680 3939 y(Understandably)-5 b(,)30 b(introductory)e(Lisp)j
(books)f(do)h(not)f(emphasize)g(the)h(dif)n(ferences)555
4043 y(between)g(Lisp)h(and)g(other)f(languages.)63 b(The)o(y)31
b(ha)n(v)o(e)g(to)h(get)g(their)g(message)f(across)h(to)555
4148 y(students)16 b(who)g(ha)n(v)o(e,)h(for)e(the)i(most)g(part,)f
(been)g(schooled)f(to)i(think)f(of)g(programs)e(in)j(P)o(ascal)555
4253 y(terms.)49 b(It)27 b(w)o(ould)g(only)f(confuse)f(matters)i(to)g
(e)o(xplain)f(that,)i(while)f Fs(defun)e Ft(looks)i FA(lik)o(e)g(a)555
4357 y(procedure)16 b(de\002nition,)h(it)i(is)g(actually)f(a)g
(program\255writing)d(program)h(that)i(generates)f(code)555
4462 y(which)h(b)n(uilds)h(a)g(functional)e(object)i(and)f(inde)o(x)o
(es)f(it)j(under)d(the)i(symbol)f(gi)n(v)o(en)f(as)j(the)f(\002rst)555
4567 y(ar)o(gument.)680 4671 y(One)f(of)h(the)g(purposes)e(of)i(this)h
(book)d(is)j(to)f(e)o(xplain)f(what)h(mak)o(es)f(Lisp)h(dif)n(ferent)f
(from)555 4776 y(other)h(languages.)27 b(When)20 b(I)f(be)o(gan,)f(I)i
(kne)n(w)f(that,)g(all)h(other)f(things)g(being)g(equal,)g(I)g(w)o
(ould)555 4880 y(much)c(rather)f(write)i(programs)e(in)i(Lisp)f(than)h
(in)f(C)i(or)e(P)o(ascal)h(or)f(F)o(ortran.)27 b(I)16
b(kne)n(w)f(also)g(that)555 4985 y(this)21 b(w)o(as)g(not)f(merely)g(a)
h(question)e(of)h(taste.)31 b(But)21 b(I)g(realized)f(that)g(if)h(I)g
(w)o(as)g(actually)f(going)p eop
%%Page: 7 7
7 6 bop 1770 538 a Fu(PREF)l(A)n(CE)1125 b FA(vii)555
801 y(to)19 b(claim)g(that)g(Lisp)g(w)o(as)g(in)g(some)g(w)o(ays)g(a)g
(better)f(language,)f(I)i(had)g(better)f(be)h(prepared)d(to)555
905 y(e)o(xplain)j(why)-5 b(.)680 1010 y(When)16 b(someone)f(ask)o(ed)i
(Louis)f(Armstrong)f(what)h(jazz)h(w)o(as,)h(he)e(replied)g(\223If)g
(you)g(ha)n(v)o(e)555 1114 y(to)21 b(ask)f(what)h(jazz)g(is,)g(you')o
(ll)e(ne)n(v)o(er)g(kno)n(w)-5 b(.)f(\224)29 b(But)21
b(he)g(did)f(answer)g(the)g(question)g(in)h(a)f(w)o(ay:)555
1219 y(he)c Ft(showed)g FA(people)f(what)i(jazz)f(w)o(as.)29
b(That')-5 b(s)16 b(one)g(w)o(ay)h(to)f(e)o(xplain)f(the)h(po)n(wer)g
(of)g(Lisp\227to)555 1324 y(demonstrate)21 b(techniques)h(that)h(w)o
(ould)g(be)g(dif)n(\002cult)f(or)h(impossible)g(in)g(other)f
(languages.)555 1428 y(Most)f(books)f(on)g(programming\227e)n(v)o(en)c
(books)k(on)h(Lisp)g(programming\227deal)16 b(with)22
b(the)555 1533 y(kinds)i(of)h(programs)e(you)h(could)g(write)h(in)g(an)
o(y)g(language.)41 b Ft(On)25 b(Lisp)h FA(deals)f(mostly)f(with)555
1638 y(the)31 b(kinds)f(of)g(programs)f(you)g(could)h(only)g(write)g
(in)h(Lisp.)61 b(Extensibility)-5 b(,)31 b(bottom\255up)555
1742 y(programming,)e(interacti)n(v)o(e)h(de)n(v)o(elopment,)g(source)g
(code)f(transformation,)i(embedded)555 1847 y(languages\227this)19
b(is)i(where)e(Lisp)i(sho)n(ws)f(to)g(adv)n(antage.)680
1951 y(In)i(principle,)f(of)h(course,)h(an)o(y)e(T)l(uring\255equi)n(v)
n(alent)e(programming)g(language)i(can)h(do)555 2056
y(the)k(same)g(things)g(as)h(an)o(y)e(other)-5 b(.)46
b(But)27 b(that)f(kind)f(of)h(po)n(wer)f(is)i(not)f(what)g(programming)
555 2161 y(languages)32 b(are)h(about.)68 b(In)33 b(principle,)j(an)o
(ything)31 b(you)h(can)i(do)f(with)g(a)h(programming)555
2265 y(language)22 b(you)h(can)g(do)g(with)h(a)g(T)l(uring)e(machine;)i
(in)g(practice,)g(programming)c(a)k(T)l(uring)555 2370
y(machine)19 b(is)i(not)f(w)o(orth)g(the)g(trouble.)680
2474 y(So)28 b(when)f(I)h(say)g(that)g(this)h(book)d(is)j(about)e(ho)n
(w)g(to)h(do)g(things)f(that)h(are)g(impossible)555 2579
y(in)c(other)g(languages,)f(I)i(don')o(t)d(mean)i(\223impossible\224)f
(in)i(the)f(mathematical)f(sense,)i(b)n(ut)f(in)555 2684
y(the)i(sense)h(that)g(matters)f(for)g(programming)d(languages.)47
b(That)26 b(is,)j(if)d(you)g(had)g(to)g(write)555 2788
y(some)20 b(of)f(the)h(programs)e(in)i(this)g(book)f(in)h(C,)g(you)f
(might)h(as)g(well)g(do)g(it)g(by)g(writing)f(a)h(Lisp)555
2893 y(compiler)i(in)i(C)h(\002rst.)40 b(Embedding)21
b(Prolog)i(in)g(C,)i(for)e(e)o(xample\227can)e(you)i(imagine)g(the)555
2997 y(amount)f(of)g(w)o(ork)g(that)h(w)o(ould)g(tak)o(e?)37
b(Chapter)22 b(24)h(sho)n(ws)g(ho)n(w)f(to)h(do)g(it)g(in)h(180)e
(lines)h(of)555 3102 y(Lisp.)680 3207 y(I)18 b(hoped)g(to)g(do)h(more)e
(than)i(simply)f(demonstrate)f(the)i(po)n(wer)e(of)i(Lisp,)g(though.)26
b(I)19 b(also)555 3311 y(w)o(anted)14 b(to)h(e)o(xplain)f
Ft(why)h FA(Lisp)g(is)h(dif)n(ferent.)26 b(This)15 b(turns)f(out)h(to)g
(be)f(a)i(subtle)f(question\227too)555 3416 y(subtle)28
b(to)g(be)g(answered)f(with)i(phrases)e(lik)o(e)i(\223symbolic)e
(computation.)-6 b(\224)50 b(What)29 b(I)f(ha)n(v)o(e)555
3520 y(learned)19 b(so)i(f)o(ar)m(,)e(I)i(ha)n(v)o(e)e(tried)h(to)g(e)o
(xplain)f(as)i(clearly)f(as)h(I)f(can.)555 3773 y Fw(Plan)25
b(of)g(the)g(Book)555 3964 y FA(Since)g(functions)f(are)h(the)h
(foundation)c(of)j(Lisp)g(programs,)g(the)g(book)f(be)o(gins)g(with)i
(se)n(v\255)555 4068 y(eral)h(chapters)f(on)g(functions.)48
b(Chapter)26 b(2)h(e)o(xplains)f(what)g(Lisp)h(functions)f(are)g(and)h
(the)555 4173 y(possibilities)k(the)o(y)f(of)n(fer)-5
b(.)59 b(Chapter)30 b(3)h(then)f(discusses)h(the)f(adv)n(antages)f(of)h
(functional)555 4278 y(programming,)17 b(the)k(dominant)e(style)j(in)f
(Lisp)g(programs.)29 b(Chapter)20 b(4)h(sho)n(ws)g(ho)n(w)f(to)h(use)
555 4382 y(functions)g(to)h(e)o(xtend)e(Lisp.)35 b(Then)21
b(Chapter)h(5)g(suggests)f(the)h(ne)n(w)g(kinds)g(of)f(abstractions)555
4487 y(we)d(can)f(de\002ne)h(with)f(functions)g(that)g(return)g(other)g
(functions.)26 b(Finally)-5 b(,)18 b(Chapter)f(6)h(sho)n(ws)555
4591 y(ho)n(w)i(to)g(use)g(functions)f(in)i(place)e(of)h(traditional)f
(data)h(structures.)680 4696 y(The)25 b(remainder)f(of)h(the)g(book)g
(deals)g(more)g(with)h(macros)f(than)g(functions.)44
b(Macros)555 4801 y(recei)n(v)o(e)20 b(more)g(attention)g(partly)g
(because)g(there)h(is)g(more)g(to)g(say)g(about)f(them,)g(and)g(partly)
555 4905 y(because)f(the)o(y)f(ha)n(v)o(e)h(not)g(till)i(no)n(w)e(been)
f(adequately)g(described)g(in)i(print.)28 b(Chapters)19
b(7\22610)p eop
%%Page: 8 8
8 7 bop 555 538 a FA(viii)1104 b Fu(PREF)l(A)n(CE)555
801 y FA(form)16 b(a)i(complete)e(tutorial)g(on)h(macro)f(technique.)27
b(By)18 b(the)f(end)f(of)h(it)h(you)e(will)i(kno)n(w)f(most)555
905 y(of)24 b(what)f(an)h(e)o(xperienced)d(Lisp)j(programmer)d(kno)n
(ws)i(about)g(macros:)36 b(ho)n(w)23 b(the)o(y)g(w)o(ork;)555
1010 y(ho)n(w)18 b(to)h(de\002ne,)f(test,)i(and)e(deb)n(ug)g(them;)g
(when)h(to)f(use)h(macros)f(and)h(when)f(not;)h(the)f(major)555
1114 y(types)23 b(of)g(macros;)h(ho)n(w)f(to)g(write)h(programs)d
(which)i(generate)f(macro)g(e)o(xpansions;)h(ho)n(w)555
1219 y(macro)18 b(style)i(dif)n(fers)f(from)f(Lisp)i(style)g(in)g
(general;)e(and)h(ho)n(w)g(to)h(detect)f(and)g(cure)g(each)g(of)555
1324 y(the)h(unique)f(problems)g(that)h(af)n(\003ict)g(macros.)680
1428 y(F)o(ollo)n(wing)j(this)j(tutorial,)g(Chapters)f(11\22618)e(sho)n
(w)i(some)g(of)g(the)h(po)n(werful)d(abstrac\255)555
1533 y(tions)32 b(you)f(can)h(b)n(uild)g(with)g(macros.)64
b(Chapter)31 b(11)h(sho)n(ws)g(ho)n(w)f(to)h(write)h(the)f(classic)555
1638 y(macros\227those)21 b(which)h(create)g(conte)o(xt,)f(or)h
(implement)f(loops)g(or)h(conditionals.)34 b(Chap\255)555
1742 y(ter)23 b(12)g(e)o(xplains)g(the)g(role)g(of)g(macros)g(in)g
(operations)f(on)h(generalized)e(v)n(ariables.)38 b(Chap\255)555
1847 y(ter)22 b(13)g(sho)n(ws)h(ho)n(w)e(macros)h(can)g(mak)o(e)g
(programs)e(run)i(f)o(aster)g(by)g(shifting)g(computation)555
1951 y(to)27 b(compile\255time.)49 b(Chapter)27 b(14)f(introduces)g
(anaphoric)f(macros,)j(which)f(allo)n(w)g(you)f(to)555
2056 y(use)f(pronouns)d(in)j(your)f(programs.)41 b(Chapter)24
b(15)g(sho)n(ws)h(ho)n(w)f(macros)g(pro)o(vide)f(a)i(more)555
2161 y(con)m(v)o(enient)h(interf)o(ace)i(to)h(the)g(function\255b)n
(uilders)c(de\002ned)j(in)h(Chapter)f(5.)55 b(Chapter)28
b(16)555 2265 y(sho)n(ws)c(ho)n(w)f(to)h(use)g(macro\255de\002ning)d
(macros)i(to)h(mak)o(e)f(Lisp)h(write)g(your)e(programs)g(for)555
2370 y(you.)27 b(Chapter)14 b(17)h(discusses)h(read\255macros,)d(and)i
(Chapter)g(18,)g(macros)g(for)f(destructuring.)680 2474
y(W)m(ith)31 b(Chapter)f(19)h(be)o(gins)f(the)h(fourth)e(part)i(of)f
(the)h(book,)h(de)n(v)n(oted)e(to)h(embedded)555 2579
y(languages.)49 b(Chapter)26 b(19)h(introduces)f(the)h(subject)g(by)g
(sho)n(wing)f(the)h(same)h(program,)e(a)555 2684 y(program)k(to)j
(answer)f(queries)g(on)h(a)g(database,)h(implemented)d(\002rst)j(by)e
(an)g(interpreter)555 2788 y(and)i(then)f(as)i(a)g(true)f(embedded)e
(language.)70 b(Chapter)33 b(20)h(sho)n(ws)g(ho)n(w)g(to)g(introduce)
555 2893 y(into)21 b(Common)f(Lisp)h(programs)e(the)i(notion)f(of)h(a)g
(continuation,)e(an)i(object)g(representing)555 2997
y(the)32 b(remainder)d(of)i(a)h(computation.)61 b(Continuations)30
b(are)h(a)h(v)o(ery)f(po)n(werful)e(tool,)34 b(and)555
3102 y(can)25 b(be)h(used)f(to)h(implement)e(both)h(multiple)g
(processes)g(and)g(nondeterministic)f(choice.)555 3207
y(Embedding)g(these)i(control)f(structures)h(in)g(Lisp)g(is)h
(discussed)f(in)h(Chapters)f(21)g(and)f(22,)555 3311
y(respecti)n(v)o(ely)-5 b(.)57 b(Nondeterminism,)31 b(which)e(allo)n
(ws)i(you)e(to)i(write)f(programs)f(as)i(if)f(the)o(y)555
3416 y(had)24 b(foresight,)g(sounds)g(lik)o(e)h(an)g(abstraction)e(of)i
(unusual)e(po)n(wer)-5 b(.)42 b(Chapters)25 b(23)f(and)g(24)555
3520 y(present)c(tw)o(o)g(embedded)e(languages)h(which)g(sho)n(w)h
(that)h(nondeterminism)c(li)n(v)o(es)j(up)g(to)h(its)555
3625 y(promise:)36 b(a)24 b(complete)f Fr(A)-7 b(TN)24
b FA(parser)f(and)h(an)f(embedded)f(Prolog)h(which)g(combined)f(total)
555 3730 y(about)d(200)h(lines)g(of)g(code.)-897 b Fq(\016)680
3834 y FA(The)13 b(f)o(act)g(that)g(these)g(programs)g(are)g(short)g
(means)g(nothing)g(in)g(itself.)22 b(If)13 b(you)g(resorted)g(to)555
3939 y(writing)19 b(incomprehensible)d(code,)j(there')-5
b(s)19 b(no)g(telling)h(what)f(you)g(could)f(do)h(in)h(200)e(lines.)555
4043 y(The)k(point)f(is,)i(these)g(programs)d(are)i(not)g(short)f
(because)h(the)o(y)f(depend)f(on)i(programming)555 4148
y(tricks,)g(b)n(ut)h(because)e(the)o(y')l(re)g(written)g(using)h(Lisp)g
(the)h(w)o(ay)f(it')-5 b(s)23 b(meant)f(to)g(be)g(used.)35
b(The)555 4253 y(point)25 b(of)g(Chapters)g(23)f(and)h(24)g(is)h(not)f
(ho)n(w)g(to)g(implement)f Fr(A)-7 b(TN)p FA(s)26 b(in)f(one)g(page)f
(of)h(code)555 4357 y(or)c(Prolog)g(in)g(tw)o(o,)h(b)n(ut)f(to)h(sho)n
(w)f(that)h(these)f(programs,)f(when)h(gi)n(v)o(en)f(their)h(most)g
(natural)555 4462 y(Lisp)d(implementation,)f(simply)g(are)i(that)f
(short.)28 b(The)18 b(embedded)e(languages)h(in)h(the)g(latter)555
4567 y(chapters)k(pro)o(vide)e(a)j(proof)d(by)i(e)o(xample)f(of)i(the)f
(twin)h(points)e(with)i(which)f(I)g(be)o(gan:)32 b(that)555
4671 y(Lisp)25 b(is)h(a)g(natural)e(language)g(for)g(bottom\255up)f
(design,)i(and)g(that)g(bottom\255up)e(design)h(is)i(a)555
4776 y(natural)19 b(w)o(ay)i(to)f(use)g(Lisp.)680 4880
y(The)25 b(book)f(concludes)h(with)h(a)g(discussion)f(of)h
(object\255oriented)d(programming,)g(and)555 4985 y(particularly)29
b Fr(CLOS)p FA(,)k(the)e(Common)e(Lisp)i(Object)g(System.)61
b(By)31 b(sa)n(ving)f(this)h(topic)g(till)p eop
%%Page: 9 9
9 8 bop 1770 538 a Fu(PREF)l(A)n(CE)1148 b FA(ix)555
801 y(last,)32 b(we)d(see)g(more)f(clearly)h(the)f(w)o(ay)h(in)g(which)
g(object\255oriented)d(programming)f(is)30 b(an)555 905
y(e)o(xtension)19 b(of)i(ideas)g(already)f(present)g(in)h(Lisp.)31
b(It)21 b(is)h(one)e(of)h(the)g(man)o(y)e(abstractions)h(that)555
1010 y(can)g(be)g(b)n(uilt)g Ft(on)g(Lisp.)680 1114 y
FA(A)g(chapter')-5 b(s)19 b(w)o(orth)g(of)g(notes)h(be)o(gins)e(on)i
(page)f(387.)28 b(The)19 b(notes)h(contain)e(references,)555
1219 y(additional)13 b(or)h(alternati)n(v)o(e)e(code,)j(or)f
(descriptions)f(of)g(aspects)i(of)f(Lisp)g(not)g(directly)f(related)555
1324 y(to)23 b(the)f(point)g(at)i(hand.)35 b(Notes)23
b(are)f(indicated)g(by)g(a)h(small)g(circle)g(in)g(the)f(outside)h(mar)
o(gin,)555 1428 y(lik)o(e)d(this.)30 b(There)20 b(is)h(also)f(an)g
(Appendix)e(\(page)i(381\))f(on)g(packages.)727 b Fq(\016)680
1533 y FA(Just)23 b(as)h(a)g(tour)e(of)h(Ne)n(w)g(Y)-9
b(ork)22 b(could)g(be)i(a)f(tour)f(of)h(most)g(of)g(the)g(w)o(orld')-5
b(s)23 b(cultures,)g(a)555 1638 y(study)c(of)g(Lisp)h(as)h(the)e
(programmable)d(programming)h(language)g(dra)o(ws)j(in)f(most)h(of)f
(Lisp)555 1742 y(technique.)27 b(Most)18 b(of)g(the)h(techniques)d
(described)h(here)h(are)g(generally)f(kno)n(wn)g(in)h(the)g(Lisp)555
1847 y(community)-5 b(,)19 b(b)n(ut)i(man)o(y)g(ha)n(v)o(e)f(not)h
(till)i(no)n(w)e(been)f(written)i(do)n(wn)e(an)o(ywhere.)31
b(And)21 b(some)555 1951 y(issues,)d(such)f(as)g(the)g(proper)e(role)i
(of)f(macros)g(or)h(the)f(nature)g(of)h(v)n(ariable)f(capture,)g(are)g
(only)555 2056 y(v)n(aguely)j(understood)e(e)n(v)o(en)i(by)h(man)o(y)f
(e)o(xperienced)f(Lisp)i(programmers.)555 2309 y Fw(Examples)555
2499 y FA(Lisp)i(is)h(a)g(f)o(amily)f(of)f(languages.)34
b(Since)22 b(Common)f(Lisp)h(promises)g(to)g(remain)f(a)i(widely)555
2604 y(used)14 b(dialect,)h(most)g(of)f(the)g(e)o(xamples)g(in)g(this)h
(book)e(are)h(in)h(Common)e(Lisp.)27 b(The)14 b(language)555
2708 y(w)o(as)22 b(originally)d(de\002ned)i(in)g(1984)e(by)i(the)g
(publication)f(of)g(Guy)h(Steele')-5 b(s)22 b Ft(Common)e(Lisp:)555
2813 y(the)f(Langua)o(g)o(e)e FA(\()p Fr(CL)-6 b(TL)p
FA(1\).)27 b(This)19 b(de\002nition)f(w)o(as)h(superseded)f(in)h(1990)e
(by)i(the)f(publication)555 2918 y(of)24 b(the)h(second)f(edition)f(\()
p Fr(CL)-6 b(TL)p FA(2\),)24 b(which)g(will)h(in)g(turn)f(yield)g
(place)g(to)h(the)g(forthcoming)54 b Fq(\016)555 3022
y Fr(ANSI)21 b FA(standard.)680 3127 y(This)e(book)f(contains)h
(hundreds)e(of)i(e)o(xamples,)f(ranging)g(from)g(single)h(e)o
(xpressions)f(to)555 3232 y(a)j(w)o(orking)e(Prolog)h(implementation.)
28 b(The)20 b(code)g(in)h(this)g(book)e(has,)h(where)n(v)o(er)f
(possible,)555 3336 y(been)e(written)g(to)h(w)o(ork)e(in)i(an)o(y)f(v)o
(ersion)f(of)h(Common)f(Lisp.)28 b(Those)17 b(fe)n(w)h(e)o(xamples)e
(which)555 3441 y(need)22 b(features)f(not)i(found)d(in)j
Fr(CL)-6 b(TL)p FA(1)21 b(implementations)g(are)h(e)o(xplicitly)f
(identi\002ed)h(in)h(the)555 3545 y(te)o(xt.)55 b(Later)29
b(chapters)f(contain)g(some)g(e)o(xamples)g(in)h(Scheme.)55
b(These)29 b(too)f(are)h(clearly)555 3650 y(identi\002ed.)680
3755 y(The)23 b(code)g(is)h(a)n(v)n(ailable)f(by)h(anon)o(ymous)c
Fr(FTP)k FA(from)e Fs(endor.harvard.edu)o FA(,)d(where)555
3859 y(it')-5 b(s)40 b(in)e(the)h(directory)e Fs(pub/onlisp)p
FA(.)80 b(Questions)38 b(and)g(comments)g(can)g(be)h(sent)f(to)555
3964 y Fs(onlisp@das.harva)o(rd.)o(ed)o(u)p FA(.)555
4217 y Fw(Ackno)o(wledgements)555 4407 y FA(While)25
b(writing)e(this)i(book)e(I)h(ha)n(v)o(e)g(been)f(particularly)g
(thankful)g(for)g(the)h(help)g(of)g(Robert)555 4512 y(Morris.)41
b(I)24 b(went)g(to)g(him)g(constantly)f(for)h(advice)f(and)h(w)o(as)h
(al)o(w)o(ays)g(glad)e(I)i(did.)40 b(Se)n(v)o(eral)555
4616 y(of)19 b(the)h(e)o(xamples)e(in)i(this)g(book)e(are)i(deri)n(v)o
(ed)d(from)i(code)g(he)g(originally)f(wrote,)h(including)555
4721 y(the)31 b(v)o(ersion)f(of)h Fs(for)f FA(on)h(page)g(127,)h(the)g
(v)o(ersion)d(of)i Fs(aand)f FA(on)h(page)g(191,)h Fs(match)e
FA(on)555 4826 y(page)19 b(239,)g(the)g(breadth\255\002rst)f
Fs(true-choose)e FA(on)j(page)g(304,)g(and)g(the)h(Prolog)e
(interpreter)p eop
%%Page: 10 10
10 9 bop 555 538 a FA(x)1173 b Fu(PREF)l(A)n(CE)555 801
y FA(in)21 b(Section)g(24.2.)30 b(In)21 b(f)o(act,)g(the)g(whole)g
(book)e(re\003ects)j(\(sometimes,)e(indeed,)g(transcribes\))555
905 y(con)m(v)o(ersations)e(I')l(v)o(e)h(had)g(with)i(Robert)f(during)e
(the)i(past)h(se)n(v)o(en)e(years.)29 b(\(Thanks,)19
b(rtm!\))680 1010 y(I)j(w)o(ould)g(also)g(lik)o(e)h(to)f(gi)n(v)o(e)g
(special)g(thanks)g(to)g(Da)n(vid)g(Moon,)g(who)g(read)f(lar)o(ge)h
(parts)555 1114 y(of)17 b(the)g(manuscript)e(with)j(great)e(care,)h
(and)g(ga)n(v)o(e)f(me)h(v)o(ery)f(useful)h(comments.)27
b(Chapter)16 b(12)555 1219 y(w)o(as)25 b(completely)e(re)n(written)h
(at)h(his)g(suggestion,)f(and)g(the)h(e)o(xample)e(of)h(v)n(ariable)g
(capture)555 1324 y(on)c(page)f(119)h(is)h(one)e(that)i(he)f(pro)o
(vided.)680 1428 y(I)k(w)o(as)i(fortunate)c(to)j(ha)n(v)o(e)f(Da)n(vid)
g(T)-7 b(ouretzk)o(y)23 b(and)h(Sk)o(ona)g(Brittain)g(as)i(the)e
(technical)555 1533 y(re)n(vie)n(wers)d(for)f(the)i(book.)31
b(Se)n(v)o(eral)21 b(sections)h(were)f(added)f(or)i(re)n(written)e(at)i
(their)f(sugges\255)555 1638 y(tion.)36 b(The)23 b(alternati)n(v)o(e)e
(true)h(nondeterministic)f(choice)h(operator)e(on)j(page)f(397)f(is)j
(based)555 1742 y(on)c(a)g(suggestion)f(by)h(Da)n(vid)g(T)-7
b(oureztk)o(y)i(.)680 1847 y(Se)n(v)o(eral)17 b(other)h(people)f
(consented)g(to)i(read)f(all)h(or)f(part)g(of)g(the)g(manuscript,)f
(including)555 1951 y(T)-7 b(om)33 b(Cheatham,)j(Richard)d(Dra)n(v)o
(es)g(\(who)g(also)g(re)n(wrote)g Fs(alambda)e FA(and)i
Fs(propmacro)555 2056 y FA(back)g(in)h(1985\),)i(John)d(F)o(oderaro,)i
(Da)n(vid)f(Hendler)m(,)i(Geor)o(ge)c(Luger)m(,)k(Robert)e(Muller)m(,)
555 2161 y(Mark)20 b(Nitzber)o(g,)e(and)i(Guy)f(Steele.)680
2265 y(I'm)h(grateful)f(to)i(Professor)f(Cheatham,)g(and)g(Harv)n(ard)f
(generally)-5 b(,)19 b(for)h(pro)o(viding)e(the)555 2370
y(f)o(acilities)i(used)f(to)h(write)g(this)g(book.)27
b(Thanks)19 b(also)h(to)f(the)h(staf)n(f)f(at)h(Aik)o(en)f(Lab,)g
(including)555 2474 y(T)-7 b(on)o(y)19 b(Hartman,)g(Janusz)h(Juda,)g
(Harry)f(Bochner)m(,)g(and)g(Joanne)h(Klys.)680 2579
y(The)25 b(people)f(at)i(Prentice)f(Hall)h(did)g(a)f(great)h(job)m(.)44
b(I)26 b(feel)f(fortunate)f(to)i(ha)n(v)o(e)f(w)o(ork)o(ed)555
2684 y(with)30 b(Alan)f(Apt,)j(a)e(good)e(editor)h(and)g(a)h(good)e
(guy)-5 b(.)55 b(Thanks)29 b(also)h(to)f(Mona)g(Pompili,)555
2788 y(Shirle)o(y)19 b(Michaels,)h(and)g(Shirle)o(y)f(McGuire)h(for)f
(their)h(or)o(ganization)d(and)j(good)f(humor)-5 b(.)680
2893 y(The)18 b(incomparable)f(Gino)h(Lee)h(of)g(the)g(Bo)n(w)h(and)e
(Arro)n(w)g(Press,)i(Cambridge,)e(did)h(the)555 2997
y(co)o(v)o(er)-5 b(.)28 b(The)20 b(tree)g(on)g(the)g(co)o(v)o(er)f
(alludes)h(speci\002cally)g(to)g(the)g(point)g(made)f(on)h(page)g(27.)
680 3102 y(This)c(book)f(w)o(as)i(typeset)f(using)g(L)1642
3091 y Fr(A)1678 3102 y FA(T)1715 3128 y(E)1755 3102
y(X,)g(a)h(language)d(written)j(by)e(Leslie)i(Lamport)e(atop)555
3207 y(Donald)25 b(Knuth')-5 b(s)26 b(T)1153 3225 y(E)1193
3207 y(X,)h(with)g(additional)e(macros)g(by)h(L.)h(A.)f(Carr)m(,)i(V)-9
b(an)26 b(Jacobson,)g(and)555 3311 y(Guy)i(Steele.)53
b(The)28 b(diagrams)f(were)h(done)f(with)i(Idra)o(w)-5
b(,)28 b(by)g(John)g(Vlissides)h(and)e(Scott)555 3416
y(Stanton.)48 b(The)27 b(whole)f(w)o(as)i(pre)n(vie)n(wed)d(with)i
(Ghostvie)n(w)-5 b(,)27 b(by)g(T)m(im)g(Theisen,)g(which)g(is)555
3520 y(b)n(uilt)c(on)g(Ghostscript,)h(by)e(L.)i(Peter)f(Deutsch.)38
b(Gary)23 b(Bisbee)h(of)f(Chiron)f(Inc.)h(produced)555
3625 y(the)d(camera\255ready)e(cop)o(y)-5 b(.)680 3730
y(I)30 b(o)n(we)g(thanks)f(to)h(man)o(y)f(others,)j(including)c(P)o
(aul)i(Beck)o(er)m(,)i(Phil)e(Chapnick,)h(Alice)555 3834
y(Hartle)o(y)-5 b(,)29 b(Glenn)f(Hollo)n(w)o(ay)-5 b(,)29
b(Meichun)e(Hsu,)j(Krzysztof)e(Lenk,)h(Arman)f(Maghbouleh,)555
3939 y(Ho)n(w)o(ard)13 b(Mullings,)h(Nanc)o(y)f(P)o(armet,)i(Robert)e
(Penn)o(y)-5 b(,)14 b(Gary)f(Sabot,)i(P)o(atrick)e(Slane)o(y)-5
b(,)14 b(Ste)n(v)o(e)555 4043 y(Strassman,)20 b(Da)n(v)o(e)g(W)-7
b(atkins,)20 b(the)h(W)-7 b(eick)o(ers,)20 b(and)g(Bill)h(W)-7
b(oods.)680 4148 y(Most)15 b(of)g(all,)h(I')l(d)e(lik)o(e)i(to)f(thank)
f(my)h(parents,)g(for)g(their)g(e)o(xample)e(and)i(encouragement;)555
4253 y(and)20 b(Jackie,)g(who)f(taught)h(me)g(what)g(I)g(might)g(ha)n
(v)o(e)g(learned)f(if)h(I)h(had)e(listened)h(to)h(them.)680
4567 y(I)g(hope)g(reading)f(this)j(book)d(will)i(be)g(fun.)33
b(Of)22 b(all)g(the)g(languages)e(I)i(kno)n(w)-5 b(,)20
b(I)i(lik)o(e)g(Lisp)555 4672 y(the)28 b(best,)h(simply)e(because)g
(it')-5 b(s)29 b(the)f(most)f(beautiful.)50 b(This)28
b(book)e(is)j(about)e(Lisp)g(at)i(its)555 4777 y(lispiest.)h(I)20
b(had)g(fun)f(writing)h(it,)h(and)e(I)i(hope)e(that)h(comes)g(through)e
(in)i(the)h(te)o(xt.)2794 4940 y Ft(P)-7 b(aul)20 b(Gr)o(aham)p
eop
%%Page: 11 11
11 10 bop 555 1608 2686 3 v 555 1816 a Fx(Contents)555
2234 y Fp(1.)29 b(The)21 b(Extensible)g(Language)74 b
Fv(1)555 2358 y(1.1.)137 b(Design)19 b(by)h(Ev)o(olution)75
b(1)555 2450 y(1.2.)137 b(Programming)20 b(Bottom\255Up)75
b(3)555 2541 y(1.3.)137 b(Extensible)19 b(Softw)o(are)75
b(5)555 2632 y(1.4.)137 b(Extending)20 b(Lisp)74 b(6)555
2723 y(1.5.)137 b(Why)19 b(Lisp)f(\(or)h(When\))75 b(8)555
2932 y Fp(2.)29 b(Functions)75 b Fv(9)555 3056 y(2.1.)137
b(Functions)20 b(as)e(Data)75 b(9)555 3148 y(2.2.)137
b(De\002ning)19 b(Functions)76 b(10)555 3239 y(2.3.)137
b(Functional)19 b(Ar)o(guments)76 b(13)555 3330 y(2.4.)137
b(Functions)20 b(as)e(Properties)75 b(15)555 3422 y(2.5.)137
b(Scope)75 b(16)555 3513 y(2.6.)137 b(Closures)75 b(17)555
3604 y(2.7.)137 b(Local)19 b(Functions)75 b(21)555 3696
y(2.8.)137 b(T)-6 b(ail\255Recursion)75 b(22)555 3787
y(2.9.)137 b(Compilation)75 b(24)555 3878 y(2.10.)100
b(Functions)20 b(from)e(Lists)75 b(27)555 4087 y Fp(3.)29
b(Functional)20 b(Pr)o(ogramming)72 b Fv(28)555 4211
y(3.1.)137 b(Functional)19 b(Design)76 b(28)555 4302
y(3.2.)137 b(Imperati)n(v)o(e)19 b(Outside\255In)76 b(33)555
4394 y(3.3.)137 b(Functional)19 b(Interf)o(aces)76 b(35)555
4485 y(3.4.)137 b(Interacti)n(v)o(e)19 b(Programming)76
b(37)555 4693 y Fp(4.)29 b(Utility)20 b(Functions)74
b Fv(40)555 4818 y(4.1.)137 b(Birth)18 b(of)h(a)g(Utility)74
b(40)555 4909 y(4.2.)137 b(In)m(v)o(est)19 b(in)g(Abstraction)75
b(43)555 5001 y(4.3.)137 b(Operations)20 b(on)f(Lists)74
b(44)1972 2234 y(4.4.)137 b(Search)75 b(48)1972 2325
y(4.5.)137 b(Mapping)77 b(53)1972 2416 y(4.6.)137 b(I/O)75
b(56)1972 2508 y(4.7.)137 b(Symbols)20 b(and)f(Strings)75
b(57)1972 2599 y(4.8.)137 b(Density)75 b(59)1972 2818
y Fp(5.)29 b(Retur)o(ning)20 b(Functions)75 b Fv(61)1972
2943 y(5.1.)137 b(Common)20 b(Lisp)f(Ev)o(olv)o(es)75
b(61)1972 3034 y(5.2.)137 b(Orthogonality)76 b(63)1972
3126 y(5.3.)137 b(Memoizing)77 b(65)1972 3217 y(5.4.)137
b(Composing)21 b(Functions)75 b(66)1972 3308 y(5.5.)137
b(Recursion)20 b(on)f(Cdrs)75 b(68)1972 3400 y(5.6.)137
b(Recursion)20 b(on)f(Subtrees)75 b(70)1972 3491 y(5.7.)137
b(When)19 b(to)g(Build)g(Functions)75 b(75)1972 3710
y Fp(6.)29 b(Functions)21 b(as)f(Repr)o(esentation)73
b Fv(76)1972 3835 y(6.1.)137 b(Netw)o(orks)76 b(76)1972
3926 y(6.2.)137 b(Compiling)20 b(Netw)o(orks)75 b(79)1972
4017 y(6.3.)137 b(Looking)20 b(F)o(orw)o(ard)75 b(81)1972
4237 y Fp(7.)29 b(Macr)o(os)74 b Fv(82)1972 4361 y(7.1.)137
b(Ho)n(w)19 b(Macros)h(W)-6 b(ork)75 b(82)1972 4453 y(7.2.)137
b(Backquote)77 b(84)1972 4544 y(7.3.)137 b(De\002ning)19
b(Simple)g(Macros)76 b(88)1972 4635 y(7.4.)137 b(T)-5
b(esting)19 b(Macroe)o(xpansion)78 b(91)1972 4727 y(7.5.)137
b(Destructuring)20 b(in)f(P)o(arameter)2221 4818 y(Lists)74
b(93)1972 4909 y(7.6.)137 b(A)19 b(Model)h(of)f(Macros)75
b(95)1972 5001 y(7.7.)137 b(Macros)20 b(as)f(Programs)75
b(96)1865 5229 y FA(xi)p eop
%%Page: 12 12
12 11 bop 555 538 a FA(xii)1098 b Fu(CONTENTS)555 801
y Fv(7.8.)137 b(Macro)20 b(Style)74 b(99)555 892 y(7.9.)137
b(Dependence)21 b(on)e(Macros)76 b(101)555 983 y(7.10.)100
b(Macros)20 b(from)f(Functions)75 b(102)555 1075 y(7.11.)100
b(Symbol)19 b(Macros)76 b(105)555 1279 y Fp(8.)29 b(When)21
b(to)f(Use)h(Macr)o(os)74 b Fv(106)555 1403 y(8.1.)137
b(When)19 b(Nothing)h(Else)e(W)m(ill)804 1495 y(Do)75
b(106)555 1586 y(8.2.)137 b(Macro)20 b(or)f(Function?)75
b(109)555 1677 y(8.3.)137 b(Applications)20 b(for)e(Macros)76
b(111)555 1881 y Fp(9.)29 b(V)-8 b(ariable)20 b(Captur)o(e)74
b Fv(118)555 2006 y(9.1.)137 b(Macro)20 b(Ar)o(gument)f(Capture)75
b(118)555 2097 y(9.2.)137 b(Free)19 b(Symbol)g(Capture)75
b(119)555 2188 y(9.3.)137 b(When)19 b(Capture)g(Occurs)76
b(121)555 2280 y(9.4.)137 b(A)-6 b(v)o(oiding)20 b(Capture)f(with)g
(Better)804 2371 y(Names)75 b(125)555 2462 y(9.5.)137
b(A)-6 b(v)o(oiding)20 b(Capture)f(by)h(Prior)804 2554
y(Ev)n(aluation)76 b(125)555 2645 y(9.6.)137 b(A)-6 b(v)o(oiding)20
b(Capture)f(with)804 2736 y(Gensyms)76 b(128)555 2828
y(9.7.)137 b(A)-6 b(v)o(oiding)20 b(Capture)f(with)804
2919 y(P)o(ackages)76 b(130)555 3010 y(9.8.)137 b(Capture)19
b(in)g(Other)804 3102 y(Name\255Spaces)76 b(130)555 3193
y(9.9.)137 b(Why)19 b(Bother?)75 b(132)555 3397 y Fp(10.)29
b(Other)20 b(Macr)o(o)f(Pitfalls)74 b Fv(133)555 3522
y(10.1.)100 b(Number)20 b(of)f(Ev)n(aluations)75 b(133)555
3613 y(10.2.)100 b(Order)19 b(of)g(Ev)n(aluation)76 b(135)555
3704 y(10.3.)100 b(Non\255functional)20 b(Expanders)76
b(136)555 3796 y(10.4.)100 b(Recursion)76 b(139)555 4000
y Fp(11.)29 b(Classic)21 b(Macr)o(os)73 b Fv(143)555
4124 y(11.1.)100 b(Creating)19 b(Conte)o(xt)75 b(143)555
4215 y(11.2.)100 b(The)19 b Fo(with-)h Fv(Macro)75 b(147)555
4307 y(11.3.)100 b(Conditional)20 b(Ev)n(aluation)75
b(150)555 4398 y(11.4.)100 b(Iteration)75 b(154)555 4489
y(11.5.)100 b(Iteration)19 b(with)f(Multiple)804 4581
y(V)-8 b(alues)75 b(158)555 4672 y(11.6.)100 b(Need)19
b(for)g(Macros)76 b(161)555 4876 y Fp(12.)29 b(Generalized)19
b(V)-8 b(ariables)75 b Fv(165)555 5001 y(12.1.)100 b(The)19
b(Concept)76 b(165)1972 801 y(12.2.)100 b(The)19 b(Multiple)g(Ev)n
(aluation)2221 892 y(Problem)75 b(167)1972 983 y(12.3.)100
b(Ne)n(w)19 b(Utilities)74 b(169)1972 1075 y(12.4.)100
b(More)20 b(Comple)o(x)f(Utilities)74 b(171)1972 1166
y(12.5.)100 b(De\002ning)19 b(In)m(v)o(ersions)76 b(178)1972
1407 y Fp(13.)29 b(Computation)19 b(at)2122 1498 y(Compile\255T)o(ime)
74 b Fv(181)1972 1622 y(13.1.)100 b(Ne)n(w)19 b(Utilities)74
b(181)1972 1714 y(13.2.)100 b(Example:)28 b(Bezier)18
b(Curv)o(es)76 b(185)1972 1805 y(13.3.)100 b(Applications)76
b(186)1972 2046 y Fp(14.)29 b(Anaphoric)20 b(Macr)o(os)74
b Fv(189)1972 2170 y(14.1.)100 b(Anaphoric)20 b(V)-8
b(ariants)75 b(189)1972 2262 y(14.2.)100 b(F)o(ailure)75
b(195)1972 2353 y(14.3.)100 b(Referential)19 b(T)m(ransparenc)o(y)77
b(198)1972 2593 y Fp(15.)29 b(Macr)o(os)20 b(Retur)o(ning)2122
2685 y(Functions)74 b Fv(201)1972 2809 y(15.1.)100 b(Building)20
b(Functions)75 b(201)1972 2901 y(15.2.)100 b(Recursion)20
b(on)f(Cdrs)75 b(204)1972 2992 y(15.3.)100 b(Recursion)20
b(on)f(Subtrees)75 b(208)1972 3083 y(15.4.)100 b(Lazy)19
b(Ev)n(aluation)76 b(211)1972 3324 y Fp(16.)29 b(Macr)o
(o\255De\002ning)19 b(Macr)o(os)74 b Fv(213)1972 3448
y(16.1.)100 b(Abbre)n(viations)77 b(213)1972 3540 y(16.2.)100
b(Properties)75 b(216)1972 3631 y(16.3.)100 b(Anaphoric)20
b(Macros)76 b(218)1972 3872 y Fp(17.)29 b(Read\255Macr)o(os)73
b Fv(224)1972 3996 y(17.1.)100 b(Macro)20 b(Characters)75
b(224)1972 4088 y(17.2.)100 b(Dispatching)20 b(Macro)2221
4179 y(Characters)76 b(226)1972 4270 y(17.3.)100 b(Delimiters)74
b(227)1972 4362 y(17.4.)100 b(When)19 b(What)g(Happens)76
b(229)1972 4602 y Fp(18.)29 b(Destructuring)74 b Fv(230)1972
4727 y(18.1.)100 b(Destructuring)20 b(on)f(Lists)74 b(230)1972
4818 y(18.2.)100 b(Other)19 b(Structures)75 b(231)1972
4909 y(18.3.)100 b(Reference)76 b(236)1972 5001 y(18.4.)100
b(Matching)76 b(238)p eop
%%Page: 13 13
13 12 bop 1741 538 a Fu(CONTENTS)1075 b FA(xiii)555 801
y Fp(19.)29 b(A)20 b(Query)g(Compiler)75 b Fv(246)555
925 y(19.1.)100 b(The)19 b(Database)76 b(247)555 1017
y(19.2.)100 b(P)o(attern\255Matching)20 b(Queries)75
b(248)555 1108 y(19.3.)100 b(A)19 b(Query)g(Interpreter)75
b(250)555 1199 y(19.4.)100 b(Restrictions)19 b(on)g(Binding)76
b(252)555 1290 y(19.5.)100 b(A)19 b(Query)g(Compiler)75
b(254)555 1488 y Fp(20.)29 b(Continuations)73 b Fv(258)555
1612 y(20.1.)100 b(Scheme)19 b(Continuations)76 b(258)555
1704 y(20.2.)100 b(Continuation\255P)o(assing)804 1795
y(Macros)76 b(266)555 1886 y(20.3.)100 b(Code\255W)-6
b(alk)o(ers)20 b(and)f(CPS)804 1978 y(Con)m(v)o(ersion)76
b(272)555 2175 y Fp(21.)29 b(Multiple)21 b(Pr)o(ocesses)74
b Fv(275)555 2300 y(21.1.)100 b(The)19 b(Process)g(Abstraction)75
b(275)555 2391 y(21.2.)100 b(Implementation)76 b(277)555
2482 y(21.3.)100 b(The)19 b(Less\255than\255Rapid)804
2574 y(Prototype)75 b(284)555 2771 y Fp(22.)29 b(Nondeterminism)74
b Fv(286)555 2896 y(22.1.)100 b(The)19 b(Concept)76 b(286)555
2987 y(22.2.)100 b(Search)75 b(290)555 3078 y(22.3.)100
b(Scheme)19 b(Implementation)76 b(292)555 3170 y(22.4.)100
b(Common)20 b(Lisp)804 3261 y(Implementation)76 b(294)555
3352 y(22.5.)100 b(Cuts)75 b(298)555 3444 y(22.6.)100
b(T)m(rue)19 b(Nondeterminism)76 b(302)555 3641 y Fp(23.)29
b(P)o(arsing)20 b(with)g(A)-8 b(TNs)76 b Fv(305)555 3765
y(23.1.)100 b(Background)77 b(305)555 3857 y(23.2.)100
b(The)19 b(F)o(ormalism)74 b(306)555 3948 y(23.3.)100
b(Nondeterminism)76 b(308)555 4039 y(23.4.)100 b(An)19
b(A)-8 b(TN)18 b(Compiler)75 b(309)555 4131 y(23.5.)100
b(A)19 b(Sample)g(A)-8 b(TN)74 b(314)555 4328 y Fp(24.)29
b(Pr)o(olog)72 b Fv(321)555 4453 y(24.1.)100 b(Concepts)76
b(321)555 4544 y(24.2.)100 b(An)19 b(Interpreter)75 b(323)555
4635 y(24.3.)100 b(Rules)75 b(329)555 4727 y(24.4.)100
b(The)19 b(Need)g(for)804 4818 y(Nondeterminism)76 b(333)555
4909 y(24.5.)100 b(Ne)n(w)19 b(Implementation)76 b(334)555
5001 y(24.6.)100 b(Adding)20 b(Prolog)f(Features)75 b(337)1972
801 y(24.7.)100 b(Examples)76 b(344)1972 892 y(24.8.)100
b(The)19 b(Senses)g(of)g(Compile)75 b(346)1972 1083 y
Fp(25.)29 b(Object\255Oriented)18 b(Lisp)76 b Fv(348)1972
1207 y(25.1.)100 b(Plus)19 b(c)-29 b(\270)t(a)19 b(Change)76
b(348)1972 1299 y(25.2.)100 b(Objects)19 b(in)g(Plain)f(Lisp)75
b(349)1972 1390 y(25.3.)100 b(Classes)19 b(and)h(Instances)75
b(364)1972 1481 y(25.4.)100 b(Methods)77 b(368)1972 1573
y(25.5.)100 b(Auxiliary)19 b(Methods)i(and)2221 1664
y(Combination)76 b(374)1972 1755 y(25.6.)100 b(CLOS)18
b(and)i(Lisp)74 b(377)1972 1847 y(25.7.)100 b(When)19
b(to)g(Object)75 b(379)p eop
%%Page: 1 14
1 13 bop 555 1610 a Fn(1)p 555 1872 2686 3 v 555 2131
a Fx(The)41 b(Extensible)h(Language)555 2568 y FA(Not)19
b(long)g(ago,)g(if)g(you)g(ask)o(ed)g(what)g(Lisp)g(w)o(as)i(for)m(,)d
(man)o(y)g(people)g(w)o(ould)h(ha)n(v)o(e)g(answered)555
2672 y(\223for)h(arti\002cial)g(intelligence.)-6 b(\224)30
b(In)20 b(f)o(act,)g(the)h(association)f(between)f(Lisp)i(and)f
Fr(AI)h FA(is)h(just)f(an)555 2777 y(accident)g(of)g(history)-5
b(.)33 b(Lisp)22 b(w)o(as)g(in)m(v)o(ented)e(by)h(John)g(McCarthy,)g
(who)g(also)h(in)m(v)o(ented)e(the)555 2882 y(term)e(\223arti\002cial)h
(intelligence.)-6 b(\224)28 b(His)20 b(students)e(and)g(colleagues)g
(wrote)g(their)h(programs)d(in)555 2986 y(Lisp,)25 b(and)e(so)h(it)h
(be)o(gan)d(to)i(be)g(spok)o(en)f(of)g(as)i(an)f Fr(AI)g
FA(language.)39 b(This)24 b(line)g(w)o(as)h(tak)o(en)e(up)555
3091 y(and)c(repeated)e(so)j(often)e(during)g(the)h(brief)f
Fr(AI)i FA(boom)e(in)h(the)g(1980s)f(that)i(it)f(became)g(almost)555
3195 y(an)h(institution.)680 3300 y(F)o(ortunately)-5
b(,)26 b(w)o(ord)h(has)g(be)o(gun)f(to)h(spread)g(that)g
Fr(AI)h FA(is)g(not)f(what)g(Lisp)h(is)g(all)g(about.)555
3405 y(Recent)21 b(adv)n(ances)e(in)i(hardw)o(are)e(and)h(softw)o(are)g
(ha)n(v)o(e)g(made)g(Lisp)g(commercially)f(viable:)555
3509 y(it)e(is)g(no)n(w)e(used)h(in)g(Gnu)f(Emacs,)i(the)f(best)g(Unix)
g(te)o(xt\255editor;)f(Autocad,)h(the)g(industry)f(stan\255)555
3614 y(dard)i(desktop)f Fr(CAD)j FA(program;)d(and)h(Interleaf,)g(a)h
(leading)f(high\255end)e(publishing)h(program.)555 3718
y(The)k(w)o(ay)g(Lisp)g(is)i(used)e(in)g(these)g(programs)f(has)h
(nothing)e(whate)n(v)o(er)h(to)i(do)e(with)i Fr(AI)p
FA(.)680 3823 y(If)k(Lisp)h(is)g(not)g(the)f(language)f(of)i
Fr(AI)p FA(,)h(what)e(is)i(it?)46 b(Instead)25 b(of)h(judging)e(Lisp)h
(by)h(the)555 3928 y(compan)o(y)20 b(it)j(k)o(eeps,)f(let')-5
b(s)23 b(look)e(at)i(the)f(language)e(itself.)36 b(What)22
b(can)g(you)f(do)h(in)g(Lisp)g(that)555 4032 y(you)g(can')o(t)g(do)g
(in)h(other)f(languages?)36 b(One)23 b(of)f(the)h(most)g(distincti)n(v)
o(e)f(qualities)h(of)g(Lisp)g(is)555 4137 y(the)h(w)o(ay)f(it)i(can)e
(be)h(tailored)f(to)h(suit)g(the)g(program)d(being)i(written)g(in)h
(it.)40 b(Lisp)24 b(itself)h(is)f(a)555 4242 y(Lisp)g(program,)f(and)g
(Lisp)h(programs)e(can)i(be)g(e)o(xpressed)f(as)h(lists,)i(which)e(are)
g(Lisp)g(data)555 4346 y(structures.)k(T)-7 b(ogether)m(,)17
b(these)h(tw)o(o)h(principles)f(mean)g(that)g(an)o(y)g(user)g(can)h
(add)e(operators)g(to)555 4451 y(Lisp)j(which)g(are)g
(indistinguishable)e(from)h(the)i(ones)f(that)g(come)f(b)n(uilt\255in.)
555 4704 y Fw(1.1)99 b(Design)25 b(by)g(Ev)o(olution)555
4894 y FA(Because)d(Lisp)f(gi)n(v)o(es)g(you)f(the)i(freedom)d(to)j
(de\002ne)f(your)f(o)n(wn)h(operators,)f(you)g(can)h(mold)555
4999 y(it)27 b(into)g(just)g(the)g(language)e(you)h(need.)48
b(If)27 b(you')l(re)e(writing)h(a)h(te)o(xt\255editor)m(,)f(you)g(can)g
(turn)1877 5229 y(1)p eop
%%Page: 2 15
2 14 bop 555 538 a FA(2)879 b Fu(THE)18 b(EXTENSIBLE)f(LANGU)n(A)n(GE)
555 801 y FA(Lisp)27 b(into)f(a)i(language)d(for)h(writing)g(te)o
(xt\255editors.)48 b(If)26 b(you')l(re)f(writing)h(a)h
Fr(CAD)h FA(program,)555 905 y(you)c(can)h(turn)f(Lisp)h(into)f(a)i
(language)d(for)h(writing)g Fr(CAD)i FA(programs.)41
b(And)25 b(if)g(you')l(re)e(not)555 1010 y(sure)j(yet)g(what)g(kind)f
(of)g(program)f(you')l(re)g(writing,)i(it')-5 b(s)27
b(a)g(safe)f(bet)g(to)g(write)g(it)h(in)f(Lisp.)555 1114
y(Whate)n(v)o(er)21 b(kind)h(of)g(program)e(yours)i(turns)g(out)g(to)g
(be,)h(Lisp)f(will,)i(during)d(the)h(writing)g(of)555
1219 y(it,)f(ha)n(v)o(e)e(e)n(v)n(olv)o(ed)g(into)h(a)g(language)f(for)
g(writing)h Ft(that)g FA(kind)f(of)h(program.)680 1324
y(If)28 b(you')l(re)e(not)j(sure)f(yet)h(what)f(kind)g(of)g(program)e
(you')l(re)h(writing?)53 b(T)-7 b(o)29 b(some)f(ears)555
1428 y(that)d(sentence)f(has)h(an)g(odd)e(ring)h(to)h(it.)44
b(It)25 b(is)h(in)e(jarring)g(contrast)g(with)h(a)g(certain)f(model)555
1533 y(of)d(doing)e(things)i(wherein)f(you)g(\(1\))h(carefully)e(plan)i
(what)g(you')l(re)e(going)h(to)h(do,)g(and)f(then)555
1638 y(\(2\))k(do)h(it.)45 b(According)23 b(to)i(this)h(model,)f(if)g
(Lisp)g(encourages)e(you)i(to)g(start)g(writing)g(your)555
1742 y(program)19 b(before)h(you')l(v)o(e)e(decided)i(ho)n(w)h(it)h
(should)e(w)o(ork,)g(it)i(merely)e(encourages)f(slopp)o(y)555
1847 y(thinking.)680 1951 y(W)-7 b(ell,)21 b(it)h(just)f(ain')o(t)f
(so.)31 b(The)21 b(plan\255and\255implement)16 b(method)j(may)i(ha)n(v)
o(e)f(been)g(a)h(good)555 2056 y(w)o(ay)h(of)g(b)n(uilding)f(dams)h(or)
g(launching)f(in)m(v)n(asions,)g(b)n(ut)h(e)o(xperience)e(has)j(not)f
(sho)n(wn)f(it)i(to)555 2161 y(be)k(as)h(good)e(a)i(w)o(ay)g(of)f
(writing)g(programs.)49 b(Why?)h(Perhaps)27 b(it')-5
b(s)28 b(because)f(computers)555 2265 y(are)j(so)g(e)o(xacting.)56
b(Perhaps)30 b(there)f(is)i(more)d(v)n(ariation)h(between)g(programs)f
(than)h(there)555 2370 y(is)e(between)e(dams)h(or)f(in)m(v)n(asions.)46
b(Or)26 b(perhaps)e(the)i(old)g(methods)f(don')o(t)f(w)o(ork)h(because)
555 2474 y(old)c(concepts)f(of)g(redundanc)o(y)e(ha)n(v)o(e)i(no)h
(analogue)e(in)i(softw)o(are)f(de)n(v)o(elopment:)28
b(if)22 b(a)f(dam)555 2579 y(contains)g(30\045)g(too)h(much)e
(concrete,)h(that')-5 b(s)22 b(a)g(mar)o(gin)e(for)h(error)m(,)g(b)n
(ut)g(if)h(a)g(program)e(does)555 2684 y(30\045)g(too)g(much)f(w)o
(ork,)g(that)i Ft(is)g FA(an)f(error)-5 b(.)680 2788
y(It)18 b(may)f(be)h(dif)n(\002cult)f(to)h(say)g(why)e(the)i(old)g
(method)e(f)o(ails,)j(b)n(ut)e(that)h(it)h(does)e(f)o(ail,)h(an)o(yone)
555 2893 y(can)25 b(see.)43 b(When)25 b(is)h(softw)o(are)e(deli)n(v)o
(ered)f(on)i(time?)43 b(Experienced)23 b(programmers)f(kno)n(w)555
2997 y(that)d(no)g(matter)g(ho)n(w)f(carefully)g(you)g(plan)h(a)h
(program,)d(when)h(you)g(write)i(it)g(the)f(plans)g(will)555
3102 y(turn)27 b(out)g(to)g(be)h(imperfect)e(in)h(some)h(w)o(ay)-5
b(.)50 b(Sometimes)27 b(the)h(plans)f(will)h(be)f(hopelessly)555
3207 y(wrong.)54 b(Y)-8 b(et)29 b(fe)n(w)g(of)f(the)h(victims)g(of)g
(the)g(plan\255and\255implement)24 b(method)k(question)g(its)555
3311 y(basic)c(soundness.)38 b(Instead)23 b(the)o(y)g(blame)g(human)f
(f)o(ailings:)36 b(if)24 b(only)f(the)h(plans)f(had)g(been)555
3416 y(made)h(with)h(more)e(foresight,)h(all)h(this)g(trouble)f(could)f
(ha)n(v)o(e)h(been)g(a)n(v)n(oided.)41 b(Since)25 b(e)n(v)o(en)555
3520 y(the)d(v)o(ery)f(best)i(programmers)c(run)j(into)f(problems)g
(when)h(the)o(y)f(turn)h(to)g(implementation,)555 3625
y(perhaps)30 b(it')-5 b(s)32 b(too)f(much)f(to)h(hope)f(that)h(people)f
(will)i(e)n(v)o(er)e(ha)n(v)o(e)g Ft(that)h FA(much)f(foresight.)555
3730 y(Perhaps)16 b(the)g(plan\255and\255implement)d(method)i(could)g
(be)i(replaced)e(with)i(another)e(approach)555 3834 y(which)20
b(better)f(suits)i(our)f(limitations.)680 3939 y(W)-7
b(e)23 b(can)f(approach)f(programming)e(in)k(a)f(dif)n(ferent)f(w)o(ay)
-5 b(,)23 b(if)g(we)f(ha)n(v)o(e)g(the)h(right)f(tools.)555
4043 y(Why)29 b(do)f(we)i(plan)f(before)f(implementing?)54
b(The)28 b(big)h(danger)f(in)h(plunging)e(right)i(into)555
4148 y(a)d(project)g(is)h(the)f(possibility)f(that)h(we)h(will)f(paint)
g(ourselv)o(es)f(into)h(a)g(corner)-5 b(.)46 b(If)26
b(we)g(had)555 4253 y(a)h(more)f(\003e)o(xible)g(language,)g(could)g
(this)h(w)o(orry)e(be)i(lessened?)48 b(W)-7 b(e)28 b(do,)f(and)f(it)i
(is.)49 b(The)555 4357 y(\003e)o(xibility)21 b(of)h(Lisp)h(has)f(spa)o
(wned)f(a)i(whole)f(ne)n(w)g(style)g(of)g(programming.)32
b(In)22 b(Lisp,)g(you)555 4462 y(can)e(do)g(much)f(of)h(your)f
(planning)f(as)j(you)e(write)i(the)f(program.)680 4567
y(Why)27 b(w)o(ait)h(for)f(hindsight?)51 b(As)28 b(Montaigne)e(found,)i
(nothing)e(clari\002es)i(your)e(ideas)555 4671 y(lik)o(e)17
b(trying)e(to)i(write)g(them)f(do)n(wn.)27 b(Once)16
b(you')l(re)f(freed)h(from)f(the)i(w)o(orry)f(that)g(you')o(ll)g(paint)
555 4776 y(yourself)k(into)h(a)h(corner)m(,)e(you)h(can)g(tak)o(e)g
(full)h(adv)n(antage)d(of)i(this)h(possibility)-5 b(.)33
b(The)21 b(ability)555 4880 y(to)e(plan)e(programs)g(as)i(you)f(write)g
(them)g(has)h(tw)o(o)f(momentous)f(consequences:)26 b(programs)555
4985 y(tak)o(e)g(less)g(time)g(to)g(write,)g(because)f(when)g(you)g
(plan)g(and)g(write)g(at)h(the)g(same)g(time,)g(you)p
eop
%%Page: 3 16
3 15 bop 555 538 a Ft(1.2)847 b Fu(PR)n(OGRAMMING)19
b(BO)n(TT)o(OM)p Fv(\255)p Fu(UP)869 b FA(3)555 801 y(ha)n(v)o(e)20
b(a)h(real)g(program)e(to)h(focus)g(your)g(attention;)g(and)g(the)o(y)g
(turn)g(out)h Ft(better)p FA(,)g(because)f(the)555 905
y(\002nal)k(design)g(is)h(al)o(w)o(ays)g(a)f(product)f(of)h(e)n(v)n
(olution.)39 b(So)25 b(long)e(as)i(you)e(maintain)g(a)i(certain)555
1010 y(discipline)30 b(while)g(searching)f(for)h(your)f(program')-5
b(s)28 b(destin)o(y\227so)h(long)h(as)h(you)e(al)o(w)o(ays)555
1114 y(re)n(write)17 b(mistak)o(en)g(parts)g(as)h(soon)e(as)i(it)g
(becomes)e(clear)h(that)h(the)o(y')l(re)d(mistak)o(en\227the)h(\002nal)
555 1219 y(product)22 b(will)i(be)g(a)g(program)e(more)g(ele)o(gant)h
(than)g(if)h(you)f(had)g(spent)g(weeks)h(planning)e(it)555
1324 y(beforehand.)680 1428 y(Lisp')-5 b(s)37 b(v)o(ersatility)f(mak)o
(es)h(this)g(kind)f(of)g(programming)e(a)j(practical)f(alternati)n(v)o
(e.)555 1533 y(Indeed,)27 b(the)g(greatest)f(danger)f(of)i(Lisp)g(is)h
(that)f(it)g(may)g(spoil)g(you.)48 b(Once)26 b(you')l(v)o(e)f(used)555
1638 y(Lisp)i(for)f(a)g(while,)i(you)e(may)g(become)f(so)i(sensiti)n(v)
o(e)f(to)h(the)f(\002t)i(between)d(language)g(and)555
1742 y(application)18 b(that)h(you)g(w)o(on')o(t)f(be)h(able)g(to)h(go)
f(back)g(to)g(another)f(language)f(without)i(al)o(w)o(ays)555
1847 y(feeling)g(that)i(it)g(doesn')o(t)d(gi)n(v)o(e)i(you)f(quite)h
(the)g(\003e)o(xibility)f(you)h(need.)555 2100 y Fw(1.2)99
b(Pr)n(ogramming)25 b(Bottom\255Up)555 2290 y FA(It')-5
b(s)17 b(a)g(long\255standing)c(principle)i(of)h(programming)d(style)k
(that)f(the)g(functional)f(elements)h(of)555 2395 y(a)g(program)e
(should)g(not)h(be)h(too)f(lar)o(ge.)27 b(If)15 b(some)h(component)d
(of)i(a)h(program)e(gro)n(ws)h(be)o(yond)555 2499 y(the)31
b(stage)g(where)g(it')-5 b(s)32 b(readily)e(comprehensible,)h(it)h
(becomes)e(a)h(mass)h(of)f(comple)o(xity)555 2604 y(which)c(conceals)g
(errors)f(as)i(easily)g(as)g(a)f(big)g(city)h(conceals)f(fugiti)n(v)o
(es.)49 b(Such)27 b(softw)o(are)555 2708 y(will)21 b(be)f(hard)f(to)i
(read,)e(hard)g(to)i(test,)g(and)e(hard)g(to)i(deb)n(ug.)680
2813 y(In)16 b(accordance)f(with)h(this)i(principle,)d(a)j(lar)o(ge)d
(program)g(must)i(be)f(di)n(vided)f(into)i(pieces,)555
2918 y(and)30 b(the)h(lar)o(ger)e(the)i(program,)g(the)f(more)g(it)i
(must)e(be)h(di)n(vided.)59 b(Ho)n(w)31 b(do)f(you)g(di)n(vide)555
3022 y(a)f(program?)54 b(The)29 b(traditional)f(approach)e(is)k(called)
f Ft(top\255down)e(design:)46 b FA(you)28 b(say)i(\223the)555
3127 y(purpose)18 b(of)i(the)f(program)f(is)j(to)f(do)f(these)h(se)n(v)
o(en)f(things,)g(so)h(I)g(di)n(vide)f(it)i(into)e(se)n(v)o(en)g(major)
555 3232 y(subroutines.)52 b(The)28 b(\002rst)i(subroutine)c(has)j(to)g
(do)f(these)g(four)g(things,)h(so)g(it)g(in)g(turn)f(will)555
3336 y(ha)n(v)o(e)g(four)f(of)h(its)h(o)n(wn)f(subroutines,)-6
b(\224)29 b(and)f(so)g(on.)54 b(This)28 b(process)g(continues)f(until)i
(the)555 3441 y(whole)d(program)d(has)k(the)f(right)f(le)n(v)o(el)h(of)
g(granularity\227each)d(part)j(lar)o(ge)f(enough)f(to)i(do)555
3545 y(something)19 b(substantial,)g(b)n(ut)i(small)f(enough)e(to)j(be)
f(understood)e(as)j(a)f(single)g(unit.)680 3650 y(Experienced)e(Lisp)j
(programmers)d(di)n(vide)h(up)i(their)f(programs)f(dif)n(ferently)-5
b(.)28 b(As)22 b(well)555 3755 y(as)33 b(top\255do)n(wn)e(design,)k
(the)o(y)d(follo)n(w)f(a)i(principle)f(which)g(could)g(be)g(called)h
Ft(bottom\255up)555 3859 y(design)p FA(\227changing)18
b(the)j(language)e(to)i(suit)h(the)f(problem.)30 b(In)20
b(Lisp,)h(you)g(don')o(t)e(just)i(write)555 3964 y(your)g(program)g(do)
n(wn)h(to)n(w)o(ard)g(the)h(language,)e(you)h(also)h(b)n(uild)f(the)h
(language)e(up)h(to)n(w)o(ard)555 4068 y(your)16 b(program.)26
b(As)18 b(you')l(re)e(writing)g(a)i(program)d(you)i(may)f(think)h
(\223I)g(wish)h(Lisp)f(had)g(such\255)555 4173 y(and\255such)22
b(an)h(operator)-5 b(.)f(\224)37 b(So)23 b(you)f(go)h(and)g(write)g
(it.)39 b(Afterw)o(ard)22 b(you)h(realize)g(that)g(using)555
4278 y(the)18 b(ne)n(w)f(operator)f(w)o(ould)h(simplify)g(the)h(design)
e(of)i(another)e(part)h(of)h(the)f(program,)f(and)h(so)555
4382 y(on.)28 b(Language)15 b(and)i(program)f(e)n(v)n(olv)o(e)g
(together)-5 b(.)27 b(Lik)o(e)18 b(the)f(border)f(between)h(tw)o(o)h(w)
o(arring)555 4487 y(states,)25 b(the)e(boundary)d(between)i(language)g
(and)g(program)f(is)j(dra)o(wn)e(and)h(redra)o(wn,)f(until)555
4591 y(e)n(v)o(entually)j(it)i(comes)f(to)h(rest)g(along)f(the)h
(mountains)e(and)h(ri)n(v)o(ers,)h(the)g(natural)f(frontiers)555
4696 y(of)d(your)e(problem.)36 b(In)23 b(the)g(end)f(your)g(program)f
(will)j(look)e(as)h(if)h(the)f(language)e(had)h(been)555
4801 y(designed)17 b(for)g(it.)30 b(And)17 b(when)h(language)e(and)i
(program)e(\002t)j(one)f(another)e(well,)j(you)e(end)h(up)555
4905 y(with)i(code)g(which)g(is)h(clear)m(,)e(small,)i(and)e(ef)n
(\002cient.)p eop
%%Page: 4 17
4 16 bop 555 538 a FA(4)879 b Fu(THE)18 b(EXTENSIBLE)f(LANGU)n(A)n(GE)
680 801 y FA(It')-5 b(s)27 b(w)o(orth)f(emphasizing)e(that)j
(bottom\255up)d(design)i(doesn')o(t)f(mean)h(just)h(writing)f(the)555
905 y(same)e(program)e(in)i(a)h(dif)n(ferent)d(order)-5
b(.)40 b(When)24 b(you)f(w)o(ork)g(bottom\255up,)g(you)g(usually)g(end)
555 1010 y(up)17 b(with)h(a)g(dif)n(ferent)e(program.)27
b(Instead)17 b(of)g(a)h(single,)g(monolithic)e(program,)g(you)h(will)i
(get)555 1114 y(a)j(lar)o(ger)f(language)f(with)h(more)g(abstract)h
(operators,)e(and)h(a)i(smaller)e(program)f(written)h(in)555
1219 y(it.)30 b(Instead)19 b(of)h(a)h(lintel,)f(you')o(ll)f(get)i(an)f
(arch.)680 1324 y(In)15 b(typical)g(code,)h(once)f(you)g(abstract)g
(out)g(the)h(parts)g(which)f(are)g(merely)g(bookk)o(eeping,)555
1428 y(what')-5 b(s)18 b(left)g(is)g(much)e(shorter;)i(the)f(higher)g
(you)f(b)n(uild)h(up)g(the)h(language,)e(the)h(less)i(distance)555
1533 y(you)g(will)i(ha)n(v)o(e)f(to)g(tra)n(v)o(el)g(from)f(the)h(top)g
(do)n(wn)f(to)i(it.)30 b(This)20 b(brings)f(se)n(v)o(eral)h(adv)n
(antages:)659 1721 y(1.)41 b(By)31 b(making)f(the)i(language)e(do)h
(more)f(of)h(the)h(w)o(ork,)h(bottom\255up)c(design)i(yields)763
1825 y(programs)c(which)i(are)g(smaller)h(and)f(more)f(agile.)57
b(A)30 b(shorter)f(program)e(doesn')o(t)763 1930 y(ha)n(v)o(e)17
b(to)h(be)g(di)n(vided)f(into)h(so)g(man)o(y)f(components,)f(and)i(fe)n
(wer)f(components)f(means)763 2034 y(programs)33 b(which)h(are)h
(easier)g(to)g(read)g(or)f(modify)-5 b(.)72 b(Fe)n(wer)35
b(components)d(also)763 2139 y(means)d(fe)n(wer)g(connections)e
(between)i(components,)h(and)f(thus)g(less)i(chance)d(for)763
2244 y(errors)19 b(there.)28 b(As)21 b(industrial)e(designers)g(stri)n
(v)o(e)g(to)h(reduce)f(the)h(number)e(of)i(mo)o(ving)763
2348 y(parts)d(in)h(a)h(machine,)e(e)o(xperienced)e(Lisp)j(programmers)
d(use)j(bottom\255up)d(design)i(to)763 2453 y(reduce)i(the)h(size)h
(and)e(comple)o(xity)f(of)i(their)g(programs.)659 2624
y(2.)41 b(Bottom\255up)30 b(design)h(promotes)f(code)h(re\255use.)63
b(When)31 b(you)g(write)h(tw)o(o)g(or)f(more)763 2728
y(programs,)d(man)o(y)g(of)h(the)f(utilities)i(you)e(wrote)g(for)h(the)
f(\002rst)i(program)d(will)i(also)763 2833 y(be)c(useful)g(in)g(the)h
(succeeding)e(ones.)44 b(Once)26 b(you')l(v)o(e)d(acquired)h(a)h(lar)o
(ge)g(substrate)763 2938 y(of)f(utilities,)h(writing)f(a)h(ne)n(w)f
(program)e(can)i(tak)o(e)h(only)e(a)i(fraction)e(of)h(the)h(ef)n(fort)e
(it)763 3042 y(w)o(ould)c(require)g(if)h(you)g(had)f(to)i(start)f(with)
h(ra)o(w)f(Lisp.)659 3213 y(3.)41 b(Bottom\255up)19 b(design)h(mak)o
(es)h(programs)e(easier)j(to)f(read.)31 b(An)21 b(instance)g(of)f(this)
i(type)763 3318 y(of)e(abstraction)g(asks)h(the)g(reader)e(to)i
(understand)e(a)i(general\255purpose)c(operator;)j(an)763
3422 y(instance)25 b(of)g(functional)e(abstraction)i(asks)g(the)h
(reader)e(to)i(understand)d(a)j(special\255)763 3527
y(purpose)18 b(subroutine.)1420 3497 y Fm(1)659 3698
y FA(4.)41 b(Because)32 b(it)h(causes)g(you)e(al)o(w)o(ays)i(to)f(be)h
(on)f(the)g(look)o(out)f(for)h(patterns)f(in)i(your)763
3803 y(code,)d(w)o(orking)d(bottom\255up)g(helps)h(to)i(clarify)e(your)
f(ideas)j(about)e(the)h(design)f(of)763 3907 y(your)18
b(program.)27 b(If)20 b(tw)o(o)g(distant)g(components)e(of)i(a)g
(program)e(are)i(similar)g(in)g(form,)763 4012 y(you')o(ll)d(be)h(led)g
(to)g(notice)f(the)h(similarity)g(and)g(perhaps)e(to)j(redesign)e(the)h
(program)d(in)763 4117 y(a)20 b(simpler)g(w)o(ay)-5 b(.)555
4304 y(Bottom\255up)27 b(design)i(is)h(possible)e(to)i(a)f(certain)g
(de)o(gree)e(in)i(languages)f(other)g(than)h(Lisp.)555
4409 y(Whene)n(v)o(er)c(you)g(see)i(library)e(functions,)h
(bottom\255up)e(design)i(is)h(happening.)45 b(Ho)n(we)n(v)o(er)m(,)555
4513 y(Lisp)33 b(gi)n(v)o(es)g(you)f(much)g(broader)f(po)n(wers)i(in)g
(this)g(department,)h(and)f(augmenting)e(the)555 4618
y(language)21 b(plays)i(a)h(proportionately)19 b(lar)o(ger)j(role)h(in)
g(Lisp)g(style\227so)h(much)e(so)h(that)g(Lisp)555 4723
y(is)e(not)f(just)h(a)f(dif)n(ferent)f(language,)f(b)n(ut)i(a)h(whole)f
(dif)n(ferent)e(w)o(ay)i(of)g(programming.)p 555 4794
1074 4 v 645 4849 a Fl(1)675 4872 y Fr(\223But)d(no)f(one)g(can)h(read)
g(the)g(program)g(without)g(understanding)i(all)e(your)g(ne)n(w)f
(utilities.)-5 b(\224)28 b(T)-5 b(o)15 b(see)i(why)e(such)555
4955 y(statements)k(are)f(usually)g(mistak)o(en,)h(see)e(Section)i
(4.8.)p eop
%%Page: 5 18
5 17 bop 555 538 a Ft(1.3)909 b Fu(EXTENSIBLE)17 b(SOFTW)-7
b(ARE)933 b FA(5)680 801 y(It')-5 b(s)15 b(true)f(that)h(this)g(style)g
(of)f(de)n(v)o(elopment)e(is)j(better)f(suited)h(to)g(programs)d(which)
i(can)h(be)555 905 y(written)20 b(by)g(small)h(groups.)29
b(Ho)n(we)n(v)o(er)m(,)18 b(at)j(the)f(same)h(time,)f(it)h(e)o(xtends)f
(the)g(limits)h(of)g(what)555 1010 y(can)27 b(be)f(done)g(by)g(a)h
(small)h(group.)47 b(In)26 b Ft(The)h(Mythical)f(Man\255Month)p
FA(,)h(Frederick)e(Brooks)57 b Fq(\016)555 1114 y FA(proposed)19
b(that)i(the)g(producti)n(vity)d(of)j(a)h(group)d(of)i(programmers)d
(does)j(not)f(gro)n(w)g(linearly)555 1219 y(with)28 b(its)g(size.)51
b(As)28 b(the)g(size)g(of)f(the)g(group)f(increases,)i(the)g(producti)n
(vity)c(of)j(indi)n(vidual)555 1324 y(programmers)20
b(goes)i(do)n(wn.)34 b(The)22 b(e)o(xperience)e(of)i(Lisp)h
(programming)18 b(suggests)23 b(a)f(more)555 1428 y(cheerful)13
b(w)o(ay)i(to)f(phrase)g(this)h(la)o(w:)27 b(as)15 b(the)g(size)g(of)f
(the)h(group)e(decreases,)i(the)f(producti)n(vity)555
1533 y(of)30 b(indi)n(vidual)f(programmers)f(goes)j(up.)60
b(A)31 b(small)g(group)e(wins,)34 b(relati)n(v)o(ely)29
b(speaking,)555 1638 y(simply)i(because)g(it')-5 b(s)33
b(smaller)-5 b(.)63 b(When)31 b(a)h(small)g(group)e(also)i(tak)o(es)g
(adv)n(antage)d(of)j(the)555 1742 y(techniques)19 b(that)h(Lisp)g(mak)o
(es)h(possible,)e(it)i(can)f(win)g(outright.)555 1995
y Fw(1.3)99 b(Extensible)26 b(Softwar)n(e)555 2185 y
FA(The)e(Lisp)g(style)g(of)f(programming)e(is)k(one)e(that)h(has)g(gro)
n(wn)e(in)i(importance)e(as)j(softw)o(are)555 2290 y(has)15
b(gro)n(wn)f(in)h(comple)o(xity)-5 b(.)25 b(Sophisticated)15
b(users)g(no)n(w)g(demand)e(so)j(much)e(from)g(softw)o(are)555
2395 y(that)20 b(we)f(can')o(t)g(possibly)g(anticipate)g(all)h(their)f
(needs.)29 b(The)o(y)18 b(themselv)o(es)h(can')o(t)f(anticipate)555
2499 y(all)27 b(their)f(needs.)46 b(But)27 b(if)g(we)f(can')o(t)f(gi)n
(v)o(e)h(them)f(softw)o(are)h(which)g(does)g(e)n(v)o(erything)d(the)o
(y)555 2604 y(w)o(ant)28 b(right)f(out)g(of)g(the)h(box,)g(we)g(can)f
(gi)n(v)o(e)g(them)g(softw)o(are)h(which)f(is)h(e)o(xtensible.)50
b(W)-7 b(e)555 2708 y(transform)22 b(our)g(softw)o(are)h(from)f(a)i
(mere)f(program)e(into)i(a)g(programming)d(language,)i(and)555
2813 y(adv)n(anced)c(users)j(can)f(b)n(uild)f(upon)g(it)i(the)f(e)o
(xtra)g(features)f(that)i(the)o(y)e(need.)680 2918 y(Bottom\255up)38
b(design)i(leads)h(naturally)e(to)i(e)o(xtensible)e(programs.)88
b(The)40 b(simplest)555 3022 y(bottom\255up)30 b(programs)h(consist)i
(of)g(tw)o(o)g(layers:)54 b(language)31 b(and)h(program.)65
b(Comple)o(x)555 3127 y(programs)19 b(may)h(be)h(written)f(as)i(a)f
(series)g(of)g(layers,)f(each)h(one)f(acting)g(as)i(a)f(programming)555
3232 y(language)26 b(for)h(the)h(one)f(abo)o(v)o(e.)51
b(If)27 b(this)i(philosophy)c(is)j(carried)f(all)i(the)e(w)o(ay)h(up)g
(to)g(the)555 3336 y(topmost)g(layer)m(,)h(that)f(layer)g(becomes)g(a)g
(programming)d(language)i(for)h(the)g(user)-5 b(.)54
b(Such)555 3441 y(a)27 b(program,)f(where)g(e)o(xtensibility)f
(permeates)h(e)n(v)o(ery)f(le)n(v)o(el,)j(is)f(lik)o(ely)g(to)f(mak)o
(e)h(a)g(much)555 3545 y(better)h(programming)d(language)i(than)h(a)h
(system)g(which)f(w)o(as)h(written)f(as)i(a)f(traditional)555
3650 y(black)20 b(box,)f(and)g(then)h(made)g(e)o(xtensible)f(as)i(an)f
(afterthought.)680 3755 y(X)h(W)m(indo)n(ws)g(and)f(T)1274
3773 y(E)1315 3755 y(X)h(are)g(early)g(e)o(xamples)f(of)h(programs)e
(based)i(on)f(this)i(principle.)555 3859 y(In)f(the)g(1980s)e(better)i
(hardw)o(are)e(made)i(possible)f(a)i(ne)n(w)e(generation)f(of)i
(programs)e(which)555 3964 y(had)32 b(Lisp)g(as)i(their)e(e)o(xtension)
f(language.)64 b(The)32 b(\002rst)h(w)o(as)g(Gnu)f(Emacs,)j(the)d
(popular)555 4068 y(Unix)19 b(te)o(xt\255editor)-5 b(.)27
b(Later)19 b(came)g(Autocad,)f(the)h(\002rst)h(lar)o(ge\255scale)d
(commercial)h(product)f(to)555 4173 y(pro)o(vide)k(Lisp)i(as)g(an)g(e)o
(xtension)f(language.)35 b(In)22 b(1991)g(Interleaf)g(released)g(a)h
(ne)n(w)g(v)o(ersion)555 4278 y(of)i(its)h(softw)o(are)e(that)i(not)e
(only)h(had)f(Lisp)h(as)h(an)f(e)o(xtension)f(language,)g(b)n(ut)h(w)o
(as)h(lar)o(gely)555 4382 y(implemented)18 b(in)j(Lisp.)680
4487 y(Lisp)h(is)i(an)f(especially)f(good)f(language)g(for)i(writing)f
(e)o(xtensible)f(programs)g(because)555 4591 y(it)k(is)g(itself)g(an)f
(e)o(xtensible)f(program.)39 b(If)24 b(you)f(write)h(your)f(Lisp)h
(programs)e(so)j(as)g(to)f(pass)555 4696 y(this)18 b(e)o(xtensibility)e
(on)h(to)h(the)f(user)m(,)g(you)g(ef)n(fecti)n(v)o(ely)e(get)j(an)f(e)o
(xtension)f(language)f(for)i(free.)555 4801 y(And)f(the)h(dif)n
(ference)d(between)i(e)o(xtending)e(a)j(Lisp)g(program)e(in)h(Lisp,)i
(and)e(doing)f(the)h(same)555 4905 y(thing)i(in)h(a)g(traditional)f
(language,)f(is)j(lik)o(e)f(the)f(dif)n(ference)f(between)h(meeting)g
(someone)f(in)p eop
%%Page: 6 19
6 18 bop 555 538 a FA(6)879 b Fu(THE)18 b(EXTENSIBLE)f(LANGU)n(A)n(GE)
555 801 y FA(person)k(and)h(con)m(v)o(ersing)e(by)i(letters.)37
b(In)22 b(a)h(program)d(which)i(is)i(made)d(e)o(xtensible)h(simply)555
905 y(by)j(pro)o(viding)e(access)j(to)f(outside)g(programs,)g(the)g
(best)h(we)g(can)f(hope)f(for)h(is)h(tw)o(o)g(black)555
1010 y(box)o(es)31 b(communicating)e(with)k(one)e(another)g(through)f
(some)i(prede\002ned)e(channel.)64 b(In)555 1114 y(Lisp,)22
b(e)o(xtensions)e(can)h(ha)n(v)o(e)g(direct)h(access)g(to)f(the)h
(entire)f(underlying)e(program.)31 b(This)22 b(is)555
1219 y(not)f(to)h(say)g(that)g(you)f(ha)n(v)o(e)g(to)g(gi)n(v)o(e)g
(users)h(access)g(to)g(e)n(v)o(ery)f(part)g(of)g(your)g
(program\227just)555 1324 y(that)f(you)g(no)n(w)f(ha)n(v)o(e)h(a)g
Ft(c)o(hoice)g FA(about)f(whether)g(to)h(gi)n(v)o(e)g(them)g(access)g
(or)g(not.)680 1428 y(When)f(this)h(de)o(gree)f(of)g(access)i(is)f
(combined)e(with)i(an)g(interacti)n(v)o(e)e(en)m(vironment,)e(you)555
1533 y(ha)n(v)o(e)j(e)o(xtensibility)f(at)i(its)h(best.)29
b(An)o(y)19 b(program)e(that)i(you)g(might)g(use)g(as)i(a)e(foundation)
e(for)555 1638 y(e)o(xtensions)d(of)h(your)e(o)n(wn)i(is)h(lik)o(ely)f
(to)g(be)g(f)o(airly)f(big\227too)g(big,)h(probably)-5
b(,)14 b(for)g(you)g(to)h(ha)n(v)o(e)555 1742 y(a)j(complete)f(mental)h
(picture)f(of)h(it.)29 b(What)18 b(happens)f(when)g(you')l(re)g(unsure)
f(of)i(something?)555 1847 y(If)j(the)g(original)f(program)f(is)k
(written)e(in)g(Lisp,)g(you)g(can)g(probe)f(it)i(interacti)n(v)o(ely:)
29 b(you)21 b(can)555 1951 y(inspect)c(its)h(data)f(structures;)h(you)e
(can)h(call)g(its)h(functions;)f(you)f(may)h(e)n(v)o(en)f(be)h(able)g
(to)g(look)555 2056 y(at)27 b(the)g(original)e(source)h(code.)47
b(This)27 b(kind)f(of)g(feedback)f(allo)n(ws)i(you)e(to)i(program)d
(with)555 2161 y(a)k(high)f(de)o(gree)f(of)h(con\002dence\227to)e
(write)j(more)e(ambitious)h(e)o(xtensions,)h(and)f(to)g(write)555
2265 y(them)18 b(f)o(aster)-5 b(.)29 b(An)19 b(interacti)n(v)o(e)e(en)m
(vironment)e(al)o(w)o(ays)k(mak)o(es)f(programming)d(easier)m(,)j(b)n
(ut)h(it)555 2370 y(is)i(no)n(where)e(more)g(v)n(aluable)g(than)h(when)
f(one)h(is)h(writing)f(e)o(xtensions.)680 2474 y(An)29
b(e)o(xtensible)f(program)f(is)j(a)f(double\255edged)d(sw)o(ord,)31
b(b)n(ut)e(recent)f(e)o(xperience)f(has)555 2579 y(sho)n(wn)15
b(that)h(users)g(prefer)f(a)h(double\255edged)c(sw)o(ord)k(to)g(a)g
(blunt)f(one.)27 b(Extensible)15 b(programs)555 2684
y(seem)20 b(to)h(pre)n(v)n(ail,)e(whate)n(v)o(er)f(their)i(inherent)f
(dangers.)555 2936 y Fw(1.4)99 b(Extending)26 b(Lisp)555
3127 y FA(There)19 b(are)h(tw)o(o)g(w)o(ays)g(to)g(add)f(ne)n(w)h
(operators)e(to)i(Lisp:)30 b(functions)18 b(and)i(macros.)28
b(In)20 b(Lisp,)555 3232 y(functions)g(you)g(de\002ne)g(ha)n(v)o(e)g
(the)h(same)h(status)f(as)h(the)f(b)n(uilt\255in)f(ones.)31
b(If)21 b(you)f(w)o(ant)h(a)h(ne)n(w)555 3336 y(v)n(ariant)h(of)g
Fs(mapcar)p FA(,)f(you)h(can)g(de\002ne)g(one)g(yourself)f(and)h(use)h
(it)g(just)h(as)f(you)e(w)o(ould)h(use)555 3441 y Fs(mapcar)p
FA(.)31 b(F)o(or)21 b(e)o(xample,)g(if)g(you)g(w)o(ant)h(a)g(list)g(of)
f(the)h(v)n(alues)f(returned)f(by)h(some)g(function)555
3545 y(when)e(it)i(is)g(applied)e(to)h(all)g(the)g(inte)o(gers)g(from)e
Fs(1)j FA(to)f Fs(10)p FA(,)f(you)g(could)g(create)h(a)g(ne)n(w)g(list)
h(and)555 3650 y(pass)g(it)g(to)f Fs(mapcar)p FA(:)555
3833 y Fs(\(mapcar)41 b(fn)904 3932 y(\(do*)h(\(\(x)g(1)h(\(1+)f(x\)\))
1165 4032 y(\(result)f(\(list)g(x\))i(\(push)f(x)h(result\)\)\))1078
4131 y(\(\(=)f(x)i(10\))e(\(nreverse)e(result\)\)\)\))555
4319 y FA(b)n(ut)26 b(this)h(approach)e(is)i(both)f(ugly)f(and)h(inef)n
(\002cient.)2100 4289 y Fm(2)2180 4319 y FA(Instead)g(you)g(could)f
(de\002ne)h(a)h(ne)n(w)555 4424 y(mapping)18 b(function)h
Fs(map1-n)f FA(\(see)i(page)g(54\),)f(and)h(then)g(call)g(it)h(as)g
(follo)n(ws:)555 4606 y Fs(\(map1-n)41 b(fn)h(10\))p
555 4678 1074 4 v 645 4733 a Fl(2)675 4757 y Fr(Y)-7
b(ou)24 b(could)i(write)f(this)h(more)e(ele)o(gantly)k(with)d(the)g(ne)
n(w)h(Common)e(Lisp)g(series)i(macros,)g(b)o(ut)f(that)h(only)555
4839 y(pro)o(v)o(es)18 b(the)f(same)h(point,)f(because)i(these)f
(macros)g(are)f(an)h(e)o(xtension)h(to)e(Lisp)g(themselv)o(es.)p
eop
%%Page: 7 20
7 19 bop 555 538 a Ft(1.4)1014 b Fu(EXTENDING)18 b(LISP)1037
b FA(7)680 801 y(De\002ning)21 b(functions)f(is)j(comparati)n(v)o(ely)c
(straightforw)o(ard.)32 b(Macros)22 b(pro)o(vide)e(a)i(more)555
905 y(general,)h(b)n(ut)h(less)h(well\255understood,)c(means)j(of)f
(de\002ning)g(ne)n(w)g(operators.)38 b(Macros)24 b(are)555
1010 y(programs)c(that)h(write)h(programs.)31 b(This)22
b(statement)f(has)h(f)o(ar)n(\255reaching)d(implications,)i(and)555
1114 y(e)o(xploring)d(them)i(is)h(one)e(of)h(the)g(main)g(purposes)f
(of)h(this)h(book.)680 1219 y(The)g(thoughtful)f(use)i(of)f(macros)h
(leads)g(to)g(programs)e(which)h(are)h(marv)o(els)f(of)h(clarity)555
1324 y(and)f(ele)o(gance.)32 b(These)21 b(gems)h(are)f(not)h(to)g(be)f
(had)g(for)g(nothing.)32 b(Ev)o(entually)20 b(macros)h(will)555
1428 y(seem)15 b(the)f(most)h(natural)f(thing)g(in)h(the)f(w)o(orld,)h
(b)n(ut)g(the)o(y)f(can)g(be)h(hard)f(to)g(understand)f(at)i(\002rst.)
555 1533 y(P)o(artly)g(this)g(is)h(because)e(the)o(y)g(are)h(more)f
(general)g(than)g(functions,)h(so)g(there)f(is)i(more)e(to)h(k)o(eep)
555 1638 y(in)23 b(mind)f(when)h(writing)f(them.)38 b(But)23
b(the)g(main)g(reason)f(macros)g(are)h(hard)g(to)g(understand)555
1742 y(is)j(that)g(the)o(y')l(re)d Ft(for)m(eign.)44
b FA(No)25 b(other)f(language)g(has)h(an)o(ything)e(lik)o(e)j(Lisp)f
(macros.)44 b(Thus)555 1847 y(learning)16 b(about)h(macros)g(may)g
(entail)h(unlearning)d(preconceptions)g(inadv)o(ertently)g(pick)o(ed)
555 1951 y(up)27 b(from)f(other)g(languages.)49 b(F)o(oremost)26
b(among)f(these)j(is)g(the)f(notion)f(of)g(a)i(program)d(as)555
2056 y(something)31 b(af)n(\003icted)h(by)g(rigor)g(mortis.)66
b(Why)32 b(should)f(data)h(structures)g(be)h(\003uid)f(and)555
2161 y(changeable,)23 b(b)n(ut)i(programs)d(not?)42 b(In)24
b(Lisp,)h(programs)e Ft(ar)m(e)h FA(data,)i(b)n(ut)e(the)g
(implications)555 2265 y(of)c(this)h(f)o(act)f(tak)o(e)g(a)h(while)f
(to)g(sink)h(in.)680 2370 y(If)e(it)h(tak)o(es)f(some)g(time)h(to)f
(get)h(used)f(to)g(macros,)f(it)i(is)h(well)e(w)o(orth)g(the)g(ef)n
(fort.)28 b(Ev)o(en)18 b(in)555 2474 y(such)j(mundane)e(uses)i(as)h
(iteration,)e(macros)h(can)g(mak)o(e)f(programs)f(signi\002cantly)i
(smaller)555 2579 y(and)g(cleaner)-5 b(.)34 b(Suppose)21
b(a)h(program)e(must)i(iterate)g(o)o(v)o(er)e(some)i(body)f(of)g(code)g
(for)h Fs(x)g FA(from)555 2684 y Fs(a)e FA(to)g Fs(b)p
FA(.)30 b(The)19 b(b)n(uilt\255in)h(Lisp)g Fs(do)g FA(is)h(meant)e(for)
h(more)f(general)g(cases.)30 b(F)o(or)19 b(simple)h(iteration)555
2788 y(it)h(does)f(not)g(yield)g(the)g(most)g(readable)f(code:)555
2971 y Fs(\(do)42 b(\(\(x)h(a)g(\(+)g(1)g(x\)\)\))729
3070 y(\(\(>)g(x)g(b\)\))642 3170 y(\(print)e(x\)\))555
3358 y FA(Instead,)19 b(suppose)h(we)g(could)f(just)i(say:)555
3540 y Fs(\(for)42 b(\(x)h(a)g(b\))642 3640 y(\(print)e(x\)\))555
3828 y FA(Macros)18 b(mak)o(e)g(this)h(possible.)29 b(W)m(ith)18
b(six)h(lines)g(of)f(code)g(\(see)h(page)f(154\))f(we)i(can)f(add)g
Fs(for)555 3932 y FA(to)24 b(the)g(language,)e(just)j(as)f(if)g(it)h
(had)e(been)g(there)h(from)e(the)i(start.)41 b(And)23
b(as)h(later)g(chapters)555 4037 y(will)d(sho)n(w)-5
b(,)19 b(writing)h Fs(for)f FA(is)i(only)f(the)g(be)o(ginning)e(of)i
(what)g(you)f(can)h(do)g(with)g(macros.)680 4141 y(Y)-9
b(ou')l(re)21 b(not)h(limited)h(to)g(e)o(xtending)d(Lisp)j(one)f
(function)f(or)i(macro)e(at)j(a)f(time.)37 b(If)22 b(you)555
4246 y(need)e(to,)g(you)f(can)h(b)n(uild)g(a)g(whole)g(language)f(on)g
(top)h(of)g(Lisp,)g(and)g(write)g(your)f(programs)555
4351 y(in)24 b(that.)40 b(Lisp)24 b(is)g(an)g(e)o(xcellent)f(language)f
(for)h(writing)g(compilers)f(and)i(interpreters,)f(b)n(ut)555
4455 y(it)e(of)n(fers)e(another)g(w)o(ay)h(of)g(de\002ning)e(a)j(ne)n
(w)f(language)e(which)i(is)h(often)e(more)g(ele)o(gant)g(and)555
4560 y(certainly)j(much)h(less)h(w)o(ork:)36 b(to)23
b(de\002ne)g(the)h(ne)n(w)f(language)f(as)i(a)g(modi\002cation)d(of)j
(Lisp.)555 4665 y(Then)k(the)h(parts)h(of)e(Lisp)i(which)e(can)h
(appear)f(unchanged)f(in)i(the)g(ne)n(w)g(language)e(\(e.g.)555
4769 y(arithmetic)h(or)g Fr(I)p FA(/)p Fr(O)p FA(\))h(can)f(be)h(used)f
(as)h(is,)j(and)c(you)f(only)h(ha)n(v)o(e)g(to)h(implement)e(the)i
(parts)555 4874 y(which)21 b(are)h(dif)n(ferent)f(\(e.g.)g(control)f
(structure\).)33 b(A)23 b(language)d(implemented)g(in)i(this)h(w)o(ay)
555 4978 y(is)e(called)f(an)g Ft(embedded)f(langua)o(g)o(e)o(.)p
eop
%%Page: 8 21
8 20 bop 555 538 a FA(8)879 b Fu(THE)18 b(EXTENSIBLE)f(LANGU)n(A)n(GE)
680 801 y FA(Embedded)31 b(languages)i(are)h(a)h(natural)e(outgro)n
(wth)f(of)i(bottom\255up)d(programming.)555 905 y(Common)i(Lisp)h
(includes)f(se)n(v)o(eral)h(already)-5 b(.)69 b(The)33
b(most)h(f)o(amous)g(of)f(them,)k Fr(CLOS)p FA(,)h(is)555
1010 y(discussed)28 b(in)g(the)g(last)h(chapter)-5 b(.)52
b(But)28 b(you)f(can)h(de\002ne)g(embedded)e(languages)g(of)i(your)555
1114 y(o)n(wn,)18 b(too.)28 b(Y)-9 b(ou)18 b(can)h(ha)n(v)o(e)f(the)g
(language)f(which)h(suits)h(your)f(program,)e(e)n(v)o(en)i(if)g(it)i
(ends)e(up)555 1219 y(looking)g(quite)i(dif)n(ferent)f(from)g(Lisp.)555
1472 y Fw(1.5)99 b(Wh)o(y)24 b(Lisp)i(\(or)f(When\))555
1662 y FA(These)14 b(ne)n(w)g(possibilities)h(do)f(not)g(stem)g(from)f
(a)i(single)f(magic)g(ingredient.)25 b(In)14 b(this)h(respect,)555
1767 y(Lisp)28 b(is)h(lik)o(e)g(an)f(arch.)52 b(Which)28
b(of)g(the)g(wedge\255shaped)e(stones)i(\(v)n(oussoirs\))f(is)i(the)f
(one)555 1872 y(that)21 b(holds)f(up)g(the)h(arch?)31
b(The)20 b(question)g(itself)h(is)h(mistak)o(en;)e(the)o(y)g(all)i(do.)
30 b(Lik)o(e)21 b(an)f(arch,)555 1976 y(Lisp)g(is)h(a)g(collection)e
(of)h(interlocking)e(features.)28 b(W)-7 b(e)21 b(can)f(list)h(some)f
(of)g(these)g(features\227)555 2081 y(dynamic)j(storage)i(allocation)f
(and)g(garbage)f(collection,)i(runtime)f(typing,)g(functions)g(as)555
2185 y(objects,)16 b(a)h(b)n(uilt\255in)e(parser)g(which)h(generates)e
(lists,)k(a)f(compiler)d(which)i(accepts)f(programs)555
2290 y(e)o(xpressed)22 b(as)h(lists,)i(an)e(interacti)n(v)o(e)f(en)m
(vironment,)f(and)h(so)h(on\227b)n(ut)g(the)g(po)n(wer)f(of)g(Lisp)555
2395 y(cannot)j(be)g(traced)g(to)h(an)o(y)f(single)h(one)f(of)g(them.)
46 b(It)26 b(is)g(the)g(combination)e(which)h(mak)o(es)555
2499 y(Lisp)20 b(programming)d(what)j(it)h(is.)680 2604
y(Ov)o(er)j(the)h(past)g(twenty)g(years,)h(the)f(w)o(ay)g(people)f
(program)f(has)i(changed.)42 b(Man)o(y)24 b(of)555 2708
y(these)g(changes\227interacti)n(v)o(e)d(en)m(vironments,)h(dynamic)h
(linking,)g(e)n(v)o(en)g(object\255oriented)555 2813
y(programming\227ha)n(v)o(e)i(been)k(piecemeal)f(attempts)i(to)f(gi)n
(v)o(e)g(other)g(languages)f(some)h(of)555 2918 y(the)g(\003e)o
(xibility)f(of)g(Lisp.)55 b(The)29 b(metaphor)e(of)h(the)h(arch)f
(suggests)h(ho)n(w)f(well)h(the)o(y)f(ha)n(v)o(e)555
3022 y(succeeded.)680 3127 y(It)22 b(is)i(widely)e(kno)n(wn)f(that)h
(Lisp)h(and)f(F)o(ortran)f(are)i(the)f(tw)o(o)h(oldest)g(languages)e
(still)i(in)555 3232 y(use.)33 b(What)21 b(is)h(perhaps)e(more)h
(signi\002cant)g(is)h(that)f(the)o(y)g(represent)f(opposite)g(poles)h
(in)h(the)555 3336 y(philosophy)c(of)i(language)f(design.)30
b(F)o(ortran)19 b(w)o(as)i(in)m(v)o(ented)e(as)i(a)g(step)g(up)f(from)g
(assembly)555 3441 y(language.)67 b(Lisp)33 b(w)o(as)h(in)m(v)o(ented)d
(as)j(a)g(language)e(for)g(e)o(xpressing)g(algorithms.)67
b(Such)555 3545 y(dif)n(ferent)15 b(intentions)h(yielded)g(v)n(astly)h
(dif)n(ferent)f(languages.)26 b(F)o(ortran)16 b(mak)o(es)h(life)g(easy)
g(for)555 3650 y(the)g(compiler)e(writer;)j(Lisp)f(mak)o(es)f(life)h
(easy)g(for)f(the)h(programmer)-5 b(.)25 b(Most)17 b(programming)555
3755 y(languages)j(since)i(ha)n(v)o(e)f(f)o(allen)g(some)n(where)g
(between)f(the)i(tw)o(o)g(poles.)33 b(F)o(ortran)20 b(and)h(Lisp)555
3859 y(ha)n(v)o(e)h(themselv)o(es)f(mo)o(v)o(ed)g(closer)h(to)g(the)h
(center)-5 b(.)35 b(F)o(ortran)21 b(no)n(w)h(looks)g(more)g(lik)o(e)g
(Algol,)555 3964 y(and)e(Lisp)g(has)g(gi)n(v)o(en)f(up)h(some)g(of)g
(the)g(w)o(asteful)g(habits)h(of)e(its)j(youth.)680 4068
y(The)k(original)g(F)o(ortran)f(and)h(Lisp)h(de\002ned)f(a)h(sort)g(of)
g(battle\002eld.)48 b(On)27 b(one)f(side)i(the)555 4173
y(battle)21 b(cry)g(is)i(\223Ef)n(\002cienc)o(y!)31 b(\(And)21
b(besides,)g(it)h(w)o(ould)f(be)g(too)g(hard)g(to)g(implement.\)\224)32
b(On)555 4278 y(the)23 b(other)f(side,)i(the)f(battle)g(cry)f(is)i
(\223)-7 b(Abstraction!)36 b(\(And)23 b(an)o(yw)o(ay)-5
b(,)21 b(this)j(isn')o(t)e(production)555 4382 y(softw)o(are.\)\224)30
b(As)22 b(the)f(gods)f(determined)f(from)h(af)o(ar)h(the)g(outcomes)e
(of)i(battles)g(among)f(the)555 4487 y(ancient)15 b(Greeks,)h(the)f
(outcome)f(of)i(this)g(battle)f(is)i(being)d(determined)g(by)h(hardw)o
(are.)26 b(Ev)o(ery)555 4591 y(year)m(,)21 b(things)h(look)f(better)h
(for)g(Lisp.)35 b(The)21 b(ar)o(guments)f(against)i(Lisp)g(are)g(no)n
(w)g(starting)f(to)555 4696 y(sound)j(v)o(ery)g(much)g(lik)o(e)i(the)f
(ar)o(guments)e(that)i(assembly)g(language)e(programmers)g(ga)n(v)o(e)
555 4801 y(against)h(high\255le)n(v)o(el)f(languages)h(in)h(the)g
(early)f(1970s.)43 b(The)24 b(question)g(is)i(no)n(w)f(becoming)555
4905 y(not)20 b Ft(Why)g(Lisp?)p FA(,)g(b)n(ut)g Ft(When?)p
eop
%%Page: 9 22
9 21 bop 555 1610 a Fn(2)p 555 1872 2686 3 v 555 2131
a Fx(Functions)555 2568 y FA(Functions)22 b(are)h(the)g(b)n
(uilding\255blocks)e(of)h(Lisp)i(programs.)36 b(The)o(y)22
b(are)h(also)g(the)g(b)n(uilding\255)555 2672 y(blocks)29
b(of)h(Lisp.)59 b(In)29 b(most)h(languages)f(the)h Fs(+)g
FA(operator)e(is)j(something)e(quite)g(dif)n(ferent)555
2777 y(from)17 b(user)n(\255de\002ned)f(functions.)26
b(But)19 b(Lisp)e(has)h(a)g(single)g(model,)f(function)f(application,)g
(to)555 2882 y(describe)f(all)h(the)g(computation)d(done)i(by)g(a)h
(program.)25 b(The)16 b(Lisp)f Fs(+)h FA(operator)e(is)i(a)h(function,)
555 2986 y(just)k(lik)o(e)f(the)g(ones)g(you)g(can)g(de\002ne)f
(yourself.)680 3091 y(In)j(f)o(act,)g(e)o(xcept)g(for)f(a)i(small)g
(number)d(of)i(operators)f(called)h Ft(special)g(forms)p
FA(,)i(the)e(core)555 3195 y(of)h(Lisp)g(is)h(a)f(collection)f(of)h
(Lisp)g(functions.)36 b(What')-5 b(s)23 b(to)h(stop)e(you)h(from)e
(adding)h(to)h(this)555 3300 y(collection?)k(Nothing)17
b(at)h(all:)29 b(if)19 b(you)d(think)i(of)f(something)g(you)g(wish)h
(Lisp)g(could)f(do,)g(you)555 3405 y(can)24 b(write)h(it)h(yourself,)e
(and)g(your)f(ne)n(w)i(function)d(will)k(be)e(treated)g(just)i(lik)o(e)
f(the)f(b)n(uilt\255in)555 3509 y(ones.)680 3614 y(This)e(f)o(act)h
(has)g(important)e(consequences)f(for)i(the)h(programmer)-5
b(.)34 b(It)22 b(means)h(that)f(an)o(y)555 3718 y(ne)n(w)28
b(function)f(could)g(be)h(considered)f(either)g(as)i(an)g(addition)e
(to)h(Lisp,)i(or)e(as)h(part)f(of)g(a)555 3823 y(speci\002c)21
b(application.)30 b(T)-7 b(ypically)i(,)19 b(an)i(e)o(xperienced)d
(Lisp)j(programmer)d(will)k(write)f(some)555 3928 y(of)k(each,)g
(adjusting)f(the)h(boundary)d(between)i(language)f(and)h(application)g
(until)g(the)h(tw)o(o)555 4032 y(\002t)h(one)e(another)g(perfectly)-5
b(.)42 b(This)26 b(book)d(is)j(about)e(ho)n(w)h(to)g(achie)n(v)o(e)f(a)
i(good)d(\002t)j(between)555 4137 y(language)k(and)h(application.)63
b(Since)31 b(e)n(v)o(erything)e(we)k(do)e(to)n(w)o(ard)g(this)h(end)f
(ultimately)555 4242 y(depends)19 b(on)h(functions,)e(functions)h(are)h
(the)g(natural)g(place)f(to)i(be)o(gin.)555 4494 y Fw(2.1)99
b(Functions)26 b(as)e(Data)555 4685 y FA(T)-7 b(w)o(o)28
b(things)g(mak)o(e)g(Lisp)g(functions)e(dif)n(ferent.)51
b(One,)30 b(mentioned)c(abo)o(v)o(e,)i(is)h(that)f(Lisp)555
4789 y(itself)14 b(is)h(a)f(collection)f(of)g(functions.)26
b(This)13 b(means)h(that)f(we)h(can)g(add)f(to)h(Lisp)g(ne)n(w)f
(operators)555 4894 y(of)k(our)g(o)n(wn.)28 b(Another)17
b(important)f(thing)h(to)h(kno)n(w)e(about)h(functions)f(is)j(that)f
(the)o(y)f(are)g(Lisp)555 4999 y(objects.)1877 5229 y(9)p
eop
%%Page: 10 23
10 22 bop 555 538 a FA(10)1091 b Fu(FUNCTIONS)680 801
y FA(Lisp)34 b(of)n(fers)g(most)h(of)f(the)h(data)g(types)f(one)g
(\002nds)h(in)g(other)f(languages.)71 b(W)-7 b(e)36 b(get)555
905 y(inte)o(gers)27 b(and)h(\003oating\255point)d(numbers,)j(strings,)
i(arrays,)f(structures,)g(and)f(so)g(on.)52 b(But)555
1010 y(Lisp)31 b(supports)f(one)g(data)g(type)h(which)f(may)g(at)h
(\002rst)h(seem)f(surprising:)49 b(the)31 b(function.)555
1114 y(Nearly)22 b(all)i(programming)c(languages)h(pro)o(vide)g(some)i
(form)f(of)g(function)g(or)g(procedure.)555 1219 y(What)e(does)f(it)i
(mean)e(to)h(say)f(that)h(Lisp)g(pro)o(vides)e(them)h(as)h(a)g(data)g
(type?)28 b(It)20 b(means)g(that)f(in)555 1324 y(Lisp)k(we)h(can)f(do)g
(with)h(functions)e(all)h(the)h(things)f(we)g(e)o(xpect)g(to)g(do)g
(with)h(more)e(f)o(amiliar)555 1428 y(data)16 b(types,)g(lik)o(e)g
(inte)o(gers:)27 b(create)15 b(ne)n(w)h(ones)f(at)i(runtime,)e(store)h
(them)f(in)h(v)n(ariables)f(and)g(in)555 1533 y(structures,)k(pass)i
(them)f(as)h(ar)o(guments)d(to)i(other)g(functions,)e(and)i(return)f
(them)h(as)g(results.)680 1638 y(The)30 b(ability)h(to)h(create)f(and)f
(return)g(functions)g(at)i(runtime)e(is)i(particularly)d(useful.)555
1742 y(This)20 b(might)f(sound)g(at)h(\002rst)h(lik)o(e)f(a)g(dubious)e
(sort)i(of)g(adv)n(antage,)e(lik)o(e)i(the)g(self\255modifying)555
1847 y(machine)k(language)f(programs)f(one)j(can)f(run)g(on)g(some)h
(computers.)41 b(But)25 b(creating)f(ne)n(w)555 1951
y(functions)16 b(at)h(runtime)f(turns)h(out)f(to)h(be)g(a)h(routinely)d
(used)i(Lisp)g(programming)c(technique.)555 2204 y Fw(2.2)99
b(De\002ning)26 b(Functions)555 2394 y FA(Most)18 b(people)e(\002rst)i
(learn)e(ho)n(w)h(to)h(mak)o(e)e(functions)g(with)i Fs(defun)p
FA(.)26 b(The)17 b(follo)n(wing)f(e)o(xpres\255)555 2499
y(sion)k(de\002nes)g(a)h(function)d(called)i Fs(double)e
FA(which)i(returns)f(twice)i(its)g(ar)o(gument.)555 2679
y Fs(>)43 b(\(defun)e(double)g(\(x\))i(\(*)f(x)i(2\)\))555
2778 y(DOUBLE)555 2958 y FA(Ha)n(ving)33 b(fed)h(this)h(to)f(Lisp,)k
(we)c(can)g(call)h Fs(double)d FA(in)i(other)g(functions,)i(or)d(from)h
(the)555 3058 y(tople)n(v)o(el:)555 3222 y Fs(>)43 b(\(double)e(1\))555
3321 y(2)555 3490 y FA(A)25 b(\002le)h(of)e(Lisp)i(code)e(usually)g
(consists)h(mainly)f(of)h(such)g Fs(defun)p FA(s,)f(and)g(so)i
(resembles)e(a)555 3595 y(\002le)f(of)f(procedure)e(de\002nitions)i(in)
h(a)g(language)e(lik)o(e)h(C)i(or)e(P)o(ascal.)37 b(But)23
b(something)e(quite)555 3699 y(dif)n(ferent)26 b(is)j(going)e(on.)51
b(Those)28 b Fs(defun)p FA(s)e(are)i(not)g(just)g(procedure)e
(de\002nitions,)i(the)o(y')l(re)555 3804 y(Lisp)h(calls.)56
b(This)30 b(distinction)e(will)i(become)d(clearer)i(when)f(we)h(see)h
(what')-5 b(s)29 b(going)f(on)555 3909 y(underneath)18
b Fs(defun)p FA(.)680 4013 y(Functions)f(are)h(objects)h(in)f(their)g
(o)n(wn)g(right.)28 b(What)19 b Fs(defun)e FA(really)h(does)g(is)h(b)n
(uild)f(one,)555 4118 y(and)29 b(store)g(it)i(under)d(the)h(name)g(gi)n
(v)o(en)f(as)i(the)g(\002rst)g(ar)o(gument.)55 b(So)30
b(as)g(well)g(as)g(calling)555 4222 y Fs(double)p FA(,)20
b(we)j(can)f(get)g(hold)f(of)h(the)g(function)e(which)i(implements)f
(it.)36 b(The)21 b(usual)h(w)o(ay)g(to)555 4327 y(do)f(so)g(is)i(by)d
(using)h(the)g Fs(#')g FA(\(sharp\255quote\))d(operator)-5
b(.)31 b(This)21 b(operator)f(can)h(be)g(understood)555
4432 y(as)c(mapping)d(names)h(to)h(actual)g(function)e(objects.)27
b(By)17 b(af)n(\002xing)d(it)j(to)f(the)g(name)f(of)g
Fs(double)555 4612 y(>)43 b(#'double)555 4711 y(#<Interpreted-Fu)o(nct)
o(io)o(n)37 b(C66ACE>)555 4896 y FA(we)d(get)h(the)f(actual)g(object)f
(created)h(by)f(the)h(de\002nition)f(abo)o(v)o(e.)70
b(Though)32 b(its)j(printed)555 5001 y(representation)15
b(will)i(v)n(ary)f(from)g(implementation)f(to)i(implementation,)e(a)i
(Common)e(Lisp)p eop
%%Page: 11 24
11 23 bop 555 538 a Ft(2.2)939 b Fu(DEFINING)19 b(FUNCTIONS)922
b FA(11)555 801 y(function)24 b(is)j(a)f(\002rst\255class)h(object,)g
(with)f(all)g(the)g(same)g(rights)g(as)g(more)f(f)o(amiliar)h(objects)
555 905 y(lik)o(e)c(numbers)f(and)g(strings.)35 b(So)22
b(we)g(can)g(pass)g(this)h(function)d(as)j(an)f(ar)o(gument,)d(return)i
(it,)555 1010 y(store)f(it)h(in)f(a)h(data)f(structure,)f(and)h(so)g
(on:)555 1193 y Fs(>)43 b(\(eq)g(#'double)d(\(car)i(\(list)f
(#'double\)\)\))555 1292 y(T)680 1480 y FA(W)-7 b(e)28
b(don')o(t)e(e)n(v)o(en)h(need)g Fs(defun)f FA(to)h(mak)o(e)h
(functions.)49 b(Lik)o(e)28 b(most)g(Lisp)f(objects,)i(we)555
1584 y(can)24 b(refer)f(to)i(them)e(literally)-5 b(.)41
b(When)24 b(we)g(w)o(ant)h(to)f(refer)f(to)h(an)h(inte)o(ger)m(,)e(we)i
(just)f(use)h(the)555 1689 y(inte)o(ger)e(itself.)41
b(T)-7 b(o)24 b(represent)f(a)h(string,)h(we)f(use)g(a)h(series)f(of)g
(characters)f(surrounded)e(by)555 1794 y(double\255quotes.)j(T)-7
b(o)15 b(represent)e(a)h(function,)g(we)g(use)h(what')-5
b(s)14 b(called)h(a)f Ft(lambda\255e)n(xpr)m(ession.)555
1898 y FA(A)25 b(lambda\255e)o(xpression)20 b(is)25 b(a)g(list)g(with)f
(three)g(parts:)37 b(the)24 b(symbol)g Fs(lambda)p FA(,)f(a)h
(parameter)555 2003 y(list,)g(and)e(a)h(body)f(of)g(zero)g(or)h(more)f
(e)o(xpressions.)35 b(This)23 b(lambda\255e)o(xpression)c(refers)j(to)h
(a)555 2107 y(function)18 b(equi)n(v)n(alent)h(to)h Fs(double)p
FA(:)555 2290 y Fs(\(lambda)41 b(\(x\))h(\(*)h(x)g(2\)\))555
2478 y FA(It)20 b(describes)g(a)h(function)d(which)i(tak)o(es)g(one)g
(ar)o(gument)e Ft(x)p FA(,)i(and)g(returns)f Ft(2x)p
FA(.)680 2582 y(A)29 b(lambda\255e)o(xpression)c(can)k(also)g(be)f
(considered)f(as)j(the)f(name)f(of)g(a)i(function.)53
b(If)555 2687 y Fs(double)17 b FA(is)j(a)f(proper)e(name,)h(lik)o(e)h
(\223Michelangelo,)-6 b(\224)17 b(then)i Fs(\(lambda)40
b(\(x\))j(\(*)f(x)h(2\)\))19 b FA(is)555 2792 y(a)d(de\002nite)e
(description,)h(lik)o(e)g(\223the)g(man)g(who)g(painted)f(the)h
(ceiling)g(of)g(the)g(Sistine)h(Chapel.)-6 b(\224)555
2896 y(By)25 b(putting)f(a)h(sharp\255quote)d(before)h(a)i(lambda\255e)
o(xpression,)e(we)i(get)f(the)h(corresponding)555 3001
y(function:)555 3183 y Fs(>)43 b(#'\(lambda)d(\(x\))i(\(*)h(x)g(2\)\))
555 3283 y(#<Interpreted-Fu)o(nct)o(io)o(n)37 b(C674CE>)555
3471 y FA(This)20 b(function)f(beha)n(v)o(es)g(e)o(xactly)g(lik)o(e)i
Fs(double)p FA(,)d(b)n(ut)i(the)g(tw)o(o)h(are)f(distinct)g(objects.)
680 3575 y(In)31 b(a)h(function)f(call,)k(the)c(name)h(of)f(the)h
(function)e(appears)h(\002rst,)36 b(follo)n(wed)30 b(by)i(the)555
3680 y(ar)o(guments:)555 3863 y Fs(>)43 b(\(double)e(3\))555
3962 y(6)555 4150 y FA(Since)23 b(lambda\255e)o(xpressions)c(are)j
(also)h(names)g(of)f(functions,)f(the)o(y)h(can)h(also)f(appear)g
(\002rst)555 4254 y(in)e(function)f(calls:)555 4437 y
Fs(>)43 b(\(\(lambda)d(\(x\))j(\(*)g(x)g(2\)\))f(3\))555
4537 y(6)680 4724 y FA(In)15 b(Common)f(Lisp,)i(we)g(can)f(ha)n(v)o(e)g
(a)g(function)f(named)g Fs(double)g FA(and)h(a)g(v)n(ariable)g(named)
555 4829 y Fs(double)j FA(at)j(the)f(same)h(time.)p eop
%%Page: 12 25
12 24 bop 555 538 a FA(12)1091 b Fu(FUNCTIONS)555 801
y Fs(>)43 b(\(setq)f(double)f(2\))555 900 y(2)555 1000
y(>)i(\(double)e(double\))555 1100 y(4)555 1284 y FA(When)21
b(a)g(name)g(occurs)f(\002rst)i(in)f(a)h(function)d(call,)j(or)f(is)h
(preceded)d(by)i(a)g(sharp\255quote,)e(it)j(is)555 1389
y(tak)o(en)e(to)g(refer)g(to)g(a)g(function.)28 b(Otherwise)20
b(it)h(is)g(treated)f(as)h(a)f(v)n(ariable)f(name.)680
1493 y(It)k(is)h(therefore)e(said)h(that)g(Common)f(Lisp)i(has)f
(distinct)g Ft(name\255spaces)f FA(for)g(v)n(ariables)555
1598 y(and)f(functions.)32 b(W)-7 b(e)23 b(can)e(ha)n(v)o(e)g(a)i(v)n
(ariable)d(called)i Fs(foo)f FA(and)g(a)h(function)e(called)h
Fs(foo)p FA(,)g(and)555 1702 y(the)o(y)f(need)f(not)h(be)h(identical.)
29 b(This)20 b(situation)g(can)g(be)g(confusing,)f(and)g(leads)i(to)f
(a)h(certain)555 1807 y(amount)g(of)h(ugliness)g(in)h(code,)f(b)n(ut)h
(it)g(is)g(something)e(that)i(Common)e(Lisp)h(programmers)555
1912 y(ha)n(v)o(e)e(to)g(li)n(v)o(e)g(with.)680 2016
y(If)d(necessary)-5 b(,)17 b(Common)g(Lisp)h(pro)o(vides)e(tw)o(o)j
(functions)d(which)i(map)f(symbols)g(to)i(the)555 2121
y(v)n(alues,)31 b(or)e(functions,)g(that)h(the)o(y)e(represent.)55
b(The)29 b(function)e Fs(symbol-value)e FA(tak)o(es)k(a)555
2225 y(symbol)19 b(and)h(returns)f(the)h(v)n(alue)g(of)g(the)g
(corresponding)d(special)j(v)n(ariable:)555 2405 y Fs(>)43
b(\(symbol-value)38 b('double\))555 2504 y(2)555 2689
y FA(while)20 b Fs(symbol-function)15 b FA(does)20 b(the)g(same)g(for)g
(a)g(globally)f(de\002ned)h(function:)555 2868 y Fs(>)43
b(\(symbol-function)37 b('double\))555 2968 y(#<Interpreted-Fu)o(nct)o
(io)o(n)g(C66ACE>)555 3152 y FA(Note)f(that,)j(since)d(functions)f(are)
g(ordinary)f(data)i(objects,)j(a)d(v)n(ariable)f(could)g(ha)n(v)o(e)g
(a)555 3257 y(function)18 b(as)j(its)h(v)n(alue:)555
3436 y Fs(>)43 b(\(setq)f(x)h(#'append\))555 3536 y(#<Compiled-Funct)o
(ion)37 b(46B4BE>)555 3636 y(>)43 b(\(eq)g(\(symbol-value)38
b('x\))k(\(symbol-function)37 b('append\)\))555 3735
y(T)680 3920 y FA(Beneath)19 b(the)h(surf)o(ace,)g Fs(defun)e
FA(is)j(setting)f(the)g Fs(symbol-function)15 b FA(of)k(its)j(\002rst)e
(ar)o(gu\255)555 4024 y(ment)e(to)h(a)g(function)d(constructed)h(from)h
(the)g(remaining)f(ar)o(guments.)26 b(The)18 b(follo)n(wing)f(tw)o(o)
555 4129 y(e)o(xpressions)i(do)h(approximately)d(the)j(same)h(thing:)
555 4308 y Fs(\(defun)41 b(double)g(\(x\))i(\(*)f(x)h(2\)\))555
4507 y(\(setf)f(\(symbol-functio)o(n)37 b('double\))817
4607 y(#'\(lambda)i(\(x\))k(\(*)f(x)i(2\)\)\))555 4791
y FA(So)34 b Fs(defun)e FA(has)i(the)f(same)h(ef)n(fect)f(as)h
(procedure)d(de\002nition)i(in)h(other)e(languages\227to)555
4896 y(associate)23 b(a)g(name)f(with)h(a)g(piece)g(of)f(code.)36
b(But)23 b(the)g(underlying)d(mechanism)i(is)h(not)g(the)555
5001 y(same.)46 b(W)-7 b(e)27 b(don')o(t)d(need)h Fs(defun)f
FA(to)i(mak)o(e)g(functions,)f(and)g(functions)f(don')o(t)h(ha)n(v)o(e)
g(to)h(be)p eop
%%Page: 13 26
13 25 bop 555 538 a Ft(2.3)872 b Fu(FUNCTION)n(AL)18
b(ARGUMENTS)855 b FA(13)555 801 y(stored)24 b(a)o(w)o(ay)h(as)g(the)g
(v)n(alue)f(of)h(some)g(symbol.)42 b(Underlying)22 b
Fs(defun)p FA(,)j(which)f(resembles)555 905 y(procedure)12
b(de\002nition)h(in)h(an)o(y)g(other)f(language,)h(is)h(a)g(more)e
(general)h(mechanism:)25 b(b)n(uilding)555 1010 y(a)32
b(function)d(and)i(associating)g(it)h(with)f(a)h(certain)f(name)g(are)g
(tw)o(o)h(separate)e(operations.)555 1114 y(When)g(we)h(don')o(t)e
(need)g(the)i(full)f(generality)f(of)h(Lisp')-5 b(s)31
b(notion)e(of)h(a)h(function,)g Fs(defun)555 1219 y FA(mak)o(es)20
b(function)f(de\002nition)g(as)h(simple)h(as)g(in)f(more)f(restricti)n
(v)o(e)h(languages.)555 1472 y Fw(2.3)99 b(Functional)26
b(Ar)o(guments)555 1662 y FA(Ha)n(ving)i(functions)g(as)h(data)g
(objects)g(means,)h(among)e(other)g(things,)i(that)f(we)g(can)g(pass)
555 1767 y(them)17 b(as)g(ar)o(guments)e(to)i(other)f(functions.)27
b(This)17 b(possibility)g(is)g(partly)g(responsible)e(for)i(the)555
1872 y(importance)h(of)i(bottom\255up)e(programming)f(in)j(Lisp.)680
1976 y(A)28 b(language)d(which)i(allo)n(ws)h(functions)e(as)i(data)g
(objects)f(must)g(also)h(pro)o(vide)e(some)555 2081 y(w)o(ay)e(of)g
(calling)g(them.)41 b(In)24 b(Lisp,)i(this)e(function)f(is)i
Fs(apply)p FA(.)40 b(Generally)-5 b(,)24 b(we)g(call)h
Fs(apply)555 2185 y FA(with)19 b(tw)o(o)g(ar)o(guments:)26
b(a)19 b(function,)e(and)h(a)h(list)h(of)e(ar)o(guments)e(for)i(it.)30
b(The)18 b(follo)n(wing)f(four)555 2290 y(e)o(xpressions)i(all)i(ha)n
(v)o(e)e(the)h(same)h(ef)n(fect:)555 2473 y Fs(\(+)43
b(1)g(2\))555 2672 y(\(apply)e(#'+)h('\(1)h(2\)\))555
2871 y(\(apply)e(\(symbol-function)c('+\))42 b('\(1)h(2\)\))555
3070 y(\(apply)e(#'\(lambda)f(\(x)j(y\))f(\(+)h(x)g(y\)\))g('\(1)f
(2\)\))555 3258 y FA(In)29 b(Common)f(Lisp,)k Fs(apply)27
b FA(can)i(tak)o(e)h(an)o(y)e(number)g(of)h(ar)o(guments,)g(and)g(the)g
(function)555 3363 y(gi)n(v)o(en)c(\002rst)h(will)h(be)f(applied)f(to)h
(the)g(list)h(made)e(by)h(consing)f(the)h(rest)g(of)g(the)g(ar)o
(guments)555 3467 y(onto)19 b(the)i(list)g(gi)n(v)o(en)e(last.)30
b(So)20 b(the)g(e)o(xpression)555 3650 y Fs(\(apply)41
b(#'+)h(1)i('\(2\)\))555 3838 y FA(is)24 b(equi)n(v)n(alent)d(to)h(the)
h(preceding)e(four)-5 b(.)36 b(If)22 b(it)i(is)f(incon)m(v)o(enient)d
(to)j(gi)n(v)o(e)f(the)g(ar)o(guments)f(as)555 3942 y(a)i(list,)i(we)e
(can)g(use)g Fs(funcall)p FA(,)e(which)h(dif)n(fers)g(from)g
Fs(apply)g FA(only)g(in)h(this)g(respect.)37 b(This)555
4047 y(e)o(xpression)555 4229 y Fs(\(funcall)j(#'+)j(1)g(2\))555
4417 y FA(has)20 b(the)h(same)f(ef)n(fect)g(as)h(those)f(abo)o(v)o(e.)
680 4522 y(Man)o(y)c(b)n(uilt\255in)g(Common)g(Lisp)h(functions)f(tak)o
(e)h(functional)e(ar)o(guments.)26 b(Among)16 b(the)555
4626 y(most)k(frequently)e(used)i(are)g(the)g(mapping)f(functions.)27
b(F)o(or)20 b(e)o(xample,)f Fs(mapcar)f FA(tak)o(es)i(tw)o(o)555
4731 y(or)k(more)g(ar)o(guments,)g(a)h(function)e(and)h(one)h(or)f
(more)g(lists)i(\(one)e(for)g(each)h(parameter)e(of)555
4836 y(the)d(function\),)e(and)i(applies)g(the)g(function)e(successi)n
(v)o(ely)i(to)g(elements)g(of)g(each)g(list:)p eop
%%Page: 14 27
14 26 bop 555 538 a FA(14)1091 b Fu(FUNCTIONS)555 801
y Fs(>)43 b(\(mapcar)e(#'\(lambda)f(\(x\))i(\(+)h(x)g(10\)\))991
900 y('\(1)f(2)h(3\)\))555 1000 y(\(11)f(12)h(13\))555
1100 y(>)g(\(mapcar)e(#'+)991 1199 y('\(1)h(2)h(3\))991
1299 y('\(10)f(100)g(1000\)\))555 1398 y(\(11)g(102)h(1003\))555
1586 y FA(Lisp)22 b(programs)f(frequently)f(w)o(ant)i(to)h(do)f
(something)f(to)h(each)g(element)g(of)g(a)g(list)i(and)e(get)555
1691 y(back)f(a)h(list)g(of)f(results.)34 b(The)21 b(\002rst)h(e)o
(xample)e(abo)o(v)o(e)g(illustrates)i(the)g(con)m(v)o(entional)c(w)o
(ay)j(to)555 1795 y(do)f(this:)31 b(mak)o(e)20 b(a)h(function)e(which)h
(does)g(what)g(you)g(w)o(ant)h(done,)e(and)h(mapcar)f(it)i(o)o(v)o(er)f
(the)555 1900 y(list.)680 2004 y(Already)j(we)h(see)h(ho)n(w)f(con)m(v)
o(enient)d(it)k(is)g(to)f(be)h(able)f(to)g(treat)g(functions)f(as)i
(data.)41 b(In)555 2109 y(man)o(y)13 b(languages,)h(e)n(v)o(en)g(if)h
(we)g(could)e(pass)j(a)f(function)d(as)k(an)e(ar)o(gument)e(to)j
(something)e(lik)o(e)555 2214 y Fs(mapcar)p FA(,)h(it)h(w)o(ould)f
(still)i(ha)n(v)o(e)e(to)g(be)h(a)g(function)e(de\002ned)g(in)i(some)g
(source)f(\002le)h(beforehand.)555 2318 y(If)i(just)g(one)g(piece)g(of)
f(code)h(w)o(anted)f(to)h(add)g(10)f(to)i(each)e(element)h(of)g(a)g
(list,)h(we)g(w)o(ould)e(ha)n(v)o(e)555 2423 y(to)25
b(de\002ne)g(a)g(function,)g(called)f Fs(plus)p 1665
2423 27 4 v 30 w(ten)h FA(or)f(some)h(such,)h(just)g(for)e(this)i(one)e
(use.)44 b(W)m(ith)555 2528 y(lambda\255e)o(xpressions,)17
b(we)j(can)g(refer)g(to)g(functions)f(directly)-5 b(.)680
2632 y(One)32 b(of)h(the)g(big)f(dif)n(ferences)f(between)h(Common)g
(Lisp)h(and)f(the)h(dialects)g(which)555 2737 y(preceded)25
b(it)i(are)f(the)h(lar)o(ge)e(number)g(of)h(b)n(uilt\255in)g(functions)
f(that)i(tak)o(e)g(functional)d(ar)o(gu\255)555 2841
y(ments.)37 b(T)-7 b(w)o(o)24 b(of)e(the)h(most)g(commonly)e(used,)i
(after)g(the)g(ubiquitous)e Fs(mapcar)p FA(,)h(are)h
Fs(sort)555 2946 y FA(and)e Fs(remove-if)p FA(.)29 b(The)20
b(former)g(is)i(a)g(general\255purpose)17 b(sorting)k(function.)30
b(It)21 b(tak)o(es)h(a)f(list)555 3051 y(and)i(a)i(predicate,)e(and)g
(returns)g(a)i(list)g(sorted)e(by)h(passing)f(each)h(pair)f(of)h
(elements)f(to)i(the)555 3155 y(predicate.)555 3338 y
Fs(>)43 b(\(sort)f('\(1)g(4)h(2)g(5)h(6)f(7)g(3\))g(#'<\))555
3437 y(\(1)g(2)g(3)g(4)g(5)g(6)h(7\))555 3625 y FA(T)-7
b(o)19 b(remember)e(ho)n(w)h Fs(sort)g FA(w)o(orks,)g(it)h(helps)g(to)g
(remember)e(that)h(if)h(you)f(sort)h(a)g(list)h(with)f(no)555
3730 y(duplicates)g(by)h Fs(<)p FA(,)g(and)g(then)g(apply)f
Fs(<)h FA(to)h(the)f(resulting)f(list,)i(it)g(will)g(return)e(true.)680
3834 y(If)k Fs(remove-if)d FA(weren')o(t)h(included)h(in)h(Common)f
(Lisp,)i(it)g(might)e(be)h(the)h(\002rst)g(utility)555
3939 y(you)c(w)o(ould)g(write.)30 b(It)21 b(tak)o(es)g(a)g(function)e
(and)h(a)h(list,)g(and)f(returns)g(all)h(the)g(elements)f(of)h(the)555
4043 y(list)g(for)f(which)g(the)g(function)e(returns)h(f)o(alse.)555
4226 y Fs(>)43 b(\(remove-if)d(#'evenp)g('\(1)j(2)g(3)g(4)g(5)g(6)h
(7\)\))555 4326 y(\(1)f(3)g(5)g(7\))680 4513 y FA(As)34
b(an)g(e)o(xample)f(of)g(a)i(function)d(which)h(tak)o(es)i(functional)d
(ar)o(guments,)j(here)e(is)i(a)555 4618 y(de\002nition)19
b(of)h(a)h(limited)f(v)o(ersion)f(of)g Fs(remove-if)p
FA(:)p eop
%%Page: 15 28
15 27 bop 555 538 a Ft(2.4)860 b Fu(FUNCTIONS)19 b(AS)g(PR)n(OPER)l
(TIES)841 b FA(15)555 801 y Fs(\(defun)41 b(our-remove-if)d(\(fn)43
b(lst\))642 900 y(\(if)g(\(null)e(lst\))817 1000 y(nil)817
1100 y(\(if)h(\(funcall)e(fn)j(\(car)f(lst\)\))991 1199
y(\(our-remove-if)c(fn)k(\(cdr)g(lst\)\))991 1299 y(\(cons)f(\(car)h
(lst\))g(\(our-remove-if)c(fn)43 b(\(cdr)f(lst\)\)\)\)\)\))555
1486 y FA(Note)24 b(that)g(within)g(this)h(de\002nition)e
Fs(fn)g FA(is)i(not)f(sharp\255quoted.)38 b(Since)24
b(functions)f(are)h(data)555 1591 y(objects,)14 b(a)g(v)n(ariable)g
(can)g(ha)n(v)o(e)g(a)g(functio)o(n)f(as)h(its)g(re)o(g)o(ular)f(v)n(a)
o(lue.)21 b(That')-5 b(s)14 b(what')-5 b(s)14 b(happening)555
1696 y(here.)26 b(Sharp\255quote)13 b(is)g(only)g(for)g(referring)f(to)
h(the)g(fun)o(ction)f(nam)o(ed)h(by)f(a)h(symbo)o(l\227usu)o(ally)555
1800 y(one)20 b(globally)f(de\002ned)g(as)i(such)f(with)g
Fs(defun)p FA(.)680 1905 y(As)e(Chapter)f(4)g(will)i(sho)n(w)-5
b(,)17 b(writing)g(ne)n(w)g(utilities)h(which)f(tak)o(e)h(functional)e
(ar)o(guments)555 2009 y(is)22 b(an)g(important)e(element)g(of)h
(bottom\255up)e(programming.)30 b(Common)20 b(Lisp)h(has)h(so)g(man)o
(y)555 2114 y(utilities)28 b(b)n(uilt\255in)f(that)g(the)g(one)g(you)f
(need)h(may)g(e)o(xist)g(already)-5 b(.)49 b(But)28 b(whether)e(you)g
(use)555 2219 y(b)n(uilt\255ins)21 b(lik)o(e)i Fs(sort)p
FA(,)d(or)i(write)g(your)e(o)n(wn)i(utilities,)g(the)g(principle)f(is)h
(the)g(same.)34 b(Instead)555 2323 y(of)20 b(wiring)f(in)i
(functionality)-5 b(,)17 b(pass)k(a)g(functional)d(ar)o(gument.)555
2576 y Fw(2.4)99 b(Functions)26 b(as)e(Pr)n(operties)555
2767 y FA(The)15 b(f)o(act)h(that)g(functions)e(are)h(Lisp)h(objects)f
(also)h(allo)n(ws)g(us)g(to)f(write)h(programs)e(which)h(can)555
2871 y(be)h(e)o(xtended)d(to)j(deal)f(with)h(ne)n(w)g(cases)g(on)f(the)
h(\003y)-5 b(.)27 b(Suppose)15 b(we)h(w)o(ant)g(to)f(write)h(a)g
(function)555 2976 y(which)23 b(tak)o(es)h(a)h(type)e(of)h(animal)f
(and)g(beha)n(v)o(es)g(appropriately)-5 b(.)37 b(In)24
b(most)f(languages,)h(the)555 3080 y(w)o(ay)c(to)g(do)f(this)h(w)o
(ould)g(be)f(with)h(a)g Fs(case)f FA(statement,)g(and)h(we)g(can)f(do)h
(it)g(this)h(w)o(ay)e(in)h(Lisp)555 3185 y(as)h(well:)555
3368 y Fs(\(defun)41 b(behave)g(\(animal\))642 3467 y(\(case)h(animal)
729 3567 y(\(dog)g(\(wag-tail\))947 3667 y(\(bark\)\))729
3766 y(\(rat)g(\(scurry\))947 3866 y(\(squeak\)\))729
3965 y(\(cat)g(\(rub-legs\))947 4065 y(\(scratch-carpet\)\))o(\)\))680
4253 y FA(What)17 b(if)h(we)g(w)o(ant)f(to)h(add)e(a)i(ne)n(w)f(type)g
(of)g(animal?)28 b(If)17 b(we)h(were)f(planning)f(to)h(add)g(ne)n(w)555
4357 y(animals,)j(it)h(w)o(ould)e(ha)n(v)o(e)h(been)f(better)h(to)g
(de\002ne)g Fs(behave)e FA(as)j(follo)n(ws:)555 4540
y Fs(\(defun)41 b(behave)g(\(animal\))642 4640 y(\(funcall)f(\(get)i
(animal)f('behavior\)\)\))555 4827 y FA(and)13 b(to)g(de\002ne)g(the)g
(beha)n(vior)f(of)h(an)g(indi)n(vidual)f(animal)g(as)i(a)g(function)e
(stored,)i(for)e(e)o(xample,)555 4932 y(on)20 b(the)g(property)e(list)j
(of)f(its)h(name:)p eop
%%Page: 16 29
16 28 bop 555 538 a FA(16)1091 b Fu(FUNCTIONS)555 801
y Fs(\(setf)42 b(\(get)f('dog)h('behavior\))817 900 y(#'\(lambda)d
(\(\))991 1000 y(\(wag-tail\))991 1100 y(\(bark\)\)\))555
1287 y FA(This)24 b(w)o(ay)-5 b(,)24 b(all)g(we)g(need)f(do)h(in)f
(order)g(to)h(add)f(a)h(ne)n(w)g(animal)f(is)i(de\002ne)e(a)h(ne)n(w)f
(property)-5 b(.)555 1392 y(No)20 b(functions)f(ha)n(v)o(e)h(to)g(be)g
(re)n(written.)680 1496 y(The)e(second)h(approach,)e(though)g(more)i
(\003e)o(xible,)f(looks)h(slo)n(wer)-5 b(.)29 b(It)20
b(is.)30 b(If)19 b(speed)g(were)555 1601 y(critical,)d(we)g(w)o(ould)f
(use)h(structures)f(instead)g(of)h(property)d(lists)k(and,)f
(especially)-5 b(,)15 b(compiled)555 1706 y(instead)21
b(of)h(interpreted)e(functions.)32 b(\(Section)21 b(2.9)g(e)o(xplains)g
(ho)n(w)g(to)h(mak)o(e)f(these.\))33 b(W)m(ith)555 1810
y(structures)18 b(and)f(compiled)g(functions,)g(the)h(more)g(\003e)o
(xible)f(type)h(of)g(code)g(can)g(approach)e(or)555 1915
y(e)o(xceed)j(the)h(speed)g(of)g(v)o(ersions)f(using)h
Fs(case)f FA(statements.)680 2019 y(This)14 b(use)h(of)f(functions)f
(corresponds)g(to)h(the)h(concept)e(of)h(a)h Ft(method)f
FA(in)g(object\255oriented)555 2124 y(programming.)28
b(Generally)20 b(speaking,)f(a)j(method)d(is)j(a)f(function)f(which)g
(is)i(a)f(property)e(of)555 2229 y(an)g(object,)g(and)f(that')-5
b(s)20 b(just)g(what)f(we)h(ha)n(v)o(e.)28 b(If)19 b(we)h(add)e
(inheritance)g(to)h(this)h(model,)e(we')o(ll)555 2333
y(ha)n(v)o(e)h(all)i(the)f(elements)f(of)h(object\255oriented)d
(programming.)25 b(Chapter)20 b(25)f(will)i(sho)n(w)e(that)555
2438 y(this)i(can)f(be)g(done)f(with)h(surprisingly)f(little)i(code.)
680 2542 y(One)g(of)f(the)h(big)g(selling)g(points)g(of)g
(object\255oriented)d(programming)g(is)k(that)f(it)h(mak)o(es)555
2647 y(programs)e(e)o(xtensible.)32 b(This)21 b(prospect)f(e)o(xcites)i
(less)g(w)o(onder)f(in)g(the)h(Lisp)f(w)o(orld,)g(where)555
2752 y(e)o(xtensibility)26 b(has)h(al)o(w)o(ays)h(been)e(tak)o(en)h
(for)f(granted.)48 b(If)27 b(the)g(kind)g(of)f(e)o(xtensibility)g(we)
555 2856 y(need)f(does)h(not)f(depend)f(too)i(much)f(on)g(inheritance,)
h(then)f(plain)h(Lisp)g(may)f(already)g(be)555 2961 y(suf)n(\002cient.)
555 3214 y Fw(2.5)99 b(Scope)555 3404 y FA(Common)16
b(Lisp)i(is)g(a)g(le)o(xically)f(scoped)f(Lisp.)29 b(Scheme)17
b(is)h(the)g(oldest)f(dialect)g(with)h(le)o(xical)555
3509 y(scope;)f(before)e(Scheme,)i(dynamic)e(scope)h(w)o(as)h
(considered)e(one)h(of)g(the)g(de\002ning)f(features)555
3613 y(of)20 b(Lisp.)680 3718 y(The)28 b(dif)n(ference)g(between)g(le)o
(xical)h(and)f(dynamic)g(scope)h(comes)g(do)n(wn)f(to)h(ho)n(w)g(an)555
3823 y(implementation)c(deals)j(with)g(free)f(v)n(ariables.)51
b(A)28 b(symbol)f(is)h Ft(bound)e FA(in)i(an)f(e)o(xpression)555
3927 y(if)c(it)h(has)f(been)f(established)g(as)i(a)f(v)n(ariable,)f
(either)h(by)f(appearing)f(as)j(a)f(parameter)m(,)e(or)i(by)555
4032 y(v)n(ariable\255binding)h(operators)i(lik)o(e)j
Fs(let)e FA(and)g Fs(do)p FA(.)52 b(Symbols)27 b(which)g(are)h(not)g
(bound)e(are)555 4136 y(said)21 b(to)f(be)g Ft(fr)m(ee)o(.)29
b FA(In)20 b(this)h(e)o(xample,)e(scope)g(comes)h(into)g(play:)555
4319 y Fs(\(let)42 b(\(\(y)g(7\)\))642 4419 y(\(defun)f(scope-test)f
(\(x\))729 4518 y(\(list)i(x)h(y\)\)\))555 4706 y FA(W)m(ithin)13
b(the)g Fs(defun)g FA(e)o(xpre)o(ssion,)8 b Fs(x)13 b
FA(is)g(bound)g(and)g Fs(y)g FA(is)f(free)o(.)21 b(Free)13
b(v)n(ariables)g(are)g(interesting)555 4811 y(because)j(it')-5
b(s)18 b(not)e(ob)o(vious)f(what)i(their)f(v)n(alues)h(should)e(be.)28
b(There')-5 b(s)16 b(no)h(uncertainty)e(about)555 4915
y(the)j(v)n(alue)f(of)h(a)g(bound)e(v)n(ariable\227when)g
Fs(scope-test)e FA(is)19 b(called,)f(the)g(v)n(alue)f(of)h
Fs(x)g FA(should)p eop
%%Page: 17 30
17 29 bop 555 538 a Ft(2.6)1104 b Fu(CLOSURES)1087 b
FA(17)555 801 y(be)22 b(whate)n(v)o(er)f(is)i(passed)f(as)h(the)f(ar)o
(gument.)33 b(But)23 b(what)f(should)f(be)h(the)h(v)n(alue)e(of)h
Fs(y)p FA(?)35 b(This)555 905 y(is)21 b(the)f(question)f(answered)h(by)
f(the)i(dialect')-5 b(s)20 b(scope)g(rules.)680 1010
y(In)k(a)h(dynamically)d(scoped)i(Lisp,)h(to)g(\002nd)f(the)g(v)n(alue)
g(of)g(a)h(free)f(v)n(ariable)g(when)g(e)o(x)o(e\255)555
1114 y(cuting)g Fs(scope-test)p FA(,)f(we)j(look)f(back)f(through)f
(the)j(chain)e(of)i(functions)d(that)j(called)f(it.)555
1219 y(When)e(we)h(\002nd)g(an)f(en)m(vironment)e(where)i
Fs(y)g FA(w)o(as)i(bound,)d(that)i(binding)e(of)h Fs(y)h
FA(will)g(be)g(the)555 1324 y(one)18 b(used)g(in)g Fs(scope-test)p
FA(.)25 b(If)18 b(we)h(\002nd)f(none,)f(we)h(tak)o(e)h(the)f(global)f
(v)n(alue)h(of)g Fs(y)p FA(.)28 b(Thus,)18 b(in)555 1428
y(a)e(dynamically)d(scoped)h(Lisp,)i Fs(y)f FA(w)o(ould)g(ha)n(v)o(e)f
(the)h(v)n(alue)g(it)g(had)g(in)g(the)g(calling)g(e)o(xpression:)555
1611 y Fs(>)43 b(\(let)f(\(\(y)g(5\)\))729 1711 y(\(scope-test)d(3\)\))
555 1810 y(\(3)k(5\))555 1998 y FA(W)m(ith)22 b(dynamic)e(scope,)h(it)h
(means)f(nothing)f(that)i Fs(y)f FA(w)o(as)h(bound)e(to)i
Fs(7)f FA(when)g Fs(scope-test)555 2102 y FA(w)o(as)26
b(de\002ned.)42 b(All)26 b(that)f(matters)g(is)h(that)f
Fs(y)g FA(had)f(a)i(v)n(alue)e(of)h Fs(5)g FA(when)f
Fs(scope-test)e FA(w)o(as)555 2207 y(called.)680 2312
y(In)16 b(a)g(le)o(xically)g(scoped)g(Lisp,)h(instead)f(of)g(looking)f
(back)g(through)g(the)h(chain)g(of)g(calling)555 2416
y(functions,)36 b(we)e(look)g(back)f(through)f(the)i(containing)e(en)m
(vironments)g(at)i(the)g(time)h(the)555 2521 y(function)25
b(w)o(as)j Ft(de\002ned.)48 b FA(In)27 b(a)g(le)o(xically)g(scoped)f
(Lisp,)j(our)d(e)o(xample)f(w)o(ould)i(catch)g(the)555
2625 y(binding)c(of)i Fs(y)g FA(where)f Fs(scope-test)e
FA(w)o(as)k(de\002ned.)42 b(So)25 b(this)h(is)g(what)f(w)o(ould)f
(happen)f(in)555 2730 y(Common)c(Lisp:)555 2913 y Fs(>)43
b(\(let)f(\(\(y)g(5\)\))729 3012 y(\(scope-test)d(3\)\))555
3112 y(\(3)k(7\))555 3300 y FA(Here)27 b(the)h(binding)e(of)h
Fs(y)h FA(to)g Fs(5)f FA(at)h(the)g(time)g(of)f(the)h(call)g(has)f(no)h
(ef)n(fect)f(on)g(the)g(returned)555 3404 y(v)n(alue.)680
3509 y(Though)12 b(you)i(can)g(still)i(get)f(dynamic)e(scope)h(by)h
(declaring)e(a)i(v)n(ariable)f(to)h(be)f Fs(special)p
FA(,)555 3613 y(le)o(xical)21 b(scope)g(is)h(the)f(def)o(ault)f(in)h
(Common)f(Lisp.)32 b(On)22 b(the)f(whole,)f(the)h(Lisp)h(community)555
3718 y(seems)k(to)f(vie)n(w)g(the)g(passing)f(of)h(dynamic)f(scope)g
(with)i(little)g(re)o(gret.)42 b(F)o(or)25 b(one)g(thing,)g(it)555
3823 y(used)i(to)h(lead)g(to)g(horribly)e(elusi)n(v)o(e)h(b)n(ugs.)51
b(But)28 b(le)o(xical)g(scope)f(is)i(more)e(than)g(a)h(w)o(ay)g(of)555
3927 y(a)n(v)n(oiding)c(b)n(ugs.)45 b(As)26 b(the)f(ne)o(xt)g(section)g
(will)h(sho)n(w)-5 b(,)26 b(it)g(also)g(mak)o(es)f(possible)h(some)f
(ne)n(w)555 4032 y(programming)17 b(techniques.)555 4285
y Fw(2.6)99 b(Closur)n(es)555 4475 y FA(Because)19 b(Common)f(Lisp)h
(is)h(le)o(xically)f(scoped,)f(when)g(we)i(de\002ne)f(a)g(function)e
(containing)555 4580 y(free)24 b(v)n(ariables,)h(the)g(system)f(must)h
(sa)n(v)o(e)g(copies)f(of)h(the)f(bindings)f(of)i(those)f(v)n(ariables)
g(at)555 4684 y(the)j(time)h(the)f(function)f(w)o(as)i(de\002ned.)50
b(Such)27 b(a)h(combination)d(of)i(a)h(function)d(and)i(a)h(set)555
4789 y(of)23 b(v)n(ariable)f(bindings)g(is)i(called)g(a)f
Ft(closur)m(e)o(.)39 b FA(Closures)23 b(turn)g(out)g(to)g(be)h(useful)e
(in)i(a)g(wide)555 4894 y(v)n(ariety)19 b(of)h(applications.)p
eop
%%Page: 18 31
18 30 bop 555 538 a FA(18)1091 b Fu(FUNCTIONS)680 801
y FA(Closures)22 b(are)g(so)h(perv)n(asi)n(v)o(e)d(in)j(Common)e(Lisp)h
(programs)e(that)j(it')-5 b(s)23 b(possible)f(to)g(use)555
905 y(them)34 b(without)f(e)n(v)o(en)g(kno)n(wing)f(it.)71
b(Ev)o(ery)32 b(time)i(you)f(gi)n(v)o(e)g Fs(mapcar)f
FA(a)j(sharp\255quoted)555 1010 y(lambda\255e)o(xpression)15
b(containing)h(free)i(v)n(ariables,)f(you')l(re)g(using)g(closures.)28
b(F)o(or)18 b(e)o(xample,)555 1114 y(suppose)28 b(we)g(w)o(ant)h(to)g
(write)f(a)h(function)e(which)h(tak)o(es)h(a)g(list)h(of)e(numbers)f
(and)h(adds)g(a)555 1219 y(certain)20 b(amount)e(to)j(each)f(one.)28
b(The)20 b(function)f Fs(list+)555 1402 y(\(defun)41
b(list+)h(\(lst)g(n\))642 1501 y(\(mapcar)f(#'\(lambda)f(\(x\))i(\(+)h
(x)g(n\)\))991 1601 y(lst\)\))555 1789 y FA(will)21 b(do)f(what)g(we)g
(w)o(ant:)555 1971 y Fs(>)43 b(\(list+)e('\(1)i(2)g(3\))g(10\))555
2071 y(\(11)f(12)h(13\))555 2259 y FA(If)24 b(we)h(look)f(closely)h(at)
g(the)f(function)f(which)h(is)i(passed)f(to)f Fs(mapcar)f
FA(within)h Fs(list+)p FA(,)g(it')-5 b(s)555 2363 y(actually)31
b(a)g(closure.)62 b(The)31 b(instance)f(of)h Fs(n)h FA(is)g(free,)h
(and)e(its)h(binding)e(comes)g(from)h(the)555 2468 y(surrounding)e(en)m
(vironment.)64 b(Under)31 b(le)o(xical)i(scope,)i(e)n(v)o(ery)c(such)h
(use)h(of)f(a)h(mapping)555 2572 y(function)18 b(causes)j(the)f
(creation)f(of)h(a)h(closure.)1910 2542 y Fm(1)680 2677
y FA(Closures)k(play)f(a)i(more)e(conspicuous)f(role)i(in)g(a)h(style)f
(of)g(programming)d(promoted)555 2782 y(by)d(Abelson)f(and)g(Sussman')
-5 b(s)19 b(classic)h Ft(Structur)m(e)f(and)f(Interpr)m(etation)f(of)i
(Computer)g(Pr)l(o\255)-2786 b Fq(\016)555 2886 y Ft(gr)o(ams.)29
b FA(Closures)20 b(are)g(functions)e(with)i(local)g(state.)30
b(The)19 b(simplest)h(w)o(ay)g(to)g(use)g(this)h(state)555
2991 y(is)g(in)f(a)h(situation)f(lik)o(e)g(the)h(follo)n(wing:)555
3173 y Fs(\(let)42 b(\(\(counter)e(0\)\))642 3273 y(\(defun)h(new-id)g
(\(\))130 b(\(incf)42 b(counter\)\))642 3373 y(\(defun)f(reset-id)g
(\(\))h(\(setq)g(counter)f(0\)\)\))555 3560 y FA(These)29
b(tw)o(o)h(functions)e(share)h(a)h(v)n(ariable)f(which)f(serv)o(es)i
(as)g(a)g(counter)-5 b(.)56 b(The)29 b(\002rst)h(one)555
3665 y(returns)25 b(successi)n(v)o(e)g(v)n(alues)g(of)g(the)h(counter)m
(,)e(and)h(the)h(second)e(resets)i(the)g(counter)e(to)i
Fs(0)p FA(.)555 3770 y(The)e(same)h(thing)f(could)f(be)i(done)e(by)i
(making)e(the)h(counter)f(a)i(global)f(v)n(ariable,)g(b)n(ut)h(this)555
3874 y(w)o(ay)20 b(it)h(is)g(protected)e(from)g(unintended)f
(references.)680 3979 y(It')-5 b(s)18 b(also)g(useful)f(to)h(be)f(able)
h(to)g(return)e(functions)g(with)i(local)g(state.)29
b(F)o(or)17 b(e)o(xample,)g(the)555 4083 y(function)h
Fs(make-adder)555 4266 y(\(defun)41 b(make-adder)f(\(n\))642
4366 y(#'\(lambda)g(\(x\))i(\(+)h(x)g(n\)\)\))555 4553
y FA(tak)o(es)20 b(a)g(number)m(,)e(and)h(returns)g(a)h(closure)f
(which,)g(when)g(called,)g(adds)h(that)g(number)e(to)i(its)555
4658 y(ar)o(gument.)27 b(W)-7 b(e)21 b(can)f(mak)o(e)g(as)h(man)o(y)e
(instances)h(of)g(adders)f(as)i(we)g(w)o(ant:)p 555 4729
1074 4 v 645 4784 a Fl(1)675 4808 y Fr(Under)k(dynamic)h(scope)f(the)g
(same)g(idiom)g(will)g(w)o(ork)g(for)g(a)f(dif)n(ferent)k(reason\227so)
d(long)h(as)e(neither)j(of)555 4890 y Fk(mapcar)p Fr(')l(s)19
b(parameter)g(is)e(called)i Fk(x)p Fr(.)p eop
%%Page: 19 32
19 31 bop 555 538 a Ft(2.6)1104 b Fu(CLOSURES)1087 b
FA(19)555 801 y Fs(>)43 b(\(setq)f(add2)85 b(\(make-adder)39
b(2\))904 900 y(add10)i(\(make-adder)e(10\)\))555 1000
y(#<Interpreted-Fu)o(nct)o(io)o(n)e(BF162E>)555 1100
y(>)43 b(\(funcall)d(add2)i(5\))555 1199 y(7)555 1299
y(>)h(\(funcall)d(add10)i(3\))555 1398 y(13)555 1585
y FA(In)25 b(the)g(closures)g(returned)f(by)g Fs(make-adder)p
FA(,)f(the)i(internal)g(state)h(is)g(\002x)o(ed,)g(b)n(ut)f(it')-5
b(s)26 b(also)555 1689 y(possible)20 b(to)g(mak)o(e)g(closures)g(which)
f(can)h(be)h(ask)o(ed)f(to)g(change)f(their)h(state.)555
1871 y Fs(\(defun)41 b(make-adderb)e(\(n\))642 1970 y(#'\(lambda)h(\(x)
j(&optional)d(change\))817 2070 y(\(if)i(change)991 2169
y(\(setq)f(n)j(x\))991 2269 y(\(+)f(x)g(n\)\)\)\))555
2455 y FA(This)25 b(ne)n(w)g(v)o(ersion)e(of)i Fs(make-adder)c
FA(returns)j(closures)h(which,)g(when)f(called)h(with)g(one)555
2560 y(ar)o(gument,)18 b(beha)n(v)o(e)h(just)h(lik)o(e)h(the)f(old)g
(ones.)555 2741 y Fs(>)43 b(\(setq)f(addx)g(\(make-adderb)c(1\)\))555
2841 y(#<Interpreted-Fu)o(nct)o(io)o(n)f(BF1C66>)555
2940 y(>)43 b(\(funcall)d(addx)i(3\))555 3040 y(4)555
3226 y FA(Ho)n(we)n(v)o(er)m(,)22 b(when)h(the)h(ne)n(w)f(type)g(of)g
(adder)f(is)j(called)e(with)h(a)g(non\255nil)e(second)g(ar)o(gument,)
555 3331 y(its)f(internal)f(cop)o(y)f(of)h Fs(n)g FA(will)h(be)f(reset)
h(to)f(the)g(v)n(alue)g(passed)g(as)h(the)f(\002rst)h(ar)o(gument:)555
3512 y Fs(>)43 b(\(funcall)d(addx)i(100)h(t\))555 3612
y(100)555 3712 y(>)g(\(funcall)d(addx)i(3\))555 3811
y(103)680 3997 y FA(It')-5 b(s)31 b(e)n(v)o(en)e(possible)i(to)g
(return)e(a)i(group)e(of)h(closures)h(which)f(share)g(the)h(same)g
(data)555 4102 y(objects.)d(Figure)17 b(2.1)h(contains)f(a)h(function)e
(which)i(creates)f(primiti)n(v)o(e)g(databases.)28 b(It)18
b(tak)o(es)555 4207 y(an)h(assoc\255list)g(\()p Fs(db)p
FA(\),)f(and)g(returns)g(a)i(list)f(of)g(three)f(closures)h(which)f
(query)-5 b(,)17 b(add,)h(and)h(delete)555 4311 y(entries,)h(respecti)n
(v)o(ely)-5 b(.)680 4416 y(Each)16 b(call)h(to)g Fs(make-dbms)d
FA(mak)o(es)j(a)g(ne)n(w)f(database\227a)h(ne)n(w)f(set)i(of)e
(functions)g(closed)555 4520 y(o)o(v)o(er)j(their)h(o)n(wn)f(shared)h
(cop)o(y)f(of)h(an)g(assoc\255list.)555 4702 y Fs(>)43
b(\(setq)f(cities)f(\(make-dbms)e('\(\(boston)h(.)j(us\))g(\(paris)e(.)
i(france\)\)\)\))555 4801 y(\(#<Interpreted-F)o(unc)o(ti)o(on)37
b(8022E7>)599 4901 y(#<Interpreted-F)o(unc)o(ti)o(on)g(802317>)599
5001 y(#<Interpreted-F)o(unc)o(ti)o(on)g(802347>\))p
eop
%%Page: 20 33
20 32 bop 555 538 a FA(20)1091 b Fu(FUNCTIONS)p 555 745
2678 4 v 553 2067 4 1322 v 605 888 a Fs(\(defun)41 b(make-dbms)f
(\(db\))692 988 y(\(list)779 1087 y(#'\(lambda)g(\(key\))954
1187 y(\(cdr)h(\(assoc)h(key)g(db\)\)\))779 1287 y(#'\(lambda)e(\(key)i
(val\))954 1386 y(\(push)f(\(cons)h(key)g(val\))g(db\))954
1486 y(key\))779 1586 y(#'\(lambda)e(\(key\))954 1685
y(\(setf)h(db)i(\(delete)d(key)j(db)g(:key)f(#'car\)\))954
1785 y(key\)\)\))1255 1989 y FA(Figure)19 b(2.1:)29 b(Three)20
b(closures)f(share)h(a)h(list.)p 3231 2067 V 555 2070
2678 4 v 555 2295 a(The)g(actual)f(assoc\255list)i(within)e(the)h
(database)f(is)i(in)m(visible)e(from)g(the)h(outside)f(w)o(orld\227we)
555 2399 y(can')o(t)h(e)n(v)o(en)g(tell)i(that)f(it')-5
b(s)23 b(an)f(assoc\255list\227b)n(ut)g(it)h(can)e(be)h(reached)f
(through)f(the)i(functions)555 2504 y(which)e(are)g(components)e(of)i
Fs(cities)p FA(:)555 2686 y Fs(>)43 b(\(funcall)d(\(car)i(cities\))f
('boston\))555 2786 y(US)555 2886 y(>)i(\(funcall)d(\(second)h
(cities\))g('london)g('england\))555 2985 y(LONDON)555
3085 y(>)i(\(funcall)d(\(car)i(cities\))f('london\))555
3185 y(ENGLAND)555 3372 y FA(Calling)18 b(the)h Fs(car)e
FA(of)i(a)f(list)i(is)f(a)g(bit)g(ugly)-5 b(.)27 b(In)18
b(real)g(programs,)f(the)h(access)h(functions)e(might)555
3477 y(instead)28 b(be)f(entries)h(in)g(a)g(structure.)52
b(Using)27 b(them)h(could)f(also)h(be)g(cleaner)n(\227databases)555
3581 y(could)19 b(be)h(reached)f(indirectly)g(via)h(functions)f(lik)o
(e:)555 3764 y Fs(\(defun)41 b(lookup)g(\(key)h(db\))642
3864 y(\(funcall)e(\(car)i(db\))h(key\)\))555 4051 y
FA(Ho)n(we)n(v)o(er)m(,)18 b(the)i(basic)h(beha)n(vior)d(of)i(closures)
g(is)h(independent)d(of)i(such)g(re\002nements.)680 4156
y(In)14 b(real)h(programs,)e(the)i(closures)f(and)h(data)f(structures)g
(w)o(ould)g(also)h(be)g(more)f(elaborate)555 4261 y(than)f(those)h(we)h
(see)f(in)g Fs(make-adder)c FA(or)k Fs(make-dbms)p FA(.)24
b(The)14 b(single)g(shared)f(v)n(ariable)g(could)555
4365 y(be)20 b(an)o(y)g(number)e(of)i(v)n(ariables,)f(each)h(bound)e
(to)i(an)o(y)g(sort)g(of)g(data)g(structure.)680 4470
y(Closures)15 b(are)f(one)h(of)f(the)h(distinct,)h(tangible)e
(bene\002ts)h(of)f(Lisp.)28 b(Some)14 b(Lisp)h(programs)555
4574 y(could,)34 b(with)e(ef)n(fort,)h(be)f(translated)f(into)g(less)i
(po)n(werful)d(languages.)63 b(But)32 b(just)h(try)e(to)555
4679 y(translate)18 b(a)h(program)d(which)i(uses)g(closures)g(as)h(abo)
o(v)o(e,)e(and)h(it)h(will)g(become)e(e)n(vident)g(ho)n(w)555
4784 y(much)i(w)o(ork)h(this)g(abstraction)f(is)i(sa)n(ving)f(us.)29
b(Later)20 b(chapters)g(will)g(deal)g(with)h(closures)e(in)555
4888 y(more)h(detail.)30 b(Chapter)20 b(5)g(sho)n(ws)h(ho)n(w)f(to)g
(use)h(them)f(to)h(b)n(uild)f(compound)d(functions,)i(and)555
4993 y(Chapter)h(6)g(looks)g(at)g(their)g(use)h(as)g(a)f(substitute)g
(for)g(traditional)f(data)h(structures.)p eop
%%Page: 21 34
21 33 bop 555 538 a Ft(2.7)981 b Fu(LOCAL)17 b(FUNCTIONS)964
b FA(21)555 801 y Fw(2.7)99 b(Local)25 b(Functions)555
991 y FA(When)e(we)h(de\002ne)f(functions)f(with)i(lambda\255e)o
(xpressions,)c(we)k(f)o(ace)g(a)f(restriction)g(which)555
1096 y(doesn')o(t)16 b(arise)j(with)f Fs(defun)p FA(:)27
b(a)18 b(function)f(de\002ned)g(in)h(a)g(lambda\255e)o(xpression)d
(doesn')o(t)h(ha)n(v)o(e)555 1200 y(a)g(name)e(and)h(therefore)e(has)j
(no)e(w)o(ay)i(of)e(referring)g(to)h(itself.)28 b(This)15
b(means)g(that)h(in)f(Common)555 1305 y(Lisp)20 b(we)h(can')o(t)e(use)i
Fs(lambda)d FA(to)i(de\002ne)g(a)g(recursi)n(v)o(e)f(function.)870
b Fq(\016)680 1410 y FA(If)17 b(we)g(w)o(ant)h(to)f(apply)f(some)i
(function)d(to)j(all)f(the)h(elements)f(of)g(a)g(list,)i(we)f(use)f
(the)h(most)555 1514 y(f)o(amiliar)i(of)g(Lisp)g(idioms:)555
1697 y Fs(>)43 b(\(mapcar)e(#'\(lambda)f(\(x\))i(\(+)h(2)g(x\)\))991
1796 y('\(2)f(5)h(7)h(3\)\))555 1896 y(\(4)f(7)g(9)g(5\))555
2079 y FA(What)18 b(about)f(cases)h(where)f(we)h(w)o(ant)g(to)g(gi)n(v)
o(e)e(a)j(recursi)n(v)o(e)d(function)g(as)i(the)g(\002rst)g(ar)o
(gument)555 2178 y(to)k Fs(mapcar)p FA(?)33 b(If)22 b(the)h(function)d
(has)i(been)g(de\002ned)f(with)h Fs(defun)p FA(,)f(we)h(can)g(simply)g
(refer)f(to)555 2278 y(it)g(by)f(name:)555 2444 y Fs(>)43
b(\(mapcar)e(#'copy-tree)e('\(\(a)j(b\))h(\(c)f(d)i(e\)\)\))555
2544 y(\(\(A)e(B\))h(\(C)g(D)g(E\)\))555 2715 y FA(But)19
b(no)n(w)g(suppose)f(that)h(the)g(function)e(has)i(to)g(be)g(a)g
(closure,)f(taking)g(some)h(bindings)f(from)555 2819
y(the)i(en)m(vironment)d(in)k(which)e(the)i Fs(mapcar)d
FA(occurs.)28 b(In)20 b(our)g(e)o(xample)e Fs(list+)p
FA(,)555 3002 y Fs(\(defun)41 b(list+)h(\(lst)g(n\))642
3102 y(\(mapcar)f(#'\(lambda)f(\(x\))i(\(+)h(x)g(n\)\))991
3201 y(lst\)\))555 3389 y FA(the)13 b(\002rst)g(ar)o(gument)g(to)g
Fs(mapcar)o FA(,)c Fs(#'\(lambda)40 b(\(x\))i(\(+)h(x)g(n\)\))p
FA(,)13 b(must)g(be)g(de\002ned)g(within)555 3493 y Fs(list+)20
b FA(because)h(it)h(needs)f(to)h(catch)f(the)h(binding)e(of)h
Fs(n)p FA(.)33 b(So)22 b(f)o(ar)f(so)h(good,)e(b)n(ut)i(what)f(if)h(we)
555 3598 y(w)o(ant)c(to)g(gi)n(v)o(e)f Fs(mapcar)f FA(a)j(function)d
(which)h(both)g(needs)h(local)g(bindings)e Ft(and)h FA(is)i(recursi)n
(v)o(e?)555 3703 y(W)-7 b(e)19 b(can')o(t)e(use)i(a)f(function)f
(de\002ned)g(else)n(where)g(with)i Fs(defun)p FA(,)e(because)g(we)i
(need)e(bindings)555 3807 y(from)32 b(the)i(local)f(en)m(vironment.)65
b(And)33 b(we)h(can')o(t)e(use)i Fs(lambda)d FA(to)j(de\002ne)e(a)i
(recursi)n(v)o(e)555 3912 y(function,)18 b(because)i(the)g(function)e
(will)j(ha)n(v)o(e)f(no)g(w)o(ay)g(of)g(referring)e(to)i(itself.)680
4017 y(Common)31 b(Lisp)h(gi)n(v)o(es)g(us)h Fs(labels)e
FA(as)i(a)g(w)o(ay)g(out)f(of)g(this)h(dilemma.)65 b(W)m(ith)33
b(one)555 4121 y(important)21 b(reserv)n(ation,)g Fs(labels)f
FA(could)h(be)i(described)e(as)i(a)f(sort)h(of)f Fs(let)g
FA(for)f(functions.)555 4226 y(Each)f(of)g(the)g(binding)e
(speci\002cations)i(in)g(a)h Fs(labels)d FA(e)o(xpression)h(should)g
(ha)n(v)o(e)h(the)g(form)555 4393 y Fs(\()p Fq(h)p FA(name)p
Fq(i)43 b(h)p FA(parameters)p Fq(i)f Fs(.)h Fq(h)p FA(body)p
Fq(i)p Fs(\))555 4559 y FA(W)m(ithin)20 b(the)g Fs(labels)f
FA(e)o(xpression,)f Fq(h)p FA(name)p Fq(i)i FA(will)h(refer)e(to)i(a)f
(function)f(equi)n(v)n(alent)f(to:)555 4714 y Fs(#'\(lambda)40
b Fq(h)p FA(parameters)p Fq(i)i Fs(.)h Fq(h)p FA(body)p
Fq(i)p Fs(\))555 4868 y FA(So)20 b(for)g(e)o(xample:)p
eop
%%Page: 22 35
22 34 bop 555 538 a FA(22)1091 b Fu(FUNCTIONS)555 801
y Fs(>)43 b(\(labels)e(\(\(inc)g(\(x\))i(\(1+)f(x\)\)\))729
905 y(\(inc)g(3\)\))555 1010 y(4)555 1188 y FA(Ho)n(we)n(v)o(er)m(,)27
b(there)h(is)g(an)g(important)e(dif)n(ference)g(between)h
Fs(let)g FA(and)g Fs(labels)p FA(.)50 b(In)27 b(a)h Fs(let)555
1293 y FA(e)o(xpression,)d(the)g(v)n(alue)g(of)g(one)g(v)n(ariable)f
(can')o(t)g(depend)g(on)h(another)f(v)n(ariable)g(made)h(by)555
1397 y(the)20 b(same)h Fs(let)p FA(\227that)e(is,)i(you)e(can')o(t)g
(say)555 1571 y Fs(\(let)42 b(\(\(x)g(10\))h(\(y)f(x\)\))642
1670 y(y\))555 1849 y FA(and)13 b(e)o(xpect)g(the)g(v)n(alue)g(of)g
(the)g(ne)m(w)g Fs(y)g FA(to)g(r)o(e\003ect)g(tha)o(t)g(of)g(th)o(e)g
(ne)m(w)g Fs(x)p FA(.)21 b(In)13 b(contrast,)f(the)h(body)g(of)555
1953 y(a)g(function)33 b Ft(f)25 b FA(de\002ned)13 b(in)g(a)g
Fs(labels)g FA(e)o(x)o(pr)o(ession)g(m)o(ay)f(ref)o(er)g(to)h(an)n(y)f
(o)o(ther)g(fu)o(nctio)o(n)h(d)o(e\002ne)o(d)555 2058
y(there,)19 b(including)34 b Ft(f)f FA(itself,)21 b(which)e(mak)o(es)h
(recursi)n(v)o(e)f(function)g(de\002nitions)g(possible.)680
2163 y(Using)i Fs(labels)f FA(we)i(can)g(write)g(a)g(function)e
(analogous)g(to)i Fs(list+)p FA(,)f(b)n(ut)g(in)h(which)g(the)555
2267 y(\002rst)f(ar)o(gument)d(to)i Fs(mapcar)e FA(is)k(a)e(recursi)n
(v)o(e)f(function:)555 2441 y Fs(\(defun)41 b(count-instances)c(\(obj)
42 b(lsts\))642 2540 y(\(labels)f(\(\(instances-in)d(\(lst\))1122
2640 y(\(if)k(\(consp)f(lst\))1296 2740 y(\(+)i(\(if)f(\(eq)g(\(car)g
(lst\))g(obj\))g(1)h(0\))1427 2839 y(\(instances-in)38
b(\(cdr)k(lst\)\)\))1296 2939 y(0\)\)\))729 3038 y(\(mapcar)f
(#'instances-in)d(lsts\)\)\))555 3217 y FA(This)e(function)e(tak)o(es)i
(an)g(object)f(and)g(a)h(list,)41 b(and)35 b(returns)g(a)h(list)h(of)e
(the)h(number)e(of)555 3321 y(occurrences)18 b(of)i(the)g(object)g(in)g
(each)g(element:)555 3495 y Fs(>)43 b(\(count-instances)37
b('a)43 b('\(\(a)f(b)h(c\))g(\(d)g(a)g(r)g(p)g(a\))g(\(d)g(a)g(r\))f
(\(a)h(a\)\)\))555 3594 y(\(1)g(2)g(1)g(2\))555 3846
y Fw(2.8)99 b(T)-9 b(ail\255Recursion)555 4036 y FA(A)30
b(recursi)n(v)o(e)f(function)f(is)i(one)g(that)f(calls)i(itself.)59
b(Such)29 b(a)h(call)g(is)h Ft(tail\255r)m(ecur)o(sive)f
FA(if)g(no)555 4141 y(w)o(ork)22 b(remains)h(to)g(be)g(done)f(in)i(the)
f(calling)g(function)e(afterw)o(ards.)37 b(This)23 b(function)f(is)i
(not)555 4245 y(tail\255recursi)n(v)o(e)555 4419 y Fs(\(defun)41
b(our-length)f(\(lst\))642 4518 y(\(if)j(\(null)e(lst\))817
4618 y(0)817 4718 y(\(1+)h(\(our-length)d(\(cdr)j(lst\)\)\)\)\))555
4896 y FA(because)18 b(on)h(returning)e(from)h(the)h(recursi)n(v)o(e)f
(call)i(we)f(ha)n(v)o(e)g(to)g(pass)h(the)f(result)g(to)g
Fs(1+)p FA(.)29 b(The)555 5001 y(follo)n(wing)19 b(function)f(is)j
(tail\255recursi)n(v)o(e,)d(though)p eop
%%Page: 23 36
23 35 bop 555 538 a Ft(2.8)1010 b Fu(T)-6 b(AIL)p Fv(\255)p
Fu(RECURSION)992 b FA(23)555 801 y Fs(\(defun)41 b(our-find-if)e(\(fn)j
(lst\))642 900 y(\(if)h(\(funcall)d(fn)j(\(car)e(lst\)\))817
1000 y(\(car)g(lst\))817 1100 y(\(our-find-if)d(fn)43
b(\(cdr)f(lst\)\)\)\))555 1287 y FA(because)20 b(the)g(v)n(alue)f(of)h
(the)g(recursi)n(v)o(e)f(call)i(is)g(immediately)e(returned.)680
1392 y(T)-7 b(ail\255recursion)20 b(is)k(desirable)d(because)h(man)o(y)
f(Common)h(Lisp)g(compilers)g(can)g(trans\255)555 1496
y(form)f(tail\255recursi)n(v)o(e)g(functions)g(into)h(loops.)36
b(W)m(ith)23 b(such)f(a)h(compiler)m(,)e(you)g(can)i(ha)n(v)o(e)f(the)
555 1601 y(ele)o(gance)e(of)i(recursion)f(in)h(your)f(source)h(code)f
(without)h(the)g(o)o(v)o(erhead)d(of)j(function)f(calls)555
1706 y(at)f(runtime.)28 b(The)19 b(gain)f(in)i(speed)f(is)h(usually)f
(great)g(enough)f(that)h(programmers)e(go)i(out)g(of)555
1810 y(their)h(w)o(ay)g(to)h(mak)o(e)e(functions)g(tail\255recursi)n(v)
o(e.)680 1915 y(A)h(function)e(which)i(isn')o(t)f(tail\255recursi)n(v)o
(e)f(can)i(often)f(be)h(transformed)e(into)h(one)h(that)g(is)555
2019 y(by)d(embedding)d(in)k(it)g(a)f(local)h(function)d(which)i(uses)g
(an)h Ft(accumulator)-9 b(.)26 b FA(In)17 b(this)g(conte)o(xt,)g(an)555
2124 y(accumulator)h(is)j(a)g(parameter)d(representing)h(the)h(v)n
(alue)f(computed)f(so)j(f)o(ar)-5 b(.)29 b(F)o(or)20
b(e)o(xample,)555 2229 y Fs(our-length)d FA(could)i(be)h(transformed)e
(into)555 2411 y Fs(\(defun)41 b(our-length)f(\(lst\))642
2511 y(\(labels)h(\(\(rec)g(\(lst)h(acc\))1122 2611 y(\(if)g(\(null)f
(lst\))1296 2710 y(acc)1296 2810 y(\(rec)h(\(cdr)g(lst\))g(\(1+)g
(acc\)\)\)\)\))729 2909 y(\(rec)g(lst)h(0\)\)\))555 3097
y FA(where)19 b(the)i(number)d(of)i(list)h(elements)f(seen)g(so)g(f)o
(ar)g(is)h(contained)e(in)h(a)g(second)g(parameter)m(,)555
3202 y Fs(acc)p FA(.)55 b(When)29 b(the)g(recursion)f(reaches)h(the)g
(end)f(of)h(the)h(list,)i(the)d(v)n(alue)f(of)h Fs(acc)g
FA(will)h(be)555 3306 y(the)22 b(total)f(length,)g(which)g(can)g(just)h
(be)g(returned.)31 b(By)22 b(accumulating)d(the)j(v)n(alue)f(as)h(we)g
(go)555 3411 y(do)n(wn)d(the)i(calling)f(tree)h(instead)f(of)g
(constructing)f(it)i(on)f(the)h(w)o(ay)f(back)g(up,)g(we)h(can)f(mak)o
(e)555 3515 y Fs(rec)g FA(tail\255recursi)n(v)o(e.)680
3620 y(Man)o(y)f(Common)g(Lisp)h(compilers)g(can)g(do)g
(tail\255recursion)e(optimization,)h(b)n(ut)h(not)g(all)555
3725 y(of)h(them)h(do)f(it)h(by)f(def)o(ault.)33 b(So)22
b(after)f(writing)g(your)g(functions)f(to)i(be)f(tail\255recursi)n(v)o
(e,)f(you)555 3829 y(may)g(also)g(w)o(ant)h(to)f(put)555
4012 y Fs(\(proclaim)40 b('\(optimize)f(speed\)\))555
4200 y FA(at)15 b(the)f(top)g(of)g(the)h(\002le,)h(to)e(ensure)g(that)h
(the)f(compiler)f(can)h(tak)o(e)h(adv)n(antage)d(of)i(your)f(ef)n
(forts.)3208 4169 y Fm(2)680 4304 y FA(Gi)n(v)o(en)21
b(tail\255recursion)h(and)g(type)g(declarations,)g(e)o(xisting)g
(Common)g(Lisp)h(compilers)555 4409 y(can)e(generate)f(code)h(that)g
(runs)g(as)h(f)o(ast)g(as,)g(or)f(f)o(aster)h(than,)f(C.)33
b(Richard)21 b(Gabriel)g(gi)n(v)o(es)g(as)58 b Fq(\016)555
4513 y FA(an)22 b(e)o(xample)f(the)h(follo)n(wing)f(function,)f(which)i
(returns)f(the)i(sum)f(of)g(the)g(inte)o(gers)f(from)g
Fs(1)555 4618 y FA(to)f Fs(n)p FA(:)p 555 4672 1074 4
v 645 4727 a Fl(2)675 4751 y Fr(The)c(declaration)k Fk(\(optimize)38
b(speed\))17 b Fr(ought)h(to)e(be)h(an)g(abbre)n(viation)j(for)d
Fk(\(optimize)38 b(\(speed)f(3\)\))p Fr(.)555 4834 y(Ho)n(we)n(v)o(er)m
(,)17 b(one)f(Common)f(Lisp)g(implementation)k(does)d
(tail\255recursion)j(optimization)g(with)d(the)g(former)m(,)g(b)o(ut)f
(not)555 4916 y(the)j(latter)l(.)p eop
%%Page: 24 37
24 36 bop 555 538 a FA(24)1091 b Fu(FUNCTIONS)555 801
y Fs(\(defun)41 b(triangle)f(\(n\))642 900 y(\(labels)h(\(\(tri)g(\(c)i
(n\))1122 1000 y(\(declare)d(\(type)h(fixnum)h(n)h(c\)\))1122
1100 y(\(if)f(\(zerop)f(n\))1296 1199 y(c)1296 1299 y(\(tri)h(\(the)g
(fixnum)f(\(+)i(n)g(c\)\))1514 1398 y(\(the)f(fixnum)f(\(-)i(n)g
(1\)\)\)\)\)\))729 1498 y(\(tri)f(0)h(n\)\)\))555 1680
y FA(This)22 b(is)i(what)e(f)o(ast)h(Common)d(Lisp)j(code)e(looks)h
(lik)o(e.)36 b(At)22 b(\002rst)h(it)g(may)f(not)g(seem)g(natural)555
1784 y(to)h(write)g(functions)e(this)j(w)o(ay)-5 b(.)37
b(It')-5 b(s)23 b(often)f(a)h(good)f(idea)h(to)g(be)o(gin)e(by)i
(writing)f(a)h(function)555 1889 y(in)c(whate)n(v)o(er)e(w)o(ay)i
(seems)g(most)g(natural,)f(and)h(then,)f(if)h(necessary)-5
b(,)18 b(transforming)e(it)k(into)e(a)555 1994 y(tail\255recursi)n(v)o
(e)g(equi)n(v)n(alent.)555 2245 y Fw(2.9)99 b(Compilation)555
2436 y FA(Lisp)21 b(functions)f(can)h(be)g(compiled)f(either)g(indi)n
(vidually)f(or)i(by)g(the)g(\002le.)32 b(If)21 b(you)f(just)i(type)555
2540 y(a)f Fs(defun)d FA(e)o(xpression)h(into)h(the)g(tople)n(v)o(el,)
555 2717 y Fs(>)43 b(\(defun)e(foo)i(\(x\))f(\(1+)g(x\)\))555
2817 y(FOO)555 2999 y FA(man)o(y)15 b(implementations)e(will)k(create)e
(an)h(interpreted)e(function.)26 b(Y)-9 b(ou)15 b(can)h(check)f
(whether)555 3103 y(a)21 b(gi)n(v)o(en)e(function)f(is)j(compiled)e(by)
h(feeding)e(it)j(to)g Fs(compiled-functi)o(on-)o(p)p
FA(:)555 3280 y Fs(>)43 b(\(compiled-functio)o(n-)o(p)37
b(#'foo\))555 3380 y(NIL)555 3561 y FA(W)-7 b(e)21 b(can)f(ha)n(v)o(e)g
Fs(foo)f FA(compiled)g(by)h(gi)n(ving)f(its)i(name)f(to)g
Fs(compile)555 3738 y(>)43 b(\(compile)d('foo\))555 3838
y(FOO)555 4019 y FA(which)20 b(will)h(compile)f(the)h(de\002nition)e
(of)i Fs(foo)f FA(and)g(replace)g(the)g(interpreted)f(v)o(ersion)g
(with)555 4124 y(a)i(compiled)d(one.)-629 b Fq(\016)555
4301 y Fs(>)43 b(\(compiled-functio)o(n-)o(p)37 b(#'foo\))555
4400 y(T)555 4582 y FA(Compiled)23 b(and)h(interpreted)e(functions)g
(are)i(both)g(Lisp)g(objects,)g(and)g(beha)n(v)o(e)f(the)h(same,)555
4687 y(e)o(xcept)30 b(with)h(respect)g(to)g Fs(compiled-function)o(-p)o
FA(.)57 b(Literal)31 b(functions)e(can)i(also)h(be)555
4791 y(compiled:)j Fs(compile)21 b FA(e)o(xpects)i(its)h(\002rst)g(ar)o
(gument)d(to)j(be)f(a)h(name,)g(b)n(ut)f(if)h(you)f(gi)n(v)o(e)f
Fs(nil)555 4896 y FA(as)j(the)f(\002rst)i(ar)o(gument,)c(it)j(will)g
(compile)f(the)g(lambda\255e)o(xpression)d(gi)n(v)o(en)i(as)i(the)f
(second)555 5001 y(ar)o(gument.)p eop
%%Page: 25 38
25 37 bop 555 538 a Ft(2.9)1055 b Fu(COMPILA)-7 b(TION)1037
b FA(25)555 801 y Fs(>)43 b(\(compile)d(nil)j('\(lambda)d(\(x\))i(\(+)h
(x)g(2\)\)\))555 900 y(#<Compiled-Funct)o(ion)37 b(BF55BE>)555
1088 y FA(If)26 b(you)f(gi)n(v)o(e)h(both)f(the)h(name)g(and)f
(function)g(ar)o(guments,)g Fs(compile)f FA(becomes)h(a)i(sort)f(of)555
1193 y(compiling)18 b Fs(defun)p FA(:)555 1375 y Fs(>)43
b(\(progn)e(\(compile)g('bar)g('\(lambda)g(\(x\))h(\(*)h(x)g(3\)\)\))
947 1475 y(\(compiled-functio)o(n-)o(p)38 b(#'bar\)\))555
1574 y(T)680 1762 y FA(Ha)n(ving)13 b Fs(compile)g FA(in)g(th)o(e)g
(lan)o(gu)o(age)f(mea)o(ns)h(th)o(at)g(a)f(pro)o(gr)o(am)g(cou)o(ld)g
(b)n(uild)g(an)o(d)h(c)o(om)o(pile)555 1867 y(ne)n(w)g(functions)f(on)h
(the)g(\003y)-5 b(.)27 b(Ho)n(we)n(v)o(er)m(,)12 b(calling)h
Fs(compile)e FA(e)o(xplicitly)h(is)j(a)e(drastic)h(measure,)555
1971 y(comparable)30 b(to)j(calling)f Fs(eval)p FA(,)j(and)d(should)f
(be)i(vie)n(wed)e(with)i(the)g(same)f(suspicion.)3208
1941 y Fm(3)555 2076 y FA(When)f(Section)g(2.1)f(said)h(that)h
(creating)e(ne)n(w)h(functions)e(at)j(runtime)e(w)o(as)i(a)f(routinely)
555 2180 y(used)k(programming)c(technique,)37 b(it)e(referred)f(to)h
(ne)n(w)f(closures)h(lik)o(e)g(those)g(made)f(by)555
2285 y Fs(make-adder)p FA(,)j(not)e(functions)g(made)h(by)g(calling)g
Fs(compile)e FA(on)i(ra)o(w)g(lists.)79 b(Calling)555
2390 y Fs(compile)20 b FA(is)k(not)e(a)h(routinely)e(used)i
(programming)c(technique\227it')-5 b(s)21 b(an)i(e)o(xtremely)e(rare)
555 2494 y(one.)44 b(So)26 b(be)n(w)o(are)f(of)g(doing)f(it)i
(unnecessarily)-5 b(.)43 b(Unless)26 b(you')l(re)e(implementing)f
(another)555 2599 y(language)e(on)h(top)h(of)f(Lisp)h(\(and)f(much)f
(of)i(the)g(time,)g(e)n(v)o(en)e(then\),)i(what)f(you)g(need)g(to)h(do)
555 2704 y(may)d(be)g(possible)g(with)g(macros.)680 2808
y(There)33 b(are)h(tw)o(o)g(sorts)h(of)f(functions)e(which)i(you)f
(can')o(t)g(gi)n(v)o(e)h(as)h(an)f(ar)o(gument)d(to)555
2913 y Fs(compile)p FA(.)47 b(According)25 b(to)j Fr(CL)-6
b(TL)p FA(2)26 b(\(p.)g(677\),)i(you)e(can')o(t)g(compile)g(a)h
(function)f(\223de\002ned)555 3017 y(interpreti)n(v)o(ely)e(in)i(a)g
(non\255null)e(le)o(xical)i(en)m(vironment.)-6 b(\224)43
b(That)26 b(is,)i(if)e(at)h(the)f(tople)n(v)o(el)e(you)555
3122 y(de\002ne)c Fs(foo)f FA(within)h(a)h Fs(let)555
3305 y(>)43 b(\(let)f(\(\(y)g(2\)\))729 3404 y(\(defun)f(foo)i(\(x\))f
(\(+)h(x)g(y\)\)\))555 3592 y FA(then)22 b Fs(\(compile)41
b('foo\))21 b FA(will)i(not)g(necessarily)f(w)o(ork.)2221
3562 y Fm(4)2290 3592 y FA(Y)-9 b(ou)22 b(also)h(can')o(t)f(call)h
Fs(compile)555 3696 y FA(on)18 b(a)h(function)e(which)h(is)i(already)e
(compiled.)27 b(In)18 b(this)h(situation,)g Fr(CL)-6
b(TL)p FA(2)17 b(hints)i(darkly)e(that)555 3801 y(\223the)j
(consequences)p Fy(:)14 b(:)g(:)m FA(are)21 b(unspeci\002ed.)-6
b(\224)680 3906 y(The)22 b(usual)h(w)o(ay)f(to)h(compile)f(Lisp)h(code)
f(is)i(not)f(to)g(compile)e(functions)h(indi)n(vidually)555
4010 y(with)29 b Fs(compile)p FA(,)f(b)n(ut)g(to)h(compile)e(whole)h
(\002les)h(with)g Fs(compile-file)p FA(.)50 b(This)28
b(function)555 4115 y(tak)o(es)20 b(a)f(\002lename)g(and)g(creates)g(a)
h(compiled)e(v)o(ersion)g(of)h(the)g(source)g(\002le\227typically)f
(with)555 4220 y(the)k(same)h(base)f(name)g(b)n(ut)g(a)h(dif)n(ferent)d
(e)o(xtension.)34 b(When)23 b(the)f(compiled)f(\002le)i(is)g(loaded,)
555 4324 y Fs(compiled-functio)o(n-p)10 b FA(should)k(return)h(true)h
(for)f(all)h(the)g(functions)e(de\002ned)h(in)h(the)g(\002le.)680
4429 y(Later)d(chapters)g(will)g(depend)g(on)g(an)o(oth)o(er)g(ef)m
(fect)g(o)o(f)g(co)o(mp)o(ilation:)20 b(when)13 b(one)g(function)555
4533 y(occurs)k(within)h(another)e(function,)h(and)g(the)h(containing)e
(function)g(is)j(compiled,)d(the)i(inner)p 555 4605 1074
4 v 645 4661 a Fl(3)675 4684 y Fr(An)e(e)o(xplanation)21
b(of)c(why)f(it)i(is)f(bad)g(to)h(call)g Fk(eval)g Fr(e)o(xplicitly)i
(appears)f(on)e(page)h(278.)645 4742 y Fl(4)675 4766
y Fr(It')l(s)13 b(ok)g(to)g(ha)o(v)o(e)h(this)f(code)h(in)g(a)f(\002le)
g(and)h(then)g(compile)g(the)g(\002le.)23 b(The)13 b(restriction)j(is)d
(imposed)g(on)g(interpreted)555 4849 y(code)g(for)e(implementation)k
(reasons,)e(not)f(because)i(there')l(s)f(an)o(ything)g(wrong)f(with)g
(de\002ning)h(functions)h(in)d(distinct)555 4932 y(le)o(xical)20
b(en)m(vironments.)p eop
%%Page: 26 39
26 38 bop 555 538 a FA(26)1091 b Fu(FUNCTIONS)555 801
y FA(function)23 b(will)i(also)f(get)h(compiled.)40 b(C)p
Fr(L)-6 b(TL)p FA(2)23 b(does)h(not)g(seem)g(to)h(say)f(e)o(xplicitly)g
(that)g(this)555 905 y(will)d(happen,)d(b)n(ut)i(in)h(a)f(decent)g
(implementation)e(you)h(can)h(count)f(on)h(it.)680 1010
y(The)i(compiling)g(of)h(inner)f(functions)g(becomes)h(e)n(vident)f(in)
h(functions)f(which)h(return)555 1114 y(functions.)62
b(When)32 b Fs(make-adder)c FA(\(page)j(18\))g(is)i(compiled,)f(it)h
(will)f(return)f(compiled)555 1219 y(functions:)555 1402
y Fs(>)43 b(\(compile)d('make-adder\))555 1501 y(MAKE-ADDER)555
1601 y(>)j(\(compiled-functio)o(n-)o(p)37 b(\(make-adder)j(2\)\))555
1701 y(T)555 1888 y FA(As)20 b(later)f(chapters)f(will)i(sho)n(w)-5
b(,)19 b(this)g(f)o(act)h(is)g(of)f(great)f(importance)f(in)j(the)f
(implementation)555 1993 y(of)28 b(embedded)e(languages.)51
b(If)28 b(a)h(ne)n(w)f(language)e(is)j(implemented)e(by)g
(transformation,)555 2097 y(and)k(the)g(transformation)e(code)h(is)j
(compiled,)f(then)f(it)h(yields)f(compiled)f(output\227and)555
2202 y(so)h(becomes)f(in)h(ef)n(fect)f(a)h(compiler)f(for)g(the)h(ne)n
(w)f(language.)60 b(\(A)30 b(simple)h(e)o(xample)f(is)555
2307 y(described)19 b(on)h(page)f(81.\))680 2411 y(If)28
b(we)g(ha)n(v)o(e)g(a)g(particularly)f(small)h(function,)g(we)h(may)f
(w)o(ant)g(to)g(request)g(that)g(it)h(be)555 2516 y(compiled)23
b(inline.)40 b(Otherwise,)25 b(the)f(machinery)e(of)i(calling)f(it)i
(could)e(entail)h(more)g(ef)n(fort)555 2620 y(than)c(the)g(function)e
(itself.)30 b(If)20 b(we)h(de\002ne)e(a)i(function:)555
2803 y Fs(\(defun)41 b(50th)h(\(lst\))g(\(nth)f(49)i(lst\)\))555
2991 y FA(and)20 b(mak)o(e)f(the)i(declaration:)555 3173
y Fs(\(proclaim)40 b('\(inline)g(50th\)\))555 3361 y
FA(then)25 b(a)g(reference)f(to)h Fs(50th)f FA(within)h(a)h(compiled)d
(function)h(should)g(no)g(longer)g(require)g(a)555 3466
y(real)c(function)f(call.)29 b(If)20 b(we)h(de\002ne)f(and)f(compile)g
(a)i(function)e(which)g(calls)i Fs(50th)p FA(,)555 3648
y Fs(\(defun)41 b(foo)h(\(lst\))642 3748 y(\(+)h(\(50th)e(lst\))h
(1\)\))555 3936 y FA(then)24 b(when)g Fs(foo)g FA(is)i(compiled,)e(the)
h(code)f(for)g Fs(50th)g FA(should)g(be)g(compiled)f(right)i(into)f
(it,)555 4040 y(just)d(as)g(if)f(we)h(had)e(written)555
4223 y Fs(\(defun)41 b(foo)h(\(lst\))642 4322 y(\(+)h(\(nth)f(49)h
(lst\))f(1\)\))555 4510 y FA(in)31 b(the)g(\002rst)g(place.)61
b(The)31 b(dra)o(wback)e(is)i(that)g(if)h(we)f(rede\002ne)f
Fs(50th)p FA(,)i(we)f(also)g(ha)n(v)o(e)f(to)555 4615
y(recompile)21 b Fs(foo)p FA(,)g(or)h(it)h(will)g(still)g(re\003ect)f
(the)g(old)g(de\002nition.)34 b(The)22 b(restrictions)f(on)h(inline)555
4719 y(functions)d(are)h(basically)g(the)g(same)g(as)h(those)f(on)g
(macros)g(\(see)g(Section)g(7.9\).)-2410 b Fq(\016)p
eop
%%Page: 27 40
27 39 bop 555 538 a Ft(2.10)866 b Fu(FUNCTIONS)19 b(FR)n(OM)f(LISTS)890
b FA(27)555 801 y Fw(2.10)99 b(Functions)26 b(fr)n(om)f(Lists)555
991 y FA(In)14 b(some)h(earlier)f(dialects)h(of)f(Lisp,)i(functions)d
(were)i(represented)e(as)i(lists.)29 b(This)15 b(ga)n(v)o(e)e(Lisp)555
1096 y(programs)25 b(the)i(remarkable)e(ability)i(to)g(write)g(and)g(e)
o(x)o(ecute)e(their)i(o)n(wn)g(Lisp)g(programs.)555 1200
y(In)d(Common)f(Lisp,)i(functions)d(are)i(no)g(longer)f(made)g(of)h
(lists\227good)f(implementations)555 1305 y(compile)k(them)h(into)g
(nati)n(v)o(e)f(machine)h(code.)52 b(But)29 b(you)e(can)h(still)i
(write)e(programs)e(that)555 1410 y(write)20 b(programs,)e(because)i
(lists)i(are)e(the)g(input)f(to)i(the)f(compiler)-5 b(.)680
1514 y(It)36 b(cannot)g(be)g(o)o(v)o(eremphasized)d(ho)n(w)j(important)
f(it)i(is)g(that)g(Lisp)f(programs)f(can)555 1619 y(write)g(Lisp)f
(programs,)i(especially)e(since)h(this)g(f)o(act)f(is)i(so)e(often)g(o)
o(v)o(erlook)o(ed.)69 b(Ev)o(en)555 1723 y(e)o(xperienced)17
b(Lisp)k(users)f(rarely)f(realize)h(the)g(adv)n(antages)e(the)o(y)h
(deri)n(v)o(e)g(from)g(this)i(feature)555 1828 y(of)27
b(the)g(language.)47 b Ft(This)28 b FA(is)f(why)f(Lisp)h(macros)g(are)f
(so)i(po)n(werful,)e(for)g(e)o(xample.)48 b(Most)555
1933 y(of)23 b(the)g(techniques)e(described)h(in)h(this)g(book)f
(depend)f(on)i(the)g(ability)f(to)h(write)g(programs)555
2037 y(which)d(manipulate)e(Lisp)j(e)o(xpressions.)p
eop
%%Page: 28 41
28 40 bop 555 1610 a Fn(3)p 555 1872 2686 3 v 555 2131
a Fx(Functional)43 b(Pr)m(ogramming)555 2568 y FA(The)27
b(pre)n(vious)e(chapter)h(e)o(xplained)f(ho)n(w)i(Lisp)g(and)f(Lisp)h
(programs)f(are)h(both)f(b)n(uilt)h(out)555 2672 y(of)f(a)h(single)g
(ra)o(w)f(material:)42 b(the)27 b(function.)47 b(Lik)o(e)26
b(an)o(y)g(b)n(uilding)f(material,)j(its)g(qualities)555
2777 y(in\003uence)19 b(both)g(the)i(kinds)e(of)h(things)g(we)h(b)n
(uild,)e(and)h(the)g(w)o(ay)g(we)h(b)n(uild)f(them.)680
2882 y(This)35 b(chapter)f(describes)g(the)h(kind)f(of)h(construction)e
(methods)h(which)g(pre)n(v)n(ail)g(in)555 2986 y(the)26
b(Lisp)g(w)o(orld.)46 b(The)25 b(sophistication)g(of)h(these)g(methods)
e(allo)n(ws)j(us)f(to)g(attempt)f(more)555 3091 y(ambitious)30
b(kinds)h(of)g(programs.)61 b(The)31 b(ne)o(xt)g(chapter)f(will)i
(describe)e(one)h(particularly)555 3195 y(important)e(class)j(of)e
(programs)f(which)i(become)e(possible)h(in)h(Lisp:)51
b(programs)29 b(which)555 3300 y(e)n(v)n(olv)o(e)19 b(instead)h(of)g
(being)f(de)n(v)o(eloped)f(by)i(the)g(old)g(plan\255and\255implement)c
(method.)555 3553 y Fw(3.1)99 b(Functional)26 b(Design)555
3743 y FA(The)18 b(character)f(of)h(an)g(object)g(is)i(in\003uenced)c
(by)i(the)h(elements)f(from)f(which)h(it)h(is)g(made.)28
b(A)555 3848 y(w)o(ooden)22 b(b)n(uilding)f(looks)i(dif)n(ferent)e
(from)h(a)i(stone)e(one,)h(for)g(e)o(xample.)36 b(Ev)o(en)22
b(when)g(you)555 3953 y(are)h(too)f(f)o(ar)h(a)o(w)o(ay)f(to)h(see)g(w)
o(ood)f(or)h(stone,)g(you)f(can)g(tell)i(from)e(the)g(o)o(v)o(erall)g
(shape)g(of)h(the)555 4057 y(b)n(uilding)15 b(what)i(it')-5
b(s)18 b(made)e(of.)28 b(The)16 b(character)f(of)i(Lisp)g(functions)e
(has)i(a)g(similar)g(in\003uence)555 4162 y(on)j(the)g(structure)f(of)h
(Lisp)h(programs.)680 4266 y Ft(Functional)j(pr)l(o)o(gr)o(amming)i
FA(means)g(writing)h(programs)e(which)h(w)o(ork)g(by)h(returning)555
4371 y(v)n(alues)34 b(instead)f(of)h(by)g(performing)d(side\255ef)n
(fects.)69 b(Side\255ef)n(fects)33 b(include)g(destructi)n(v)o(e)555
4476 y(changes)20 b(to)h(objects)f(\(e.g.)g(by)h Fs(rplaca)p
FA(\))d(and)j(assignments)f(to)h(v)n(ariables)f(\(e.g.)g(by)g
Fs(setq)p FA(\).)555 4580 y(If)27 b(side\255ef)n(fects)f(are)h(fe)n(w)g
(and)f(localized,)i(programs)d(become)h(easier)h(to)g(read,)h(test,)h
(and)555 4685 y(deb)n(ug.)44 b(Lisp)26 b(programs)e(ha)n(v)o(e)h(not)g
(al)o(w)o(ays)h(been)f(written)g(in)h(this)g(style,)i(b)n(ut)d(o)o(v)o
(er)f(time)555 4789 y(Lisp)c(and)g(functional)e(programming)f(ha)n(v)o
(e)j(gradually)e(become)h(inseparable.)680 4894 y(An)28
b(e)o(xample)e(will)j(sho)n(w)e(ho)n(w)h(functional)e(programming)f
(dif)n(fers)i(from)g(what)g(you)555 4999 y(might)20 b(do)g(in)g
(another)f(language.)28 b(Suppose)19 b(for)h(some)g(reason)f(we)i(w)o
(ant)f(the)h(elements)f(of)1856 5229 y(28)p eop
%%Page: 29 42
29 41 bop 555 538 a Ft(3.1)948 b Fu(FUNCTION)n(AL)19
b(DESIGN)931 b FA(29)p 555 745 2678 4 v 553 1768 4 1023
v 605 888 a Fs(\(defun)41 b(bad-reverse)e(\(lst\))692
988 y(\(let*)j(\(\(len)f(\(length)g(lst\)\))997 1087
y(\(ilimit)g(\(truncate)f(\(/)i(len)h(2\)\)\)\))779 1187
y(\(do)g(\(\(i)f(0)h(\(1+)f(i\)\))997 1287 y(\(j)h(\(1-)f(len\))g(\(1-)
g(j\)\)\))954 1386 y(\(\(>=)f(i)j(ilimit\)\))866 1486
y(\(rotatef)d(\(nth)h(i)h(lst\))f(\(nth)g(j)h(lst\)\)\)\)\))1259
1690 y FA(Figure)19 b(3.1:)29 b(A)21 b(function)d(to)j(re)n(v)o(erse)e
(lists.)p 3231 1768 V 555 1772 2678 4 v 555 1994 a(a)h(list)h(in)e(the)
h(re)n(v)o(erse)e(order)-5 b(.)28 b(Instead)19 b(of)g(writing)g(a)h
(function)e(to)h(re)n(v)o(erse)g(lists,)i(we)e(write)h(a)555
2099 y(function)c(which)h(tak)o(es)g(a)h(list,)h(and)e(returns)f(a)i
(list)h(with)e(the)h(same)f(elements)h(in)f(the)h(re)n(v)o(erse)555
2203 y(order)-5 b(.)680 2308 y(Figure)27 b(3.1)h(contains)f(a)i
(function)d(to)i(re)n(v)o(erse)f(lists.)55 b(It)28 b(treats)h(the)f
(list)h(as)g(an)f(array)-5 b(,)555 2412 y(re)n(v)o(ersing)18
b(it)j(in)g(place;)f(its)h(return)e(v)n(alue)g(is)i(irrele)n(v)n(ant:)
555 2593 y Fs(>)43 b(\(setq)f(lst)g('\(a)g(b)i(c\)\))555
2692 y(\(A)f(B)g(C\))555 2792 y(>)g(\(bad-reverse)c(lst\))555
2892 y(NIL)555 2991 y(>)k(lst)555 3091 y(\(C)g(B)g(A\))555
3276 y FA(As)26 b(its)g(name)f(suggests,)i Fs(bad-reverse)21
b FA(is)26 b(f)o(ar)f(from)g(good)f(Lisp)h(style.)45
b(Moreo)o(v)o(er)m(,)24 b(its)555 3381 y(ugliness)14
b(is)i(contagious:)25 b(because)14 b(it)h(w)o(orks)f(by)h(side\255ef)n
(fects,)f(it)i(will)f(also)g(dra)o(w)f(its)h(callers)555
3485 y(a)o(w)o(ay)20 b(from)f(the)h(functional)f(ideal.)680
3590 y(Though)i(cast)j(in)f(the)h(role)f(of)g(the)g(villain,)h
Fs(bad-reverse)19 b FA(does)24 b(ha)n(v)o(e)e(one)h(merit:)36
b(it)555 3695 y(sho)n(ws)26 b(the)h(Common)e(Lisp)h(idiom)g(for)g(sw)o
(apping)f(tw)o(o)h(v)n(alues.)48 b(The)26 b Fs(rotatef)e
FA(macro)555 3799 y(rotates)k(the)h(v)n(alues)f(of)g(an)o(y)f(number)g
(of)h(generalized)f(v)n(ariables\227that)g(is,)k(e)o(xpressions)555
3904 y(you)15 b(could)h(gi)n(v)o(e)f(as)j(the)e(\002rst)h(ar)o(gument)d
(to)j Fs(setf)p FA(.)26 b(When)16 b(applied)g(to)g(just)h(tw)o(o)g(ar)o
(guments,)555 4008 y(the)j(ef)n(fect)g(is)h(to)f(sw)o(ap)h(them.)680
4113 y(In)27 b(contrast,)i(Figure)e(3.2)h(sho)n(ws)f(a)i(function)d
(which)h(returns)g(re)n(v)o(ersed)g(lists.)53 b(W)m(ith)555
4218 y Fs(good-reverse)p FA(,)14 b(we)19 b(get)g(the)g(re)n(v)o(ersed)e
(list)i(as)h(the)e(return)g(v)n(alue;)g(the)h(original)f(list)h(is)h
(not)555 4322 y(touched.)555 4503 y Fs(>)43 b(\(setq)f(lst)g('\(a)g(b)i
(c\)\))555 4602 y(\(A)f(B)g(C\))555 4702 y(>)g(\(good-reverse)38
b(lst\))555 4801 y(\(C)43 b(B)g(A\))555 4901 y(>)g(lst)555
5001 y(\(A)g(B)g(C\))p eop
%%Page: 30 43
30 42 bop 555 538 a FA(30)833 b Fu(FUNCTION)n(AL)18 b(PR)n(OGRAMMING)p
555 745 2678 4 v 553 1669 4 924 v 605 888 a Fs(\(defun)41
b(good-reverse)e(\(lst\))692 988 y(\(labels)i(\(\(rev)g(\(lst)h(acc\))
1171 1087 y(\(if)h(\(null)e(lst\))1346 1187 y(acc)1346
1287 y(\(rev)h(\(cdr)g(lst\))g(\(cons)f(\(car)h(lst\))g(acc\)\)\)\)\))
779 1386 y(\(rev)g(lst)g(nil\)\)\))1129 1591 y FA(Figure)19
b(3.2:)29 b(A)21 b(function)d(to)i(return)f(re)n(v)o(ersed)g(lists.)p
3231 1669 V 555 1672 2678 4 v 680 1896 a(It)j(used)f(to)h(be)g(thought)
e(that)i(you)f(could)g(judge)g(someone')-5 b(s)21 b(character)f(by)i
(looking)e(at)555 2001 y(the)25 b(shape)g(of)g(his)h(head.)44
b(Whether)25 b(or)g(not)g(this)g(is)i(true)e(of)g(people,)g(it)h(is)g
(generally)e(true)555 2105 y(of)i(Lisp)g(programs.)45
b(Functional)25 b(programs)g(ha)n(v)o(e)g(a)i(dif)n(ferent)d(shape)i
(from)f(imperati)n(v)o(e)555 2210 y(ones.)k(The)19 b(structure)g(in)h
(a)g(functional)f(program)e(comes)j(entirely)f(from)g(the)g
(composition)555 2315 y(of)29 b(ar)o(guments)e(within)i(e)o
(xpressions,)h(and)f(since)g(ar)o(guments)e(are)j(indented,)f
(functional)555 2419 y(code)18 b(will)h(sho)n(w)g(more)f(v)n(ariation)f
(in)i(indentation.)27 b(Functional)17 b(code)h(looks)h(\003uid)2985
2389 y Fm(1)3036 2419 y FA(on)g(the)555 2524 y(page;)h(imperati)n(v)o
(e)e(code)i(looks)f(solid)i(and)e(blockish,)g(lik)o(e)h(Basic.)680
2628 y(Ev)o(en)g(from)g(a)h(distance,)g(the)g(shapes)g(of)g
Fs(bad-)f FA(and)h Fs(good-reverse)16 b FA(suggest)21
b(which)555 2733 y(is)29 b(the)f(better)g(program.)51
b(And)28 b(despite)g(being)f(shorter)m(,)i Fs(good-reverse)24
b FA(is)29 b(also)f(more)555 2838 y(ef)n(\002cient:)h
Ft(O\(n)p FA(\))20 b(instead)f(of)h Ft(O\(n)1531 2807
y Fm(2)1564 2838 y Ft(\))p FA(.)680 2942 y(W)-7 b(e)32
b(are)g(spared)e(the)i(trouble)e(of)h(writing)g Fs(reverse)f
FA(because)g(Common)h(Lisp)g(has)555 3047 y(it)j(b)n(uilt\255in.)70
b(It)34 b(is)g(w)o(orth)f(looking)f(brie\003y)i(at)g(this)g(function,)h
(because)e(it)i(is)f(one)f(that)555 3151 y(often)23 b(brings)h(to)g
(the)g(surf)o(ace)g(misconceptions)e(about)h(functional)g(programming.)
38 b(Lik)o(e)555 3256 y Fs(good-reverse)p FA(,)9 b(the)k(b)n
(uilt\255in)g Fs(reverse)g FA(w)o(orks)g(by)g(r)o(etur)o(nin)o(g)g(a)g
(v)m(alue\227it)g(d)o(oesn)o(')n(t)g(touc)o(h)555 3361
y(its)24 b(ar)o(guments.)36 b(But)24 b(people)e(learning)g(Lisp)h(may)g
(assume)g(that,)h(lik)o(e)f Fs(bad-reverse)p FA(,)d(it)555
3465 y(w)o(orks)27 b(by)g(side\255ef)n(fects.)50 b(If)28
b(in)f(some)h(part)f(of)g(a)h(program)d(the)o(y)i(w)o(ant)h(a)g(list)g
Fs(lst)f FA(to)h(be)555 3570 y(re)n(v)o(ersed,)18 b(the)o(y)i(may)g
(write)555 3753 y Fs(\(reverse)40 b(lst\))555 3940 y
FA(and)20 b(w)o(onder)f(why)h(the)g(call)h(seems)g(to)g(ha)n(v)o(e)f
(no)g(ef)n(fect.)30 b(In)20 b(f)o(act,)h(if)f(we)h(w)o(ant)g
Ft(ef)o(fects)g FA(from)555 4045 y(such)26 b(a)h(function,)g(we)f(ha)n
(v)o(e)g(to)h(see)g(to)g(it)g(ourselv)o(es)f(in)h(the)f(calling)g
(code.)48 b(That)26 b(is,)j(we)555 4149 y(need)20 b(to)g(write)555
4332 y Fs(\(setq)42 b(lst)g(\(reverse)e(lst\)\))555 4520
y FA(instead.)g(Operators)23 b(lik)o(e)h Fs(reverse)e
FA(are)i(intended)f(to)h(be)g(called)f(for)h(return)f(v)n(alues,)h(not)
555 4624 y(side\255ef)n(fects.)k(It)18 b(is)i(w)o(orth)e(writing)f
(your)h(o)n(wn)f(programs)g(in)i(this)g(style)f(too\227not)g(only)f
(for)555 4729 y(its)27 b(inherent)e(bene\002ts,)j(b)n(ut)e(because,)h
(if)f(you)g(don')o(t,)g(you)f(will)i(be)f(w)o(orking)f(against)h(the)
555 4833 y(language.)p 555 4905 1074 4 v 645 4961 a Fl(1)675
4984 y Fr(F)o(or)16 b(a)i(characteristic)j(e)o(xample,)d(see)g(page)g
(242.)p eop
%%Page: 31 44
31 43 bop 555 538 a Ft(3.1)948 b Fu(FUNCTION)n(AL)19
b(DESIGN)931 b FA(31)680 801 y(One)14 b(of)h(the)g(points)g(we)g
(ignored)f(in)h(the)g(comparison)e(of)i Fs(bad-)e FA(and)i
Fs(good-reverse)c FA(is)555 905 y(that)18 b Fs(bad-reverse)13
b FA(doesn')o(t)j(cons.)28 b(Instead)17 b(of)g(b)n(uilding)f(ne)n(w)h
(list)h(structure,)f(it)h(operates)555 1010 y(on)24 b(the)h(original)f
(list.)44 b(This)25 b(can)g(be)g(dangerous\227the)d(list)k(could)e(be)h
(needed)e(else)n(where)555 1114 y(in)31 b(the)f(program\227b)n(ut)e
(for)i(ef)n(\002cienc)o(y)f(it)j(is)f(sometimes)f(necessary)-5
b(.)60 b(F)o(or)30 b(such)g(cases,)555 1219 y(Common)19
b(Lisp)h(pro)o(vides)f(an)h Ft(O\(n\))f FA(destructi)n(v)o(e)g(re)n(v)o
(ersing)f(function)h(called)h Fs(nreverse)p FA(.)65 b
Fq(\016)680 1324 y FA(A)13 b(destructi)n(v)o(e)g(function)g(is)g(one)g
(that)g(can)g(alter)g(the)f(ar)o(g)o(um)o(ents)h(pa)o(ssed)g(to)g(it.)
22 b(Ho)n(we)n(v)o(er)m(,)555 1428 y(e)n(v)o(en)e(destructi)n(v)o(e)f
(functions)g(usually)h(w)o(ork)h(by)f(returning)f(v)n(alues:)30
b(you)20 b(ha)n(v)o(e)g(to)h(assume)555 1533 y(that)27
b Fs(nreverse)d FA(will)j(rec)o(ycle)f(lists)i(you)e(gi)n(v)o(e)g(to)g
(it)i(as)f(ar)o(guments,)f(b)n(ut)h(you)f(still)i(can')o(t)555
1638 y(assume)d(that)g(it)g(will)h(re)n(v)o(erse)d(them.)43
b(As)26 b(before,)e(the)h(re)n(v)o(ersed)e(list)j(has)f(to)g(be)f
(found)f(in)555 1742 y(the)d(return)f(v)n(alue.)29 b(Y)-9
b(ou)19 b(still)j(can')o(t)d(write)555 1915 y Fs(\(nreverse)40
b(lst\))555 2092 y FA(in)19 b(the)g(middle)f(of)h(a)g(function)e(and)i
(assume)f(that)h(afterw)o(ards)f Fs(lst)h FA(will)g(be)g(re)n(v)o
(ersed.)27 b(This)555 2197 y(is)21 b(what)f(happens)f(in)h(most)h
(implementations:)555 2369 y Fs(>)43 b(\(setq)f(lst)g('\(a)g(b)i(c\)\))
555 2469 y(\(A)f(B)g(C\))555 2569 y(>)g(\(nreverse)d(lst\))555
2668 y(\(C)j(B)g(A\))555 2768 y(>)g(lst)555 2868 y(\(A\))555
3045 y FA(T)-7 b(o)21 b(re)n(v)o(erse)e Fs(lst)p FA(,)h(you)g(ha)n(v)o
(e)g(w)o(ould)g(ha)n(v)o(e)g(to)h(set)g Fs(lst)f FA(to)h(the)g(return)e
(v)n(alue,)h(as)h(with)g(plain)555 3150 y Fs(reverse)p
FA(.)680 3254 y(If)29 b(a)i(function)d(is)j(adv)o(ertised)e(as)h
(destructi)n(v)o(e,)h(that)f(doesn')o(t)f(mean)g(that)h(it')-5
b(s)31 b(meant)555 3359 y(to)25 b(be)g(called)g(for)g(side\255ef)n
(fects.)43 b(The)24 b(danger)g(is,)j(some)e(destructi)n(v)o(e)f
(functions)f(gi)n(v)o(e)i(the)555 3464 y(impression)19
b(that)h(the)o(y)g(are.)29 b(F)o(or)20 b(e)o(xample,)555
3636 y Fs(\(nconc)41 b(x)i(y\))555 3814 y Ft(almost)20
b FA(al)o(w)o(ays)h(has)f(the)g(same)h(ef)n(fect)e(as)555
3986 y Fs(\(setq)42 b(x)h(\(nconc)e(x)i(y\)\))555 4164
y FA(If)26 b(you)f(wrote)h(code)f(which)h(relied)f(on)h(the)g(former)f
(idiom,)h(it)h(might)e(seem)i(to)f(w)o(ork)f(for)555
4268 y(some)20 b(time.)29 b(Ho)n(we)n(v)o(er)m(,)18 b(it)j(w)o(ouldn')o
(t)e(do)g(what)h(you)g(e)o(xpected)e(when)i Fs(x)g FA(w)o(as)h
Fs(nil)p FA(.)680 4373 y(Only)14 b(a)i(fe)n(w)f(Lisp)h(operators)d(are)
i(intended)f(to)i(be)f(called)g(for)f(side\255ef)n(fects.)27
b(In)15 b(general,)555 4478 y(the)f(b)n(uilt\255in)f(operators)g(are)h
(meant)f(to)h(be)g(called)g(for)f(their)h(return)e(v)n(alues.)27
b(Don')o(t)13 b(be)h(misled)555 4582 y(by)k(names)g(lik)o(e)g
Fs(sort)p FA(,)f Fs(remove)p FA(,)g(or)g Fs(substitute)p
FA(.)25 b(If)18 b(you)g(w)o(ant)g(side\255ef)n(fects,)f(use)i
Fs(setq)555 4687 y FA(on)h(the)g(return)f(v)n(alue.)680
4791 y(This)13 b(v)o(ery)g(rule)g(suggests)g(that)g(some)g(side\255ef)n
(fects)g(are)g(ine)n(vitable.)22 b(Ha)n(ving)13 b(functional)555
4896 y(programming)26 b(as)k(an)g(ideal)f(doesn')o(t)g(imply)f(that)i
(programs)e(should)g(ne)n(v)o(er)h(ha)n(v)o(e)g(side\255)555
5001 y(ef)n(fects.)g(It)20 b(just)h(means)f(that)g(the)o(y)g(should)f
(ha)n(v)o(e)h(no)f(more)h(than)f(necessary)-5 b(.)p eop
%%Page: 32 45
32 44 bop 555 538 a FA(32)833 b Fu(FUNCTION)n(AL)18 b(PR)n(OGRAMMING)
680 801 y FA(It)e(may)f(tak)o(e)i(time)f(to)g(de)n(v)o(elop)e(this)j
(habit.)27 b(One)16 b(w)o(ay)g(to)g(start)h(is)g(to)f(treat)g(the)g
(follo)n(wing)555 905 y(operators)j(as)i(if)f(there)g(were)g(a)g(tax)h
(on)e(their)h(use:)773 1065 y Fs(set)42 b(setq)g(setf)g(psetf)g(psetq)f
(incf)h(decf)g(push)g(pop)g(pushnew)773 1165 y(rplaca)f(rplacd)85
b(rotatef)40 b(shiftf)85 b(remf)42 b(remprop)84 b(remhash)680
1371 y FA(and)25 b(also)i Fs(let*)p FA(,)g(in)g(which)f(imperati)n(v)o
(e)f(programs)f(often)i(lie)h(concealed.)47 b(T)m(reating)555
1476 y(these)25 b(operators)e(as)i(taxable)f(is)i(only)d(proposed)g(as)
i(a)g(help)f(to)n(w)o(ard,)h(not)f(a)h(criterion)f(for)m(,)555
1580 y(good)19 b(Lisp)h(style.)30 b(Ho)n(we)n(v)o(er)m(,)18
b(this)j(alone)e(can)h(get)g(you)g(surprisingly)e(f)o(ar)-5
b(.)680 1685 y(In)18 b(other)f(languages,)g(one)h(of)g(the)g(most)g
(common)f(causes)h(of)g(side\255ef)n(fects)g(is)h(the)f(need)555
1789 y(for)25 b(a)h(function)e(to)i(return)e(multiple)h(v)n(alues.)45
b(If)26 b(functions)e(can)h(only)g(return)f(one)h(v)n(alue,)555
1894 y(the)o(y)d(ha)n(v)o(e)g(to)h(\223return\224)e(the)i(rest)g(by)g
(altering)f(their)g(parameters.)36 b(F)o(ortunately)-5
b(,)21 b(this)i(isn')o(t)555 1999 y(necessary)c(in)i(Common)e(Lisp,)h
(because)f(an)o(y)h(function)e(can)i(return)f(multiple)h(v)n(alues.)680
2103 y(The)27 b(b)n(uilt\255in)g(function)f Fs(truncate)f
FA(returns)h(tw)o(o)i(v)n(alues,)h(for)e(e)o(xample\227the)f(trun\255)
555 2208 y(cated)18 b(inte)o(ger)m(,)g(and)g(what)h(w)o(as)g(cut)g(of)n
(f)f(in)h(order)e(to)i(create)g(it.)29 b(A)20 b(typical)e
(implementation)555 2312 y(will)j(print)f(both)f(when)g
Fs(truncate)f FA(is)j(called)f(at)h(the)f(tople)n(v)o(el:)555
2495 y Fs(>)43 b(\(truncate)d(26.21875\))555 2595 y(26)555
2694 y(0.21875)555 2882 y FA(When)20 b(the)g(calling)g(code)f(only)h(w)
o(ants)g(one)g(v)n(alue,)f(the)i(\002rst)f(one)g(is)h(used:)555
3065 y Fs(>)43 b(\(=)g(\(truncate)d(26.21875\))g(26\))555
3164 y(T)555 3352 y FA(The)15 b(calling)g(code)g(can)h(catch)f(both)g
(return)f(v)n(alues)i(by)f(using)g(a)h Fs(multiple-value-b)o(ind)o
FA(.)555 3456 y(This)27 b(operator)e(tak)o(es)j(a)f(list)h(of)f(v)n
(ariables,)h(a)f(call,)i(and)e(a)g(body)f(of)g(code.)49
b(The)27 b(body)f(is)555 3561 y(e)n(v)n(aluated)19 b(with)h(the)g(v)n
(ariables)g(bound)e(to)i(the)h(respecti)n(v)o(e)e(return)g(v)n(alues)g
(from)h(the)g(call:)555 3744 y Fs(>)43 b(\(multiple-value-b)o(in)o(d)37
b(\(int)42 b(frac\))g(\(truncate)e(26.21875\))729 3843
y(\(list)i(int)g(frac\)\))555 3943 y(\(26)g(0.21875\))555
4131 y FA(Finally)-5 b(,)19 b(to)i(return)e(multiple)g(v)n(alues,)h(we)
g(use)h(the)f Fs(values)e FA(operator:)555 4313 y Fs(>)43
b(\(defun)e(powers)g(\(x\))729 4413 y(\(values)g(x)i(\(sqrt)f(x\))g
(\(expt)g(x)h(2\)\)\))555 4513 y(POWERS)555 4612 y(>)g
(\(multiple-value-b)o(in)o(d)37 b(\(base)42 b(root)g(square\))f
(\(powers)f(4\))729 4712 y(\(list)i(base)g(root)g(square\)\))555
4811 y(\(4)h(2.0)f(16\))p eop
%%Page: 33 46
33 45 bop 555 538 a Ft(3.2)898 b Fu(IMPERA)-7 b(TIVE)18
b(OUTSIDE)p Fv(\255)p Fu(IN)881 b FA(33)680 801 y(Functional)12
b(programming)e(is)k(a)g(good)e(idea)i(in)g(general.)25
b(It)14 b(is)h(a)f(particularly)e(good)g(idea)555 905
y(in)23 b(Lisp,)h(because)e(Lisp)h(has)g(e)n(v)n(olv)o(ed)e(to)i
(support)f(it.)38 b(Built\255in)22 b(operators)g(lik)o(e)h
Fs(reverse)555 1010 y FA(and)j Fs(nreverse)e FA(are)i(meant)g(to)h(be)f
(used)h(in)f(this)h(w)o(ay)-5 b(.)48 b(Other)26 b(operators,)h(lik)o(e)
f Fs(values)555 1114 y FA(and)18 b Fs(multiple-value-b)o(ind)o
FA(,)13 b(ha)n(v)o(e)18 b(been)g(pro)o(vided)e(speci\002cally)j(to)f
(mak)o(e)g(functional)555 1219 y(programming)f(easier)-5
b(.)555 1472 y Fw(3.2)99 b(Imperati)o(v)o(e)25 b(Outside\255In)555
1662 y FA(The)30 b(aims)g(of)g(functional)f(programming)e(may)i(sho)n
(w)h(more)g(clearly)f(when)h(contrasted)555 1767 y(with)17
b(those)f(of)h(the)f(more)g(common)f(approach,)g(imperati)n(v)o(e)g
(programming.)24 b(A)17 b(functional)555 1872 y(program)k(tells)k(you)d
(what)i(it)g(w)o(ants;)h(an)f(imperati)n(v)o(e)d(program)h(tells)i(you)
f(what)g(to)h(do.)38 b(A)555 1976 y(functional)20 b(program)g(says)j
(\223Return)e(a)i(list)g(of)f Fs(a)g FA(and)g(the)g(square)f(of)h(the)g
(\002rst)h(element)f(of)555 2081 y Fs(x)p FA(:\224)555
2263 y Fs(\(defun)41 b(fun)h(\(x\))642 2363 y(\(list)g('a)g(\(expt)g
(\(car)g(x\))h(2\)\)\))555 2551 y FA(An)15 b(imperati)n(v)o(e)f
(programs)f(says)j(\223Get)g(the)f(\002rst)h(element)f(of)g
Fs(x)p FA(,)h(then)f(square)f(it,)j(then)e(return)555
2655 y(a)21 b(list)g(of)f Fs(a)g FA(and)g(the)g(square:\224)555
2838 y Fs(\(defun)41 b(imp)h(\(x\))642 2938 y(\(let)g(\(y)h(sqr\))729
3037 y(\(setq)f(y)h(\(car)f(x\)\))729 3137 y(\(setq)g(sqr)g(\(expt)g(y)
h(2\)\))729 3237 y(\(list)f('a)h(sqr\)\)\))555 3424 y
FA(Lisp)29 b(users)h(are)f(fortunate)e(in)j(being)e(able)h(to)h(write)f
(this)h(program)d(both)h(w)o(ays.)57 b(Some)555 3529
y(languages)17 b(are)h(only)f(suited)h(to)g(imperati)n(v)o(e)e
(programming\227notably)d(Basic,)19 b(along)e(with)555
3633 y(most)25 b(machine)f(languages.)42 b(In)25 b(f)o(act,)h(the)f
(de\002nition)f(of)h Fs(imp)f FA(is)i(similar)f(in)g(form)f(to)i(the)
555 3738 y(machine)19 b(language)g(code)g(that)h(most)h(Lisp)f
(compilers)f(w)o(ould)h(generate)f(for)g Fs(fun)p FA(.)680
3843 y(Why)32 b(write)i(such)f(code)f(when)h(the)g(compiler)f(could)g
(do)h(it)h(for)e(you?)68 b(F)o(or)33 b(man)o(y)555 3947
y(programmers,)16 b(this)k(question)f(does)g(not)g(e)n(v)o(en)f(arise.)
29 b(A)20 b(language)e(stamps)h(its)i(pattern)d(on)555
4052 y(our)f(thoughts:)27 b(someone)16 b(used)h(to)h(programming)c(in)k
(an)f(imperati)n(v)o(e)f(language)g(may)h(ha)n(v)o(e)555
4156 y(be)o(gun)e(to)i(concei)n(v)o(e)e(of)i(programs)e(in)i(imperati)n
(v)o(e)f(terms,)h(and)f(may)h(actually)f(\002nd)h(it)g(easier)555
4261 y(to)25 b(write)h(imperati)n(v)o(e)e(programs)f(than)i(functional)
f(ones.)44 b(This)25 b(habit)g(of)g(mind)g(is)h(w)o(orth)555
4366 y(o)o(v)o(ercoming)17 b(if)j(you)g(ha)n(v)o(e)f(a)i(language)d
(that)j(will)g(let)f(you.)680 4470 y(F)o(or)27 b(alumni)g(of)h(other)f
(languages,)h(be)o(ginning)d(to)j(use)g(Lisp)g(may)g(be)g(lik)o(e)g
(stepping)555 4575 y(onto)c(a)i(skating)e(rink)h(for)f(the)h(\002rst)h
(time.)45 b(It')-5 b(s)25 b(actually)g(much)f(easier)h(to)h(get)f
(around)e(on)555 4679 y(ice)f(than)f(it)h(is)g(on)f(dry)f(land\227)p
Ft(if)h FA(you)g(use)g(skates.)34 b(T)m(ill)22 b(then)e(you)h(will)h
(be)f(left)h(w)o(ondering)555 4784 y(what)e(people)f(see)i(in)f(this)h
(sport.)680 4889 y(What)i(skates)g(are)g(to)h(ice,)g(functional)d
(programming)e(is)24 b(to)g(Lisp.)38 b(T)-7 b(ogether)21
b(the)i(tw)o(o)555 4993 y(allo)n(w)h(you)g(to)g(tra)n(v)o(el)g(more)f
(gracefully)-5 b(,)23 b(with)i(less)g(ef)n(fort.)40 b(But)25
b(if)g(you)e(are)h(accustomed)p eop
%%Page: 34 47
34 46 bop 555 538 a FA(34)833 b Fu(FUNCTION)n(AL)18 b(PR)n(OGRAMMING)
555 801 y FA(to)35 b(another)e(mode)h(of)g(tra)n(v)o(el,)k(this)d(may)g
(not)f(be)h(your)e(e)o(xperience)g(at)i(\002rst.)73 b(One)35
b(of)555 905 y(the)27 b(obstacles)g(to)g(learning)e(Lisp)i(as)h(a)f
(second)f(language)f(is)j(learning)d(to)i(program)e(in)i(a)555
1010 y(functional)18 b(style.)680 1114 y(F)o(ortunately)24
b(there)j(is)g(a)h(trick)e(for)g(transforming)e(imperati)n(v)o(e)h
(programs)g(into)i(func\255)555 1219 y(tional)20 b(ones.)30
b(Y)-9 b(ou)20 b(can)h(be)o(gin)e(by)h(applying)f(this)i(trick)f(to)h
(\002nished)f(code.)29 b(Soon)20 b(you)g(will)555 1324
y(be)o(gin)h(to)i(anticipate)f(yourself,)g(and)g(transform)f(your)g
(code)h(as)h(you)f(write)h(it.)37 b(Soon)22 b(after)555
1428 y(that,)e(you)f(will)i(be)o(gin)e(to)i(concei)n(v)o(e)d(of)i
(programs)e(in)j(functional)d(terms)i(from)f(the)i(start.)680
1533 y(The)31 b(trick)h(is)h(to)f(realize)g(that)g(an)h(imperati)n(v)o
(e)d(program)g(is)j(a)f(functional)f(program)555 1638
y(turned)21 b(inside\255out.)33 b(T)-7 b(o)22 b(\002nd)f(the)h
(functional)e(program)g(implicit)i(in)g(our)f(imperati)n(v)o(e)f(one,)
555 1742 y(we)h(just)f(turn)g(it)h(outside\255in.)28
b(Let')-5 b(s)20 b(try)g(this)h(technique)e(on)g Fs(imp)p
FA(.)680 1847 y(The)e(\002rst)i(thing)f(we)g(notice)g(is)h(the)g
(creation)e(of)h Fs(y)g FA(and)g Fs(sqr)f FA(in)i(the)f(initial)g
Fs(let)p FA(.)28 b(This)19 b(is)555 1951 y(a)i(sign)g(that)g(bad)f
(things)h(are)f(to)h(follo)n(w)-5 b(.)30 b(Lik)o(e)21
b Fs(eval)f FA(at)h(runtime,)f(uninitialized)f(v)n(ariables)555
2056 y(are)j(so)h(rarely)f(needed)f(that)h(the)o(y)g(should)f
(generally)g(be)h(treated)g(as)h(a)g(symptom)e(of)h(some)555
2161 y(illness)29 b(in)g(the)f(program.)52 b(Such)28
b(v)n(ariables)g(are)g(often)g(used)g(lik)o(e)h(pins)f(which)g(hold)g
(the)555 2265 y(program)18 b(do)n(wn)h(and)h(k)o(eep)g(it)g(from)g
(coiling)f(into)h(its)h(natural)e(shape.)680 2370 y(Ho)n(we)n(v)o(er)m
(,)28 b(we)h(ignore)e(them)h(for)g(the)h(time)f(being,)i(and)e(go)g
(straight)g(to)g(the)h(end)f(of)555 2474 y(the)f(function.)46
b(What)27 b(occurs)f(last)i(in)e(an)h(imperati)n(v)o(e)e(program)f
(occurs)i(outermost)f(in)i(a)555 2579 y(functional)17
b(one.)28 b(So)19 b(our)e(\002rst)j(step)f(is)g(to)g(grab)e(the)i
(\002nal)g(call)g(to)g Fs(list)e FA(and)h(be)o(gin)f(stuf)n(\002ng)555
2684 y(the)i(rest)h(of)f(the)h(program)d(inside)i(it\227just)h(lik)o(e)
g(turning)e(a)h(shirt)h(inside\255out.)28 b(W)-7 b(e)20
b(continue)555 2788 y(by)d(applying)e(the)i(same)g(transformation)d
(repeatedly)-5 b(,)16 b(just)h(as)h(we)f(w)o(ould)f(with)i(the)f(slee)n
(v)o(es)555 2893 y(of)j(the)g(shirt,)g(and)g(in)g(turn)g(with)g(their)g
(cuf)n(fs.)680 2997 y(Starting)f(at)i(the)f(end,)g(we)g(replace)g
Fs(sqr)f FA(with)h Fs(\(expt)42 b(y)h(2\))p FA(,)20 b(yielding:)555
3180 y Fs(\(list)42 b('a)g(\(expt)g(y)h(2\)\)\))555 3368
y FA(Then)19 b(we)i(replace)e Fs(y)i FA(by)e Fs(\(car)42
b(x\))p FA(:)555 3550 y Fs(\(list)g('a)g(\(expt)g(\(car)g(x\))g(2\)\))
555 3738 y FA(No)n(w)27 b(we)h(can)g(thro)n(w)e(a)o(w)o(ay)i(the)f
(rest)h(of)f(the)h(code,)g(ha)n(ving)f(stuf)n(fed)f(it)j(all)f(into)f
(the)h(last)555 3843 y(e)o(xpression.)39 b(In)24 b(the)g(process)g(we)g
(remo)o(v)o(ed)e(the)i(need)f(for)h(the)g(v)n(ariables)f
Fs(y)i FA(and)e Fs(sqr)p FA(,)h(so)555 3947 y(we)d(can)f(discard)f(the)
h Fs(let)g FA(as)h(well.)680 4052 y(The)f(\002nal)i(result)f(is)h
(shorter)f(than)g(what)g(we)g(be)o(gan)f(with,)h(and)g(easier)h(to)f
(understand.)555 4156 y(In)h(the)h(original)f(code,)g(we')l(re)g(f)o
(aced)g(with)h(the)g(\002nal)g(e)o(xpression)e Fs(\(list)41
b('a)i(sqr\))p FA(,)22 b(and)555 4261 y(it')-5 b(s)20
b(not)e(immediately)f(clear)i(where)f(the)g(v)n(alue)g(of)g
Fs(sqr)g FA(comes)g(from.)28 b(No)n(w)18 b(the)h(source)f(of)555
4366 y(the)i(return)f(v)n(alue)h(is)h(laid)f(out)g(for)g(us)g(lik)o(e)h
(a)f(road)f(map.)680 4470 y(The)31 b(e)o(xample)g(in)i(this)f(section)g
(w)o(as)h(a)g(short)f(one,)i(b)n(ut)e(the)h(technique)d(scales)j(up.)
555 4575 y(Indeed,)38 b(it)e(becomes)f(more)g(v)n(aluable)g(as)h(it)h
(is)g(applied)e(to)h(lar)o(ger)e(functions.)75 b(Ev)o(en)555
4679 y(functions)30 b(which)h(perform)f(side\255ef)n(fects)h(can)g(be)h
(cleaned)e(up)h(in)h(the)g(portions)e(which)555 4784
y(don')o(t.)p eop
%%Page: 35 48
35 47 bop 555 538 a Ft(3.3)880 b Fu(FUNCTION)n(AL)19
b(INTERF)l(A)n(CES)861 b FA(35)555 801 y Fw(3.3)99 b(Functional)26
b(Interfaces)555 991 y FA(Some)21 b(side\255ef)n(fects)g(are)g(w)o
(orse)h(than)f(others.)33 b(F)o(or)21 b(e)o(xample,)f(though)g(this)i
(function)e(calls)555 1096 y Fs(nconc)555 1278 y(\(defun)41
b(qualify)g(\(expr\))642 1378 y(\(nconc)g(\(copy-list)f(expr\))h
(\(list)h('maybe\)\)\))555 1566 y FA(it)22 b(preserv)o(es)e
(referential)g(transparenc)o(y)-5 b(.)1762 1536 y Fm(2)1824
1566 y FA(If)21 b(you)g(call)g(it)h(with)g(a)f(gi)n(v)o(en)f(ar)o
(gument,)f(it)j(will)555 1670 y(al)o(w)o(ays)g(return)e(the)h(same)g
(\()p Fs(equal)p FA(\))e(v)n(alue.)32 b(From)21 b(the)g(caller')-5
b(s)22 b(point)e(of)h(vie)n(w)-5 b(,)21 b Fs(qualify)555
1775 y FA(might)c(as)h(well)f(be)g(purely)f(functional)g(code.)27
b(W)-7 b(e)19 b(can')o(t)d(say)h(the)h(same)f(for)g Fs(bad-reverse)555
1880 y FA(\(page)i(29\),)g(which)h(actually)g(modi\002es)f(its)j(ar)o
(gument.)680 1984 y(Instead)16 b(of)h(treating)f(all)h(side\255ef)n
(fects)f(as)i(equally)e(bad,)h(it)h(w)o(ould)e(be)h(helpful)f(if)h(we)g
(had)555 2089 y(some)g(w)o(ay)f(of)h(distinguishing)e(between)g(such)i
(cases.)29 b(Informally)-5 b(,)14 b(we)j(could)f(say)h(that)f(it')-5
b(s)555 2193 y(harmless)19 b(for)f(a)h(function)f(to)h(modify)e
(something)h(that)h(no)f(one)h(else)g(o)n(wns.)29 b(F)o(or)18
b(e)o(xample,)555 2298 y(the)23 b Fs(nconc)f FA(in)h
Fs(qualify)e FA(is)j(harmless)f(because)f(the)h(list)h(gi)n(v)o(en)e
(as)i(the)f(\002rst)h(ar)o(gument)d(is)555 2403 y(freshly)e(consed.)29
b(No)20 b(one)f(else)i(could)f(o)n(wn)f(it.)680 2507
y(In)i(the)g(general)f(case,)i(we)g(ha)n(v)o(e)f(to)g(talk)h(about)e(o)
n(wnership)g(not)h(by)g(functions,)f(b)n(ut)h(by)555
2612 y(in)m(v)n(ocations)e(of)h(functions.)27 b(Though)18
b(no)i(one)g(else)h(o)n(wns)e(the)i(v)n(ariable)e Fs(x)h
FA(here,)555 2794 y Fs(\(let)42 b(\(\(x)g(0\)\))642 2894
y(\(defun)f(total)h(\(y\))729 2994 y(\(incf)g(x)h(y\)\)\))555
3181 y FA(the)20 b(ef)n(fects)f(of)g(one)g(call)i(will)f(be)f(visible)h
(in)g(succeeding)e(ones.)29 b(So)19 b(the)h(rule)f(should)g(be:)29
b(a)555 3286 y(gi)n(v)o(en)19 b(in)m(v)n(ocation)f(can)i(safely)g
(modify)f(what)h(it)h(uniquely)d(o)n(wns.)680 3391 y(Who)i(o)n(wns)h
(ar)o(guments)d(and)i(return)g(v)n(alues?)30 b(The)20
b(con)m(v)o(ention)e(in)j(Lisp)g(seems)g(to)g(be)555
3495 y(that)e(an)f(in)m(v)n(ocation)f(o)n(wns)h(objects)g(it)h(recei)n
(v)o(es)f(as)h(return)f(v)n(alues,)g(b)n(ut)g(not)g(objects)h(passed)
555 3600 y(to)e(it)h(as)g(ar)o(guments.)26 b(Functions)16
b(that)h(modify)f(their)g(ar)o(guments)f(are)i(distinguished)f(by)h
(the)555 3704 y(label)j(\223destructi)n(v)o(e,)-6 b(\224)19
b(b)n(ut)h(there)g(is)h(no)f(special)g(name)f(for)h(functions)f(that)h
(modify)f(objects)555 3809 y(returned)f(to)j(them.)680
3909 y(This)f(function)e(adheres)i(to)g(the)g(con)m(v)o(ention,)d(for)j
(e)o(xample:)555 4075 y Fs(\(defun)41 b(ok)i(\(x\))642
4174 y(\(nconc)e(\(list)h('a)h(x\))f(\(list)g('c\)\)\))555
4345 y FA(It)23 b(calls)g Fs(nconc)p FA(,)f(which)g(doesn')o(t,)f(b)n
(ut)i(since)g(the)g(list)g(spliced)g(by)f Fs(nconc)f
FA(will)j(al)o(w)o(ays)f(be)555 4450 y(freshly)c(made)h(rather)f(than,)
h(say)-5 b(,)20 b(a)g(list)h(passed)g(to)f Fs(ok)g FA(as)h(an)f(ar)o
(gument,)d Fs(ok)j FA(itself)h(is)g(ok.)680 4550 y(If)f(it)g(were)h
(written)f(slightly)f(dif)n(ferently)-5 b(,)18 b(ho)n(we)n(v)o(er)m(,)
555 4716 y Fs(\(defun)41 b(not-ok)g(\(x\))642 4815 y(\(nconc)g(\(list)h
('a\))g(x)h(\(list)f('c\)\)\))p 555 4875 1074 4 v 645
4931 a Fl(2)675 4955 y Fr(A)16 b(de\002nition)j(of)e(referential)k
(transparenc)o(y)f(appears)e(on)f(page)h(198.)p eop
%%Page: 36 49
36 48 bop 555 538 a FA(36)833 b Fu(FUNCTION)n(AL)18 b(PR)n(OGRAMMING)
555 801 y FA(then)i(the)g(call)h(to)f Fs(nconc)f FA(w)o(ould)g(be)h
(modifying)e(an)i(ar)o(gument)e(passed)i(to)g Fs(not-ok)p
FA(.)680 905 y(Man)o(y)f(Lisp)h(programs)f(violate)h(this)h(con)m(v)o
(ention,)c(at)k(least)g(locally)-5 b(.)29 b(Ho)n(we)n(v)o(er)m(,)18
b(as)j(we)555 1010 y(sa)o(w)h(with)f Fs(ok)p FA(,)g(local)h(violations)
e(need)h(not)g(disqualify)f(the)h(calling)g(function.)31
b(And)21 b(func\255)555 1114 y(tions)g(which)g(do)g(meet)g(the)h
(preceding)d(conditions)h(will)i(retain)f(man)o(y)f(of)h(the)g(adv)n
(antages)555 1219 y(of)f(purely)f(functional)f(code.)680
1324 y(T)-7 b(o)23 b(write)g(programs)e(that)i(are)g(really)f
(indistinguishable)f(from)h(functional)f(code,)i(we)555
1428 y(ha)n(v)o(e)j(to)g(add)g(one)g(more)f(condition.)46
b(Functions)26 b(can')o(t)f(share)h(objects)g(with)h(other)e(code)555
1533 y(that)31 b(doesn')o(t)f(follo)n(w)g(the)h(rules.)61
b(F)o(or)31 b(e)o(xample,)h(though)d(this)i(function)f(doesn')o(t)f(ha)
n(v)o(e)555 1638 y(side\255ef)n(fects,)555 1825 y Fs(\(defun)41
b(anything)f(\(x\))642 1930 y(\(+)j(x)g(*anything*\)\))555
2117 y FA(its)33 b(return)d(v)n(alue)h(depends)f(on)h(the)g(global)g(v)
n(ariable)g Fs(*anything*)p FA(.)59 b(So)32 b(if)g(an)o(y)e(other)555
2222 y(function)18 b(can)i(alter)h(the)f(v)n(alue)f(of)h(this)h(v)n
(ariable,)e Fs(anything)e FA(could)j(return)f(an)o(ything.)680
2327 y(Code)i(written)h(so)h(that)f(each)f(in)m(v)n(ocation)g(only)g
(modi\002es)g(what)h(it)h(o)n(wns)f(is)h(almost)f(as)555
2431 y(good)15 b(as)h(purely)f(functional)f(code.)27
b(A)17 b(function)d(that)i(meets)h(all)f(the)g(preceding)e(conditions)
555 2536 y(at)25 b(least)g(presents)f(a)g(functional)f(interf)o(ace)g
(to)i(the)f(w)o(orld:)37 b(if)24 b(you)g(call)g(it)h(twice)g(with)g
(the)555 2640 y(same)h(ar)o(guments,)e(you)h(should)f(get)i(the)f(same)
h(results.)45 b(And)25 b(this,)i(as)g(the)e(ne)o(xt)g(section)555
2745 y(will)c(sho)n(w)-5 b(,)19 b(is)i(a)g(crucial)f(ingredient)e(in)i
(bottom\255up)e(programming.)680 2850 y(One)d(problem)g(with)h
(destructi)n(v)o(e)e(operations)h(is)i(that,)f(lik)o(e)h(global)e(v)n
(ariables,)h(the)o(y)f(can)555 2954 y(destro)o(y)21 b(the)g(locality)h
(of)f(a)h(program.)31 b(When)22 b(you')l(re)d(writing)i(functional)f
(code,)h(you)g(can)555 3059 y(narro)n(w)i(your)h(focus:)37
b(you)24 b(only)g(need)g(consider)f(the)i(functions)e(that)i(call,)h
(or)e(are)h(called)555 3163 y(by)-5 b(,)31 b(the)g(one)e(you')l(re)f
(writing.)58 b(This)31 b(bene\002t)e(disappears)g(when)h(you)f(w)o(ant)
h(to)g(modify)555 3268 y(something)19 b(destructi)n(v)o(ely)-5
b(.)27 b(It)20 b(could)f(be)h(used)g(an)o(ywhere.)680
3373 y(The)c(conditions)g(abo)o(v)o(e)f(do)i(not)f(guarantee)g(the)h
(perfect)f(locality)h(you)f(get)h(with)g(purely)555 3477
y(functional)g(code,)g(though)g(the)o(y)h(do)g(impro)o(v)o(e)e(things)i
(some)n(what.)27 b(F)o(or)18 b(e)o(xample,)g(suppose)555
3582 y(that)i Fs(f)h FA(calls)g Fs(g)f FA(as)h(belo)n(w:)555
3765 y Fs(\(defun)41 b(f)i(\(x\))642 3864 y(\(let)f(\(\(val)g(\(g)g
(x\)\)\))729 3964 y(;)i(safe)d(to)i(modify)e(val)i(here?)729
4063 y(\)\))555 4251 y FA(Is)28 b(it)h(safe)f(for)f Fs(f)h
FA(to)g(nconc)f(something)f(onto)h Fs(val)p FA(?)51 b(Not)28
b(if)g Fs(g)g FA(is)h Fs(identity)p FA(:)42 b(then)27
b(we)555 4356 y(w)o(ould)19 b(be)i(modifying)c(something)i(originally)g
(passed)h(as)h(an)f(ar)o(gument)e(to)i Fs(f)g FA(itself.)680
4460 y(So)26 b(e)n(v)o(en)f(in)h(programs)e(which)i(do)g(follo)n(w)f
(the)h(con)m(v)o(ention,)f(we)h(may)g(ha)n(v)o(e)f(to)h(look)555
4565 y(be)o(yond)j Fs(f)i FA(if)h(we)g(w)o(ant)f(to)g(modify)f
(something)g(there.)62 b(Ho)n(we)n(v)o(er)m(,)32 b(we)f(don')o(t)f(ha)n
(v)o(e)g(to)555 4669 y(look)23 b(as)h(f)o(ar:)36 b(instead)24
b(of)f(w)o(orrying)e(about)i(the)h(whole)f(program,)f(we)i(no)n(w)f
(only)f(ha)n(v)o(e)h(to)555 4774 y(consider)c(the)h(subtree)g(be)o
(ginning)d(with)k Fs(f)p FA(.)680 4879 y(A)16 b(corollary)e(of)i(the)g
(con)m(v)o(ention)d(abo)o(v)o(e)h(is)j(that)f(functions)e(shouldn')o(t)
g(return)h(an)o(ything)555 4983 y(that)24 b(isn')o(t)g(safe)g(to)h
(modify)-5 b(.)39 b(Thus)23 b(one)h(should)f(a)n(v)n(oid)h(writing)f
(functions)g(whose)h(return)p eop
%%Page: 37 50
37 49 bop 555 538 a Ft(3.4)825 b Fu(INTERA)n(CTIVE)17
b(PR)n(OGRAMMING)808 b FA(37)555 801 y(v)n(alues)23 b(incorporate)e
(quoted)h(objects.)38 b(If)23 b(we)h(de\002ne)f Fs(exclaim)e
FA(so)i(that)h(its)g(return)e(v)n(alue)555 905 y(incorporates)c(a)j
(quoted)d(list,)555 1088 y Fs(\(defun)41 b(exclaim)g(\(expression\))642
1188 y(\(append)g(expression)e('\(oh)j(my\)\)\))555 1375
y FA(Then)19 b(an)o(y)h(later)g(destructi)n(v)o(e)f(modi\002cation)f
(of)i(the)g(return)f(v)n(alue)555 1558 y Fs(>)43 b(\(exclaim)d
('\(lions)h(and)h(tigers)g(and)g(bears\)\))555 1657 y(\(LIONS)f(AND)h
(TIGERS)g(AND)g(BEARS)f(OH)i(MY\))555 1757 y(>)g(\(nconc)e(*)i
('\(goodness\)\))555 1857 y(\(LIONS)e(AND)h(TIGERS)g(AND)g(BEARS)f(OH)i
(MY)g(GOODNESS\))555 2039 y FA(could)19 b(alter)i(the)f(list)h(within)f
(the)g(function:)555 2205 y Fs(>)43 b(\(exclaim)d('\(fixnums)g(and)j
(bignums)d(and)j(floats\)\))555 2305 y(\(FIXNUMS)d(AND)j(BIGNUMS)d(AND)
j(FLOATS)e(OH)i(MY)f(GOODNESS\))555 2476 y FA(T)-7 b(o)20
b(mak)o(e)g Fs(exclaim)e FA(proof)h(against)g(such)h(problems,)f(it)h
(should)g(be)g(written:)555 2659 y Fs(\(defun)41 b(exclaim)g
(\(expression\))642 2758 y(\(append)g(expression)e(\(list)j('oh)g
('my\)\)\))680 2946 y FA(There)16 b(is)i(one)e(major)h(e)o(xception)e
(to)i(the)g(rule)g(that)g(functions)e(shouldn')o(t)g(return)h(quoted)
555 3051 y(lists:)58 b(the)34 b(functions)f(which)g(generate)g(macro)g
(e)o(xpansions.)69 b(Macro)33 b(e)o(xpanders)f(can)555
3155 y(safely)22 b(incorporate)e(quoted)h(lists)i(in)g(the)f(e)o
(xpansions)f(the)o(y)g(generate,)g(if)i(the)f(e)o(xpansions)555
3260 y(are)e(going)f(straight)h(to)g(the)g(compiler)-5
b(.)680 3364 y(Otherwise,)20 b(one)g(might)g(as)i(well)f(be)g(a)g
(suspicious)f(of)g(quoted)g(lists)i(generally)-5 b(.)29
b(Man)o(y)555 3469 y(other)15 b(uses)i(of)f(them)g(are)g(lik)o(ely)g
(to)h(be)f(something)f(which)h(ought)f(to)h(be)g(done)f(with)i(a)g
(macro)555 3574 y(lik)o(e)j Fs(in)g FA(\(page)g(152\).)555
3826 y Fw(3.4)99 b(Interacti)o(v)o(e)26 b(Pr)n(ogramming)555
4017 y FA(The)21 b(pre)n(vious)e(sections)i(presented)f(the)h
(functional)e(style)j(as)g(a)f(good)f(w)o(ay)h(of)g(or)o(ganizing)555
4122 y(programs.)26 b(But)18 b(it)f(is)h(more)e(than)h(this.)28
b(Lisp)17 b(programmers)d(did)j(not)g(adopt)e(the)i(functional)555
4226 y(style)k(purely)e(for)g(aesthetic)i(reasons.)29
b(The)o(y)19 b(use)i(it)g(because)e(it)i(mak)o(es)f(their)h(w)o(ork)e
(easier)-5 b(.)555 4331 y(In)20 b(Lisp')-5 b(s)20 b(dynamic)f(en)m
(vironment,)d(functional)i(programs)g(can)i(be)g(written)g(with)g
(unusual)555 4435 y(speed,)g(and)f(at)i(the)f(same)g(time,)h(can)f(be)g
(unusually)e(reliable.)680 4540 y(In)25 b(Lisp)g(it)i(is)f(comparati)n
(v)o(ely)d(easy)i(to)h(deb)n(ug)e(programs.)44 b(A)26
b(lot)f(of)h(information)d(is)555 4645 y(a)n(v)n(ailable)g(at)h
(runtime,)f(which)g(helps)h(in)g(tracing)e(the)i(causes)g(of)f(errors.)
39 b(But)24 b(e)n(v)o(en)e(more)555 4749 y(important)13
b(is)j(the)f(ease)g(with)g(which)g(you)f(can)g Ft(test)i
FA(programs.)26 b(Y)-9 b(ou)14 b(don')o(t)f(ha)n(v)o(e)h(to)i(compile)
555 4854 y(a)25 b(program)e(and)h(test)h(the)g(whole)f(thing)g(at)h
(once.)42 b(Y)-9 b(ou)24 b(can)h(test)g(functions)f(indi)n(vidually)555
4958 y(by)c(calling)g(them)f(from)g(the)i(tople)n(v)o(el)e(loop.)p
eop
%%Page: 38 51
38 50 bop 555 538 a FA(38)833 b Fu(FUNCTION)n(AL)18 b(PR)n(OGRAMMING)
680 801 y FA(Incremental)c(testing)i(is)h(so)f(v)n(aluable)f(that)h
(Lisp)h(style)f(has)h(e)n(v)n(olv)o(ed)d(to)i(tak)o(e)h(adv)n(antage)
555 905 y(of)h(it.)30 b(Programs)17 b(written)i(in)g(the)f(functional)f
(style)i(can)g(be)g(understood)d(one)i(function)f(at)i(a)555
1010 y(time,)e(and)f(from)f(the)h(point)g(of)g(vie)n(w)g(of)g(the)g
(reader)g(this)g(is)i(its)f(main)f(adv)n(antage.)26 b(Ho)n(we)n(v)o(er)
m(,)555 1114 y(the)31 b(functional)e(style)i(is)h(also)f(perfectly)e
(adapted)h(to)h(incremental)e(testing:)50 b(programs)555
1219 y(written)25 b(in)h(this)g(style)h(can)e(also)h(be)g
Ft(tested)g FA(one)f(function)f(at)i(a)g(time.)46 b(When)25
b(a)h(function)555 1324 y(neither)15 b(e)o(xamines)f(nor)h(alters)h(e)o
(xternal)f(state,)i(an)o(y)e(b)n(ugs)g(will)i(appear)d(immediately)-5
b(.)26 b(Such)555 1428 y(a)d(function)e(can)i(af)n(fect)f(the)h
(outside)f(w)o(orld)g(only)g(through)f(its)j(return)e(v)n(alues.)36
b(Insof)o(ar)22 b(as)555 1533 y(these)e(are)g(what)h(you)e(e)o
(xpected,)f(you)i(can)g(trust)g(the)g(code)g(which)f(produced)f(them.)
680 1638 y(Experienced)k(Lisp)j(programmers)d(actually)j(design)f
(their)g(programs)f(to)j(be)e(easy)h(to)555 1742 y(test:)659
1903 y(1.)41 b(The)o(y)24 b(try)h(to)g(se)o(gre)o(gate)f(side\255ef)n
(fects)g(in)i(a)g(fe)n(w)f(functions,)g(allo)n(wing)f(the)i(greater)763
2008 y(part)19 b(of)h(the)h(program)d(to)i(be)g(written)g(in)g(a)h
(purely)e(functional)f(style.)659 2168 y(2.)41 b(If)14
b(a)g(function)f(must)h(perform)e(side\255ef)n(fects,)j(the)o(y)e(try)h
(at)h(least)g(to)f(gi)n(v)o(e)g(it)h(a)f(functional)763
2273 y(interf)o(ace.)659 2433 y(3.)41 b(The)o(y)19 b(gi)n(v)o(e)g(each)
h(function)e(a)j(single,)f(well\255de\002ned)f(purpose.)555
2595 y(When)i(a)g(function)e(is)j(written,)f(the)o(y)f(can)h(test)g(it)
h(on)f(a)g(selection)g(of)f(representati)n(v)o(e)f(cases,)555
2699 y(then)e(mo)o(v)o(e)f(on)g(to)i(the)f(ne)o(xt)g(one.)27
b(If)17 b(each)g(brick)g(does)g(what)g(it')-5 b(s)18
b(supposed)e(to)h(do,)h(the)f(w)o(all)555 2804 y(will)k(stand.)680
2908 y(In)g(Lisp,)h(the)g(w)o(all)h(can)f(be)f(better)n(\255designed)f
(as)j(well.)35 b(Imagine)20 b(the)i(kind)f(of)h(con)m(v)o(er)n(\255)555
3013 y(sation)k(you)f(w)o(ould)g(ha)n(v)o(e)h(with)g(someone)f(so)h(f)o
(ar)g(a)o(w)o(ay)f(that)h(there)g(w)o(as)h(a)f(transmission)555
3118 y(delay)d(of)g(one)g(minute.)39 b(No)n(w)23 b(imagine)g(speaking)f
(to)i(someone)e(in)i(the)f(ne)o(xt)g(room.)38 b(Y)-9
b(ou)555 3222 y(w)o(ouldn')o(t)20 b(just)i(ha)n(v)o(e)f(the)h(same)g
(con)m(v)o(ersation)d(f)o(aster)m(,)i(you)g(w)o(ould)g(ha)n(v)o(e)g(a)h
(dif)n(ferent)e(kind)555 3327 y(of)j(con)m(v)o(ersation.)34
b(In)22 b(Lisp,)i(de)n(v)o(eloping)c(softw)o(are)i(is)i(lik)o(e)f
(speaking)f(f)o(ace\255to\255f)o(ace.)35 b(Y)-9 b(ou)555
3432 y(can)21 b(test)h(code)e(as)i(you')l(re)d(writing)h(it.)32
b(And)21 b(instant)f(turnaround)e(has)j(just)h(as)g(dramatic)e(an)555
3536 y(ef)n(fect)j(on)g(de)n(v)o(elopment)e(as)j(it)g(does)f(on)g(con)m
(v)o(ersation.)37 b(Y)-9 b(ou)22 b(don')o(t)g(just)i(write)g(the)f
(same)555 3641 y(program)18 b(f)o(aster;)i(you)g(write)g(a)h(dif)n
(ferent)d(kind)i(of)g(program.)680 3745 y(Ho)n(w)f(so?)30
b(When)20 b(testing)f(is)i(quick)o(er)e(you)g(can)h(do)f(it)i(more)e
(often.)28 b(In)20 b(Lisp,)g(as)g(in)g(an)o(y)555 3850
y(language,)h(de)n(v)o(elopment)f(is)j(a)g(c)o(ycle)g(of)f(writing)g
(and)g(testing.)36 b(But)23 b(in)g(Lisp)g(the)g(c)o(ycle)f(is)555
3955 y(v)o(ery)16 b(short:)28 b(single)17 b(functions,)f(or)h(e)n(v)o
(en)f(parts)h(of)g(functions.)27 b(And)16 b(if)i(you)e(test)i(e)n(v)o
(erything)555 4059 y(as)30 b(you)f(write)g(it,)k(you)28
b(will)i(kno)n(w)f(where)g(to)g(look)g(when)g(errors)f(occur:)47
b(in)30 b(what)f(you)555 4164 y(wrote)g(last.)57 b(Simple)29
b(as)h(it)g(sounds,)h(this)e(principle)f(is)j(to)e(a)h(lar)o(ge)e(e)o
(xtent)g(what)i(mak)o(es)555 4268 y(bottom\255up)21 b(programming)f
(feasible.)38 b(It)24 b(brings)e(an)i(e)o(xtra)e(de)o(gree)g(of)i
(con\002dence)d(which)555 4373 y(enables)27 b(Lisp)h(programmers)d(to)i
(break)g(free,)i(at)f(least)g(part)f(of)h(the)f(time,)j(from)c(the)i
(old)555 4478 y(plan\255and\255implement)16 b(style)21
b(of)f(softw)o(are)f(de)n(v)o(elopment.)680 4582 y(Section)27
b(1.1)f(stressed)i(that)g(bottom\255up)d(design)i(is)h(an)g(e)n(v)n
(olutionary)d(process.)50 b(Y)-9 b(ou)555 4687 y(b)n(uild)24
b(up)h(a)g(language)e(as)i(you)f(write)h(a)g(program)e(in)i(it.)43
b(This)25 b(approach)e(can)h(w)o(ork)g(only)555 4791
y(if)30 b(you)e Ft(trust)i FA(the)f(lo)n(wer)g(le)n(v)o(els)h(of)f
(code.)55 b(If)30 b(you)e(really)h(w)o(ant)g(to)h(use)f(this)h(layer)f
(as)h(a)555 4896 y(language,)24 b(you)h(ha)n(v)o(e)f(to)h(be)h(able)f
(to)g(assume,)h(as)g(you)e(w)o(ould)g(with)i(an)o(y)e(language,)g(that)
555 5001 y(an)o(y)16 b(b)n(ugs)g(you)f(encounter)g(are)h(b)n(ugs)g(in)h
(your)e(application)g(and)h(not)g(in)h(the)f(language)f(itself.)p
eop
%%Page: 39 52
39 51 bop 555 538 a Ft(3.4)825 b Fu(INTERA)n(CTIVE)17
b(PR)n(OGRAMMING)808 b FA(39)680 801 y(So)20 b(your)f(ne)n(w)h
(abstractions)g(are)g(supposed)f(to)i(bear)e(this)i(hea)n(vy)f(b)n
(urden)f(of)h(responsi\255)555 905 y(bility)-5 b(,)19
b(and)f(yet)h(you')l(re)e(supposed)h(to)h(just)g(spin)g(them)g(of)n(f)f
(as)i(the)f(need)f(arises?)30 b(Just)20 b(so;)f(in)555
1010 y(Lisp)k(you)e(can)i(ha)n(v)o(e)f(both.)35 b(When)23
b(you)f(write)g(programs)f(in)i(a)g(functional)e(style)i(and)f(test)555
1114 y(them)c(incrementally)-5 b(,)17 b(you)h(can)g(ha)n(v)o(e)h(the)f
(\003e)o(xibility)g(of)h(doing)e(things)i(on)f(the)h(spur)f(of)h(the)
555 1219 y(moment,)g(plus)h(the)g(kind)f(of)h(reliability)g(one)g
(usually)f(associates)i(with)f(careful)g(planning.)p
eop
%%Page: 40 53
40 52 bop 555 1610 a Fn(4)p 555 1872 2686 3 v 555 2131
a Fx(Utility)42 b(Functions)555 2568 y FA(Common)23 b(Lisp)i(operators)
f(come)g(in)h(three)f(types:)39 b(functions)23 b(and)h(macros,)h(which)
f(you)555 2672 y(can)j(write)g(yourself,)g(and)f(special)h(forms,)h
(which)e(you)g(can')o(t.)48 b(This)27 b(chapter)f(describes)555
2777 y(techniques)21 b(for)h(e)o(xtending)e(Lisp)i(with)h(ne)n(w)f
(functions.)34 b(But)22 b(\223techniques\224)f(here)h(means)555
2882 y(something)15 b(dif)n(ferent)g(from)h(what)h(it)g(usually)f
(does.)28 b(The)17 b(important)e(thing)h(to)h(kno)n(w)f(about)555
2986 y(such)e(functions)f(is)i(not)f(ho)n(w)f(the)o(y')l(re)g(written,)
i(b)n(ut)f(where)g(the)o(y)f(come)h(from.)26 b(An)14
b(e)o(xtension)555 3091 y(to)22 b(Lisp)h(will)g(be)f(written)g(using)g
(mostly)g(the)g(same)h(techniques)e(you)g(w)o(ould)g(use)i(to)f(write)
555 3195 y(an)o(y)d(other)f(Lisp)i(function.)27 b(The)19
b(hard)f(part)h(of)g(writing)g(these)h(e)o(xtensions)e(is)i(not)f
(deciding)555 3300 y(ho)n(w)h(to)g(write)g(them,)g(b)n(ut)g(deciding)f
(which)g(ones)h(to)h(write.)555 3553 y Fw(4.1)99 b(Birth)26
b(of)f(a)g(Utility)555 3743 y FA(In)k(its)g(simplest)h(form,)f
(bottom\255up)e(programming)e(means)j(second\255guessing)e(whoe)n(v)o
(er)555 3848 y(designed)18 b(your)g(Lisp.)29 b(At)19
b(the)g(same)h(time)f(as)h(you)e(write)h(your)f(program,)f(you)h(also)i
(add)e(to)555 3953 y(Lisp)g(ne)n(w)f(operators)g(which)g(mak)o(e)g
(your)f(program)g(easy)i(to)g(write.)28 b(These)18 b(ne)n(w)f
(operators)555 4057 y(are)j(called)g Ft(utilities.)680
4162 y FA(The)27 b(term)g(\223utility\224)g(has)g(no)g(precise)g
(de\002nition.)50 b(A)28 b(piece)f(of)g(code)f(can)h(be)h(called)555
4266 y(a)c(utility)g(if)g(it)h(seems)f(too)g(small)g(to)g(be)g
(considered)e(as)j(a)f(separate)g(application,)f(and)g(too)555
4371 y(general\255purpose)k(to)k(be)g(considered)e(as)j(part)f(of)f(a)i
(particular)d(program.)60 b(A)31 b(database)555 4476
y(program)25 b(w)o(ould)h(not)h(be)f(a)i(utility)-5 b(,)28
b(for)e(e)o(xample,)h(b)n(ut)g(a)g(function)e(which)i(performed)d(a)555
4580 y(single)13 b(operation)g(on)g(a)g(list)g(cou)o(ld)f(be.)21
b(Most)13 b(utilities)g(resemble)g(the)g(functions)g(an)o(d)f(macr)o
(os)555 4685 y(that)24 b(Lisp)h(has)f(already)-5 b(.)40
b(In)24 b(f)o(act,)h(man)o(y)e(of)h(Common)f(Lisp')-5
b(s)25 b(b)n(uilt\255in)f(operators)e(be)o(gan)555 4789
y(life)e(as)h(utilities.)30 b(The)20 b(function)e Fs(remove-if-not)p
FA(,)d(which)20 b(collects)g(all)h(the)f(elements)g(of)555
4894 y(a)g(list)g(satisfying)f(some)g(predicate,)f(w)o(as)i(de\002ned)e
(by)h(indi)n(vidual)f(programmers)e(for)j(years)555 4999
y(before)g(it)i(became)e(a)i(part)e(of)h(Common)f(Lisp.)1856
5229 y(40)p eop
%%Page: 41 54
41 53 bop 555 538 a Ft(4.1)964 b Fu(BIR)l(TH)18 b(OF)h(A)g(UTILITY)945
b FA(41)680 801 y(Learning)23 b(to)i(write)g(utilities)h(w)o(ould)e(be)
h(better)f(described)g(as)i(learning)d(the)i(habit)g(of)555
905 y(writing)17 b(them,)g(rather)f(than)h(the)g(technique)f(of)h
(writing)g(them.)27 b(Bottom\255up)16 b(programming)555
1010 y(means)g(simultaneously)e(writing)h(a)i(program)d(and)h(a)i
(programming)12 b(language.)26 b(T)-7 b(o)16 b(do)g(this)555
1114 y(well,)26 b(you)e(ha)n(v)o(e)h(to)g(de)n(v)o(elop)e(a)i(\002ne)g
(sense)g(of)g(which)f(operators)g(a)h(program)e(is)j(lacking.)555
1219 y(Y)-9 b(ou)23 b(ha)n(v)o(e)f(to)i(be)f(able)h(to)f(look)g(at)g(a)
h(program)d(and)i(say)-5 b(,)24 b(\223)-7 b(Ah,)24 b(what)f(you)g
(really)g(mean)f(to)555 1324 y(say)e(is)i Ft(this.)p
FA(\224)680 1428 y(F)o(or)35 b(e)o(xample,)j(suppose)d(that)g
Fs(nicknames)e FA(is)k(a)f(function)e(which)h(tak)o(es)h(a)g(name)555
1533 y(and)31 b(b)n(uilds)g(a)h(list)g(of)f(all)h(the)f(nicknames)f
(which)h(could)f(be)h(deri)n(v)o(ed)f(from)g(it.)63 b(Gi)n(v)o(en)555
1638 y(this)29 b(function,)f(ho)n(w)f(do)h(we)g(collect)g(all)g(the)h
(nicknames)d(yielded)h(by)h(a)g(list)h(of)f(names?)555
1742 y(Someone)19 b(learning)g(Lisp)h(might)f(write)i(a)f(function)f
(lik)o(e:)555 1925 y Fs(\(defun)41 b(all-nicknames)d(\(names\))642
2024 y(\(if)43 b(\(null)e(names\))817 2124 y(nil)817
2224 y(\(nconc)g(\(nicknames)e(\(car)j(names\)\))1122
2323 y(\(all-nicknames)37 b(\(cdr)42 b(names\)\)\)\)\))555
2511 y FA(A)25 b(more)f(e)o(xperienced)d(Lisp)k(programmer)c(can)k
(look)e(at)i(such)f(a)h(function)e(and)h(say)h(\223)-7
b(Ah,)555 2616 y(what)29 b(you)f(really)g(w)o(ant)h(is)h
Fs(mapcan)p FA(.)-6 b(\224)53 b(Then)28 b(instead)g(of)h(ha)n(ving)e
(to)i(de\002ne)g(and)f(call)h(a)555 2720 y(ne)n(w)21
b(function)e(to)i(\002nd)f(all)i(the)e(nicknames)g(of)g(a)i(group)d(of)
h(people,)g(you)g(can)g(use)h(a)h(single)555 2825 y(e)o(xpression:)555
3007 y Fs(\(mapcan)41 b(#'nicknames)e(people\))555 3195
y FA(The)23 b(de\002nition)e(of)i Fs(all-nicknames)18
b FA(is)24 b(rein)m(v)o(enting)c(the)j(wheel.)37 b(Ho)n(we)n(v)o(er)m
(,)22 b(that')-5 b(s)23 b(not)555 3300 y(all)k(that')-5
b(s)28 b(wrong)d(with)i(it:)44 b(it)27 b(is)h(also)f(b)n(urying)e(in)i
(a)g(speci\002c)g(function)e(something)g(that)555 3404
y(could)19 b(be)h(done)g(by)f(a)i(general\255purpose)16
b(operator)-5 b(.)680 3509 y(In)26 b(this)i(case)g(the)f(operator)m(,)f
Fs(mapcan)p FA(,)h(already)f(e)o(xists.)50 b(An)o(yone)25
b(who)i(kne)n(w)g(about)555 3613 y Fs(mapcan)13 b FA(w)o(ould)i(feel)h
(a)f(little)i(uncomfortable)12 b(looking)h(at)j Fs(all-nicknames)p
FA(.)23 b(T)-7 b(o)16 b(be)f(good)555 3718 y(at)31 b(bottom\255up)e
(programming)e(is)32 b(to)f(feel)g(equally)f(uncomfortable)d(when)k
(the)g(missing)555 3823 y(operator)17 b(is)j(one)f(which)f(hasn')o(t)g
(been)h(written)g(yet.)28 b(Y)-9 b(ou)19 b(must)g(be)g(able)g(to)g(say)
h(\223what)e(you)555 3927 y(really)i(w)o(ant)g(is)h Fs(x)p
FA(,)-6 b(\224)20 b(and)g(at)h(the)f(same)g(time,)g(to)h(kno)n(w)e
(what)h Fs(x)g FA(should)g(be.)680 4032 y(Lisp)26 b(programming)c
(entails,)28 b(among)c(other)h(things,)i(spinning)d(of)n(f)h(ne)n(w)h
(utilities)h(as)555 4136 y(you)f(need)g(them.)48 b(The)26
b(aim)g(of)h(this)g(section)f(is)i(to)f(sho)n(w)f(ho)n(w)g(such)g
(utilities)i(are)e(born.)555 4241 y(Suppose)20 b(that)h
Fs(towns)f FA(is)i(a)f(list)h(of)f(nearby)e(to)n(wns,)i(sorted)g(from)f
(nearest)g(to)h(f)o(arthest,)g(and)555 4346 y(that)e
Fs(bookshops)d FA(is)k(a)f(function)e(which)i(returns)f(a)h(list)h(of)f
(all)g(the)g(bookshops)e(in)i(a)g(city)-5 b(.)29 b(If)555
4450 y(we)20 b(w)o(ant)g(to)g(\002nd)f(the)h(nearest)f(to)n(wn)h(which)
f(has)h(an)o(y)f(bookshops,)e(and)i(the)h(bookshops)d(in)555
4555 y(it,)k(we)f(could)f(be)o(gin)g(with:)555 4738 y
Fs(\(let)42 b(\(\(town)f(\(find-if)f(#'bookshops)f(towns\)\)\))642
4837 y(\(values)i(town)h(\(bookshops)d(town\)\)\))p eop
%%Page: 42 55
42 54 bop 555 538 a FA(42)964 b Fu(UTILITY)17 b(FUNCTIONS)555
801 y FA(But)i(this)g(is)h(a)f(bit)g(inele)o(gant:)27
b(when)18 b Fs(find-if)e FA(\002nds)j(an)g(element)f(for)g(which)g
Fs(bookshops)555 905 y FA(returns)j(a)h(non\255nil)e(v)n(alue,)i(the)g
(v)n(alue)f(is)i(thro)n(wn)d(a)o(w)o(ay)-5 b(,)21 b(only)g(to)h(be)g
(recomputed)e(as)i(soon)555 1010 y(as)i Fs(find-if)d
FA(returns.)39 b(If)23 b Fs(bookshops)d FA(were)k(an)f(e)o(xpensi)n(v)o
(e)e(call,)k(this)f(idiom)f(w)o(ould)g(be)555 1114 y(inef)n(\002cient)
15 b(as)i(well)g(as)f(ugly)-5 b(.)27 b(T)-7 b(o)16 b(a)n(v)n(oid)g
(unnecessary)e(w)o(ork,)i(we)h(could)e(use)h(the)g(follo)n(wing)555
1219 y(function)i(instead:)555 1402 y Fs(\(defun)41 b(find-books)f
(\(towns\))642 1501 y(\(if)j(\(null)e(towns\))817 1601
y(nil)817 1701 y(\(let)g(\(\(shops)g(\(bookshops)f(\(car)i
(towns\)\)\)\))904 1800 y(\(if)g(shops)1078 1900 y(\(values)f(\(car)h
(towns\))f(shops\))1078 1999 y(\(find-books)e(\(cdr)j
(towns\)\)\)\)\)\))555 2187 y FA(Then)23 b(calling)g
Fs(\(find-books)39 b(towns\))21 b FA(w)o(ould)i(at)h(least)h(get)e(us)h
(what)f(we)h(w)o(anted)f(with)555 2292 y(no)16 b(more)g(computation)f
(than)h(necessary)-5 b(.)27 b(But)18 b(w)o(ait\227isn')o(t)e(it)i(lik)o
(ely)e(that)h(at)h(some)e(time)h(in)555 2396 y(the)h(future)f(we)h
(will)h(w)o(ant)f(to)g(do)g(the)g(same)g(kind)f(of)h(search)g(again?)27
b(What)18 b(we)h(really)e(w)o(ant)555 2501 y(here)g(is)h(a)g(utility)f
(which)g(combines)f Fs(find-if)f FA(and)i Fs(some)p FA(,)g(returning)e
(both)h(the)i(successful)555 2606 y(element,)c(and)g(the)g(v)n(alue)g
(returned)e(by)i(the)g(test)h(function.)25 b(Such)14
b(a)g(utility)g(could)g(be)g(de\002ned)555 2710 y(as:)555
2893 y Fs(\(defun)41 b(find2)h(\(fn)g(lst\))642 2992
y(\(if)h(\(null)e(lst\))817 3092 y(nil)817 3192 y(\(let)g(\(\(val)h
(\(funcall)e(fn)j(\(car)f(lst\)\)\)\))904 3291 y(\(if)g(val)1078
3391 y(\(values)f(\(car)h(lst\))g(val\))1078 3491 y(\(find2)f(fn)i
(\(cdr)f(lst\)\)\)\)\)\))555 3678 y FA(Notice)24 b(the)h(similarity)f
(between)g Fs(find-books)d FA(and)j Fs(find2)p FA(.)41
b(Indeed,)23 b(the)i(latter)g(could)555 3783 y(be)i(described)f(as)h
(the)g(sk)o(eleton)g(of)f(the)h(former)-5 b(.)48 b(No)n(w)-5
b(,)28 b(using)f(the)g(ne)n(w)f(utility)-5 b(,)28 b(we)g(can)555
3887 y(achie)n(v)o(e)19 b(our)g(original)g(aim)i(with)f(a)h(single)f(e)
o(xpression:)555 4070 y Fs(\(find2)41 b(#'bookshops)e(towns\))680
4258 y FA(One)24 b(of)g(the)g(unique)f(characteristics)g(of)h(Lisp)h
(programming)c(is)k(the)f(important)f(role)555 4362 y(of)d(functions)g
(as)h(ar)o(guments.)29 b(This)21 b(is)g(part)f(of)h(why)f(Lisp)h(is)g
(well\255adapted)e(to)i(bottom\255up)555 4467 y(programming.)47
b(It')-5 b(s)28 b(easier)g(to)f(abstract)g(out)g(the)h(bones)e(of)h(a)h
(function)e(when)g(you)h(can)555 4572 y(pass)21 b(the)f(\003esh)h(back)
e(as)i(a)g(functional)d(ar)o(gument.)680 4676 y(Introductory)13
b(programming)g(courses)j(teach)g(early)h(on)f(that)g(abstraction)g
(leads)h(to)f(less)555 4781 y(duplication)28 b(of)i(ef)n(fort.)58
b(One)30 b(of)g(the)h(\002rst)g(lessons)f(is:)51 b(don')o(t)28
b(wire)j(in)f(beha)n(vior)-5 b(.)58 b(F)o(or)555 4885
y(e)o(xample,)24 b(instead)g(of)g(de\002ning)f(tw)o(o)i(functions)e
(which)g(do)h(the)h(same)f(thing)g(b)n(ut)g(for)g(one)555
4990 y(or)j(tw)o(o)h(constants,)h(de\002ne)e(a)h(single)g(function)e
(and)h(pass)h(the)f(constants)h(as)g(ar)o(guments.)p
eop
%%Page: 43 56
43 55 bop 555 538 a Ft(4.2)893 b Fu(INVEST)18 b(IN)h(ABSTRA)n(CTION)874
b FA(43)555 801 y(In)27 b(Lisp)g(we)g(can)f(carry)g(this)i(idea)e
(further)m(,)h(because)f(we)h(can)g(pass)g(whole)f(functions)g(as)555
905 y(ar)o(guments.)i(In)21 b(both)e(of)i(the)f(pre)n(vious)f(e)o
(xamples)h(we)h(went)f(from)g(a)h(speci\002c)g(function)d(to)555
1010 y(a)26 b(more)f(general)f(function)g(which)h(took)g(a)h
(functional)e(ar)o(gument.)43 b(In)25 b(the)h(\002rst)g(case)g(we)555
1114 y(used)20 b(the)g(prede\002ned)e Fs(mapcan)g FA(and)h(in)h(the)g
(second)f(we)h(wrote)g(a)g(ne)n(w)g(utility)-5 b(,)19
b Fs(find2)p FA(,)g(b)n(ut)555 1219 y(the)k(general)e(principle)g(is)j
(the)e(same:)35 b(instead)22 b(of)h(mixing)e(the)i(general)e(and)h(the)
h(speci\002c,)555 1324 y(de\002ne)d(the)g(general)f(and)h(pass)g(the)h
(speci\002c)f(as)h(an)f(ar)o(gument.)680 1428 y(When)31
b(carefully)g(applied,)j(this)e(principle)f(yields)h(noticeably)e(more)
h(ele)o(gant)g(pro\255)555 1533 y(grams.)d(It)20 b(is)h(not)e(the)h
(only)f(force)g(dri)n(ving)f(bottom\255up)f(design,)i(b)n(ut)h(it)g(is)
h(a)f(major)f(one.)28 b(Of)555 1638 y(the)20 b(32)g(utilities)h
(de\002ned)e(in)h(this)h(chapter)m(,)e(18)g(tak)o(e)i(functional)d(ar)o
(guments.)555 1890 y Fw(4.2)99 b(In)l(v)o(est)25 b(in)g(Abstraction)555
2081 y FA(If)e(bre)n(vity)g(is)h(the)g(soul)f(of)g(wit,)i(it)f(is)h
(also,)f(along)f(with)g(ef)n(\002cienc)o(y)-5 b(,)23
b(the)g(essence)h(of)f(good)555 2185 y(softw)o(are.)30
b(The)20 b(cost)h(of)g(writing)f(or)g(maintaining)f(a)i(program)e
(increases)h(with)h(its)h(length.)56 b Fq(\016)555 2290
y FA(All)21 b(other)e(things)h(being)f(equal,)h(the)g(shorter)f
(program)f(is)j(the)f(better)-5 b(.)680 2395 y(From)22
b(this)i(point)e(of)h(vie)n(w)-5 b(,)23 b(the)h(writing)e(of)h
(utilities)h(should)e(be)h(treated)g(as)h(a)g(capital)555
2499 y(e)o(xpenditure.)40 b(By)25 b(replacing)f Fs(find-books)d
FA(with)k(the)g(utility)f Fs(find2)p FA(,)h(we)g(end)f(up)g(with)555
2604 y(just)f(as)g(man)o(y)f(lines)h(of)f(code.)35 b(But)23
b(we)g(ha)n(v)o(e)f(made)g(the)h(program)d(shorter)i(in)g(one)g(sense,)
555 2708 y(because)i(the)h(length)f(of)h(the)g(utility)g(does)f(not)h
(ha)n(v)o(e)f(to)h(be)g(char)o(ged)e(against)h(the)h(current)555
2813 y(program.)680 2918 y(It)19 b(is)i(not)e(just)h(an)f(accounting)e
(trick)j(to)f(treat)h(e)o(xtensions)e(to)i(Lisp)f(as)h(capital)g(e)o
(xpendi\255)555 3022 y(tures.)35 b(Utilities)24 b(can)e(go)g(into)g(a)g
(separate)g(\002le;)i(the)o(y)e(will)h(not)f(clutter)g(our)f(vie)n(w)h
(as)h(we')l(re)555 3127 y(w)o(orking)h(on)h(the)g(program,)f(nor)h(are)
g(the)o(y)f(lik)o(ely)i(to)f(be)g(in)m(v)n(olv)o(ed)e(if)j(we)g(ha)n(v)
o(e)e(to)i(return)555 3232 y(later)20 b(to)h(change)e(the)h(program)e
(in)i(some)g(respect.)680 3336 y(As)i(capital)g(e)o(xpenditures,)d(ho)n
(we)n(v)o(er)m(,)h(utilities)i(demand)e(e)o(xtra)h(attention.)33
b(It)22 b(is)h(espe\255)555 3441 y(cially)g(important)d(that)j(the)o(y)
f(be)g(well\255written.)36 b(The)o(y)21 b(are)h(going)g(to)g(be)h(used)
f(repeatedly)-5 b(,)555 3545 y(so)26 b(an)o(y)e(incorrectness)g(or)h
(inef)n(\002cienc)o(y)f(will)i(be)f(multiplied.)44 b(Extra)25
b(care)g(must)g(also)h(go)555 3650 y(into)16 b(their)h(design:)27
b(a)17 b(ne)n(w)f(utility)h(must)g(be)f(written)g(for)g(the)h(general)f
(case,)h(not)f(just)i(for)e(the)555 3755 y(problem)k(at)i(hand.)32
b(Finally)-5 b(,)21 b(lik)o(e)h(an)o(y)e(capital)i(e)o(xpenditure,)c
(we)k(need)f(not)g(be)h(in)f(a)h(hurry)555 3859 y(about)27
b(it.)53 b(If)28 b(you')l(re)f(thinking)f(of)i(spinning)e(of)n(f)i
(some)f(ne)n(w)h(operator)m(,)g(b)n(ut)g(aren')o(t)f(sure)555
3964 y(that)f(you)f(will)h(w)o(ant)g(it)h(else)n(where,)f(write)g(it)g
(an)o(yw)o(ay)-5 b(,)25 b(b)n(ut)h(lea)n(v)o(e)g(it)g(with)g(the)g
(particular)555 4068 y(program)19 b(which)i(uses)h(it.)34
b(Later)22 b(if)f(you)g(use)h(the)f(ne)n(w)h(operator)d(in)j(other)f
(programs,)e(you)555 4173 y(can)h(promote)e(it)j(from)f(a)g(subroutine)
e(to)j(a)f(utility)h(and)e(mak)o(e)h(it)h(generally)e(accessible.)680
4278 y(The)g(utility)h Fs(find2)e FA(seems)i(to)g(be)g(a)g(good)f(in)m
(v)o(estment.)27 b(By)20 b(making)f(a)h(capital)f(outlay)555
4382 y(of)i(7)g(lines,)h(we)f(get)g(an)g(immediate)g(sa)n(vings)g(of)g
(7.)32 b(The)21 b(utility)g(has)g(paid)g(for)f(itself)i(in)g(the)555
4487 y(\002rst)28 b(use.)51 b(A)28 b(programming)c(language,)k(Guy)f
(Steele)h(wrote,)g(should)f(\223cooperate)e(with)555
4591 y(our)19 b(natural)h(tendenc)o(y)e(to)n(w)o(ards)i(bre)n
(vity:\224)763 4779 y Fy(:)14 b(:)g(:)o FA(we)28 b(tend)f(to)g(belie)n
(v)o(e)f(that)i(the)f(e)o(xpense)f(of)h(a)g(programming)d(construct)763
4884 y(is)g(proportional)c(to)k(the)f(amount)f(of)h(writer')-5
b(s)24 b(cramp)e(that)h(it)h(causes)g(us)g(\(by)763 4988
y(\223belief)5 b(\224)24 b(I)h(mean)g(here)f(an)h(unconscious)f
(tendenc)o(y)f(rather)h(than)h(a)h(ferv)o(ent)p eop
%%Page: 44 57
44 56 bop 555 538 a FA(44)964 b Fu(UTILITY)17 b(FUNCTIONS)763
801 y FA(con)m(viction\).)64 b(Indeed,)34 b(this)f(is)g(not)g(a)g(bad)f
(psychological)e(principle)i(for)763 905 y(language)23
b(designers)g(to)i(k)o(eep)g(in)f(mind.)43 b(W)-7 b(e)25
b(think)f(of)h(addition)e(as)j(cheap)-2579 b Fq(\016)763
1010 y FA(partly)20 b(because)h(we)g(can)g(notate)g(it)h(with)g(a)f
(single)h(character:)30 b(\223)p Fs(+)p FA(\224.)i(Ev)o(en)21
b(if)763 1114 y(we)j(belie)n(v)o(e)g(that)g(a)h(construct)e(is)i(e)o
(xpensi)n(v)o(e,)f(we)g(will)h(often)f(prefer)f(it)i(to)g(a)763
1219 y(cheaper)18 b(one)i(if)h(it)f(will)h(cut)g(our)e(writing)h(ef)n
(fort)f(in)h(half.)555 1407 y(In)28 b(an)o(y)g(language,)h(the)g
(\223tendenc)o(y)d(to)n(w)o(ards)i(bre)n(vity\224)f(will)j(cause)e
(trouble)g(unless)g(it)i(is)555 1511 y(allo)n(wed)e(to)h(v)o(ent)f
(itself)i(in)f(ne)n(w)g(utilities.)56 b(The)28 b(shortest)h(idioms)g
(are)g(rarely)f(the)h(most)555 1616 y(ef)n(\002cient)d(ones.)46
b(If)26 b(we)g(w)o(ant)g(to)g(kno)n(w)f(whether)g(one)g(list)i(is)g
(longer)e(than)g(another)m(,)h(ra)o(w)555 1721 y(Lisp)20
b(will)h(tempt)f(us)h(to)f(write)555 1903 y Fs(\(>)43
b(\(length)d(x\))j(\(length)e(y\)\))555 2091 y FA(If)17
b(we)g(w)o(ant)g(to)g(map)g(a)g(function)e(o)o(v)o(er)h(se)n(v)o(eral)g
(lists,)j(we)e(will)h(lik)o(e)n(wise)f(be)g(tempted)f(to)h(join)555
2195 y(them)j(together)f(\002rst:)555 2378 y Fs(\(mapcar)41
b(fn)h(\(append)f(x)i(y)g(z\)\))555 2566 y FA(Such)22
b(e)o(xamples)f(sho)n(w)i(that)f(it')-5 b(s)24 b(especially)e
(important)f(to)h(write)h(utilities)g(for)f(situations)555
2670 y(we)28 b(might)f(otherwise)g(handle)f(inef)n(\002ciently)-5
b(.)50 b(A)28 b(language)e(augmented)g(with)i(the)f(right)555
2775 y(utilities)18 b(will)f(lead)g(us)g(to)g(write)g(more)g(abstract)f
(programs.)26 b(If)17 b(these)g(utilities)h(are)f(properly)555
2880 y(de\002ned,)i(it)i(will)g(also)f(lead)g(us)h(to)f(write)h(more)e
(ef)n(\002cient)h(ones.)680 2984 y(A)e(collection)g(of)g(utilities)g
(will)h(certainly)f(mak)o(e)g(programming)c(easier)-5
b(.)29 b(But)19 b(the)o(y)f(can)555 3089 y(do)27 b(more)g(than)f(that:)
44 b(the)o(y)27 b(can)g(mak)o(e)g(you)g(write)g(better)g(programs.)49
b(The)27 b(muses,)i(lik)o(e)555 3193 y(cooks,)f(spring)f(into)g(action)
g(at)h(the)f(sight)h(of)f(ingredients.)49 b(This)28 b(is)g(why)e
(artists)j(lik)o(e)e(to)555 3298 y(ha)n(v)o(e)d(a)g(lot)h(of)f(tools)g
(and)g(materials)g(in)g(their)g(studios.)41 b(The)o(y)23
b(kno)n(w)g(that)i(the)o(y)e(are)h(more)555 3403 y(lik)o(ely)17
b(to)g(start)h(something)d(ne)n(w)i(if)g(the)o(y)f(ha)n(v)o(e)h(what)g
(the)o(y)f(need)g(ready)g(at)i(hand.)27 b(The)16 b(same)555
3507 y(phenomenon)g(appears)j(with)h(programs)e(written)i
(bottom\255up.)27 b(Once)19 b(you)g(ha)n(v)o(e)g(written)h(a)555
3612 y(ne)n(w)g(utility)-5 b(,)20 b(you)f(may)h(\002nd)f(yourself)g
(using)h(it)h(more)e(than)h(you)f(w)o(ould)h(ha)n(v)o(e)f(e)o(xpected.)
680 3716 y(The)k(follo)n(wing)e(sections)j(describe)e(se)n(v)o(eral)h
(classes)h(of)f(utility)h(functions.)37 b(The)o(y)22
b(do)555 3821 y(not)h(by)g(an)o(y)g(means)g(represent)f(all)i(the)g
(dif)n(ferent)e(types)h(of)g(functions)f(you)h(might)g(add)f(to)555
3926 y(Lisp.)32 b(Ho)n(we)n(v)o(er)m(,)19 b(all)j(the)f(utilities)g(gi)
n(v)o(en)f(as)i(e)o(xamples)e(are)h(ones)g(that)g(ha)n(v)o(e)f(pro)o(v)
o(en)f(their)555 4030 y(w)o(orth)h(in)g(practice.)555
4283 y Fw(4.3)99 b(Operations)25 b(on)g(Lists)555 4474
y FA(Lists)e(were)f(originally)e(Lisp')-5 b(s)22 b(main)g(data)f
(structure.)34 b(Indeed,)20 b(the)i(name)f(\223Lisp\224)h(comes)555
4578 y(from)31 b(\223LISt)g(Processing.)-6 b(\224)63
b(It)32 b(is)g(as)h(well)f(not)f(to)h(be)g(misled)f(by)g(this)h
(historical)g(f)o(act,)555 4683 y(ho)n(we)n(v)o(er)-5
b(.)38 b(Lisp)23 b(is)i(not)e(inherently)f(about)g(processing)g(lists)j
(an)o(y)e(more)g(than)g(Polo)g(shirts)555 4787 y(are)d(for)g(Polo.)29
b(A)20 b(highly)f(optimized)g(Common)g(Lisp)h(program)e(might)i(ne)n(v)
o(er)f(see)i(a)f(list.)680 4892 y(It)26 b(w)o(ould)g(still)i
Ft(be)e FA(a)h(list,)i(though,)d(at)h(least)h(at)f(compile\255time.)46
b(The)26 b(most)h(sophisti\255)555 4997 y(cated)20 b(programs,)d(which)
j(use)g(lists)h(less)g(at)g(runtime,)d(use)i(them)g(proportionately)c
(more)j(at)p eop
%%Page: 45 58
45 57 bop 555 538 a Ft(4.3)933 b Fu(OPERA)-7 b(TIONS)19
b(ON)g(LISTS)915 b FA(45)p 555 745 2678 4 v 553 2665
4 1920 v 605 888 a Fs(\(proclaim)40 b('\(inline)g(last1)h(single)h
(append1)e(conc1)i(mklist\)\))605 1087 y(\(defun)f(last1)g(\(lst\))692
1187 y(\(car)h(\(last)f(lst\)\)\))605 1386 y(\(defun)g(single)g
(\(lst\))692 1486 y(\(and)h(\(consp)f(lst\))h(\(not)g(\(cdr)g
(lst\)\)\)\))605 1685 y(\(defun)f(append1)g(\(lst)h(obj\))692
1785 y(\(append)f(lst)h(\(list)g(obj\)\)\))605 1984 y(\(defun)f(conc1)g
(\(lst)h(obj\))692 2084 y(\(nconc)f(lst)h(\(list)g(obj\)\)\))605
2283 y(\(defun)f(mklist)g(\(obj\))692 2383 y(\(if)h(\(listp)f(obj\))h
(obj)h(\(list)e(obj\)\)\))1051 2587 y FA(Figure)19 b(4.1:)29
b(Small)21 b(functions)d(which)i(operate)f(on)h(lists.)p
3231 2665 V 555 2668 2678 4 v 555 2884 a(compile\255time,)e(when)g
(generating)f(macro)i(e)o(xpansions.)27 b(So)19 b(although)f(the)h
(role)g(of)g(lists)i(is)555 2988 y(decreased)c(in)h(modern)e(dialects,)
i(operations)e(on)i(lists)h(can)e(still)i(mak)o(e)f(up)f(the)h(greater)
f(part)555 3093 y(of)j(a)h(Lisp)f(program.)680 3198 y(Figures)k(4.1)h
(and)f(4.2)h(contain)f(a)h(selection)g(of)g(functions)f(which)g(b)n
(uild)h(or)g(e)o(xamine)555 3302 y(lists.)45 b(Those)24
b(gi)n(v)o(en)g(in)h(Figure)g(4.1)f(are)h(among)e(the)i(smallest)h
(utilities)g(w)o(orth)e(de\002ning.)555 3407 y(F)o(or)c(ef)n(\002cienc)
o(y)-5 b(,)18 b(the)o(y)h(should)h(all)g(be)h(declared)d(inline)i
(\(page)g(26\).)680 3511 y(The)g(\002rst,)h Fs(last1)p
FA(,)e(returns)h(the)g(last)i(element)e(in)h(a)g(list.)31
b(The)21 b(b)n(uilt\255in)f(function)f Fs(last)555 3616
y FA(returns)28 b(the)h(last)h Ft(cons)f FA(in)g(a)h(list,)i(not)d(the)
g(last)h(element.)55 b(Most)29 b(of)g(the)g(time)h(one)e(uses)555
3721 y(it)f(to)g(get)g(the)g(last)g(element,)h(by)e(saying)g
Fs(\(car)42 b(\(last)g(...\)\))p FA(.)47 b(Is)27 b(it)h(w)o(orth)e
(writing)g(a)555 3825 y(ne)n(w)e(utility)g(for)f(such)h(a)h(case?)41
b(Y)-8 b(es,)25 b(when)e(it)i(ef)n(fecti)n(v)o(ely)d(replaces)i(one)f
(of)h(the)g(b)n(uilt\255in)555 3930 y(operators.)680
4034 y(Notice)13 b(that)h Fs(last1)e FA(does)i(no)f(error)n
(\255checking.)24 b(In)13 b(general,)h(none)e(of)i(the)g(code)f
(de\002ned)555 4139 y(in)i(this)f(book)g(will)h(do)f(error)n
(\255checking.)23 b(P)o(artly)15 b(this)f(is)i(just)f(to)f(mak)o(e)g
(the)h(e)o(xamples)e(clearer)-5 b(.)555 4244 y(But)19
b(in)g(shorter)f(utilities)i(it)f(is)h(reasonable)d(not)i(to)g(do)f(an)
o(y)g(error)n(\255checking)e(an)o(yw)o(ay)-5 b(.)27 b(If)18
b(we)555 4348 y(try:)555 4520 y Fs(>)43 b(\(last1)e("blub"\))555
4620 y(>>Error:)f("blub")h(is)i(not)f(a)i(list.)555 4719
y(Broken)d(at)i(LAST...)555 4896 y FA(the)18 b(error)f(will)j(be)e
(caught)f(by)h Fs(last)f FA(itself.)29 b(When)18 b(utilities)h(are)g
(small,)f(the)o(y)g(form)f(a)i(layer)555 5001 y(of)f(abstraction)f(so)i
(thin)f(that)g(it)h(starts)g(to)g(be)f(transparent.)27
b(As)19 b(one)f(can)g(see)h(through)d(a)j(thin)p eop
%%Page: 46 59
46 58 bop 555 538 a FA(46)964 b Fu(UTILITY)17 b(FUNCTIONS)555
801 y FA(layer)f(of)h(ice,)g(one)f(can)h(see)g(through)e(utilities)i
(lik)o(e)g Fs(last1)f FA(to)h(interpret)e(errors)h(which)g(arise)555
905 y(in)k(the)h(underlying)c(functions.)680 1010 y(The)24
b(function)e Fs(single)h FA(tests)j(whether)d(something)g(is)i(a)g
(list)h(of)e(one)g(element.)41 b(Lisp)555 1114 y(programs)17
b(need)i(to)g(mak)o(e)f(this)i(test)g(rather)e(often.)28
b(At)19 b(\002rst)h(one)f(might)f(be)h(tempted)f(to)h(use)555
1219 y(the)h(natural)g(translation)f(from)g(English:)555
1377 y Fs(\(=)43 b(\(length)d(lst\))i(1\))555 1540 y
FA(Written)18 b(this)f(w)o(ay)-5 b(,)18 b(the)f(test)h(w)o(ould)f(be)g
(v)o(ery)g(inef)n(\002cient.)27 b(W)-7 b(e)18 b(kno)n(w)f(all)h(we)f
(need)g(to)h(kno)n(w)555 1644 y(as)j(soon)e(as)i(we')l(v)o(e)f(look)o
(ed)f(past)h(the)g(\002rst)h(element.)680 1749 y(Ne)o(xt)j(come)g
Fs(append1)e FA(and)i Fs(conc1)p FA(.)41 b(Both)24 b(attach)g(a)h(ne)n
(w)g(element)f(to)g(the)h(end)f(of)g(a)555 1854 y(list,)i(the)d(latter)
h(destructi)n(v)o(ely)-5 b(.)38 b(These)23 b(functions)g(are)h(small,)g
(b)n(ut)g(so)g(frequently)e(needed)555 1958 y(that)k(the)o(y)f(are)h(w)
o(orth)f(de\002ning.)46 b(Indeed,)25 b Fs(append1)f FA(has)i(been)f
(prede\002ned)f(in)i(pre)n(vious)555 2063 y(Lisp)20 b(dialects.)680
2167 y(So)i(has)g Fs(mklist)p FA(,)e(which)h(w)o(as)h(prede\002ned)e
(in)i(\(at)g(least\))g(Interlisp.)33 b(Its)23 b(purpose)d(is)i(to)555
2272 y(ensure)e(that)h(something)e(is)j(a)f(list.)32
b(Man)o(y)20 b(Lisp)h(functions)e(are)i(written)f(to)h(return)f(either)
g(a)555 2377 y(single)i(v)n(alue)f(or)g(a)h(list)h(of)f(v)n(alues.)33
b(Suppose)21 b(that)h Fs(lookup)e FA(is)i(such)g(a)g(function,)e(and)h
(that)555 2481 y(we)e(w)o(ant)f(to)g(collect)g(the)g(results)h(of)f
(calling)g(it)h(on)e(all)i(the)f(elements)g(of)g(a)h(list)g(called)f
Fs(data)p FA(.)555 2586 y(W)-7 b(e)21 b(can)f(do)g(so)h(by)e(writing:)
555 2744 y Fs(\(mapcan)41 b(#'\(lambda)f(\(d\))i(\(mklist)f(\(lookup)f
(d\)\)\))904 2843 y(data\))680 3006 y FA(Figure)16 b(4.2)h(contains)f
(some)h(lar)o(ger)f(e)o(xamples)g(of)h(list)i(utilities.)29
b(The)17 b(\002rst,)h Fs(longer)p FA(,)e(is)555 3111
y(useful)h(from)g(the)h(point)f(of)g(vie)n(w)h(of)g(ef)n(\002cienc)o(y)
e(as)j(well)f(as)g(abstraction.)28 b(It)18 b(compares)e(tw)o(o)555
3215 y(sequences)i(and)g(returns)g(true)g(only)g(if)h(the)g(\002rst)h
(is)g(longer)-5 b(.)27 b(When)19 b(comparing)d(the)j(lengths)555
3320 y(of)h(tw)o(o)g(lists,)i(it)f(is)g(tempting)e(to)h(do)g(just)h
(that:)555 3478 y Fs(\(>)43 b(\(length)d(x\))j(\(length)e(y\)\))555
3641 y FA(This)31 b(idiom)g(is)h(inef)n(\002cient)e(because)g(it)i
(requires)e(the)h(program)e(to)i(tra)n(v)o(erse)g(the)g(entire)555
3745 y(length)e(of)g(both)f(lists.)58 b(If)30 b(one)e(list)j(is)f(much)
f(longer)f(than)h(the)g(other)m(,)h(all)g(the)g(ef)n(fort)e(of)555
3850 y(tra)n(v)o(ersing)j(the)i(dif)n(ference)e(in)h(their)h(lengths)f
(will)h(be)g(w)o(asted.)67 b(It)32 b(is)i(f)o(aster)f(to)g(do)f(as)555
3955 y Fs(longer)18 b FA(does)i(and)g(tra)n(v)o(erse)f(the)i(tw)o(o)f
(lists)i(in)e(parallel.)680 4059 y(Embedded)k(within)j
Fs(longer)d FA(is)k(a)f(recursi)n(v)o(e)f(function)f(to)i(compare)e
(the)i(lengths)f(of)555 4164 y(tw)o(o)i(lists.)54 b(Since)28
b Fs(longer)e FA(is)j(for)f(comparing)d(lengths,)k(it)g(should)e(w)o
(ork)g(for)h(an)o(ything)555 4268 y(that)23 b(you)e(could)h(gi)n(v)o(e)
f(as)j(an)e(ar)o(gument)e(to)j Fs(length)p FA(.)34 b(But)23
b(the)g(possibility)f(of)g(comparing)555 4373 y(lengths)j(in)h
(parallel)g(only)f(applies)h(to)g(lists,)i(so)e(the)g(internal)f
(function)g(is)h(only)g(called)f(if)555 4478 y(both)19
b(ar)o(guments)g(are)h(lists.)680 4582 y(The)h(ne)o(xt)f(function,)g
Fs(filter)p FA(,)f(is)k(to)e Fs(some)f FA(what)i Fs(remove-if-not)16
b FA(is)23 b(to)e Fs(find-if)p FA(.)555 4687 y(The)e(b)n(uilt\255in)f
Fs(remove-if-not)c FA(returns)19 b(all)g(the)g(v)n(alues)g(that)g
(might)g(ha)n(v)o(e)f(been)g(returned)555 4791 y(if)h(you)f(called)h
Fs(find-if)e FA(with)i(the)g(same)g(function)e(on)h(successi)n(v)o(e)h
(cdrs)g(of)f(a)i(list.)29 b(Analo\255)555 4896 y(gously)-5
b(,)17 b Fs(filter)g FA(returns)h(what)g Fs(some)g FA(w)o(ould)g(ha)n
(v)o(e)g(returned)e(for)i(successi)n(v)o(e)h(cdrs)f(of)h(the)555
5001 y(list:)p eop
%%Page: 47 60
47 59 bop 555 538 a Ft(4.3)933 b Fu(OPERA)-7 b(TIONS)19
b(ON)g(LISTS)915 b FA(47)p 555 745 2678 4 v 553 3462
4 2717 v 605 888 a Fs(\(defun)41 b(longer)g(\(x)i(y\))692
988 y(\(labels)e(\(\(compare)f(\(x)i(y\))1171 1087 y(\(and)g(\(consp)f
(x\))1389 1187 y(\(or)i(\(null)e(y\))1564 1287 y(\(compare)f(\(cdr)i
(x\))h(\(cdr)f(y\)\)\)\)\)\))779 1386 y(\(if)h(\(and)e(\(listp)h(x\))g
(\(listp)f(y\)\))954 1486 y(\(compare)f(x)j(y\))954 1586
y(\(>)f(\(length)f(x\))i(\(length)d(y\)\)\)\)\))605 1785
y(\(defun)h(filter)g(\(fn)h(lst\))692 1884 y(\(let)g(\(\(acc)f(nil\)\))
779 1984 y(\(dolist)g(\(x)i(lst\))866 2084 y(\(let)f(\(\(val)g
(\(funcall)e(fn)j(x\)\)\))954 2183 y(\(if)f(val)g(\(push)g(val)g
(acc\)\)\)\))779 2283 y(\(nreverse)e(acc\)\)\))605 2482
y(\(defun)h(group)g(\(source)g(n\))692 2582 y(\(if)h(\(zerop)f(n\))i
(\(error)e("zero)h(length"\)\))692 2681 y(\(labels)f(\(\(rec)g
(\(source)g(acc\))1171 2781 y(\(let)h(\(\(rest)f(\(nthcdr)g(n)i
(source\)\)\))1259 2881 y(\(if)f(\(consp)f(rest\))1433
2980 y(\(rec)h(rest)g(\(cons)f(\(subseq)g(source)g(0)i(n\))g(acc\)\))
1433 3080 y(\(nreverse)d(\(cons)h(source)g(acc\)\)\)\)\)\))779
3180 y(\(if)i(source)e(\(rec)h(source)f(nil\))h(nil\)\)\))1077
3384 y FA(Figure)19 b(4.2:)29 b(Lar)o(ger)19 b(functions)g(that)h
(operate)f(on)h(lists.)p 3231 3462 V 555 3465 2678 4
v 555 3682 a Fs(>)43 b(\(filter)e(#'\(lambda)f(\(x\))i(\(if)g
(\(numberp)f(x\))h(\(1+)h(x\)\)\))991 3781 y('\(a)f(1)h(2)h(b)f(3)g(c)g
(d)g(4\)\))555 3881 y(\(2)g(3)g(4)g(5\))555 4059 y FA(Y)-9
b(ou)27 b(gi)n(v)o(e)h Fs(filter)e FA(a)i(function)f(and)g(a)i(list,)h
(and)e(get)g(back)f(a)i(list)g(of)f(whate)n(v)o(er)e(non\255nil)555
4164 y(v)n(alues)20 b(are)g(returned)e(by)i(the)g(function)f(as)i(it)g
(is)g(applied)e(to)h(the)g(elements)g(of)g(the)g(list.)680
4268 y(Notice)f(that)h Fs(filter)d FA(uses)k(an)e(accumulator)f(in)h
(the)h(same)g(w)o(ay)f(as)i(the)e(tail\255recursi)n(v)o(e)555
4373 y(functions)29 b(described)g(in)h(Section)g(2.8.)59
b(Indeed,)31 b(the)f(aim)h(in)f(writing)g(a)g(tail\255recursi)n(v)o(e)
555 4478 y(function)i(is)i(to)g(ha)n(v)o(e)f(the)h(compiler)e(generate)
g(code)h(in)h(the)f(shape)g(of)h Fs(filter)p FA(.)67
b(F)o(or)555 4582 y Fs(filter)p FA(,)22 b(the)i(straightforw)o(ard)e
(iterati)n(v)o(e)h(de\002nition)f(is)j(simpler)e(than)h(the)f
(tail\255recursi)n(v)o(e)555 4687 y(one.)36 b(The)22
b(combination)f(of)h Fs(push)g FA(and)g Fs(nreverse)e
FA(in)j(the)f(de\002nition)g(of)g Fs(filter)f FA(is)j(the)555
4791 y(standard)19 b(Lisp)h(idiom)g(for)f(accumulating)g(a)h(list.)680
4896 y(The)27 b(last)i(function)d(in)i(Figure)g(4.2)f(is)i(for)e
(grouping)f(lists)j(into)f(sublists.)53 b(Y)-9 b(ou)27
b(gi)n(v)o(e)555 5001 y Fs(group)20 b FA(a)i(list)h Ft(l)f
FA(and)g(a)g(number)d Ft(n,)j FA(and)f(it)i(will)f(return)f(a)h(ne)n(w)
f(list)i(in)f(which)f(the)h(elements)p eop
%%Page: 48 61
48 60 bop 555 538 a FA(48)964 b Fu(UTILITY)17 b(FUNCTIONS)555
801 y FA(of)23 b Ft(l)g FA(are)g(grouped)d(into)j(sublists)g(of)g
(length)f Ft(n)p FA(.)37 b(The)22 b(remainder)f(is)j(put)e(in)h(a)g
(\002nal)g(sublist.)555 905 y(Thus)d(if)g(we)h(gi)n(v)o(e)e
Fs(2)i FA(as)f(the)h(second)e(ar)o(gument,)f(we)i(get)g(an)g
(assoc\255list:)555 1088 y Fs(>)43 b(\(group)e('\(a)i(b)g(c)g(d)g(e)g
(f)g(g\))g(2\))555 1188 y(\(\(A)f(B\))h(\(C)g(D\))g(\(E)f(F\))h
(\(G\)\))680 1375 y FA(This)27 b(function)e(is)j(written)f(in)g(a)g
(rather)f(con)m(v)n(oluted)f(w)o(ay)i(in)g(order)f(to)h(mak)o(e)g(it)g
(tail\255)555 1480 y(recursi)n(v)o(e)c(\(Section)h(2.8\).)41
b(The)24 b(principle)g(of)g(rapid)g(prototyping)d(applies)k(to)f(indi)n
(vidual)555 1584 y(functions)16 b(as)i(well)g(as)g(to)g(whole)f
(programs.)26 b(When)17 b(writing)g(a)h(function)e(lik)o(e)h
Fs(flatten)p FA(,)f(it)555 1689 y(can)f(be)f(a)i(good)d(idea)i(to)g(be)
o(gin)f(with)h(the)f(simplest)i(possible)e(implementation.)25
b(Then,)15 b(once)555 1794 y(the)26 b(simpler)f(v)o(ersion)g(w)o(orks,)
h(you)f(can)h(replace)f(it)i(if)f(necessary)f(with)h(a)g(more)f(ef)n
(\002cient)555 1898 y(tail\255recursi)n(v)o(e)19 b(or)g(iterati)n(v)o
(e)h(v)o(ersion.)28 b(If)20 b(it')-5 b(s)22 b(short)d(enough,)f(the)j
(initial)f(v)o(ersion)f(could)h(be)555 2003 y(left)j(as)g(a)f(comment)f
(to)i(describe)e(the)h(beha)n(vior)f(of)h(its)h(replacement.)34
b(\(Simpler)22 b(v)o(ersions)555 2107 y(of)k Fs(group)e
FA(and)i(se)n(v)o(eral)f(other)g(functions)g(in)h(Figures)g(4.2)f(and)h
(4.3)f(are)h(included)e(in)j(the)555 2212 y(note)20 b(on)f(page)h
(389.\))-720 b Fq(\016)680 2317 y FA(The)24 b(de\002nition)h(of)f
Fs(group)g FA(is)i(unusual)e(in)i(that)f(it)h(checks)f(for)f(at)i
(least)g(one)f(error:)38 b(a)555 2421 y(second)24 b(ar)o(gument)e(of)i
Fs(0)p FA(,)i(which)e(w)o(ould)g(otherwise)g(send)g(the)h(function)e
(into)h(an)h(in\002nite)555 2526 y(recursion.)680 2630
y(In)19 b(one)h(respect,)g(the)g(e)o(xamples)f(in)h(this)h(book)e(de)n
(viate)g(from)g(usual)h(Lisp)h(practice:)28 b(to)555
2735 y(mak)o(e)20 b(the)g(chapters)g(independent)e(of)i(one)f(another)m
(,)g(the)h(code)g(e)o(xamples)f(are)h(as)h(much)f(as)555
2840 y(possible)g(written)f(in)h(ra)o(w)g(Lisp.)29 b(Because)20
b(it)h(is)g(so)f(useful)g(in)g(de\002ning)e(macros,)h
Fs(group)g FA(is)555 2944 y(an)h(e)o(xception,)e(and)i(will)h(reappear)
d(at)j(se)n(v)o(eral)f(points)f(in)i(later)f(chapters.)680
3049 y(The)e(functions)g(in)i(Figure)e(4.2)h(all)h(w)o(ork)e(their)h(w)
o(ay)g(along)g(the)g(top\255le)n(v)o(el)f(structure)g(of)555
3153 y(a)k(list.)34 b(Figure)21 b(4.3)f(sho)n(ws)i(tw)o(o)g(e)o
(xamples)e(of)h(functions)f(that)i(descend)e(into)h(nested)g(lists.)555
3258 y(The)28 b(\002rst,)j Fs(flatten)p FA(,)c(w)o(as)i(also)g
(prede\002ned)d(in)i(Interlisp.)53 b(It)28 b(returns)g(a)g(list)i(of)e
(all)h(the)555 3363 y(atoms)20 b(that)g(are)h(elements)e(of)h(a)h
(list,)g(or)f(elements)g(of)g(its)h(elements,)f(and)f(so)i(on:)555
3545 y Fs(>)43 b(\(flatten)d('\(a)j(\(b)g(c\))f(\(\(d)h(e\))f(f\)\)\))
555 3645 y(\(A)h(B)g(C)g(D)g(E)g(F\))680 3833 y FA(The)17
b(other)h(function)f(in)h(Figure)g(4.3,)f Fs(prune)p
FA(,)g(is)i(to)g Fs(remove-if)c FA(as)k Fs(copy-tree)c
FA(is)k(to)555 3937 y Fs(copy-list)p FA(.)26 b(That)20
b(is,)h(it)g(recurses)e(do)n(wn)h(into)g(sublists:)555
4120 y Fs(>)43 b(\(prune)e(#'evenp)g('\(1)h(2)h(\(3)g(\(4)g(5\))g(6\))g
(7)g(8)g(\(9\)\)\))555 4220 y(\(1)g(\(3)g(\(5\)\))e(7)j(\(9\)\))555
4407 y FA(Ev)o(ery)19 b(leaf)h(for)g(which)f(the)h(function)f(returns)g
(true)h(is)h(remo)o(v)o(ed.)555 4660 y Fw(4.4)99 b(Sear)n(ch)680
4850 y FA(This)24 b(section)f(gi)n(v)o(es)h(some)f(e)o(xamples)g(of)h
(functions)e(for)i(searching)e(lists.)42 b(Common)555
4955 y(Lisp)32 b(pro)o(vides)f(a)h(rich)g(set)h(of)f(b)n(uilt\255in)f
(operators)g(for)g(this)i(purpose,)g(b)n(ut)f(some)g(tasks)p
eop
%%Page: 49 62
49 61 bop 555 538 a Ft(4.4)1139 b Fu(SEARCH)1122 b FA(49)p
555 745 2678 4 v 553 2864 4 2119 v 605 888 a Fs(\(defun)41
b(flatten)g(\(x\))692 988 y(\(labels)g(\(\(rec)g(\(x)i(acc\))1171
1087 y(\(cond)f(\(\(null)f(x\))i(acc\))1433 1187 y(\(\(atom)e(x\))i
(\(cons)e(x)j(acc\)\))1433 1287 y(\(t)f(\(rec)f(\(car)g(x\))g(\(rec)g
(\(cdr)g(x\))h(acc\)\)\)\)\)\))779 1386 y(\(rec)f(x)h(nil\)\)\))605
1586 y(\(defun)e(prune)g(\(test)h(tree\))692 1685 y(\(labels)f(\(\(rec)
g(\(tree)h(acc\))1171 1785 y(\(cond)g(\(\(null)f(tree\))h(\(nreverse)d
(acc\)\))1433 1884 y(\(\(consp)i(\(car)h(tree\)\))1477
1984 y(\(rec)f(\(cdr)h(tree\))1694 2084 y(\(cons)g(\(rec)g(\(car)g
(tree\))f(nil\))h(acc\)\)\))1433 2183 y(\(t)h(\(rec)f(\(cdr)g(tree\))
1782 2283 y(\(if)g(\(funcall)e(test)i(\(car)g(tree\)\))1956
2383 y(acc)1956 2482 y(\(cons)g(\(car)f(tree\))h(acc\)\)\)\)\)\)\))779
2582 y(\(rec)g(tree)g(nil\)\)\))1201 2786 y FA(Figure)20
b(4.3:)28 b(Doubly\255recursi)n(v)o(e)17 b(list)k(utilities.)p
3231 2864 V 555 2867 2678 4 v 555 3092 a(are)26 b(still)h(dif)n
(\002cult\227or)e(at)i(least)g(dif)n(\002cult)e(to)i(perform)d(ef)n
(\002ciently)-5 b(.)46 b(W)-7 b(e)27 b(sa)o(w)g(this)f(in)h(the)555
3196 y(hypothetical)20 b(case)j(described)e(on)h(page)g(41.)35
b(The)22 b(\002rst)i(utility)e(in)h(Figure)e(4.4,)h Fs(find2)p
FA(,)g(is)-2785 b Fq(\016)555 3301 y FA(the)20 b(one)g(we)g(de\002ned)g
(in)g(response)f(to)i(it.)680 3405 y(The)f(ne)o(xt)h(utility)-5
b(,)20 b Fs(before)p FA(,)f(is)j(written)f(with)g(similar)h
(intentions.)30 b(It)22 b(tells)g(you)e(if)h(one)555
3510 y(object)f(is)h(found)d(before)h(another)g(in)h(a)h(list:)555
3693 y Fs(>)43 b(\(before)e('b)i('d)f('\(a)h(b)g(c)g(d\)\))555
3792 y(\(B)g(C)g(D\))555 3980 y FA(It)20 b(is)i(easy)e(enough)e(to)i
(do)g(this)h(sloppily)e(in)i(ra)o(w)f(Lisp:)555 4163
y Fs(\(<)43 b(\(position)d('b)i('\(a)h(b)g(c)g(d\)\))f(\(position)e('d)
j('\(a)f(b)i(c)f(d\)\)\))555 4350 y FA(But)28 b(the)f(latter)g(idiom)g
(is)h(inef)n(\002cient)f(and)f(error)n(\255prone:)41
b(inef)n(\002cient)26 b(because)h(we)g(don')o(t)555 4455
y(need)22 b(to)i(\002nd)e(both)h(objects,)g(only)f(the)h(one)g(that)g
(occurs)f(\002rst;)k(and)c(error)n(\255prone)e(because)555
4559 y(if)27 b(either)f(object)h(isn')o(t)f(in)h(the)g(list,)i
Fs(nil)d FA(will)i(be)e(passed)h(as)h(an)e(ar)o(gument)f(to)i
Fs(<)p FA(.)49 b(Using)555 4664 y Fs(before)18 b FA(\002x)o(es)j(both)e
(problems.)680 4769 y(Since)31 b Fs(before)e FA(is)j(similar)f(in)h
(spirit)f(to)h(a)f(test)h(for)f(membership,)g(it)h(is)g(written)f(to)
555 4873 y(resemble)26 b(the)i(b)n(uilt\255in)e Fs(member)f
FA(function.)49 b(Lik)o(e)27 b Fs(member)e FA(it)j(tak)o(es)g(an)f
(optional)f Fs(test)555 4978 y FA(ar)o(gument,)c(which)i(def)o(aults)g
(to)g Fs(eql)p FA(.)40 b(Also,)25 b(instead)f(of)g(simply)g(returning)e
Fs(t)p FA(,)j(it)g(tries)f(to)p eop
%%Page: 50 63
50 62 bop 555 538 a FA(50)964 b Fu(UTILITY)17 b(FUNCTIONS)p
555 745 2678 4 v 553 3960 4 3215 v 605 888 a Fs(\(defun)41
b(find2)g(\(fn)i(lst\))692 988 y(\(if)f(\(null)g(lst\))866
1087 y(nil)866 1187 y(\(let)g(\(\(val)g(\(funcall)e(fn)j(\(car)f
(lst\)\)\)\))954 1287 y(\(if)g(val)1128 1386 y(\(values)f(\(car)g
(lst\))h(val\))1128 1486 y(\(find2)f(fn)i(\(cdr)f(lst\)\)\)\)\)\))605
1685 y(\(defun)f(before)g(\(x)i(y)g(lst)f(&key)g(\(test)g(#'eql\)\))692
1785 y(\(and)g(lst)910 1884 y(\(let)g(\(\(first)f(\(car)g(lst\)\)\))997
1984 y(\(cond)h(\(\(funcall)d(test)j(y)i(first\))d(nil\))1259
2084 y(\(\(funcall)e(test)j(x)i(first\))d(lst\))1259
2183 y(\(t)h(\(before)f(x)i(y)g(\(cdr)f(lst\))g(:test)g
(test\)\)\)\)\)\))605 2383 y(\(defun)f(after)g(\(x)i(y)g(lst)g(&key)f
(\(test)f(#'eql\)\))692 2482 y(\(let)h(\(\(rest)f(\(before)g(y)i(x)g
(lst)f(:test)g(test\)\)\))779 2582 y(\(and)g(rest)g(\(member)f(x)i
(rest)f(:test)f(test\)\)\)\))605 2781 y(\(defun)g(duplicate)f(\(obj)i
(lst)g(&key)g(\(test)g(#'eql\)\))692 2881 y(\(member)f(obj)h(\(cdr)g
(\(member)f(obj)h(lst)g(:test)g(test\)\))1041 2980 y(:test)f(test\)\))
605 3180 y(\(defun)g(split-if)f(\(fn)j(lst\))692 3279
y(\(let)f(\(\(acc)f(nil\)\))779 3379 y(\(do)i(\(\(src)e(lst)h(\(cdr)g
(src\)\)\))954 3478 y(\(\(or)f(\(null)h(src\))g(\(funcall)e(fn)j(\(car)
f(src\)\)\))997 3578 y(\(values)f(\(nreverse)f(acc\))i(src\)\))866
3678 y(\(push)g(\(car)g(src\))g(acc\)\)\)\))1217 3882
y FA(Figure)19 b(4.4:)29 b(Functions)19 b(which)h(search)g(lists.)p
3231 3960 V 555 3963 2678 4 v 555 4166 a(return)i(potentially)g(useful)
g(information:)33 b(the)24 b(cdr)e(be)o(ginning)f(with)i(the)g(object)g
(gi)n(v)o(en)f(as)555 4271 y(the)e(\002rst)h(ar)o(gument.)680
4375 y(Note)k(that)h Fs(before)e FA(returns)h(true)h(if)g(we)g
(encounter)e(the)i(\002rst)h(ar)o(gument)c(before)i(en\255)555
4480 y(countering)h(the)i(second.)52 b(Thus)28 b(it)h(will)g(return)e
(true)h(if)h(the)f(second)f(ar)o(gument)f(doesn')o(t)555
4584 y(occur)19 b(in)h(the)h(list)g(at)g(all:)555 4740
y Fs(>)43 b(\(before)e('a)i('b)f('\(a\)\))555 4840 y(\(A\))555
5001 y FA(W)-7 b(e)26 b(can)e(peform)f(a)i(more)f(e)o(xacting)f(test)j
(by)e(calling)g Fs(after)p FA(,)g(which)g(requires)g(that)g(both)p
eop
%%Page: 51 64
51 63 bop 555 538 a Ft(4.4)1139 b Fu(SEARCH)1122 b FA(51)555
801 y(its)21 b(ar)o(guments)d(occur)h(in)i(the)f(list:)555
983 y Fs(>)43 b(\(after)e('a)i('b)g('\(b)f(a)h(d\)\))555
1083 y(\(A)g(D\))555 1183 y(>)g(\(after)e('a)i('b)g('\(a\)\))555
1282 y(NIL)680 1470 y FA(If)29 b Fs(\(member)40 b Ft(o)j(l)p
Fs(\))30 b FA(\002nds)f Ft(o)h FA(in)f(the)g(list)i Ft(l,)g
FA(it)f(also)g(returns)e(the)i(cdr)e(of)h Ft(l)h FA(be)o(ginning)555
1574 y(with)21 b Ft(o)p FA(.)31 b(This)21 b(return)f(v)n(alue)g(can)h
(be)g(used,)f(for)g(e)o(xample,)g(to)h(test)g(for)g(duplication.)29
b(If)21 b Ft(o)g FA(is)555 1679 y(duplicated)c(in)h Ft(l,)h
FA(then)f(it)h(will)g(also)g(be)f(found)e(in)j(the)f(cdr)g(of)g(the)g
(list)h(returned)e(by)h Fs(member)p FA(.)555 1784 y(This)i(idiom)g(is)h
(embodied)d(in)j(the)f(ne)o(xt)f(utility)-5 b(,)20 b
Fs(duplicate)p FA(:)555 1966 y Fs(>)43 b(\(duplicate)d('a)i('\(a)h(b)g
(c)g(a)g(d\)\))555 2066 y(\(A)g(D\))555 2254 y FA(Other)20
b(utilities)h(to)f(test)h(for)f(duplication)e(could)h(be)h(written)g
(on)g(the)g(same)h(principle.)680 2358 y(More)f(f)o(astidious)h
(language)e(designers)i(are)g(shock)o(ed)f(that)h(Common)f(Lisp)i(uses)
f Fs(nil)555 2463 y FA(to)h(represent)e(both)h(f)o(alsity)h(and)f(the)g
(empty)g(list.)34 b(It)22 b(does)f(cause)h(trouble)e(sometimes)h(\(see)
555 2567 y(Section)j(14.2\),)f(b)n(ut)h(it)h(is)g(con)m(v)o(enient)d
(in)i(functions)f(lik)o(e)h Fs(duplicate)p FA(.)38 b(In)24
b(questions)f(of)555 2672 y(sequence)16 b(membership,)f(it)i(seems)g
(natural)f(to)h(represent)f(f)o(alsity)h(as)g(the)g(empty)f(sequence.)
680 2777 y(The)29 b(last)h(function)e(in)h(Figure)g(4.4)g(is)h(also)g
(a)g(kind)e(of)h(generalization)f(of)h Fs(member)p FA(.)555
2881 y(While)34 b Fs(member)d FA(returns)h(the)i(cdr)e(of)h(the)h(list)
g(be)o(ginning)d(with)i(the)g(element)g(it)h(\002nds,)555
2986 y Fs(split-if)c FA(returns)i(both)g(halv)o(es.)66
b(This)33 b(utility)g(is)h(mainly)e(used)h(with)g(lists)h(that)f(are)
555 3090 y(ordered)18 b(in)j(some)f(respect:)555 3273
y Fs(>)43 b(\(split-if)d(#'\(lambda)g(\(x\))i(\(>)h(x)g(4\)\))1078
3373 y('\(1)f(2)i(3)f(4)g(5)g(6)g(7)g(8)h(9)f(10\)\))555
3472 y(\(1)g(2)g(3)g(4\))555 3572 y(\(5)g(6)g(7)g(8)g(9)g(10\))680
3760 y FA(Figure)26 b(4.5)g(contains)g(search)g(functions)g(of)g
(another)f(kind:)42 b(those)27 b(which)f(compare)555
3864 y(elements)d(against)f(one)g(another)-5 b(.)36 b(The)22
b(\002rst,)i Fs(most)p FA(,)e(looks)h(at)g(one)f(element)h(at)g(a)g
(time.)37 b(It)555 3969 y(tak)o(es)20 b(a)f(list)i(and)e(a)g(scoring)g
(function,)e(and)i(returns)f(the)i(element)e(with)i(the)f(highest)g
(score.)555 4073 y(In)h(case)h(of)e(ties,)i(the)g(element)e(occurring)f
(\002rst)j(wins.)555 4256 y Fs(>)43 b(\(most)f(#'length)e('\(\(a)i(b\))
h(\(a)f(b)i(c\))e(\(a\))h(\(e)f(f)i(g\)\)\))555 4356
y(\(A)f(B)g(C\))555 4455 y(3)555 4643 y FA(F)o(or)20
b(con)m(v)o(enience,)d Fs(most)i FA(also)h(returns)g(the)g(score)g(of)g
(the)g(winner)-5 b(.)680 4748 y(A)23 b(more)f(general)g(kind)g(of)g
(search)h(is)h(pro)o(vided)c(by)j Fs(best)p FA(.)36 b(This)23
b(utility)g(also)g(tak)o(es)g(a)555 4852 y(function)18
b(and)h(a)h(list,)h(b)n(ut)f(here)f(the)h(function)e(must)h(be)h(a)g
(predicate)f(of)g(tw)o(o)h(ar)o(guments.)27 b(It)555
4957 y(returns)19 b(the)i(element)e(which,)h(according)e(to)i(the)g
(predicate,)f(beats)h(all)h(the)f(others.)p eop
%%Page: 52 65
52 64 bop 555 538 a FA(52)964 b Fu(UTILITY)17 b(FUNCTIONS)p
555 745 2678 4 v 553 4458 4 3713 v 605 888 a Fs(\(defun)41
b(most)h(\(fn)g(lst\))692 988 y(\(if)g(\(null)g(lst\))866
1087 y(\(values)f(nil)h(nil\))866 1187 y(\(let*)g(\(\(wins)f(\(car)h
(lst\)\))1171 1287 y(\(max)g(\(funcall)f(fn)h(wins\)\)\))954
1386 y(\(dolist)e(\(obj)i(\(cdr)g(lst\)\))1041 1486 y(\(let)g
(\(\(score)e(\(funcall)h(fn)h(obj\)\)\))1128 1586 y(\(when)f(\(>)i
(score)f(max\))1215 1685 y(\(setq)g(wins)f(obj)1477 1785
y(max)85 b(score\)\)\)\))954 1884 y(\(values)40 b(wins)i(max\)\)\)\))
605 2084 y(\(defun)f(best)h(\(fn)g(lst\))692 2183 y(\(if)g(\(null)g
(lst\))866 2283 y(nil)866 2383 y(\(let)g(\(\(wins)f(\(car)h(lst\)\)\))
954 2482 y(\(dolist)e(\(obj)i(\(cdr)g(lst\)\))1041 2582
y(\(if)g(\(funcall)e(fn)j(obj)f(wins\))1215 2681 y(\(setq)g(wins)f
(obj\)\)\))954 2781 y(wins\)\)\))605 2980 y(\(defun)g(mostn)g(\(fn)i
(lst\))692 3080 y(\(if)f(\(null)g(lst\))866 3180 y(\(values)f(nil)h
(nil\))866 3279 y(\(let)g(\(\(result)f(\(list)g(\(car)h(lst\)\)\))1128
3379 y(\(max)g(\(funcall)e(fn)j(\(car)f(lst\)\)\)\))954
3478 y(\(dolist)e(\(obj)i(\(cdr)g(lst\)\))1041 3578 y(\(let)g
(\(\(score)e(\(funcall)h(fn)h(obj\)\)\))1128 3678 y(\(cond)f(\(\(>)i
(score)e(max\))1433 3777 y(\(setq)g(max)174 b(score)1694
3877 y(result)42 b(\(list)f(obj\)\)\))1389 3977 y(\(\(=)i(score)e
(max\))1433 4076 y(\(push)g(obj)i(result\)\)\)\)\))954
4176 y(\(values)d(\(nreverse)g(result\))h(max\)\)\)\))985
4380 y FA(Figure)20 b(4.5:)29 b(Search)19 b(functions)g(which)h
(compare)e(elements.)p 3231 4458 V 555 4462 2678 4 v
555 4686 a Fs(>)43 b(\(best)f(#'>)g('\(1)g(2)i(3)f(4)g(5\)\))555
4785 y(5)555 4973 y FA(W)-7 b(e)17 b(can)e(think)g(of)g
Fs(best)f FA(as)j(being)d(equi)n(v)n(alent)g(to)h Fs(car)g
FA(of)g Fs(sort)p FA(,)h(b)n(ut)f(much)g(more)f(ef)n(\002cient.)p
eop
%%Page: 53 66
53 65 bop 555 538 a Ft(4.5)1123 b Fu(MAPPING)1106 b FA(53)555
801 y(It)31 b(is)h(up)f(to)g(the)g(caller)g(to)g(pro)o(vide)e(a)j
(predicate)d(which)i(de\002nes)g(a)g(total)g(order)f(on)h(the)555
905 y(elements)19 b(of)g(the)h(list.)30 b(Otherwise)19
b(the)h(order)e(of)h(the)h(elements)f(will)h(in\003uence)f(the)g
(result;)555 1010 y(as)i(before,)d(in)j(case)f(of)g(ties,)h(the)f
(\002rst)h(element)f(wins.)680 1114 y(Finally)-5 b(,)19
b Fs(mostn)g FA(tak)o(es)h(a)h(function)e(and)g(a)i(list)h(and)d
(returns)h(a)g Ft(list)i FA(of)e(all)h(the)f(elements)555
1219 y(for)g(which)f(the)h(function)f(yields)h(the)g(highest)g(score)g
(\(along)f(with)h(the)g(score)g(itself\):)555 1402 y
Fs(>)43 b(\(mostn)85 b(#'length)40 b('\(\(a)i(b\))h(\(a)g(b)g(c\))g
(\(a\))f(\(e)h(f)g(g\)\)\))555 1501 y(\(\(A)f(B)i(C\))e(\(E)h(F)g
(G\)\))555 1601 y(3)555 1854 y Fw(4.5)99 b(Mapping)680
2044 y FA(Another)15 b(widely)i(used)g(class)i(of)e(Lisp)g(functions)f
(are)h(the)g(mapping)f(functions,)g(which)555 2149 y(apply)i(a)h
(function)f(to)h(a)g(sequence)f(of)h(ar)o(guments.)26
b(Figure)19 b(4.6)f(sho)n(ws)h(some)g(e)o(xamples)f(of)555
2254 y(ne)n(w)23 b(mapping)e(functions.)37 b(The)23 b(\002rst)g(three)g
(are)g(for)g(applying)e(a)j(function)d(to)i(a)h(range)e(of)555
2358 y(numbers)e(without)h(ha)n(ving)f(to)i(cons)g(up)f(a)h(list)h(to)e
(contain)g(them.)33 b(The)21 b(\002rst)i(tw)o(o,)e Fs(map0-n)555
2463 y FA(and)f Fs(map1-n)p FA(,)e(w)o(ork)h(for)h(ranges)f(of)h
(positi)n(v)o(e)f(inte)o(gers:)555 2645 y Fs(>)43 b(\(map0-n)e(#'1+)h
(5\))555 2745 y(\(1)h(2)g(3)g(4)g(5)g(6\))555 2933 y
FA(Both)25 b(are)g(written)g(using)f(the)i(more)e(general)g
Fs(mapa-b)p FA(,)g(which)g(w)o(orks)h(for)g(an)o(y)f(range)g(of)555
3037 y(numbers:)555 3220 y Fs(>)43 b(\(mapa-b)e(#'1+)h(-2)h(0)g(.5\))
555 3320 y(\(-1)f(-0.5)g(0.0)h(0.5)f(1.0\))680 3507 y
FA(F)o(ollo)n(wing)15 b Fs(mapa-b)f FA(is)j(the)g(still)g(more)f
(general)f Fs(map->)p FA(,)h(which)g(w)o(orks)g(for)f(sequences)555
3612 y(of)23 b(objects)f(of)h(an)o(y)f(kind.)36 b(The)22
b(sequence)g(be)o(gins)g(with)h(the)f(object)h(gi)n(v)o(en)e(as)j(the)e
(second)555 3716 y(ar)o(gument,)k(the)h(end)f(of)h(the)g(sequence)f(is)
h(de\002ned)f(by)h(the)g(function)e(gi)n(v)o(en)h(as)h(the)g(third)555
3821 y(ar)o(gument,)20 b(and)h(successors)h(are)f(generated)f(by)i(the)
f(function)f(gi)n(v)o(en)h(as)h(the)g(fourth)e(ar)o(gu\255)555
3926 y(ment.)43 b(W)m(ith)25 b Fs(map->)f FA(it)h(is)h(possible)f(to)g
(na)n(vigate)e(arbitrary)h(data)h(structures,)g(as)g(well)h(as)555
4030 y(operate)19 b(on)h(sequences)g(of)g(numbers.)28
b(W)-7 b(e)22 b(could)d(de\002ne)h Fs(mapa-b)f FA(in)h(terms)h(of)f
Fs(map->)f FA(as)555 4135 y(follo)n(ws:)555 4317 y Fs(\(defun)41
b(mapa-b)g(\(fn)i(a)g(b)g(&optional)d(\(step)h(1\)\))642
4417 y(\(map->)g(fn)947 4517 y(a)947 4616 y(#'\(lambda)f(\(x\))i(\(>)h
(x)g(b\)\))947 4716 y(#'\(lambda)d(\(x\))i(\(+)h(x)g(step\)\)\)\))p
eop
%%Page: 54 67
54 66 bop 555 538 a FA(54)964 b Fu(UTILITY)17 b(FUNCTIONS)p
555 924 2678 4 v 553 4736 4 3813 v 605 1066 a Fs(\(defun)41
b(map0-n)g(\(fn)h(n\))692 1166 y(\(mapa-b)f(fn)h(0)i(n\)\))605
1365 y(\(defun)d(map1-n)g(\(fn)h(n\))692 1465 y(\(mapa-b)f(fn)h(1)i
(n\)\))605 1664 y(\(defun)d(mapa-b)g(\(fn)h(a)i(b)f(&optional)d(\(step)
h(1\)\))692 1764 y(\(do)h(\(\(i)h(a)g(\(+)g(i)g(step\)\))910
1863 y(\(result)e(nil\)\))866 1963 y(\(\(>)i(i)g(b\))g(\(nreverse)c
(result\)\))779 2063 y(\(push)j(\(funcall)e(fn)j(i\))f(result\)\)\))605
2262 y(\(defun)f(map->)g(\(fn)i(start)e(test-fn)g(succ-fn\))692
2362 y(\(do)h(\(\(i)h(start)e(\(funcall)f(succ-fn)h(i\)\))910
2461 y(\(result)g(nil\)\))866 2561 y(\(\(funcall)f(test-fn)h(i\))i
(\(nreverse)d(result\)\))779 2660 y(\(push)i(\(funcall)e(fn)j(i\))f
(result\)\)\))605 2860 y(\(defun)f(mappend)g(\(fn)h(&rest)f(lsts\))692
2959 y(\(apply)g(#'append)f(\(apply)h(#'mapcar)g(fn)i(lsts\)\)\))605
3159 y(\(defun)e(mapcars)g(\(fn)h(&rest)f(lsts\))692
3258 y(\(let)h(\(\(result)e(nil\)\))779 3358 y(\(dolist)h(\(lst)h
(lsts\))866 3457 y(\(dolist)f(\(obj)h(lst\))954 3557
y(\(push)f(\(funcall)f(fn)j(obj\))f(result\)\)\))779
3657 y(\(nreverse)e(result\)\)\))605 3856 y(\(defun)h(rmapcar)g(\(fn)h
(&rest)f(args\))692 3956 y(\(if)h(\(some)g(#'atom)f(args\))866
4055 y(\(apply)g(fn)i(args\))866 4155 y(\(apply)e(#'mapcar)1171
4254 y(#'\(lambda)f(\(&rest)h(args\))1346 4354 y(\(apply)g(#'rmapcar)f
(fn)j(args\)\))1171 4454 y(args\)\)\))1371 4658 y FA(Figure)20
b(4.6:)29 b(Mapping)18 b(functions.)p 3231 4736 V 555
4739 2678 4 v eop
%%Page: 55 68
55 67 bop 555 538 a Ft(4.5)1123 b Fu(MAPPING)1106 b FA(55)680
801 y(F)o(or)19 b(ef)n(\002cienc)o(y)-5 b(,)19 b(the)h(b)n(uilt\255in)f
Fs(mapcan)g FA(is)i(destructi)n(v)o(e.)27 b(It)21 b(could)e(be)h
(duplicated)f(by:)555 978 y Fs(\(defun)41 b(our-mapcan)f(\(fn)i(&rest)f
(lsts\))642 1078 y(\(apply)g(#'nconc)g(\(apply)g(#'mapcar)f(fn)j
(lsts\)\)\))555 1261 y FA(Because)25 b Fs(mapcan)d FA(splices)k
(together)d(lists)j(with)f Fs(nconc)p FA(,)f(the)g(lists)i(returned)d
(by)h(the)h(\002rst)555 1366 y(ar)o(gument)k(had)i(better)g(be)h(ne)n
(wly)f(created,)i(or)e(the)h(ne)o(xt)f(time)g(we)h(look)f(at)h(them)f
(the)o(y)555 1470 y(might)d(be)g(altered.)53 b(That')-5
b(s)29 b(why)e Fs(nicknames)f FA(\(page)h(41\))h(w)o(as)h(de\002ned)e
(as)i(a)g(function)555 1575 y(which)23 b(\223b)n(uilds)g(a)h(list\224)g
(of)f(nicknames.)38 b(If)23 b(it)h(simply)f(returned)f(a)i(list)h
(stored)d(else)n(where,)555 1679 y(it)j(w)o(ouldn')o(t)d(ha)n(v)o(e)i
(been)f(safe)i(to)f(use)h Fs(mapcan)p FA(.)39 b(Instead)24
b(we)g(w)o(ould)g(ha)n(v)o(e)f(had)h(to)g(splice)555
1784 y(the)e(returned)e(lists)k(with)e Fs(append)p FA(.)33
b(F)o(or)21 b(such)h(cases,)h Fs(mappend)d FA(of)n(fers)h(a)h
(nondestructi)n(v)o(e)555 1889 y(alternati)n(v)o(e)d(to)h
Fs(mapcan)p FA(.)680 1993 y(The)25 b(ne)o(xt)f(utility)-5
b(,)26 b Fs(mapcars)p FA(,)e(is)j(for)d(cases)j(where)d(we)i(w)o(ant)g
(to)f(mapcar)f(a)i(function)555 2098 y(o)o(v)o(er)18
b(se)n(v)o(eral)h(lists.)31 b(If)20 b(we)g(ha)n(v)o(e)f(tw)o(o)h(lists)
h(of)e(numbers)g(and)g(we)h(w)o(ant)g(to)g(get)g(a)g(single)f(list)555
2202 y(of)h(the)g(square)g(roots)f(of)h(both,)f(using)h(ra)o(w)g(Lisp)g
(we)h(could)e(say)555 2380 y Fs(\(mapcar)41 b(#'sqrt)g(\(append)f
(list1)i(list2\)\))555 2563 y FA(b)n(ut)31 b(this)h(conses)g
(unnecessarily)-5 b(.)61 b(W)-7 b(e)32 b(append)e(together)g
Fs(list1)g FA(and)h Fs(list2)f FA(only)g(to)555 2668
y(discard)20 b(the)g(result)g(immediately)-5 b(.)27 b(W)m(ith)21
b Fs(mapcars)d FA(we)i(can)g(get)g(the)h(same)f(result)g(from:)555
2846 y Fs(\(mapcars)40 b(#'sqrt)h(list1)h(list2\))555
3028 y FA(and)20 b(do)f(no)h(unnecessary)f(consing.)680
3133 y(The)26 b(\002nal)g(function)f(in)h(Figure)g(4.6)f(is)j(a)e(v)o
(ersion)g(of)g Fs(mapcar)e FA(for)i(trees.)48 b(Its)26
b(name,)555 3238 y Fs(rmapcar)p FA(,)21 b(is)i(short)g(for)f
(\223recursi)n(v)o(e)f Fs(mapcar)p FA(,)-6 b(\224)21
b(and)i(what)f Fs(mapcar)f FA(does)i(on)f(\003at)h(lists,)i(it)555
3342 y(does)20 b(on)g(trees:)555 3520 y Fs(>)43 b(\(rmapcar)d(#'princ)h
('\(1)h(2)i(\(3)e(4)i(\(5\))e(6\))h(7)g(\(8)g(9\)\)\))555
3620 y(123456789)555 3719 y(\(1)g(2)g(\(3)g(4)g(\(5\))f(6\))h(7)g(\(8)g
(9\)\))555 3897 y FA(Lik)o(e)20 b Fs(mapcar)p FA(,)e(it)j(can)f(tak)o
(e)g(more)g(than)f(one)h(list)h(ar)o(gument.)555 4059
y Fs(>)43 b(\(rmapcar)d(#'+)j('\(1)f(\(2)h(\(3\))f(4\)\))h('\(10)f
(\(20)g(\(30\))g(40\)\)\))555 4159 y(\(11)g(\(22)h(\(33\))f(44\)\))555
4326 y FA(Se)n(v)o(eral)33 b(of)h(the)g(functions)f(which)h(appear)f
(later)h(on)g(ought)f(really)g(to)i(call)f Fs(rmapcar)p
FA(,)555 4431 y(including)18 b Fs(rep)p 1026 4431 27
4 v 51 w FA(on)i(page)g(324.)680 4535 y(T)-7 b(o)24 b(some)f(e)o
(xtent,)h(traditional)f(list)i(mapping)d(functions)h(may)g(be)h
(rendered)e(obsolete)555 4640 y(by)e(the)g(ne)n(w)g(series)h(macros)e
(introduced)f(in)i Fr(CL)-6 b(TL)p FA(2.)29 b(F)o(or)19
b(e)o(xample,)555 4818 y Fs(\(mapa-b)41 b(#'fn)h(a)h(b)g(c\))555
5001 y FA(could)19 b(be)h(rendered)p eop
%%Page: 56 69
56 68 bop 555 538 a FA(56)964 b Fu(UTILITY)17 b(FUNCTIONS)p
555 745 2678 4 v 553 2765 4 2020 v 605 888 a Fs(\(defun)41
b(readlist)f(\(&rest)h(args\))692 988 y(\(values)g(\(read-from-stri)o
(ng)1128 1087 y(\(concatenate)d('string)j("\(")2043 1187
y(\(apply)g(#'read-line)e(args\))2043 1287 y("\)"\)\)\)\))605
1486 y(\(defun)i(prompt)g(\(&rest)g(args\))692 1586 y(\(apply)g
(#'format)f(*query-io*)g(args\))692 1685 y(\(read)i(*query-io*\)\))605
1884 y(\(defun)f(break-loop)e(\(fn)k(quit)f(&rest)f(args\))692
1984 y(\(format)g(*query-io*)e("Entering)h(break-loop.~\045"\))692
2084 y(\(loop)779 2183 y(\(let)i(\(\(in)g(\(apply)f(#'prompt)f
(args\)\)\))866 2283 y(\(if)j(\(funcall)d(quit)i(in\))1041
2383 y(\(return\))1041 2482 y(\(format)e(*query-io*)g("~A~\045")h
(\(funcall)f(fn)j(in\)\)\)\)\)\))1466 2686 y FA(Figure)19
b(4.7:)29 b(I/O)21 b(functions.)p 3231 2765 V 555 2768
2678 4 v 555 2992 a Fs(\(collect)40 b(\(#Mfn)i(\(scan-range)d(:from)i
(a)j(:upto)d(b)i(:by)g(c\)\)\))555 3180 y FA(Ho)n(we)n(v)o(er)m(,)17
b(there)h(is)h(still)h(some)f(call)g(for)e(mapping)g(functions.)27
b(A)19 b(mapping)e(function)g(may)555 3284 y(in)28 b(some)g(cases)h(be)
f(clearer)g(or)g(more)f(ele)o(gant.)52 b(Some)28 b(things)f(we)i(could)
e(e)o(xpress)g(with)555 3389 y Fs(map->)c FA(might)g(be)h(dif)n
(\002cult)g(to)g(e)o(xpress)g(using)g(series.)42 b(Finally)-5
b(,)24 b(mapping)e(functions,)i(as)555 3493 y(functions,)19
b(can)h(be)g(passed)g(as)h(ar)o(guments.)555 3746 y Fw(4.6)99
b(I/O)680 3937 y FA(Figure)23 b(4.7)g(contains)g(three)g(e)o(xamples)g
(of)g Fr(I)p FA(/)p Fr(O)i FA(utilities.)41 b(The)23
b(need)g(for)h(this)g(kind)f(of)555 4041 y(utility)g(v)n(aries)g(from)g
(program)e(to)i(program.)37 b(Those)23 b(in)g(Figure)g(4.7)f(are)i
(just)f(a)h(represen\255)555 4146 y(tati)n(v)o(e)d(sample.)32
b(The)21 b(\002rst)h(is)g(for)e(the)i(case)f(where)g(you)f(w)o(ant)h
(users)h(to)f(be)g(able)g(to)h(type)e(in)555 4251 y(e)o(xpressions)f
(without)g(parentheses;)g(it)i(reads)f(a)h(line)f(of)g(input)g(and)f
(returns)h(it)g(as)h(a)g(list:)555 4433 y Fs(>)43 b(\(readlist\))555
4533 y(Call)f(me)h("Ed")555 4633 y(\(CALL)f(ME)g("Ed"\))555
4820 y FA(The)17 b(call)g(to)g Fs(values)e FA(ensures)i(that)g(we)h
(get)f(only)f(one)g(v)n(alue)h(back)f(\()p Fs(read-from-strin)o(g)555
4925 y FA(itself)21 b(returns)e(a)i(second)e(v)n(alue)h(that)g(is)h
(irrele)n(v)n(ant)e(in)h(this)h(case\).)p eop
%%Page: 57 70
57 69 bop 555 538 a Ft(4.7)908 b Fu(SYMBOLS)19 b(AND)g(STRINGS)891
b FA(57)680 801 y(The)18 b(function)f Fs(prompt)f FA(combines)i
(printing)f(a)i(question)f(and)g(reading)f(the)i(answer)-5
b(.)28 b(It)555 905 y(tak)o(es)21 b(the)f(ar)o(guments)e(of)i
Fs(format)p FA(,)e(e)o(xcept)h(the)h(initial)h(stream)f(ar)o(gument.)
555 1088 y Fs(>)43 b(\(prompt)e("Enter)g(a)i(number)e(between)g(~A)i
(and)f(~A.~\045>>)f(")i(1)g(10\))555 1188 y(Enter)f(a)h(number)e
(between)f(1)k(and)e(10.)555 1287 y(>>)h(3)555 1387 y(3)555
1574 y FA(Finally)-5 b(,)17 b Fs(break-loop)c FA(is)18
b(for)e(situations)h(where)g(you)f(w)o(ant)h(to)g(imitate)g(the)g(Lisp)
g(tople)n(v)o(el.)555 1679 y(It)35 b(tak)o(es)h(tw)o(o)g(functions)d
(and)i(an)g Fs(&rest)f FA(ar)o(gument,)i(which)f(is)h(repeatedly)d(gi)n
(v)o(en)h(to)555 1784 y Fs(prompt)p FA(.)66 b(As)34 b(long)f(as)h(the)f
(second)g(function)e(returns)h(f)o(alse)i(for)f(the)g(input,)j(the)d
(\002rst)555 1888 y(function)g(is)j(applied)e(to)i(it.)74
b(So)36 b(for)e(e)o(xample)g(we)h(could)f(simulate)h(the)g(actual)g
(Lisp)555 1993 y(tople)n(v)o(el)19 b(with:)555 2175 y
Fs(>)43 b(\(break-loop)c(#'eval)i(#'\(lambda)f(\(x\))j(\(eq)f(x)h
(:q\)\))f(">>)g("\))555 2275 y(Entering)e(break-loop.)555
2375 y(>>)j(\(+)g(2)g(3\))555 2474 y(5)555 2574 y(>>)g(:q)555
2674 y(:Q)555 2861 y FA(This,)20 b(by)f(the)g(w)o(ay)-5
b(,)19 b(is)i(the)f(reason)e(Common)h(Lisp)g(v)o(endors)f(generally)g
(insist)j(on)e(runtime)555 2966 y(licenses.)28 b(If)17
b(you)f(can)g(call)i Fs(eval)d FA(at)j(runtime,)e(then)g(an)o(y)g(Lisp)
h(program)d(can)j(include)f(Lisp.)555 3219 y Fw(4.7)99
b(Symbols)25 b(and)g(Strings)680 3409 y FA(Symbols)h(and)i(strings)f
(are)h(closely)f(related.)52 b(By)28 b(means)f(of)h(printing)e(and)h
(reading)555 3514 y(functions)22 b(we)h(can)g(go)f(back)g(and)h(forth)f
(between)g(the)h(tw)o(o)g(representations.)36 b(Figure)22
b(4.8)555 3618 y(contains)30 b(e)o(xamples)g(of)g(utilities)h(which)g
(operate)e(on)h(this)i(border)-5 b(.)59 b(The)30 b(\002rst,)k
Fs(mkstr)p FA(,)555 3723 y(tak)o(es)16 b(an)o(y)g(number)e(of)i(ar)o
(guments)e(and)h(concatenates)g(their)h(printed)f(representations)f
(into)555 3828 y(a)21 b(string:)555 4010 y Fs(>)43 b(\(mkstr)e(pi)i(")g
(pieces)e(of)i(")g('pi\))555 4110 y("3.1415926535897)o(93)37
b(pieces)k(of)i(PI")555 4298 y FA(Built)22 b(upon)e(it)i(is)g
Fs(symb)p FA(,)f(which)g(is)h(mostly)f(used)g(for)g(b)n(uilding)f
(symbols.)32 b(It)21 b(tak)o(es)h(one)f(or)555 4402 y(more)h(ar)o
(guments)f(and)i(returns)f(the)i(symbol)e(\(creating)g(one)g(if)i
(necessary\))e(whose)h(print\255)555 4507 y(name)i(is)h(their)f
(concatenation.)42 b(It)25 b(can)g(tak)o(e)h(as)g(an)f(ar)o(gument)e
(an)o(y)h(object)h(which)g(has)g(a)555 4611 y(printable)19
b(representation:)27 b(symbols,)20 b(strings,)g(numbers,)e(e)n(v)o(en)h
(lists.)555 4794 y Fs(>)43 b(\(symb)f('ar)g("Madi")f(#\\L)h(#\\L)h(0\))
555 4894 y(|ARMadiLL0|)p eop
%%Page: 58 71
58 70 bop 555 538 a FA(58)964 b Fu(UTILITY)17 b(FUNCTIONS)p
555 745 2678 4 v 553 2565 4 1820 v 605 888 a Fs(\(defun)41
b(mkstr)g(\(&rest)h(args\))692 988 y(\(with-output-to-)o(str)o(in)o(g)
37 b(\(s\))779 1087 y(\(dolist)k(\(a)i(args\))e(\(princ)g(a)i
(s\)\)\)\))605 1287 y(\(defun)e(symb)h(\(&rest)f(args\))692
1386 y(\(values)g(\(intern)f(\(apply)h(#'mkstr)g(args\)\)\)\))605
1586 y(\(defun)g(reread)g(\(&rest)g(args\))692 1685 y(\(values)g
(\(read-from-stri)o(ng)c(\(apply)k(#'mkstr)g(args\)\)\)\))605
1884 y(\(defun)g(explode)g(\(sym\))692 1984 y(\(map)h('list)f
(#'\(lambda)f(\(c\))1346 2084 y(\(intern)g(\(make-string)f(1)2261
2183 y(:initial-element)e(c\)\)\))1171 2283 y(\(symbol-name)i
(sym\)\)\))886 2487 y FA(Figure)19 b(4.8:)29 b(Functions)19
b(which)h(operate)f(on)h(symbols)g(and)f(strings.)p 3231
2565 V 555 2569 2678 4 v 555 2793 a(After)29 b(calling)f
Fs(mkstr)f FA(to)i(concatenate)f(all)h(its)h(ar)o(guments)d(into)h(a)h
(single)g(string,)i Fs(symb)555 2897 y FA(sends)21 b(the)h(string)f(to)
h Fs(intern)p FA(.)31 b(This)21 b(function)f(is)i(Lisp')-5
b(s)22 b(traditional)f(symbol\255b)n(uilder:)29 b(it)555
3002 y(tak)o(es)c(a)h(string)e(and)g(either)h(\002nds)g(the)g(symbol)f
(which)g(prints)h(as)g(the)g(string,)h(or)e(mak)o(es)h(a)555
3107 y(ne)n(w)20 b(one)g(which)f(does.)680 3211 y(An)o(y)f(string)h
(can)g(be)g(the)g(print\255name)e(of)i(a)g(symbol,)f(e)n(v)o(en)g(a)i
(string)f(containing)e(lo)n(wer)n(\255)555 3316 y(case)g(letters)h(or)e
(macro)g(characters)g(lik)o(e)h(parentheses.)27 b(When)17
b(a)g(symbol')-5 b(s)16 b(name)g(contains)555 3420 y(such)27
b(oddities,)i(it)f(is)g(printed)e(within)h(v)o(ertical)g(bars,)i(as)f
(abo)o(v)o(e.)49 b(In)27 b(source)g(code,)h(such)555
3525 y(symbols)h(should)f(either)h(be)g(enclosed)f(in)h(v)o(ertical)g
(bars,)i(or)e(the)g(of)n(fending)e(characters)555 3630
y(preceded)18 b(by)i(backslashes:)555 3812 y Fs(>)43
b(\(let)f(\(\(s)g(\(symb)g('\(a)g(b\)\)\)\))729 3912
y(\(and)g(\(eq)h(s)g('|\(A)f(B\)|\))g(\(eq)g(s)h('\\\(A\\)f
(B\\\)\)\)\))555 4012 y(T)680 4199 y FA(The)25 b(ne)o(xt)g(function,)h
Fs(reread)p FA(,)f(is)i(a)f(generalization)e(of)h Fs(symb)p
FA(.)46 b(It)26 b(tak)o(es)g(a)g(series)h(of)555 4304
y(objects,)c(and)g(prints)g(and)f(rereads)h(them.)37
b(It)24 b(can)f(return)e(symbols)i(lik)o(e)g Fs(symb)p
FA(,)g(b)n(ut)g(it)h(can)555 4408 y(also)f(return)e(an)o(ything)f(else)
j(that)f Fs(read)g FA(can.)35 b(Read\255macros)21 b(will)i(be)f(in)m(v)
n(ok)o(ed)f(instead)h(of)555 4513 y(being)i(treated)g(as)i(part)f(of)g
(a)g(symbol')-5 b(s)24 b(name,)i(and)e Fs(a:b)h FA(will)g(be)g(read)g
(as)g(the)g(symbol)f Fs(b)555 4618 y FA(in)k(package)e
Fs(a)p FA(,)j(instead)e(of)g(the)g(symbol)g Fs(|a:b|)f
FA(in)h(the)h(current)e(package.)2830 4587 y Fm(1)2912
4618 y FA(The)h(more)555 4722 y(general)e(function)g(is)i(also)f
(pickier:)41 b Fs(reread)24 b FA(will)j(generate)e(an)h(error)f(if)h
(its)i(ar)o(guments)555 4827 y(are)20 b(not)g(proper)e(Lisp)j(syntax.)p
555 4898 1074 4 v 645 4954 a Fl(1)675 4978 y Fr(F)o(or)16
b(an)i(introduction)i(to)d(packages,)i(see)e(the)h(Appendix)h(be)o
(ginning)g(on)e(page)h(381.)p eop
%%Page: 59 72
59 71 bop 555 538 a Ft(4.8)1129 b Fu(DENSITY)1112 b FA(59)680
801 y(The)34 b(last)i(function)d(in)i(Figure)f(4.8)h(w)o(as)g
(prede\002ned)e(in)i(se)n(v)o(eral)g(earlier)f(dialects:)555
905 y Fs(explode)21 b FA(tak)o(es)j(a)g(symbol)f(and)g(returns)g(a)h
(list)h(of)e(symbols)g(made)g(from)g(the)h(characters)555
1010 y(in)c(its)i(name.)555 1165 y Fs(>)43 b(\(explode)d('bomb\))555
1264 y(\(B)j(O)g(M)g(B\))555 1424 y FA(It)33 b(is)h(no)f(accident)f
(that)h(this)h(function)d(w)o(asn')o(t)i(included)e(in)i(Common)f
(Lisp.)68 b(If)32 b(you)555 1529 y(\002nd)e(yourself)f(w)o(anting)g(to)
h(tak)o(e)g(apart)g(symbols,)h(you')l(re)e(probably)e(doing)i
(something)555 1633 y(inef)n(\002cient.)38 b(Ho)n(we)n(v)o(er)m(,)23
b(there)g(is)h(a)g(place)g(for)e(this)j(kind)d(of)i(utility)f(in)h
(prototypes,)e(if)i(not)555 1738 y(in)c(production)e(softw)o(are.)555
1986 y Fw(4.8)99 b(Density)555 2176 y FA(If)15 b(your)f(code)h(uses)h
(a)g(lot)g(of)f(ne)n(w)g(utilities,)i(some)e(readers)g(may)g(complain)f
(that)h(it)i(is)f(hard)e(to)555 2281 y(understand.)25
b(People)16 b(who)f(are)g(not)g(yet)h(v)o(ery)e(\003uent)h(in)h(Lisp)g
(will)g(only)f(be)g(used)g(to)h(reading)555 2385 y(ra)o(w)24
b(Lisp.)41 b(In)23 b(f)o(act,)i(the)o(y)f(may)f(not)h(be)g(used)g(to)g
(the)g(idea)g(of)g(an)g(e)o(xtensible)f(language)f(at)555
2490 y(all.)29 b(When)19 b(the)o(y)g(look)f(at)h(a)h(program)d(which)h
(depends)g(hea)n(vily)h(on)f(utilities,)i(it)g(may)e(seem)555
2595 y(to)i(them)f(that)h(the)f(author)g(has,)h(out)f(of)g(pure)g
(eccentricity)-5 b(,)18 b(decided)g(to)i(write)g(the)g(program)555
2699 y(in)g(some)g(sort)h(of)f(pri)n(v)n(ate)f(language.)680
2804 y(All)g(these)g(ne)n(w)g(operators,)e(it)i(might)g(be)f(ar)o
(gued,)f(mak)o(e)i(the)f(program)f(harder)g(to)i(read.)555
2908 y(One)28 b(has)g(to)g(understand)d(them)i(all)i(before)d(being)h
(able)h(to)f(read)h(the)f(program.)50 b(T)-7 b(o)28 b(see)555
3013 y(why)23 b(this)i(kind)f(of)g(statement)g(is)h(mistak)o(en,)g
(consider)e(the)i(case)g(described)e(on)h(page)f(41,)555
3118 y(in)f(which)f(we)h(w)o(ant)g(to)f(\002nd)h(the)f(nearest)h
(bookshops.)31 b(If)21 b(you)g(wrote)g(the)h(program)d(using)555
3222 y Fs(find2)p FA(,)e(someone)h(could)g(complain)f(that)i(the)o(y)g
(had)f(to)h(understand)e(the)i(de\002nition)e(of)i(this)555
3327 y(ne)n(w)j(utility)g(before)f(the)o(y)g(could)g(read)g(your)g
(program.)33 b(W)-7 b(ell,)23 b(suppose)e(you)h(hadn')o(t)e(used)555
3432 y Fs(find2)p FA(.)28 b(Then,)20 b(instead)g(of)g(ha)n(ving)f(to)i
(understand)d(the)i(de\002nition)f(of)i Fs(find2)p FA(,)d(the)j(reader)
555 3536 y(w)o(ould)14 b(ha)n(v)o(e)g(had)g(to)h(understand)e(the)h
(de\002nition)g(of)h Fs(find-books)p FA(,)d(in)i(which)h(the)f
(function)555 3641 y(of)23 b Fs(find2)f FA(is)j(mix)o(ed)d(up)h(with)h
(the)f(speci\002c)h(task)g(of)f(\002nding)f(bookshops.)37
b(It)24 b(is)g(no)f(more)555 3745 y(dif)n(\002cult)18
b(to)h(understand)d Fs(find2)h FA(than)h Fs(find-books)p
FA(.)25 b(And)19 b(here)f(we)g(ha)n(v)o(e)g(only)g(used)h(the)555
3850 y(ne)n(w)k(utility)g(once.)38 b(Utilities)25 b(are)e(meant)g(to)g
(be)g(used)h(repeatedly)-5 b(.)36 b(In)23 b(a)h(real)f(program,)f(it)
555 3955 y(might)17 b(be)g(a)h(choice)f(between)g(ha)n(ving)f(to)i
(understand)d Fs(find2)p FA(,)i(and)g(ha)n(ving)f(to)i(understand)555
4059 y(three)i(or)g(four)f(specialized)g(search)h(routines.)28
b(Surely)20 b(the)g(former)f(is)i(easier)-5 b(.)680 4164
y(So)23 b(yes,)i(reading)d(a)i(bottom\255up)d(program)h(requires)g(one)
i(to)f(understand)f(all)i(the)g(ne)n(w)555 4268 y(operators)j
(de\002ned)g(by)g(the)h(author)-5 b(.)53 b(But)28 b(this)h(will)g
(nearly)e(al)o(w)o(ays)h(be)g(less)i(w)o(ork)d(than)555
4373 y(ha)n(ving)19 b(to)h(understand)e(all)j(the)f(code)g(that)g(w)o
(ould)g(ha)n(v)o(e)f(been)h(required)e(without)i(them.)680
4478 y(If)31 b(people)f(complain)f(that)j(using)e(utilities)i(mak)o(es)
f(your)f(code)h(hard)f(to)h(read,)i(the)o(y)555 4582
y(probably)26 b(don')o(t)g(realize)i(what)g(the)g(code)g(w)o(ould)f
(look)g(lik)o(e)i(if)f(you)f(hadn')o(t)f(used)i(them.)555
4687 y(Bottom\255up)c(programming)e(mak)o(es)k(what)f(w)o(ould)g
(otherwise)g(be)h(a)g(lar)o(ge)f(program)e(look)555 4791
y(lik)o(e)i(a)f(small,)i(simple)f(one.)41 b(This)24 b(can)h(gi)n(v)o(e)
e(the)i(impression)e(that)h(the)h(program)d(doesn')o(t)555
4896 y(do)d(much,)g(and)g(should)f(therefore)g(be)i(easy)f(to)h(read.)
29 b(When)19 b(ine)o(xperienced)e(readers)h(look)555
5001 y(closer)i(and)g(\002nd)g(that)g(this)h(isn')o(t)e(so,)i(the)o(y)e
(react)h(with)h(dismay)-5 b(.)p eop
%%Page: 60 73
60 72 bop 555 538 a FA(60)964 b Fu(UTILITY)17 b(FUNCTIONS)680
801 y FA(W)-7 b(e)22 b(\002nd)g(the)g(same)g(phenomenon)c(in)k(other)f
(\002elds:)33 b(a)22 b(well\255designed)e(machine)h(may)555
905 y(ha)n(v)o(e)32 b(fe)n(wer)f(parts,)k(and)d(yet)g(look)f(more)g
(complicated,)j(because)d(it)i(is)g(pack)o(ed)e(into)h(a)555
1010 y(smaller)17 b(space.)27 b(Bottom\255up)15 b(programs)g(are)i
(conceptually)d(denser)-5 b(.)28 b(It)16 b(may)h(tak)o(e)f(an)h(ef)n
(fort)555 1114 y(to)g(read)f(them,)h(b)n(ut)g(not)f(as)h(much)f(as)i
(it)f(w)o(ould)f(tak)o(e)h(if)g(the)o(y)f(hadn')o(t)f(been)h(written)g
(that)h(w)o(ay)-5 b(.)680 1219 y(There)29 b(is)i(one)e(case)i(in)f
(which)g(you)f(might)g(deliberately)g(a)n(v)n(oid)h(using)f(utilities:)
50 b(if)555 1324 y(you)26 b(had)g(to)h(write)f(a)h(small)h(program)c
(to)j(be)f(distrib)n(uted)g(independently)e(of)i(the)h(rest)g(of)555
1428 y(your)21 b(code.)35 b(A)23 b(utility)g(usually)e(pays)i(for)e
(itself)i(after)f(tw)o(o)h(or)f(three)g(uses,)h(b)n(ut)g(in)f(a)h
(small)555 1533 y(program,)18 b(a)i(utility)h(might)e(not)h(be)g(used)g
(enough)e(to)j(justify)f(including)e(it.)p eop
%%Page: 61 74
61 73 bop 555 1610 a Fn(5)p 555 1872 2686 3 v 555 2131
a Fx(Retur)n(ning)42 b(Functions)555 2568 y FA(The)18
b(pre)n(vious)e(chapter)h(sho)n(wed)f(ho)n(w)i(the)g(ability)f(to)h
(pass)h(functions)d(as)j(ar)o(guments)c(leads)555 2672
y(to)j(greater)f(possibilities)h(for)f(abstraction.)27
b(The)18 b(more)f(we)h(can)g(do)f(to)h(functions,)f(the)g(more)555
2777 y(we)24 b(can)g(tak)o(e)g(adv)n(antage)e(of)i(these)g
(possibilities.)41 b(By)25 b(de\002ning)e(functions)f(to)i(b)n(uild)g
(and)555 2882 y(return)d(ne)n(w)h(functions,)g(we)g(can)h(magnify)d
(the)j(ef)n(fect)e(of)i(utilities)g(which)f(tak)o(e)g(functions)555
2986 y(as)f(ar)o(guments.)680 3091 y(The)e(utilities)i(in)g(this)f
(chapter)f(operate)g(on)h(functions.)28 b(It)20 b(w)o(ould)g(be)g(more)
f(natural,)g(at)555 3195 y(least)i(in)g(Common)e(Lisp,)i(to)g(write)g
(man)o(y)e(of)h(them)h(to)f(operate)g(on)g(e)o(xpressions\227that)f
(is,)555 3300 y(as)25 b(macros.)42 b(A)25 b(layer)f(of)g(macros)g(will)
i(be)e(superimposed)e(on)j(some)f(of)g(these)h(operators)555
3405 y(in)k(Chapter)g(15.)56 b(Ho)n(we)n(v)o(er)m(,)30
b(it)g(is)g(important)e(to)h(kno)n(w)f(what)i(part)f(of)g(the)g(task)h
(can)f(be)555 3509 y(done)21 b(with)h(functions,)e(e)n(v)o(en)h(if)h
(we)g(will)g(e)n(v)o(entually)e(call)j(these)e(functions)g(only)g
(through)555 3614 y(macros.)555 3867 y Fw(5.1)99 b(Common)25
b(Lisp)g(Ev)o(olv)o(es)555 4057 y FA(Common)16 b(Lisp)i(originally)e
(pro)o(vided)f(se)n(v)o(eral)i(pairs)g(of)g(complementary)e(functions.)
27 b(The)555 4162 y(functions)j Fs(remove-if)e FA(and)i
Fs(remove-if-not)c FA(mak)o(e)31 b(one)f(such)h(pair)-5
b(.)62 b(If)31 b Fs(pred)f FA(is)i(a)555 4266 y(predicate)19
b(of)h(one)g(ar)o(gument,)d(then)555 4449 y Fs(\(remove-if-not)38
b(#'pred)j(lst\))555 4637 y FA(is)21 b(equi)n(v)n(alent)e(to)555
4819 y Fs(\(remove-if)39 b(#'\(lambda)h(\(x\))j(\(not)f(\(pred)f
(x\)\)\))h(lst\))1856 5229 y FA(61)p eop
%%Page: 62 75
62 74 bop 555 538 a FA(62)909 b Fu(RETURNING)18 b(FUNCTIONS)680
801 y FA(By)28 b(v)n(arying)e(the)h(function)f(gi)n(v)o(en)h(as)h(an)g
(ar)o(gument)d(to)j(one,)h(we)f(can)g(duplicate)f(the)555
905 y(ef)n(fect)c(of)g(the)g(other)-5 b(.)37 b(In)23
b(that)h(case,)g(why)e(ha)n(v)o(e)h(both?)37 b(C)p Fr(L)-6
b(TL)p FA(2)22 b(includes)h(a)g(ne)n(w)g(function)555
1010 y(intended)13 b(for)h(cases)h(lik)o(e)g(this:)27
b Fs(complement)11 b FA(tak)o(es)k(a)g(predicate)e Ft(p)i
FA(and)f(returns)f(a)i(function)555 1114 y(which)25 b(al)o(w)o(ays)h
(returns)f(the)g(opposite)g(v)n(alue.)45 b(When)25 b
Ft(p)h FA(returns)f(true,)h(the)g(complement)555 1219
y(returns)19 b(f)o(alse,)i(and)e(vice)h(v)o(ersa.)29
b(No)n(w)20 b(we)h(can)f(replace)555 1402 y Fs(\(remove-if-not)38
b(#'pred)j(lst\))555 1589 y FA(with)20 b(the)h(equi)n(v)n(alent)555
1772 y Fs(\(remove-if)39 b(\(complement)g(#'pred\))i(lst\))555
1960 y FA(W)m(ith)24 b Fs(complement)p FA(,)c(there)k(is)g(little)g
(justi\002cation)g(for)f(continuing)e(to)j(use)f(the)h
Fs(-if-not)555 2064 y FA(functions.)887 2034 y Fm(1)955
2064 y FA(Indeed,)d Fr(CL)-6 b(TL)p FA(2)22 b(\(p.)g(391\))f(says)i
(that)f(their)h(use)f(is)i(no)n(w)e(deprecated.)34 b(If)22
b(the)o(y)555 2169 y(remain)d(in)i(Common)e(Lisp,)h(it)h(will)f(only)g
(be)g(for)g(the)g(sak)o(e)g(of)g(compatibility)-5 b(.)680
2273 y(The)24 b(ne)n(w)h Fs(complement)c FA(operator)i(is)j(the)e(tip)h
(of)g(an)g(important)e(iceber)o(g:)37 b(functions)555
2378 y(which)30 b(return)e(functions.)58 b(This)30 b(has)h(long)e(been)
g(an)h(important)f(part)g(of)h(the)g(idiom)g(of)555 2483
y(Scheme.)42 b(Scheme)24 b(w)o(as)h(the)f(\002rst)i(Lisp)e(to)h(mak)o
(e)f(functions)f(le)o(xical)h(closures,)h(and)f(it)i(is)555
2587 y(this)21 b(which)e(mak)o(es)h(it)h(interesting)f(to)g(ha)n(v)o(e)
g(functions)e(as)j(return)e(v)n(alues.)680 2692 y(It')-5
b(s)24 b(not)f(that)g(we)h(couldn')o(t)e(return)g(functions)g(in)i(a)g
(dynamically)d(scoped)i(Lisp.)39 b(The)555 2797 y(follo)n(wing)19
b(function)f(w)o(ould)i(w)o(ork)f(the)h(same)h(under)d(dynamic)h(or)h
(le)o(xical)g(scope:)555 2979 y Fs(\(defun)41 b(joiner)g(\(obj\))642
3079 y(\(typecase)f(obj)729 3178 y(\(cons)129 b(#'append\))729
3278 y(\(number)41 b(#'+\)\)\))555 3466 y FA(It)17 b(tak)o(es)f(an)h
(object)f(and,)g(depending)e(on)i(its)h(type,)f(returns)g(a)h(function)
d(to)j(add)f(such)g(objects)555 3570 y(together)-5 b(.)32
b(W)-7 b(e)23 b(could)d(use)i(it)g(to)g(de\002ne)f(a)h(polymorphic)c
Fs(join)i FA(function)g(that)i(w)o(ork)o(ed)e(for)555
3675 y(numbers)f(or)h(lists:)555 3858 y Fs(\(defun)41
b(join)h(\(&rest)f(args\))642 3957 y(\(apply)g(\(joiner)g(\(car)h
(args\)\))f(args\)\))555 4145 y FA(Ho)n(we)n(v)o(er)m(,)14
b(returning)f(constant)i(functions)e(is)k(the)e(limit)g(of)g(what)g(we)
h(can)f(do)g(with)g(dynamic)555 4249 y(scope.)33 b(What)23
b(we)f(can')o(t)e(do)i(\(well\))f(is)i(b)n(uild)e(functions)g(at)h
(runtime;)f Fs(joiner)f FA(can)i(return)555 4354 y(one)e(of)g(tw)o(o)g
(functions,)f(b)n(ut)h(the)g(tw)o(o)g(choices)g(are)g(\002x)o(ed.)680
4459 y(On)h(page)g(18)f(we)i(sa)o(w)g(another)e(function)f(for)i
(returning)e(functions,)h(which)h(relied)g(on)555 4563
y(le)o(xical)f(scope:)555 4746 y Fs(\(defun)41 b(make-adder)f(\(n\))642
4845 y(#'\(lambda)g(\(x\))i(\(+)h(x)g(n\)\)\))p 555 4906
1074 4 v 645 4962 a Fl(1)675 4985 y Fr(Except)18 b(perhaps)g
Fk(remove-if-not)p Fr(,)i(which)e(is)f(used)g(more)g(often)h(than)g
Fk(remove-if)p Fr(.)p eop
%%Page: 63 76
63 75 bop 555 538 a Ft(5.2)1003 b Fu(OR)l(THOGON)n(ALITY)985
b FA(63)555 801 y(Calling)27 b Fs(make-adder)22 b FA(will)28
b(yield)e(a)h(closure)f(whose)g(beha)n(vior)f(depends)g(on)h(the)g(v)n
(alue)555 905 y(originally)19 b(gi)n(v)o(en)g(as)h(an)h(ar)o(gument:)
555 1080 y Fs(>)43 b(\(setq)f(add3)g(\(make-adder)d(3\)\))555
1180 y(#<Interpreted-Fu)o(nct)o(io)o(n)e(BF1356>)555
1279 y(>)43 b(\(funcall)d(add3)i(2\))555 1379 y(5)555
1559 y FA(Under)18 b(le)o(xical)h(scope,)f(instead)h(of)g(merely)f
(choosing)f(among)h(a)h(group)f(of)h(constant)f(func\255)555
1664 y(tions,)23 b(we)g(can)g(b)n(uild)f(ne)n(w)g(closures)h(at)g
(runtime.)36 b(W)m(ith)23 b(dynamic)e(scope)h(this)h(technique)555
1768 y(is)f(impossible.)1014 1738 y Fm(2)1078 1768 y
FA(If)f(we)g(consider)f(ho)n(w)h Fs(complement)c FA(w)o(ould)j(be)h
(written,)g(we)g(see)h(that)f(it)555 1873 y(too)f(must)g(return)f(a)i
(closure:)555 2048 y Fs(\(defun)41 b(complement)f(\(fn\))642
2147 y(#'\(lambda)g(\(&rest)h(args\))h(\(not)g(\(apply)f(fn)h
(args\)\)\)\))555 2327 y FA(The)23 b(function)f(returned)g(by)i
Fs(complement)c FA(uses)k(the)g(v)n(alue)f(of)h(the)f(parameter)g
Fs(fn)g FA(when)555 2432 y Fs(complement)g FA(w)o(as)28
b(called.)49 b(So)27 b(instead)g(of)g(just)g(choosing)e(from)h(a)i
(group)d(of)h(constant)555 2536 y(functions,)19 b Fs(complement)d
FA(can)k(custom\255b)n(uild)e(the)j(in)m(v)o(erse)e(of)g(an)o(y)h
(function:)555 2711 y Fs(>)43 b(\(remove-if)d(\(complement)f(#'oddp\))h
('\(1)j(2)g(3)g(4)g(5)g(6\)\))555 2811 y(\(1)g(3)g(5\))680
2991 y FA(Being)23 b(able)h(to)g(pass)g(functions)f(as)h(ar)o(guments)e
(is)j(a)f(po)n(werful)e(tool)i(for)f(abstraction.)555
3095 y(The)f(ability)g(to)g(write)g(functions)f(which)g(return)g
(functions)g(allo)n(ws)h(us)h(to)f(mak)o(e)f(the)i(most)555
3200 y(of)j(it.)47 b(The)25 b(remaining)g(sections)h(present)f(se)n(v)o
(eral)g(e)o(xamples)g(of)h(utilities)g(which)g(return)555
3305 y(functions.)555 3556 y Fw(5.2)99 b(Orthogonality)555
3747 y FA(An)14 b Ft(ortho)o(gonal)g FA(language)g(is)g(o)o(ne)f(in)h
(wh)o(ich)f(yo)o(u)g(can)g(e)o(xp)o(ress)h(a)f(lot)h(b)o(y)g(c)o(omb)o
(inin)o(g)g(a)f(small)555 3851 y(number)19 b(of)i(operators)e(in)i(a)g
(lot)g(of)g(dif)n(ferent)e(w)o(ays.)31 b(T)-7 b(o)o(y)21
b(blocks)f(are)h(v)o(ery)f(orthogonal;)e(a)555 3956 y(plastic)i(model)e
(kit)h(is)i(hardly)c(orthogonal)g(at)j(all.)29 b(The)19
b(main)g(adv)n(antage)e(of)i Fs(complement)555 4060 y
FA(is)34 b(that)e(it)h(mak)o(es)g(a)g(language)e(more)g(orthogonal.)64
b(Before)32 b Fs(complement)p FA(,)g(Common)555 4165
y(Lisp)18 b(had)g(pairs)g(of)f(functions)g(lik)o(e)h
Fs(remove-if)d FA(and)i Fs(remove-if-not)p FA(,)d Fs(subst-if)h
FA(and)555 4270 y Fs(subst-if-not)p FA(,)h(and)j(so)i(on.)28
b(W)m(ith)21 b Fs(complement)c FA(we)j(can)g(do)g(without)f(half)h(of)g
(them.)680 4374 y(The)i Fs(setf)g FA(macro)f(also)i(impro)o(v)o(es)e
(Lisp')-5 b(s)23 b(orthogonality)-5 b(.)34 b(Earlier)22
b(dialects)h(of)f(Lisp)555 4479 y(w)o(ould)f(often)g(ha)n(v)o(e)g
(pairs)g(of)h(functions)e(for)h(reading)f(and)h(writing)g(data.)33
b(W)m(ith)22 b(property\255)555 4583 y(lists,)e(for)e(e)o(xample,)f
(there)h(w)o(ould)g(be)g(one)g(function)f(to)h(establish)h(properties)e
(and)h(another)555 4688 y(function)23 b(to)i(ask)f(about)g(them.)42
b(In)24 b(Common)g(Lisp,)h(we)g(ha)n(v)o(e)f(only)g(the)g(latter)m(,)i
Fs(get)p FA(.)41 b(T)-7 b(o)p 555 4756 1074 4 v 645 4812
a Fl(2)675 4835 y Fr(Under)26 b(dynamic)g(scope,)i(we)e(could)g(write)h
(something)f(lik)o(e)h Fk(make-adder)p Fr(,)j(b)o(ut)25
b(it)h(w)o(ould)h(hardly)f(e)n(v)o(er)555 4918 y(w)o(ork.)h(The)18
b(binding)h(of)f Fk(n)f Fr(w)o(ould)i(be)f(determined)j(by)c(the)i(en)m
(vironment)h(in)f(which)f(the)h(returned)h(function)f(w)o(as)555
5001 y(e)n(v)o(entually)i(called,)d(and)g(we)f(might)h(not)f(ha)o(v)o
(e)h(an)o(y)f(control)i(o)o(v)o(er)f(that.)p eop
%%Page: 64 77
64 76 bop 555 538 a FA(64)909 b Fu(RETURNING)18 b(FUNCTIONS)p
555 745 2678 4 v 553 1768 4 1023 v 605 888 a Fs(\(defvar)41
b(*!equivs*)e(\(make-hash-table\))o(\))605 1087 y(\(defun)i(!)i(\(fn\))
692 1187 y(\(or)f(\(gethash)f(fn)h(*!equivs*\))e(fn\)\))605
1386 y(\(defun)h(def!)h(\(fn)g(fn!\))692 1486 y(\(setf)g(\(gethash)e
(fn)j(*!equivs*\))c(fn!\)\))1132 1690 y FA(Figure)19
b(5.1:)29 b(Returning)19 b(destructi)n(v)o(e)g(equi)n(v)n(alents.)p
3231 1768 V 555 1772 2678 4 v 555 1996 a(establish)h(a)h(property)-5
b(,)17 b(we)k(use)f Fs(get)g FA(in)g(combination)e(with)i
Fs(setf)p FA(:)555 2178 y Fs(\(setf)42 b(\(get)f('ball)h('color\))f
('red\))680 2366 y FA(W)-7 b(e)20 b(may)f(not)g(be)g(able)g(to)h(mak)o
(e)f(Common)f(Lisp)h(smaller)m(,)g(b)n(ut)g(we)h(can)f(do)g(something)
555 2471 y(almost)d(as)g(good:)26 b(use)16 b(a)h(smaller)e(subset)h(of)
g(it.)28 b(Can)17 b(we)f(de\002ne)f(an)o(y)g(ne)n(w)h(operators)e
(which)555 2575 y(w)o(ould,)27 b(lik)o(e)g Fs(complement)c
FA(and)j Fs(setf)p FA(,)h(help)f(us)h(to)n(w)o(ard)f(this)h(goal?)48
b(There)25 b(is)j(at)f(least)555 2680 y(one)17 b(other)g(w)o(ay)g(in)h
(which)f(functions)f(are)h(grouped)e(in)j(pairs.)28 b(Man)o(y)16
b(functions)g(also)i(come)555 2784 y(in)24 b(a)h(destructi)n(v)o(e)e(v)
o(ersion:)36 b Fs(remove-if)21 b FA(and)i Fs(delete-if)p
FA(,)f Fs(reverse)g FA(and)i Fs(nreverse)p FA(,)555 2889
y Fs(append)18 b FA(and)i Fs(nconc)p FA(.)28 b(By)20
b(de\002ning)f(an)h(operator)f(to)h(return)f(the)h(destructi)n(v)o(e)f
(counterpart)555 2994 y(of)h(a)h(function,)d(we)i(w)o(ould)g(not)g(ha)n
(v)o(e)f(to)i(refer)e(to)h(the)h(destructi)n(v)o(e)d(functions)h
(directly)-5 b(.)680 3098 y(Figure)30 b(5.1)h(contains)f(code)h(to)g
(support)f(the)h(notion)f(of)h(destructi)n(v)o(e)f(counterparts.)555
3203 y(The)16 b(global)g(hash\255table)g Fs(*!equivs*)d
FA(maps)k(functions)e(to)i(their)g(destructi)n(v)o(e)e(equi)n(v)n
(alents;)555 3308 y Fs(!)22 b FA(returns)f(destructi)n(v)o(e)g(equi)n
(v)n(alents;)g(and)h Fs(def!)f FA(sets)i(them.)34 b(The)22
b(name)f(of)h(the)g Fs(!)g FA(\(bang\))555 3412 y(operator)31
b(comes)h(from)g(the)h(Scheme)f(con)m(v)o(ention)e(of)i(appending)f
Fs(!)i FA(to)g(the)f(names)h(of)555 3517 y(functions)19
b(with)h(side\255ef)n(fects.)28 b(No)n(w)21 b(once)e(we)i(ha)n(v)o(e)e
(de\002ned)555 3699 y Fs(\(def!)42 b(#'remove-if)d(#'delete-if\))555
3887 y FA(then)20 b(instead)g(of)555 4070 y Fs(\(delete-if)39
b(#'oddp)j(lst\))555 4257 y FA(we)21 b(w)o(ould)e(say)555
4440 y Fs(\(funcall)40 b(\(!)j(#'remove-if\))c(#'oddp)i(lst\))555
4628 y FA(Here)29 b(the)g(a)o(wkw)o(ardness)e(of)i(Common)e(Lisp)i
(masks)g(the)g(basic)g(ele)o(gance)e(of)i(the)g(idea,)555
4732 y(which)20 b(w)o(ould)f(be)h(more)g(visible)g(in)g(Scheme:)555
4915 y Fs(\(\(!)42 b(remove-if\))e(oddp)i(lst\))p eop
%%Page: 65 78
65 77 bop 555 538 a Ft(5.3)1083 b Fu(MEMOIZING)1065 b
FA(65)p 555 745 2678 4 v 553 1868 4 1123 v 605 888 a
Fs(\(defun)41 b(memoize)g(\(fn\))692 988 y(\(let)h(\(\(cache)f
(\(make-hash-tabl)o(e)d(:test)j(#'equal\)\)\))779 1087
y(#'\(lambda)f(\(&rest)h(args\))954 1187 y(\(multiple-value)o(-b)o(ind)
c(\(val)42 b(win\))g(\(gethash)e(args)i(cache\))1041
1287 y(\(if)g(win)1215 1386 y(val)1215 1486 y(\(setf)g(\(gethash)e
(args)i(cache\))1477 1586 y(\(apply)f(fn)h(args\)\)\)\)\)\)\))1388
1790 y FA(Figure)19 b(5.2:)29 b(Memoizing)19 b(utility)-5
b(.)p 3231 1868 V 555 1871 2678 4 v 680 2077 a(As)19
b(well)g(as)h(greater)e(orthogonality)-5 b(,)15 b(the)k
Fs(!)g FA(operator)e(brings)g(a)j(couple)d(of)i(other)f(bene\255)555
2181 y(\002ts.)30 b(It)20 b(mak)o(es)f(programs)f(clearer)m(,)h
(because)f(we)i(can)g(see)g(immediately)e(that)i Fs(\(!)42
b(#'foo\))555 2286 y FA(is)27 b(the)f(destructi)n(v)o(e)e(equi)n(v)n
(alent)h(of)g Fs(foo)p FA(.)46 b(Also,)28 b(it)f(gi)n(v)o(es)e
(destructi)n(v)o(e)g(operations)f(a)i(dis\255)555 2390
y(tinct,)16 b(recognizable)c(form)i(in)h(source)f(code,)h(which)f(is)i
(good)d(because)h(the)o(y)g(should)g(recei)n(v)o(e)555
2495 y(special)20 b(attention)g(when)f(we)i(are)f(searching)f(for)g(a)i
(b)n(ug.)680 2600 y(Since)35 b(the)h(relation)f(between)g(a)i(function)
d(and)h(its)i(destructi)n(v)o(e)d(counterpart)g(will)555
2704 y(usually)e(be)h(kno)n(wn)f(before)f(runtime,)k(it)e(w)o(ould)g
(be)g(most)f(ef)n(\002cient)h(to)g(de\002ne)f Fs(!)i
FA(as)f(a)555 2809 y(macro,)19 b(or)h(e)n(v)o(en)f(pro)o(vide)f(a)j
(read)e(macro)h(for)f(it.)555 3057 y Fw(5.3)99 b(Memoizing)555
3248 y FA(If)22 b(some)f(function)f(is)j(e)o(xpensi)n(v)o(e)d(to)i
(compute,)e(and)i(we)g(e)o(xpect)f(sometimes)g(to)h(mak)o(e)g(the)555
3352 y(same)g(call)g(more)f(than)h(once,)f(then)g(it)i(pays)e(to)h
Ft(memoize:)33 b FA(to)22 b(cache)f(the)h(return)e(v)n(alues)i(of)555
3457 y(all)d(the)f(pre)n(vious)f(calls,)i(and)f(each)g(time)g(the)h
(function)d(is)k(about)d(to)h(be)h(called,)f(to)g(look)g(\002rst)555
3562 y(in)i(the)h(cache)e(to)i(see)f(if)h(the)f(v)n(alue)g(is)h
(already)e(kno)n(wn.)680 3666 y(Figure)26 b(5.2)h(contains)f(a)i
(generalized)e(memoizing)f(utility)-5 b(.)50 b(W)-7 b(e)29
b(gi)n(v)o(e)d(a)i(function)d(to)555 3771 y Fs(memoize)p
FA(,)18 b(and)h(it)i(returns)e(an)h(equi)n(v)n(alent)e(memoized)h(v)o
(ersion\227a)g(closure)g(containing)f(a)555 3876 y(hash\255table)h(in)h
(which)g(to)g(store)g(the)h(results)f(of)g(pre)n(vious)f(calls.)555
4035 y Fs(>)43 b(\(setq)f(slowid)f(\(memoize)f(#'\(lambda)g(\(x\))i
(\(sleep)f(5\))i(x\)\)\))555 4134 y(#<Interpreted-Fu)o(nct)o(io)o(n)37
b(C38346>)555 4234 y(>)43 b(\(time)f(\(funcall)e(slowid)h(1\)\))555
4333 y(Elapsed)g(Time)h(=)h(5.15)f(seconds)555 4433 y(1)555
4533 y(>)h(\(time)f(\(funcall)e(slowid)h(1\)\))555 4632
y(Elapsed)g(Time)h(=)h(0.00)f(seconds)555 4732 y(1)555
4896 y FA(W)m(ith)26 b(a)h(memoized)d(function,)h(repeated)g(calls)i
(are)f(just)g(hash\255table)f(lookups.)45 b(There)25
b(is)555 5001 y(of)k(course)g(the)g(additional)f(e)o(xpense)g(of)h(a)h
(lookup)e(on)h(each)g(initial)g(call,)j(b)n(ut)e(since)f(we)p
eop
%%Page: 66 79
66 78 bop 555 538 a FA(66)909 b Fu(RETURNING)18 b(FUNCTIONS)p
555 745 2678 4 v 553 1968 4 1223 v 605 888 a Fs(\(defun)41
b(compose)g(\(&rest)g(fns\))692 988 y(\(if)h(fns)866
1087 y(\(let)g(\(\(fn1)g(\(car)g(\(last)f(fns\)\)\))1128
1187 y(\(fns)h(\(butlast)e(fns\)\)\))954 1287 y(#'\(lambda)f(\(&rest)i
(args\))1128 1386 y(\(reduce)g(#'funcall)e(fns)1477 1486
y(:from-end)g(t)1477 1586 y(:initial-value)e(\(apply)k(fn1)i
(args\)\)\)\))866 1685 y(#'identity\)\))1034 1889 y FA(Figure)19
b(5.3:)29 b(An)20 b(operator)e(for)i(functional)e(composition.)p
3231 1968 V 555 1971 2678 4 v 555 2192 a(w)o(ould)25
b(only)f(memoize)h(a)h(function)e(that)h(w)o(as)i(suf)n(\002ciently)d
(e)o(xpensi)n(v)o(e)g(to)h(compute,)g(it')-5 b(s)555
2297 y(reasonable)19 b(to)h(assume)g(that)h(this)f(cost)h(is)g
(insigni\002cant)e(in)i(comparison.)680 2401 y(Though)e(adequate)i(for)
h(most)g(uses,)h(this)f(implementation)e(of)i Fs(memoize)e
FA(has)i(se)n(v)o(eral)555 2506 y(limitations.)28 b(It)16
b(treats)h(calls)g(as)g(identical)f(if)h(the)o(y)f(ha)n(v)o(e)g
Fs(equal)e FA(ar)o(gument)g(lists;)20 b(this)d(could)555
2611 y(be)j(too)g(strict)i(if)e(the)h(function)d(had)i(k)o(e)o(yw)o
(ord)f(parameters.)29 b(Also,)20 b(it)h(is)h(intended)d(only)g(for)555
2715 y(single\255v)n(alued)f(functions,)h(and)g(cannot)g(store)h(or)g
(return)f(multiple)h(v)n(alues.)555 2967 y Fw(5.4)99
b(Composing)25 b(Functions)555 3158 y FA(The)d(complement)e(of)j(a)f
(function)f Ft(f)i FA(is)g(denoted)e Fq(\030)p Ft(f)p
FA(.)36 b(Section)22 b(5.1)g(sho)n(wed)f(that)i(closures)555
3263 y(mak)o(e)h(it)i(possible)e(to)h(de\002ne)f Fq(\030)g
FA(as)i(a)f(Lisp)g(function.)40 b(Another)23 b(common)g(operation)g(on)
555 3367 y(functions)18 b(is)i(composition,)e(denoted)f(by)i(the)h
(operator)d Fq(\016)p FA(.)29 b(If)20 b Ft(f)g FA(and)e
Ft(g)i FA(are)f(functions,)f(then)555 3472 y Ft(f)12
b Fq(\016)p Ft(g)28 b FA(is)i(also)f(a)g(function,)f(and)g
Ft(f)12 b Fq(\016)p Ft(g)p FA(\()p Ft(x)p FA(\))28 b(=)h
Ft(f)12 b FA(\()p Ft(g)p FA(\()p Ft(x)p FA(\)\).)52 b(Closures)29
b(also)g(mak)o(e)f(it)h(possible)f(to)555 3576 y(de\002ne)20
b Fq(\016)g FA(as)h(a)f(Lisp)h(function.)680 3681 y(Figure)h(5.3)h
(de\002nes)g(a)h Fs(compose)d FA(function)g(which)i(tak)o(es)h(an)o(y)e
(number)g(of)h(functions)555 3786 y(and)d(returns)f(their)h
(composition.)27 b(F)o(or)20 b(e)o(xample)555 3965 y
Fs(\(compose)40 b(#'list)h(#'1+\))555 4149 y FA(returns)19
b(a)i(function)d(equi)n(v)n(alent)h(to)555 4328 y Fs(#'\(lambda)40
b(\(x\))i(\(list)g(\(1+)g(x\)\)\))555 4513 y FA(All)23
b(the)f(functions)e(gi)n(v)o(en)h(as)h(ar)o(guments)e(to)i
Fs(compose)e FA(must)i(be)g(functions)e(of)i(one)f(ar)o(gu\255)555
4617 y(ment,)f(e)o(xcept)g(the)h(last.)32 b(On)21 b(the)g(last)h
(function)d(there)h(are)h(no)f(restrictions,)h(and)f(whate)n(v)o(er)
-2787 b Fq(\016)555 4722 y FA(ar)o(guments)18 b(it)j(tak)o(es,)f(so)h
(will)g(the)f(function)f(returned)f(by)i(compose:)555
4901 y Fs(>)43 b(\(funcall)d(\(compose)h(#'1+)h(#'find-if\))d(#'oddp)i
('\(2)i(3)g(4\)\))555 5001 y(4)p eop
%%Page: 67 80
67 79 bop 555 538 a Ft(5.4)904 b Fu(COMPOSING)20 b(FUNCTIONS)887
b FA(67)p 555 745 2678 4 v 553 2964 4 2219 v 605 888
a Fs(\(defun)41 b(fif)h(\(if)h(then)f(&optional)d(else\))692
988 y(#'\(lambda)h(\(x\))866 1087 y(\(if)j(\(funcall)d(if)j(x\))1041
1187 y(\(funcall)d(then)i(x\))1041 1287 y(\(if)g(else)g(\(funcall)e
(else)i(x\)\)\)\)\))605 1486 y(\(defun)f(fint)h(\(fn)g(&rest)g(fns\))
692 1586 y(\(if)g(\(null)g(fns\))866 1685 y(fn)866 1785
y(\(let)g(\(\(chain)f(\(apply)g(#'fint)g(fns\)\)\))954
1884 y(#'\(lambda)e(\(x\))1128 1984 y(\(and)j(\(funcall)e(fn)j(x\))g
(\(funcall)d(chain)h(x\)\)\)\)\)\))605 2183 y(\(defun)g(fun)h(\(fn)h
(&rest)e(fns\))692 2283 y(\(if)h(\(null)g(fns\))866 2383
y(fn)866 2482 y(\(let)g(\(\(chain)f(\(apply)g(#'fun)h(fns\)\)\))954
2582 y(#'\(lambda)d(\(x\))1128 2681 y(\(or)j(\(funcall)e(fn)j(x\))g
(\(funcall)d(chain)i(x\)\)\)\)\)\))1304 2886 y FA(Figure)20
b(5.4:)28 b(More)20 b(function)f(b)n(uilders.)p 3231
2964 V 555 2967 2678 4 v 555 3188 a(Since)h Fs(not)g
FA(is)h(a)g(Lisp)f(function,)e Fs(complement)f FA(is)k(a)g(special)f
(case)h(of)f Fs(compose)p FA(.)27 b(It)21 b(could)555
3292 y(be)f(de\002ned)f(as:)555 3471 y Fs(\(defun)41
b(complement)f(\(pred\))642 3570 y(\(compose)g(#'not)i(pred\)\))680
3754 y FA(W)-7 b(e)37 b(can)f(combine)f(functions)f(in)j(other)e(w)o
(ays)i(than)e(by)h(composing)e(them.)77 b(F)o(or)555
3858 y(e)o(xample,)19 b(we)h(often)f(see)i(e)o(xpressions)e(lik)o(e)555
4036 y Fs(\(mapcar)41 b(#'\(lambda)f(\(x\))1078 4136
y(\(if)i(\(slave)f(x\))1252 4236 y(\(owner)g(x\))1252
4335 y(\(employer)f(x\)\)\))904 4435 y(people\))555 4618
y FA(W)-7 b(e)22 b(could)d(de\002ne)h(an)g(operator)f(to)i(b)n(uild)f
(functions)f(lik)o(e)i(this)g(one)f(automatically)-5
b(.)28 b(Using)555 4723 y Fs(fif)20 b FA(from)f(Figure)g(5.4,)g(we)i
(could)e(get)h(the)h(same)f(ef)n(fect)g(with:)555 4901
y Fs(\(mapcar)41 b(\(fif)h(#'slave)e(#'owner)h(#'employer\))904
5001 y(people\))p eop
%%Page: 68 81
68 80 bop 555 538 a FA(68)909 b Fu(RETURNING)18 b(FUNCTIONS)680
801 y FA(Figure)k(5.4)g(contains)g(se)n(v)o(eral)g(other)g
(constructors)f(for)h(commonly)e(occurring)h(types)555
905 y(of)f(functions.)28 b(The)20 b(second,)f Fs(fint)p
FA(,)f(is)k(for)d(cases)i(lik)o(e)g(this:)555 1088 y
Fs(\(find-if)40 b(#'\(lambda)g(\(x\))1122 1188 y(\(and)i(\(signed)e
(x\))j(\(sealed)e(x\))h(\(delivered)e(x\)\)\))947 1287
y(docs\))555 1475 y FA(The)15 b(predicate)g(gi)n(v)o(en)f(as)i(the)g
(second)f(ar)o(gument)e(to)j Fs(find-if)d FA(de\002nes)j(the)f
(intersection)g(of)555 1579 y(the)j(three)g(predicates)f(called)h
(within)g(it.)29 b(W)m(ith)19 b Fs(fint)p FA(,)e(whose)h(name)g(stands)
g(for)f(\223function)555 1684 y(intersection,)-6 b(\224)19
b(we)i(can)e(say:)555 1867 y Fs(\(find-if)40 b(\(fint)i(#'signed)e
(#'sealed)g(#'delivered\))f(docs\))555 2054 y FA(W)-7
b(e)26 b(can)f(de\002ne)g(a)h(similar)f(operator)f(to)h(return)f(the)i
(union)e(of)h(a)g(set)h(of)f(predicates.)44 b(The)555
2159 y(function)18 b Fs(fun)i FA(is)h(lik)o(e)g Fs(fint)e
FA(b)n(ut)h(uses)h Fs(or)f FA(instead)f(of)h Fs(and)p
FA(.)555 2412 y Fw(5.5)99 b(Recursion)26 b(on)f(Cdrs)555
2602 y FA(Recursi)n(v)o(e)30 b(functions)f(are)i(so)g(important)e(in)i
(Lisp)g(programs)d(that)j(it)h(w)o(ould)e(be)g(w)o(orth)555
2707 y(ha)n(ving)19 b(utilities)i(to)f(b)n(uild)g(them.)28
b(This)21 b(section)e(and)h(the)g(ne)o(xt)f(describe)g(functions)g
(which)555 2811 y(b)n(uild)k(the)g(tw)o(o)h(most)f(common)e(types.)39
b(In)23 b(Common)f(Lisp,)i(these)f(functions)f(are)h(a)h(little)555
2916 y(a)o(wkw)o(ard)k(to)i(use.)57 b(Once)29 b(we)h(get)g(into)f(the)g
(subject)g(of)h(macros,)g(we)g(will)g(see)h(ho)n(w)d(to)555
3021 y(put)d(a)g(more)g(ele)o(gant)e(f)o(acade)i(on)f(this)i(machinery)
-5 b(.)41 b(Macros)25 b(for)g(b)n(uilding)e(recursers)i(are)555
3125 y(discussed)20 b(in)g(Sections)g(15.2)f(and)h(15.3.)680
3230 y(Repeated)h(patterns)g(in)g(a)h(program)e(are)h(a)h(sign)g(that)f
(it)h(could)f(ha)n(v)o(e)g(been)g(written)g(at)h(a)555
3334 y(higher)13 b(le)n(v)o(el)i(of)f(abstraction.)26
b(What)15 b(pattern)f(is)i(more)e(commonly)e(seen)j(in)g(Lisp)f
(programs)555 3439 y(than)20 b(a)g(function)f(lik)o(e)h(this:)555
3622 y Fs(\(defun)41 b(our-length)f(\(lst\))642 3721
y(\(if)j(\(null)e(lst\))817 3821 y(0)817 3921 y(\(1+)h(\(our-length)d
(\(cdr)j(lst\)\)\)\)\))555 4108 y FA(or)20 b(this:)555
4291 y Fs(\(defun)41 b(our-every)f(\(fn)i(lst\))642 4391
y(\(if)h(\(null)e(lst\))817 4490 y(t)817 4590 y(\(and)g(\(funcall)g(fn)
h(\(car)g(lst\)\))1034 4689 y(\(our-every)e(fn)j(\(cdr)f(lst\)\)\)\)\))
555 4877 y FA(Structurally)20 b(these)i(tw)o(o)g(functions)e(ha)n(v)o
(e)h(a)h(lot)g(in)f(common.)32 b(The)o(y)20 b(both)h(operate)f(recur)n
(\255)555 4982 y(si)n(v)o(ely)25 b(on)g(successi)n(v)o(e)f(cdrs)h(of)g
(a)h(list,)h(e)n(v)n(aluating)d(the)h(same)g(e)o(xpression)f(on)h(each)
g(step,)p eop
%%Page: 69 82
69 81 bop 555 538 a Ft(5.5)948 b Fu(RECURSION)18 b(ON)h(CDRS)931
b FA(69)p 555 745 2678 4 v 553 2067 4 1322 v 605 888
a Fs(\(defun)41 b(lrec)h(\(rec)g(&optional)e(base\))692
988 y(\(labels)h(\(\(self)g(\(lst\))1171 1087 y(\(if)i(\(null)e(lst\))
1346 1187 y(\(if)h(\(functionp)e(base\))1520 1287 y(\(funcall)g(base\))
1520 1386 y(base\))1346 1486 y(\(funcall)g(rec)i(\(car)g(lst\))1912
1586 y(#'\(lambda)e(\(\))2087 1685 y(\(self)h(\(cdr)h
(lst\)\)\)\)\)\)\))779 1785 y(#'self\)\))1099 1989 y
FA(Figure)20 b(5.5:)29 b(Function)19 b(to)h(de\002ne)g(\003at)g(list)i
(recursers.)p 3231 2067 V 555 2070 2678 4 v 555 2288
a(e)o(xcept)h(in)h(the)g(base)g(case,)i(where)d(the)o(y)h(return)e(a)j
(distinct)f(v)n(alue.)40 b(This)24 b(pattern)f(appears)555
2392 y(so)18 b(frequently)d(in)i(Lisp)h(programs)d(that)i(e)o
(xperienced)e(programmers)g(can)i(read)f(and)h(repro\255)555
2497 y(duce)25 b(it)h(without)f(stopping)f(to)i(think.)45
b(Indeed,)25 b(the)g(lesson)h(is)h(so)f(quickly)e(learned,)h(that)555
2601 y(the)20 b(question)f(of)h(ho)n(w)g(to)g(package)f(the)h(pattern)f
(in)i(a)f(ne)n(w)g(abstraction)f(does)h(not)g(arise.)680
2706 y(Ho)n(we)n(v)o(er)m(,)j(a)i(pattern)e(it)i(is,)h(all)f(the)g
(same.)42 b(Instead)23 b(of)i(writing)e(these)i(functions)e(out)555
2811 y(by)g(hand,)h(we)g(should)f(be)g(able)h(to)g(write)g(a)g
(function)e(which)h(will)h(generate)f(them)g(for)g(us.)555
2915 y(Figure)e(5.5)f(contains)h(a)g(function\255b)n(uilder)d(called)j
Fs(lrec)f FA(\(\223list)i(recurser\224\))e(which)h(should)555
3020 y(be)f(able)g(to)h(generate)d(most)j(functions)d(that)j(recurse)e
(on)h(successi)n(v)o(e)g(cdrs)g(of)g(a)g(list.)680 3124
y(The)h(\002rst)h(ar)o(gument)e(to)i Fs(lrec)e FA(must)i(be)g(a)g
(function)e(of)i(tw)o(o)g(ar)o(guments:)30 b(the)22 b(current)555
3229 y(car)17 b(of)h(the)f(list,)i(and)e(a)h(function)e(which)h(can)g
(be)g(called)h(to)f(continue)f(the)i(recursion.)27 b(Using)555
3334 y Fs(lrec)19 b FA(we)i(could)e(e)o(xpress)g Fs(our-length)e
FA(as:)555 3508 y Fs(\(lrec)42 b(#'\(lambda)d(\(x)k(f\))g(\(1+)f
(\(funcall)f(f\)\)\))g(0\))555 3687 y FA(T)-7 b(o)22
b(\002nd)g(the)g(length)g(of)g(the)g(list,)h(we)g(don')o(t)d(need)i(to)
g(look)f(at)i(the)f(elements,)g(or)g(stop)g(part\255)555
3791 y(w)o(ay)-5 b(,)16 b(so)h(the)f(object)f Fs(x)h
FA(is)h(al)o(w)o(ays)g(ignored,)e(and)g(the)h(function)e
Fs(f)j FA(al)o(w)o(ays)f(called.)28 b(Ho)n(we)n(v)o(er)m(,)555
3896 y(we)g(need)f(to)h(tak)o(e)f(adv)n(antage)f(of)h(both)g
(possibilities)h(to)f(e)o(xpress)g Fs(our-every)p FA(,)f(for)h(e.g.)555
4000 y Fs(oddp)p FA(:)754 3970 y Fm(3)555 4174 y Fs(\(lrec)42
b(#'\(lambda)d(\(x)k(f\))g(\(and)f(\(oddp)f(x\))i(\(funcall)d(f\)\)\))i
(t\))680 4353 y FA(The)20 b(de\002nition)g(of)g Fs(lrec)g
FA(uses)i Fs(labels)d FA(to)i(b)n(uild)f(a)h(local)g(recursi)n(v)o(e)f
(function)f(called)555 4458 y Fs(self)p FA(.)28 b(In)18
b(the)h(recursi)n(v)o(e)f(case)h(the)g(function)f Fs(rec)g
FA(is)i(passed)f(tw)o(o)g(ar)o(guments,)e(the)i(current)555
4562 y(car)31 b(of)f(the)h(list,)j(and)c(a)h(function)e(embodying)f
(the)i(recursi)n(v)o(e)g(call.)61 b(In)30 b(functions)f(lik)o(e)555
4667 y Fs(our-every)p FA(,)16 b(where)j(the)g(recursi)n(v)o(e)f(case)i
(is)g(an)f Fs(and)p FA(,)g(if)g(the)h(\002rst)g(ar)o(gument)d(returns)h
(f)o(alse)555 4772 y(we)d(w)o(ant)f(to)h(stop)f(right)g(there.)26
b(Which)14 b(means)g(that)h(the)f(ar)o(gument)e(passed)i(in)h(the)f
(recursi)n(v)o(e)p 555 4839 1074 4 v 645 4894 a Fl(3)675
4918 y Fr(In)20 b(one)i(widely)g(used)g(Common)e(Lisp,)i
Fk(functionp)h Fr(erroneously)g(returns)f(true)g(for)f
Fk(t)g Fr(and)g Fk(nil)p Fr(.)36 b(In)21 b(that)555 5001
y(implementation)g(it)c(w)o(on')o(t)h(w)o(ork)f(to)h(gi)n(v)o(e)g
(either)h(as)e(the)g(second)h(ar)o(gument)h(to)e Fk(lrec)p
Fr(.)p eop
%%Page: 70 83
70 82 bop 555 538 a FA(70)909 b Fu(RETURNING)18 b(FUNCTIONS)p
555 745 2678 4 v 553 2160 4 1415 v 605 881 a Fs(;)43
b(copy-list)605 981 y(\(lrec)e(#'\(lambda)f(\(x)j(f\))g(\(cons)e(x)i
(\(funcall)e(f\)\)\)\))605 1180 y(;)i(remove-duplicate)o(s)605
1280 y(\(lrec)e(#'\(lambda)f(\(x)j(f\))g(\(adjoin)d(x)k(\(funcall)c
(f\)\)\)\))605 1479 y(;)j(find-if,)d(for)j(some)f(function)e(fn)605
1579 y(\(lrec)h(#'\(lambda)f(\(x)j(f\))g(\(if)f(\(fn)g(x\))h(x)g
(\(funcall)e(f\)\)\)\))605 1778 y(;)i(some,)f(for)g(some)g(function)e
(fn)605 1878 y(\(lrec)h(#'\(lambda)f(\(x)j(f\))g(\(or)f(\(fn)g(x\))h
(\(funcall)d(f\)\)\)\))1167 2082 y FA(Figure)20 b(5.6:)28
b(Functions)20 b(e)o(xpressed)f(with)h Fs(lrec)p FA(.)p
3231 2160 V 555 2163 2678 4 v 555 2387 a(case)f(must)f(not)g(be)g(a)h
(v)n(alue)f(b)n(ut)g(a)h(function,)e(which)g(we)i(can)f(call)h(\(if)f
(we)h(w)o(ant\))f(in)g(order)f(to)555 2492 y(get)j(a)h(v)n(alue.)680
2597 y(Figure)e(5.6)h(sho)n(ws)h(some)f(e)o(xisting)g(Common)f(Lisp)i
(functions)e(de\002ned)h(with)h Fs(lrec)p FA(.)3209 2566
y Fm(4)555 2701 y FA(Calling)j Fs(lrec)f FA(will)i(not)e(al)o(w)o(ays)i
(yield)e(the)h(most)g(ef)n(\002cient)g(implementation)e(of)h(a)i(gi)n
(v)o(en)555 2806 y(function.)55 b(Indeed,)30 b Fs(lrec)e
FA(and)h(the)h(other)e(recurser)g(generators)g(to)i(be)f(de\002ned)f
(in)i(this)555 2910 y(chapter)22 b(tend)g(to)h(lead)f(one)g(a)o(w)o(ay)
g(from)g(tail\255recursi)n(v)o(e)f(solutions.)36 b(F)o(or)22
b(this)h(reason)f(the)o(y)555 3015 y(are)g(best)g(suited)g(for)f(use)h
(in)g(initial)h(v)o(ersions)d(of)i(a)g(program,)e(or)i(in)g(parts)g
(where)f(speed)h(is)555 3120 y(not)e(critical.)555 3372
y Fw(5.6)99 b(Recursion)26 b(on)f(Subtr)n(ees)555 3563
y FA(There)d(is)i(another)e(recursi)n(v)o(e)g(pattern)g(commonly)f
(found)g(in)i(Lisp)h(programs:)33 b(recursion)555 3668
y(on)20 b(subtrees.)30 b(This)20 b(pattern)g(is)h(seen)g(in)g(cases)g
(where)f(you)f(be)o(gin)g(with)i(a)g(possibly)f(nested)555
3772 y(list,)h(and)f(w)o(ant)g(to)g(recurse)g(do)n(wn)f(both)g(its)j
(car)e(and)f(its)j(cdr)-5 b(.)680 3877 y(The)21 b(Lisp)g(list)i(is)f(a)
g(v)o(ersatile)f(structure.)32 b(Lists)23 b(can)e(represent,)g(among)f
(other)g(things,)555 3981 y(sequences,)i(sets,)i(mappings,)e(arrays,)g
(and)h(trees.)37 b(There)22 b(are)g(se)n(v)o(eral)g(dif)n(ferent)f(w)o
(ays)i(to)555 4086 y(interpret)h(a)i(list)g(as)g(a)f(tree.)45
b(The)24 b(most)i(common)d(is)j(to)g(re)o(gard)d(the)i(list)h(as)g(a)g
(binary)e(tree)555 4191 y(whose)j(left)g(branch)f(is)i(the)f(car)g(and)
g(whose)f(right)h(branch)f(is)i(the)f(cdr)-5 b(.)50 b(\(In)26
b(f)o(act,)j(this)f(is)555 4295 y(usually)c(the)h(internal)e
(representation)g(of)h(lists.\))44 b(Figure)24 b(5.7)g(sho)n(ws)g
(three)g(e)o(xamples)g(of)555 4400 y(lists)i(and)e(the)h(trees)g(the)o
(y)f(represent.)41 b(Each)24 b(internal)g(node)g(in)h(such)f(a)h(tree)g
(corresponds)555 4504 y(to)f(a)h(dot)f(in)g(the)g(dotted\255pair)e
(representation)h(of)g(the)i(list,)h(so)e(the)g(tree)h(structure)e(may)
h(be)p 555 4576 1074 4 v 645 4631 a Fl(4)675 4654 y Fr(In)16
b(some)g(implementations,)j(you)e(may)f(ha)o(v)o(e)h(to)f(set)h
Fk(*print-circle*)i Fr(to)e Fk(t)f Fr(before)i(these)f(functions)h(can)
555 4737 y(be)f(displayed.)p eop
%%Page: 71 84
71 83 bop 555 538 a Ft(5.6)877 b Fu(RECURSION)18 b(ON)h(SUBTREES)858
b FA(71)p 555 745 2678 4 v 553 2641 4 1896 v 605 2301
a @beginspecial @setspecial @endspecial 736 2358 a Fs(\(a)42
b(.)i(b\))478 b(\(a)43 b(b)g(c\))653 b(\(a)43 b(b)g(\(c)g(d\)\))1472
2562 y FA(Figure)19 b(5.7:)29 b(Lists)21 b(as)g(trees.)p
3231 2641 V 555 2644 2678 4 v 555 2868 a(easier)f(to)h(interpret)e(if)h
(the)g(lists)i(are)e(considered)f(in)h(that)g(form:)773
3051 y Fs(\(a)43 b(b)g(c\))261 b(=)86 b(\(a)43 b(.)g(\(b)g(.)g(\(c)g(.)
g(nil\)\)\))773 3150 y(\(a)g(b)g(\(c)g(d\)\))86 b(=)g(\(a)43
b(.)g(\(b)g(.)g(\(\(c)g(.)g(\(d)f(.)i(nil\)\))d(.)i(nil\)\)\))555
3338 y FA(An)o(y)22 b(list)j(can)e(be)g(interpreted)e(as)j(a)f(binary)f
(tree.)38 b(Hence)23 b(the)g(distinction)f(between)h(pairs)555
3443 y(of)e(Common)g(Lisp)g(functions)g(lik)o(e)h Fs(copy-list)c
FA(and)j Fs(copy-tree)p FA(.)30 b(The)22 b(former)e(copies)555
3547 y(a)e(list)h(as)f(a)g(sequence\227if)e(the)h(list)i(contains)e
(sublists,)h(the)g(sublists,)g(being)f(mere)g(elements)555
3652 y(in)j(the)h(sequence,)d(are)i(not)g(copied:)555
3834 y Fs(>)43 b(\(setq)f(x)217 b('\(a)43 b(b\))904 3934
y(listx)e(\(list)h(x)h(1\)\))555 4034 y(\(\(A)f(B\))h(1\))555
4133 y(>)g(\(eq)g(x)g(\(car)f(\(copy-list)d(listx\)\)\))555
4233 y(T)555 4421 y FA(In)20 b(contrast,)h Fs(copy-tree)c
FA(copies)k(a)g(list)h(as)f(a)g(tree\227sublists)g(are)g(subtrees,)f
(and)g(so)i(must)555 4525 y(also)f(be)f(copied:)555 4708
y Fs(>)43 b(\(eq)g(x)g(\(car)f(\(copy-tree)d(listx\)\)\))555
4807 y(NIL)555 4995 y FA(W)-7 b(e)21 b(could)f(de\002ne)f(a)i(v)o
(ersion)e(of)h Fs(copy-tree)d FA(as)k(follo)n(ws:)p eop
%%Page: 72 85
72 84 bop 555 538 a FA(72)909 b Fu(RETURNING)18 b(FUNCTIONS)555
801 y Fs(\(defun)41 b(our-copy-tree)d(\(tree\))642 900
y(\(if)43 b(\(atom)e(tree\))817 1000 y(tree)817 1100
y(\(cons)g(\(our-copy-tree)d(\(car)k(tree\)\))1078 1199
y(\(if)g(\(cdr)g(tree\))g(\(our-copy-tree)c(\(cdr)k(tree\)\)\)\)\)\))
555 1386 y FA(This)25 b(de\002nition)f(turns)h(out)f(to)h(be)g(one)g
(instance)f(of)h(a)h(common)d(pattern.)42 b(\(Some)25
b(of)g(the)555 1490 y(follo)n(wing)14 b(functions)h(are)h(written)g(a)g
(little)h(oddly)d(in)i(order)f(to)h(mak)o(e)g(the)g(pattern)f(ob)o
(vious.\))555 1595 y(Consider)20 b(for)f(e)o(xample)g(a)i(utility)f(to)
g(count)f(the)h(number)f(of)h(lea)n(v)o(es)g(in)g(a)h(tree:)555
1777 y Fs(\(defun)41 b(count-leaves)e(\(tree\))642 1876
y(\(if)k(\(atom)e(tree\))817 1976 y(1)817 2075 y(\(+)h(\(count-leaves)c
(\(car)k(tree\)\))947 2175 y(\(or)h(\(if)f(\(cdr)g(tree\))f
(\(count-leaves)e(\(cdr)j(tree\)\)\))1122 2275 y(1\)\)\)\))555
2461 y FA(A)19 b(tree)g(has)h(more)e(lea)n(v)o(es)h(than)f(the)h(atoms)
g(you)f(can)h(see)g(when)g(it)g(is)h(represented)d(as)j(a)f(list:)555
2643 y Fs(>)43 b(\(count-leaves)38 b('\(\(a)k(b)h(\(c)g(d\)\))g(\(e\))f
(f\)\))555 2743 y(10)555 2929 y FA(The)26 b(lea)n(v)o(es)h(of)f(a)h
(tree)g(are)f(all)h(the)g(atoms)g(you)e(can)i(see)g(when)f(you)f(look)h
(at)h(the)g(tree)f(in)555 3034 y(its)i Ft(dotted\255pair)d
FA(representation.)46 b(In)27 b(dotted\255pair)d(notation,)j
Fs(\(\(a)42 b(b)h(\(c)g(d\)\))f(\(e\))h(f\))555 3138
y FA(w)o(ould)26 b(ha)n(v)o(e)g(four)f Fs(nil)p FA(s)h(that)g(aren')o
(t)f(visible)i(in)f(the)h(list)g(representation)e(\(one)g(for)h(each)
555 3243 y(pair)20 b(of)g(parentheses\))e(so)j Fs(count-leaves)16
b FA(returns)j Fs(10)p FA(.)680 3348 y(In)29 b(the)g(last)h(chapter)e
(we)i(de\002ned)e(se)n(v)o(eral)h(utilities)h(which)f(operate)f(on)h
(trees.)57 b(F)o(or)555 3452 y(e)o(xample,)22 b Fs(flatten)f
FA(\(page)h(47\))h(tak)o(es)g(a)h(tree)f(and)g(returns)f(a)i(list)g(of)
f(all)g(the)h(atoms)f(in)g(it.)555 3557 y(That)16 b(is,)j(if)e(you)e
(gi)n(v)o(e)h Fs(flatten)f FA(a)i(nested)f(list,)i(you')o(ll)e(get)h
(back)f(a)h(list)h(that)f(looks)f(the)g(same)555 3661
y(e)o(xcept)j(that)h(it')-5 b(s)22 b(missing)e(all)h(b)n(ut)f(the)g
(outermost)f(pair)h(of)g(parentheses:)555 3843 y Fs(>)43
b(\(flatten)d('\(\(a)i(b)i(\(c)e(d\)\))h(\(e\))f(f)h(\(\)\)\))555
3943 y(\(A)g(B)g(C)g(D)g(E)g(F\))555 4129 y FA(This)20
b(function)f(could)g(also)i(be)f(de\002ned)f(\(some)n(what)g(inef)n
(\002ciently\))f(as)j(follo)n(ws:)555 4311 y Fs(\(defun)41
b(flatten)g(\(tree\))642 4411 y(\(if)i(\(atom)e(tree\))817
4510 y(\(mklist)f(tree\))817 4610 y(\(nconc)h(\(flatten)f(\(car)i
(tree\)\))1122 4709 y(\(if)g(\(cdr)g(tree\))f(\(flatten)g(\(cdr)h
(tree\)\)\)\)\)\))680 4896 y FA(Finally)-5 b(,)20 b(consider)g
Fs(rfind-if)p FA(,)e(a)j(recursi)n(v)o(e)f(v)o(ersion)g(of)g
Fs(find-if)f FA(which)h(w)o(orks)h(on)555 5001 y(trees)g(as)f(well)h
(as)g(\003at)g(lists:)p eop
%%Page: 73 86
73 85 bop 555 538 a Ft(5.6)877 b Fu(RECURSION)18 b(ON)h(SUBTREES)858
b FA(73)555 801 y Fs(\(defun)41 b(rfind-if)f(\(fn)j(tree\))642
900 y(\(if)g(\(atom)e(tree\))817 1000 y(\(and)g(\(funcall)g(fn)h
(tree\))g(tree\))817 1100 y(\(or)g(\(rfind-if)e(fn)i(\(car)g(tree\)\))
991 1199 y(\(if)g(\(cdr)g(tree\))g(\(rfind-if)e(fn)i(\(cdr)g
(tree\)\)\)\)\)\))555 1387 y FA(T)-7 b(o)26 b(generalize)f
Fs(find-if)e FA(for)j(trees,)h(we)f(ha)n(v)o(e)f(to)i(decide)e(whether)
g(we)h(w)o(ant)g(to)g(search)555 1491 y(for)21 b(just)i(lea)n(v)o(es,)f
(or)f(for)g(whole)h(subtrees.)33 b(Our)22 b Fs(rfind-if)d
FA(tak)o(es)j(the)g(former)e(approach,)55 b Fq(\016)555
1596 y FA(so)21 b(the)f(caller)h(can)f(assume)g(that)h(the)f(function)f
(gi)n(v)o(en)g(as)i(the)g(\002rst)g(ar)o(gument)d(will)j(only)f(be)555
1701 y(called)g(on)g(atoms:)555 1883 y Fs(>)43 b(\(rfind-if)d(\(fint)i
(#'numberp)d(#'oddp\))i('\(2)h(\(3)h(4\))g(5\)\))555
1983 y(3)680 2171 y FA(Ho)n(w)26 b(similar)h(in)g(form)e(are)i(these)f
(four)g(functions,)g Fs(copy-tree)p FA(,)f Fs(count-leaves)p
FA(,)555 2275 y Fs(flatten)p FA(,)20 b(and)h Fs(rfind-if)p
FA(.)31 b(Indeed,)20 b(the)o(y')l(re)g(all)i(instances)g(of)g(an)f
(archetypal)f(function)555 2380 y(for)31 b(recursion)g(on)h(subtrees.)
64 b(As)33 b(with)f(recursion)f(on)h(cdrs,)i(we)f(need)e(not)h(lea)n(v)
o(e)g(this)555 2484 y(archetype)15 b(to)i(\003oat)f(v)n(aguely)f(in)i
(the)g(background\227we)c(can)j(write)h(a)g(function)e(to)i(generate)
555 2589 y(instances)j(of)g(it.)680 2694 y(T)-7 b(o)23
b(get)f(at)i(the)f(archetype)e(itself,)j(let')-5 b(s)23
b(look)f(at)i(these)f(functions)e(and)h(see)i(what')-5
b(s)23 b(not)555 2798 y(pattern.)28 b(Essentially)20
b Fs(our-copy-tree)c FA(is)21 b(tw)o(o)f(f)o(acts:)659
2986 y(1.)41 b(In)19 b(the)i(base)f(case)h(it)g(returns)e(its)i(ar)o
(gument.)659 3157 y(2.)41 b(In)24 b(the)g(recursi)n(v)o(e)g(case,)h(it)
h(applies)e Fs(cons)g FA(to)g(the)h(recursions)e(do)n(wn)h(the)h(left)f
(\(car\))763 3261 y(and)19 b(right)h(\(cdr\))f(subtrees.)555
3449 y(W)-7 b(e)21 b(should)f(thus)g(be)g(able)g(to)g(e)o(xpress)g(it)h
(as)g(a)f(call)h(to)f(a)h(b)n(uilder)e(with)h(tw)o(o)h(ar)o(guments:)
555 3632 y Fs(\(ttrav)41 b(#'cons)g(#'identity\))680
3819 y FA(A)28 b(de\002nition)f(of)h Fs(ttrav)f FA(\(\223tree)g(tra)n
(v)o(erser\224\))g(is)i(sho)n(wn)e(in)i(Figure)e(5.8.)52
b(Instead)28 b(of)555 3924 y(passing)21 b(one)h(v)n(alue)f(in)g(the)h
(recursi)n(v)o(e)e(case,)j(we)f(pass)g(tw)o(o,)g(one)f(for)g(the)h
(left)g(subtree)f(and)555 4029 y(one)16 b(for)g(the)h(right.)27
b(If)17 b(the)g Fs(base)e FA(ar)o(gument)g(is)i(a)h(function)d(it)i
(will)h(be)e(called)h(on)f(the)h(current)555 4133 y(leaf.)43
b(In)25 b(\003at)g(list)h(recursion,)e(the)h(base)g(case)g(is)h(al)o(w)
o(ays)f Fs(nil)p FA(,)h(b)n(ut)e(in)h(tree)g(recursion)f(the)555
4238 y(base)c(case)h(could)e(be)h(an)g(interesting)g(v)n(alue,)f(and)h
(we)g(might)g(w)o(ant)g(to)g(use)h(it.)680 4342 y(W)m(ith)j
Fs(ttrav)e FA(we)j(could)d(e)o(xpress)i(all)g(the)g(preceding)e
(functions)h(e)o(xcept)g Fs(rfind-if)p FA(.)555 4447
y(\(The)o(y)17 b(are)h(sho)n(wn)f(in)h(Figure)g(5.9.\))27
b(T)-7 b(o)18 b(de\002ne)g Fs(rfind-if)d FA(we)k(need)e(a)h(more)g
(general)f(tree)555 4552 y(recursion)h(b)n(uilder)h(which)h(gi)n(v)o
(es)f(us)h(control)f(o)o(v)o(er)f(when,)h(and)h(if,)g(the)g(recursi)n
(v)o(e)e(calls)j(are)555 4656 y(made.)27 b(As)17 b(the)f(\002rst)h(ar)o
(gument)d(to)j Fs(ttrav)d FA(we)j(ga)n(v)o(e)e(a)i(function)d(which)i
(took)f(the)i Ft(r)m(esults)g FA(of)555 4761 y(the)j(recursi)n(v)o(e)f
(calls.)30 b(F)o(or)20 b(the)h(general)e(case,)i(we)f(w)o(ant)h(to)f
(use)h(instead)f(a)h(function)d(which)555 4865 y(tak)o(es)g(tw)o(o)g
(closures)g(representing)e(the)i(calls)g(themselv)o(es.)28
b(Then)17 b(we)i(can)e(write)h(recursers)555 4970 y(which)i(only)f(tra)
n(v)o(erse)h(as)h(much)e(of)h(the)g(tree)g(as)h(the)o(y)f(w)o(ant)g
(to.)p eop
%%Page: 74 87
74 86 bop 555 538 a FA(74)909 b Fu(RETURNING)18 b(FUNCTIONS)p
555 745 2678 4 v 553 2067 4 1322 v 605 888 a Fs(\(defun)41
b(ttrav)g(\(rec)h(&optional)e(\(base)i(#'identity\)\))692
988 y(\(labels)f(\(\(self)g(\(tree\))1171 1087 y(\(if)i(\(atom)e
(tree\))1346 1187 y(\(if)h(\(functionp)e(base\))1520
1287 y(\(funcall)g(base)i(tree\))1520 1386 y(base\))1346
1486 y(\(funcall)e(rec)i(\(self)g(\(car)g(tree\)\))1912
1586 y(\(if)h(\(cdr)f(tree\))2087 1685 y(\(self)f(\(cdr)h
(tree\)\)\)\)\)\)\))779 1785 y(#'self\)\))1174 1989 y
FA(Figure)20 b(5.8:)29 b(Function)19 b(for)g(recursion)g(on)h(trees.)p
3231 2067 V 555 2070 2678 4 v 555 2198 V 553 3309 4 1111
v 605 2329 a Fs(;)43 b(our-copy-tree)605 2429 y(\(ttrav)e(#'cons\))605
2628 y(;)i(count-leaves)605 2727 y(\(ttrav)e(#'\(lambda)f(\(l)j(r\))f
(\(+)h(l)g(\(or)g(r)g(1\)\)\))85 b(1\))605 2927 y(;)43
b(flatten)605 3026 y(\(ttrav)e(#'nconc)g(#'mklist\))1145
3231 y FA(Figure)20 b(5.9:)29 b(Functions)19 b(e)o(xpressed)g(with)h
Fs(ttrav)p FA(.)p 3231 3309 V 555 3312 2678 4 v 680 3536
a(Functions)13 b(b)n(uilt)g(by)g Fs(ttrav)g FA(al)o(w)o(ays)g(tra)n(v)n
(erse)g(a)g(wh)o(ole)g(tr)o(ee.)21 b(That')-5 b(s)13
b(\002ne)g(for)g(functions)555 3641 y(lik)o(e)23 b Fs(count-leaves)c
FA(or)k Fs(flatten)p FA(,)e(which)i(ha)n(v)o(e)g(to)g(tra)n(v)o(erse)g
(the)g(whole)f(tree)i(an)o(yw)o(ay)-5 b(.)555 3745 y(But)20
b(we)g(w)o(ant)g Fs(rfind-if)d FA(to)j(stop)g(searching)f(as)h(soon)f
(as)i(it)f(\002nds)g(what)g(it')-5 b(s)21 b(looking)d(for)-5
b(.)555 3850 y(It)21 b(must)f(be)g(b)n(uilt)h(by)f(the)g(more)g
(general)f Fs(trec)p FA(,)g(sho)n(wn)g(in)i(Figure)f(5.10.)28
b(The)20 b(second)f(ar)o(g)555 3955 y(to)k Fs(trec)g
FA(should)f(be)h(a)h(function)d(of)i(three)g(ar)o(guments:)33
b(the)24 b(current)e(object)g(and)h(the)g(tw)o(o)555
4059 y(recursers.)48 b(The)27 b(latter)g(tw)o(o)g(will)h(be)f(closures)
f(representing)f(the)i(recursions)f(do)n(wn)g(the)555
4164 y(left)20 b(and)g(right)g(subtrees.)28 b(W)m(ith)21
b Fs(trec)e FA(we)i(w)o(ould)e(de\002ne)h Fs(flatten)e
FA(as:)555 4346 y Fs(\(trec)42 b(#'\(lambda)d(\(o)k(l)g(r\))g(\(nconc)e
(\(funcall)f(l\))j(\(funcall)d(r\)\)\))817 4446 y(#'mklist\))555
4634 y FA(No)n(w)20 b(we)h(can)f(also)g(e)o(xpress)g
Fs(rfind-if)d FA(for)j(e.g.)f Fs(oddp)g FA(as:)555 4816
y Fs(\(trec)42 b(#'\(lambda)d(\(o)k(l)g(r\))g(\(or)f(\(funcall)f(l\))h
(\(funcall)f(r\)\)\))817 4916 y(#'\(lambda)e(\(tree\))i(\(and)h(\(oddp)
g(tree\))f(tree\)\)\))p eop
%%Page: 75 88
75 87 bop 555 538 a Ft(5.7)842 b Fu(WHEN)19 b(T)o(O)f(B)o(UILD)g
(FUNCTIONS)825 b FA(75)p 555 745 2678 4 v 553 2466 4
1721 v 605 888 a Fs(\(defun)41 b(trec)h(\(rec)g(&optional)e(\(base)h
(#'identity\)\))692 988 y(\(labels)779 1087 y(\(\(self)g(\(tree\))910
1187 y(\(if)h(\(atom)g(tree\))1084 1287 y(\(if)h(\(functionp)c(base\))
1259 1386 y(\(funcall)h(base)i(tree\))1259 1486 y(base\))1084
1586 y(\(funcall)f(rec)h(tree)1651 1685 y(#'\(lambda)e(\(\))1825
1785 y(\(self)i(\(car)g(tree\)\)\))1651 1884 y(#'\(lambda)e(\(\))1825
1984 y(\(if)j(\(cdr)f(tree\))2000 2084 y(\(self)f(\(cdr)h
(tree\)\)\)\)\)\)\)\))779 2183 y(#'self\)\))1153 2388
y FA(Figure)20 b(5.10:)28 b(Function)19 b(for)h(recursion)f(on)g
(trees.)p 3231 2466 V 555 2469 2678 4 v 555 2693 a Fw(5.7)99
b(When)26 b(to)f(Build)g(Functions)555 2884 y FA(Expressing)30
b(functions)h(by)g(calls)i(to)f(constructors)e(instead)i(of)f
(sharp\255quoted)e(lambda\255)555 2988 y(e)o(xpressions)c(could,)h
(unfortunately)-5 b(,)24 b(entail)i(unnecessary)f(w)o(ork)g(at)i
(runtime.)46 b(A)27 b(sharp\255)555 3093 y(quoted)15
b(lambda\255e)o(xpression)e(is)18 b(a)f(constant,)f(b)n(ut)g(a)h(call)g
(to)g(a)g(constructor)e(function)f(will)k(be)555 3197
y(e)n(v)n(aluated)k(at)h(runtime.)36 b(If)23 b(we)h(really)e(ha)n(v)o
(e)h(to)g(mak)o(e)f(this)i(call)f(at)h(runtime,)e(it)i(might)e(not)555
3302 y(be)f(w)o(orth)g(using)g(constructor)e(functions.)31
b(Ho)n(we)n(v)o(er)m(,)20 b(at)i(least)g(some)f(of)g(the)h(time)f(we)h
(can)555 3407 y(call)i(the)g(constructor)e(beforehand.)38
b(By)24 b(using)g Fs(#.)p FA(,)g(the)g(sharp\255dot)e(read)i(macro,)f
(we)i(can)555 3511 y(ha)n(v)o(e)20 b(the)g(ne)n(w)h(functions)e(b)n
(uilt)h(at)h(read\255time.)29 b(So)20 b(long)g(as)h Fs(compose)d
FA(and)i(its)i(ar)o(guments)555 3616 y(are)e(de\002ned)f(when)h(this)h
(e)o(xpression)d(is)j(read,)f(we)g(could)g(say)-5 b(,)19
b(for)h(e)o(xample,)555 3804 y Fs(\(find-if)40 b(#.\(compose)g(#'oddp)h
(#'truncate\))e(lst\))555 3991 y FA(Then)29 b(the)i(call)f(to)h
Fs(compose)d FA(w)o(ould)h(be)h(e)n(v)n(aluated)f(by)h(the)g(reader)m
(,)h(and)f(the)g(resulting)555 4096 y(function)18 b(inserted)g(as)j(a)e
(constant)g(into)g(our)g(code.)28 b(Since)19 b(both)g
Fs(oddp)f FA(and)h Fs(truncate)e FA(are)555 4200 y(b)n(uilt\255in,)23
b(it)h(w)o(ould)f(safe)h(to)f(assume)g(that)h(we)f(can)h(e)n(v)n
(aluate)e(the)h Fs(compose)e FA(at)j(read\255time,)555
4305 y(so)d(long)e(as)i Fs(compose)d FA(itself)j(were)f(already)f
(loaded.)680 4410 y(In)g(general,)g(composing)e(and)j(combining)d
(functions)h(is)j(more)e(easily)h(and)f(ef)n(\002ciently)555
4514 y(done)26 b(with)i(macros.)50 b(This)27 b(is)i(particularly)c
(true)i(in)h(Common)e(Lisp,)j(with)f(its)g(separate)555
4619 y(name\255space)18 b(for)h(functions.)27 b(After)19
b(introducing)e(macros,)i(we)h(will)g(in)f(Chapter)g(15)g(co)o(v)o(er)
555 4723 y(much)g(of)h(the)g(ground)e(we)j(co)o(v)o(ered)d(here,)h(b)n
(ut)h(in)h(a)f(more)g(luxurious)e(v)o(ehicle.)p eop
%%Page: 76 89
76 88 bop 555 1610 a Fn(6)p 555 1872 2686 3 v 555 2131
a Fx(Functions)43 b(as)e(Repr)m(esentation)555 2568 y
FA(Generally)-5 b(,)37 b(data)e(structures)g(are)g(used)g(to)h
Ft(r)m(epr)m(esent.)74 b FA(An)35 b(array)g(could)f(represent)g(a)555
2672 y(geometric)16 b(transformation;)f(a)j(tree)f(could)f(represent)g
(a)h(hierarchy)e(of)h(command;)h(a)g(graph)555 2777 y(could)33
b(represent)g(a)h(rail)g(netw)o(ork.)69 b(In)33 b(Lisp)i(we)f(can)f
(sometimes)h(use)g(closures)g(as)g(a)555 2882 y(representation.)26
b(W)m(ithin)18 b(a)g(closure,)f(v)n(ariable)f(bindings)g(can)i(store)f
(information,)f(and)h(can)555 2986 y(also)24 b(play)f(the)g(role)g
(that)h(pointers)f(play)g(in)g(constructing)f(comple)o(x)f(data)j
(structures.)38 b(By)555 3091 y(making)19 b(a)h(group)f(of)h(closures)g
(which)f(share)h(bindings,)f(or)h(can)g(refer)f(to)h(one)g(another)m(,)
e(we)555 3195 y(can)28 b(create)f(hybrid)f(objects)i(which)f(combine)f
(the)i(adv)n(antages)f(of)g(data)h(structures)f(and)555
3300 y(programs.)680 3405 y(Beneath)22 b(the)g(surf)o(ace,)g(shared)g
(bindings)f Ft(ar)m(e)i FA(pointers.)35 b(Closures)22
b(just)h(bring)f(us)h(the)555 3509 y(con)m(v)o(enience)13
b(of)g(dealin)o(g)f(with)h(th)o(em)f(at)h(a)f(h)o(ighe)o(r)h(le)m(v)o
(el)f(of)g(ab)o(straction)o(.)21 b(By)13 b(using)g(closures)555
3614 y(to)23 b(represent)f(something)f(we)j(w)o(ould)e(otherwise)g
(represent)g(with)h(static)h(data)e(structures,)555 3718
y(we)f(can)f(often)f(e)o(xpect)g(substantial)h(impro)o(v)o(ements)d(in)
k(ele)o(gance)d(and)i(ef)n(\002cienc)o(y)-5 b(.)555 3971
y Fw(6.1)99 b(Netw)o(orks)555 4162 y FA(Closures)24 b(ha)n(v)o(e)f
(three)h(useful)f(properties:)35 b(the)o(y)24 b(are)f(acti)n(v)o(e,)i
(the)o(y)e(ha)n(v)o(e)g(local)h(state,)h(and)555 4266
y(we)i(can)g(mak)o(e)g(multiple)f(instances)h(of)g(them.)50
b(Where)27 b(could)f(we)h(use)g(multiple)g(copies)555
4371 y(of)k(acti)n(v)o(e)g(objects)g(with)h(local)f(state?)63
b(In)32 b(applications)e(in)m(v)n(olving)f(netw)o(orks,)k(among)555
4476 y(others.)28 b(In)16 b(man)o(y)g(cases)h(we)h(can)e(represent)g
(nodes)g(in)h(a)h(netw)o(ork)d(as)j(closures.)28 b(As)17
b(well)h(as)555 4580 y(ha)n(ving)k(its)h(o)n(wn)g(local)f(state,)i(a)g
(closure)e(can)g(refer)g(to)h(another)e(closure.)37 b(Thus)22
b(a)h(closure)555 4685 y(representing)h(a)j(node)e(in)i(a)f(netw)o(ork)
f(can)h(kno)n(w)g(of)g(se)n(v)o(eral)f(other)h(nodes)f(\(closures\))g
(to)555 4789 y(which)c(it)i(must)f(send)f(its)i(output.)33
b(This)22 b(means)g(that)g(we)g(may)f(be)h(able)g(to)g(translate)g
(some)555 4894 y(netw)o(orks)d(straight)h(into)g(code.)1856
5229 y(76)p eop
%%Page: 77 90
77 89 bop 555 538 a Ft(6.1)1091 b Fu(NETW)o(ORKS)1075
b FA(77)p 555 745 2678 4 v 553 2266 4 1522 v 605 888
a Fs(>)43 b(\(run-node)d('people\))605 988 y(Is)j(the)f(person)f(a)i
(man?)605 1087 y(>>)g(yes)605 1187 y(Is)g(he)f(living?)605
1287 y(>>)h(no)605 1386 y(Was)f(he)h(American?)605 1486
y(>>)g(yes)605 1586 y(Is)g(he)f(on)h(a)g(coin?)605 1685
y(>>)g(yes)605 1785 y(Is)g(the)f(coin)g(a)h(penny?)605
1884 y(>>)g(yes)605 1984 y(LINCOLN)1224 2188 y FA(Figure)19
b(6.1:)29 b(Session)21 b(of)e(twenty)h(questions.)p 3231
2266 V 555 2270 2678 4 v 680 2494 a(In)25 b(this)h(section)f(and)g(the)
h(ne)o(xt)f(we)h(will)g(look)f(at)h(tw)o(o)g(w)o(ays)g(to)g(tra)n(v)o
(erse)f(a)h(netw)o(ork.)555 2598 y(First)17 b(we)g(will)g(follo)n(w)f
(the)h(traditional)e(approach,)g(with)h(nodes)g(de\002ned)g(as)h
(structures,)f(and)555 2703 y(separate)i(code)g(to)g(tra)n(v)o(erse)g
(the)h(netw)o(ork.)27 b(Then)18 b(in)g(the)h(ne)o(xt)e(section)i(we')o
(ll)f(sho)n(w)h(ho)n(w)e(to)555 2808 y(b)n(uild)j(the)g(same)g(program)
e(from)i(a)g(single)g(abstraction.)680 2912 y(As)26 b(an)g(e)o(xample,)
g(we)h(will)g(use)f(about)f(the)h(simplest)h(application)d(possible:)41
b(one)26 b(of)555 3017 y(those)i(programs)e(that)i(play)f(twenty)h
(questions.)51 b(Our)28 b(netw)o(ork)e(will)j(be)f(a)g(binary)f(tree.)
555 3122 y(Each)21 b(non\255leaf)f(node)g(will)j(contain)d(a)i(yes/no)f
(question,)g(and)g(depending)e(on)i(the)h(answer)555
3226 y(to)27 b(the)g(question,)h(the)f(tra)n(v)o(ersal)g(will)g
(continue)f(do)n(wn)g(the)h(left)g(or)g(right)g(subtree.)49
b(Leaf)555 3331 y(nodes)18 b(will)h(contain)e(return)g(v)n(alues.)29
b(When)18 b(the)g(tra)n(v)o(ersal)g(reaches)g(a)h(leaf)f(node,)g(its)h
(v)n(alue)555 3435 y(will)k(be)g(returned)d(as)j(the)g(v)n(alue)f(of)g
(the)g(tra)n(v)o(ersal.)36 b(A)23 b(session)f(with)h(this)g(program)d
(might)555 3540 y(look)f(as)i(in)g(Figure)e(6.1.)680
3645 y(The)g(traditional)g(w)o(ay)i(to)f(be)o(gin)f(w)o(ould)g(be)h(to)
h(de\002ne)e(some)h(sort)g(of)g(data)g(structure)f(to)555
3749 y(represent)i(nodes.)36 b(A)23 b(node)e(is)j(going)d(to)h(ha)n(v)o
(e)g(to)h(kno)n(w)e(se)n(v)o(eral)h(things:)34 b(whether)21
b(it)j(is)f(a)555 3854 y(leaf;)g(if)f(so,)g(which)f(v)n(alue)g(to)h
(return,)f(and)g(if)i(not,)e(which)g(question)g(to)h(ask;)h(and)e
(where)g(to)555 3958 y(go)h(depending)f(on)h(the)h(answer)-5
b(.)37 b(A)24 b(suf)n(\002cient)e(data)h(structure)f(is)h(de\002ned)f
(in)h(Figure)f(6.2.)555 4063 y(It)c(is)i(designed)c(for)i(minimal)f
(size.)30 b(The)17 b Fs(contents)f FA(\002eld)i(will)h(contain)e
(either)h(a)h(question)555 4168 y(or)h(a)g(return)f(v)n(alue.)28
b(If)20 b(the)g(node)f(is)i(not)e(a)i(leaf,)e(the)h Fs(yes)f
FA(and)h Fs(no)f FA(\002elds)i(will)g(tell)f(where)f(to)555
4272 y(go)h(depending)e(on)i(the)h(answer)f(to)h(the)g(question;)f(if)h
(the)f(node)g(is)h(a)g(leaf,)g(we)g(will)g(kno)n(w)f(it)555
4377 y(because)d(these)i(\002elds)f(are)g(empty)-5 b(.)27
b(The)18 b(global)f Fs(*nodes*)f FA(will)j(be)f(a)g(hash\255table)f(in)
h(which)555 4481 y(nodes)i(are)h(inde)o(x)o(ed)d(by)j(name.)30
b(Finally)-5 b(,)20 b Fs(defnode)f FA(mak)o(es)h(a)i(ne)n(w)e(node)g
(\(of)g(either)g(type\))555 4586 y(and)h(stores)g(it)h(in)f
Fs(*nodes*)p FA(.)30 b(Using)21 b(these)h(materials)f(we)h(could)e
(de\002ne)g(the)i(\002rst)g(node)e(of)555 4691 y(our)f(tree:)555
4873 y Fs(\(defnode)40 b('people)h("Is)h(the)h(person)e(a)i(man?")947
4973 y('male)f('female\))p eop
%%Page: 78 91
78 90 bop 555 538 a FA(78)779 b Fu(FUNCTIONS)19 b(AS)g(REPRESENT)-6
b(A)f(TION)p 555 745 2678 4 v 553 1968 4 1223 v 605 888
a Fs(\(defstruct)39 b(node)86 b(contents)40 b(yes)i(no\))605
1087 y(\(defvar)f(*nodes*)f(\(make-hash-table\))o(\))605
1287 y(\(defun)h(defnode)g(\(name)g(conts)h(&optional)e(yes)i(no\))692
1386 y(\(setf)g(\(gethash)e(name)i(*nodes*\))954 1486
y(\(make-node)d(:contents)h(conts)1433 1586 y(:yes)260
b(yes)1433 1685 y(:no)304 b(no\)\)\))1045 1889 y FA(Figure)20
b(6.2:)28 b(Representation)19 b(and)h(de\002nition)f(of)h(nodes.)p
3231 1968 V 555 1971 2678 4 v 555 2098 V 553 3520 4 1422
v 605 2241 a Fs(\(defnode)40 b('people)h("Is)h(the)g(person)g(a)h
(man?")e('male)h('female\))605 2440 y(\(defnode)e('male)i("Is)g(he)h
(living?")d('liveman)g('deadman\))605 2640 y(\(defnode)g('deadman)g
("Was)i(he)h(American?")d('us)i('them\))605 2839 y(\(defnode)e('us)i
("Is)h(he)g(on)f(a)h(coin?")f('coin)f('cidence\))605
3038 y(\(defnode)f('coin)i("Is)g(the)g(coin)g(a)h(penny?")e('penny)g
('coins\))605 3237 y(\(defnode)f('penny)h('lincoln\))1416
3442 y FA(Figure)19 b(6.3:)29 b(Sample)20 b(netw)o(ork.)p
3231 3520 V 555 3523 2678 4 v 555 3747 a(Figure)h(6.3)f(sho)n(ws)i(as)g
(much)e(of)h(the)h(netw)o(ork)e(as)i(we)g(need)f(to)g(produce)e(the)j
(transcript)e(in)555 3852 y(Figure)g(6.1.)680 3956 y(No)n(w)26
b(all)h(we)f(need)g(to)g(do)g(is)i(write)e(a)h(function)e(to)h(tra)n(v)
o(erse)g(this)h(netw)o(ork,)f(printing)555 4061 y(out)d(the)h
(questions)f(and)g(follo)n(wing)f(the)h(indicated)g(path.)39
b(This)24 b(function,)e Fs(run-node)p FA(,)g(is)555 4166
y(sho)n(wn)g(in)h(Figure)g(6.4.)37 b(Gi)n(v)o(en)22 b(a)i(name,)e(we)i
(look)e(up)h(the)g(corresponding)c(node.)37 b(If)23 b(it)h(is)555
4270 y(not)g(a)g(leaf,)h(the)f Fs(contents)d FA(are)j(ask)o(ed)g(as)h
(a)f(question,)g(and)f(depending)f(on)h(the)h(answer)m(,)555
4375 y(we)g(continue)e(tra)n(v)o(ersing)h(at)h(one)f(of)g(tw)o(o)h
(possible)f(destinations.)39 b(If)24 b(the)f(node)g(is)i(a)f(leaf,)555
4479 y Fs(run-node)15 b FA(just)j(returns)f(its)i Fs(contents)p
FA(.)26 b(W)m(ith)18 b(the)g(netw)o(ork)f(de\002ned)f(in)i(Figure)g
(6.3,)f(this)555 4584 y(function)h(produces)h(the)h(output)f(sho)n(wn)h
(in)g(Figure)f(6.1.)p eop
%%Page: 79 92
79 91 bop 555 538 a Ft(6.2)916 b Fu(COMPILING)19 b(NETW)o(ORKS)899
b FA(79)p 555 745 2678 4 v 553 1868 4 1123 v 605 888
a Fs(\(defun)41 b(run-node)f(\(name\))692 988 y(\(let)i(\(\(n)g
(\(gethash)f(name)g(*nodes*\)\)\))779 1087 y(\(cond)h(\(\(node-yes)d
(n\))1084 1187 y(\(format)i(t)i("~A~\045>>)e(")i(\(node-contents)38
b(n\)\))1084 1287 y(\(case)k(\(read\))1171 1386 y(\(yes)g(\(run-node)e
(\(node-yes)g(n\)\)\))1171 1486 y(\(t)130 b(\(run-node)40
b(\(node-no)h(n\)\)\)\)\))1041 1586 y(\(t)h(\(node-contents)c
(n\)\)\)\)\))1143 1790 y FA(Figure)19 b(6.4:)29 b(Function)19
b(for)h(tra)n(v)o(ersing)e(netw)o(orks.)p 3231 1868 V
555 1871 2678 4 v 555 1999 V 553 3420 4 1422 v 605 2141
a Fs(\(defvar)41 b(*nodes*)f(\(make-hash-table\))o(\))605
2341 y(\(defun)h(defnode)g(\(name)g(conts)h(&optional)e(yes)i(no\))692
2440 y(\(setf)g(\(gethash)e(name)i(*nodes*\))954 2540
y(\(if)g(yes)1128 2640 y(#'\(lambda)e(\(\))1302 2739
y(\(format)h(t)i("~A~\045>>)e(")i(conts\))1302 2839 y(\(case)f
(\(read\))1389 2938 y(\(yes)g(\(funcall)f(\(gethash)f(yes)i
(*nodes*\)\)\))1389 3038 y(\(t)130 b(\(funcall)41 b(\(gethash)f(no)86
b(*nodes*\)\)\)\)\))1128 3138 y(#'\(lambda)40 b(\(\))i(conts\)\)\)\))
1124 3342 y FA(Figure)19 b(6.5:)29 b(A)21 b(netw)o(ork)e(compiled)g
(into)h(closures.)p 3231 3420 V 555 3423 2678 4 v 555
3647 a Fw(6.2)99 b(Compiling)24 b(Netw)o(orks)555 3838
y FA(In)15 b(the)g(preceding)e(section)j(we)f(wrote)g(a)h(netw)o(ork)e
(program)f(as)j(it)g(might)f(ha)n(v)o(e)f(been)h(written)555
3943 y(in)22 b(an)o(y)e(language.)32 b(Indeed,)20 b(the)h(program)f(is)
i(so)g(simple)g(that)f(it)h(seems)g(odd)f(to)h(think)e(that)555
4047 y(we)g(could)f(write)h(it)h(an)o(y)e(other)g(w)o(ay)-5
b(.)29 b(But)20 b(we)h(can\227in)e(f)o(act,)h(we)g(can)g(write)g(it)g
(much)f(more)555 4152 y(simply)-5 b(.)680 4256 y(The)20
b(code)h(in)g(Figure)g(6.5)f(illustrates)i(this)g(point.)31
b(It')-5 b(s)22 b(all)g(we)f(really)g(need)g(to)g(run)f(our)555
4361 y(netw)o(ork.)51 b(Instead)27 b(of)h(ha)n(ving)f(nodes)g(as)h
(data)g(structures)f(and)h(a)g(separate)f(function)f(to)555
4466 y(tra)n(v)o(erse)18 b(them,)f(we)i(represent)e(the)h(nodes)f(as)i
(closures.)28 b(The)18 b(data)g(formerly)e(contained)g(in)555
4570 y(the)h(structures)f(gets)h(stored)g(in)g(v)n(ariable)e(bindings)h
(within)g(the)h(closures.)28 b(No)n(w)17 b(there)f(is)i(no)555
4675 y(need)k(for)g Fs(run-node)p FA(;)f(it)j(is)f(implicit)g(in)g(the)
g(nodes)f(themselv)o(es.)36 b(T)-7 b(o)22 b(start)i(the)e(tra)n(v)o
(ersal,)p eop
%%Page: 80 93
80 92 bop 555 538 a FA(80)779 b Fu(FUNCTIONS)19 b(AS)g(REPRESENT)-6
b(A)f(TION)p 555 745 2678 4 v 553 3263 4 2518 v 605 888
a Fs(\(defvar)41 b(*nodes*)f(nil\))605 1087 y(\(defun)h(defnode)g
(\(&rest)g(args\))692 1187 y(\(push)h(args)f(*nodes*\))692
1287 y(args\))605 1486 y(\(defun)g(compile-net)e(\(root\))692
1586 y(\(let)j(\(\(node)f(\(assoc)g(root)h(*nodes*\)\)\))779
1685 y(\(if)h(\(null)e(node\))954 1785 y(nil)954 1884
y(\(let)g(\(\(conts)g(\(second)g(node\)\))1215 1984 y(\(yes)h(\(third)f
(node\)\))1215 2084 y(\(no)h(\(fourth)f(node\)\)\))1041
2183 y(\(if)h(yes)1215 2283 y(\(let)g(\(\(yes-fn)e(\(compile-net)f
(yes\)\))1477 2383 y(\(no-fn)84 b(\(compile-net)39 b(no\)\)\))1302
2482 y(#'\(lambda)h(\(\))1477 2582 y(\(format)g(t)j("~A~\045>>)e(")i
(conts\))1477 2681 y(\(funcall)d(\(if)i(\(eq)h(\(read\))e('yes\))2043
2781 y(yes-fn)2043 2881 y(no-fn\)\)\)\))1215 2980 y(#'\(lambda)f(\(\))j
(conts\)\)\)\)\)\))1115 3185 y FA(Figure)20 b(6.6:)29
b(Compilation)19 b(with)h(static)h(references.)p 3231
3263 V 555 3266 2678 4 v 555 3490 a(we)g(just)f(funcall)g(the)g(node)f
(at)i(which)e(we)i(w)o(ant)f(to)h(be)o(gin:)555 3672
y Fs(\(funcall)40 b(\(gethash)h('people)f(*nodes*\)\))555
3772 y(Is)j(the)f(person)f(a)i(man?)555 3872 y(>>)555
4059 y FA(From)13 b(then)g(on,)h(the)f(transcript)g(will)h(be)g(just)g
(as)g(it)g(w)o(as)g(with)g(the)f(pre)n(vious)f(implementation.)680
4164 y(By)25 b(representing)e(the)i(nodes)f(as)i(closures,)f(we)h(are)f
(able)g(to)g(transform)e(our)h(twenty\255)555 4268 y(questions)f(netw)o
(ork)g(entirely)g(into)h(code.)40 b(As)25 b(it)g(is,)h(the)e(code)f
(will)i(ha)n(v)o(e)e(to)i(look)e(up)h(the)555 4373 y(node)k(functions)g
(by)g(name)h(at)g(runtime.)55 b(Ho)n(we)n(v)o(er)m(,)29
b(if)g(we)h(kno)n(w)e(that)h(the)g(netw)o(ork)f(is)555
4478 y(not)c(going)e(to)j(be)e(rede\002ned)g(on)h(the)g(\003y)-5
b(,)24 b(we)h(can)e(add)h(a)g(further)f(enhancement:)34
b(we)25 b(can)555 4582 y(ha)n(v)o(e)c(node)f(functions)f(call)j(their)f
(destinations)f(directly)-5 b(,)20 b(without)h(ha)n(ving)f(to)h(go)g
(through)555 4687 y(a)g(hash\255table.)680 4791 y(Figure)27
b(6.6)g(contains)g(a)h(ne)n(w)g(v)o(ersion)e(of)i(the)g(program.)49
b(No)n(w)28 b Fs(*nodes*)e FA(is)i(a)g(dis\255)555 4896
y(posable)d(list)h(instead)f(of)h(a)f(hash\255table.)44
b(All)26 b(the)g(nodes)e(are)i(de\002ned)e(with)i Fs(defnode)d
FA(as)555 5001 y(before,)e(b)n(ut)h(no)g(closures)g(are)g(generated)f
(at)i(this)f(point.)35 b(After)22 b(all)h(the)f(nodes)g(ha)n(v)o(e)f
(been)p eop
%%Page: 81 94
81 93 bop 555 538 a Ft(6.3)968 b Fu(LOOKING)18 b(FOR)m(W)-7
b(ARD)951 b FA(81)555 801 y(de\002ned,)16 b(we)h(call)g
Fs(compile-net)c FA(to)k(compile)e(a)i(whole)g(netw)o(ork)e(at)i(once.)
27 b(This)17 b(function)555 905 y(recursi)n(v)o(ely)26
b(w)o(orks)i(its)h(w)o(ay)g(right)e(do)n(wn)h(to)g(the)g(lea)n(v)o(es)h
(of)f(the)g(tree,)i(and)d(on)h(the)h(w)o(ay)555 1010
y(back)21 b(up,)h(returns)f(at)i(each)e(step)h(the)g(node/function)d
(for)i(each)h(of)g(the)g(tw)o(o)g(subtrees.)3085 980
y Fm(1)3152 1010 y FA(So)555 1114 y(no)n(w)c(each)g(node)g(will)h(ha)n
(v)o(e)f(a)h(direct)g(handle)e(on)h(its)i(tw)o(o)f(destinations,)f
(instead)g(of)h(ha)n(ving)555 1219 y(only)i(their)g(names.)33
b(When)22 b(the)f(original)g(call)h(to)g Fs(compile-net)17
b FA(returns,)k(it)i(will)f(yield)f(a)555 1324 y(function)d
(representing)h(the)h(portion)e(of)i(the)h(netw)o(ork)e(we)h(ask)o(ed)g
(to)g(ha)n(v)o(e)g(compiled.)555 1506 y Fs(>)43 b(\(setq)f(n)h
(\(compile-net)38 b('people\)\))555 1606 y(#<Compiled-Funct)o(ion)f
(BF3C06>)555 1706 y(>)43 b(\(funcall)d(n\))555 1805 y(Is)j(the)f
(person)f(a)i(man?)555 1905 y(>>)555 2092 y FA(Notice)29
b(that)g Fs(compile-net)c FA(compiles)k(in)g(both)g(senses.)56
b(It)30 b(compiles)e(in)i(the)f(general)555 2197 y(sense,)23
b(by)f(translating)f(the)h(abstract)g(representation)f(of)h(the)g(netw)
o(ork)f(into)h(code.)35 b(More\255)555 2302 y(o)o(v)o(er)m(,)22
b(if)i Fs(compile-net)19 b FA(itself)24 b(is)h(compiled,)d(it)j(will)f
(return)e(compiled)g(functions.)37 b(\(See)555 2406 y(page)20
b(25.\))680 2511 y(After)13 b(compiling)f(the)h(netw)o(ork,)h(we)g
(will)g(no)f(longer)g(need)g(the)g(list)i(made)e(by)g
Fs(defnode)p FA(.)555 2616 y(It)19 b(can)g(be)f(cut)h(loose)g(\(e.g.)f
(by)g(setting)h Fs(*nodes*)d FA(to)j Fs(nil)p FA(\))f(and)g(reclaimed)g
(by)g(the)h(garbage)555 2720 y(collector)-5 b(.)555 2973
y Fw(6.3)99 b(Looking)25 b(F)n(orward)555 3163 y FA(Man)o(y)20
b(programs)g(in)m(v)n(olving)f(netw)o(orks)i(can)g(be)h(implemented)d
(by)i(compiling)f(the)h(nodes)555 3268 y(into)g(closures.)33
b(Closures)21 b(are)g(data)h(objects,)f(and)g(the)o(y)g(can)g(be)g
(used)g(to)h(represent)e(things)555 3373 y(just)26 b(as)f(structures)g
(can.)43 b(Doing)25 b(so)g(requires)f(some)h(uncon)m(v)o(entional)c
(thinking,)j(b)n(ut)i(the)555 3477 y(re)n(w)o(ards)20
b(are)g(f)o(aster)g(and)g(more)f(ele)o(gant)g(programs.)680
3582 y(Macros)32 b(help)h(substantially)f(when)g(we)h(use)h(closures)e
(as)i(a)f(representation.)66 b(\223T)-7 b(o)555 3686
y(represent)19 b(with)h(closures\224)f(is)i(another)d(w)o(ay)i(of)g
(saying)f(\223to)h(compile,)-6 b(\224)19 b(and)g(since)h(macros)555
3791 y(do)36 b(their)g(w)o(ork)g(at)h(compile\255time,)h(the)o(y)e(are)
g(a)h(natural)e(v)o(ehicle)h(for)g(this)g(technique.)555
3896 y(After)21 b(macros)f(ha)n(v)o(e)g(been)g(introduced,)f(Chapters)h
(23)h(and)f(24)g(will)i(present)e(much)g(lar)o(ger)555
4000 y(programs)e(based)i(on)g(the)g(strate)o(gy)f(used)h(here.)p
555 4921 1074 4 v 645 4977 a Fl(1)675 5001 y Fr(This)c(v)o(ersion)i
(assumes)f(that)i(the)e(netw)o(ork)i(is)e(a)g(tree,)h(which)g(it)f
(must)g(be)g(in)h(this)f(application.)p eop
%%Page: 82 95
82 94 bop 555 1610 a Fn(7)p 555 1872 2686 3 v 555 2131
a Fx(Macr)m(os)555 2568 y FA(Lisp')-5 b(s)35 b(macro)e(f)o(acility)h
(allo)n(ws)g(you)g(to)g(de\002ne)g(operators)e(that)j(are)f
(implemented)e(by)555 2672 y(transformation.)f(The)21
b(de\002nition)g(of)g(a)i(macro)d(is)j(essentially)f(a)g(function)e
(that)i(generates)555 2777 y(Lisp)j(code\227a)e(program)f(that)j
(writes)g(programs.)40 b(From)24 b(these)g(small)h(be)o(ginnings)d
(arise)555 2882 y(great)k(possibilities,)j(and)d(also)h(une)o(xpected)d
(hazards.)48 b(Chapters)27 b(7\22610)e(form)h(a)h(tutorial)555
2986 y(on)20 b(macros.)29 b(This)20 b(chapter)f(e)o(xplains)h(ho)n(w)g
(macros)f(w)o(ork,)h(gi)n(v)o(es)g(techniques)e(for)i(writing)555
3091 y(and)g(testing)g(them,)f(and)h(looks)g(at)g(the)h(issue)f(of)g
(macro)g(style.)555 3344 y Fw(7.1)99 b(Ho)o(w)24 b(Macr)n(os)h(W)-7
b(ork)555 3534 y FA(Since)16 b(macros)f(can)g(be)h(called)f(and)g
(return)g(v)n(alues,)h(the)o(y)f(tend)g(to)h(be)g(associated)f(with)h
(func\255)555 3639 y(tions.)42 b(Macro)23 b(de\002nitions)h(sometimes)g
(resemble)f(function)g(de\002nitions,)h(and)g(speaking)555
3743 y(informally)-5 b(,)23 b(people)g(call)i Fs(do)p
FA(,)f(which)g(is)h(actually)f(a)h(macro,)f(a)h(\223b)n(uilt\255in)e
(function.)-6 b(\224)40 b(But)555 3848 y(pushing)15 b(the)h(analogy)e
(too)i(f)o(ar)g(can)g(be)g(a)h(source)e(of)h(confusion.)26
b(Macros)15 b(w)o(ork)h(dif)n(ferently)555 3953 y(from)29
b(normal)f(functions,)i(and)g(kno)n(wing)d(ho)n(w)i(and)h(why)e(macros)
h(are)h(dif)n(ferent)e(is)j(the)555 4057 y(k)o(e)o(y)24
b(to)h(using)f(them)h(correctly)-5 b(.)41 b(A)25 b(function)e(produces)
g(results,)j(b)n(ut)f(a)g(macro)f(produces)555 4162 y
Ft(e)n(xpr)m(essions)p FA(\227which,)19 b(when)h(e)n(v)n(aluated,)e
(produce)g(results.)680 4266 y(The)i(best)i(w)o(ay)f(to)g(be)o(gin)f
(is)i(to)f(mo)o(v)o(e)f(straight)h(into)f(an)h(e)o(xample.)31
b(Suppose)20 b(we)h(w)o(ant)555 4371 y(to)26 b(write)g(a)h(macro)e
Fs(nil!)p FA(,)h(which)f(sets)i(its)g(ar)o(gument)d(to)i
Fs(nil)p FA(.)46 b(W)-7 b(e)27 b(w)o(ant)f Fs(\(nil!)42
b(x\))25 b FA(to)555 4476 y(ha)n(v)o(e)g(the)g(same)g(ef)n(fect)f(as)i
Fs(\(setq)42 b(x)h(nil\))p FA(.)g(W)-7 b(e)26 b(do)f(it)h(by)e
(de\002ning)g Fs(nil!)g FA(as)i(a)g(macro)555 4580 y(which)20
b(turns)f(instances)i(of)e(the)i(\002rst)g(form)e(into)h(instances)g
(of)g(the)g(second.)555 4763 y Fs(>)43 b(\(defmacro)d(nil!)i(\(var\))
729 4863 y(\(list)g('setq)f(var)i(nil\)\))555 4962 y(NIL!)1856
5229 y FA(82)p eop
%%Page: 83 96
83 95 bop 555 538 a Ft(7.1)953 b Fu(HO)n(W)20 b(MA)n(CR)n(OS)e(W)o(ORK)
937 b FA(83)555 801 y(P)o(araphrased)13 b(in)g(English,)d(this)j
(de\002nition)g(tells)g(Lisp:)24 b(\223Whene)n(v)o(er)13
b(you)g(see)g(an)g(e)o(xpr)o(ession)555 905 y(of)28 b(the)h(form)f
Fs(\(nil!)41 b Ft(var)p Fs(\))p FA(,)31 b(turn)d(it)h(into)g(one)f(of)g
(the)h(form)f Fs(\(setq)41 b Ft(var)i Fs(nil\))28 b FA(before)555
1010 y(e)n(v)n(aluating)18 b(it.)-6 b(\224)680 1114 y(The)13
b(e)o(xpression)g(generated)g(by)g(the)g(mac)o(ro)g(will)g(be)g(e)n(v)m
(alua)o(ted)g(in)g(plac)o(e)g(of)g(the)f(orig)o(inal)555
1219 y(macro)27 b(call.)53 b(A)28 b(macro)f(call)i(is)g(a)f(list)h
(whose)f(\002rst)g(element)g(is)g(the)g(name)g(of)f(a)i(macro.)555
1324 y(What)f(happens)d(when)i(we)h(type)e(the)i(macro)e(call)i
Fs(\(nil!)41 b(x\))27 b FA(into)g(the)g(tople)n(v)o(el?)49
b(Lisp)555 1428 y(notices)20 b(that)g Fs(nil!)f FA(is)i(the)g(name)e
(of)h(a)h(macro,)e(and)659 1613 y(1.)41 b(b)n(uilds)20
b(the)g(e)o(xpression)e(speci\002ed)i(by)g(the)g(de\002nition)f(abo)o
(v)o(e,)g(then)659 1783 y(2.)41 b(e)n(v)n(aluates)19
b(that)h(e)o(xpression)f(in)h(place)g(of)g(the)g(original)f(macro)h
(call.)680 1967 y(The)d(step)i(of)f(b)n(uilding)f(the)h(ne)n(w)g(e)o
(xpression)e(is)j(called)f Ft(macr)l(oe)n(xpansion.)27
b FA(Lisp)18 b(looks)555 2072 y(up)27 b(the)f(de\002nition)g(of)h
Fs(nil!)p FA(,)g(which)f(sho)n(ws)h(ho)n(w)g(to)g(construct)f(a)h
(replacement)e(for)i(the)555 2176 y(macro)e(call.)45
b(The)26 b(de\002nition)e(of)i Fs(nil!)e FA(is)j(applied)d(lik)o(e)i(a)
g(function)e(to)i(the)f Ft(e)n(xpr)m(essions)555 2281
y FA(gi)n(v)o(en)g(as)h(ar)o(guments)e(in)j(the)f(macro)f(call.)47
b(It)26 b(returns)f(a)i(list)g(of)f(three)f(elements:)41
b Fs(setq)p FA(,)555 2385 y(the)29 b(e)o(xpression)f(gi)n(v)o(en)f(as)j
(the)f(ar)o(gument)e(to)i(the)g(macro,)h(and)f Fs(nil)p
FA(.)55 b(In)29 b(this)g(case,)j(the)555 2490 y(ar)o(gument)18
b(to)i Fs(nil!)f FA(is)i Fs(x)p FA(,)g(and)e(the)h(macroe)o(xpansion)d
(is)k Fs(\(setq)42 b(x)h(nil\))p FA(.)680 2595 y(After)27
b(macroe)o(xpansion)e(comes)j(a)g(second)f(step,)j Ft(e)o(valuation.)51
b FA(Lisp)28 b(e)n(v)n(aluates)g(the)555 2699 y(macroe)o(xpansion)15
b Fs(\(setq)41 b(x)i(nil\))17 b FA(as)i(if)g(you)e(had)h(typed)f(that)h
(in)g(the)h(\002rst)g(place.)28 b(Ev)n(alu\255)555 2804
y(ation)16 b(does)f(not)h(al)o(w)o(ays)g(come)f(immediately)g(after)g
(e)o(xpansion,)g(as)i(it)f(does)g(at)g(the)g(tople)n(v)o(el.)555
2908 y(A)22 b(macro)e(call)i(occurring)d(in)j(the)f(de\002nition)f(of)h
(a)h(function)e(will)i(be)f(e)o(xpanded)e(when)i(the)555
3013 y(function)j(is)i(compiled,)f(b)n(ut)h(the)f(e)o(xpansion\227or)e
(the)i(object)g(code)g(which)g(results)h(from)555 3118
y(it\227w)o(on')o(t)19 b(be)h(e)n(v)n(aluated)f(until)h(the)g(function)
f(is)i(called.)680 3222 y(Man)o(y)g(of)h(the)g(dif)n(\002culties)g(you)
g(might)g(encounter)e(with)i(macros)g(can)g(be)h(a)n(v)n(oided)e(by)555
3327 y(maintaining)i(a)i(sharp)f(distinction)g(between)g(macroe)o
(xpansion)d(and)k(e)n(v)n(aluation.)41 b(When)555 3432
y(writing)14 b(macros,)h(kno)n(w)f(which)g(computations)f(are)i
(performed)d(during)h(macroe)o(xpansion,)555 3536 y(and)28
b(which)g(during)g(e)n(v)n(aluation,)h(for)f(the)h(tw)o(o)g(steps)g
(generally)e(operate)h(on)g(objects)h(of)555 3641 y(tw)o(o)i(dif)n
(ferent)e(sorts.)62 b(The)31 b(macroe)o(xpansion)c(step)k(deals)g(with)
g(e)o(xpressions,)h(and)f(the)555 3745 y(e)n(v)n(aluation)18
b(step)j(deals)f(with)h(their)f(v)n(alues.)680 3850 y(Sometimes)14
b(macroe)o(xpansion)d(can)j(be)h(more)f(complicated)f(than)h(it)i(w)o
(as)f(in)g(the)g(case)g(of)555 3955 y Fs(nil!)p FA(.)28
b(The)18 b(e)o(xpansion)f(of)h Fs(nil!)g FA(w)o(as)h(a)g(call)g(to)g(a)
g(b)n(uilt\255in)g(special)f(form,)g(b)n(ut)h(sometimes)555
4059 y(the)f(e)o(xpansion)d(of)j(a)g(macro)e(will)j(be)e(yet)h(another)
e(macro)g(call,)j(lik)o(e)f(a)g(Russian)g(doll)f(which)555
4164 y(contains)23 b(another)f(doll)i(inside)f(it.)41
b(In)24 b(such)f(cases,)i(macroe)o(xpansion)20 b(simply)k(continues)555
4268 y(until)d(it)h(arri)n(v)o(es)f(at)h(an)f(e)o(xpression)f(which)g
(is)j(no)e(longer)f(a)h(macro)g(call.)33 b(The)21 b(process)g(can)555
4373 y(tak)o(e)f(arbitrarily)f(man)o(y)g(steps,)i(so)f(long)f(as)i(it)g
(terminates)f(e)n(v)o(entually)-5 b(.)680 4478 y(Man)o(y)27
b(languages)f(of)n(fer)h(some)h(form)f(of)h(macro,)h(b)n(ut)f(Lisp)g
(macros)g(are)g(singularly)555 4582 y(po)n(werful.)d(When)14
b(a)g(\002le)g(of)g(Lisp)g(is)g(compiled,)g(a)g(parser)f(reads)h(the)f
(source)g(code)g(and)h(sends)555 4687 y(its)27 b(output)d(to)i(the)f
(compiler)-5 b(.)45 b(Here')-5 b(s)26 b(the)f(strok)o(e)g(of)h(genius:)
39 b(the)26 b(output)e(of)i(the)f(parser)555 4791 y(consists)j(of)g
Ft(lists)h(of)f(Lisp)h(objects.)52 b FA(W)m(ith)28 b(macros,)h(we)g
(can)e(manipulate)g(the)h(program)555 4896 y(while)g(it')-5
b(s)28 b(in)g(this)g(intermediate)e(form)h(between)g(parser)g(and)g
(compiler)-5 b(.)50 b(If)28 b(necessary)-5 b(,)555 5001
y(these)20 b(manipulations)e(can)h(be)h(v)o(ery)e(e)o(xtensi)n(v)o(e.)
28 b(A)20 b(macro)e(generating)g(its)j(e)o(xpansion)c(has)p
eop
%%Page: 84 97
84 96 bop 555 538 a FA(84)1135 b Fu(MA)n(CR)n(OS)555
801 y FA(at)15 b(its)h(disposition)e(the)g(full)h(po)n(wer)f(of)g
(Lisp.)27 b(Indeed,)15 b(a)g(macro)e(is)j(really)e(a)h(Lisp)g
(function\227)555 905 y(one)h(which)g(happens)f(to)i(return)f(e)o
(xpressions.)26 b(The)16 b(de\002nition)g(of)g Fs(nil!)g
FA(contains)g(a)h(single)555 1010 y(call)k(to)f Fs(list)p
FA(,)f(b)n(ut)h(another)f(macro)g(might)h(in)m(v)n(ok)o(e)f(a)h(whole)g
(subprogram)d(to)k(generate)e(its)555 1114 y(e)o(xpansion.)680
1219 y(Being)14 b(able)g(to)g(change)f(what)h(the)g(compiler)f(sees)i
(is)h(almost)e(lik)o(e)g(being)g(able)g(to)g(re)n(write)555
1324 y(it.)29 b(W)-7 b(e)20 b(can)e(add)f(an)o(y)h(construct)f(to)i
(the)f(language)e(that)j(we)f(can)h(de\002ne)e(by)h(transformation)555
1428 y(into)i(e)o(xisting)f(constructs.)555 1681 y Fw(7.2)99
b(Backquote)555 1871 y FA(Backquote)27 b(is)j(a)f(special)g(v)o(ersion)
e(of)i(quote)f(which)g(can)g(be)h(used)f(to)h(create)g(templates)555
1976 y(for)e(Lisp)h(e)o(xpressions.)50 b(One)28 b(of)f(the)h(most)g
(common)e(uses)i(of)f(backquote)f(is)j(in)f(macro)555
2081 y(de\002nitions.)680 2185 y(The)18 b(backquote)f(character)m(,)h
Fs(`)p FA(,)h(is)h(so)g(named)e(because)g(it)i(resembles)f(a)g(re)o
(gular)f(quote,)555 2290 y Fs(')p FA(,)g(re)n(v)o(ersed.)27
b(When)17 b(backquote)f(alone)h(is)h(af)n(\002x)o(ed)f(to)g(an)h(e)o
(xpression,)e(it)i(beha)n(v)o(es)f(just)h(lik)o(e)555
2394 y(quote:)1307 2581 y Fs(`\(a)43 b(b)g(c\))d FA(is)22
b Fs(equal)c FA(to)41 b Fs('\(a)i(b)g(c\))p FA(.)680
2827 y(Backquote)17 b(becomes)h(useful)g(only)g(when)g(it)h(appears)f
(in)h(combination)d(with)j(comma,)555 2932 y Fs(,)p FA(,)g(and)f
(comma\255at,)g Fs(,@)p FA(.)28 b(If)19 b(backquote)e(mak)o(es)i(a)g
(template,)f(comma)g(mak)o(es)h(a)g(slot)h(within)555
3037 y(a)27 b(template.)46 b(A)27 b(backquoted)c(list)28
b(is)f(equi)n(v)n(alent)d(to)j(a)f(call)h(to)f Fs(list)f
FA(with)i(the)f(elements)555 3141 y(quoted.)i(That)20
b(is,)1155 3328 y Fs(`\(a)42 b(b)h(c\))e FA(is)21 b Fs(equal)e
FA(to)41 b Fs(\(list)g('a)i('b)g('c\))p FA(.)555 3574
y(W)m(ithin)31 b(the)g(scope)g(of)g(a)h(backquote,)f(a)h(comma)e(tells)
j(Lisp:)51 b(\223turn)31 b(of)n(f)f(the)h(quoting.)-6
b(\224)555 3679 y(When)21 b(a)g(comma)g(appears)f(before)f(one)i(of)g
(the)g(elements)g(of)g(the)g(list,)h(it)g(has)f(the)g(ef)n(fect)g(of)
555 3783 y(cancelling)e(out)h(the)g(quote)f(that)i(w)o(ould)e(ha)n(v)o
(e)h(been)f(put)h(there.)29 b(So)1046 3970 y Fs(`\(a)42
b(,b)h(c)g(,d\))d FA(is)21 b Fs(equal)e FA(to)41 b Fs(\(list)h('a)g(b)i
('c)e(d\))p FA(.)555 4216 y(Instead)18 b(of)h(the)g(symbol)f
Fs(b)p FA(,)h(its)h(v)n(alue)e(is)i(inserted)e(into)h(the)g(resulting)f
(list.)30 b(Commas)18 b(w)o(ork)555 4321 y(no)i(matter)g(ho)n(w)f
(deeply)g(the)o(y)h(appear)f(within)h(a)g(nested)g(list,)555
4503 y Fs(>)43 b(\(setq)f(a)h(1)g(b)g(2)g(c)h(3\))555
4602 y(3)555 4702 y(>)f(`\(a)g(,b)f(c\))555 4801 y(\(A)h(2)g(C\))555
4901 y(>)g(`\(a)g(\(,b)f(c\)\))555 5001 y(\(A)h(\(2)g(C\)\))p
eop
%%Page: 85 98
85 97 bop 555 538 a Ft(7.2)1077 b Fu(B)n(A)n(CKQ)o(UO)n(TE)1058
b FA(85)555 801 y(and)20 b(the)o(y)f(may)h(e)n(v)o(en)f(appear)g
(within)h(quotes,)f(or)h(within)g(quoted)f(sublists:)555
967 y Fs(>)43 b(`\(a)g(b)g(,c)f(\(',\(+)g(a)h(b)g(c\)\))g(\(+)f(a)i
(b\))e('c)h('\(\(,a)f(,b\)\)\))555 1066 y(\(A)h(B)g(3)g(\('6\))f(\(+)h
(A)g(B\))g('C)f('\(\(1)g(2\)\)\))680 1237 y FA(One)21
b(comma)g(counteracts)f(the)i(ef)n(fect)f(of)g(one)h(backquote,)d(so)j
(commas)f(must)h(match)555 1342 y(backquotes.)j(Say)13
b(that)g(a)g(comma)g(is)g Ft(surr)l(ounded)g FA(by)g(a)g(p)o(articu)o
(lar)g(o)o(per)o(ator)f(if)h(the)f(op)o(erato)o(r)555
1447 y(is)24 b(prepended)d(to)i(the)g(comma,)g(or)g(prepended)e(to)i
(an)g(e)o(xpression)f(which)g(contains)h(it.)39 b(In)555
1551 y Fs(`\(,a)j(,\(b)g(`,c\)\)\))p FA(,)26 b(for)g(e)o(xample,)h(the)
g(last)g(comma)f(is)h(surrounded)d(by)i(one)h(comma)555
1656 y(and)16 b(tw)o(o)h(backquotes.)27 b(The)16 b(general)g(rule)g
(is:)29 b(a)17 b(comma)f(surrounded)e(by)i Ft(n)h FA(commas)g(must)555
1760 y(be)k(surrounded)e(by)i(at)h(least)g Ft(n)p Fj(+)p
FA(1)f(backquotes.)31 b(An)22 b(ob)o(vious)d(corollary)h(is)j(that)e
(commas)555 1865 y(may)c(not)h(appear)e(outside)h(of)h(a)g(backquoted)d
(e)o(xpression.)27 b(Backquotes)17 b(and)g(commas)g(can)555
1970 y(be)k(nested,)g(so)g(long)g(as)h(the)o(y)e(obe)o(y)g(the)h(rule)g
(abo)o(v)o(e.)30 b(An)o(y)20 b(of)h(the)g(follo)n(wing)f(e)o
(xpressions)555 2074 y(w)o(ould)f(generate)g(an)i(error)e(if)h(typed)f
(into)h(the)g(tople)n(v)o(el:)904 2257 y Fs(,x)173 b(`\(a)43
b(,,b)f(c\))173 b(`\(a)43 b(,\(b)f(,c\))g(d\))174 b(`\(,,`a\))555
2444 y FA(Nested)23 b(backquotes)e(are)i(only)f(lik)o(ely)g(to)h(be)g
(needed)f(in)g(macro\255de\002ning)e(macros.)37 b(Both)555
2549 y(topics)20 b(are)g(discussed)g(in)h(Chapter)e(16.)680
2654 y(Backquote)f(is)j(usually)e(used)h(for)f(making)f(lists.)2104
2624 y Fm(1)2168 2654 y FA(An)o(y)h(list)i(generated)d(by)i(backquote)
555 2758 y(can)35 b(also)h(be)g(generated)e(by)h(using)g
Fs(list)f FA(and)h(re)o(gular)f(quotes.)75 b(The)35 b(adv)n(antage)f
(of)555 2863 y(backquote)22 b(is)j(just)f(that)g(it)h(mak)o(es)f(e)o
(xpressions)f(easier)h(to)g(read,)g(because)g(a)g(backquoted)555
2968 y(e)o(xpression)f(resembles)h(the)h(e)o(xpression)e(it)i(will)g
(produce.)40 b(In)24 b(the)h(pre)n(vious)e(section)h(we)555
3072 y(de\002ned)19 b Fs(nil!)g FA(as:)555 3255 y Fs(\(defmacro)40
b(nil!)i(\(var\))642 3354 y(\(list)g('setq)f(var)i(nil\)\))555
3537 y FA(W)m(ith)20 b(backquote)e(the)j(same)f(macro)f(can)h(be)g
(de\002ned)g(as:)555 3703 y Fs(\(defmacro)40 b(nil!)i(\(var\))642
3803 y(`\(setq)f(,var)h(nil\)\))555 3974 y FA(which)34
b(in)g(this)h(case)g(is)g(not)f(all)h(that)g(dif)n(ferent.)70
b(The)34 b(longer)f(the)i(macro)e(de\002nition,)555 4078
y(ho)n(we)n(v)o(er)m(,)g(the)f(more)g(important)f(it)i(is)g(to)g(use)f
(backquote.)64 b(Figure)32 b(7.1)g(contains)f(tw)o(o)555
4183 y(possible)20 b(de\002nitions)f(of)h Fs(nif)p FA(,)f(a)i(macro)e
(which)h(does)g(a)h(three\255w)o(ay)d(numeric)h Fs(if)p
FA(.)2975 4153 y Fm(2)680 4288 y FA(The)26 b(\002rst)i(ar)o(gument)c
(should)i(e)n(v)n(aluate)g(to)h(a)g(number)-5 b(.)48
b(Then)26 b(the)h(second,)g(third,)h(or)555 4392 y(fourth)23
b(ar)o(gument)g(is)i(e)n(v)n(aluated,)f(depending)f(on)h(whether)g(the)
g(\002rst)i(w)o(as)g(positi)n(v)o(e,)e(zero,)555 4497
y(or)c(ne)o(gati)n(v)o(e:)555 4679 y Fs(>)43 b(\(mapcar)e(#'\(lambda)f
(\(x\))1165 4779 y(\(nif)i(x)h('p)g('z)g('n\)\))991 4879
y('\(0)f(2.5)h(-8\)\))555 4978 y(\(Z)g(P)g(N\))p eop
%%Page: 86 99
86 98 bop 555 538 a FA(86)1135 b Fu(MA)n(CR)n(OS)p 555
745 2678 4 v 553 2588 4 1844 v 605 886 a FA(W)m(ith)20
b(backquote:)605 1052 y Fs(\(defmacro)40 b(nif)i(\(expr)g(pos)g(zero)g
(neg\))692 1152 y(`\(case)f(\(truncate)f(\(signum)h(,expr\)\))823
1252 y(\(1)i(,pos\))823 1351 y(\(0)g(,zero\))823 1451
y(\(-1)f(,neg\)\)\))605 1658 y FA(W)m(ithout)19 b(backquote:)605
1825 y Fs(\(defmacro)40 b(nif)i(\(expr)g(pos)g(zero)g(neg\))692
1924 y(\(list)g('case)954 2024 y(\(list)f('truncate)f(\(list)h('signum)
g(expr\)\))954 2123 y(\(list)g(1)i(pos\))954 2223 y(\(list)e(0)i
(zero\))954 2323 y(\(list)e(-1)i(neg\)\)\))937 2510 y
FA(Figure)19 b(7.1:)29 b(A)21 b(macro)e(de\002ned)g(with)h(and)g
(without)g(backquote.)p 3231 2588 V 555 2592 2678 4 v
680 2814 a(The)29 b(tw)o(o)g(de\002nitions)g(in)g(Figure)g(7.1)f
(de\002ne)h(the)g(same)h(macro,)g(b)n(ut)g(the)f(\002rst)h(uses)555
2918 y(backquote,)19 b(while)i(the)g(second)f(b)n(uilds)g(its)i(e)o
(xpansion)d(by)i(e)o(xplicit)f(calls)i(to)f Fs(list)p
FA(.)30 b(From)555 3023 y(the)18 b(\002rst)h(de\002nition)e(it')-5
b(s)19 b(easy)f(to)g(see)h(that)f Fs(\(nif)42 b(x)h('p)g('z)f('n\))p
FA(,)18 b(for)f(e)o(xample,)g(e)o(xpands)555 3127 y(into)555
3307 y Fs(\(case)42 b(\(truncate)d(\(signum)i(x\)\))642
3407 y(\(1)i('p\))642 3506 y(\(0)g('z\))642 3606 y(\(-1)g('n\)\))555
3791 y FA(because)15 b(the)i(body)d(of)i(the)h(macro)e(de\002nition)g
(looks)g(just)i(lik)o(e)g(the)f(e)o(xpansion)e(it)j(generates.)555
3895 y(T)-7 b(o)25 b(understand)d(the)i(second)g(v)o(ersion,)g(without)
g(backquote,)f(you)g(ha)n(v)o(e)h(to)h(trace)f(in)h(your)555
4000 y(head)20 b(the)g(b)n(uilding)f(of)h(the)g(e)o(xpansion.)680
4104 y(Comma\255at,)35 b Fs(,@)p FA(,)i(is)d(a)g(v)n(ariant)e(of)i
(comma.)68 b(It)34 b(beha)n(v)o(es)e(lik)o(e)i(comma,)h(with)f(one)555
4209 y(dif)n(ference:)47 b(instead)30 b(of)f(merely)g(inserting)g(the)h
(v)n(alue)f(of)h(the)g(e)o(xpression)e(to)i(which)g(it)555
4314 y(is)f(af)n(\002x)o(ed,)h(as)f(comma)e(does,)j(comma\255at)d
Ft(splices)i FA(it.)55 b(Splicing)28 b(can)g(be)h(thought)e(of)h(as)555
4418 y(inserting)19 b(while)i(remo)o(ving)c(the)k(outermost)d(le)n(v)o
(el)i(of)g(parentheses:)555 4598 y Fs(>)43 b(\(setq)f(b)h('\(1)f(2)h
(3\)\))555 4698 y(\(1)g(2)g(3\))p 555 4756 1074 4 v 645
4813 a Fl(1)675 4836 y Fr(Backquote)19 b(can)f(also)g(be)f(used)g(to)h
(create)h(v)o(ectors,)f(b)o(ut)f(this)g(is)g(rarely)i(done)f(in)f
(macro)g(de\002nitions.)645 4894 y Fl(2)675 4918 y Fr(This)26
b(macro)g(is)h(de\002ned)g(a)f(little)j(oddly)e(to)g(a)o(v)o(oid)g
(using)f(gensyms.)52 b(A)26 b(better)i(de\002nition)h(is)d(gi)n(v)o(en)
i(on)555 5001 y(page)18 b(150.)p eop
%%Page: 87 100
87 99 bop 555 538 a Ft(7.2)1077 b Fu(B)n(A)n(CKQ)o(UO)n(TE)1058
b FA(87)555 801 y Fs(>)43 b(`\(a)g(,b)f(c\))555 900 y(\(A)h(\(1)g(2)g
(3\))f(C\))555 1000 y(>)h(`\(a)g(,@b)f(c\))555 1100 y(\(A)h(1)g(2)g(3)g
(C\))555 1266 y FA(The)16 b(comma)f(causes)h(the)g(list)h
Fs(\(1)43 b(2)g(3\))16 b FA(to)g(be)g(inserted)f(in)i(place)e(of)h
Fs(b)p FA(,)h(while)f(the)g(comma\255)555 1370 y(at)24
b(causes)f(the)g(elements)f(of)h(the)g(list)h(to)g(be)e(inserted)h
(there.)37 b(There)22 b(are)h(some)g(additional)555 1475
y(restrictions)d(on)f(the)i(use)f(of)g(comma\255at:)659
1641 y(1.)41 b(In)33 b(order)g(for)h(its)h(ar)o(gument)d(to)i(be)g
(spliced,)j(comma\255at)c(must)h(occur)f(within)h(a)763
1746 y(sequence.)26 b(It')-5 b(s)18 b(an)f(error)e(to)i(say)g
(something)e(lik)o(e)i Fs(`,@b)f FA(because)g(there)h(is)g(no)n(where)
763 1850 y(to)j(splice)g(the)h(v)n(alue)e(of)h Fs(b)p
FA(.)659 2013 y(2.)41 b(The)18 b(object)g(to)h(be)f(spliced)h(must)f
(be)h(a)g(list,)h(unless)e(it)i(occurs)d(last.)30 b(The)18
b(e)o(xpression)763 2117 y Fs(`\(a)42 b(,@1\))17 b FA(will)h(e)n(v)n
(aluate)f(to)h Fs(\(a)42 b(.)87 b(1\))p FA(,)18 b(b)n(ut)g(attempting)e
(to)i(splice)g(an)f(atom)h(into)763 2222 y(the)i(middle)f(of)h(a)h
(list,)g(as)g(in)f Fs(`\(a)42 b(,@1)h(b\))p FA(,)19 b(will)i(cause)f
(an)h(error)-5 b(.)680 2388 y(Comma\255at)18 b(tends)h(to)g(be)g(used)g
(in)h(macros)e(which)h(tak)o(e)g(an)g(indeterminate)e(number)h(of)555
2493 y(ar)o(guments)e(and)i(pass)h(them)g(on)f(to)g(functions)f(or)i
(macros)e(which)h(also)h(tak)o(e)g(an)f(indetermi\255)555
2597 y(nate)24 b(number)e(of)i(ar)o(guments.)39 b(This)25
b(situation)e(commonly)f(arises)j(when)f(implementing)555
2702 y(implicit)13 b(blocks.)26 b(Common)13 b(Lisp)g(has)g(se)n(v)o
(eral)g(operators)g(for)g(gro)o(up)o(ing)g(co)o(de)g(into)f(bloc)o(ks,)
555 2807 y(including)17 b Fs(block)p FA(,)h Fs(tagbody)p
FA(,)f(and)i Fs(progn)p FA(.)27 b(These)19 b(operators)f(rarely)g
(appear)g(directly)g(in)555 2911 y(source)h(code;)h(the)o(y)f(are)i
(more)e(often)g Ft(implicit)p FA(\227that)h(is,)h(hidden)e(by)h
(macros.)680 3016 y(An)32 b(implicit)g(block)f(occurs)h(in)g(an)o(y)g
(b)n(uilt\255in)f(macro)h(which)f(can)h(ha)n(v)o(e)g(a)h
Ft(body)e FA(of)555 3120 y(e)o(xpressions.)68 b(Both)33
b Fs(let)g FA(and)g Fs(cond)f FA(pro)o(vide)g(implicit)h
Fs(progn)p FA(,)i(for)e(e)o(xample.)68 b(The)555 3225
y(simplest)21 b(b)n(uilt\255in)e(macro)g(to)i(do)e(so)i(is)g(probably)d
Fs(when)p FA(:)555 3386 y Fs(\(when)42 b(\(eligible)d(obj\))642
3486 y(\(do-this\))642 3586 y(\(do-that\))642 3685 y(obj\))555
3851 y FA(If)14 b Fs(\(eligible)40 b(obj\))14 b FA(returns)f(true,)i
(the)g(remaining)d(e)o(xpressions)i(will)h(be)f(e)n(v)n(aluated,)g(and)
555 3956 y(the)k Fs(when)g FA(e)o(xpression)e(as)k(a)e(whole)g(will)h
(return)e(the)i(v)n(alue)f(of)g(the)g(last.)29 b(As)20
b(an)e(e)o(xample)f(of)555 4061 y(the)j(use)h(of)f(comma\255at,)e(here)
i(is)h(one)e(possible)h(de\002nition)f(for)h Fs(when)p
FA(:)555 4222 y Fs(\(defmacro)40 b(our-when)g(\(test)i(&body)f(body\))
642 4321 y(`\(if)h(,test)860 4421 y(\(progn)947 4521
y(,@body\)\)\))555 4687 y FA(This)22 b(de\002nition)g(uses)g(an)h
Fs(&body)d FA(parameter)h(\(identical)h(to)g Fs(&rest)f
FA(e)o(xcept)g(for)h(its)h(ef)n(fect)555 4791 y(on)g
(pretty\255printing\))c(to)k(tak)o(e)g(in)g(an)g(arbitrary)e(number)g
(of)i(ar)o(guments,)e(and)i(a)g(comma\255at)555 4896
y(to)e(splice)f(them)g(into)g(a)h Fs(progn)e FA(e)o(xpression.)28
b(In)20 b(the)g(macroe)o(xpansion)d(of)j(the)h(call)f(abo)o(v)o(e,)555
5001 y(the)g(three)g(e)o(xpressions)f(in)h(the)g(body)f(will)i(appear)e
(within)h(a)h(single)f Fs(progn)p FA(:)p eop
%%Page: 88 101
88 100 bop 555 538 a FA(88)1135 b Fu(MA)n(CR)n(OS)555
801 y Fs(\(if)42 b(\(eligible)e(obj\))729 900 y(\(progn)h(\(do-this\))
1034 1000 y(\(do-that\))1034 1100 y(obj\)\))555 1278
y FA(Most)20 b(macros)g(for)g(iteration)f(splice)h(their)g(ar)o
(guments)f(in)h(a)g(similar)h(w)o(ay)-5 b(.)680 1383
y(The)26 b(ef)n(fect)h(of)g(comma\255at)f(can)h(be)g(achie)n(v)o(ed)e
(without)i(using)f(backquote.)48 b(The)27 b(e)o(x\255)555
1488 y(pression)19 b Fs(`\(a)42 b(,@b)h(c\))19 b FA(is)i(equal)e(to)h
Fs(\(cons)42 b('a)h(\(append)d(b)j(\(list)f('c\)\)\))p
FA(,)18 b(for)h(e)o(x\255)555 1592 y(ample.)55 b(Comma\255at)27
b(e)o(xists)j(only)e(to)h(mak)o(e)f(such)h(e)o(xpression\255generating)
24 b(e)o(xpressions)555 1697 y(more)19 b(readable.)680
1801 y(Macro)h(de\002nitions)h(\(usually\))f(generate)h(lists.)34
b(Although)20 b(macro)h(e)o(xpansions)f(could)555 1906
y(be)31 b(b)n(uilt)g(with)g(the)g(function)e Fs(list)p
FA(,)j(backquote)c(list\255templates)j(mak)o(e)g(the)f(task)i(much)555
2011 y(easier)-5 b(.)28 b(A)15 b(macro)f(de\002ned)g(with)h
Fs(defmacro)d FA(and)i(backquote)f(will)i(super\002cially)f(resemble)
555 2115 y(a)25 b(function)d(de\002ned)h(with)i Fs(defun)p
FA(.)40 b(So)24 b(long)g(as)h(you)e(are)h(not)g(misled)g(by)g(the)g
(similarity)-5 b(,)555 2220 y(backquote)18 b(mak)o(es)i(macro)f
(de\002nitions)h(both)f(easier)h(to)h(write)f(and)g(easier)g(to)g
(read.)680 2324 y(Backquote)h(is)j(so)f(often)g(used)f(in)h(macro)f
(de\002nitions)h(that)g(people)f(sometimes)g(think)555
2429 y(of)17 b(backquote)e(as)i(part)g(of)g Fs(defmacro)p
FA(.)25 b(The)17 b(last)h(thing)e(to)h(remember)f(about)g(backquote)f
(is)555 2534 y(that)g(it)h(has)f(a)h(life)f(of)g(its)h(o)n(wn,)f
(separate)g(from)f(its)i(role)f(in)g(macros.)27 b(Y)-9
b(ou)15 b(can)f(use)i(backquote)555 2638 y(an)o(ywhere)i(sequences)i
(need)f(to)h(be)h(b)n(uilt:)555 2812 y Fs(\(defun)41
b(greet)h(\(name\))642 2912 y(`\(hello)f(,name\)\))555
3163 y Fw(7.3)99 b(De\002ning)26 b(Simple)f(Macr)n(os)555
3354 y FA(In)i(programming,)e(the)i(best)h(w)o(ay)f(to)g(learn)g(is)h
(often)e(to)h(be)o(gin)f(e)o(xperimenting)e(as)k(soon)555
3458 y(as)f(possible.)49 b(A)27 b(full)f(theoretical)g(understanding)d
(can)k(come)f(later)-5 b(.)49 b(Accordingly)-5 b(,)25
b(this)555 3563 y(section)g(presents)f(a)i(w)o(ay)f(to)g(start)h
(writing)e(macros)h(immediately)-5 b(.)42 b(It)25 b(w)o(orks)g(only)f
(for)g(a)555 3667 y(narro)n(w)19 b(range)f(of)i(cases,)g(b)n(ut)g
(where)g(applicable)e(it)j(can)f(be)g(applied)e(quite)i(mechanically)-5
b(.)555 3772 y(\(If)20 b(you')l(v)o(e)e(written)i(macros)f(before,)g
(you)g(may)h(w)o(ant)g(to)g(skip)g(this)h(section.\))680
3877 y(As)c(an)g(e)o(xample,)f(we)h(consider)f(ho)n(w)h(to)g(write)g(a)
g(v)n(ariant)f(of)h(the)g(the)g(b)n(uilt\255in)f(Common)555
3981 y(Lisp)26 b(function)d Fs(member)p FA(.)43 b(By)26
b(def)o(ault)f Fs(member)e FA(uses)j Fs(eql)f FA(to)h(test)g(for)f
(equality)-5 b(.)43 b(If)25 b(you)555 4086 y(w)o(ant)20
b(to)h(test)g(for)e(membership)g(using)g Fs(eq)p FA(,)h(you)f(ha)n(v)o
(e)h(to)g(say)h(so)f(e)o(xplicitly:)555 4260 y Fs(\(member)41
b(x)i(choices)e(:test)g(#'eq\))555 4439 y FA(If)17 b(we)g(did)f(this)h
(a)h(lot,)f(we)g(might)f(w)o(ant)h(to)g(write)g(a)g(v)n(ariant)f(of)h
Fs(member)d FA(which)j(al)o(w)o(ays)g(used)555 4543 y
Fs(eq)p FA(.)29 b(Some)20 b(earlier)g(dialects)g(of)g(Lisp)g(had)g
(such)g(a)g(function,)f(called)h Fs(memq)p FA(:)555 4717
y Fs(\(memq)42 b(x)h(choices\))555 4896 y FA(Ordinarily)12
b(one)i(w)o(ould)f(de\002ne)g Fs(memq)g FA(as)h(an)g(inline)f
(function,)h(b)n(ut)f(for)h(the)f(sak)o(e)h(of)g(e)o(xample)555
5001 y(we)21 b(will)f(reincarnate)f(it)i(as)g(a)f(macro.)p
eop
%%Page: 89 102
89 101 bop 555 538 a Ft(7.3)867 b Fu(DEFINING)19 b(SIMPLE)f(MA)n(CR)n
(OS)850 b FA(89)p 555 745 2678 4 v 553 1370 4 625 v 605
1161 a @beginspecial @setspecial @endspecial 736 888
a Fs(call:)564 b(\(memq)42 b(x)h(choices\))736 1087 y(expansion:)83
b(\(member)40 b(x)j(choices)e(:test)h(#'eq\))1184 1292
y FA(Figure)19 b(7.2:)29 b(Diagram)19 b(used)h(in)h(writing)e
Fs(memq)p FA(.)p 3231 1370 V 555 1373 2678 4 v 680 1597
a(The)f(method:)28 b(Be)o(gin)19 b(with)g(a)h(typical)e(call)i(to)f
(the)h(macro)e(you)g(w)o(ant)h(to)h(de\002ne.)28 b(Write)555
1701 y(it)21 b(do)n(wn)f(on)g(a)h(piece)f(of)g(paper)m(,)f(and)h(belo)n
(w)g(it)h(write)g(do)n(wn)e(the)i(e)o(xpression)e(into)h(which)g(it)555
1806 y(ought)j(to)i(e)o(xpand.)39 b(Figure)24 b(7.2)g(sho)n(ws)g(tw)o
(o)g(such)h(e)o(xpressions.)40 b(From)24 b(the)g(macro)f(call,)555
1911 y(construct)c(the)i(parameter)e(list)i(for)f(your)g(macro,)f
(making)g(up)h(some)g(parameter)f(name)h(for)555 2015
y(each)25 b(of)h(the)f(ar)o(guments.)44 b(In)25 b(this)h(case)g(there)f
(are)h(tw)o(o)g(ar)o(guments,)e(so)i(we')o(ll)g(ha)n(v)o(e)f(tw)o(o)555
2120 y(parameters,)19 b(and)g(call)i(them)f Fs(obj)f
FA(and)h Fs(lst)p FA(:)555 2302 y Fs(\(defmacro)40 b(memq)i(\(obj)g
(lst\))555 2488 y FA(No)n(w)23 b(go)g(back)g(to)g(the)g(tw)o(o)h(e)o
(xpressions)e(you)g(wrote)h(do)n(wn.)37 b(F)o(or)23 b(each)g(ar)o
(gument)e(in)j(the)555 2593 y(macro)h(call,)j(dra)o(w)d(a)i(line)f
(connecting)e(it)j(with)f(the)g(place)g(it)h(appears)e(in)h(the)h(e)o
(xpansion)555 2698 y(belo)n(w)-5 b(.)30 b(In)20 b(Figure)g(7.2)g(there)
g(are)h(tw)o(o)g(parallel)f(lines.)31 b(T)-7 b(o)21 b(write)g(the)f
(body)g(of)g(the)h(macro,)555 2802 y(turn)c(your)f(attention)h(to)g
(the)h(e)o(xpansion.)26 b(Start)18 b(the)g(body)e(with)h(a)h
(backquote.)26 b(No)n(w)-5 b(,)18 b(be)o(gin)555 2907
y(reading)f(the)h(e)o(xpansion)f(e)o(xpression)f(by)i(e)o(xpression.)27
b(Where)n(v)o(er)17 b(you)h(\002nd)g(a)g(parenthesis)555
3011 y(that)24 b(isn')o(t)g(part)g(of)g(an)g(ar)o(gument)e(in)j(the)f
(macro)f(call,)i(put)f(one)g(in)g(the)h(macro)e(de\002nition.)555
3116 y(So)f(follo)n(wing)e(the)h(backquote)e(will)k(be)e(a)h(left)g
(parenthesis.)32 b(F)o(or)21 b(each)g(e)o(xpression)f(in)i(the)555
3221 y(e)o(xpansion)659 3391 y(1.)41 b(If)26 b(there)h(is)h(no)f(line)g
(connecting)e(it)i(with)h(the)f(macro)f(call,)j(then)d(write)i(do)n(wn)
e(the)763 3495 y(e)o(xpression)18 b(itself.)659 3666
y(2.)41 b(If)28 b(there)h(is)h(a)f(connection)e(to)i(one)f(of)h(the)g
(ar)o(guments)e(in)i(the)g(macro)f(call,)j(write)763
3771 y(do)n(wn)20 b(the)i(symbol)f(which)h(occurs)f(in)h(the)g
(corresponding)c(position)k(in)g(the)g(macro)763 3875
y(parameter)c(list,)j(preceded)e(by)g(a)i(comma.)555
4041 y(There)e(is)i(no)f(connection)e(to)j(the)f(\002rst)h(element,)e
Fs(member)p FA(,)f(so)j(we)f(use)h Fs(member)d FA(itself:)555
4206 y Fs(\(defmacro)40 b(memq)i(\(obj)g(lst\))642 4306
y(`\(member)555 4471 y FA(Ho)n(we)n(v)o(er)m(,)16 b Fs(x)i
FA(has)g(a)g(line)f(leading)g(to)h(the)f(\002rst)i(ar)o(gument)c(in)j
(the)f(source)g(e)o(xpression,)f(so)i(we)555 4570 y(use)i(in)h(the)f
(macro)f(body)g(the)h(\002rst)h(parameter)m(,)d(with)j(a)f(comma:)555
4736 y Fs(\(defmacro)40 b(memq)i(\(obj)g(lst\))642 4835
y(`\(member)e(,obj)555 5001 y FA(Continuing)18 b(in)j(this)g(w)o(ay)-5
b(,)19 b(the)h(completed)f(macro)g(de\002nition)g(is:)p
eop
%%Page: 90 103
90 102 bop 555 538 a FA(90)1135 b Fu(MA)n(CR)n(OS)p 555
745 2678 4 v 553 2067 4 1322 v 605 1881 a @beginspecial
@setspecial @endspecial -993 x Fs(\(while)41 b(hungry)692
988 y(\(stare-intently\))692 1087 y(\(meow\))692 1187
y(\(rub-against-leg)o(s\)\))605 1386 y(\(do)h(\(\))779
1486 y(\(\(not)g(hungry\)\))692 1586 y(\(stare-intently\))692
1685 y(\(meow\))692 1785 y(\(rub-against-leg)o(s\)\))1162
1989 y FA(Figure)20 b(7.3:)28 b(Diagram)20 b(used)g(in)g(writing)g
Fs(while)p FA(.)p 3231 2067 V 555 2070 2678 4 v 555 2295
a Fs(\(defmacro)40 b(memq)i(\(obj)g(lst\))642 2394 y(`\(member)e(,obj)i
(,lst)g(:test)g(#'eq\)\))680 2565 y FA(So)27 b(f)o(ar)m(,)h(we)g(can)f
(only)g(write)g(macros)g(which)g(tak)o(e)g(a)h(\002x)o(ed)e(number)g
(of)h(ar)o(guments.)555 2670 y(No)n(w)21 b(suppose)g(we)g(w)o(ant)h(to)
f(write)h(a)g(macro)e Fs(while)p FA(,)g(which)h(will)h(tak)o(e)f(a)h
(test)g(e)o(xpression)555 2774 y(and)f(some)h(body)e(of)i(code,)f(and)h
(loop)f(through)e(the)j(code)f(as)i(long)e(as)i(the)e(test)i(e)o
(xpression)555 2879 y(returns)32 b(true.)65 b(Figure)32
b(7.3)g(contains)g(an)g(e)o(xample)f(of)h(a)h Fs(while)e
FA(loop)h(describing)f(the)555 2984 y(beha)n(vior)19
b(of)h(a)g(cat.)680 3088 y(T)-7 b(o)22 b(write)g(such)g(a)h(macro,)e
(we)i(ha)n(v)o(e)e(to)h(modify)f(our)g(technique)g(slightly)-5
b(.)34 b(As)23 b(before,)555 3193 y(be)o(gin)g(by)i(writing)f(do)n(wn)f
(a)i(sample)g(macro)f(call.)43 b(From)24 b(that,)h(b)n(uild)g(the)f
(parameter)f(list)555 3298 y(of)31 b(the)g(macro,)h(b)n(ut)f(where)f
(you)g(w)o(ant)h(to)g(tak)o(e)g(an)g(inde\002nite)f(number)f(of)i(ar)o
(guments,)555 3402 y(conclude)18 b(with)j(an)f Fs(&rest)f
FA(or)h Fs(&body)e FA(parameter:)555 3585 y Fs(\(defmacro)40
b(while)h(\(test)h(&body)f(body\))555 3772 y FA(No)n(w)23
b(write)g(the)g(desired)f(e)o(xpansion)f(belo)n(w)h(the)h(macro)f
(call,)i(and)e(as)i(before)d(dra)o(w)h(lines)555 3877
y(connecting)29 b(the)h(ar)o(guments)f(in)i(the)f(macro)g(call)h(to)g
(their)f(position)g(in)h(the)g(e)o(xpansion.)555 3982
y(Ho)n(we)n(v)o(er)m(,)20 b(when)h(you)g(ha)n(v)o(e)g(a)h(sequence)f
(of)g(ar)o(guments)f(which)h(are)g(going)g(to)h(be)f(suck)o(ed)555
4086 y(into)h(a)h(single)g Fs(&rest)e FA(or)i Fs(&body)e
FA(parameter)m(,)g(treat)i(them)f(as)h(a)g(group,)f(dra)o(wing)f(a)i
(single)555 4191 y(line)d(for)g(the)g(whole)g(sequence.)28
b(Figure)19 b(7.3)h(sho)n(ws)g(the)g(resulting)g(diagram.)680
4295 y(T)-7 b(o)20 b(write)g(the)f(body)g(of)g(the)h(macro)f
(de\002nition,)g(proceed)f(as)i(before)f(along)g(the)g(e)o(xpan\255)555
4400 y(sion.)29 b(As)21 b(well)g(as)g(the)f(tw)o(o)g(pre)n(vious)f
(rules,)h(we)g(need)g(one)g(more:)659 4588 y(3.)41 b(If)24
b(there)g(is)i(a)f(connection)e(from)h(a)h(series)g(of)f(e)o
(xpressions)g(in)h(the)g(e)o(xpansion)d(to)j(a)763 4692
y(series)k(of)g(the)h(ar)o(guments)d(in)i(the)g(macro)g(call,)i(write)f
(do)n(wn)e(the)h(corresponding)763 4797 y Fs(&rest)18
b FA(or)i Fs(&body)f FA(parameter)m(,)f(preceded)g(by)i(a)h
(comma\255at.)555 4985 y(So)f(the)h(resulting)e(macro)g(de\002nition)g
(will)i(be:)p eop
%%Page: 91 104
91 103 bop 555 538 a Ft(7.4)850 b Fu(TESTING)17 b(MA)n(CR)n(OEXP)-5
b(ANSION)832 b FA(91)555 801 y Fs(\(defmacro)40 b(while)h(\(test)h
(&body)f(body\))642 900 y(`\(do)h(\(\))860 1000 y(\(\(not)g(,test\)\))
773 1100 y(,@body\)\))555 1271 y FA(T)-7 b(o)25 b(b)n(uild)g(a)g(macro)
f(which)g(can)h(ha)n(v)o(e)f(a)h Ft(body)f FA(of)h(e)o(xpressions,)f
(some)h(parameter)e(has)i(to)555 1375 y(act)18 b(as)g(a)g(funnel.)27
b(Here)17 b(multiple)g(ar)o(guments)e(in)j(the)f(macro)g(call)h(are)f
(joined)g(together)f(into)555 1480 y Fs(body)p FA(,)j(and)g(then)h
(brok)o(en)f(up)g(again)h(when)f Fs(body)g FA(is)i(spliced)f(into)g
(the)h(e)o(xpansion.)680 1584 y(The)40 b(approach)e(described)i(in)g
(this)h(section)g(enables)f(us)h(to)g(write)g(the)f(simplest)555
1689 y(macros\227those)c(which)g(merely)h(shuf)n(\003e)f(their)h
(parameters.)79 b(Macros)37 b(can)g(do)g(a)g(lot)555
1794 y(more)30 b(than)h(that.)62 b(Section)30 b(7.7)h(will)g(present)g
(e)o(xamples)f(where)g(e)o(xpansions)g(can')o(t)g(be)555
1898 y(represented)f(as)k(simple)e(backquoted)d(lists,)36
b(and)30 b(to)i(generate)e(them,)j(macros)e(become)555
2003 y(programs)18 b(in)j(their)f(o)n(wn)f(right.)555
2253 y Fw(7.4)99 b(T)-9 b(esting)25 b(Macr)n(oexpansion)555
2443 y FA(Ha)n(ving)20 b(written)h(a)h(macro,)e(ho)n(w)g(do)h(we)h
(test)g(it?)32 b(A)22 b(macro)e(lik)o(e)h Fs(memq)f FA(is)j(simple)e
(enough)555 2548 y(that)g(one)f(can)g(tell)h(just)h(by)e(looking)f(at)i
(it)g(what)g(it)g(will)g(do.)30 b(When)21 b(writing)f(more)g
(compli\255)555 2652 y(cated)f(macros,)g(we)h(ha)n(v)o(e)e(to)i(be)f
(able)h(to)f(check)g(that)g(the)o(y)g(are)g(being)g(e)o(xpanded)e
(correctly)-5 b(.)680 2757 y(Figure)17 b(7.4)g(sho)n(ws)h(a)h(macro)e
(de\002nition)f(and)i(tw)o(o)g(w)o(ays)g(of)g(looking)e(at)j(its)g(e)o
(xpansion.)555 2862 y(The)h(b)n(uilt\255in)h(function)e
Fs(macroexpand)e FA(tak)o(es)k(an)g(e)o(xpression)e(and)h(returns)g
(its)i(macroe)o(x\255)555 2966 y(pansion.)41 b(Sending)24
b(a)h(macro)f(call)h(to)g Fs(macroexpand)20 b FA(sho)n(ws)25
b(ho)n(w)f(the)h(macro)f(call)h(will)555 3071 y(\002nally)g(be)h(e)o
(xpanded)d(before)h(being)h(e)n(v)n(aluated,)g(b)n(ut)h(a)g(complete)f
(e)o(xpansion)e(is)k(not)e(al\255)555 3176 y(w)o(ays)d(what)g(you)f(w)o
(ant)h(in)h(order)d(to)i(test)h(a)g(macro.)33 b(When)22
b(the)g(macro)f(in)h(question)f(relies)555 3280 y(on)j(other)g(macros,)
h(the)o(y)f(too)g(will)h(be)g(e)o(xpanded,)e(so)i(a)g(complete)f
(macroe)o(xpansion)d(can)555 3385 y(sometimes)f(be)g(dif)n(\002cult)g
(to)g(read.)680 3489 y(From)h(the)h(\002rst)g(e)o(xpression)e(sho)n(wn)
h(in)h(Figure)f(7.4,)h(it')-5 b(s)22 b(hard)f(to)h(tell)h(whether)d(or)
i(not)555 3594 y Fs(while)d FA(is)i(e)o(xpanding)c(as)k(intended,)e
(because)g(the)h(b)n(uilt\255in)g Fs(do)g FA(macro)f(gets)h(e)o
(xpanded,)e(as)555 3699 y(well)23 b(as)f(the)h Fs(prog)e
FA(macro)g(into)g(which)h Ft(it)h FA(e)o(xpands.)33 b(What)23
b(we)f(need)f(is)i(a)g(w)o(ay)f(of)g(seeing)555 3803
y(the)29 b(result)g(after)g(only)f(one)g(step)h(of)g(e)o(xpansion.)53
b(This)29 b(is)h(the)f(purpose)f(of)g(the)h(b)n(uilt\255in)555
3908 y(function)19 b Fs(macroexpand-1)p FA(,)c(sho)n(wn)20
b(in)h(the)f(second)g(e)o(xample;)g Fs(macroexpand-1)15
b FA(stops)555 4012 y(after)20 b(just)h(one)e(step,)h(e)n(v)o(en)g(if)g
(the)g(e)o(xpansion)f(is)i(still)g(a)g(macro)e(call.)680
4117 y(When)i(we)i(w)o(ant)f(to)g(look)f(at)h(the)g(e)o(xpansion)e(of)i
(a)g(macro)f(call,)i(it)g(will)f(be)g(a)h(nuisance)555
4222 y(al)o(w)o(ays)e(to)f(ha)n(v)o(e)g(to)g(type)555
4388 y Fs(\(pprint)41 b(\(macroexpand-1)c('\(or)42 b(x)i(y\)\)\))555
4559 y FA(Figure)20 b(7.5)f(de\002nes)h(a)h(ne)n(w)f(macro)f(which)h
(allo)n(ws)g(us)h(to)f(say)g(instead:)555 4725 y Fs(\(mac)42
b(\(or)g(x)h(y\)\))680 4896 y FA(T)-7 b(ypically)31 b(you)g(deb)n(ug)g
(functions)g(by)h(calling)g(them,)i(and)e(macros)g(by)f(e)o(xpanding)
555 5001 y(them.)43 b(But)25 b(since)g(a)g(macro)f(call)i(in)m(v)n(olv)
o(es)d(tw)o(o)i(layers)g(of)g(computation,)e(there)i(are)f(tw)o(o)p
eop
%%Page: 92 105
92 104 bop 555 538 a FA(92)1135 b Fu(MA)n(CR)n(OS)p 555
745 2678 4 v 553 3263 4 2518 v 605 888 a Fs(>)43 b(\(defmacro)d(while)h
(\(test)h(&body)f(body\))779 988 y(`\(do)h(\(\))997 1087
y(\(\(not)g(,test\)\))910 1187 y(,@body\)\))605 1287
y(WHILE)605 1486 y(>)h(\(pprint)e(\(macroexpand)d('\(while)j(\(able\))g
(\(laugh\)\)\)\))605 1685 y(\(BLOCK)g(NIL)692 1785 y(\(LET)h(NIL)779
1884 y(\(TAGBODY)866 1984 y(#:G61)866 2084 y(\(IF)h(\(NOT)f(\(ABLE\)\))
e(\(RETURN)h(NIL\)\))866 2183 y(\(LAUGH\))866 2283 y(\(GO)i
(#:G61\)\)\)\))605 2383 y(T)605 2482 y(>)g(\(pprint)e(\(macroexpand-1)c
('\(while)k(\(able\))g(\(laugh\)\)\)\))605 2681 y(\(DO)h(NIL)779
2781 y(\(\(NOT)g(\(ABLE\)\)\))692 2881 y(\(LAUGH\)\))605
2980 y(T)1058 3185 y FA(Figure)19 b(7.4:)29 b(A)21 b(macro)e(and)h(tw)o
(o)g(depths)g(of)f(e)o(xpansion.)p 3231 3263 V 555 3266
2678 4 v 555 3393 V 553 3918 4 525 v 605 3536 a Fs(\(defmacro)40
b(mac)i(\(expr\))692 3636 y(`\(pprint)e(\(macroexpand-1)e(',expr\)\)\))
1080 3840 y FA(Figure)20 b(7.5:)29 b(A)20 b(macro)g(for)f(testing)h
(macroe)o(xpansion.)p 3231 3918 V 555 3921 2678 4 v 555
4146 a(points)k(where)g(things)f(can)i(go)e(wrong.)41
b(If)24 b(a)h(macro)e(is)i(misbeha)n(ving,)f(most)g(of)g(the)g(time)555
4250 y(you)16 b(will)h(be)f(able)h(to)f(tell)i(what')-5
b(s)17 b(wrong)e(just)i(by)f(looking)f(at)i(the)f(e)o(xpansion.)26
b(Sometimes,)555 4355 y(though,)e(the)h(e)o(xpansion)f(will)h(look)g
(\002ne)g(and)f(you')o(ll)h(w)o(ant)g(to)g(e)n(v)n(aluate)f(it)i(to)f
(see)h(where)555 4459 y(the)21 b(problems)f(arise.)33
b(If)21 b(the)g(e)o(xpansion)f(contains)g(free)h(v)n(ariables,)g(you)f
(may)h(w)o(ant)g(to)h(set)555 4564 y(some)d(v)n(ariables)f(\002rst.)29
b(In)19 b(some)f(systems,)i(you)e(will)h(be)g(able)g(to)g(cop)o(y)e
(the)i(e)o(xpansion)e(and)555 4669 y(paste)22 b(it)g(into)f(the)h
(tople)n(v)o(el,)e(or)h(select)i(it)f(and)f(choose)f
Fs(eval)h FA(from)f(a)i(menu.)33 b(In)21 b(the)g(w)o(orst)555
4773 y(case)d(you)f(can)g(set)i(a)f(v)n(ariable)f(to)g(the)h(list)h
(returned)d(by)h Fs(macroexpand-1)p FA(,)c(then)18 b(call)g
Fs(eval)555 4878 y FA(on)i(it:)p eop
%%Page: 93 106
93 105 bop 555 538 a Ft(7.5)692 b Fu(DESTR)n(UCTURING)17
b(IN)i(P)-5 b(ARAMETER)17 b(LISTS)674 b FA(93)555 801
y Fs(>)43 b(\(setq)f(exp)g(\(macroexpand-1)c('\(memq)j('a)i('\(a)f(b)h
(c\)\)\)\))555 900 y(\(MEMBER)e(\(QUOTE)g(A\))i(\(QUOTE)e(\(A)h(B)i
(C\)\))e(:TEST)f(\(FUNCTION)f(EQ\)\))555 1000 y(>)j(\(eval)f(exp\))555
1100 y(\(A)h(B)g(C\))680 1259 y FA(Finally)-5 b(,)22
b(macroe)o(xpansion)d(is)24 b(more)e(than)h(an)f(aid)h(in)g(deb)n
(ugging,)e(it')-5 b(s)24 b(also)f(a)g(w)o(ay)g(of)555
1364 y(learning)18 b(ho)n(w)h(to)h(write)g(macros.)28
b(Common)18 b(Lisp)i(has)g(o)o(v)o(er)e(a)i(hundred)d(macros)i(b)n
(uilt\255in,)555 1468 y(some)k(of)f(them)h(quite)f(comple)o(x.)36
b(By)23 b(looking)e(at)j(the)e(e)o(xpansions)g(of)g(these)h(macros)f
(you)555 1573 y(will)f(often)e(be)h(able)h(to)f(see)h(ho)n(w)e(the)o(y)
h(were)g(written.)555 1821 y Fw(7.5)99 b(Destructuring)27
b(in)e(P)o(arameter)g(Lists)555 2011 y FA(Destructuring)14
b(is)j(a)g(generalization)d(of)i(the)g(sort)g(of)g(assignment)2447
1981 y Fm(3)2496 2011 y FA(done)f(by)h(function)e(calls.)555
2116 y(If)20 b(you)f(de\002ne)h(a)h(function)d(of)i(se)n(v)o(eral)g(ar)
o(guments)555 2271 y Fs(\(defun)41 b(foo)h(\(x)h(y)g(z\))642
2370 y(\(+)g(x)g(y)g(z\)\))555 2530 y FA(then)20 b(when)f(the)i
(function)d(is)j(called)555 2685 y Fs(\(foo)42 b(1)h(2)g(3\))555
2845 y FA(the)16 b(parameters)e(of)h(the)h(function)e(are)h(assigned)h
(ar)o(guments)d(in)j(the)f(call)i(according)c(to)j(their)555
2949 y(position:)35 b Fs(x)24 b FA(to)g Fs(1)p FA(,)g
Fs(y)g FA(to)f Fs(2)p FA(,)i(and)e Fs(z)g FA(to)h Fs(3)p
FA(.)40 b Ft(Destructuring)22 b FA(describes)h(the)h(situation)f(where)
555 3054 y(this)j(sort)g(of)g(positional)f(assignment)g(is)h(done)f
(for)g(arbitrary)g(list)i(structures,)f(as)g(well)h(as)555
3158 y(\003at)21 b(lists)g(lik)o(e)g Fs(\(x)43 b(y)g(z\))p
FA(.)680 3263 y(The)34 b(Common)f(Lisp)i Fs(destructuring-bin)o(d)29
b FA(macro)34 b(\(ne)n(w)h(in)g Fr(CL)-6 b(TL)p FA(2\))33
b(tak)o(es)i(a)555 3368 y(pattern,)18 b(an)h(ar)o(gument)e(e)n(v)n
(aluating)g(to)i(a)g(list,)h(and)f(a)g(body)f(of)g(e)o(xpressions,)g
(and)g(e)n(v)n(aluates)555 3472 y(the)30 b(e)o(xpressions)f(with)i(the)
f(parameters)f(in)h(the)h(pattern)e(bound)f(to)j(the)f(corresponding)
555 3577 y(elements)20 b(of)g(the)g(list:)555 3732 y
Fs(>)43 b(\(destructuring-bi)o(nd)37 b(\(x)43 b(\(y\))f(.)h(z\))g('\(a)
f(\(b\))h(c)g(d\))729 3831 y(\(list)f(x)h(y)g(z\)\))555
3931 y(\(A)g(B)g(\(C)g(D\)\))555 4091 y FA(This)20 b(ne)n(w)g(operator)
f(and)g(others)h(lik)o(e)h(it)f(form)g(the)g(subject)g(of)g(Chapter)f
(18.)680 4195 y(Destructuring)25 b(is)j(also)f(possible)g(in)g(macro)f
(parameter)f(lists.)51 b(The)27 b(Common)e(Lisp)555 4300
y Fs(defmacro)g FA(allo)n(ws)k(parameter)d(lists)k(to)e(be)g(arbitrary)
e(list)j(structures.)52 b(When)28 b(a)h(macro)555 4404
y(call)24 b(is)g(e)o(xpanded,)e(components)f(of)i(the)h(call)f(will)i
(be)e(assigned)g(to)g(the)h(parameters)e(as)i(if)555
4509 y(by)f Fs(destructuring-bi)o(nd)o FA(.)33 b(The)23
b(b)n(uilt\255in)g Fs(dolist)e FA(macro)i(tak)o(es)g(adv)n(antage)f(of)
h(such)555 4614 y(parameter)c(list)i(destructuring.)27
b(In)20 b(a)g(call)h(lik)o(e:)p 555 4674 1074 4 v 645
4729 a Fl(3)675 4752 y Fr(Destructuring)28 b(is)d(usually)i(seen)g(in)e
(operators)j(which)e(create)i(bindings,)h(rather)e(than)f(do)g
(assignments.)555 4835 y(Ho)n(we)n(v)o(er)m(,)f(conceptually)h
(destructuring)f(is)d(a)g(w)o(ay)h(of)f(assigning)h(v)n(alues,)i(and)d
(w)o(ould)h(w)o(ork)g(just)g(as)f(well)h(for)555 4918
y(e)o(xisting)e(v)n(ariables)h(as)d(for)g(ne)n(w)h(ones.)31
b(That)20 b(is,)f(there)h(is)f(nothing)i(to)f(stop)f(you)h(from)f
(writing)h(a)g(destructuring)555 5001 y Fk(setq)p Fr(.)p
eop
%%Page: 94 107
94 106 bop 555 538 a FA(94)1135 b Fu(MA)n(CR)n(OS)555
801 y Fs(\(dolist)41 b(\(x)h('\(a)h(b)g(c\)\))642 900
y(\(print)e(x\)\))555 1088 y FA(the)21 b(e)o(xpansion)f(function)g
(must)h(pluck)g Fs(x)g FA(and)g Fs('\(a)43 b(b)g(c\))21
b FA(from)f(within)i(the)f(list)i(gi)n(v)o(en)d(as)555
1193 y(the)g(\002rst)h(ar)o(gument.)27 b(That)20 b(can)f(be)h(done)g
(implicitly)f(by)h(gi)n(ving)f Fs(dolist)f FA(the)i(appropriate)555
1297 y(parameter)f(list:)1032 1267 y Fm(4)555 1480 y
Fs(\(defmacro)40 b(our-dolist)f(\(\(var)j(list)g(&optional)e(result\))g
(&body)i(body\))642 1579 y(`\(progn)773 1679 y(\(mapc)f(#'\(lambda)f
(\(,var\))h(,@body\))1034 1779 y(,list\))773 1878 y(\(let)h(\(\(,var)f
(nil\)\))860 1978 y(,result\)\)\))555 2166 y FA(In)18
b(Common)f(Lisp,)i(macros)f(lik)o(e)g Fs(dolist)f FA(usually)h(enclose)
g(within)g(a)h(list)g(the)g(ar)o(guments)555 2270 y(not)30
b(part)f(of)h(the)g(body)-5 b(.)57 b(Because)30 b(it)h(tak)o(es)g(an)f
(optional)e Fs(result)h FA(ar)o(gument,)g Fs(dolist)555
2375 y FA(must)e(enclose)g(its)h(\002rst)g(ar)o(guments)e(in)h(a)h
(distinct)f(list)i(an)o(yw)o(ay)-5 b(.)48 b(But)28 b(e)n(v)o(en)e(if)i
(the)f(e)o(xtra)555 2479 y(list)h(structure)d(were)i(not)f(necessary)-5
b(,)27 b(it)h(w)o(ould)e(mak)o(e)g(calls)h(to)g Fs(dolist)e
FA(easier)i(to)f(read.)555 2584 y(Suppose)g(we)h(w)o(ant)g(to)g
(de\002ne)f(a)h(macro)f Fs(when-bind)p FA(,)f(lik)o(e)i
Fs(when)f FA(e)o(xcept)g(that)h(it)g(binds)555 2689 y(some)f(v)n
(ariable)g(to)g(the)h(v)n(alue)f(returned)e(by)i(the)h(test)g(e)o
(xpression.)46 b(This)27 b(macro)f(may)g(be)555 2793
y(best)21 b(implemented)d(with)i(a)h(nested)f(parameter)e(list:)555
2976 y Fs(\(defmacro)40 b(when-bind)g(\(\(var)h(expr\))h(&body)f
(body\))642 3075 y(`\(let)h(\(\(,var)f(,expr\)\))773
3175 y(\(when)g(,var)860 3275 y(,@body\)\)\))555 3462
y FA(and)20 b(called)g(as)h(follo)n(ws:)555 3645 y Fs(\(when-bind)39
b(\(input)j(\(get-user-input)o(\)\))642 3745 y(\(process)e(input\)\))
555 3932 y FA(instead)20 b(of:)555 4115 y Fs(\(let)42
b(\(\(input)f(\(get-user-input)o(\)\)\))642 4215 y(\(when)h(input)729
4314 y(\(process)f(input\)\)\))555 4502 y FA(Used)35
b(sparingly)-5 b(,)36 b(parameter)e(list)i(destructuring)c(can)j
(result)f(in)h(clearer)g(code.)72 b(At)35 b(a)555 4606
y(minimum,)18 b(it)i(can)g(be)f(used)h(in)g(macros)e(lik)o(e)i
Fs(when-bind)d FA(and)i Fs(dolist)p FA(,)f(which)h(tak)o(e)g(tw)o(o)555
4711 y(or)h(more)f(ar)o(guments)f(follo)n(wed)h(by)h(a)h(body)d(of)i(e)
o(xpressions.)p 555 4782 1074 4 v 645 4837 a Fl(4)675
4861 y Fr(This)e(v)o(ersion)i(is)f(written)h(in)f(this)h(strange)g(w)o
(ay)f(to)h(a)o(v)o(oid)f(using)g(gensyms,)g(which)h(are)f(not)h
(introduced)h(till)555 4944 y(later)l(.)p eop
%%Page: 95 108
95 107 bop 555 538 a Ft(7.6)939 b Fu(A)19 b(MODEL)f(OF)h(MA)n(CR)n(OS)
922 b FA(95)p 555 745 2678 4 v 553 2665 4 1920 v 605
888 a Fs(\(defmacro)40 b(our-expander)e(\(name\))j(`\(get)h(,name)f
('expander\)\))605 1087 y(\(defmacro)f(our-defmacro)e(\(name)k(parms)f
(&body)h(body\))692 1187 y(\(let)g(\(\(g)g(\(gensym\)\)\))779
1287 y(`\(progn)910 1386 y(\(setf)f(\(our-expander)e(',name\))1171
1486 y(#'\(lambda)h(\(,g\))1346 1586 y(\(block)h(,name)1433
1685 y(\(destructuring-b)o(ind)c(,parms)k(\(cdr)h(,g\))1520
1785 y(,@body\)\)\)\))910 1884 y(',name\)\)\))605 2084
y(\(defun)f(our-macroexpand-)o(1)c(\(expr\))692 2183
y(\(if)42 b(\(and)g(\(consp)f(expr\))h(\(our-expander)c(\(car)k
(expr\)\)\))866 2283 y(\(funcall)f(\(our-expander)d(\(car)k(expr\)\))f
(expr\))866 2383 y(expr\)\))1310 2587 y FA(Figure)20
b(7.6:)29 b(A)20 b(sk)o(etch)g(of)g Fs(defmacro)p FA(.)p
3231 2665 V 555 2668 2678 4 v 555 2892 a Fw(7.6)99 b(A)25
b(Model)g(of)g(Macr)n(os)555 3083 y FA(A)13 b(formal)g(description)g
(of)g(wh)o(at)g(m)o(acro)o(s)g(do)f(w)o(o)o(uld)g(b)o(e)h(lon)o(g)f
(and)g(c)o(onf)o(using)o(.)21 b(Experienced)555 3188
y(programmers)k(do)j(not)g(carry)f(such)h(a)h(description)e(in)h(their)
g(heads)g(an)o(yw)o(ay)-5 b(.)52 b(It')-5 b(s)28 b(more)555
3292 y(con)m(v)o(enient)i(to)k(remember)d(what)i Fs(defmacro)d
FA(does)j(by)g(imagining)e(ho)n(w)h(it)i(w)o(ould)f(be)555
3397 y(de\002ned.)680 3501 y(There)d(is)j(a)f(long)e(tradition)h(of)g
(such)g(e)o(xplanations)f(in)h(Lisp.)63 b(The)32 b Ft(Lisp)g(1.5)f(Pr)l
(o\255)555 3606 y(gr)o(ammer')m(s)e(Manual)p FA(,)i(\002rst)g
(published)d(in)j(1962,)f(gi)n(v)o(es)g(for)f(reference)g(a)h
(de\002nition)f(of)57 b Fq(\016)555 3711 y Fs(eval)21
b FA(written)h(in)g(Lisp.)35 b(Since)22 b Fs(defmacro)d
FA(is)k(itself)g(a)g(macro,)e(we)h(can)g(gi)n(v)o(e)g(it)g(the)g(same)
555 3815 y(treatment,)d(as)h(in)g(Figure)f(7.6.)28 b(This)20
b(de\002nition)f(uses)h(se)n(v)o(eral)f(techniques)f(which)h(ha)n(v)o
(en')o(t)555 3920 y(been)h(co)o(v)o(ered)e(yet,)h(so)i(some)f(readers)g
(may)f(w)o(ant)i(to)f(refer)f(to)i(it)g(later)-5 b(.)680
4024 y(The)18 b(de\002nition)f(in)i(Figure)f(7.6)f(gi)n(v)o(es)h(a)h(f)
o(airly)f(accurate)g(impression)g(of)g(what)g(macros)555
4129 y(do,)k(b)n(ut)h(lik)o(e)f(an)o(y)g(sk)o(etch)g(it)h(is)g
(incomplete.)34 b(It)23 b(w)o(ouldn')o(t)d(handle)i(the)g
Fs(&whole)e FA(k)o(e)o(yw)o(ord)555 4234 y(properly)-5
b(.)40 b(And)24 b(what)h Fs(defmacro)c FA(really)k(stores)g(as)g(the)f
Fs(macro-function)c FA(of)k(its)i(\002rst)555 4338 y(ar)o(gument)g(is)i
(a)h(function)d(of)i Ft(two)g FA(ar)o(guments:)43 b(the)28
b(macro)f(call,)j(and)d(the)h(le)o(xical)g(en)m(vi\255)555
4443 y(ronment)c(in)h(which)g(it)i(occurs.)44 b(Ho)n(we)n(v)o(er)m(,)25
b(these)h(features)e(are)i(used)f(only)g(by)g(the)h(most)555
4547 y(esoteric)18 b(macros.)28 b(If)18 b(you)f(w)o(ork)o(ed)g(on)h
(the)g(assumption)f(that)i(macros)e(were)h(implemented)555
4652 y(as)26 b(in)f(Figure)f(7.6,)h(you)g(w)o(ould)f(hardly)f(e)n(v)o
(er)i(go)f(wrong.)42 b(Ev)o(ery)24 b(macro)g(de\002ned)g(in)h(this)555
4757 y(book)19 b(w)o(ould)g(w)o(ork,)h(for)f(e)o(xample.)680
4861 y(The)27 b(de\002nition)f(in)i(Figure)e(7.6)h(yields)h(an)f(e)o
(xpansion)f(function)f(which)i(is)i(a)f(sharp\255)555
4966 y(quoted)15 b(lambda\255e)o(xpression.)24 b(That)16
b(should)f(mak)o(e)h(it)g(a)h(closure:)27 b(an)o(y)15
b(free)h(symbols)f(in)i(the)p eop
%%Page: 96 109
96 108 bop 555 538 a FA(96)1135 b Fu(MA)n(CR)n(OS)555
801 y FA(macro)15 b(de\002nition)g(should)g(refer)h(to)g(v)n(ariables)f
(in)h(the)h(en)m(vironment)c(where)i(the)h Fs(defmacro)555
905 y FA(occurred.)27 b(So)21 b(it)f(should)g(be)g(possible)g(to)g(say)
g(this:)555 1088 y Fs(\(let)42 b(\(\(op)g('setq\)\))642
1188 y(\(defmacro)e(our-setq)g(\(var)i(val\))729 1287
y(\(list)g(op)h(var)f(val\)\)\))555 1475 y FA(As)20 b(of)f
Fr(CL)-6 b(TL)p FA(2,)18 b(it)i(is.)30 b(But)20 b(in)g
Fr(CL)-6 b(TL)p FA(1,)18 b(macro)g(e)o(xpanders)f(were)j(de\002ned)e
(in)h(the)h(null)f(le)o(xical)555 1579 y(en)m(vironment,)996
1549 y Fm(5)1052 1579 y FA(so)25 b(in)g(some)g(old)g(implementations)e
(this)i(de\002nition)f(of)h Fs(our-setq)d FA(will)555
1684 y(not)e(w)o(ork.)555 1937 y Fw(7.7)99 b(Macr)n(os)25
b(as)g(Pr)n(ograms)555 2127 y FA(A)16 b(macro)f(de\002nition)g(need)g
(not)g(be)h(just)g(a)g(backquoted)d(list.)29 b(A)16 b(macro)f(is)i(a)f
(function)e(which)555 2232 y(transforms)27 b(one)g(sort)i(of)f(e)o
(xpression)e(into)i(another)-5 b(.)52 b(This)28 b(function)f(can)h
(call)g Fs(list)f FA(to)555 2337 y(generate)22 b(its)i(result,)f(b)n
(ut)g(can)g(just)g(as)h(well)f(in)m(v)n(ok)o(e)f(a)h(whole)g
(subprogram)d(consisting)i(of)555 2441 y(hundreds)c(of)i(lines)h(of)f
(code.)680 2546 y(Section)e(7.3)h(ga)n(v)o(e)f(an)i(easy)f(w)o(ay)g(of)
g(writing)g(macros.)28 b(Using)20 b(this)f(technique)f(we)i(can)555
2650 y(write)g(macros)e(whose)i(e)o(xpansions)d(contain)i(the)g(same)h
(sube)o(xpressions)d(as)k(appear)d(in)i(the)555 2755
y(macro)26 b(call.)49 b(Unfortunately)-5 b(,)25 b(only)g(the)i
(simplest)g(macros)f(meet)h(this)g(condition.)47 b(As)27
b(a)555 2860 y(more)g(complicated)e(e)o(xample,)j(consider)e(the)i(b)n
(uilt\255in)e(macro)h Fs(do)p FA(.)50 b(It)28 b(isn')o(t)f(possible)g
(to)555 2964 y(write)c Fs(do)g FA(as)h(a)g(macro)e(which)h(simply)g
(shuf)n(\003es)g(its)i(parameters.)37 b(The)23 b(e)o(xpansion)e(has)i
(to)555 3069 y(b)n(uild)d(comple)o(x)e(e)o(xpressions)h(which)h(ne)n(v)
o(er)f(appear)g(in)h(the)g(macro)f(call.)680 3173 y(The)29
b(more)g(general)g(approach)f(to)i(writing)g(macros)f(is)i(to)f(think)g
(about)f(the)h(sort)g(of)555 3278 y(e)o(xpression)20
b(you)h(w)o(ant)h(to)g(be)g(able)g(to)g(use,)g(what)g(you)f(w)o(ant)h
(it)h(to)f(e)o(xpand)e(into,)i(and)f(then)555 3383 y(write)15
b(the)g Ft(pr)l(o)o(gr)o(am)g FA(that)g(will)h(transform)d(the)i
(\002rst)h(form)e(into)h(the)g(second.)27 b(T)m(ry)14
b(e)o(xpanding)555 3487 y(an)i(e)o(xample)e(by)i(hand,)f(then)g(look)g
(at)i(what)f(happens)e(when)h(one)h(form)e(is)j(transformed)d(into)555
3592 y(another)-5 b(.)28 b(By)21 b(w)o(orking)e(from)g(e)o(xamples)g
(you)g(can)h(get)h(an)f(idea)g(of)g(what)g(will)h(be)f(required)555
3696 y(of)g(your)f(proposed)f(macro.)680 3801 y(Figure)24
b(7.7)g(sho)n(ws)h(an)g(instance)f(of)h Fs(do)p FA(,)g(and)g(the)g(e)o
(xpression)e(into)i(which)f(it)i(should)555 3906 y(e)o(xpand.)h(Doing)
18 b(e)o(xpansions)f(by)h(hand)g(is)i(a)f(good)e(w)o(ay)i(to)g(clarify)
f(your)f(ideas)i(about)f(ho)n(w)555 4010 y(a)k(macro)f(should)f(w)o
(ork.)33 b(F)o(or)22 b(e)o(xample,)e(it)i(may)g(not)f(be)g(ob)o(vious)f
(until)i(one)f(tries)h(writing)555 4115 y(the)e(e)o(xpansion)e(that)j
(the)f(local)g(v)n(ariables)f(will)i(ha)n(v)o(e)f(to)g(be)g(updated)f
(using)h Fs(psetq)p FA(.)680 4220 y(The)30 b(b)n(uilt\255in)f(macro)h
Fs(psetq)f FA(\(named)g(for)g(\223parallel)h Fs(setq)p
FA(\224\))f(beha)n(v)o(es)g(lik)o(e)i Fs(setq)p FA(,)555
4324 y(e)o(xcept)19 b(that)h(all)h(its)g(\(e)n(v)o(en\255numbered\))15
b(ar)o(guments)j(will)j(be)f(e)n(v)n(aluated)f(before)f(an)o(y)i(of)g
(the)555 4429 y(assignments)25 b(are)g(made.)44 b(If)25
b(an)h(ordinary)d Fs(setq)h FA(has)i(more)e(than)h(tw)o(o)h(ar)o
(guments,)e(then)555 4533 y(the)c(ne)n(w)g(v)n(alue)g(of)g(the)g
(\002rst)h(ar)o(gument)d(is)j(visible)f(during)e(the)j(e)n(v)n
(aluation)d(of)i(the)g(fourth:)p 555 4605 1074 4 v 645
4661 a Fl(5)675 4684 y Fr(F)o(or)c(an)i(e)o(xample)g(of)f(macro)h
(where)g(this)f(distinction)j(matters,)e(see)g(the)f(note)h(on)f(page)h
(393.)p eop
%%Page: 97 110
97 109 bop 555 538 a Ft(7.7)913 b Fu(MA)n(CR)n(OS)19
b(AS)g(PR)n(OGRAMS)896 b FA(97)p 555 745 2678 4 v 553
2877 4 2133 v 605 888 a Fs(\(do)42 b(\(\(w)h(3\))823
988 y(\(x)g(1)g(\(1+)f(x\)\))823 1087 y(\(y)h(2)g(\(1+)f(y\)\))823
1187 y(\(z\)\))779 1287 y(\(\(>)h(x)g(10\))f(\(princ)f(z\))i(y\))692
1386 y(\(princ)e(x\))692 1486 y(\(princ)g(y\)\))605 1715
y FA(should)19 b(e)o(xpand)f(into)i(something)f(lik)o(e)605
1898 y Fs(\(prog)41 b(\(\(w)i(3\))f(\(x)h(1\))g(\(y)g(2\))f(\(z)h
(nil\)\))736 1997 y(foo)779 2097 y(\(if)g(\(>)f(x)h(10\))954
2197 y(\(return)d(\(progn)h(\(princ)g(z\))i(y\)\)\))779
2296 y(\(princ)e(x\))779 2396 y(\(princ)g(y\))779 2495
y(\(psetq)g(x)i(\(1+)g(x\))g(y)g(\(1+)f(y\)\))736 2595
y(\(go)g(foo\)\))1280 2799 y FA(Figure)19 b(7.7:)29 b(Desired)20
b(e)o(xpansion)e(of)i Fs(do)p FA(.)p 3231 2877 V 555
2881 2678 4 v 555 3092 a Fs(>)43 b(\(let)f(\(\(a)g(1\)\))729
3192 y(\(setq)g(a)h(2)g(b)g(a\))729 3292 y(\(list)f(a)h(b\)\))555
3391 y(\(2)g(2\))555 3558 y FA(Here,)17 b(because)f Fs(a)h
FA(is)g(set)g(\002rst,)h Fs(b)f FA(gets)g(its)g(ne)n(w)g(v)n(alue,)f
Fs(2)p FA(.)28 b(A)17 b Fs(psetq)e FA(is)j(supposed)d(to)i(beha)n(v)o
(e)555 3658 y(as)k(if)f(its)i(ar)o(guments)c(were)i(assigned)f(in)i
(parallel:)555 3811 y Fs(>)43 b(\(let)f(\(\(a)g(1\)\))729
3911 y(\(psetq)f(a)j(2)f(b)g(a\))729 4010 y(\(list)f(a)h(b\)\))555
4110 y(\(2)g(1\))555 4268 y FA(So)29 b(here)e Fs(b)i
FA(gets)f(the)h(old)e(v)n(alue)h(of)g Fs(a)p FA(.)54
b(The)28 b Fs(psetq)e FA(macro)i(is)h(pro)o(vided)d(especially)h(to)555
4373 y(support)13 b(macros)g(lik)o(e)i Fs(do)p FA(,)g(which)e(need)h
(to)g(e)n(v)n(aluate)f(some)h(of)g(their)g(ar)o(guments)e(in)i
(parallel.)555 4478 y(\(Had)20 b(we)g(used)g Fs(setq)p
FA(,)f(we)i(w)o(ould)e(ha)n(v)o(e)h(been)f(de\002ning)g
Fs(do*)h FA(instead.\))680 4582 y(On)26 b(looking)f(at)h(the)h(e)o
(xpansion,)f(it)h(is)g(also)g(clear)f(that)g(we)h(can')o(t)f(really)g
(use)g Fs(foo)g FA(as)555 4687 y(the)h(loop)f(label.)48
b(What)27 b(if)g Fs(foo)f FA(is)i(also)f(used)g(as)g(a)g(loop)f(label)h
(within)f(the)h(body)e(of)i(the)555 4791 y Fs(do)p FA(?)k(Chapter)20
b(9)h(will)h(deal)f(with)g(this)g(problem)e(in)i(detail;)h(for)e(no)n
(w)-5 b(,)20 b(suf)n(\002ce)h(it)g(to)g(say)g(that)555
4896 y(instead)g(of)g(using)f Fs(foo)p FA(,)h(the)g(macroe)o(xpansion)d
(must)j(use)g(a)h(special)f(anon)o(ymous)e(symbol)555
5001 y(returned)f(by)i(the)g(function)f Fs(gensym)p FA(.)p
eop
%%Page: 98 111
98 110 bop 555 538 a FA(98)1135 b Fu(MA)n(CR)n(OS)p 555
745 2678 4 v 553 3362 4 2617 v 605 888 a Fs(\(defmacro)40
b(our-do)h(\(bindforms)e(\(test)j(&rest)f(result\))g(&body)g(body\))692
988 y(\(let)h(\(\(label)f(\(gensym\)\)\))779 1087 y(`\(prog)g
(,\(make-initforms)c(bindforms\))910 1187 y(,label)910
1287 y(\(if)42 b(,test)1084 1386 y(\(return)f(\(progn)g(,@result\)\)\))
910 1486 y(,@body)910 1586 y(\(psetq)g(,@\(make-stepform)o(s)d
(bindforms\)\))910 1685 y(\(go)k(,label\)\)\)\))605 1884
y(\(defun)f(make-initforms)d(\(bindforms\))692 1984 y(\(mapcar)j
(#'\(lambda)f(\(b\))1215 2084 y(\(if)i(\(consp)f(b\))1389
2183 y(\(list)h(\(car)g(b\))h(\(cadr)e(b\)\))1389 2283
y(\(list)h(b)h(nil\)\)\))1041 2383 y(bindforms\)\))605
2582 y(\(defun)e(make-stepforms)d(\(bindforms\))692 2681
y(\(mapcan)j(#'\(lambda)f(\(b\))1215 2781 y(\(if)i(\(and)g(\(consp)f
(b\))i(\(third)e(b\)\))1389 2881 y(\(list)h(\(car)g(b\))h(\(third)e
(b\)\))1389 2980 y(nil\)\))1041 3080 y(bindforms\)\))1399
3284 y FA(Figure)20 b(7.8:)29 b(Implementing)17 b Fs(do)p
FA(.)p 3231 3362 V 555 3366 2678 4 v 680 3590 a(In)29
b(order)f(to)i(write)g Fs(do)p FA(,)h(we)f(consider)f(what)g(it)i(w)o
(ould)e(tak)o(e)g(to)h(transform)e(the)i(\002rst)555
3694 y(e)o(xpression)i(in)i(Figure)f(7.7)g(into)g(the)h(second.)69
b(T)-7 b(o)33 b(perform)f(such)h(a)h(transformation,)555
3799 y(we)e(need)e(to)h(do)g(more)f(than)h(get)g(the)g(macro)f
(parameters)g(into)h(the)g(right)g(positions)f(in)555
3904 y(some)c(backquoted)d(list.)48 b(The)26 b(initial)g
Fs(prog)f FA(has)h(to)h(be)f(follo)n(wed)e(by)i(a)g(list)h(of)f
(symbols)555 4008 y(and)31 b(their)h(initial)h(bindings,)g(which)e
(must)h(be)g(e)o(xtracted)f(from)g(the)h(second)f(ar)o(gument)555
4113 y(passed)24 b(to)g(the)f Fs(do)p FA(.)40 b(The)24
b(function)e Fs(make-initforms)c FA(in)24 b(Figure)f(7.8)h(will)g
(return)f(such)555 4217 y(a)k(list.)49 b(W)-7 b(e)28
b(also)f(ha)n(v)o(e)f(to)h(b)n(uild)f(a)h(list)g(of)g(ar)o(guments)d
(for)i(the)h Fs(psetq)p FA(,)f(b)n(ut)h(this)g(case)g(is)555
4322 y(more)21 b(complicated)g(because)g(not)h(all)g(the)h(symbols)e
(should)g(be)h(updated.)33 b(In)22 b(Figure)f(7.8,)555
4427 y Fs(make-stepforms)h FA(returns)27 b(ar)o(guments)e(for)i(the)h
Fs(psetq)p FA(.)49 b(W)m(ith)28 b(these)g(tw)o(o)f(functions,)555
4531 y(the)20 b(rest)h(of)f(the)g(de\002nition)f(becomes)g(f)o(airly)h
(straightforw)o(ard.)680 4636 y(The)38 b(code)h(in)g(Figure)g(7.8)f
(isn')o(t)h(e)o(xactly)g(the)g(w)o(ay)g Fs(do)g FA(w)o(ould)g(be)g
(written)g(in)g(a)555 4740 y(real)d(implementation.)74
b(T)-7 b(o)36 b(emphasize)f(the)g(computation)f(done)h(during)f(e)o
(xpansion,)555 4845 y Fs(make-initforms)14 b FA(and)20
b Fs(make-stepforms)14 b FA(ha)n(v)o(e)19 b(been)g(brok)o(en)f(out)h
(as)i(separate)e(func\255)555 4950 y(tions.)27 b(In)14
b(the)h(future,)f(such)g(code)g(will)h(usually)f(be)g(left)h(within)f
(the)h Fs(defmacro)c FA(e)o(xpression.)p eop
%%Page: 99 112
99 111 bop 555 538 a Ft(7.8)1048 b Fu(MA)n(CR)n(O)18
b(STYLE)1029 b FA(99)680 801 y(W)m(ith)28 b(the)g(de\002nition)f(of)h
(this)h(macro,)g(we)f(be)o(gin)f(to)i(see)g(what)f(macros)f(can)h(do.)
53 b(A)555 905 y(macro)24 b(has)h(full)g(access)g(to)g(Lisp)h(to)f(b)n
(uild)f(an)h(e)o(xpansion.)41 b(The)25 b(code)f(used)h(to)g(generate)
555 1010 y(the)20 b(e)o(xpansion)e(may)i(be)g(a)h(program)d(in)i(its)h
(o)n(wn)f(right.)555 1263 y Fw(7.8)99 b(Macr)n(o)25 b(Style)555
1453 y FA(Good)i(style)h(means)g(something)e(dif)n(ferent)g(for)i
(macros.)51 b(Style)28 b(matters)g(when)f(code)h(is)555
1558 y(either)22 b(read)f(by)g(people)g(or)h(e)n(v)n(aluated)f(by)g
(Lisp.)35 b(W)m(ith)22 b(macros,)f(both)g(of)h(these)g(acti)n(vities)
555 1662 y(tak)o(e)e(place)g(under)f(slightly)h(unusual)f
(circumstances.)680 1767 y(There)h(are)i(tw)o(o)g(dif)n(ferent)e(kinds)
h(of)h(code)f(associated)g(with)h(a)g(macro)f(de\002nition:)31
b Ft(e)n(x\255)555 1872 y(pander)16 b(code)p FA(,)h(the)h(code)e(used)h
(by)g(the)h(macro)e(to)i(generate)e(its)i(e)o(xpansion,)e(and)h
Ft(e)n(xpansion)555 1976 y(code)p FA(,)22 b(which)h(appears)f(in)h(the)
f(e)o(xpansion)f(itself.)38 b(The)22 b(principles)g(of)g(style)i(are)e
(dif)n(ferent)555 2081 y(for)f(each.)33 b(F)o(or)22 b(programs)e(in)h
(general,)g(to)h(ha)n(v)o(e)f(good)f(style)i(is)h(to)f(be)g(clear)f
(and)g(ef)n(\002cient.)555 2185 y(These)h(principles)g(are)h(bent)f(in)
h(opposite)e(directions)h(by)g(the)h(tw)o(o)g(types)f(of)h(macro)e
(code:)555 2290 y(e)o(xpander)28 b(code)i(can)g(f)o(a)n(v)n(or)g
(clarity)g(o)o(v)o(er)f(ef)n(\002cienc)o(y)-5 b(,)32
b(and)d(e)o(xpansion)g(code)h(can)g(f)o(a)n(v)n(or)555
2395 y(ef)n(\002cienc)o(y)19 b(o)o(v)o(er)g(clarity)-5
b(.)680 2499 y(It')g(s)27 b(in)f(compiled)f(code)h(that)g(ef)n
(\002cienc)o(y)f(counts)h(most,)i(and)d(in)i(compiled)e(code)h(the)555
2604 y(macro)g(calls)h(ha)n(v)o(e)f(already)g(been)g(e)o(xpanded.)46
b(If)27 b(the)f(e)o(xpander)f(code)h(w)o(as)h(ef)n(\002cient,)h(it)555
2708 y(made)18 b(compilation)f(go)i(slightly)f(f)o(aster)m(,)h(b)n(ut)g
(it)h(w)o(on')o(t)d(mak)o(e)i(an)o(y)f(dif)n(ference)f(in)i(ho)n(w)f
(well)555 2813 y(the)f(program)e(runs.)28 b(Since)17
b(the)g(e)o(xpansion)e(of)i(macro)f(calls)i(tends)f(to)g(be)g(only)g(a)
g(small)h(part)555 2918 y(of)27 b(the)f(w)o(ork)h(done)e(by)i(a)g
(compiler)m(,)g(macros)f(which)g(e)o(xpand)f(ef)n(\002ciently)h(can')o
(t)g(usually)555 3022 y(mak)o(e)f(much)g(of)g(a)i(dif)n(ference)c(e)n
(v)o(en)i(in)h(the)f(compilation)f(speed.)46 b(So)26
b(most)f(of)h(the)f(time)555 3127 y(you)17 b(can)h(safely)g(write)g(e)o
(xpander)e(code)h(the)h(w)o(ay)g(you)g(w)o(ould)f(write)h(a)h(quick,)e
(\002rst)i(v)o(ersion)555 3232 y(of)28 b(a)g(program.)49
b(If)28 b(the)g(e)o(xpander)d(code)i(does)h(unnecessary)e(w)o(ork)h(or)
h(conses)f(a)i(lot,)g(so)555 3336 y(what?)35 b(Y)-9 b(our)21
b(time)i(is)g(better)f(spent)g(impro)o(ving)d(other)j(parts)g(of)g(the)
g(program.)33 b(Certainly)555 3441 y(if)e(there')-5 b(s)31
b(a)h(choice)e(between)h(clarity)g(and)f(speed)h(in)g(e)o(xpander)e
(code,)k(clarity)e(should)555 3545 y(pre)n(v)n(ail.)36
b(Macro)23 b(de\002nitions)f(are)h(generally)e(harder)g(to)j(read)e
(than)g(function)g(de\002nitions,)555 3650 y(because)c(the)o(y)f
(contain)h(a)h(mix)f(of)g(e)o(xpressions)f(e)n(v)n(aluated)g(at)i(tw)o
(o)g(dif)n(ferent)e(times.)29 b(If)18 b(this)555 3755
y(confusion)h(can)h(be)g(reduced)f(at)i(the)g(e)o(xpense)e(of)h(ef)n
(\002cienc)o(y)f(in)i(the)g(e)o(xpander)d(code,)i(it')-5
b(s)21 b(a)555 3859 y(bar)o(gain.)680 3964 y(F)o(or)i(e)o(xample,)f
(suppose)h(that)g(we)h(w)o(anted)f(to)g(de\002ne)g(a)h(v)o(ersion)e(of)
h Fs(and)g FA(as)h(a)g(macro.)555 4068 y(Since)30 b Fs(\(and)42
b(a)h(b)g(c\))30 b FA(is)h(equi)n(v)n(alent)d(to)i Fs(\(if)42
b(a)h(\(if)g(b)g(c\)\))p FA(,)31 b(we)f(can)g(write)g
Fs(and)f FA(in)555 4173 y(terms)22 b(of)f Fs(if)g FA(as)h(in)g(the)f
(\002rst)i(de\002nition)d(in)i(Figure)e(7.9.)33 b(According)19
b(to)j(the)f(standards)g(by)555 4278 y(which)h(we)i(judge)e(ordinary)e
(code,)j Fs(our-and)e FA(is)i(badly)f(written.)37 b(The)23
b(e)o(xpander)d(code)j(is)555 4382 y(recursi)n(v)o(e,)h(and)h(on)f
(each)h(recursion)e(\002nds)i(the)g(length)g(of)f(successi)n(v)o(e)h
(cdrs)g(of)f(the)h(same)555 4487 y(list.)k(If)17 b(this)h(code)f(were)g
(going)f(to)h(be)g(e)n(v)n(aluated)f(at)i(runtime,)e(it)i(w)o(ould)f
(be)g(better)g(to)g(de\002ne)555 4591 y(this)22 b(macro)f(as)i(in)f
Fs(our-andb)p FA(,)d(which)j(generates)f(the)h(same)g(e)o(xpansion)e
(with)i(no)f(w)o(asted)555 4696 y(ef)n(fort.)40 b(Ho)n(we)n(v)o(er)m(,)
23 b(as)i(a)g(macro)f(de\002nition)f Fs(our-and)f FA(is)j(just)g(as)g
(good,)e(if)i(not)f(better)-5 b(.)41 b(It)555 4801 y(may)16
b(be)h(inef)n(\002cient)f(in)i(calling)e Fs(length)f
FA(on)i(each)f(recursion,)g(b)n(ut)h(its)h(or)o(ganization)c(sho)n(ws)
555 4905 y(more)i(clearly)g(the)h(w)o(ay)g(in)g(which)g(the)g(e)o
(xpansion)d(depends)i(on)g(the)h(number)e(of)i(conjuncts.)p
eop
%%Page: 100 113
100 112 bop 555 538 a FA(100)1093 b Fu(MA)n(CR)n(OS)p
555 745 2678 4 v 553 2665 4 1920 v 605 888 a Fs(\(defmacro)40
b(our-and)g(\(&rest)h(args\))692 988 y(\(case)h(\(length)e(args\))779
1087 y(\(0)j(t\))779 1187 y(\(1)g(\(car)f(args\)\))779
1287 y(\(t)h(`\(if)f(,\(car)f(args\))1128 1386 y(\(our-and)f(,@\(cdr)h
(args\)\)\)\)\)\))605 1586 y(\(defmacro)f(our-andb)g(\(&rest)h(args\))
692 1685 y(\(if)h(\(null)g(args\))866 1785 y(t)866 1884
y(\(labels)f(\(\(expander)e(\(rest\))1346 1984 y(\(if)j(\(cdr)g(rest\))
1520 2084 y(`\(if)g(,\(car)g(rest\))1738 2183 y(,\(expander)e(\(cdr)h
(rest\)\)\))1520 2283 y(\(car)h(rest\)\)\)\))954 2383
y(\(expander)d(args\)\)\)\))1184 2587 y FA(Figure)19
b(7.9:)29 b(T)-7 b(w)o(o)21 b(macros)e(equi)n(v)n(alent)g(to)h
Fs(and)p FA(.)p 3231 2665 V 555 2668 2678 4 v 680 2892
a(As)28 b(al)o(w)o(ays,)j(there)c(are)h(e)o(xceptions.)51
b(In)28 b(Lisp,)i(the)e(distinction)g(between)f(compile\255)555
2997 y(time)18 b(and)e(runtime)h(is)h(an)f(arti\002cial)h(one,)f(so)h
(an)o(y)f(rule)g(which)g(depends)f(upon)g(it)i(is)g(lik)o(e)n(wise)555
3102 y(arti\002cial.)28 b(In)16 b(some)f(programs,)g(compile\255time)f
(is)j(runtime.)26 b(If)16 b(you')l(re)e(writing)h(a)i(program)555
3206 y(whose)35 b(main)g(purpose)f(is)j(transformation)c(and)i(which)g
(uses)h(macros)e(to)i(do)f(it,)40 b(then)555 3311 y(e)n(v)o(erything)14
b(changes:)26 b(the)16 b(e)o(xpander)e(code)i(becomes)f(your)g
(program,)g(and)g(the)i(e)o(xpansion)555 3415 y(its)23
b(output.)34 b(Of)22 b(course)g(under)e(such)i(circumstances)f(e)o
(xpander)f(code)i(should)f(be)h(written)555 3520 y(with)16
b(ef)n(\002cienc)o(y)f(in)h(mind.)27 b(Ho)n(we)n(v)o(er)m(,)15
b(it')-5 b(s)17 b(safe)f(to)g(say)h(that)f(most)g(e)o(xpander)d(code)j
(\(a\))f(only)555 3625 y(af)n(fects)26 b(the)g(speed)g(of)g
(compilation,)g(and)f(\(b\))h(doesn')o(t)f(af)n(fect)h(it)g(v)o(ery)g
(much\227meaning)555 3729 y(that)20 b(clarity)g(should)f(nearly)h(al)o
(w)o(ays)g(come)g(\002rst.)680 3834 y(W)m(ith)29 b(e)o(xpansion)e
(code,)j(it')-5 b(s)31 b(just)e(the)g(opposite.)55 b(Clarity)30
b(matters)f(less)h(for)f(macro)555 3938 y(e)o(xpansions)e(because)i
(the)o(y)f(are)h(rarely)f(look)o(ed)g(at,)k(especially)c(by)h(other)f
(people.)55 b(The)555 4043 y(forbidden)21 b(goto)i(is)i(not)e(entirely)
g(forbidden)e(in)j(e)o(xpansions,)f(and)g(the)h(disparaged)e
Fs(setq)555 4148 y FA(not)e(quite)g(so)g(disparaged.)680
4252 y(Proponents)e(of)i(structured)f(programming)e(dislik)o(ed)j(goto)
g(for)g(what)g(it)h(did)f(to)h Ft(sour)m(ce)555 4357
y FA(code.)89 b(It)40 b(w)o(as)h(not)f(machine)f(language)g(jump)g
(instructions)g(that)i(the)o(y)e(considered)555 4462
y(harmful\227so)33 b(long)h(as)i(the)o(y)e(were)h(hidden)e(by)i(more)f
(abstract)g(constructs)g(in)h(source)555 4566 y(code.)k(Gotos)23
b(are)h(condemned)d(in)j(Lisp)g(precisely)e(because)h(it')-5
b(s)25 b(so)f(easy)g(to)g(hide)f(them:)555 4671 y(you)e(can)g(use)h
Fs(do)f FA(instead,)g(and)g(if)h(you)f(didn')o(t)f(ha)n(v)o(e)h
Fs(do)p FA(,)g(you)g(could)f(write)i(it.)34 b(Of)22 b(course,)555
4775 y(if)g(we')l(re)f(going)f(to)i(b)n(uild)f(ne)n(w)h(abstractions)e
(on)i(top)f(of)g(goto,)g(the)h(goto)f(is)h(going)e(to)i(ha)n(v)o(e)555
4880 y(to)d(e)o(xist)g(some)n(where.)27 b(Thus)19 b(it)h(is)f(not)g
(necessarily)f(bad)h(style)g(to)g(use)g Fs(go)g FA(in)g(the)g
(de\002nition)555 4985 y(of)h(a)h(ne)n(w)f(macro,)f(if)h(it)h(can')o(t)
e(be)h(written)g(in)h(terms)f(of)g(some)g(e)o(xisting)f(macro.)p
eop
%%Page: 101 114
101 113 bop 555 538 a Ft(7.9)876 b Fu(DEPENDENCE)17 b(ON)i(MA)n(CR)n
(OS)816 b FA(101)680 801 y(Similarly)-5 b(,)17 b Fs(setq)g
FA(is)i(fro)n(wned)d(upon)h(because)g(it)i(mak)o(es)e(it)i(hard)e(to)h
(see)h(where)e(a)i(gi)n(v)o(en)555 905 y(v)n(ariable)27
b(gets)h(its)g(v)n(alue.)51 b(Ho)n(we)n(v)o(er)m(,)28
b(a)g(macroe)o(xpansion)c(is)29 b(not)e(going)f(to)i(be)g(read)f(by)555
1010 y(man)o(y)f(people,)i(so)f(there)g(is)h(usually)f(little)h(harm)e
(in)h(using)g Fs(setq)f FA(on)h(v)n(ariables)f(created)555
1114 y(within)k(the)g(macroe)o(xpansion.)55 b(If)29 b(you)g(look)g(at)i
(e)o(xpansions)d(of)i(some)g(of)f(the)h(b)n(uilt\255in)555
1219 y(macros,)19 b(you')o(ll)h(see)g(quite)g(a)h(lot)f(of)g
Fs(setq)p FA(s.)680 1324 y(Se)n(v)o(eral)e(circumstances)h(can)g(mak)o
(e)h(clarity)f(more)g(important)f(in)i(e)o(xpansion)d(code.)29
b(If)555 1428 y(you')l(re)16 b(writing)h(a)h(complicated)f(macro,)g
(you)g(may)g(end)g(up)h(reading)e(the)i(e)o(xpansions)e(after)555
1533 y(all,)23 b(at)f(least)h(while)f(you')l(re)e(deb)n(ugging)f(it.)35
b(Also,)23 b(in)f(simple)g(macros,)f(only)g(a)i(backquote)555
1638 y(separates)k(e)o(xpander)d(code)i(from)f(e)o(xpansion)g(code,)i
(so)h(if)f(such)f(macros)g(generate)f(ugly)555 1742 y(e)o(xpansions,)k
(the)f(ugliness)h(will)g(be)f(all)h(too)g(visible)f(in)h(your)e(source)
h(code.)54 b(Ho)n(we)n(v)o(er)m(,)555 1847 y(e)n(v)o(en)19
b(when)h(the)g(clarity)h(of)f(e)o(xpansion)e(code)i(becomes)f(an)h
(issue,)h(ef)n(\002cienc)o(y)e(should)g(still)555 1951
y(predominate.)37 b(Ef)n(\002cienc)o(y)22 b(is)j(important)d(in)i(most)
f(runtime)g(code.)39 b(T)-7 b(w)o(o)23 b(things)h(mak)o(e)f(it)555
2056 y(especially)d(so)g(for)g(macro)f(e)o(xpansions:)28
b(their)20 b(ubiquity)e(and)i(their)g(in)m(visibility)-5
b(.)680 2161 y(Macros)20 b(are)h(often)f(used)h(to)g(implement)f
(general\255purpose)d(utilities,)22 b(which)e(are)h(then)555
2265 y(called)33 b(e)n(v)o(erywhere)d(in)j(a)g(program.)65
b(Something)31 b(used)i(so)g(often)f(can')o(t)g(af)n(ford)f(to)i(be)555
2370 y(inef)n(\002cient.)56 b(What)30 b(looks)f(lik)o(e)h(a)f(harmless)
h(little)g(macro)e(could,)j(after)e(the)h(e)o(xpansion)555
2474 y(of)23 b(all)h(the)f(calls)h(to)g(it,)g(amount)e(to)i(a)g
(signi\002cant)e(proportion)f(of)i(your)f(program.)36
b(Such)23 b(a)555 2579 y(macro)14 b(should)h(recei)n(v)o(e)f(more)h
(attention)f(than)h(its)i(length)d(w)o(ould)h(seem)h(to)f(demand.)26
b(A)-6 b(v)n(oid)555 2684 y(consing)15 b(especially)-5
b(.)26 b(A)17 b(utility)e(which)g(conses)h(unnecessarily)e(can)i(ruin)f
(the)g(performance)555 2788 y(of)20 b(an)g(otherwise)g(ef)n(\002cient)f
(program.)680 2893 y(The)i(other)g(reason)g(to)h(look)f(to)i(the)e(ef)n
(\002cienc)o(y)g(of)h(e)o(xpansion)d(code)j(is)h(its)f(v)o(ery)f(in)m
(vis\255)555 2997 y(ibility)-5 b(.)33 b(If)22 b(a)g(function)e(is)i
(badly)f(implemented,)f(it)i(will)h(proclaim)d(this)i(f)o(act)g(to)g
(you)f(e)n(v)o(ery)555 3102 y(time)28 b(you)f(look)g(at)h(its)h
(de\002nition.)51 b(Not)28 b(so)g(with)g(macros.)52 b(From)27
b(a)h(macro)f(de\002nition,)555 3207 y(inef)n(\002cienc)o(y)13
b(in)i(the)g(e)o(xpansion)e(code)h(may)h(not)f(be)h(e)n(vident,)g
(which)f(is)i(all)f(the)g(more)f(reason)555 3311 y(to)20
b(go)g(looking)f(for)g(it.)555 3564 y Fw(7.9)99 b(Dependence)28
b(on)d(Macr)n(os)555 3755 y FA(If)20 b(you)f(rede\002ne)h(a)g
(function,)f(other)g(functions)g(which)h(call)g(it)h(will)g
(automatically)e(get)i(the)555 3859 y(ne)n(w)27 b(v)o(ersion.)985
3829 y Fm(6)1068 3859 y FA(The)h(same)f(doesn')o(t)f(al)o(w)o(ays)i
(hold)f(for)g(macros.)51 b(A)28 b(macro)e(call)i(which)555
3964 y(occurs)c(in)h(a)g(function)e(de\002nition)g(gets)i(replaced)e
(by)h(its)i(e)o(xpansion)d(when)h(the)g(function)555
4068 y(is)j(compiled.)47 b(What)27 b(if)f(we)h(rede\002ne)f(the)g
(macro)f(after)h(the)h(calling)f(function)f(has)h(been)555
4173 y(compiled?)h(Since)17 b(no)f(trace)h(of)f(the)h(original)f(macro)
g(call)h(remains,)g(the)g(e)o(xpansion)e(within)555 4278
y(the)h(function)e(can')o(t)h(be)h(updated.)27 b(The)15
b(beha)n(vior)g(of)h(the)g(function)e(will)j(continue)d(to)j(re\003ect)
555 4382 y(the)j Ft(old)g FA(macro)f(de\002nition:)555
4565 y Fs(>)43 b(\(defmacro)d(mac)i(\(x\))h(`\(1+)f(,x\)\))555
4665 y(MAC)p 555 4801 1074 4 v 645 4857 a Fl(6)675 4880
y Fr(Except)18 b(functions)g(compiled)h(inline,)g(which)f(impose)f(the)
h(same)f(restrictions)j(on)d(rede\002nition)j(as)d(macros.)p
eop
%%Page: 102 115
102 114 bop 555 538 a FA(102)1093 b Fu(MA)n(CR)n(OS)555
801 y Fs(>)43 b(\(setq)f(fn)g(\(compile)f(nil)h('\(lambda)e(\(y\))j
(\(mac)f(y\)\)\)\))555 900 y(#<Compiled-Funct)o(ion)37
b(BF7E7E>)555 1000 y(>)43 b(\(defmacro)d(mac)i(\(x\))h(`\(+)f(,x)h
(100\)\))555 1100 y(MAC)555 1199 y(>)g(\(funcall)d(fn)j(1\))555
1299 y(2)680 1486 y FA(Similar)26 b(problems)g(occur)f(if)j(code)e
(which)g(calls)h(some)g(macro)f(is)i(compiled)d(before)555
1591 y(the)30 b(macro)f(itself)h(is)h(de\002ned.)57 b(C)p
Fr(L)-6 b(TL)p FA(2)28 b(says)j(that)e(\223a)i(macro)d(de\002nition)h
(must)h(be)f(seen)555 1696 y(by)22 b(the)h(compiler)e(before)g(the)h
(\002rst)h(use)g(of)f(the)h(macro.)-6 b(\224)35 b(Implementations)20
b(v)n(ary)h(in)i(ho)n(w)555 1800 y(the)o(y)h(respond)g(to)h(violations)
f(of)g(this)i(rule.)43 b(F)o(ortunately)23 b(it')-5 b(s)26
b(easy)f(to)g(a)n(v)n(oid)g(both)f(types)555 1905 y(of)d(problem.)32
b(If)21 b(you)f(adhere)h(to)g(the)h(follo)n(wing)e(tw)o(o)i
(principles,)e(you)h(need)f(ne)n(v)o(er)h(w)o(orry)555
2009 y(about)e(stale)i(or)f(none)o(xistent)e(macro)i(de\002nitions:)659
2180 y(1.)41 b(De\002ne)20 b(macros)f(before)g(functions)g(\(or)g
(macros\))g(which)h(call)h(them.)659 2352 y(2.)41 b(When)28
b(a)i(macro)e(is)h(rede\002ned,)h(also)f(recompile)e(all)j(the)f
(functions)e(\(or)i(macros\))763 2456 y(which)19 b(call)i
(it\227directly)e(or)h(via)h(other)e(macros.)680 2627
y(It)f(has)g(been)g(suggested)f(that)h(all)h(the)f(macros)f(in)h(a)h
(program)d(be)i(put)g(in)g(a)h(separate)e(\002le,)555
2732 y(to)i(mak)o(e)f(it)i(easier)f(to)g(ensure)f(that)h(macro)f
(de\002nitions)g(are)h(compiled)e(\002rst.)29 b(That')-5
b(s)19 b(taking)555 2836 y(things)j(too)g(f)o(ar)-5 b(.)37
b(It)22 b(w)o(ould)g(be)h(reasonable)e(to)h(put)h(general\255purpose)18
b(macros)k(lik)o(e)h Fs(while)555 2941 y FA(into)j(a)h(separate)e
(\002le,)k(b)n(ut)d(general\255purpose)d(utilities)k(ought)d(to)j(be)f
(separated)f(from)h(the)555 3046 y(rest)21 b(of)f(a)g(program)e(an)o
(yw)o(ay)-5 b(,)18 b(whether)i(the)o(y')l(re)e(functions)h(or)h
(macros.)680 3150 y(Some)25 b(macros)g(are)h(written)g(just)g(for)g
(use)g(in)g(one)f(speci\002c)i(part)e(of)h(a)g(program,)f(and)555
3255 y(these)c(should)f(be)g(de\002ned)g(with)h(the)f(code)g(which)g
(uses)i(them.)30 b(So)21 b(long)f(as)h(the)g(de\002nition)555
3359 y(of)28 b(each)g(macro)g(appears)g(before)f(an)o(y)h(calls)h(to)g
(it,)i(your)c(programs)g(will)i(compile)f(\002ne.)555
3464 y(Collecting)h(together)f(all)h(your)f(macros,)j(simply)e(because)
f(the)o(y')l(re)g(macros,)i(w)o(ould)f(do)555 3569 y(nothing)18
b(b)n(ut)j(mak)o(e)e(your)g(code)h(harder)f(to)h(read.)555
3821 y Fw(7.10)99 b(Macr)n(os)25 b(fr)n(om)g(Functions)555
4012 y FA(This)f(section)g(describes)f(ho)n(w)g(to)h(transform)f
(functions)f(into)i(macros.)39 b(The)24 b(\002rst)g(step)g(in)555
4117 y(translating)g(a)i(function)d(into)i(a)g(macro)f(is)i(to)f(ask)g
(yourself)f(if)h(you)f(really)h(need)f(to)h(do)g(it.)555
4221 y(Couldn')o(t)18 b(you)i(just)g(as)h(well)g(declare)f(the)g
(function)e Fs(inline)h FA(\(p.)g(26\)?)680 4326 y(There)h(are)h(some)g
(le)o(gitimate)g(reasons)g(to)g(consider)f(ho)n(w)h(to)g(translate)g
(functions)f(into)555 4430 y(macros,)30 b(though.)54
b(When)28 b(you)g(be)o(gin)g(writing)g(macros,)i(it)g(sometimes)f
(helps)f(to)h(think)555 4535 y(as)21 b(if)g(you)f(were)h(writing)f(a)h
(function\227an)d(approach)h(that)h(usually)h(yields)f(macros)g(which)
555 4640 y(aren')o(t)i(quite)h(right,)h(b)n(ut)g(which)f(at)h(least)g
(gi)n(v)o(e)f(you)g(something)f(to)i(w)o(ork)f(from.)38
b(Another)555 4744 y(reason)16 b(to)i(look)e(at)i(the)f(relationship)f
(between)g(macros)h(and)g(functions)e(is)j(to)g(see)g(ho)n(w)e(the)o(y)
555 4849 y Ft(dif)o(fer)p FA(.)43 b(Finally)-5 b(,)25
b(Lisp)g(programmers)d(sometimes)j(actually)f(w)o(ant)h(to)g(con)m(v)o
(ert)e(functions)555 4953 y(into)d(macros.)p eop
%%Page: 103 116
103 115 bop 555 538 a Ft(7.10)822 b Fu(MA)n(CR)n(OS)18
b(FR)n(OM)h(FUNCTIONS)804 b FA(103)680 801 y(The)22 b(dif)n(\002culty)g
(of)h(translating)f(a)i(function)d(into)i(a)h(macro)e(depends)f(on)i(a)
h(number)d(of)555 905 y(properties)e(of)h(the)g(function.)27
b(The)20 b(easiest)h(class)g(to)g(translate)f(are)g(the)g(functions)f
(which)659 1073 y(1.)41 b(Ha)n(v)o(e)20 b(a)g(body)f(consisting)g(of)h
(a)h(single)f(e)o(xpression.)659 1236 y(2.)41 b(Ha)n(v)o(e)20
b(a)g(parameter)f(list)i(consisting)f(only)f(of)h(parameter)f(names.)
659 1398 y(3.)41 b(Create)20 b(no)g(ne)n(w)g(v)n(ariables)f(\(e)o
(xcept)g(the)h(parameters\).)659 1561 y(4.)41 b(Are)20
b(not)g(recursi)n(v)o(e)e(\(nor)h(part)h(of)g(a)h(mutually)e(recursi)n
(v)o(e)f(group\).)659 1724 y(5.)41 b(Ha)n(v)o(e)20 b(no)f(parameter)g
(which)h(occurs)f(more)h(than)f(once)h(in)g(the)g(body)-5
b(.)659 1887 y(6.)41 b(Ha)n(v)o(e)27 b(no)g(parameter)e(whose)i(v)n
(alue)g(is)h(used)f(before)f(that)h(of)g(another)f(parameter)763
1992 y(occurring)17 b(before)i(it)i(in)g(the)f(parameter)e(list.)659
2155 y(7.)41 b(Contain)19 b(no)h(free)g(v)n(ariables.)555
2322 y(One)30 b(function)e(which)h(meets)h(these)g(criteria)g(is)h(the)
f(b)n(uilt\255in)f(Common)f(Lisp)i(function)555 2427
y Fs(second)p FA(,)18 b(which)i(returns)f(the)h(second)g(element)f(of)h
(a)h(list.)30 b(It)20 b(could)g(be)g(de\002ned:)555 2589
y Fs(\(defun)41 b(second)g(\(x\))i(\(cadr)e(x\)\))555
2757 y FA(Where)22 b(a)g(function)e(de\002nition)h(meets)h(all)g(the)g
(conditions)e(abo)o(v)o(e,)g(you)h(can)h(easily)g(trans\255)555
2861 y(form)16 b(it)i(into)f(an)g(equi)n(v)n(alent)f(macro)g
(de\002nition.)27 b(Simply)17 b(put)g(a)h(backquote)d(in)i(front)g(of)g
(the)555 2966 y(body)i(and)g(a)i(comma)e(in)i(front)e(of)h(each)f
(symbol)h(which)f(occurs)h(in)g(the)g(parameter)f(list:)555
3128 y Fs(\(defmacro)40 b(second)h(\(x\))h(`\(cadr)f(,x\)\))555
3296 y FA(Of)27 b(course,)g(the)g(macro)f(can')o(t)f(be)i(called)g
(under)e(all)i(the)g(same)g(conditions.)47 b(It)27 b(can')o(t)f(be)555
3400 y(gi)n(v)o(en)d(as)j(the)e(\002rst)i(ar)o(gument)c(to)j
Fs(apply)e FA(or)i Fs(funcall)p FA(,)e(and)h(it)h(should)f(not)g(be)h
(called)f(in)555 3505 y(en)m(vironments)c(where)i(the)h(functions)e(it)
j(calls)f(ha)n(v)o(e)g(ne)n(w)f(local)h(bindings.)35
b(F)o(or)23 b(ordinary)555 3609 y(in\255line)d(calls,)i(though,)d(the)i
(macro)f Fs(second)e FA(should)i(do)h(the)g(same)g(thing)f(as)h(the)g
(function)555 3714 y Fs(second)p FA(.)680 3819 y(The)e(technique)g
(changes)f(slightly)i(when)g(the)g(body)e(has)i(more)f(than)h(one)f(e)o
(xpression,)555 3923 y(because)i(a)h(macro)f(must)h(e)o(xpand)e(into)h
(a)h(single)g(e)o(xpression.)32 b(So)22 b(if)g(condition)e(1)i(doesn')o
(t)555 4028 y(hold,)d(you)g(ha)n(v)o(e)h(to)g(add)g(a)h
Fs(progn)p FA(.)27 b(The)20 b(function)f Fs(noisy-second)p
FA(:)555 4190 y Fs(\(defun)41 b(noisy-second)e(\(x\))642
4290 y(\(princ)i("Someone)g(is)h(taking)f(a)j(cadr!"\))642
4390 y(\(cadr)e(x\)\))555 4552 y FA(could)19 b(be)h(duplicated)f(by)h
(the)g(follo)n(wing)f(macro:)555 4702 y Fs(\(defmacro)40
b(noisy-second)e(\(x\))642 4801 y(`\(progn)773 4901 y(\(princ)j
("Someone)f(is)j(taking)e(a)i(cadr!"\))773 5001 y(\(cadr)e(,x\)\)\))p
eop
%%Page: 104 117
104 116 bop 555 538 a FA(104)1093 b Fu(MA)n(CR)n(OS)680
801 y FA(When)16 b(the)g(function)f(doesn')o(t)g(meet)h(condition)f(2)i
(because)f(it)h(has)f(an)h Fs(&rest)e FA(or)h Fs(&body)555
905 y FA(parameter)m(,)29 b(the)f(rules)h(are)g(the)f(same,)j(e)o
(xcept)d(that)h(the)f(parameter)m(,)h(instead)g(of)f(simply)555
1010 y(ha)n(ving)19 b(a)i(comma)e(before)g(it,)h(must)h(be)f(spliced)g
(into)g(a)g(call)h(to)f Fs(list)p FA(.)28 b(Thus)555
1193 y Fs(\(defun)41 b(sum)h(\(&rest)g(args\))642 1292
y(\(apply)f(#'+)i(args\)\))555 1480 y FA(becomes)555
1662 y Fs(\(defmacro)d(sum)i(\(&rest)f(args\))642 1762
y(`\(apply)g(#'+)h(\(list)g(,@args\)\)\))555 1950 y FA(which)20
b(in)g(this)h(case)f(w)o(ould)g(be)g(better)g(re)n(written:)555
2132 y Fs(\(defmacro)40 b(sum)i(\(&rest)f(args\))642
2232 y(`\(+)i(,@args\)\))680 2420 y FA(When)25 b(condition)f(3)i
(doesn')o(t)f(hold\227when)f(ne)n(w)i(v)n(ariables)f(are)h(created)f
(within)h(the)555 2524 y(function)16 b(body\227the)g(rule)h(about)f
(the)i(insertion)f(of)g(commas)g(must)h(be)f(modi\002ed.)27
b(Instead)555 2629 y(of)i(putting)g(commas)g(before)f(all)i(symbols)f
(in)h(the)g(parameter)e(list,)33 b(we)d(only)f(put)g(them)555
2733 y(before)19 b(those)h(which)f(will)i(refer)f(to)g(the)g
(parameters.)28 b(F)o(or)20 b(e)o(xample,)f(in:)555 2916
y Fs(\(defun)41 b(foo)h(\(x)h(y)g(z\))642 3016 y(\(list)f(x)h(\(let)f
(\(\(x)g(y\)\))1078 3115 y(\(list)g(x)h(z\)\)\)\))555
3303 y FA(neither)25 b(of)h(the)g(last)h(tw)o(o)f(instances)g(of)g
Fs(x)g FA(will)h(refer)e(to)h(the)g(parameter)f Fs(x)p
FA(.)47 b(The)25 b(second)555 3408 y(instance)30 b(is)h(not)e(e)n(v)n
(aluated)g(at)i(all,)i(and)c(the)h(third)g(instance)f(refers)h(to)g(a)h
(ne)n(w)f(v)n(ariable)555 3512 y(established)20 b(by)f(the)i
Fs(let)p FA(.)28 b(So)21 b(only)e(the)h(\002rst)h(instance)f(will)h
(get)f(a)h(comma:)555 3695 y Fs(\(defmacro)40 b(foo)i(\(x)h(y)g(z\))642
3794 y(`\(list)e(,x)i(\(let)f(\(\(x)g(,y\)\))1165 3894
y(\(list)g(x)h(,z\)\)\)\))555 4082 y FA(Functions)25
b(can)g(sometimes)g(be)h(transformed)d(into)j(macros)f(when)g
(conditions)f(4,)i(5)g(and)555 4186 y(6)d(don')o(t)e(hold.)37
b(Ho)n(we)n(v)o(er)m(,)22 b(these)h(topics)g(are)g(treated)g
(separately)f(in)h(later)g(chapters.)37 b(The)555 4291
y(issue)15 b(of)g(recursion)e(in)i(macros)f(is)i(co)o(v)o(ered)c(in)j
(Section)g(10.4,)f(and)g(the)h(dangers)f(of)g(multiple)555
4396 y(and)20 b(misordered)e(e)n(v)n(aluation)g(in)j(Sections)f(10.1)f
(and)h(10.2,)e(respecti)n(v)o(ely)-5 b(.)680 4500 y(As)29
b(for)e(condition)g(7,)j(it)f(is)g(possible)f(to)g(simulate)h(closures)
f(with)g(macros,)h(using)f(a)555 4605 y(technique)c(similar)h(to)g(the)
h(error)e(described)g(on)h(page)f(37.)44 b(But)26 b(seeing)f(as)h(this)
g(is)g(a)g(lo)n(w)555 4709 y(hack,)16 b(not)f(consonant)f(with)i(the)g
(genteel)f(tone)h(of)f(this)i(book,)e(we)h(shall)g(not)f(go)h(into)f
(details.)p eop
%%Page: 105 118
105 117 bop 555 538 a Ft(7.11)958 b Fu(SYMBOL)18 b(MA)n(CR)n(OS)940
b FA(105)555 801 y Fw(7.11)99 b(Symbol)25 b(Macr)n(os)555
991 y FA(C)p Fr(L)-6 b(TL)p FA(2)27 b(introduced)e(a)j(ne)n(w)f(kind)g
(of)g(macro)g(into)g(Common)g(Lisp,)i(the)f(symbol\255macro.)555
1096 y(While)18 b(a)g(normal)e(macro)h(call)g(looks)g(lik)o(e)h(a)g
(function)e(call,)i(a)g(symbol\255macro)c(\223call\224)k(looks)555
1200 y(lik)o(e)i(a)h(symbol.)680 1305 y(Symbol\255macros)d(can)k(only)f
(be)g(locally)g(de\002ned.)32 b(The)22 b Fs(symbol-macrolet)15
b FA(special)555 1410 y(form)k(can,)h(within)g(its)h(body)-5
b(,)18 b(cause)i(a)h(lone)f(symbol)f(to)h(beha)n(v)o(e)f(lik)o(e)i(an)f
(e)o(xpression:)555 1592 y Fs(>)43 b(\(symbol-macrolet)37
b(\(\(hi)42 b(\(progn)f(\(print)g("Howdy"\))1906 1692
y(1\)\)\))729 1792 y(\(+)i(hi)g(2\)\))555 1891 y("Howdy")555
1991 y(3)555 2178 y FA(The)21 b(body)e(of)i(the)g Fs(symbol-macrolet)15
b FA(will)22 b(be)e(e)n(v)n(aluated)g(as)h(if)h(e)n(v)o(ery)d
Fs(hi)i FA(in)g(ar)o(gument)555 2283 y(position)e(had)h(been)f
(replaced)g(with)i Fs(\(progn)41 b(\(print)g("Howdy"\))f(1\))p
FA(.)680 2388 y(Conceptually)-5 b(,)20 b(symbol\255macros)g(are)i(lik)o
(e)h(macros)e(that)h(don')o(t)f(tak)o(e)h(an)o(y)g(ar)o(guments.)555
2492 y(W)m(ith)13 b(no)g(ar)o(guments,)e(macros)i(become)g(simply)g(te)
o(xtual)g(abbre)n(viation)o(s.)22 b(This)13 b(is)g(not)g(to)g(say)555
2597 y(that)k(symbol\255macros)e(are)i(useless,)h(ho)n(we)n(v)o(er)-5
b(.)27 b(The)o(y)16 b(are)h(used)g(in)g(Chapter)g(15)g(\(page)f(205\))
555 2701 y(and)k(Chapter)f(18)h(\(page)f(237\),)g(and)g(in)i(the)f
(latter)g(instance)g(the)o(y)g(are)g(indispensable.)p
eop
%%Page: 106 119
106 118 bop 555 1610 a Fn(8)p 555 1872 2686 3 v 555 2131
a Fx(When)42 b(to)g(Use)e(Macr)m(os)555 2568 y FA(Ho)n(w)17
b(do)f(we)h(kno)n(w)e(whether)h(a)h(gi)n(v)o(en)e(function)g(should)h
(really)g(be)h(a)g(function,)e(rather)h(than)555 2672
y(a)26 b(macro?)45 b(Most)26 b(of)g(the)f(time)h(there)g(is)g(a)g
(clear)g(distinction)f(between)g(the)h(cases)g(which)555
2777 y(call)d(for)f(macros)f(and)h(those)h(which)e(don')o(t.)35
b(By)22 b(def)o(ault)g(we)h(should)e(use)i(functions:)32
b(it)24 b(is)555 2882 y(inele)o(gant)19 b(to)i(use)g(a)g(macro)f(where)
g(a)h(function)e(w)o(ould)h(do.)30 b(W)-7 b(e)22 b(should)d(use)i
(macros)f(only)555 2986 y(where)g(the)o(y)f(bring)g(us)i(some)f
(speci\002c)g(adv)n(antage.)680 3091 y(When)14 b(do)g(macros)g(bring)g
(adv)n(antages?)25 b(That)15 b(is)g(the)g(subject)g(of)f(this)h
(chapter)-5 b(.)27 b(Usually)555 3195 y(the)19 b(question)e(is)j(not)f
(one)f(of)g(adv)n(antage,)f(b)n(ut)i(necessity)-5 b(.)28
b(Most)19 b(of)g(the)g(things)f(we)h(do)f(with)555 3300
y(macros,)24 b(we)f(could)g(not)g(do)g(with)h(functions.)38
b(Section)23 b(8.1)g(lists)i(the)f(kinds)f(of)g(operators)555
3405 y(which)i(can)g(only)f(be)i(implemented)d(as)j(macros.)44
b(Ho)n(we)n(v)o(er)m(,)25 b(there)f(is)j(also)e(a)h(small)g(\(b)n(ut)
-2786 b Fq(\016)555 3509 y FA(interesting\))26 b(class)j(of)e
(borderline)f(cases,)k(in)e(which)f(an)g(operator)f(might)h
(justi\002ably)h(be)555 3614 y(written)33 b(as)i(a)f(function)d(or)j(a)
g(macro.)68 b(F)o(or)33 b(these)h(situations,)i(Section)e(8.2)e(gi)n(v)
o(es)i(the)555 3718 y(ar)o(guments)24 b(for)i(and)g(against)f(macros.)
47 b(Finally)-5 b(,)27 b(ha)n(ving)e(considered)g(what)h(macros)g(are)
555 3823 y(capable)15 b(of)h(doing,)f(we)h(turn)f(in)h(Section)g(8.3)f
(to)h(a)h(related)e(question:)26 b(what)16 b(kinds)f(of)h(things)555
3928 y(do)k(people)f(do)h(with)g(them?)555 4180 y Fw(8.1)99
b(When)26 b(Nothing)f(Else)g(W)n(ill)f(Do)555 4371 y
FA(It')-5 b(s)25 b(a)g(general)e(principle)g(of)h(good)e(design)i(that)
g(if)h(you)e(\002nd)h(similar)g(code)g(appearing)e(at)555
4476 y(se)n(v)o(eral)c(points)g(in)h(a)g(program,)e(you)h(should)g
(write)g(a)i(subroutine)c(and)j(replace)f(the)g(similar)555
4580 y(sequences)k(of)i(code)e(with)i(calls)g(to)f(the)h(subroutine.)36
b(When)23 b(we)h(apply)f(this)g(principle)f(to)555 4685
y(Lisp)g(programs,)d(we)j(ha)n(v)o(e)f(to)h(decide)e(whether)h(the)g
(\223subroutine\224)f(should)g(be)h(a)h(function)555
4789 y(or)e(a)h(macro.)680 4894 y(In)34 b(some)g(cases)i(it')-5
b(s)35 b(easy)g(to)g(decide)f(to)g(write)h(a)g(macro)f(instead)g(of)h
(a)g(function,)555 4999 y(because)16 b(only)f(a)i(macro)e(can)h(do)g
(what')-5 b(s)16 b(needed.)27 b(A)17 b(function)d(lik)o(e)j
Fs(1+)f FA(could)f(concei)n(v)n(ably)1835 5229 y(106)p
eop
%%Page: 107 120
107 119 bop 555 538 a Ft(8.1)806 b Fu(WHEN)19 b(NO)n(THING)g(ELSE)e
(WILL)h(DO)747 b FA(107)555 801 y(be)20 b(written)g(as)h(either)f(a)g
(function)f(or)h(a)g(macro:)555 975 y Fs(\(defun)41 b(1+)i(\(x\))f(\(+)
h(1)g(x\)\))555 1174 y(\(defmacro)d(1+)j(\(x\))f(`\(+)g(1)h(,x\)\))555
1354 y FA(But)21 b Fs(while)p FA(,)d(from)h(Section)h(7.3,)f(could)h
(only)f(be)h(de\002ned)f(as)i(a)g(macro:)555 1528 y Fs(\(defmacro)40
b(while)h(\(test)h(&body)f(body\))642 1628 y(`\(do)h(\(\))860
1728 y(\(\(not)g(,test\)\))773 1827 y(,@body\)\))555
2007 y FA(There)29 b(is)h(no)f(w)o(ay)h(to)f(duplicate)g(the)g(beha)n
(vior)f(of)h(this)h(macro)f(with)h(a)g(function.)55 b(The)555
2111 y(de\002nition)29 b(of)h Fs(while)e FA(splices)j(the)f(e)o
(xpressions)f(passed)h(as)h Fs(body)e FA(into)h(the)g(body)e(of)i(a)555
2216 y Fs(do)p FA(,)g(where)d(the)o(y)g(will)i(be)f(e)n(v)n(aluated)f
(only)g(if)i(the)f Fs(test)f FA(e)o(xpression)f(returns)h
Fs(nil)p FA(.)53 b(No)555 2320 y(function)22 b(could)h(do)g(that;)j(in)
e(a)g(function)e(call,)i(all)h(the)e(ar)o(guments)f(are)i(e)n(v)n
(aluated)e(before)555 2425 y(the)e(function)f(is)i(e)n(v)o(en)e(in)m(v)
n(ok)o(ed.)680 2530 y(When)24 b(you)f(do)h(need)g(a)g(macro,)h(what)f
(do)g(you)f(need)h(from)f(it?)42 b(Macros)24 b(can)g(do)g(tw)o(o)555
2634 y(things)i(that)g(functions)e(can')o(t:)40 b(the)o(y)26
b(can)g(control)e(\(or)i(pre)n(v)o(ent\))e(the)i(e)n(v)n(aluation)e(of)
i(their)555 2739 y(ar)o(guments,)19 b(and)i(the)o(y)g(are)g(e)o
(xpanded)d(right)j(into)g(the)g(calling)g(conte)o(xt.)31
b(An)o(y)21 b(application)555 2844 y(which)f(requires)f(macros)g
(requires,)g(in)i(the)f(end,)f(one)h(or)g(both)f(of)h(these)g
(properties.)680 2948 y(The)35 b(informal)e(e)o(xplanation)g(that)j
(\223macros)e(don')o(t)g(e)n(v)n(aluate)g(their)h(ar)o(guments\224)f
(is)555 3053 y(slightly)17 b(wrong.)27 b(It)17 b(w)o(ould)g(be)g(more)f
(precise)h(to)h(say)f(that)h(macros)e Ft(contr)l(ol)h
FA(the)g(e)n(v)n(aluation)555 3157 y(of)23 b(the)g(ar)o(guments)d(in)k
(the)f(macro)e(call.)38 b(Depending)21 b(on)i(where)f(the)h(ar)o
(gument)d(is)k(placed)555 3262 y(in)i(the)g(macro')-5
b(s)26 b(e)o(xpansion,)f(it)i(could)e(be)h(e)n(v)n(aluated)e(once,)j
(man)o(y)e(times,)i(or)f(not)g(at)g(all.)555 3367 y(Macros)20
b(use)g(this)h(control)e(in)h(four)f(major)h(w)o(ays:)659
3546 y(1.)41 b Ft(T)-5 b(r)o(ansformation.)27 b FA(The)16
b(Common)g(Lisp)h Fs(setf)f FA(macro)g(is)i(one)e(of)h(a)h(class)g(of)e
(macros)763 3651 y(which)i(pick)g(apart)h(their)f(ar)o(guments)f
(before)h(e)n(v)n(aluation.)27 b(A)19 b(b)n(uilt\255in)f(access)i
(func\255)763 3755 y(tion)30 b(will)h(often)f(ha)n(v)o(e)g(a)h(con)m(v)
o(erse)e(whose)h(purpose)f(is)j(to)e(set)i(what)e(the)h(access)763
3860 y(function)24 b(retrie)n(v)o(es.)46 b(The)25 b(con)m(v)o(erse)f
(of)i Fs(car)f FA(is)i Fs(rplaca)p FA(,)f(of)f Fs(cdr)p
FA(,)i Fs(rplacd)p FA(,)e(and)763 3964 y(so)c(on.)29
b(W)m(ith)21 b Fs(setf)f FA(we)h(can)f(use)h(calls)g(to)g(such)f
(access)i(functions)d(as)i(if)g(the)o(y)f(were)763 4069
y(v)n(ariables)25 b(to)i(be)f(set,)j(as)e(in)g Fs(\(setf)41
b(\(car)h(x\))h('a\))p FA(,)27 b(which)f(could)f(e)o(xpand)g(into)763
4174 y Fs(\(progn)41 b(\(rplaca)f(x)k('a\))e('a\))p FA(.)763
4310 y(T)-7 b(o)23 b(perform)e(this)j(trick,)g Fs(setf)e
FA(has)i(to)f(look)g(inside)g(its)i(\002rst)f(ar)o(gument.)36
b(T)-7 b(o)24 b(kno)n(w)763 4414 y(that)19 b(the)h(case)g(abo)o(v)o(e)f
(requires)f Fs(rplaca)p FA(,)g Fs(setf)h FA(must)h(be)f(able)h(to)g
(see)g(that)g(the)g(\002rst)763 4519 y(ar)o(gument)g(is)25
b(an)e(e)o(xpression)e(be)o(ginning)g(with)i Fs(car)p
FA(.)38 b(Thus)23 b Fs(setf)p FA(,)f(and)h(an)o(y)f(other)763
4624 y(operator)c(which)i(transforms)e(its)k(ar)o(guments,)c(must)i(be)
g(written)g(as)h(a)f(macro.)659 4791 y(2.)41 b Ft(Binding)o(.)25
b FA(Le)o(xical)14 b(v)n(ariables)g(must)h(appear)f(directly)g(in)h
(the)g(source)f(code.)26 b(The)15 b(\002rst)763 4896
y(ar)o(gument)j(to)k Fs(setq)e FA(is)i(not)f(e)n(v)n(aluated,)f(for)g
(e)o(xample,)g(so)h(an)o(ything)f(b)n(uilt)h(on)g Fs(setq)763
5001 y FA(must)h(be)h(a)h(macro)d(which)i(e)o(xpands)e(into)i(a)g
Fs(setq)p FA(,)f(rather)g(than)h(a)g(function)e(which)p
eop
%%Page: 108 121
108 120 bop 555 538 a FA(108)879 b Fu(WHEN)19 b(T)o(O)f(USE)h(MA)n(CR)n
(OS)763 801 y FA(calls)i(it.)31 b(Lik)o(e)n(wise)20 b(for)g(operators)f
(lik)o(e)i Fs(let)p FA(,)f(whose)g(ar)o(guments)e(are)j(to)g(appear)e
(as)763 905 y(parameters)i(in)i(a)g Fs(lambda)e FA(e)o(xpression,)h
(for)g(macros)g(lik)o(e)h Fs(do)g FA(which)f(e)o(xpand)f(into)763
1010 y Fs(let)p FA(s,)e(and)g(so)h(on.)29 b(An)o(y)19
b(ne)n(w)g(operator)f(which)i(is)g(to)g(alter)g(the)g(le)o(xical)f
(bindings)g(of)763 1114 y(its)i(ar)o(guments)d(must)i(be)g(written)g
(as)h(a)g(macro.)659 1285 y(3.)41 b Ft(Conditional)22
b(e)o(valuation.)37 b FA(All)25 b(the)e(ar)o(guments)f(to)i(a)g
(function)e(are)i(e)n(v)n(aluated.)38 b(In)763 1390 y(constructs)21
b(lik)o(e)i Fs(when)p FA(,)e(we)i(w)o(ant)f(some)g(ar)o(guments)e(to)j
(be)f(e)n(v)n(aluated)f(only)g(under)763 1495 y(certain)e(conditions.)
28 b(Such)20 b(\003e)o(xibility)f(is)i(only)f(possible)g(with)g
(macros.)659 1666 y(4.)41 b Ft(Multiple)17 b(e)o(valuation.)26
b FA(Not)18 b(only)f(are)g(the)h(ar)o(guments)d(to)j(a)g(function)e
(all)i(e)n(v)n(aluated,)763 1770 y(the)o(y)j(are)g(all)i(e)n(v)n
(aluated)d(e)o(xactly)h(once.)33 b(W)-7 b(e)23 b(need)e(a)h(macro)f(to)
h(de\002ne)f(a)i(construct)763 1875 y(lik)o(e)d Fs(do)p
FA(,)g(where)f(certain)h(ar)o(guments)e(are)i(to)h(be)f(e)n(v)n
(aluated)e(repeatedly)-5 b(.)555 2063 y(There)21 b(are)h(also)g(se)n(v)
o(eral)g(w)o(ays)g(to)g(tak)o(e)g(adv)n(antage)e(of)i(the)g(inline)g(e)
o(xpansion)e(of)h(macros.)555 2167 y(It')-5 b(s)22 b(important)d(to)i
(emphasize)f(that)h(the)g(e)o(xpansions)e(thus)i(appear)f(in)h(the)g
(le)o(xical)g(conte)o(xt)555 2272 y(of)c(the)g(macro)f(call,)i(since)f
(tw)o(o)h(of)f(the)g(three)f(uses)i(for)e(macros)h(depend)e(on)i(that)g
(f)o(act.)29 b(The)o(y)555 2376 y(are:)659 2564 y(5.)41
b Ft(Using)26 b(the)h(calling)e(en)m(vir)l(onment.)47
b FA(A)27 b(macro)f(can)g(generate)f(an)i(e)o(xpansion)d(con\255)763
2669 y(taining)18 b(a)i(v)n(ariable)f(whose)g(binding)f(comes)h(from)g
(the)g(conte)o(xt)g(of)g(the)h(macro)e(call.)763 2773
y(The)h(beha)n(vior)g(of)h(the)g(follo)n(wing)f(macro:)763
2989 y Fs(\(defmacro)39 b(foo)k(\(x\))850 3089 y(`\(+)f(,x)h(y\)\))763
3310 y FA(depends)18 b(on)i(the)g(binding)f(of)h Fs(y)g
FA(where)g Fs(foo)f FA(is)i(called.)763 3447 y(This)g(kind)f(of)h(le)o
(xical)g(intercourse)e(is)j(usually)f(vie)n(wed)f(more)g(as)i(a)f
(source)g(of)f(con\255)763 3552 y(tagion)15 b(than)i(a)g(source)f(of)g
(pleasure.)27 b(Usually)17 b(it)g(w)o(ould)f(be)h(bad)f(style)h(to)g
(write)g(such)763 3657 y(a)24 b(macro.)40 b(The)24 b(ideal)g(of)g
(functional)f(programming)d(applies)k(as)h(well)g(to)f(macros:)763
3761 y(the)e(preferred)e(w)o(ay)j(to)f(communicate)f(with)h(a)h(macro)f
(is)h(through)e(its)i(parameters.)763 3866 y(Indeed,)k(it)g(is)i(so)e
(rarely)f(necessary)h(to)g(use)g(the)h(calling)e(en)m(vironment)e(that)
k(most)763 3970 y(of)23 b(the)g(time)h(it)g(happens,)f(it)h(happens)e
(by)h(mistak)o(e.)39 b(\(See)23 b(Chapter)g(9.\))39 b(Of)24
b(all)g(the)763 4075 y(macros)15 b(in)h(this)g(book,)f(only)g(the)h
(continuation\255passing)c(macros)j(\(Chapter)g(20\))g(and)763
4180 y(some)j(parts)g(of)g(the)g Fr(A)-7 b(TN)18 b FA(compiler)f
(\(Chapter)g(23\))h(use)g(the)g(calling)g(en)m(vironment)d(in)763
4284 y(this)20 b(w)o(ay)-5 b(.)659 4455 y(6.)41 b Ft(Wr)o(apping)27
b(a)j(ne)o(w)f(en)m(vir)l(onment.)55 b FA(A)30 b(macro)e(can)h(also)h
(cause)f(its)h(ar)o(guments)d(to)763 4560 y(be)i(e)n(v)n(aluated)e(in)i
(a)h(ne)n(w)f(le)o(xical)f(en)m(vironment.)53 b(The)29
b(classic)h(e)o(xample)d(is)j Fs(let)p FA(,)763 4665
y(which)d(could)g(be)g(implemented)f(as)i(a)h(macro)d(on)i
Fs(lambda)d FA(\(page)i(144\).)51 b(W)m(ithin)763 4769
y(the)19 b(body)f(of)h(an)g(e)o(xpression)e(lik)o(e)j
Fs(\(let)42 b(\(\(y)g(2\)\))h(\(+)f(x)h(y\)\))p FA(,)19
b Fs(y)g FA(will)h(refer)f(to)g(a)763 4874 y(ne)n(w)h(v)n(ariable.)p
eop
%%Page: 109 122
109 121 bop 555 538 a Ft(8.2)922 b Fu(MA)n(CR)n(O)18
b(OR)h(FUNCTION)p Fv(?)863 b FA(109)659 801 y(7.)41 b
Ft(Saving)31 b(function)h(calls.)69 b FA(The)32 b(third)h(consequence)e
(of)i(the)g(inline)g(insertion)f(of)763 905 y(macroe)o(xpansions)20
b(is)25 b(that)f(in)g(compiled)f(code)g(there)g(is)i(no)f(o)o(v)o
(erhead)d(associated)763 1010 y(with)30 b(a)g(macro)f(call.)60
b(By)30 b(runtime,)i(the)e(macro)f(call)h(has)h(been)e(replaced)g(by)h
(its)763 1114 y(e)o(xpansion.)d(\(The)19 b(same)i(is)g(true)f(in)g
(principle)f(of)h(functions)e(declared)h Fs(inline)p
FA(.\))555 1295 y(Signi\002cantly)-5 b(,)14 b(cases)i(5)f(and)f(6,)i
(when)e(unintentional,)f(constitute)h(the)h(problem)e(of)i(v)n(ariable)
555 1400 y(capture,)26 b(which)g(is)h(probably)d(the)i(w)o(orst)h
(thing)e(a)i(macro)e(writer)h(has)h(to)f(fear)-5 b(.)47
b(V)-9 b(ariable)555 1505 y(capture)19 b(is)i(discussed)f(in)h(Chapter)
e(9.)680 1609 y(Instead)g(of)h(se)n(v)o(en)g(w)o(ays)g(of)g(using)g
(macros,)f(it)i(might)f(be)g(better)g(to)g(say)h(that)f(there)g(are)555
1714 y(six)e(and)f(a)h(half.)27 b(In)18 b(an)f(ideal)g(w)o(orld,)h(all)
g(Common)e(Lisp)h(compilers)g(w)o(ould)f(obe)o(y)g Fs(inline)555
1819 y FA(declarations,)26 b(and)f(sa)n(ving)h(function)e(calls)j(w)o
(ould)e(be)h(a)h(task)f(for)f(inline)h(functions,)g(not)555
1923 y(macros.)i(An)21 b(ideal)f(w)o(orld)f(is)j(left)e(as)h(an)f(e)o
(x)o(ercise)f(to)i(the)f(reader)-5 b(.)555 2175 y Fw(8.2)99
b(Macr)n(o)25 b(or)g(Function?)555 2365 y FA(The)h(pre)n(vious)e
(section)i(dealt)g(with)g(the)g(easy)g(cases.)47 b(An)o(y)25
b(operator)f(that)i(needs)g(access)555 2470 y(to)21 b(its)h(parameters)
d(before)g(the)o(y)h(are)h(e)n(v)n(aluated)e(should)h(be)h(written)f
(as)h(a)h(macro,)d(because)555 2575 y(there)d(is)i(no)e(other)f
(choice.)28 b(What)17 b(about)e(those)i(operators)e(which)h(could)f(be)
i(written)f(either)555 2679 y(w)o(ay?)52 b(Consider)27
b(for)g(e)o(xample)g(the)h(operator)e Fs(avg)p FA(,)i(which)g(returns)f
(the)g(a)n(v)o(erage)g(of)h(its)555 2784 y(ar)o(guments.)f(It)21
b(could)e(be)h(de\002ned)f(as)i(a)g(function)555 2960
y Fs(\(defun)41 b(avg)h(\(&rest)g(args\))642 3059 y(\(/)h(\(apply)e
(#'+)h(args\))g(\(length)f(args\)\)\))555 3240 y FA(b)n(ut)20
b(there)g(is)h(a)g(good)d(case)j(for)f(de\002ning)f(it)h(as)h(a)g
(macro,)555 3416 y Fs(\(defmacro)40 b(avg)i(\(&rest)f(args\))642
3516 y(`\(/)i(\(+)f(,@args\))f(,\(length)f(args\)\)\))555
3697 y FA(because)14 b(the)g(function)f(v)o(ersion)g(w)o(ould)h(entail)
g(an)h(unnecessary)d(call)j(to)g Fs(length)d FA(each)i(time)555
3802 y Fs(avg)21 b FA(w)o(as)i(called.)34 b(At)23 b(compile\255time)d
(we)j(may)e(not)h(kno)n(w)f(the)h(v)n(alues)f(of)h(the)g(ar)o(guments,)
555 3906 y(b)n(ut)g(we)h(do)f(kno)n(w)f(ho)n(w)h(man)o(y)f(there)h
(are,)h(so)f(the)h(call)g(to)f Fs(length)e FA(could)i(just)h(as)g(well)
g(be)555 4011 y(made)d(then.)28 b(Here)20 b(are)g(se)n(v)o(eral)g
(points)g(to)g(consider)f(when)h(we)g(f)o(ace)g(such)g(choices:)1731
4192 y(T)p Fr(HE)g FA(P)p Fr(R)m(OS)659 4373 y FA(1.)41
b Ft(Computation)24 b(at)j(compile\255time)o(.)47 b FA(A)27
b(macro)e(call)i(in)m(v)n(olv)o(es)e(computation)f(at)j(tw)o(o)763
4478 y(times:)34 b(when)22 b(the)h(macro)e(is)j(e)o(xpanded,)c(and)i
(when)g(the)g(e)o(xpansion)f(is)i(e)n(v)n(aluated.)763
4582 y(All)30 b(the)f(macroe)o(xpansion)d(in)k(a)g(Lisp)g(program)d(is)
k(done)e(when)g(the)g(program)f(is)763 4687 y(compiled,)17
b(and)h(e)n(v)o(ery)g(bit)h(of)g(computation)d(which)j(can)f(be)h(done)
f(at)h(compile\255time)763 4791 y(is)34 b(one)g(bit)g(that)g(w)o(on')o
(t)f(slo)n(w)h(the)g(program)e(do)n(wn)g(when)i(it')-5
b(s)35 b(running.)68 b(If)34 b(an)763 4896 y(operator)27
b(could)h(be)g(written)h(to)g(do)g(some)f(of)h(its)h(w)o(ork)e(in)h
(the)g(macroe)o(xpansion)763 5001 y(stage,)18 b(it)h(will)h(be)e(more)g
(ef)n(\002cient)g(to)g(mak)o(e)g(it)h(a)g(macro,)f(because)f(whate)n(v)
o(er)g(w)o(ork)h(a)p eop
%%Page: 110 123
110 122 bop 555 538 a FA(110)879 b Fu(WHEN)19 b(T)o(O)f(USE)h(MA)n(CR)n
(OS)763 801 y FA(smart)j(compiler)e(can')o(t)h(do)h(itself,)h(a)f
(function)f(has)h(to)g(do)g(at)g(runtime.)34 b(Chapter)21
b(13)763 905 y(describes)13 b(macros)f(lik)o(e)i Fs(avg)f
FA(which)g(do)g(some)g(of)g(their)h(w)o(ork)e(during)g(the)i(e)o
(xpansion)763 1010 y(phase.)659 1170 y(2.)41 b Ft(Inte)m(gr)o(ation)22
b(with)k(Lisp.)44 b FA(Sometimes,)25 b(using)g(macros)f(instead)h(of)f
(functions)g(will)763 1274 y(mak)o(e)j(a)i(program)d(more)i(closely)g
(inte)o(grated)e(with)i(Lisp.)54 b(Instead)28 b(of)f(writing)h(a)763
1379 y(program)i(to)j(solv)o(e)f(a)h(certain)f(problem,)h(you)f(may)g
(be)h(able)f(to)h(use)g(macros)e(to)763 1483 y(transform)17
b(the)j(problem)d(into)i(one)g(that)g(Lisp)h(already)e(kno)n(ws)h(ho)n
(w)f(to)i(solv)o(e.)28 b(This)763 1588 y(approach,)11
b(when)i(possible,)g(will)g(usually)g(mak)o(e)g(programs)g(both)g
(smaller)g(and)g(mo)o(re)763 1693 y(ef)n(\002cient:)43
b(smaller)28 b(because)f(Lisp)h(is)g(doing)f(some)g(of)g(your)g(w)o
(ork)g(for)g(you,)h(and)763 1797 y(more)e(ef)n(\002cient)h(because)f
(production)f(Lisp)i(systems)h(generally)e(ha)n(v)o(e)h(had)f(more)763
1902 y(of)20 b(the)g(f)o(at)h(sweated)f(out)g(of)g(them)g(than)g(user)g
(programs.)28 b(This)20 b(adv)n(antage)e(appears)763
2006 y(mostly)g(in)g(embedded)e(languages,)h(which)h(are)h(described)e
(starting)h(in)g(Chapter)g(19.)659 2166 y(3.)41 b Ft(Saving)21
b(function)g(calls.)38 b FA(A)23 b(macro)f(call)h(is)h(e)o(xpanded)c
(right)j(into)f(the)h(code)f(where)763 2271 y(it)g(appears.)32
b(So)21 b(if)h(you)f(write)g(some)g(frequently)f(used)h(piece)g(of)g
(code)g(as)h(a)g(macro,)763 2375 y(you)c(can)g(sa)n(v)o(e)i(a)f
(function)e(call)j(e)n(v)o(ery)e(time)h(it')-5 b(s)20
b(used.)28 b(In)19 b(earlier)g(dialects)g(of)g(Lisp,)763
2480 y(programmers)25 b(took)i(adv)n(antage)g(of)g(this)i(property)d
(of)i(macros)g(to)g(sa)n(v)o(e)g(function)763 2585 y(calls)20
b(at)h(runtime.)28 b(In)20 b(Common)f(Lisp,)h(this)h(job)e(is)i
(supposed)e(to)h(be)h(tak)o(en)e(o)o(v)o(er)g(by)763
2689 y(functions)f(declared)h Fs(inline)p FA(.)763 2821
y(By)24 b(declaring)f(a)h(function)e(to)j(be)f Fs(inline)p
FA(,)f(you)g(ask)h(for)g(it)g(to)h(be)f(compiled)e(right)763
2926 y(into)j(the)h(calling)f(code,)h(just)g(lik)o(e)g(a)g(macro.)45
b(Ho)n(we)n(v)o(er)m(,)25 b(there)g(is)i(a)f(gap)e(between)763
3031 y(theory)j(and)i(practice)f(here;)33 b Fr(CL)-6
b(TL)p FA(2)28 b(\(p.)g(229\))g(says)h(that)g(\223a)g(compiler)f(is)i
(free)e(to)763 3135 y(ignore)17 b(this)i(declaration,)-6
b(\224)18 b(and)g(some)h(Common)e(Lisp)i(compilers)f(do.)28
b(It)19 b(may)f(still)763 3240 y(be)j(reasonable)e(to)j(use)f(macros)g
(to)g(sa)n(v)o(e)g(function)f(calls,)i(if)f(you)g(are)g(compelled)e(to)
763 3344 y(use)h(such)g(a)h(compiler)-5 b(.)680 3504
y(In)27 b(some)g(cases,)j(the)d(combined)f(adv)n(antages)g(of)h(ef)n
(\002cienc)o(y)f(and)h(close)h(inte)o(gration)555 3608
y(with)34 b(Lisp)g(can)g(create)g(a)h(strong)e(ar)o(gument)e(for)j(the)
g(use)g(of)g(macros.)70 b(In)34 b(the)g(query)555 3713
y(compiler)18 b(of)g(Chapter)h(19,)f(the)h(amount)f(of)h(computation)d
(which)j(can)g(be)g(shifted)f(forw)o(ard)555 3818 y(to)35
b(compile\255time)e(is)j(so)g(great)e(that)h(it)h(justi\002es)g
(turning)d(the)i(whole)g(program)d(into)j(a)555 3922
y(single)28 b(giant)g(macro.)53 b(Though)26 b(done)h(for)h(speed,)i
(this)f(shift)f(also)h(brings)e(the)i(program)555 4027
y(closer)20 b(to)h(Lisp:)30 b(in)21 b(the)f(ne)n(w)g(v)o(ersion,)f(it')
-5 b(s)22 b(easier)e(to)h(use)g(Lisp)f(e)o(xpressions\227arithmetic)555
4131 y(e)o(xpressions,)f(for)g(e)o(xample\227within)f(queries.)1723
4291 y(T)p Fr(HE)i FA(C)p Fr(ONS)659 4450 y FA(4.)41
b Ft(Functions)14 b(ar)m(e)j(data,)f FA(while)g(macros)f(are)h(more)g
(lik)o(e)g(instructions)f(to)i(the)f(compiler)-5 b(.)763
4555 y(Functions)14 b(can)g(be)g(passed)g(as)g(ar)o(gu)o(men)o(ts)g
(\(e.g)o(.)g(to)f Fs(app)o(ly)o FA(\),)c(returned)14
b(by)g(functions,)763 4659 y(or)19 b(stored)g(in)i(data)e(structures.)
29 b(None)19 b(of)h(these)g(things)f(are)h(possible)f(with)h(macros.)
763 4791 y(In)13 b(some)h(cases,)i(you)d(can)h(get)h(what)f(you)f(w)o
(ant)h(by)g(enclosing)f(the)h(macro)f(call)i(within)763
4896 y(a)28 b(lambda\255e)o(xpression.)48 b(This)28 b(w)o(orks,)g(for)f
(e)o(xample,)h(if)g(you)f(w)o(ant)h(to)g Fs(apply)e FA(or)763
5001 y Fs(funcall)17 b FA(certain)j(macros:)p eop
%%Page: 111 124
111 123 bop 555 538 a Ft(8.3)847 b Fu(APPLICA)-7 b(TIONS)19
b(FOR)g(MA)n(CR)n(OS)788 b FA(111)763 801 y Fs(>)43 b(\(funcall)d
(#'\(lambda)g(\(x)j(y\))f(\(avg)g(x)h(y\)\))g(1)g(3\))763
900 y(2)763 1082 y FA(Ho)n(we)n(v)o(er)m(,)19 b(this)j(is)g(an)f(incon)
m(v)o(enience.)29 b(It)21 b(doesn')o(t)f(al)o(w)o(ays)i(w)o(ork,)e
(either:)31 b(e)n(v)o(en)21 b(if,)763 1187 y(lik)o(e)26
b Fs(avg)p FA(,)h(the)f(macro)f(has)i(an)f Fs(&rest)f
FA(parameter)m(,)g(there)h(is)h(no)f(w)o(ay)g(to)g(pass)h(it)g(a)763
1292 y(v)n(arying)18 b(number)g(of)i(ar)o(guments.)659
1450 y(5.)41 b Ft(Clarity)28 b(of)f(sour)m(ce)g(code)o(.)50
b FA(Macro)27 b(de\002nitions)f(can)h(be)h(harder)d(to)j(read)f(than)g
(the)763 1554 y(equi)n(v)n(alent)20 b(function)h(de\002nitions.)35
b(So)22 b(if)h(writing)f(something)f(as)i(a)g(macro)e(w)o(ould)763
1659 y(only)e(mak)o(e)h(a)h(program)d(mar)o(ginally)g(better)m(,)h(it)j
(might)d(be)i(better)e(to)i(use)g(a)f(function)763 1763
y(instead.)659 1922 y(6.)41 b Ft(Clarity)23 b(at)f(runtime)o(.)36
b FA(Macros)22 b(are)g(sometimes)g(harder)f(to)i(deb)n(ug)e(than)h
(functions.)763 2026 y(If)h(you)g(get)g(a)h(runtime)f(error)f(in)i
(code)f(which)g(contains)g(a)h(lot)g(of)f(macro)g(calls,)i(the)763
2131 y(code)e(you)h(see)h(in)g(the)f(backtrace)f(could)h(consist)g(of)g
(the)h(e)o(xpansions)e(of)h(all)h(those)763 2235 y(macro)30
b(calls,)35 b(and)30 b(may)h(bear)g(little)h(resemblance)e(to)i(the)f
(code)g(you)f(originally)763 2340 y(wrote.)763 2471 y(And)18
b(because)f(macros)h(disappear)f(when)h(e)o(xpanded,)e(the)o(y)i(are)g
(not)h(accountable)d(at)763 2576 y(runtime.)35 b(Y)-9
b(ou)22 b(can')o(t)g(usually)g(use)h Fs(trace)e FA(to)i(see)g(ho)n(w)g
(a)g(macro)f(is)h(being)f(called.)763 2681 y(If)e(it)g(w)o(ork)o(ed)f
(at)i(all,)f Fs(trace)f FA(w)o(ould)g(sho)n(w)h(you)f(the)i(call)f(to)g
(the)g(macro')-5 b(s)20 b(e)o(xpander)763 2785 y(function,)e(not)i(the)
g(macro)f(call)i(itself.)659 2943 y(7.)41 b Ft(Recur)o(sion.)30
b FA(Using)20 b(recursion)g(in)h(macros)f(is)h(not)g(so)g(simple)g(as)g
(it)h(is)f(in)g(functions.)763 3048 y(Although)11 b(the)j(e)o(xpansion)
d(function)h(of)i(a)g(macro)e(may)h(be)h(recursi)n(v)o(e,)f(the)h(e)o
(xpansion)763 3153 y(itself)h(may)f(not)g(be.)28 b(Section)14
b(10.4)f(deals)i(with)g(the)g(subject)f(of)h(recursion)e(in)h(macros.)
680 3308 y(All)23 b(these)g(considerations)e(ha)n(v)o(e)i(to)g(be)f
(balanced)g(against)g(one)h(another)e(in)i(deciding)555
3412 y(when)c(to)g(use)h(macros.)28 b(Only)19 b(e)o(xperience)f(can)h
(tell)h(which)f(will)h(predominate.)27 b(Ho)n(we)n(v)o(er)m(,)555
3517 y(the)16 b(e)o(xamples)f(of)h(macros)g(which)f(appear)g(in)h
(later)h(chapters)e(co)o(v)o(er)g(most)h(of)g(the)g(situations)555
3622 y(in)23 b(which)f(macros)g(are)h(useful.)36 b(If)23
b(a)g(potential)f(macro)g(is)i(analogous)d(to)i(one)f(gi)n(v)o(en)f
(here,)555 3726 y(then)f(it)h(is)g(probably)d(safe)i(to)g(write)h(it)g
(as)g(such.)680 3831 y(Finally)-5 b(,)21 b(it)i(should)e(be)h(noted)f
(that)h(clarity)g(at)h(runtime)e(\(point)g(6\))g(rarely)h(becomes)f(an)
555 3935 y(issue.)36 b(Deb)n(ugging)21 b(code)g(which)h(uses)h(a)g(lot)
f(of)g(macros)g(will)h(not)f(be)h(as)g(dif)n(\002cult)e(as)i(you)555
4040 y(might)i(e)o(xpect.)44 b(If)25 b(macro)f(de\002nitions)h(were)g
(se)n(v)o(eral)g(hundred)e(lines)j(long,)g(it)g(might)f(be)555
4145 y(unpleasant)20 b(to)h(deb)n(ug)g(their)g(e)o(xpansions)e(at)j
(runtime.)31 b(But)22 b(utilities,)g(at)g(least,)g(tend)f(to)h(be)555
4249 y(written)h(in)g(small,)h(trusted)f(layers.)38 b(Generally)22
b(their)h(de\002nitions)f(are)h(less)i(than)d(15)h(lines)555
4354 y(long.)30 b(So)22 b(e)n(v)o(en)e(if)h(you)f(are)h(reduced)e(to)i
(poring)e(o)o(v)o(er)h(backtraces,)f(such)i(macros)f(will)i(not)555
4459 y(cloud)d(your)g(vie)n(w)h(v)o(ery)f(much.)555 4706
y Fw(8.3)99 b(A)n(pplications)25 b(f)n(or)f(Macr)n(os)555
4896 y FA(Ha)n(ving)k(considered)f(what)h(can)g(be)h(done)e(with)i
(macros,)g(the)g(ne)o(xt)f(question)f(to)i(ask)g(is:)555
5001 y(in)g(what)f(sorts)h(of)g(applications)e(can)i(we)g(use)f(them?)
55 b(The)28 b(closest)h(thing)f(to)h(a)g(general)p eop
%%Page: 112 125
112 124 bop 555 538 a FA(112)879 b Fu(WHEN)19 b(T)o(O)f(USE)h(MA)n(CR)n
(OS)555 801 y FA(description)i(of)i(macro)e(use)i(w)o(ould)f(be)h(to)g
(say)g(that)g(the)o(y)f(are)g(used)h(mainly)f(for)g(syntactic)555
905 y(transformations.)54 b(This)29 b(is)h(not)f(to)g(suggest)g(that)g
(the)g(scope)g(for)g(macros)f(is)i(restricted.)555 1010
y(Since)24 b(Lisp)g(programs)e(are)i(made)f(from)1767
980 y Fm(1)1823 1010 y FA(lists,)j(which)e(are)f(Lisp)h(data)g
(structures,)g(\223syn\255)555 1114 y(tactic)f(transformation\224)d
(can)j(go)f(a)i(long)e(w)o(ay)g(indeed.)36 b(Chapters)23
b(19\22624)e(present)h(whole)555 1219 y(programs)33 b(whose)h(purpose)g
(could)f(be)i(described)f(as)h(syntactic)g(transformation,)g(and)555
1324 y(which)20 b(are,)g(in)g(ef)n(fect,)f(all)i(macro.)680
1428 y(Macro)d(applications)g(form)g(a)i(continuum)d(between)h(small)i
(general\255purpose)15 b(macros)555 1533 y(lik)o(e)g
Fs(while)p FA(,)f(and)g(the)h(lar)o(ge,)g(special\255purpose)d(macros)i
(de\002ned)g(in)g(the)h(later)g(chapters.)27 b(On)555
1638 y(one)19 b(end)g(are)g(the)g Ft(utilities)p FA(,)h(the)g(macros)f
(resembling)e(those)j(that)f(e)n(v)o(ery)f(Lisp)i(has)f(b)n
(uilt\255in.)555 1742 y(The)o(y)g(are)h(usually)f(small,)h(general,)f
(and)g(written)h(in)g(isolation.)29 b(Ho)n(we)n(v)o(er)m(,)18
b(you)h(can)g(write)555 1847 y(utilities)26 b(for)e(speci\002c)h
(classes)h(of)f(programs)e(too,)j(and)e(when)h(you)f(ha)n(v)o(e)g(a)i
(collection)e(of)555 1951 y(macros)19 b(for)g(use)g(in,)h(say)-5
b(,)19 b(graphics)f(programs,)g(the)o(y)h(be)o(gin)f(to)i(look)e(lik)o
(e)i(a)g(programming)555 2056 y(language)c(for)g(graphics.)27
b(At)18 b(the)g(f)o(ar)f(end)g(of)g(the)g(continuum,)e(macros)i(allo)n
(w)g(you)g(to)g(write)555 2161 y(whole)j(programs)e(in)i(a)h(language)e
(distinctly)h(dif)n(ferent)e(from)h(Lisp.)30 b(Macros)20
b(used)g(in)g(this)555 2265 y(w)o(ay)g(are)g(said)h(to)f(implement)f
Ft(embedded)f(langua)o(g)o(es.)680 2370 y FA(Utilities)24
b(are)f(the)g(\002rst)g(of)n(fspring)e(of)i(the)g(bottom\255up)d
(style.)38 b(Ev)o(en)22 b(when)g(a)i(program)555 2474
y(is)g(too)f(small)h(to)f(be)g(b)n(uilt)g(in)h(layers,)f(it)h(may)f
(still)h(bene\002t)f(from)f(additions)g(to)h(the)g(lo)n(west)555
2579 y(layer)m(,)f(Lisp)h(itself.)37 b(The)23 b(utility)f
Fs(nil!)p FA(,)g(which)h(sets)g(its)h(ar)o(gument)c(to)j
Fs(nil)p FA(,)g(could)e(not)i(be)555 2684 y(de\002ned)c(e)o(xcept)g(as)
i(a)g(macro:)555 2871 y Fs(\(defmacro)40 b(nil!)i(\(x\))642
2976 y(`\(setf)f(,x)i(nil\)\))555 3163 y FA(Looking)19
b(at)i Fs(nil!)p FA(,)f(one)g(is)i(tempted)e(to)h(say)g(that)g(it)h
(doesn')o(t)e Ft(do)g FA(an)o(ything,)f(that)i(it)g(merely)555
3268 y(sa)n(v)o(es)35 b(typing.)71 b(T)m(rue,)37 b(b)n(ut)d(all)h(an)o
(y)f(macro)f(does)i(is)g(sa)n(v)o(e)g(typing.)70 b(If)35
b(one)f(w)o(ants)g(to)555 3373 y(think)d(of)h(it)h(in)g(these)f(terms,)
j(the)d(job)g(of)g(a)h(compiler)e(is)i(to)f(sa)n(v)o(e)g(typing)f(in)i
(machine)555 3477 y(language.)26 b(The)17 b(v)n(alue)f(of)h(utilities)g
(should)f(not)g(be)h(underestimated,)e(because)i(their)f(ef)n(fect)555
3582 y(is)24 b(cumulati)n(v)o(e:)34 b(se)n(v)o(eral)22
b(layers)h(of)g(simple)h(macros)e(can)h(mak)o(e)g(the)g(dif)n(ference)e
(between)555 3687 y(an)f(ele)o(gant)f(program)f(and)i(an)g
(incomprehensible)d(one.)680 3791 y(Most)h(utilities)i(are)e(patterns)g
(embodied.)27 b(When)19 b(you)e(notice)h(a)i(pattern)d(in)i(your)f
(code,)555 3896 y(consider)j(turning)g(it)j(into)e(a)h(utility)-5
b(.)36 b(P)o(atterns)22 b(are)g(just)h(the)g(sort)g(of)f(thing)g
(computers)f(are)555 4000 y(good)d(at.)30 b(Why)19 b(should)f(you)h
(bother)f(follo)n(wing)g(them)h(when)g(you)g(could)g(ha)n(v)o(e)g(a)h
(program)555 4105 y(do)k(it)g(for)g(you?)39 b(Suppose)23
b(that)h(in)h(writing)e(some)h(program)e(you)h(\002nd)g(yourself)g
(using)g(in)555 4210 y(man)o(y)c(dif)n(ferent)g(places)h
Fs(do)g FA(loops)f(of)h(the)g(same)h(general)e(form:)555
4397 y Fs(\(do)42 b(\(\))729 4502 y(\(\(not)g Fq(h)p
FA(condition)p Fq(i)p Fs(\)\))642 4606 y(.)87 b Fq(h)p
FA(body)19 b(of)h(code)p Fq(i)p Fs(\))p 555 4691 1074
4 v 645 4746 a Fl(1)675 4769 y Fi(Made)f(fr)m(om,)f Fr(in)h(the)g
(sense)g(that)h(lists)f(are)g(the)h(input)f(to)g(the)g(compiler)l(.)31
b(Functions)20 b(are)f(no)g(longer)g Fi(made)g(of)555
4852 y Fr(lists,)e(as)g(the)o(y)h(used)g(to)f(be)g(in)g(some)g(earlier)
i(dialects.)p eop
%%Page: 113 126
113 125 bop 555 538 a Ft(8.3)847 b Fu(APPLICA)-7 b(TIONS)19
b(FOR)g(MA)n(CR)n(OS)788 b FA(113)555 801 y(When)15 b(you)f(\002nd)h(a)
h(pattern)f(repeated)f(through)f(your)h(code,)h(that)g(pattern)g(often)
f(has)i(a)f(name.)555 905 y(The)j(name)f(of)h(this)h(pattern)e(is)i
Ft(while)p FA(.)29 b(If)18 b(we)g(w)o(ant)h(to)f(pro)o(vide)e(it)j(in)f
(a)h(ne)n(w)e(utility)-5 b(,)18 b(we)h(will)555 1010
y(ha)n(v)o(e)h(to)h(use)g(a)g(macro,)e(because)h(we)h(need)f
(conditional)f(and)h(repeated)f(e)n(v)n(aluation.)29
b(If)20 b(we)555 1114 y(de\002ne)g Fs(while)e FA(using)i(this)h
(de\002nition)e(from)g(page)g(91:)555 1297 y Fs(\(defmacro)40
b(while)h(\(test)h(&body)f(body\))642 1397 y(`\(do)h(\(\))860
1496 y(\(\(not)g(,test\)\))773 1596 y(,@body\)\))555
1784 y FA(then)20 b(we)g(can)g(replace)g(the)g(instances)g(of)g(the)g
(pattern)f(with)555 1971 y Fs(\(while)41 b Fq(h)p FA(condition)p
Fq(i)642 2076 y Fs(.)87 b Fq(h)p FA(body)19 b(of)h(code)p
Fq(i)p Fs(\))555 2297 y FA(Doing)k(so)h(will)h(mak)o(e)f(the)g(code)f
(shorter)g(and)g(also)i(mak)o(e)e(it)i(declare)e(in)h(a)h(clearer)e(v)n
(oice)555 2401 y(what)c(it')-5 b(s)21 b(doing.)680 2506
y(The)k(ability)g(to)g(transform)f(their)h(ar)o(guments)e(mak)o(es)i
(macros)g(useful)g(in)g(writing)g(in\255)555 2611 y(terf)o(aces.)43
b(The)24 b(appropriate)f(macro)h(will)h(mak)o(e)g(it)g(possible)g(to)g
(type)f(a)h(shorter)m(,)g(simpler)555 2715 y(e)o(xpression)i(where)g(a)
i(long)e(or)h(comple)o(x)f(one)g(w)o(ould)h(ha)n(v)o(e)f(been)h
(required.)51 b(Although)555 2820 y(graphic)17 b(interf)o(aces)g
(decrease)h(the)g(need)g(to)g(write)h(such)f(macros)f(for)h(end)g
(users,)g(program\255)555 2924 y(mers)31 b(use)h(this)g(type)f(of)g
(macro)f(as)i(much)f(as)h(e)n(v)o(er)-5 b(.)62 b(The)31
b(most)g(common)f(e)o(xample)g(is)555 3029 y Fs(defun)p
FA(,)16 b(which)i(mak)o(es)f(the)h(binding)e(of)h(functions)g
(resemble,)g(on)g(the)h(surf)o(ace,)f(a)h(function)555
3134 y(de\002nition)h(in)i(a)g(language)e(lik)o(e)i(P)o(ascal)g(or)f
(C.)31 b(Chapter)20 b(2)g(mentioned)f(that)i(the)f(follo)n(wing)555
3238 y(tw)o(o)g(e)o(xpressions)f(ha)n(v)o(e)h(approximately)d(the)k
(same)f(ef)n(fect:)555 3421 y Fs(\(defun)41 b(foo)h(\(x\))h(\(*)g(x)g
(2\)\))555 3620 y(\(setf)f(\(symbol-functio)o(n)37 b('foo\))817
3720 y(#'\(lambda)i(\(x\))k(\(*)f(x)i(2\)\)\))555 3902
y FA(Thus)17 b Fs(defun)e FA(can)i(be)g(implemented)e(as)j(a)f(macro)g
(which)f(turns)h(the)g(former)e(into)i(the)g(latter)-5
b(.)555 4002 y(W)e(e)21 b(could)f(imagine)f(it)i(written)f(as)h(follo)n
(ws:)1862 3972 y Fm(2)555 4168 y Fs(\(defmacro)40 b(our-defun)g(\(name)
h(parms)h(&body)f(body\))642 4268 y(`\(progn)773 4367
y(\(setf)g(\(symbol-function)c(',name\))1034 4467 y(#'\(lambda)j
(,parms)h(\(block)h(,name)f(,@body\)\)\))773 4567 y(',name\)\))680
4738 y FA(Macros)21 b(lik)o(e)g Fs(while)f FA(and)h Fs(nil!)g
FA(could)f(be)i(described)e(as)i(general\255purpose)c(utilities.)555
4842 y(An)o(y)f(Lisp)h(program)e(might)i(use)g(them.)28
b(But)18 b(particular)f(domains)g(can)h(ha)n(v)o(e)f(their)h(utilities)
p 555 4913 1074 4 v 645 4970 a Fl(2)675 4993 y Fr(F)o(or)e(clarity)l(,)
j(this)f(v)o(ersion)g(ignores)g(all)g(the)g(bookk)o(eeping)i(that)e
Fk(defun)g Fr(must)f(perform.)p eop
%%Page: 114 127
114 126 bop 555 538 a FA(114)879 b Fu(WHEN)19 b(T)o(O)f(USE)h(MA)n(CR)n
(OS)p 555 745 2678 4 v 553 2765 4 2020 v 605 888 a Fs(\(defun)41
b(move-objs)f(\(objs)h(dx)i(dy\))692 988 y(\(multiple-value-)o(bin)o(d)
37 b(\(x0)43 b(y0)f(x1)h(y1\))g(\(bounds)d(objs\))779
1087 y(\(dolist)h(\(o)i(objs\))866 1187 y(\(incf)f(\(obj-x)f(o\))i
(dx\))866 1287 y(\(incf)f(\(obj-y)f(o\))i(dy\)\))779
1386 y(\(multiple-value-b)o(in)o(d)37 b(\(xa)43 b(ya)g(xb)f(yb\))h
(\(bounds)d(objs\))866 1486 y(\(redraw)h(\(min)h(x0)h(xa\))f(\(min)g
(y0)h(ya\))1215 1586 y(\(max)f(x1)h(xb\))f(\(max)g(y1)h(yb\)\)\)\)\))
605 1785 y(\(defun)e(scale-objs)e(\(objs)j(factor\))692
1884 y(\(multiple-value-)o(bin)o(d)37 b(\(x0)43 b(y0)f(x1)h(y1\))g
(\(bounds)d(objs\))779 1984 y(\(dolist)h(\(o)i(objs\))866
2084 y(\(setf)f(\(obj-dx)f(o\))h(\(*)h(\(obj-dx)e(o\))i(factor\))1128
2183 y(\(obj-dy)e(o\))h(\(*)h(\(obj-dy)e(o\))i(factor\)\)\))779
2283 y(\(multiple-value-b)o(in)o(d)37 b(\(xa)43 b(ya)g(xb)f(yb\))h
(\(bounds)d(objs\))866 2383 y(\(redraw)h(\(min)h(x0)h(xa\))f(\(min)g
(y0)h(ya\))1215 2482 y(\(max)f(x1)h(xb\))f(\(max)g(y1)h(yb\)\)\)\)\))
1283 2686 y FA(Figure)19 b(8.1:)29 b(Original)19 b(mo)o(v)o(e)g(and)h
(scale.)p 3231 2765 V 555 2768 2678 4 v 555 2992 a(as)26
b(well.)43 b(There)25 b(is)g(no)g(reason)f(to)h(suppose)f(that)h(base)g
(Lisp)g(is)h(the)f(only)f(le)n(v)o(el)h(at)g(which)555
3097 y(you)f(ha)n(v)o(e)h(a)g(programming)d(language)h(to)i(e)o(xtend.)
42 b(If)25 b(you')l(re)e(writing)i(a)g Fr(CAD)h FA(program,)555
3201 y(for)18 b(e)o(xample,)f(the)i(best)f(results)h(will)h(sometimes)e
(come)g(from)f(writing)h(it)h(in)g(tw)o(o)g(layers:)28
b(a)555 3306 y(language)21 b(\(or)g(if)i(you)f(prefer)f(a)h(more)g
(modest)g(term,)g(a)h(toolkit\))e(for)h Fr(CAD)h FA(programs,)e(and)555
3410 y(in)f(the)h(layer)e(abo)o(v)o(e,)g(your)f(particular)h
(application.)680 3515 y(Lisp)35 b(blurs)h(man)o(y)e(distinctions)h
(which)g(other)g(languages)f(tak)o(e)i(for)f(granted.)74
b(In)555 3620 y(other)29 b(languages,)h(there)f(really)g(are)h
(conceptual)d(distinctions)i(between)g(compile\255time)555
3724 y(and)17 b(runtime,)g(program)e(and)j(data,)f(language)f(and)i
(program.)26 b(In)17 b(Lisp,)h(these)g(distinctions)555
3829 y(e)o(xist)k(only)g(as)h(con)m(v)o(ersational)d(con)m(v)o
(entions.)32 b(There)22 b(is)h(no)f(line)h(di)n(viding,)e(for)g(e)o
(xample,)555 3933 y(language)31 b(and)g(program.)64 b(Y)-9
b(ou)31 b(can)h(dra)o(w)g(the)g(line)h(where)n(v)o(er)d(suits)j(the)f
(problem)f(at)555 4038 y(hand.)43 b(So)25 b(it)h(really)f(is)h(no)f
(more)f(than)h(a)g(question)f(of)h(terminology)e(whether)h(to)h(call)h
(an)555 4143 y(underlying)c(layer)j(of)f(code)g(a)i(toolkit)e(or)h(a)g
(language.)41 b(One)25 b(adv)n(antage)e(of)i(considering)555
4247 y(it)f(as)g(a)f(language)f(is)i(that)f(it)h(suggests)f(you)f(can)h
(e)o(xtend)f(this)i(language,)e(as)i(you)e(do)h(Lisp,)555
4352 y(with)d(utilities.)680 4457 y(Suppose)25 b(we)i(are)f(writing)g
(an)g(interacti)n(v)o(e)f(2)p Fr(D)i FA(dra)o(wing)e(program.)45
b(F)o(or)26 b(simplicity)-5 b(,)555 4561 y(we)25 b(will)g(assume)f
(that)g(the)h(only)e(objects)h(handled)f(by)h(the)g(program)e(are)i
(line)g(se)o(gments,)555 4666 y(represented)29 b(as)j(an)e(origin)g
Fq(h)p Ft(x,y)p Fq(i)i FA(and)e(a)h(v)o(ector)f Fq(h)p
Ft(dx,dy)p Fq(i)p FA(.)61 b(One)31 b(of)f(the)h(things)g(such)f(a)555
4770 y(program)d(will)j(ha)n(v)o(e)e(to)i(do)e(is)i(slide)g(groups)d
(of)i(objects.)56 b(This)29 b(is)h(the)f(purpose)f(of)h(the)555
4875 y(function)24 b Fs(move-objs)e FA(in)j(Figure)g(8.1.)43
b(F)o(or)25 b(ef)n(\002cienc)o(y)-5 b(,)25 b(we)g(don')o(t)f(w)o(ant)h
(to)h(redra)o(w)e(the)555 4980 y(whole)i(screen)g(after)g(each)g
(operation\227only)e(the)i(parts)h(which)f(ha)n(v)o(e)g(changed.)46
b(Hence)p eop
%%Page: 115 128
115 127 bop 555 538 a Ft(8.3)847 b Fu(APPLICA)-7 b(TIONS)19
b(FOR)g(MA)n(CR)n(OS)788 b FA(115)p 555 745 2678 4 v
553 3063 4 2319 v 605 888 a Fs(\(defmacro)40 b(with-redraw)f(\(\(var)i
(objs\))h(&body)f(body\))692 988 y(\(let)h(\(\(gob)f(\(gensym\)\))954
1087 y(\(x0)h(\(gensym\)\))e(\(y0)i(\(gensym\)\))954
1187 y(\(x1)g(\(gensym\)\))e(\(y1)i(\(gensym\)\)\))779
1287 y(`\(let)g(\(\(,gob)f(,objs\)\))910 1386 y(\(multiple-value-)o(bi)
o(nd)c(\(,x0)42 b(,y0)h(,x1)f(,y1\))g(\(bounds)e(,gob\))997
1486 y(\(dolist)h(\(,var)g(,gob\))h(,@body\))997 1586
y(\(multiple-value-)o(bin)o(d)37 b(\(xa)43 b(ya)g(xb)f(yb\))h(\(bounds)
d(,gob\))1084 1685 y(\(redraw)h(\(min)h(,x0)g(xa\))h(\(min)f(,y0)g
(ya\))1433 1785 y(\(max)g(,x1)g(xb\))h(\(max)f(,y1)g(yb\)\)\)\)\)\)\))
605 1984 y(\(defun)f(move-objs)f(\(objs)h(dx)i(dy\))692
2084 y(\(with-redraw)c(\(o)j(objs\))779 2183 y(\(incf)g(\(obj-x)f(o\))i
(dx\))779 2283 y(\(incf)f(\(obj-y)f(o\))i(dy\)\)\))605
2482 y(\(defun)e(scale-objs)e(\(objs)j(factor\))692 2582
y(\(with-redraw)d(\(o)j(objs\))779 2681 y(\(setf)g(\(obj-dx)e(o\))j
(\(*)g(\(obj-dx)e(o\))h(factor\))1041 2781 y(\(obj-dy)e(o\))j(\(*)g
(\(obj-dy)e(o\))h(factor\)\)\)\))1301 2985 y FA(Figure)20
b(8.2:)28 b(Mo)o(v)o(e)19 b(and)h(scale)h(\002lleted.)p
3231 3063 V 555 3067 2678 4 v 555 3291 a(the)g(tw)o(o)g(calls)h(to)f
(the)g(function)e Fs(bounds)p FA(,)g(which)h(returns)h(four)e
(coordinates)h(\(min)g(x,)h(min)555 3396 y(y)-5 b(,)22
b(max)f(x,)h(max)g(y\))f(representing)f(the)i(bounding)d(rectangle)i
(of)g(a)h(group)e(of)i(objects.)34 b(The)555 3500 y(operati)n(v)o(e)21
b(part)i(of)g Fs(move-objs)d FA(is)k(sandwiched)d(between)i(tw)o(o)g
(calls)h(to)f Fs(bounds)e FA(which)555 3605 y(\002nd)f(the)g(bounding)d
(rectangle)i(before)g(and)g(then)h(after)f(the)h(mo)o(v)o(ement,)e(and)
h(then)h(redra)o(w)555 3709 y(the)g(entire)g(af)n(fected)f(re)o(gion.)
680 3814 y(The)33 b(function)e Fs(scale-objs)f FA(is)k(for)f(changing)e
(the)j(size)g(of)f(a)g(group)f(of)h(objects.)555 3919
y(Since)28 b(the)f(bounding)e(re)o(gion)h(could)h(gro)n(w)g(or)g
(shrink)g(depending)e(on)i(the)h(scale)g(f)o(actor)m(,)555
4023 y(this)g(function)d(too)i(must)g(do)g(its)h(w)o(ork)f(between)f
(tw)o(o)i(calls)g(to)f Fs(bounds)p FA(.)48 b(As)28 b(we)g(wrote)555
4128 y(more)c(of)h(the)f(program,)g(we)h(w)o(ould)f(see)i(more)e(of)g
(this)i(pattern:)38 b(in)25 b(functions)e(to)i(rotate,)555
4232 y(\003ip,)20 b(transpose,)f(and)h(so)h(on.)680 4337
y(W)m(ith)e(a)g(macro)f(we)h(can)f(abstract)h(out)f(the)h(code)f(that)h
(these)g(functions)f(w)o(ould)g(all)h(ha)n(v)o(e)555
4442 y(in)27 b(common.)46 b(The)27 b(macro)e Fs(with-redraw)e
FA(in)k(Figure)f(8.2)g(pro)o(vides)f(the)h(sk)o(eleton)g(that)555
4546 y(the)f(functions)e(in)j(Figure)e(8.1)g(share.)1675
4516 y Fm(3)1751 4546 y FA(As)i(a)g(result,)f(the)o(y)g(can)f(no)n(w)h
(be)g(de\002ned)f(in)h(four)555 4651 y(lines)f(each,)g(as)h(at)f(the)g
(end)f(of)h(Figure)f(8.2.)39 b(W)m(ith)25 b(these)f(tw)o(o)g(functions)
e(the)i(ne)n(w)g(macro)555 4755 y(has)j(already)f(paid)h(for)f(itself)i
(in)f(bre)n(vity)-5 b(.)49 b(And)26 b(ho)n(w)h(much)f(clearer)g(the)i
(tw)o(o)f(functions)56 b Fq(\016)p 555 4827 1074 4 v
645 4882 a Fl(3)675 4905 y Fr(The)15 b(de\002nition)j(of)d(this)i
(macro)f(anticipates)j(the)e(ne)o(xt)f(chapter)i(by)d(using)i(gensyms.)
23 b(Their)16 b(purpose)h(will)f(be)555 4988 y(e)o(xplained)k(shortly)l
(.)p eop
%%Page: 116 129
116 128 bop 555 538 a FA(116)879 b Fu(WHEN)19 b(T)o(O)f(USE)h(MA)n(CR)n
(OS)555 801 y FA(become)g(once)g(the)i(details)f(of)g(screen)g(redra)o
(wing)e(are)i(abstracted)f(a)o(w)o(ay)-5 b(.)680 905
y(One)28 b(w)o(ay)g(to)h(vie)n(w)f Fs(with-redraw)d FA(is)k(as)h(a)f
(construct)e(in)i(a)g(language)d(for)i(writing)555 1010
y(interacti)n(v)o(e)12 b(dra)o(wing)g(programs.)26 b(As)14
b(we)g(de)n(v)o(elop)e(more)h(such)g(macros,)h(the)o(y)f(will)h(come)f
(to)555 1114 y(resemble)19 b(a)h(programming)c(language)i(in)i(f)o(act)
g(as)g(well)g(as)g(in)g(name,)f(and)g(our)g(application)555
1219 y(itself)i(will)h(be)o(gin)d(to)i(sho)n(w)f(the)h(ele)o(gance)d
(one)i(w)o(ould)g(e)o(xpect)g(in)h(a)g(program)d(written)i(in)h(a)555
1324 y(language)d(de\002ned)i(for)f(its)i(speci\002c)g(needs.)680
1428 y(The)27 b(other)f(major)h(use)g(of)g(macros)g(is)h(to)g
(implement)e(embedded)f(languages.)49 b(Lisp)555 1533
y(is)34 b(an)e(e)o(xceptionally)e(good)i(language)f(in)h(which)g(to)h
(write)g(programming)c(languages,)555 1638 y(because)d(Lisp)h(programs)
e(can)h(be)h(e)o(xpressed)f(as)h(lists,)j(and)c(Lisp)h(has)g(a)g(b)n
(uilt\255in)f(parser)555 1742 y(\()p Fs(read)p FA(\))16
b(and)i(compiler)f(\()p Fs(compile)p FA(\))e(for)j(programs)e(so)i(e)o
(xpressed.)28 b(Most)18 b(of)g(the)g(time)g(you)555 1847
y(don')o(t)c(e)n(v)o(en)h(ha)n(v)o(e)g(to)g(call)h Fs(compile)p
FA(;)f(you)g(can)g(ha)n(v)o(e)g(your)g(embedded)e(language)h(compiled)
555 1951 y(implicitly)-5 b(,)19 b(by)h(compiling)e(the)j(code)e(which)h
(does)g(the)g(transformations)e(\(page)h(25\).)680 2056
y(An)26 b(embedded)e(language)h(is)j(one)e(which)g(is)h(not)f(written)g
(on)h(top)f(of)g(Lisp)h(so)g(much)555 2161 y(as)32 b(commingled)d(with)
i(it,)j(so)e(that)f(the)g(syntax)f(is)i(a)g(mixture)e(of)h(Lisp)g(and)f
(constructs)555 2265 y(speci\002c)18 b(to)f(the)h(ne)n(w)f(language.)26
b(The)17 b(nai)n(v)o(e)g(w)o(ay)g(to)h(implement)e(an)h(embedded)e
(language)555 2370 y(is)33 b(to)f(write)g(an)g(interpreter)e(for)h(it)i
(in)f(Lisp.)64 b(A)32 b(better)g(approach,)g(when)f(possible,)k(is)555
2474 y(to)d(implement)e(the)i(language)e(by)h(transformation:)50
b(transform)30 b(each)i(e)o(xpression)e(into)555 2579
y(the)c(Lisp)f(code)g(that)h(the)f(interpreter)f(w)o(ould)h(ha)n(v)o(e)
g(run)f(in)i(order)e(to)i(e)n(v)n(aluate)f(it.)45 b(That')-5
b(s)555 2684 y(where)29 b(macros)h(come)f(in.)60 b(The)29
b(job)h(of)g(macros)f(is)i(precisely)f(to)g(transform)e(one)i(type)555
2788 y(of)22 b(e)o(xpression)f(into)h(another)m(,)f(so)i(the)o(y')l(re)
e(the)h(natural)f(choice)h(when)g(writing)g(embedded)555
2893 y(languages.)680 2997 y(In)f(general,)f(the)h(more)f(an)i
(embedded)d(language)g(can)i(be)h(implemented)d(by)i(transfor)n(\255)
555 3102 y(mation,)27 b(the)f(better)-5 b(.)48 b(F)o(or)25
b(one,)i(it')-5 b(s)28 b(less)f(w)o(ork.)47 b(If)26 b(the)g(ne)n(w)h
(language)d(has)j(arithmetic,)555 3207 y(for)e(e)o(xample,)h(you)f
(needn')o(t)g(f)o(ace)h(all)g(the)g(comple)o(xities)f(of)h
(representing)e(and)h(manipu\255)555 3311 y(lating)e(numeric)e
(quantities.)37 b(If)23 b(Lisp')-5 b(s)23 b(arithmetic)g(capabilities)f
(are)h(suf)n(\002cient)g(for)f(your)555 3416 y(purposes,)34
b(then)e(you)f(can)h(simply)g(transform)f(your)g(arithmetic)g(e)o
(xpressions)g(into)i(the)555 3520 y(equi)n(v)n(alent)18
b(Lisp)j(ones,)f(and)f(lea)n(v)o(e)h(the)g(rest)h(to)f(the)h(Lisp.)680
3625 y(Using)c(transformation)d(will)k(ordinarily)d(mak)o(e)i(your)f
(embedded)f(languages)h(f)o(aster)h(as)555 3730 y(well.)32
b(Interpreters)19 b(ha)n(v)o(e)i(inherent)e(disadv)n(antages)g(with)j
(respect)e(to)h(speed.)31 b(When)21 b(code)555 3834 y(occurs)13
b(within)h(a)h(loop,)f(for)g(e)o(xample,)f(an)h(interpreter)f(will)i
(often)e(ha)n(v)o(e)h(to)g(do)g(w)o(ork)f(on)h(each)555
3939 y(iteration)21 b(which)g(in)h(compiled)e(code)h(could)g(ha)n(v)o
(e)g(been)g(done)f(just)i(once.)33 b(An)22 b(embedded)555
4043 y(language)14 b(which)g(has)g(its)g(o)n(wn)g(in)o(terp)o(reter)f
(will)h(th)o(eref)o(or)o(e)g(b)o(e)g(slo)n(w)-6 b(,)9
b(e)n(v)o(en)14 b(if)g(the)g(interpreter)555 4148 y(itself)k(is)g
(compiled.)27 b(But)17 b(if)h(the)f(e)o(xpressions)f(in)h(the)g(ne)n(w)
g(language)f(are)h(transformed)e(into)555 4253 y(Lisp,)23
b(the)g(resulting)f(code)g(can)h(then)f(be)h(compiled)f(by)g(the)h
(Lisp)g(compiler)-5 b(.)36 b(A)23 b(language)555 4357
y(so)28 b(implemented)d(need)i(suf)n(fer)g(none)f(of)h(the)h(o)o(v)o
(erheads)d(of)i(interpretation)e(at)j(runtime.)555 4462
y(Short)h(of)h(writing)f(a)h(true)f(compiler)f(for)h(your)g(language,)h
(macros)f(will)h(yield)g(the)f(best)555 4567 y(performance.)j(In)22
b(f)o(act,)g(the)h(macros)e(which)h(transform)e(the)i(ne)n(w)g
(language)f(can)g(be)h(seen)555 4671 y(as)29 b(a)f(compiler)f(for)g
(it\227just)i(one)e(which)g(relies)i(on)e(the)h(e)o(xisting)f(Lisp)h
(compiler)f(to)h(do)555 4776 y(most)20 b(of)g(the)g(w)o(ork.)680
4880 y(W)-7 b(e)27 b(w)o(on')o(t)e(consider)g(an)o(y)g(e)o(xamples)g
(of)h(embedded)e(languages)h(here,)i(since)f(Chap\255)555
4985 y(ters)20 b(19\22625)f(are)h(all)g(de)n(v)n(oted)f(to)h(the)g
(topic.)29 b(Chapter)19 b(19)h(deals)g(speci\002cally)g(with)g(the)g
(dif\255)p eop
%%Page: 117 130
117 129 bop 555 538 a Ft(8.3)847 b Fu(APPLICA)-7 b(TIONS)19
b(FOR)g(MA)n(CR)n(OS)788 b FA(117)555 801 y(ference)24
b(between)h(interpreting)e(and)i(transforming)e(embedded)g(languages,)i
(and)g(sho)n(ws)555 905 y(the)20 b(same)h(language)d(implemented)g(by)i
(each)g(of)g(the)g(tw)o(o)h(methods.)680 1010 y(One)d(book)e(on)i
(Common)f(Lisp)h(asserts)h(that)f(the)g(scope)g(for)f(macros)h(is)h
(limited,)f(citing)555 1114 y(as)26 b(e)n(vidence)d(the)i(f)o(act)h
(that,)g(of)e(the)i(operators)d(de\002ned)h(in)h Fr(CL)-6
b(TL)p FA(1,)25 b(less)h(than)f(10\045)g(were)555 1219
y(macros.)38 b(This)24 b(is)g(lik)o(e)g(saying)f(that)g(since)h(our)e
(house)h(is)h(made)f(of)g(bricks,)h(our)f(furniture)555
1324 y(will)j(be)f(too.)44 b(The)25 b(proportion)d(of)j(macros)f(in)i
(a)f(Common)f(Lisp)h(program)e(will)j(depend)555 1428
y(entirely)j(on)g(what)g(it')-5 b(s)31 b(supposed)d(to)h(do.)57
b(Some)29 b(programs)f(will)i(contain)e(no)h(macros.)555
1533 y(Some)20 b(programs)e(could)h(be)i(all)f(macros.)p
eop
%%Page: 118 131
118 130 bop 555 1610 a Fn(9)p 555 1872 2686 3 v 555 2131
a Fx(V)-15 b(ariable)41 b(Captur)m(e)555 2568 y FA(Macros)30
b(are)g(vulnerable)f(to)h(a)h(problem)e(called)h Ft(variable)g(captur)m
(e)o(.)59 b FA(V)-9 b(ariable)30 b(capture)555 2672 y(occurs)23
b(when)h(macroe)o(xpansion)c(causes)25 b(a)f(name)f(clash:)38
b(when)23 b(some)h(symbol)f(ends)h(up)555 2777 y(referring)29
b(to)j(a)g(v)n(ariable)e(from)h(another)f(conte)o(xt.)61
b(Inadv)o(ertent)29 b(v)n(ariable)h(capture)h(can)555
2882 y(cause)h(e)o(xtremely)d(subtle)j(b)n(ugs.)63 b(This)32
b(chapter)e(is)j(about)d(ho)n(w)h(to)h(foresee)f(and)g(a)n(v)n(oid)555
2986 y(them.)37 b(Ho)n(we)n(v)o(er)m(,)21 b(intentional)h(v)n(ariable)g
(capture)g(is)h(a)h(useful)e(programming)d(technique,)555
3091 y(and)h(Chapter)f(14)h(is)h(full)f(of)g(macros)g(which)f(rely)h
(on)g(it.)555 3344 y Fw(9.1)99 b(Macr)n(o)25 b(Ar)o(gument)h(Captur)n
(e)555 3534 y FA(A)15 b(macro)f(vulnerable)f(to)i(unintended)e(v)n
(ariable)h(capture)f(is)j(a)g(macro)e(with)h(a)g(b)n(ug.)27
b(T)-7 b(o)15 b(a)n(v)n(oid)555 3639 y(writing)20 b(such)g(macros,)g
(we)h(must)g(kno)n(w)e(precisely)h(when)g(capture)g(can)g(occur)-5
b(.)30 b(Instances)555 3743 y(of)16 b(v)n(ariable)f(capture)g(can)g(be)
h(traced)g(to)g(one)g(of)f(tw)o(o)i(situations:)27 b(macro)15
b(ar)o(gument)f(capture)555 3848 y(and)k(free)f(symbol)g(capture.)28
b(In)17 b(ar)o(gument)f(capture,)h(a)i(symbol)e(passed)h(as)h(an)f(ar)o
(gument)d(in)555 3953 y(the)e(macro)g(call)h(inadv)o(ertently)c(refers)
j(to)h(a)g(v)n(ariable)e(established)h(by)g(the)g(macro)g(e)o(xpansion)
555 4057 y(itself.)39 b(Consider)23 b(the)g(follo)n(wing)f
(de\002nition)g(of)i(the)f(macro)f Fs(for)p FA(,)i(which)e(iterates)i
(o)o(v)o(er)e(a)555 4162 y(body)d(of)h(e)o(xpressions)f(lik)o(e)h(a)h
(P)o(ascal)f Fs(for)g FA(loop:)555 4344 y Fs(\(defmacro)40
b(for)i(\(\(var)g(start)f(stop\))h(&body)f(body\))478
b(;)43 b(wrong)642 4444 y(`\(do)f(\(\(,var)f(,start)g(\(1+)i(,var\)\))
904 4544 y(\(limit)e(,stop\)\))860 4643 y(\(\(>)h(,var)g(limit\)\))773
4743 y(,@body\)\))555 4931 y FA(This)20 b(macro)g(looks)f(correct)g(at)
i(\002rst)g(sight.)29 b(It)21 b(e)n(v)o(en)e(seems)i(to)f(w)o(ork)g
(\002ne:)1835 5229 y(118)p eop
%%Page: 119 132
119 131 bop 555 538 a Ft(9.2)905 b Fu(FREE)18 b(SYMBOL)g(CAPTURE)845
b FA(119)555 801 y Fs(>)43 b(\(for)f(\(x)h(1)g(5\))729
900 y(\(princ)e(x\)\))555 1000 y(12345)555 1100 y(NIL)555
1287 y FA(Indeed,)17 b(the)g(error)g(is)i(so)f(subtle)g(that)g(we)g
(might)f(use)h(this)h(v)o(ersion)d(of)i(the)g(macro)f(hundreds)555
1392 y(of)j(times)h(and)e(ha)n(v)o(e)h(it)h(al)o(w)o(ays)f(w)o(ork)g
(perfectly)-5 b(.)27 b(Not)21 b(if)f(we)h(call)f(it)h(this)g(w)o(ay)-5
b(,)20 b(though:)555 1574 y Fs(\(for)42 b(\(limit)f(1)i(5\))642
1674 y(\(princ)e(limit\)\))555 1862 y FA(W)-7 b(e)22
b(might)e(e)o(xpect)f(this)i(e)o(xpression)e(to)i(ha)n(v)o(e)f(the)g
(same)h(ef)n(fect)f(as)h(the)g(one)f(before.)29 b(But)21
b(it)555 1966 y(doesn')o(t)16 b(print)h(an)o(ything;)f(it)j(generates)d
(an)i(error)-5 b(.)28 b(T)-7 b(o)17 b(see)i(why)-5 b(,)16
b(we)i(look)f(at)h(its)h(e)o(xpansion:)555 2149 y Fs(\(do)42
b(\(\(limit)f(1)i(\(1+)g(limit\)\))773 2249 y(\(limit)e(5\)\))729
2348 y(\(\(>)i(limit)e(limit\)\))642 2448 y(\(princ)g(limit\)\))555
2635 y FA(No)n(w)30 b(it')-5 b(s)30 b(ob)o(vious)e(what)i(goes)f
(wrong.)57 b(There)29 b(is)h(a)h(name)e(clash)g(between)g(a)i(symbol)
555 2740 y(local)24 b(to)f(the)h(macro)f(e)o(xpansion)e(and)i(a)h
(symbol)f(passed)g(as)i(an)e(ar)o(gument)e(to)j(the)g(macro.)555
2845 y(The)c(macroe)o(xpansion)d Ft(captur)m(es)j Fs(limit)p
FA(.)29 b(It)21 b(ends)f(up)g(occurring)e(twice)j(in)g(the)f(same)h
Fs(do)p FA(,)555 2949 y(which)f(is)h(ille)o(gal.)680
3054 y(Errors)13 b(caused)i(by)f(v)n(ariable)g(capture)f(are)i(rare,)g
(b)n(ut)g(what)g(the)o(y)f(lack)g(in)h(frequenc)o(y)d(the)o(y)555
3158 y(mak)o(e)19 b(up)h(in)g(viciousness.)28 b(This)20
b(capture)f(w)o(as)i(comparati)n(v)o(ely)c(mild\227here,)h(at)j(least,)
f(we)555 3263 y(got)e(an)f(error)-5 b(.)28 b(More)17
b(often)g(than)h(not,)g(a)g(capturing)e(macro)h(w)o(ould)g(simply)g
(yield)h(incorrect)555 3368 y(results)j(with)f(no)g(indication)f(that)h
(an)o(ything)e(w)o(as)j(wrong.)28 b(In)20 b(this)g(case,)555
3550 y Fs(>)43 b(\(let)f(\(\(limit)f(5\)\))729 3650 y(\(for)h(\(i)h(1)g
(10\))817 3750 y(\(when)e(\(>)i(i)g(limit\))904 3849
y(\(princ)e(i\)\)\)\))555 3949 y(NIL)555 4136 y FA(the)20
b(resulting)g(code)f(quietly)g(does)h(nothing.)555 4389
y Fw(9.2)99 b(Fr)n(ee)26 b(Symbol)f(Captur)n(e)555 4580
y FA(Less)19 b(frequently)-5 b(,)15 b(the)j(macro)f(de\002nition)g
(itself)h(contains)f(a)i(symbol)e(which)g(inadv)o(ertently)555
4684 y(refers)28 b(to)g(a)h(binding)e(in)h(the)h(en)m(vironment)c
(where)j(the)g(macro)f(is)j(e)o(xpanded.)51 b(Suppose)555
4789 y(some)15 b(program,)f(instead)h(of)g(printing)f(w)o(arnings)h(to)
g(the)h(user)f(as)h(the)o(y)f(arise,)h(w)o(ants)g(to)g(store)555
4894 y(the)25 b(w)o(arnings)g(in)g(a)h(list,)h(to)f(be)f(e)o(xamined)e
(later)-5 b(.)45 b(One)25 b(person)g(writes)g(a)h(macro)e
Fs(gripe)p FA(,)555 4998 y(which)c(tak)o(es)g(a)h(w)o(arning)e(message)
h(and)f(adds)h(it)h(to)g(a)f(global)g(list,)h Fs(w)p
FA(:)p eop
%%Page: 120 133
120 132 bop 555 538 a FA(120)924 b Fu(V)-8 b(ARIABLE)18
b(CAPTURE)555 801 y Fs(\(defvar)41 b(w)i(nil\))555 1000
y(\(defmacro)d(gripe)h(\(warning\))1261 b(;)43 b(wrong)642
1100 y(`\(progn)e(\(setq)g(w)j(\(nconc)d(w)i(\(list)e(,warning\)\)\))
991 1199 y(nil\)\))555 1387 y FA(Someone)23 b(else)i(then)f(w)o(ants)h
(to)g(write)g(a)g(function)d Fs(sample-ratio)p FA(,)f(to)k(return)e
(the)i(ratio)555 1491 y(of)h(the)h(lengths)f(of)g(tw)o(o)h(lists.)50
b(If)27 b(either)f(of)g(the)h(lists)h(has)f(less)h(than)e(tw)o(o)h
(elements,)h(the)555 1596 y(function)d(is)i(to)g(return)f
Fs(nil)g FA(instead,)h(also)g(issuing)g(a)g(w)o(arning)e(that)i(it)g(w)
o(as)h(called)e(on)g(a)555 1701 y(statistically)f(insigni\002cant)e
(case.)40 b(\(Actual)24 b(w)o(arnings)f(could)g(be)g(more)g(informati)n
(v)o(e,)g(b)n(ut)555 1805 y(their)d(content)f(isn')o(t)h(rele)n(v)n
(ant)f(to)h(this)h(e)o(xample.\))555 1988 y Fs(\(defun)41
b(sample-ratio)e(\(v)j(w\))642 2087 y(\(let)g(\(\(vn)g(\(length)f
(v\)\))h(\(wn)g(\(length)f(w\)\)\))729 2187 y(\(if)i(\(or)f(\(<)h(vn)g
(2\))f(\(<)h(wn)g(2\)\))904 2287 y(\(gripe)e("sample)f(<)k(2"\))904
2386 y(\(/)e(vn)h(wn\)\)\)\))555 2574 y FA(If)27 b(sample\255ratio)f
(is)h(called)g(with)h Fs(w)f FA(=)g Fs(\(b\))p FA(,)h(then)f(it)g(will)
h(w)o(ant)f(to)g(w)o(arn)g(that)g(one)g(of)g(its)555
2679 y(ar)o(guments,)18 b(with)i(only)f(one)g(element,)h(is)g
(statistically)h(insigni\002cant.)28 b(But)21 b(when)e(the)h(call)555
2783 y(to)g Fs(gripe)f FA(is)i(e)o(xpanded,)d(it)i(will)h(be)g(as)f(if)
h Fs(sample-ratio)16 b FA(had)j(been)h(de\002ned:)555
2966 y Fs(\(defun)41 b(sample-ratio)e(\(v)j(w\))642 3065
y(\(let)g(\(\(vn)g(\(length)f(v\)\))h(\(wn)g(\(length)f(w\)\)\))729
3165 y(\(if)i(\(or)f(\(<)h(vn)g(2\))f(\(<)h(wn)g(2\)\))904
3265 y(\(progn)e(\(setq)g(w)i(\(nconc)f(w)h(\(list)e("sample)g(<)i
(2"\)\)\))1209 3364 y(nil\))904 3464 y(\(/)f(vn)h(wn\)\)\)\))555
3652 y FA(The)27 b(problem)f(here)h(is)h(that)g Fs(gripe)e
FA(is)i(used)f(in)h(a)g(conte)o(xt)e(where)h Fs(w)h FA(has)f(its)i(o)n
(wn)e(local)555 3756 y(binding.)39 b(The)24 b(w)o(arning,)g(instead)f
(of)h(being)f(sa)n(v)o(ed)h(in)h(the)f(global)f(w)o(arning)g(list,)j
(will)f(be)555 3861 y(nconced)g(onto)h(the)g(end)g(of)h(one)f(of)g(the)
h(parameters)e(of)h Fs(sample-ratio)p FA(.)44 b(Not)27
b(only)f(is)555 3965 y(the)20 b(w)o(arning)e(lost,)i(b)n(ut)g(the)g
(list)g Fs(\(b\))p FA(,)f(which)g(is)i(probably)c(used)j(as)g(data)g
(else)n(where)f(in)h(the)555 4070 y(program,)e(will)j(ha)n(v)o(e)e(an)h
(e)o(xtraneous)f(string)g(appended)f(to)j(it:)555 4253
y Fs(>)43 b(\(let)f(\(\(lst)g('\(b\)\)\))729 4352 y(\(sample-ratio)d
(nil)j(lst\))729 4452 y(lst\))555 4552 y(\(B)h("sample)d(<)k(2"\))555
4651 y(>)f(w)555 4751 y(NIL)p eop
%%Page: 121 134
121 133 bop 555 538 a Ft(9.3)893 b Fu(WHEN)19 b(CAPTURE)f(OCCURS)834
b FA(121)555 801 y Fw(9.3)99 b(When)26 b(Captur)n(e)g(Occurs)555
991 y FA(It')-5 b(s)25 b(asking)f(a)h(lot)f(of)h(the)f(macro)g(writer)g
(to)h(be)f(able)g(to)h(look)e(at)i(a)g(macro)f(de\002nition)f(and)555
1096 y(foresee)15 b(all)i(the)f(possible)g(problems)f(arising)g(from)g
(these)i(tw)o(o)f(types)g(of)g(capture.)26 b(V)-9 b(ariable)555
1200 y(capture)20 b(is)j(a)f(subtle)f(matter)m(,)g(and)g(it)h(tak)o(es)
g(some)g(e)o(xperience)d(to)j(anticipate)f(all)h(the)f(w)o(ays)555
1305 y(a)29 b(capturable)d(symbol)i(could)f(wreak)h(mischief)f(in)i(a)f
(program.)52 b(F)o(ortunately)-5 b(,)27 b(you)h(can)555
1410 y(detect)17 b(and)h(eliminate)f(capturable)f(symbols)h(in)h(your)e
(macro)h(de\002nitions)g(without)g(ha)n(ving)555 1514
y(to)30 b(think)g(about)f Ft(how)h FA(their)g(capture)f(could)g(send)h
(your)f(program)f(a)o(wry)-5 b(.)58 b(This)30 b(section)555
1619 y(pro)o(vides)20 b(a)i(straightforw)o(ard)d(rule)j(for)f
(detecting)g(capturable)f(symbols.)33 b(The)21 b(remaining)555
1723 y(sections)f(of)g(this)h(chapter)e(e)o(xplain)g(techniques)g(for)g
(eliminating)g(them.)680 1828 y(The)35 b(rule)h(for)g(de\002ning)f(a)h
(capturable)f(v)n(ariable)g(depends)g(on)h(some)g(subordinate)555
1933 y(concepts,)19 b(which)h(must)g(be)g(de\002ned)f(\002rst:)555
2120 y Ft(F)-5 b(r)m(ee:)41 b FA(A)19 b(symbol)d Ft(s)j
FA(occurs)e(free)g(in)h(an)g(e)o(xpression)e(when)h(it)i(is)g(used)e
(as)i(a)f(v)n(ariable)f(in)g(that)763 2225 y(e)o(xpression,)h(b)n(ut)i
(the)g(e)o(xpression)f(does)h(not)g(create)g(a)g(binding)f(for)g(it.)
555 2413 y(In)h(the)g(follo)n(wing)f(e)o(xpression,)555
2595 y Fs(\(let)42 b(\(\(x)g(y\))h(\(z)g(10\)\))642 2695
y(\(list)f(w)h(x)g(z\)\))555 2882 y(w)p FA(,)15 b Fs(x)f
FA(and)f Fs(z)h FA(all)g(occur)f(free)g(within)g(the)h
Fs(list)f FA(e)o(xpression,)g(which)g(establishes)h(no)f(bindings.)555
2987 y(Ho)n(we)n(v)o(er)m(,)i(the)i(enclosing)e Fs(let)h
FA(e)o(xpression)f(establishes)i(bindings)f(for)g Fs(x)g
FA(and)h Fs(z)p FA(,)g(so)g(within)555 3092 y(the)j Fs(let)g
FA(as)h(a)f(whole,)g(only)f Fs(y)h FA(and)g Fs(w)g FA(occur)g(free.)28
b(Note)20 b(that)h(in)555 3274 y Fs(\(let)42 b(\(\(x)g(x\)\))642
3374 y(x\))555 3562 y FA(the)16 b(second)f(instance)g(of)h
Fs(x)g FA(is)g(free\227it')-5 b(s)16 b(not)g(within)f(the)h(scope)g(of)
f(the)h(ne)n(w)f(binding)g(being)555 3666 y(established)20
b(for)f Fs(x)p FA(.)555 3854 y Ft(Sk)o(eleton:)40 b FA(The)35
b(sk)o(eleton)f(of)h(a)h(macro)f(e)o(xpansion)e(is)j(the)f(whole)g(e)o
(xpansion,)i(minus)763 3958 y(an)o(ything)18 b(which)h(w)o(as)i(part)f
(of)g(an)g(ar)o(gument)e(in)i(the)h(macro)e(call.)555
4146 y(If)h Fs(foo)g FA(is)h(de\002ned:)555 4329 y Fs(\(defmacro)40
b(foo)i(\(x)h(y\))642 4428 y(`\(/)g(\(+)f(,x)h(1\))g(,y\)\))555
4616 y FA(and)20 b(called)g(thus:)555 4799 y Fs(\(foo)42
b(\(-)h(5)g(2\))g(6\))555 4986 y FA(then)20 b(it)h(yields)f(the)g
(macro)f(e)o(xpansion:)p eop
%%Page: 122 135
122 134 bop 555 538 a FA(122)924 b Fu(V)-8 b(ARIABLE)18
b(CAPTURE)555 801 y Fs(\(/)43 b(\(+)g(\(-)f(5)h(2\))g(1\))g(6\))555
988 y FA(The)34 b(sk)o(eleton)g(of)h(this)g(e)o(xpansion)d(is)k(the)e
(abo)o(v)o(e)f(e)o(xpression)g(with)i(holes)g(where)f(the)555
1093 y(parameters)19 b Fs(x)h FA(and)g Fs(y)g FA(got)g(inserted:)555
1276 y Fs(\(/)43 b(\(+)391 b(1\))87 b(\))680 1463 y FA(W)m(ith)36
b(these)g(tw)o(o)h(concepts)e(de\002ned,)k(it')-5 b(s)38
b(possible)e(to)g(state)h(a)g(concise)e(rule)h(for)555
1568 y(detecting)19 b(capturable)g(symbols:)555 1755
y Ft(Captur)o(able:)39 b FA(A)31 b(symbol)f(is)i(capturable)d(in)i
(some)g(macro)e(e)o(xpansion)g(if)i(\(a\))g(it)g(occurs)763
1860 y(free)22 b(in)h(the)h(sk)o(eleton)e(of)h(the)g(macro)f(e)o
(xpansion,)g(or)g(\(b\))h(it)h(is)g(bound)d(by)i(a)g(part)g(of)763
1965 y(the)j(sk)o(eleton)g(in)h(which)f(ar)o(guments)f(passed)h(to)h
(the)g(macro)e(are)i(either)f(bound)f(or)763 2069 y(e)n(v)n(aluated.)
555 2257 y(Some)20 b(e)o(xamples)f(will)i(sho)n(w)f(the)g(implications)
f(of)h(this)h(rule.)29 b(In)20 b(the)g(simplest)g(case:)555
2440 y Fs(\(defmacro)40 b(cap1)i(\(\))642 2539 y('\(+)h(x)g(1\)\))555
2727 y(x)22 b FA(is)h(capturable)e(because)g(it)i(will)g(occur)e(free)g
(in)i(the)f(sk)o(eleton.)34 b(That')-5 b(s)22 b(what)g(caused)g(the)555
2831 y(b)n(ug)e(in)g Fs(gripe)p FA(.)28 b(In)20 b(this)g(macro:)555
3014 y Fs(\(defmacro)40 b(cap2)i(\(var\))642 3114 y(`\(let)g(\(\(x)g
(...\))947 3213 y(\(,var)g(...\)\))773 3313 y(...\)\))555
3501 y(x)29 b FA(is)h(capturable)d(because)h(it)i(is)g(bound)d(in)i(an)
g(e)o(xpression)e(where)h(an)h(ar)o(gument)e(to)i(the)555
3605 y(macro)17 b(call)g(will)i(also)e(be)h(bound.)26
b(\(That')-5 b(s)17 b(what)h(went)f(wrong)f(in)i Fs(for)p
FA(.\))27 b(Lik)o(e)n(wise)18 b(for)f(the)555 3710 y(follo)n(wing)i(tw)
o(o)h(macros)555 3892 y Fs(\(defmacro)40 b(cap3)i(\(var\))642
3992 y(`\(let)g(\(\(x)g(...\)\))773 4092 y(\(let)g(\(\(,var)f(...\)\))
860 4191 y(...\)\)\))555 4391 y(\(defmacro)f(cap4)i(\(var\))642
4490 y(`\(let)g(\(\(,var)f(...\)\))773 4590 y(\(let)h(\(\(x)g(...\)\))
860 4689 y(...\)\)\))555 4877 y FA(in)28 b(both)f(of)g(which)h
Fs(x)g FA(is)g(capturable.)51 b(Ho)n(we)n(v)o(er)m(,)27
b(if)h(there)g(is)g(no)g(conte)o(xt)e(in)i(which)g(the)555
4982 y(binding)18 b(of)i Fs(x)h FA(and)e(the)i(v)n(ariable)e(passed)h
(as)h(an)f(ar)o(gument)e(will)j(both)e(be)h(visible,)g(as)h(in)p
eop
%%Page: 123 136
123 135 bop 555 538 a Ft(9.3)893 b Fu(WHEN)19 b(CAPTURE)f(OCCURS)834
b FA(123)555 801 y Fs(\(defmacro)40 b(safe1)h(\(var\))642
900 y(`\(progn)g(\(let)h(\(\(x)g(1\)\))1078 1000 y(\(print)f(x\)\))991
1100 y(\(let)h(\(\(,var)f(1\)\))1078 1199 y(\(print)g(,var\)\)\)\))555
1378 y FA(then)25 b Fs(x)g FA(w)o(on')o(t)g(be)g(capturable.)43
b(Not)25 b(all)h(v)n(ariables)f(bound)e(by)i(the)h(sk)o(eleton)f(are)g
(at)h(risk.)555 1483 y(Ho)n(we)n(v)o(er)m(,)14 b(if)i(ar)o(guments)d
(to)j(the)f(macro)g(call)h(are)f(e)n(v)n(aluated)f(within)h(a)h
(binding)e(established)555 1587 y(by)20 b(the)g(sk)o(eleton,)555
1761 y Fs(\(defmacro)40 b(cap5)i(\(&body)f(body\))642
1861 y(`\(let)h(\(\(x)g(...\)\))773 1960 y(,@body\)\))555
2139 y FA(then)25 b(v)n(ariables)g(so)h(bound)d(are)j(at)g(risk)f(of)g
(capture:)39 b(in)26 b Fs(cap5)p FA(,)f Fs(x)h FA(is)g(capturable.)44
b(In)25 b(this)555 2244 y(case,)20 b(though,)555 2418
y Fs(\(defmacro)40 b(safe2)h(\(expr\))642 2518 y(`\(let)h(\(\(x)g
(,expr\)\))773 2617 y(\(cons)f(x)j(1\)\)\))555 2796 y(x)23
b FA(is)h Ft(not)e FA(capturable,)g(because)g(when)g(the)h(ar)o(gument)
e(passed)h(to)h Fs(expr)f FA(is)i(e)n(v)n(aluated,)e(the)555
2901 y(ne)n(w)e(binding)f(of)h Fs(x)h FA(w)o(on')o(t)e(be)h(visible.)30
b(Note)21 b(also)f(that)h(it')-5 b(s)21 b(only)f(the)g(binding)f(of)h
(sk)o(eletal)555 3005 y(v)n(ariables)f(we)i(ha)n(v)o(e)f(to)g(w)o(orry)
f(about.)28 b(In)20 b(this)h(macro)555 3179 y Fs(\(defmacro)40
b(safe3)h(\(var)h(&body)g(body\))642 3279 y(`\(let)g(\(\(,var)f
(...\)\))773 3378 y(,@body\)\))555 3557 y FA(no)17 b(symbol)g(is)h(at)g
(risk)g(of)f(inadv)o(ertent)e(capture)h(\(assuming)h(that)g(the)h(user)
f(e)o(xpects)g(that)h(the)555 3662 y(\002rst)j(ar)o(gument)d(will)j(be)
f(bound\).)680 3767 y(No)n(w)27 b(let')-5 b(s)29 b(look)e(at)i(the)f
(original)f(de\002nition)f(of)i Fs(for)f FA(in)h(light)g(of)g(the)g(ne)
n(w)g(rule)f(for)555 3871 y(identifying)18 b(capturable)h(symbols:)555
4045 y Fs(\(defmacro)40 b(for)i(\(\(var)g(start)f(stop\))h(&body)f
(body\))478 b(;)43 b(wrong)642 4145 y(`\(do)f(\(\(,var)f(,start)g(\(1+)
i(,var\)\))904 4244 y(\(limit)e(,stop\)\))860 4344 y(\(\(>)h(,var)g
(limit\)\))773 4444 y(,@body\)\))555 4622 y FA(It)24
b(turns)g(out)f(no)n(w)g(that)h(this)h(de\002nition)e(of)g
Fs(for)g FA(is)i(vulnerable)d(to)i(capture)f(in)h Ft(two)g
FA(w)o(ays:)555 4727 y Fs(limit)19 b FA(could)g(be)h(passed)g(as)h(the)
f(\002rst)h(ar)o(gument)d(to)i Fs(for)p FA(,)g(as)h(in)f(the)g
(original)f(e)o(xample:)555 4901 y Fs(\(for)42 b(\(limit)f(1)i(5\))642
5001 y(\(princ)e(limit\)\))p eop
%%Page: 124 137
124 136 bop 555 538 a FA(124)924 b Fu(V)-8 b(ARIABLE)18
b(CAPTURE)555 801 y FA(b)n(ut)i(it')-5 b(s)21 b(just)g(as)g(dangerous)d
(if)j Fs(limit)d FA(occurs)i(in)g(the)g(body)f(of)h(the)g(loop:)555
983 y Fs(\(let)42 b(\(\(limit)f(0\)\))642 1083 y(\(for)h(\(x)h(1)g
(10\))729 1183 y(\(incf)f(limit)f(x\)\))642 1282 y(limit\))555
1470 y FA(Someone)19 b(using)h Fs(for)g FA(in)g(this)h(w)o(ay)f(w)o
(ould)g(be)h(e)o(xpecting)d(his)j(o)n(wn)f(binding)e(of)j
Fs(limit)d FA(to)555 1574 y(be)i(the)f(one)g(incremented)f(in)h(the)h
(loop,)f(and)g(the)g(e)o(xpression)f(as)j(a)f(whole)f(to)h(return)e
(55;)h(in)555 1679 y(f)o(act,)26 b(only)e(the)h(binding)e(of)i
Fs(limit)e FA(generated)h(by)g(the)h(sk)o(eleton)f(of)h(the)g(e)o
(xpansion)e(will)555 1784 y(be)d(incremented:)555 1966
y Fs(\(do)42 b(\(\(x)h(1)g(\(1+)f(x\)\))773 2066 y(\(limit)f(10\)\))729
2166 y(\(\(>)i(x)g(limit\)\))642 2265 y(\(incf)f(limit)f(x\)\))555
2453 y FA(and)20 b(since)g(that')-5 b(s)21 b(the)f(one)g(which)f
(controls)g(iteration,)h(the)g(loop)f(w)o(on')o(t)g(e)n(v)o(en)h
(terminate.)680 2557 y(The)14 b(rules)g(presented)g(in)h(this)g
(section)f(should)g(be)h(used)f(with)h(the)g(reserv)n(ation)e(that)h
(the)o(y)555 2662 y(are)j(intended)f(only)g(as)i(a)f(guide.)28
b(The)o(y)16 b(are)h(not)f(e)n(v)o(en)h(formally)e(stated,)j(let)g
(alone)e(formally)555 2767 y(correct.)53 b(The)28 b(problem)f(of)h
(capture)f(is)i(a)g(v)n(aguely)e(de\002ned)h(one,)h(since)g(it)g
(depends)e(on)555 2871 y(e)o(xpectations.)h(F)o(or)19
b(e)o(xample,)g(in)h(an)g(e)o(xpression)f(lik)o(e)555
3054 y Fs(\(let)42 b(\(\(x)g(1\)\))h(\(list)e(x\)\))555
3241 y FA(we)23 b(don')o(t)e(re)o(gard)g(it)j(as)f(an)g(error)f(that)h
(when)f Fs(\(list)41 b(x\))23 b FA(is)h(e)n(v)n(aluated,)e
Fs(x)h FA(will)g(refer)f(to)h(a)555 3346 y(ne)n(w)d(v)n(ariable.)29
b(That')-5 b(s)21 b(what)g Fs(let)e FA(is)j(supposed)d(to)i(do.)30
b(The)20 b(rules)g(for)g(detecting)g(capture)555 3451
y(are)i(also)h(imprecise.)36 b(Y)-9 b(ou)22 b(could)f(write)i(macros)f
(which)g(passed)g(these)h(tests,)h(and)e(which)555 3555
y(still)f(w)o(ould)f(be)g(vulnerable)e(to)j(unintended)c(capture.)28
b(F)o(or)20 b(e)o(xample,)555 3738 y Fs(\(defmacro)40
b(pathological)e(\(&body)k(body\))826 b(;)43 b(wrong)642
3838 y(\(let*)f(\(\(syms)f(\(remove-if)e(\(complement)g(#'symbolp\))
1688 3937 y(\(flatten)i(body\)\)\))947 4037 y(\(var)h(\(nth)g(\(random)
f(\(length)g(syms\)\))1383 4136 y(syms\)\)\))729 4236
y(`\(let)h(\(\(,var)f(99\)\))860 4336 y(,@body\)\)\))555
4523 y FA(When)23 b(this)h(macro)e(is)j(called,)e(the)h(e)o(xpressions)
e(in)h(the)h(body)e(will)i(be)f(e)n(v)n(aluated)f(as)i(if)f(in)555
4628 y(a)j Fs(progn)p FA(\227b)n(ut)d(one)h(random)g(v)n(ariable)g
(within)g(the)i(body)d(may)i(ha)n(v)o(e)f(a)i(dif)n(ferent)d(v)n(alue.)
555 4733 y(This)c(is)i(clearly)d(capture,)g(b)n(ut)h(it)h(passes)g(our)
f(tests,)h(because)f(the)g(v)n(ariable)f(does)h(not)g(occur)555
4837 y(in)24 b(the)g(sk)o(eleton.)40 b(In)23 b(practice,)h(though,)f
(the)h(rules)g(will)g(w)o(ork)g(nearly)f(all)h(the)g(time:)37
b(one)555 4942 y(rarely)19 b(\(if)h(e)n(v)o(er\))f(w)o(ants)i(to)f
(write)h(a)f(macro)g(lik)o(e)g(the)g(e)o(xample)f(abo)o(v)o(e.)p
eop
%%Page: 125 138
125 137 bop 555 538 a Ft(9.5)645 b Fu(A)-8 b(V)n(OIDING)19
b(CAPTURE)f(WITH)h(BETTER)d(N)n(AMES)586 b FA(125)p 555
745 2678 4 v 553 2298 4 1553 v 605 886 a(V)-6 b(ulnerable)18
b(to)j(capture:)605 1044 y Fs(\(defmacro)40 b(before)h(\(x)i(y)g(seq\))
692 1144 y(`\(let)f(\(\(seq)f(,seq\)\))823 1243 y(\(<)i(\(position)c
(,x)k(seq\))954 1343 y(\(position)c(,y)k(seq\)\)\)\))605
1567 y FA(A)21 b(correct)e(v)o(ersion:)605 1733 y Fs(\(defmacro)40
b(before)h(\(x)i(y)g(seq\))692 1833 y(`\(let)f(\(\(xval)f(,x\))h
(\(yval)f(,y\))i(\(seq)f(,seq\)\))823 1932 y(\(<)h(\(position)c(xval)j
(seq\))954 2032 y(\(position)d(yval)j(seq\)\)\)\))1241
2220 y FA(Figure)19 b(9.1:)29 b(A)-6 b(v)n(oiding)19
b(capture)g(with)h Fs(let)p FA(.)p 3231 2298 V 555 2301
2678 4 v 555 2525 a Fw(9.4)99 b(A)-10 b(v)o(oiding)25
b(Captur)n(e)h(with)f(Better)h(Names)555 2716 y FA(The)i(\002rst)h(tw)o
(o)g(sections)f(di)n(vided)f(instances)h(of)g(v)n(ariable)f(capture)g
(into)h(tw)o(o)h(types:)46 b(ar)n(\255)555 2820 y(gument)31
b(capture,)j(where)d(a)i(symbol)e(used)h(in)h(an)f(ar)o(gument)e(is)j
(caught)e(by)h(a)g(binding)555 2925 y(established)20
b(by)h(the)f(macro)g(sk)o(eleton,)g(and)g(free)h(symbol)e(capture,)h
(where)g(a)h(free)g(symbol)555 3030 y(in)34 b(a)h(macroe)o(xpansion)30
b(is)35 b(caught)e(by)g(a)i(binding)d(in)i(force)f(where)g(the)h(macro)
f(is)i(e)o(x\255)555 3134 y(panded.)c(The)21 b(latter)h(cases)g(are)f
(usually)g(dealt)g(with)h(simply)f(by)g(gi)n(ving)f(global)g(v)n
(ariables)555 3239 y(distinguished)k(names.)45 b(In)26
b(Common)e(Lisp,)j(it)g(is)f(traditional)f(to)h(gi)n(v)o(e)f(global)f
(v)n(ariables)555 3343 y(names)32 b(which)f(be)o(gin)g(and)g(end)g
(with)h(asterisks.)65 b(The)32 b(v)n(ariable)e(de\002ning)h(the)h
(current)555 3448 y(package)25 b(is)j(called)f Fs(*package*)p
FA(,)e(for)h(e)o(xample.)48 b(\(Such)26 b(a)h(name)f(may)g(be)h
(pronounced)555 3553 y(\223star)n(\255package\255star\224)18
b(to)i(emphasize)f(that)i(it)g(is)g(not)f(an)g(ordinary)e(v)n
(ariable.\))680 3657 y(So)27 b(really)f(it)i(w)o(as)f(the)g
(responsibility)f(of)g(the)h(author)f(of)g Fs(gripe)g
FA(to)h(store)f(w)o(arnings)555 3762 y(in)c(a)g(v)n(ariable)f(called)h
(something)e(lik)o(e)i Fs(*warnings*)p FA(,)c(rather)j(than)h(just)g
Fs(w)p FA(.)34 b(If)22 b(the)g(author)555 3867 y(of)g
Fs(sample-ratio)17 b FA(had)22 b(used)g Fs(*warnings*)c
FA(as)23 b(a)f(parameter)m(,)f(then)g(he)h(w)o(ould)g(deserv)o(e)555
3971 y(e)n(v)o(ery)d(b)n(ug)h(he)h(got,)f(b)n(ut)g(he)g(can')o(t)g(be)g
(blamed)g(for)g(thinking)f(that)h(it)h(w)o(ould)f(be)h(safe)f(to)h
(call)555 4076 y(a)g(parameter)d Fs(w)p FA(.)555 4329
y Fw(9.5)99 b(A)-10 b(v)o(oiding)25 b(Captur)n(e)h(by)f(Prior)g(Ev)o
(aluation)680 4519 y FA(Sometimes)h(ar)o(gument)f(capture)i(can)g(be)g
(cured)f(simply)h(by)g(e)n(v)n(aluating)f(the)h(endan\255)555
4624 y(gered)h(ar)o(guments)f(outside)i(of)g(an)o(y)g(bindings)e
(created)i(by)g(the)g(macroe)o(xpansion.)53 b(The)555
4728 y(simplest)30 b(cases)h(can)e(be)h(handled)e(by)h(be)o(ginning)f
(the)h(macro)g(with)h(a)g Fs(let)f FA(e)o(xpression.)555
4833 y(Figure)23 b(9.1)h(contains)f(tw)o(o)i(v)o(ersions)e(of)g(the)i
(macro)e Fs(before)p FA(,)g(which)g(tak)o(es)h(tw)o(o)h(objects)555
4938 y(and)18 b(a)h(sequence,)e(and)h(returns)g(true)g(if)n(f)h(the)f
(\002rst)i(object)e(occurs)f(before)h(the)g(second)g(in)h(the)p
eop
%%Page: 126 139
126 138 bop 555 538 a FA(126)924 b Fu(V)-8 b(ARIABLE)18
b(CAPTURE)555 801 y FA(sequence.)882 771 y Fm(1)956 801
y FA(The)24 b(\002rst)h(de\002nition)e(is)j(incorrect.)40
b(Its)25 b(initial)g Fs(let)f FA(ensures)g(that)g(the)h(form)555
905 y(passed)18 b(as)h Fs(seq)f FA(is)h(only)e(e)n(v)n(aluated)g(once,)
h(b)n(ut)g(it)h(is)g(not)f(suf)n(\002cient)g(to)g(a)n(v)n(oid)g(the)g
(follo)n(wing)555 1010 y(problem:)555 1191 y Fs(>)43
b(\(before)e(\(progn)g(\(setq)g(seq)i('\(b)f(a\)\))h('a\))991
1291 y('b)991 1390 y('\(a)f(b\)\))555 1490 y(NIL)555
1676 y FA(This)29 b(amounts)g(to)g(asking)g(\223Is)g
Fs(a)h FA(before)d Fs(b)j FA(in)f Fs(\(a)43 b(b\))p FA(?\224)56
b(If)29 b Fs(before)e FA(were)j(correct,)g(it)555 1781
y(w)o(ould)18 b(return)g(true.)28 b(Macroe)o(xpansion)16
b(sho)n(ws)j(what)g(really)f(happens:)28 b(the)19 b(e)n(v)n(aluation)e
(of)555 1885 y(the)j(\002rst)h(ar)o(gument)d(to)i Fs(<)h
FA(rearranges)d(the)i(list)i(to)e(be)g(searched)f(in)i(the)f(second.)
555 2067 y Fs(\(let)42 b(\(\(seq)f('\(a)i(b\)\)\))642
2166 y(\(<)g(\(position)d(\(progn)h(\(setq)g(seq)i('\(b)f(a\)\))g('a\))
1209 2266 y(seq\))773 2366 y(\(position)e('b)j(seq\)\)\))555
2552 y FA(T)-7 b(o)21 b(a)n(v)n(oid)f(this)i(problem,)d(it)i(will)h
(suf)n(\002ce)e(to)h(e)n(v)n(aluate)f(all)i(the)e(ar)o(guments)f
(\002rst)j(in)f(one)f(big)555 2656 y Fs(let)p FA(.)28
b(The)20 b(second)g(de\002nition)f(in)h(Figure)g(9.1)f(is)i(thus)f
(safe)h(from)e(capture.)680 2761 y(Unfortunately)-5 b(,)34
b(the)h Fs(let)e FA(technique)g(w)o(orks)h(only)g(in)g(a)h(narro)n(w)e
(range)h(of)g(cases:)555 2866 y(macros)20 b(where)659
3052 y(1.)41 b(all)20 b(the)h(ar)o(guments)d(at)i(risk)h(of)f(capture)f
(are)h(e)n(v)n(aluated)f(e)o(xactly)g(once,)g(and)659
3222 y(2.)41 b(none)19 b(of)i(the)g(ar)o(guments)e(need)h(to)h(be)g(e)n
(v)n(aluated)e(in)i(the)g(scope)g(of)f(bindings)g(estab\255)763
3327 y(lished)g(by)f(the)i(macro)e(sk)o(eleton.)555 3513
y(This)34 b(rules)f(out)h(a)g(great)f(man)o(y)f(macros.)69
b(The)33 b(proposed)e Fs(for)i FA(macro)g(violates)g(both)555
3618 y(conditions.)g(Ho)n(we)n(v)o(er)m(,)20 b(we)i(can)g(use)g(a)g(v)n
(ariation)e(of)i(this)g(scheme)g(to)g(mak)o(e)f(macros)g(lik)o(e)555
3723 y Fs(for)14 b FA(safe)i(from)e(capture:)26 b(to)15
b(wrap)g(its)h Fs(body)e FA(forms)g(within)h(a)h(lambda\255e)o
(xpression)11 b(outside)555 3827 y(of)20 b(an)o(y)f(locally)h(created)f
(bindings.)680 3932 y(Some)26 b(macros,)h(including)e(those)h(for)g
(iteration,)i(yield)e(e)o(xpansions)f(where)h(e)o(xpres\255)555
4036 y(sions)35 b(appearing)e(in)i(the)g(macro)f(call)h(will)h(be)f(e)n
(v)n(aluated)e(within)i(ne)n(wly)f(established)555 4141
y(bindings.)54 b(In)29 b(the)g(de\002nition)f(of)h Fs(for)p
FA(,)h(for)e(e)o(xample,)i(the)f(body)f(of)g(the)h(loop)g(must)g(be)555
4246 y(e)n(v)n(aluated)24 b(within)h(a)g Fs(do)g FA(created)g(by)f(the)
i(macro.)43 b(V)-9 b(ariables)25 b(occurring)d(in)k(the)f(body)f(of)555
4350 y(the)k(loop)f(are)h(thus)h(vulnerable)d(to)i(capture)f(by)h
(bindings)e(established)i(by)g(the)g Fs(do)p FA(.)52
b(W)-7 b(e)555 4455 y(can)27 b(protect)f(v)n(ariables)g(in)h(the)g
(body)f(from)g(such)h(capture)f(by)g(wrapping)f(the)i(body)f(in)h(a)555
4559 y(closure,)34 b(and,)f(within)f(the)f(loop,)j(instead)d(of)h
(inserting)f(the)g(e)o(xpressions)g(themselv)o(es,)555
4664 y(simply)20 b(funcalling)e(the)i(closure.)680 4769
y(Figure)14 b(9.2)h(sho)n(ws)g(a)h(v)o(ersion)e(of)h
Fs(for)g FA(which)g(uses)h(this)g(technique.)25 b(Since)16
b(the)f(closure)-2786 b Fq(\016)p 555 4839 1074 4 v 645
4894 a Fl(1)675 4918 y Fr(This)17 b(macro)h(is)g(used)f(only)i(as)e(an)
h(e)o(xample.)28 b(Really)19 b(it)f(should)h(neither)g(be)f
(implemented)i(as)e(a)g(macro,)f(nor)555 5001 y(use)g(the)h(inef)n
(\002cient)i(algorithm)f(that)f(it)g(does.)24 b(F)o(or)17
b(a)g(proper)h(de\002nition,)h(see)e(page)h(50.)p eop
%%Page: 127 140
127 139 bop 555 538 a Ft(9.6)624 b Fu(A)-8 b(V)n(OIDING)19
b(CAPTURE)f(BY)h(PRIOR)g(EV)-8 b(ALU)n(A)h(TION)564 b
FA(127)p 555 745 2678 4 v 553 2588 4 1844 v 605 886 a(V)-6
b(ulnerable)18 b(to)j(capture:)605 1052 y Fs(\(defmacro)40
b(for)i(\(\(var)g(start)f(stop\))h(&body)f(body\))692
1152 y(`\(do)h(\(\(,var)f(,start)g(\(1+)h(,var\)\))954
1252 y(\(limit)f(,stop\)\))910 1351 y(\(\(>)h(,var)g(limit\)\))823
1451 y(,@body\)\))605 1658 y FA(A)21 b(correct)e(v)o(ersion:)605
1825 y Fs(\(defmacro)40 b(for)i(\(\(var)g(start)f(stop\))h(&body)f
(body\))692 1924 y(`\(do)h(\(\(b)g(#'\(lambda)e(\(,var\))h(,@body\)\))
954 2024 y(\(count)g(,start)g(\(1+)h(count\)\))954 2123
y(\(limit)f(,stop\)\))910 2223 y(\(\(>)h(count)g(limit\)\))823
2323 y(\(funcall)e(b)j(count\)\)\))1157 2510 y FA(Figure)20
b(9.2:)29 b(A)-6 b(v)n(oiding)18 b(capture)h(with)i(a)f(closure.)p
3231 2588 V 555 2592 2678 4 v 555 2816 a(is)26 b(the)e(\002rst)i(thing)
e(made)g(by)h(the)f(e)o(xpansion)f(of)i(a)g Fs(for)p
FA(,)g(free)f(symbols)g(occurring)f(in)i(the)555 2920
y(body)20 b(will)i(all)g(refer)e(to)i(v)n(ariables)e(in)i(the)f(en)m
(vironment)d(of)j(the)g(macro)g(call.)32 b(No)n(w)22
b(the)f Fs(do)555 3025 y FA(communicates)14 b(with)i(its)h(body)e
(through)f(the)i(parameters)f(of)g(the)h(closure.)28
b(All)16 b(the)g(closure)555 3130 y(needs)24 b(to)h(kno)n(w)f(from)g
(the)h Fs(do)f FA(is)i(the)f(number)e(of)h(the)h(current)f(iteration,)h
(so)g(it)g(has)g(only)555 3234 y(one)20 b(parameter)m(,)e(the)i(symbol)
f(speci\002ed)h(as)h(the)f(inde)o(x)f(v)n(ariable)g(in)i(the)f(macro)f
(call.)680 3339 y(The)h(technique)f(of)i(wrapping)d(e)o(xpressions)i
(in)h(lambdas)f(is)i(not)e(a)h(uni)n(v)o(ersal)f(remedy)-5
b(.)555 3444 y(Y)c(ou)20 b(can)h(use)f(it)i(to)f(protect)f(a)h(body)e
(of)h(code,)g(b)n(ut)h(closures)f(w)o(on')o(t)g(be)g(an)o(y)g(use)h
(when,)f(for)555 3548 y(e)o(xample,)15 b(there)h(is)h(a)g(risk)f(of)g
(the)g(same)g(v)n(ariable)f(being)g(bound)g(twice)h(by)g(the)g(same)g
Fs(let)g FA(or)555 3653 y Fs(do)22 b FA(\(as)g(in)h(our)e(original)g
(brok)o(en)g Fs(for)p FA(\).)34 b(F)o(ortunately)-5 b(,)20
b(in)i(this)h(case,)g(by)f(re)n(writing)f Fs(for)g FA(to)555
3757 y(package)f(its)i(body)e(in)h(a)h(closure,)e(we)i(also)f
(eliminated)g(the)g(need)f(for)h(the)g Fs(do)g FA(to)g(establish)555
3862 y(bindings)27 b(for)h(the)g Fs(var)g FA(ar)o(gument.)52
b(The)28 b Fs(var)f FA(ar)o(gument)g(of)h(the)g(old)g
Fs(for)g FA(became)g(the)555 3967 y(parameter)f(of)g(the)h(closure)g
(and)f(could)g(be)h(replaced)f(in)h(the)g Fs(do)g FA(by)g(an)g(actual)g
(symbol,)555 4071 y Fs(count)p FA(.)34 b(So)22 b(the)g(ne)n(w)g
(de\002nition)f(of)h Fs(for)g FA(is)h(completely)d(immune)h(from)g
(capture,)h(as)h(the)555 4176 y(test)e(in)f(Section)g(9.3)g(will)h(sho)
n(w)-5 b(.)680 4280 y(The)27 b(disadv)n(antage)e(of)i(using)h(closures)
f(is)h(that)g(the)o(y)f(might)g(be)g(less)i(ef)n(\002cient.)50
b(W)-7 b(e)555 4385 y(could)30 b(be)h(introducing)d(another)h(function)
h(call.)61 b(Potentially)31 b(w)o(orse,)i(if)e(the)g(compiler)555
4490 y(doesn')o(t)22 b(gi)n(v)o(e)g(the)i(closure)e(dynamic)g(e)o
(xtent,)h(space)h(for)e(it)i(will)g(ha)n(v)o(e)f(to)h(be)f(allocated)f
(in)555 4594 y(the)e(heap)g(at)g(runtime.)p eop
%%Page: 128 141
128 140 bop 555 538 a FA(128)924 b Fu(V)-8 b(ARIABLE)18
b(CAPTURE)555 801 y Fw(9.6)99 b(A)-10 b(v)o(oiding)25
b(Captur)n(e)h(with)f(Gensyms)555 991 y FA(There)d(is)h(one)f(certain)g
(w)o(ay)h(to)f(a)n(v)n(oid)h(macro)e(ar)o(gument)f(capture:)33
b(replacing)21 b(capturable)555 1096 y(symbols)h(with)g(gensyms.)34
b(In)22 b(the)h(original)e(v)o(ersion)g(of)h Fs(for)p
FA(,)f(problems)g(arise)i(when)e(tw)o(o)555 1200 y(symbols)14
b(inadv)o(ertently)f(ha)n(v)o(e)h(the)h(same)g(name.)27
b(If)15 b(we)g(w)o(ant)g(to)g(a)n(v)n(oid)g(the)g(possibility)f(that)
555 1305 y(a)24 b(macro)g(sk)o(eleton)f(will)i(contain)e(a)h(symbol)f
(also)i(used)f(by)f(the)h(calling)g(code,)g(we)g(might)555
1410 y(hope)19 b(to)h(get)h(a)o(w)o(ay)f(with)g(using)g(only)f
(strangely)g(named)g(symbols)h(in)g(macro)f(de\002nitions:)555
1592 y Fs(\(defmacro)40 b(for)i(\(\(var)g(start)f(stop\))h(&body)f
(body\))478 b(;)43 b(wrong)642 1692 y(`\(do)f(\(\(,var)f(,start)g(\(1+)
i(,var\)\))904 1792 y(\(xsf2jsh)d(,stop\)\))860 1891
y(\(\(>)i(,var)g(xsf2jsh\)\))773 1991 y(,@body\)\))555
2178 y FA(b)n(ut)27 b(this)g(is)g(no)g(solution.)47 b(It)27
b(doesn')o(t)e(eliminate)h(the)h(b)n(ug,)g(just)g(mak)o(es)g(it)g(less)
h(lik)o(ely)e(to)555 2283 y(sho)n(w)-5 b(.)40 b(And)23
b(not)h(so)g(v)o(ery)f(less)i(lik)o(ely)f(at)g(that\227it')-5
b(s)25 b(still)g(possible)f(to)g(imagine)f(con\003icts)555
2388 y(arising)d(in)g(nested)g(instances)g(of)g(the)g(same)h(macro.)680
2492 y(W)-7 b(e)29 b(need)f(some)h(w)o(ay)f(to)h Ft(ensur)m(e)g
FA(that)f(a)h(symbol)f(is)i(unique.)53 b(The)28 b(Common)f(Lisp)555
2597 y(function)16 b Fs(gensym)g FA(e)o(xists)i(just)h(for)e(this)i
(purpose.)26 b(It)19 b(returns)e(a)h(symbol,)f(called)h(a)g
Ft(g)o(ensym,)-2786 b Fq(\016)555 2701 y FA(which)21
b(is)h(guaranteed)d(not)h(to)i(be)f Fs(eq)g FA(to)g(an)o(y)f(symbol)g
(either)h(typed)f(in)i(or)f(constructed)e(by)555 2806
y(a)i(program.)680 2911 y(Ho)n(w)j(can)h(Lisp)f(promise)g(this?)43
b(In)25 b(Common)e(Lisp,)j(each)e(package)g(k)o(eeps)g(a)h(list)h(of)
555 3015 y(all)k(the)g(symbols)g(kno)n(wn)e(in)i(that)g(package.)57
b(\(F)o(or)29 b(an)h(introduction)d(to)j(packages,)h(see)555
3120 y(page)25 b(381.\))44 b(A)26 b(symbol)f(which)g(is)i(on)e(the)g
(list)i(is)g(said)f(to)f(be)h Ft(interned)f FA(in)h(the)f(package.)555
3224 y(Each)14 b(call)i(to)f Fs(gensym)e FA(returns)h(a)h(unique,)f
(uninterned)f(symbol.)26 b(And)15 b(since)g(e)n(v)o(ery)f(symbol)555
3329 y(seen)28 b(by)f Fs(read)f FA(gets)i(interned,)g(no)f(one)g(could)
g(type)g(an)o(ything)e(identical)i(to)h(a)g(gensym.)555
3434 y(Thus,)20 b(if)g(you)f(be)o(gin)g(the)i(e)o(xpression)555
3616 y Fs(\(eq)42 b(\(gensym\))f(...)555 3804 y FA(there)20
b(is)h(no)f(w)o(ay)g(to)g(complete)f(it)i(that)g(will)f(cause)h(it)g
(to)f(return)f(true.)680 3904 y(Asking)13 b Fs(gensym)g
FA(to)i(mak)o(e)f(you)g(a)h(symbol)e(is)j(lik)o(e)e(taking)g(the)h
(approach)d(of)i(choosing)f(a)555 4003 y(strangely)k(named)g(symbol)g
(one)h(step)g(further)n(\227)p Fs(gensym)d FA(will)k(gi)n(v)o(e)e(you)g
(a)i(symbol)e(whose)555 4103 y(name)j(isn')o(t)f(e)n(v)o(en)h(in)g(the)
g(phone)f(book.)28 b(When)20 b(Lisp)g(has)g(to)h(display)e(a)i(gensym,)
555 4269 y Fs(>)43 b(\(gensym\))555 4369 y(#:G47)555
4540 y FA(what)29 b(it)g(prints)f(is)i(really)e(just)h(Lisp')-5
b(s)30 b(equi)n(v)n(alent)d(of)h(\223John)g(Doe,)-6 b(\224)30
b(an)f(arbitrary)e(name)555 4644 y(made)d(up)h(for)g(something)e(whose)
i(name)f(is)i(irrele)n(v)n(ant.)43 b(And)24 b(to)i(be)f(sure)g(that)g
(we)g(don')o(t)555 4749 y(ha)n(v)o(e)e(an)o(y)f(illusions)i(about)e
(this,)i(gensyms)f(are)g(displayed)f(preceded)g(by)h(a)g
(sharp\255colon,)555 4853 y(a)f(special)f(read\255macro)e(which)i(e)o
(xists)h(just)g(to)g(cause)f(an)g(error)g(if)h(we)f(e)n(v)o(er)g(try)g
(to)h(read)f(the)555 4958 y(gensym)e(in)h(again.)p eop
%%Page: 129 142
129 141 bop 555 538 a Ft(9.7)728 b Fu(A)-8 b(V)n(OIDING)19
b(CAPTURE)f(WITH)h(GENSYMS)669 b FA(129)p 555 745 2678
4 v 553 2589 4 1844 v 605 886 a(V)-6 b(ulnerable)18 b(to)j(capture:)605
1052 y Fs(\(defmacro)40 b(for)i(\(\(var)g(start)f(stop\))h(&body)f
(body\))692 1152 y(`\(do)h(\(\(,var)f(,start)g(\(1+)h(,var\)\))954
1252 y(\(limit)f(,stop\)\))910 1351 y(\(\(>)h(,var)g(limit\)\))823
1451 y(,@body\)\))605 1658 y FA(A)21 b(correct)e(v)o(ersion:)605
1825 y Fs(\(defmacro)40 b(for)i(\(\(var)g(start)f(stop\))h(&body)f
(body\))692 1924 y(\(let)h(\(\(gstop)f(\(gensym\)\)\))779
2024 y(`\(do)h(\(\(,var)f(,start)g(\(1+)i(,var\)\))1041
2123 y(\(,gstop)d(,stop\)\))997 2223 y(\(\(>)i(,var)g(,gstop\)\))910
2323 y(,@body\)\)\))1175 2510 y FA(Figure)20 b(9.3:)29
b(A)-6 b(v)n(oiding)18 b(capture)h(with)i Fs(gensym)p
FA(.)p 3231 2589 V 555 2592 2678 4 v 680 2816 a(In)32
b Fr(CL)-6 b(TL)p FA(2)32 b(Common)f(Lisp,)36 b(the)d(number)e(in)i(a)g
(gensym')-5 b(s)32 b(printed)g(representation)555 2921
y(comes)25 b(from)f Fs(*gensym-counter*)o FA(,)d(a)26
b(global)e(v)n(ariable)g(al)o(w)o(ays)i(bound)d(to)i(an)h(inte)o(ger)-5
b(.)555 3025 y(By)21 b(resetting)e(this)i(counter)e(we)h(can)g(cause)g
(tw)o(o)h(gensyms)e(to)i(print)e(the)h(same)555 3208
y Fs(>)43 b(\(setq)f(x)h(\(gensym\)\))555 3308 y(#:G48)555
3407 y(>)g(\(setq)f(*gensym-counter)o(*)c(48)k(y)i(\(gensym\)\))555
3507 y(#:G48)555 3607 y(>)f(\(eq)g(x)g(y\))555 3706 y(NIL)555
3894 y FA(b)n(ut)20 b(the)o(y)g(w)o(on')o(t)f(be)h(identical.)680
3998 y(Figure)14 b(9.3)h(contains)g(a)h(correct)f(de\002nition)g(of)g
Fs(for)g FA(using)g(gensyms.)27 b(No)n(w)15 b(there)g(is)i(no)555
4103 y Fs(limit)k FA(to)h(clash)h(with)f(symbols)g(in)h(forms)e(passed)
h(to)h(the)f(macro.)35 b(It)23 b(has)f(been)g(replaced)555
4208 y(by)f(a)h(symbol)e(gensymed)f(on)i(the)g(spot.)33
b(In)21 b(each)g(e)o(xpansion)e(of)i(the)g(macro,)g(the)g(place)g(of)
555 4312 y Fs(limit)e FA(will)i(be)f(tak)o(en)g(by)f(a)i(unique)e
(symbol)g(created)g(at)i(e)o(xpansion\255time.)680 4417
y(The)g(correct)g(de\002nition)f(of)i Fs(for)f FA(is)h(a)g(complicated)
e(one)i(to)f(produce)f(on)h(the)h(\002rst)g(try)-5 b(.)555
4522 y(Finished)20 b(code,)g(lik)o(e)g(a)h(\002nished)f(theorem,)f
(often)h(co)o(v)o(ers)f(up)h(a)h(lot)f(of)g(trial)h(and)f(error)-5
b(.)29 b(So)555 4626 y(don')o(t)c(w)o(orry)g(if)i(you)e(ha)n(v)o(e)h
(to)h(write)f(se)n(v)o(eral)g(v)o(ersions)g(of)g(a)h(macro.)46
b(T)-7 b(o)27 b(be)o(gin)e(writing)555 4731 y(macros)e(lik)o(e)h
Fs(for)p FA(,)g(you)f(may)g(w)o(ant)h(to)g(write)g(the)g(\002rst)h(v)o
(ersion)d(without)h(thinking)g(about)555 4835 y(v)n(ariable)17
b(capture,)f(and)h(then)h(to)f(go)h(back)e(and)i(mak)o(e)f(gensyms)f
(for)h(symbols)g(which)h(could)555 4940 y(be)i(in)m(v)n(olv)o(ed)e(in)j
(captures.)p eop
%%Page: 130 143
130 142 bop 555 538 a FA(130)924 b Fu(V)-8 b(ARIABLE)18
b(CAPTURE)555 801 y Fw(9.7)99 b(A)-10 b(v)o(oiding)25
b(Captur)n(e)h(with)f(P)o(ackages)555 991 y FA(T)-7 b(o)27
b(some)g(e)o(xtent,)g(it)h(is)g(possible)e(to)h(a)n(v)n(oid)g(capture)e
(by)i(de\002ning)e(macros)i(in)g(their)f(o)n(wn)555 1096
y(package.)i(If)20 b(you)f(create)h(a)h Fs(macros)d FA(package)h(and)g
(de\002ne)h Fs(for)f FA(there,)h(you)f(can)h(e)n(v)o(en)f(use)555
1200 y(the)h(de\002nition)f(gi)n(v)o(en)g(\002rst)555
1373 y Fs(\(defmacro)40 b(for)i(\(\(var)g(start)f(stop\))h(&body)f
(body\))642 1472 y(`\(do)h(\(\(,var)f(,start)g(\(1+)i(,var\)\))904
1572 y(\(limit)e(,stop\)\))860 1671 y(\(\(>)h(,var)g(limit\)\))773
1771 y(,@body\)\))555 1948 y FA(and)21 b(call)h(it)h(safely)e(from)g
(an)o(y)g(other)g(package.)32 b(If)21 b(you)g(call)h
Fs(for)f FA(from)g(another)f(package,)555 2053 y(say)34
b Fs(mycode)p FA(,)h(then)e(e)n(v)o(en)g(if)h(you)f(do)h(use)g
Fs(limit)e FA(as)j(the)e(\002rst)i(ar)o(gument,)g(it)f(will)h(be)555
2158 y Fs(mycode::limit)p FA(\227a)16 b(distinct)22 b(symbol)e(from)g
Fs(macros::limit)p FA(,)d(which)k(occurs)f(in)i(the)555
2262 y(macro)d(sk)o(eleton.)680 2367 y(Ho)n(we)n(v)o(er)m(,)j(packages)
g(do)i(not)f(pro)o(vide)f(a)i(v)o(ery)e(general)h(solution)f(to)i(the)g
(problem)e(of)555 2471 y(capture.)42 b(In)25 b(the)g(\002rst)h(place,)f
(macros)g(are)g(an)f(inte)o(gral)g(part)h(of)g(some)f(programs,)g(and)h
(it)555 2576 y(w)o(ould)g(be)h(incon)m(v)o(enient)d(to)j(ha)n(v)o(e)f
(to)i(separate)e(them)h(in)g(their)f(o)n(wn)h(package.)45
b(Second,)555 2681 y(this)28 b(approach)d(of)n(fers)h(no)h(protection)e
(against)h(capture)h(by)f(other)h(code)f(in)h(the)g Fs(macros)555
2785 y FA(package.)555 3036 y Fw(9.8)99 b(Captur)n(e)26
b(in)f(Other)h(Name\255Spaces)555 3227 y FA(The)14 b(pre)n(vious)g
(sections)g(ha)n(v)o(e)f(spok)n(en)g(of)g(cap)o(tur)o(e)h(as)f(if)h(it)
f(were)g(a)g(pro)o(blem)g(wh)o(ich)g(af)m(\003icted)555
3331 y(v)n(ariables)18 b(e)o(xclusi)n(v)o(ely)-5 b(.)26
b(Although)16 b(most)j(capture)e(is)i(v)n(ariable)e(capture,)h(the)g
(problem)f(can)555 3436 y(arise)k(in)f(Common)f(Lisp')-5
b(s)20 b(other)g(name\255spaces)f(as)i(well.)680 3540
y(Functions)c(may)h(also)h(be)g(locally)f(bound,)f(and)h(function)e
(bindings)h(are)i(equally)f(liable)555 3645 y(to)i(inadv)o(ertent)e
(capture.)28 b(F)o(or)20 b(e)o(xample:)555 3817 y Fs(>)43
b(\(defun)e(fn)i(\(x\))f(\(+)h(x)g(1\)\))555 3917 y(FN)555
4016 y(>)g(\(defmacro)d(mac)i(\(x\))h(`\(fn)f(,x\)\))555
4116 y(MAC)555 4216 y(>)h(\(mac)f(10\))555 4315 y(11)555
4415 y(>)h(\(labels)e(\(\(fn)h(\(y\))g(\(-)h(y)g(1\)\)\))729
4515 y(\(mac)f(10\)\))555 4614 y(9)555 4791 y FA(As)22
b(predicted)e(by)g(the)i(capture)e(rule,)g(the)i Fs(fn)e
FA(which)h(occurs)g(free)f(in)i(the)f(sk)o(eleton)f(of)h
Fs(mac)555 4896 y FA(is)27 b(at)f(risk)g(of)g(capture.)45
b(When)25 b Fs(fn)h FA(is)h(locally)e(rebound,)g Fs(mac)g
FA(returns)g(a)h(dif)n(ferent)e(v)n(alue)555 5001 y(than)c(it)h(does)f
(generally)-5 b(.)p eop
%%Page: 131 144
131 143 bop 555 538 a Ft(9.9)758 b Fu(CAPTURE)18 b(IN)h(O)n(THER)e(N)n
(AME)p Fv(\255)p Fu(SP)-5 b(A)n(CES)698 b FA(131)680
801 y(What)17 b(to)h(do)f(about)g(this)h(case?)29 b(When)17
b(the)h(symbol)e(at)i(risk)g(of)f(capture)g(is)h(the)g(name)f(of)555
905 y(a)j(b)n(uilt\255in)g(function)e(or)i(macro,)f(then)g(it')-5
b(s)21 b(reasonable)e(to)h(do)f(nothing.)28 b(In)19 b
Fr(CL)-6 b(TL)p FA(2)19 b(\(p.)h(260\))56 b Fq(\016)555
1010 y FA(if)25 b(the)f(name)g(of)g(an)o(ything)e(b)n(uilt\255in)i(is)i
(gi)n(v)o(en)d(a)i(local)f(function)f(or)h(macro)f(binding,)h(\223the)
555 1114 y(consequences)13 b(are)h(unde\002ned.")f(So)i(it)g(w)o
(ouldn')o(t)e(matter)h(what)h(your)f(macro)f(did\227an)o(yone)555
1219 y(who)k(rebinds)g(b)n(uilt\255in)h(functions)e(is)j(going)e(to)h
(ha)n(v)o(e)f(problems)g(with)h(more)f(than)g(just)i(your)555
1324 y(macros.)680 1428 y(Otherwise,)27 b(you)e(can)g(protect)h
(function)e(names)i(against)f(macro)g(ar)o(gument)f(capture)555
1533 y(the)29 b(same)h(w)o(ay)g(you)e(w)o(ould)h(protect)f(v)n(ariable)
h(names:)47 b(by)29 b(using)g(gensyms)g(as)h(names)555
1638 y(for)e(an)o(y)f(functions)g(gi)n(v)o(en)g(local)i(de\002nitions)e
(by)h(the)h(macro)e(sk)o(eleton.)53 b(A)-6 b(v)n(oiding)27
b(free)555 1742 y(symbol)c(capture,)h(as)g(in)g(the)g(case)h(abo)o(v)o
(e,)e(is)i(a)f(bit)h(more)e(dif)n(\002cult.)40 b(The)23
b(w)o(ay)h(to)g(protect)555 1847 y(v)n(ariables)g(against)h(free)g
(symbol)f(capture)h(w)o(as)h(to)f(gi)n(v)o(e)g(them)f(distinctly)h
(global)g(names:)555 1951 y(e.g.)15 b Fs(*warnings*)d
FA(instead)k(of)f Fs(w)p FA(.)28 b(This)16 b(solution)f(is)i(not)e
(practical)g(for)g(functions,)g(because)555 2056 y(there)29
b(is)i(no)f(con)m(v)o(ention)d(for)i(distinguishing)f(the)i(names)g(of)
f(global)g(functions\227most)555 2161 y(functions)35
b(are)h(global.)76 b(If)36 b(you')l(re)f(concerned)f(about)h(a)i(macro)
e(being)g(called)h(in)h(an)555 2265 y(en)m(vironment)12
b(where)i(a)h(function)f(it)h(needs)g(might)f(be)h(locally)f
(rede\002ned,)g(the)h(best)g(solution)555 2370 y(is)21
b(probably)d(to)i(put)g(your)f(code)h(in)g(a)h(distinct)f(package.)680
2474 y(Block\255names)e(are)i(also)g(liable)g(to)g(capture,)f(as)h(are)
g(the)g(tags)g(used)g(by)f Fs(go)h FA(and)f Fs(throw)p
FA(.)555 2579 y(When)13 b(your)g(macros)g(need)f(such)g(sym)o(bo)o(ls,)
d(you)k(should)g(use)g(gensym)o(s,)c(as)k(in)g(the)g(de\002nition)555
2684 y(of)20 b Fs(our-do)e FA(on)i(page)f(98.)680 2788
y(Remember)14 b(also)i(that)g(operators)e(lik)o(e)i Fs(do)g
FA(are)g(implicitly)f(enclosed)g(in)h(a)g(block)f(named)555
2893 y Fs(nil)p FA(.)33 b(Thus)21 b(a)i Fs(return)c FA(or)j
Fs(return-from)39 b(nil)21 b FA(within)g(a)i Fs(do)e
FA(returns)g(from)g(the)g Fs(do)p FA(,)h(not)555 2997
y(the)e(containing)e(e)o(xpression:)555 3180 y Fs(>)43
b(\(block)e(nil)729 3280 y(\(list)h('a)991 3379 y(\(do)g(\(\(x)h(1)g
(\(1+)f(x\)\)\))1165 3479 y(\(nil\))1078 3579 y(\(if)g(\(>)h(x)g(5\))
1252 3678 y(\(return-from)c(nil)j(x\))1252 3778 y(\(princ)f
(x\)\)\)\)\))555 3877 y(12345)555 3977 y(\(A)i(6\))555
4165 y FA(If)23 b Fs(do)g FA(didn')o(t)e(create)i(a)h(block)e(named)g
Fs(nil)p FA(,)h(this)g(e)o(xample)f(w)o(ould)g(ha)n(v)o(e)h(returned)e
(just)j Fs(6)p FA(,)555 4269 y(rather)19 b(than)h Fs(\(A)43
b(6\))p FA(.)680 4374 y(The)20 b(implicit)h(block)e(in)i
Fs(do)g FA(is)h(not)e(a)h(problem,)e(because)h Fs(do)h
FA(is)h(adv)o(ertised)d(to)i(beha)n(v)o(e)555 4479 y(this)d(w)o(ay)-5
b(.)28 b(Ho)n(we)n(v)o(er)m(,)16 b(you)h(should)f(realize)i(that)g(if)g
(you)e(write)i(macros)f(which)g(e)o(xpand)f(into)555
4583 y Fs(do)p FA(s,)30 b(the)o(y)d(will)i(capture)d(the)i(block)f
(name)h Fs(nil)p FA(.)51 b(In)28 b(a)g(macro)f(lik)o(e)i
Fs(for)p FA(,)f(a)h Fs(return)d FA(or)555 4688 y Fs(return-from)39
b(nil)19 b FA(will)i(return)e(from)f(the)i Fs(for)g FA(e)o(xpression,)e
(not)h(the)h(enclosing)f(block.)p eop
%%Page: 132 145
132 144 bop 555 538 a FA(132)924 b Fu(V)-8 b(ARIABLE)18
b(CAPTURE)555 801 y Fw(9.9)99 b(Wh)o(y)24 b(Bother?)555
991 y FA(Some)h(of)h(the)g(preceding)d(e)o(xamples)i(are)h(pretty)f
(pathological.)44 b(Looking)23 b(at)k(them,)f(one)555
1096 y(might)21 b(be)g(tempted)f(to)i(say)f(\223v)n(ariable)f(capture)g
(is)j(so)e(unlik)o(ely\227why)e(e)n(v)o(en)h(w)o(orry)h(about)555
1200 y(it?\224)43 b(There)23 b(are)h(tw)o(o)h(w)o(ays)g(to)g(answer)f
(this)h(question.)40 b(One)25 b(is)g(with)g(another)e(question:)555
1305 y(why)30 b(write)g(programs)f(with)h(small)h(b)n(ugs)f(when)g(you)
g(could)f(write)i(programs)d(with)j(no)555 1410 y(b)n(ugs?)680
1514 y(The)c(longer)f(answer)h(is)i(to)e(point)g(out)g(that)h(in)g
(real)f(applications)f(it')-5 b(s)29 b(dangerous)c(to)555
1619 y(assume)g(an)o(ything)f(about)g(the)i(w)o(ay)f(your)f(code)h
(will)h(be)f(used.)45 b(An)o(y)25 b(Lisp)g(program)e(has)555
1723 y(what)k(is)h(no)n(w)e(called)h(an)g(\223open)e(architecture.)-6
b(\224)48 b(If)27 b(you')l(re)e(writing)h(code)h(other)f(people)555
1828 y(will)c(use,)g(the)o(y)f(may)g(use)g(it)i(in)e(w)o(ays)h(you')l
(d)e(ne)n(v)o(er)g(anticipate.)32 b(And)21 b(it')-5 b(s)23
b(not)e(just)h(people)555 1933 y(you)d(ha)n(v)o(e)g(to)h(w)o(orry)f
(about.)28 b(Programs)19 b(write)h(programs)e(too.)28
b(It)21 b(may)e(be)h(that)g(no)f(human)555 2037 y(w)o(ould)g(write)i
(code)e(lik)o(e)555 2220 y Fs(\(before)41 b(\(progn)g(\(setq)g(seq)i
('\(b)f(a\)\))g('a\))904 2320 y('b)904 2419 y('\(a)g(b\)\))555
2607 y FA(b)n(ut)23 b(code)f(generated)f(by)h(programs)f(often)h(looks)
h(lik)o(e)g(this.)37 b(Ev)o(en)22 b(if)h(indi)n(vidual)e(macros)555
2711 y(generate)15 b(simple)h(and)f(reasonable\255looking)d(e)o
(xpansions,)j(once)h(you)f(be)o(gin)g(to)h(nest)h(macro)555
2816 y(calls,)34 b(the)c(e)o(xpansions)f(can)h(become)g(lar)o(ge)f
(programs)g(which)h(look)g(lik)o(e)h(nothing)d(an)o(y)555
2921 y(human)i(w)o(ould)g(write.)62 b(Under)30 b(such)g(circumstances,)
j(it)e(is)h(w)o(orth)f(defending)d(against)555 3025 y(cases,)21
b(ho)n(we)n(v)o(er)d(contri)n(v)o(ed,)g(which)h(might)h(mak)o(e)g(your)
f(macros)g(e)o(xpand)f(incorrectly)-5 b(.)680 3130 y(In)21
b(the)g(end,)g(a)n(v)n(oiding)g(v)n(ariable)f(capture)g(is)j(not)e(v)o
(ery)f(dif)n(\002cult)h(an)o(yw)o(ay)-5 b(.)31 b(It)22
b(soon)f(be\255)555 3234 y(comes)c(second\255nature.)25
b(The)17 b(classic)g(Common)f(Lisp)h Fs(defmacro)d FA(is)k(lik)o(e)g(a)
f(cook')-5 b(s)16 b(knife:)555 3339 y(an)k(ele)o(gant)f(idea)h(which)g
(seems)g(dangerous,)e(b)n(ut)i(which)g(e)o(xperts)f(use)i(with)f
(con\002dence.)p eop
%%Page: 133 146
133 145 bop 555 1610 a Fn(10)p 555 1872 2686 3 v 555
2131 a Fx(Other)42 b(Macr)m(o)f(Pitfalls)555 2568 y FA(Writing)31
b(macros)f(requires)g(an)g(e)o(xtra)h(de)o(gree)e(of)h(caution.)61
b(A)31 b(function)e(is)j(isolated)e(in)555 2672 y(its)25
b(o)n(wn)f(le)o(xical)f(w)o(orld,)i(b)n(ut)f(a)g(macro,)g(because)g(it)
g(is)h(e)o(xpanded)d(into)i(the)g(calling)g(code,)555
2777 y(can)f(gi)n(v)o(e)g(the)h(user)f(an)h(unpleasant)e(surprise)h
(unless)h(it)g(is)g(carefully)e(written.)40 b(Chapter)22
b(9)555 2882 y(e)o(xplained)c(v)n(ariable)h(capture,)g(the)h(biggest)g
(such)g(surprise.)29 b(This)20 b(chapter)f(discusses)i(four)555
2986 y(more)e(problems)g(to)h(a)n(v)n(oid)g(when)g(de\002ning)f
(macros.)555 3239 y Fw(10.1)99 b(Number)26 b(of)f(Ev)o(aluations)680
3430 y FA(Se)n(v)o(eral)13 b(incorrect)f(v)o(ersions)h(of)h
Fs(for)f FA(appeared)f(in)i(the)g(pre)n(vious)e(chapter)-5
b(.)27 b(Figure)13 b(10.1)555 3534 y(sho)n(ws)20 b(tw)o(o)h(more,)e
(accompanied)f(by)h(a)i(correct)e(v)o(ersion)g(for)h(comparison.)680
3639 y(Though)29 b(not)i(vulnerable)e(to)i(capture,)i(the)e(second)g
Fs(for)f FA(contains)h(a)g(b)n(ug.)62 b(It)32 b(will)555
3743 y(generate)15 b(an)i(e)o(xpansion)d(in)j(which)f(the)g(form)f
(passed)i(as)g Fs(stop)e FA(will)i(be)g(e)n(v)n(aluated)e(on)h(each)555
3848 y(iteration.)28 b(In)19 b(the)g(best)h(case,)g(this)g(kind)e(of)h
(macro)f(is)j(inef)n(\002cient,)d(repeatedly)g(doing)g(what)555
3953 y(it)25 b(could)f(ha)n(v)o(e)f(done)h(just)h(once.)41
b(If)24 b Fs(stop)g FA(has)g(side\255ef)n(fects,)h(the)f(macro)g(could)
f(actually)555 4057 y(produce)h(incorrect)i(results.)48
b(F)o(or)26 b(e)o(xample,)g(this)h(loop)f(will)h(ne)n(v)o(er)e
(terminate,)i(because)555 4162 y(the)20 b(goal)g(recedes)g(on)f(each)h
(iteration:)555 4344 y Fs(>)43 b(\(let)f(\(\(x)g(2\)\))729
4444 y(\(for)g(\(i)h(1)g(\(incf)f(x\)\))817 4544 y(\(princ)f(i\)\)\))
555 4643 y(1234567891011121)o(3..)o(.)680 4831 y FA(In)17
b(writing)g(macros)g(lik)o(e)h Fs(for)p FA(,)g(one)f(must)h(remember)e
(that)i(the)g(ar)o(guments)d(to)j(a)h(macro)555 4936
y(are)27 b(forms,)g(not)g(v)n(alues.)49 b(Depending)24
b(on)j(where)f(the)o(y)g(appear)g(in)h(the)g(e)o(xpansion,)f(the)o(y)
1835 5229 y(133)p eop
%%Page: 134 147
134 146 bop 555 538 a FA(134)858 b Fu(O)n(THER)18 b(MA)n(CR)n(O)g(PITF)
l(ALLS)p 555 745 2678 4 v 553 3369 4 2624 v 605 886 a
FA(A)j(correct)e(v)o(ersion:)605 1044 y Fs(\(defmacro)40
b(for)i(\(\(var)g(start)f(stop\))h(&body)f(body\))692
1144 y(\(let)h(\(\(gstop)f(\(gensym\)\)\))779 1243 y(`\(do)h(\(\(,var)f
(,start)g(\(1+)i(,var\)\))1041 1343 y(\(,gstop)d(,stop\)\))997
1443 y(\(\(>)i(,var)g(,gstop\)\))910 1542 y(,@body\)\)\))605
1766 y FA(Subject)20 b(to)g(multiple)g(e)n(v)n(aluations:)605
1932 y Fs(\(defmacro)40 b(for)i(\(\(var)g(start)f(stop\))h(&body)f
(body\))692 2032 y(`\(do)h(\(\(,var)f(,start)g(\(1+)h(,var\)\)\))910
2132 y(\(\(>)g(,var)g(,stop\)\))823 2231 y(,@body\)\))605
2439 y FA(Incorrect)18 b(order)h(of)h(e)n(v)n(aluation:)605
2605 y Fs(\(defmacro)40 b(for)i(\(\(var)g(start)f(stop\))h(&body)f
(body\))692 2705 y(\(let)h(\(\(gstop)f(\(gensym\)\)\))779
2804 y(`\(do)h(\(\(,gstop)e(,stop\))1041 2904 y(\(,var)h(,start)g(\(1+)
i(,var\)\)\))997 3003 y(\(\(>)f(,var)g(,gstop\)\))910
3103 y(,@body\)\)\))1126 3291 y FA(Figure)20 b(10.1:)28
b(Controlling)19 b(ar)o(gument)f(e)n(v)n(aluation.)p
3231 3369 V 555 3372 2678 4 v 555 3596 a(could)i(be)g(e)n(v)n(aluated)f
(more)h(than)g(once.)29 b(In)20 b(this)h(case,)g(the)f(solution)g(is)h
(to)g(bind)f(a)h(v)n(ariable)555 3701 y(to)f(the)h(v)n(alue)e(returned)
f(by)i(the)g Fs(stop)g FA(form,)e(and)i(refer)f(to)i(the)f(v)n(ariable)
f(during)g(the)h(loop.)680 3806 y(Unless)25 b(the)o(y)f(are)g(clearly)g
(intended)f(for)h(iteration,)h(macros)f(should)g(ensure)g(that)g(e)o
(x\255)555 3910 y(pressions)h(are)h(e)n(v)n(aluated)f(e)o(xactly)g(as)h
(man)o(y)f(times)h(as)h(the)o(y)e(appear)g(in)h(the)f(macro)g(call.)555
4015 y(There)k(are)h(ob)o(vious)e(cases)i(in)g(which)f(this)h(rule)g
(does)f(not)h(apply:)47 b(the)30 b(Common)e(Lisp)555
4119 y Fs(or)22 b FA(w)o(ould)g(be)g(much)f(less)j(useful)d(\(it)i(w)o
(ould)f(become)f(a)h(P)o(ascal)h Fs(or)p FA(\))f(if)g(all)h(its)h(ar)o
(guments)555 4224 y(were)f(al)o(w)o(ays)g(e)n(v)n(aluated.)36
b(But)23 b(in)g(such)g(cases)g(the)g(user)g(kno)n(ws)f(ho)n(w)g(man)o
(y)g(e)n(v)n(aluations)555 4329 y(to)f(e)o(xpect.)29
b(This)20 b(isn')o(t)h(so)f(with)h(the)g(second)e(v)o(ersion)g(of)i
Fs(for)p FA(:)29 b(the)21 b(user)f(has)h(no)f(reason)f(to)555
4433 y(suppose)24 b(that)h(the)g Fs(stop)f FA(form)f(is)j(e)n(v)n
(aluated)e(more)g(than)g(once,)h(and)g(in)g(f)o(act)g(there)f(is)i(no)
555 4538 y(reason)c(that)g(it)h(should)f(be.)36 b(A)23
b(macro)e(written)h(lik)o(e)h(the)f(second)g(v)o(ersion)f(of)h
Fs(for)g FA(is)i(most)555 4642 y(lik)o(ely)c(written)g(that)g(w)o(ay)h
(by)e(mistak)o(e.)680 4747 y(Unintended)h(multiple)h(e)n(v)n(aluation)g
(is)i(a)g(particularly)d(dif)n(\002cult)i(problem)f(for)g(macros)555
4852 y(b)n(uilt)33 b(on)f Fs(setf)p FA(.)65 b(Common)31
b(Lisp)i(pro)o(vides)e(se)n(v)o(eral)h(utilities)h(to)g(mak)o(e)f
(writing)g(such)555 4956 y(macros)20 b(easier)-5 b(.)29
b(The)20 b(problem,)e(and)i(the)g(solution,)f(are)h(discussed)g(in)h
(Chapter)e(12.)p eop
%%Page: 135 148
135 147 bop 555 538 a Ft(10.3)871 b Fu(ORDER)19 b(OF)g(EV)-8
b(ALU)n(A)h(TION)853 b FA(135)555 801 y Fw(10.2)99 b(Order)25
b(of)g(Ev)o(aluation)555 991 y FA(The)31 b(order)g(in)h(which)f(e)o
(xpressions)g(are)h(e)n(v)n(aluated,)h(though)d(not)h(as)i(important)d
(as)j(the)555 1096 y(number)16 b(of)i(times)g(the)o(y)f(are)h(e)n(v)n
(aluated,)f(can)g(sometimes)h(become)f(an)g(issue.)29
b(In)18 b(Common)555 1200 y(Lisp)i(function)f(calls,)i(ar)o(guments)d
(are)i(e)n(v)n(aluated)f(left\255to\255right:)555 1352
y Fs(>)43 b(\(setq)f(x)h(10\))555 1452 y(10)555 1551
y(>)g(\(+)g(\(setq)e(x)j(3\))e(x\))555 1651 y(6)555 1808
y FA(and)22 b(it)g(is)i(good)c(practice)i(for)f(macros)h(to)g(do)g(the)
g(same.)35 b(Macros)22 b(should)f(usually)g(ensure)555
1913 y(that)c(e)o(xpressions)f(are)h(e)n(v)n(aluated)e(in)i(the)g(same)
g(order)f(that)h(the)o(y)f(appear)g(in)h(the)g(macro)f(call.)680
2017 y(In)33 b(Figure)g(10.1,)j(the)e(third)g(v)o(ersion)e(of)i
Fs(for)f FA(also)i(contains)e(a)h(subtle)g(b)n(ug.)70
b(The)555 2122 y(parameter)22 b Fs(stop)h FA(will)i(be)e(e)n(v)n
(aluated)g(before)f Fs(start)p FA(,)h(e)n(v)o(en)g(though)f(the)o(y)h
(appear)g(in)h(the)555 2226 y(opposite)19 b(order)g(in)h(the)h(macro)e
(call:)555 2378 y Fs(>)43 b(\(let)f(\(\(x)g(1\)\))729
2478 y(\(for)g(\(i)h(x)g(\(setq)f(x)h(13\)\))773 2577
y(\(princ)e(i\)\)\))555 2677 y(13)555 2777 y(NIL)555
2934 y FA(This)14 b(macro)g(gi)n(v)o(es)f(a)i(disconcerting)d
(impression)h(of)h(going)f(back)h(in)g(time.)27 b(The)14
b(e)n(v)n(aluation)555 3038 y(of)24 b(the)f Fs(stop)g
FA(form)g(in\003uences)g(the)h(v)n(alue)f(returned)f(by)h(the)h
Fs(start)e FA(form,)i(e)n(v)o(en)e(though)555 3143 y(the)e
Fs(start)f FA(form)g(appears)g(\002rst)i(te)o(xtually)-5
b(.)680 3247 y(The)20 b(correct)f(v)o(ersion)g(of)i Fs(for)f
FA(ensures)g(that)g(its)i(ar)o(guments)c(will)j(be)g(e)n(v)n(aluated)e
(in)i(the)555 3352 y(order)e(in)h(which)g(the)o(y)f(appear:)555
3504 y Fs(>)43 b(\(let)f(\(\(x)g(1\)\))729 3603 y(\(for)g(\(i)h(x)g
(\(setq)f(x)h(13\)\))773 3703 y(\(princ)e(i\)\)\))555
3803 y(1234567891011121)o(3)555 3902 y(NIL)555 4059 y
FA(No)n(w)16 b(setting)h Fs(x)f FA(in)h(the)f Fs(stop)f
FA(form)h(has)g(no)g(ef)n(fect)g(on)g(the)h(v)n(alue)e(returned)g(by)h
(the)g(pre)n(vious)555 4164 y(ar)o(gument.)680 4268 y(Although)21
b(the)i(preceding)e(e)o(xample)h(is)i(a)f(contri)n(v)o(ed)e(one,)i
(there)g(are)g(cases)h(in)f(which)555 4373 y(this)31
b(sort)f(of)g(problem)f(might)g(really)h(happen,)h(and)f(such)g(a)h(b)n
(ug)e(w)o(ould)h(be)g(e)o(xtremely)555 4478 y(dif)n(\002cult)20
b(to)h(\002nd.)31 b(Perhaps)21 b(fe)n(w)f(people)g(w)o(ould)g(write)h
(code)f(in)h(which)g(the)g(e)n(v)n(aluation)e(of)555
4582 y(one)d(ar)o(gument)e(to)j(a)g(macro)f(in\003uenced)f(the)i(v)n
(alue)f(returned)e(by)j(another)m(,)e(b)n(ut)i(people)e(may)555
4687 y(do)21 b(by)g(accident)g(things)g(that)g(the)o(y)g(w)o(ould)g(ne)
n(v)o(er)f(do)h(on)g(purpose.)32 b(As)22 b(well)g(as)g(ha)n(ving)e(to)
555 4791 y(w)o(ork)g(right)h(when)f(used)h(as)h(intended,)d(a)j
(utility)f(must)g(not)g(mask)f(b)n(ugs.)32 b(If)21 b(an)o(yone)e(wrote)
555 4896 y(code)d(lik)o(e)h(the)f(fore)o(going)e(e)o(xamples,)i(it)h(w)
o(ould)f(probably)f(be)h(by)g(mistak)o(e,)h(b)n(ut)g(the)g(correct)555
5001 y(v)o(ersion)i(of)h Fs(for)f FA(will)i(mak)o(e)f(the)g(mistak)o(e)
g(easier)h(to)f(detect.)p eop
%%Page: 136 149
136 148 bop 555 538 a FA(136)858 b Fu(O)n(THER)18 b(MA)n(CR)n(O)g(PITF)
l(ALLS)555 801 y Fw(10.3)99 b(Non\255functional)26 b(Expanders)555
991 y FA(Lisp)e(e)o(xpects)e(code)h(which)g(generates)f(macro)h(e)o
(xpansions)e(to)j(be)f(purely)f(functional,)g(in)555
1096 y(the)j(sense)f(described)g(in)g(Chapter)g(3.)42
b(Expander)23 b(code)g(should)h(depend)f(on)h(nothing)f(b)n(ut)555
1200 y(the)i(forms)g(passed)g(to)h(it)g(as)g(ar)o(guments,)e(and)h
(should)f(not)h(try)g(to)h(ha)n(v)o(e)f(an)g(ef)n(fect)g(on)g(the)555
1305 y(w)o(orld)20 b(e)o(xcept)f(by)h(returning)e(v)n(alues.)680
1410 y(As)d(of)g Fr(CL)-6 b(TL)p FA(2)13 b(\(p.)i(685\),)f(it)i(is)f
(safe)g(to)g(assume)g(that)g(macro)f(calls)h(in)g(compiled)f(code)g
(will)555 1514 y(not)25 b(be)h(re\255e)o(xpanded)c(at)27
b(runtime.)44 b(Otherwise,)27 b(Common)d(Lisp)i(mak)o(es)g(no)f
(guarantees)555 1619 y(about)17 b(when,)g(or)g(ho)n(w)g(often,)g(a)h
(macro)f(call)h(will)g(be)f(e)o(xpanded.)26 b(It)18 b(is)g(considered)e
(an)i(error)555 1723 y(for)k(the)g(e)o(xpansion)e(of)i(a)h(macro)e(to)i
(v)n(ary)e(depending)f(on)i(either)-5 b(.)35 b(F)o(or)22
b(e)o(xample,)g(suppose)555 1828 y(we)k(w)o(anted)f(to)h(count)e(the)i
(number)e(of)h(times)h(some)f(macro)g(is)i(used.)45 b(W)-7
b(e)26 b(can')o(t)f(simply)555 1933 y(do)f(a)h(search)g(through)d(the)j
(source)f(\002les,)i(because)e(the)h(macro)e(might)h(be)h(called)f(in)h
(code)555 2037 y(which)20 b(is)h(generated)d(by)i(the)g(program.)27
b(W)-7 b(e)21 b(might)f(therefore)e(w)o(ant)i(to)h(de\002ne)e(the)i
(macro)555 2142 y(as)g(follo)n(ws:)555 2324 y Fs(\(defmacro)40
b(nil!)i(\(x\))1568 b(;)43 b(wrong)642 2424 y(\(incf)f(*nil!s*\))642
2524 y(`\(setf)f(,x)i(nil\)\))555 2711 y FA(W)m(ith)31
b(this)g(de\002nition,)g(the)g(global)e Fs(*nil!s*)g
FA(will)i(be)f(incremented)f(each)h(time)g(a)h(call)555
2816 y(to)c Fs(nil!)f FA(is)i(e)o(xpanded.)46 b(Ho)n(we)n(v)o(er)m(,)27
b(we)g(are)g(mistak)o(en)f(if)h(we)h(e)o(xpect)d(the)i(v)n(alue)f(of)h
(this)555 2920 y(v)n(ariable)h(to)h(tell)h(us)g(ho)n(w)f(often)f
Fs(nil!)g FA(w)o(as)i(called.)56 b(A)30 b(gi)n(v)o(en)e(call)i(can)f
(be,)i(and)d(often)555 3025 y(is,)37 b(e)o(xpanded)30
b(more)i(than)h(once.)67 b(F)o(or)32 b(e)o(xample,)j(a)e(preprocessor)e
(which)h(performed)555 3130 y(transformations)20 b(on)i(your)g(source)f
(code)h(might)g(ha)n(v)o(e)g(to)h(e)o(xpand)d(the)j(macro)f(calls)h(in)
g(an)555 3234 y(e)o(xpression)c(before)f(it)j(could)f(decide)f(whether)
g(or)h(not)g(to)g(transform)f(it.)680 3339 y(As)32 b(a)g(general)f
(rule,)j(e)o(xpander)c(code)h(shouldn')o(t)e(depend)i(on)g(an)o(ything)
f(e)o(xcept)h(its)555 3443 y(ar)o(guments.)f(So)22 b(an)o(y)e(macro)g
(which)h(b)n(uilds)g(its)h(e)o(xpansion)e(out)g(of)h(strings,)h(for)e
(e)o(xample,)555 3548 y(should)k(be)i(careful)e(not)h(to)g(assume)h(an)
o(ything)d(about)h(what)h(the)h(package)d(will)k(be)e(at)h(the)555
3653 y(time)20 b(of)g(e)o(xpansion.)27 b(This)21 b(concise)f(b)n(ut)g
(rather)f(pathological)f(e)o(xample,)555 3835 y Fs(\(defmacro)40
b(string-call)f(\(opstring)h(&rest)h(args\))478 b(;)43
b(wrong)642 3935 y(`\(,\(intern)d(opstring\))f(,@args\)\))555
4122 y FA(de\002nes)19 b(a)g(macro)f(which)h(tak)o(es)g(the)g(print)g
(name)f(of)h(an)g(operator)e(and)h(e)o(xpands)g(into)h(a)g(call)555
4227 y(to)h(it:)555 4410 y Fs(>)43 b(\(defun)e(our+)h(\(x)h(y\))g(\(+)f
(x)i(y\)\))555 4509 y(OUR+)555 4609 y(>)f(\(string-call)c("OUR+")i(2)i
(3\))555 4708 y(5)555 4896 y FA(The)15 b(call)h(to)g
Fs(intern)e FA(tak)o(es)h(a)h(string)g(and)f(returns)f(the)i
(corresponding)c(symbol.)27 b(Ho)n(we)n(v)o(er)m(,)555
5001 y(if)21 b(we)h(omit)e(the)h(optional)f(package)f(ar)o(gument,)g
(it)i(does)g(so)g(in)g(the)g(current)f(package.)30 b(The)p
eop
%%Page: 137 150
137 149 bop 555 538 a Ft(10.3)766 b Fu(NON)p Fv(\255)p
Fu(FUNCTION)n(AL)18 b(EXP)-5 b(ANDERS)748 b FA(137)555
801 y(e)o(xpansion)16 b(will)j(thus)f(depend)e(on)i(the)g(package)e(at)
j(the)f(time)g(the)g(e)o(xpansion)e(is)j(generated,)555
905 y(and)31 b(unless)g Fs(our+)f FA(is)j(visible)e(in)g(that)h
(package,)g(the)f(e)o(xpansion)f(will)i(be)f(a)g(call)h(to)g(an)555
1010 y(unkno)n(wn)18 b(function.)680 1114 y(Miller)30
b(and)g(Benson')-5 b(s)30 b Ft(Lisp)h(Style)g(and)e(Design)h
FA(mentions)g(one)g(particularly)e(ugly)57 b Fq(\016)555
1219 y FA(e)o(xample)29 b(of)g(problems)g(arising)h(from)f(side\255ef)n
(fects)g(in)h(e)o(xpander)e(code.)58 b(In)30 b(Common)555
1324 y(Lisp,)20 b(as)i(of)e Fr(CL)-6 b(TL)p FA(2)19 b(\(p.)h(78\),)g
(the)g(lists)i(bound)d(to)h Fs(&rest)f FA(parameters)g(are)i(not)f
(guaranteed)555 1428 y(to)e(be)g(freshly)g(made.)27 b(The)o(y)17
b(may)h(share)g(structure)f(with)h(lists)i(else)n(where)e(in)g(the)g
(program.)555 1533 y(In)24 b(consequence,)f(you)h(shouldn')o(t)e
(destructi)n(v)o(ely)h(modify)g Fs(&rest)g FA(parameters,)h(because)555
1638 y(you)19 b(don')o(t)g(kno)n(w)g(what)h(else)h(you')o(ll)e(be)h
(modifying.)680 1742 y(This)h(possibility)g(af)n(fects)g(both)g
(functions)f(and)g(macros.)32 b(W)m(ith)22 b(functions,)e(problems)555
1847 y(w)o(ould)j(arise)h(when)e(using)h Fs(apply)p FA(.)38
b(In)23 b(a)h(v)n(alid)f(implementation)e(of)j(Common)e(Lisp)i(the)555
1951 y(follo)n(wing)g(could)i(happen.)45 b(Suppose)25
b(we)h(de\002ne)g(a)g(function)f Fs(et-al)p FA(,)g(which)h(returns)f(a)
555 2056 y(list)c(of)f(its)h(ar)o(guments)e(with)h Fs(et)43
b(al)20 b FA(added)f(to)h(the)g(end:)555 2239 y Fs(\(defun)41
b(et-al)h(\(&rest)f(args\))642 2338 y(\(nconc)g(args)h(\(list)g('et)g
('al\)\)\))555 2526 y FA(If)20 b(we)h(called)f(this)g(function)f
(normally)-5 b(,)18 b(it)j(w)o(ould)e(seem)h(to)h(w)o(ork)e(\002ne:)555
2708 y Fs(>)43 b(\(et-al)e('smith)g('jones\))555 2808
y(\(SMITH)g(JONES)h(ET)g(AL\))555 2996 y FA(Ho)n(we)n(v)o(er)m(,)18
b(if)j(we)f(called)g(it)h(via)f Fs(apply)p FA(,)f(it)i(could)e(alter)h
(e)o(xisting)g(data)g(structures:)555 3178 y Fs(>)43
b(\(setq)f(greats)f('\(leonardo)e(michelangelo\)\))555
3278 y(\(LEONARDO)h(MICHELANGELO\))555 3378 y(>)j(\(apply)e(#'et-al)g
(greats\))555 3477 y(\(LEONARDO)f(MICHELANGELO)e(ET)43
b(AL\))555 3577 y(>)g(greats)555 3677 y(\(LEONARDO)d(MICHELANGELO)e(ET)
43 b(AL\))555 3864 y FA(At)29 b(least,)h(a)f(v)n(alid)f(implementation)
e(of)h(Common)g(Lisp)i(could)e(do)g(this,)k(though)26
b(so)j(f)o(ar)555 3969 y(none)19 b(seems)i(to.)680 4073
y(F)o(or)c(macros,)g(the)h(danger)f(is)h(greater)-5 b(.)28
b(A)19 b(macro)d(which)i(altered)f(an)h Fs(&rest)e FA(parameter)555
4178 y(could)23 b(thereby)f(alter)h(the)h(macro)e(call.)40
b(That)23 b(is,)i(you)e(could)f(end)h(up)g(with)h(inadv)o(ertently)555
4283 y(self\255re)n(writing)18 b(programs.)27 b(The)19
b(danger)e(is)k(also)e(more)g(real\227it)g(actually)g(happens)f(under)
555 4387 y(e)o(xisting)i(implementations.)29 b(If)20
b(we)h(de\002ne)g(a)g(macro)e(which)i(nconcs)e(something)h(onto)g(its)
555 4492 y Fs(&rest)f FA(ar)o(gument)1109 4462 y Fm(1)555
4674 y Fs(\(defmacro)40 b(echo)i(\(&rest)f(args\))642
4774 y(`',\(nconc)f(args)i(\(list)f('amen\)\)\))p 555
4846 1074 4 v 645 4902 a Fl(1)675 4925 y Fk(`',\(foo\))18
b Fr(is)f(equi)n(v)n(alent)k(to)d Fk(`\(quote)37 b(,\(foo\)\))p
Fr(.)p eop
%%Page: 138 151
138 150 bop 555 538 a FA(138)858 b Fu(O)n(THER)18 b(MA)n(CR)n(O)g(PITF)
l(ALLS)555 801 y FA(and)i(then)f(de\002ne)h(a)h(function)d(that)i
(calls)h(it:)555 983 y Fs(\(defun)41 b(foo)h(\(\))h(\(echo)f(x\)\))555
1171 y FA(in)20 b(one)g(widely)g(used)g(Common)f(Lisp,)h(the)g(follo)n
(wing)e(will)j(happen:)555 1354 y Fs(>)43 b(\(foo\))555
1453 y(\(X)g(AMEN)f(AMEN\))555 1553 y(>)h(\(foo\))555
1652 y(\(X)g(AMEN)f(AMEN)g(AMEN\))555 1840 y FA(Not)22
b(only)e(does)i Fs(foo)f FA(return)f(the)i(wrong)e(result,)i(it)g
(returns)f(a)h(dif)n(ferent)e(result)h(each)h(time,)555
1945 y(because)e(each)f(macroe)o(xpansion)e(alters)k(the)f
(de\002nition)f(of)h Fs(foo)p FA(.)680 2049 y(This)d(e)o(xample)g(also)
h(illustrates)g(the)g(point)f(made)g(earlier)g(about)g(multiple)g(e)o
(xpansions)555 2154 y(of)d(a)h(gi)n(v)o(en)e(macro)h(call.)27
b(In)14 b(this)h(particular)f(implementation,)f(the)h(\002rst)h(call)g
(to)g Fs(foo)e FA(returns)555 2259 y(a)20 b(lists)g(with)f
Ft(two)h Fs(amen)p FA(s.)28 b(F)o(or)19 b(some)g(reason)f(this)i
(implementation)d(e)o(xpanded)f(the)k(macro)555 2363
y(call)h(once)e(when)h Fs(foo)f FA(w)o(as)i(de\002ned,)e(as)i(well)g
(as)g(once)e(in)i(each)e(of)h(the)h(succeeding)d(calls.)680
2468 y(It)i(w)o(ould)f(be)i(safer)f(to)g(ha)n(v)o(e)g(de\002ned)f
Fs(echo)g FA(as:)555 2650 y Fs(\(defmacro)40 b(echo)i(\(&rest)f(args\))
642 2750 y(`'\(,@args)f(amen\)\))555 2938 y FA(because)31
b(a)i(comma\255at)d(is)j(equi)n(v)n(alent)d(to)i(an)g
Fs(append)e FA(rather)h(than)h(an)g Fs(nconc)p FA(.)63
b(After)555 3042 y(rede\002ning)28 b(this)j(macro,)g
Fs(foo)e FA(will)i(ha)n(v)o(e)e(to)h(be)g(rede\002ned)f(as)h(well,)j(e)
n(v)o(en)c(if)h(it)h(w)o(asn')o(t)555 3147 y(compiled,)19
b(because)g(the)h(pre)n(vious)f(v)o(ersion)g(of)h Fs(echo)f
FA(caused)g(it)i(to)g(be)f(re)n(written.)680 3251 y(In)26
b(macros,)h(it')-5 b(s)28 b(not)e(only)g Fs(&rest)f FA(parameters)g
(which)h(are)h(subject)f(to)h(this)g(danger)-5 b(.)555
3356 y(An)o(y)25 b(macro)g(ar)o(gument)f(which)h(is)i(a)f(list)h
(should)e(be)g(left)i(alone.)45 b(If)26 b(we)g(de\002ne)f(a)i(macro)555
3461 y(which)20 b(modi\002es)f(one)h(of)g(its)h(ar)o(guments,)d(and)i
(a)g(function)f(which)g(calls)i(it,)555 3643 y Fs(\(defmacro)40
b(crazy)h(\(expr\))g(\(nconc)h(expr)g(\(list)f(t\)\)\))555
3843 y(\(defun)g(foo)h(\(\))h(\(crazy)e(\(list\)\)\))555
4030 y FA(then)18 b(the)g(source)g(code)g(of)g(the)g(calling)g
(function)f(could)h(get)g(modi\002ed,)f(as)i(happens)f(in)g(one)555
4135 y(implementation)g(the)i(\002rst)h(time)f(we)h(call)g(it:)555
4317 y Fs(>)43 b(\(foo\))555 4417 y(\(T)g(T\))555 4605
y FA(This)20 b(happens)f(in)i(compiled)d(as)j(well)g(as)g(interpreted)d
(code.)680 4709 y(The)d(upshot)f(is,)j(don')o(t)d(try)h(to)h(a)n(v)n
(oid)f(consing)f(by)h(destructi)n(v)o(ely)f(modifying)f(parameter)555
4814 y(list)22 b(structure.)32 b(The)21 b(resulting)g(programs)e(w)o
(on')o(t)h(be)i(portable,)e(if)h(the)o(y)g(run)f(at)i(all.)33
b(If)21 b(you)555 4919 y(w)o(ant)g(to)g(a)n(v)n(oid)g(consing)f(in)h(a)
g(function)e(which)i(tak)o(es)g(a)g(v)n(ariable)f(number)f(of)i(ar)o
(guments,)p eop
%%Page: 139 152
139 151 bop 555 538 a Ft(10.4)1046 b Fu(RECURSION)1028
b FA(139)555 801 y(one)21 b(solution)f(is)i(to)f(use)h(a)f(macro,)f
(and)h(thereby)f(shift)h(the)g(consing)f(forw)o(ard)g(to)h(compile\255)
555 905 y(time.)29 b(F)o(or)20 b(this)h(application)e(of)h(macros,)f
(see)i(Chapter)e(13.)680 1010 y(One)25 b(should)f(also)i(a)n(v)n(oid)g
(performing)c(destructi)n(v)o(e)i(operations)g(on)h(the)h(e)o
(xpressions)555 1114 y(returned)21 b(by)h(macro)g(e)o(xpanders,)f(if)i
(these)g(e)o(xpressions)e(incorporate)g(quoted)g(lists.)38
b(This)555 1219 y(is)25 b(not)f(a)g(restriction)f(on)h(macros)f
Ft(per)i(se)o(,)g FA(b)n(ut)f(an)g(instance)g(of)g(the)g(principle)f
(outlined)f(in)555 1324 y(Section)e(3.3.)555 1575 y Fw(10.4)99
b(Recursion)555 1765 y FA(Sometimes)21 b(it')-5 b(s)22
b(natural)f(to)g(de\002ne)g(a)h(function)d(recursi)n(v)o(ely)-5
b(.)31 b(There')-5 b(s)21 b(something)e(inher)n(\255)555
1870 y(ently)h(recursi)n(v)o(e)f(about)g(a)h(function)f(lik)o(e)h
(this:)555 2042 y Fs(\(defun)41 b(our-length)f(\(x\))642
2141 y(\(if)j(\(null)e(x\))817 2241 y(0)817 2340 y(\(1+)h(\(our-length)
d(\(cdr)j(x\)\)\)\)\))555 2517 y FA(This)25 b(de\002nition)f(someho)n
(w)f(seems)j(more)e(natural)g(\(though)e(probably)h(slo)n(wer\))h(than)
h(the)555 2622 y(iterati)n(v)o(e)19 b(equi)n(v)n(alent:)555
2794 y Fs(\(defun)41 b(our-length)f(\(x\))642 2893 y(\(do)j(\(\(len)e
(0)i(\(1+)g(len\)\))860 2993 y(\(y)g(x)g(\(cdr)f(y\)\)\))817
3093 y(\(\(null)84 b(y\))43 b(len\)\)\))680 3270 y FA(A)20
b(function)d(which)i(is)i(neither)d(recursi)n(v)o(e,)g(nor)h(part)g(of)
g(some)g(mutually)g(recursi)n(v)o(e)f(set)555 3374 y(of)k(functions,)e
(can)i(be)g(transformed)e(into)i(a)g(macro)f(by)h(the)g(simple)g
(technique)e(described)555 3479 y(in)d(Section)f(7.10.)26
b(Ho)n(we)n(v)o(er)m(,)16 b(just)g(inserting)g(backquotes)f(and)h
(commas)f(w)o(on')o(t)h(w)o(ork)f(with)555 3583 y(a)25
b(recursi)n(v)o(e)e(function.)39 b(Let')-5 b(s)25 b(tak)o(e)g(the)f(b)n
(uilt\255in)g Fs(nth)f FA(as)i(an)g(e)o(xample.)40 b(\(F)o(or)23
b(simplicity)-5 b(,)555 3688 y(our)27 b(v)o(ersions)g(of)g
Fs(nth)h FA(will)g(do)g(no)f(error)n(\255checking.\))48
b(Figure)27 b(10.2)g(sho)n(ws)h(a)g(mistak)o(en)555 3793
y(attempt)20 b(to)h(de\002ne)f Fs(nth)g FA(as)i(a)f(macro.)30
b(Super\002cially)-5 b(,)19 b Fs(nthb)g FA(appears)h(to)h(be)f(equi)n
(v)n(alent)f(to)555 3897 y Fs(ntha)p FA(,)27 b(b)n(ut)f(a)h(program)e
(containing)f(a)j(call)g(to)g Fs(nthb)f FA(w)o(ould)f(not)i(compile,)g
(because)f(the)555 4002 y(e)o(xpansion)18 b(of)i(the)g(call)h(w)o(ould)
e(ne)n(v)o(er)g(terminate.)680 4106 y(In)c(general,)g(it')-5
b(s)17 b(\002ne)e(for)g(macros)g(to)h(contain)e(references)g(to)i
(other)f(macros,)g(so)h(long)f(as)555 4211 y(e)o(xpansion)k(terminates)
h(some)n(where.)30 b(The)20 b(trouble)g(with)h Fs(nthb)e
FA(is)j(that)f(e)n(v)o(ery)f(e)o(xpansion)555 4316 y(contains)13
b(a)g(reference)g(to)g Fs(nthb)g FA(itself.)23 b(The)13
b(function)g(v)o(ersion,)d Fs(ntha)p FA(,)j(terminates)g(because)555
4420 y(it)36 b(recurses)e(on)g(the)h Ft(value)f FA(of)h
Fs(n)p FA(,)j(which)c(is)i(decremented)d(on)h(each)h(recursion.)71
b(But)555 4525 y(macroe)o(xpansion)15 b(only)j(has)i(access)f(to)g
(forms,)f(not)h(to)g(their)g(v)n(alues.)28 b(When)19
b(the)g(compiler)555 4630 y(tries)i(to)f(macroe)o(xpand,)d(say)-5
b(,)19 b Fs(\(nthb)42 b(x)h(y\))p FA(,)20 b(the)g(\002rst)h(e)o
(xpansion)d(will)j(yield)555 4801 y Fs(\(if)42 b(\(=)h(x)g(0\))729
4901 y(\(car)f(y\))729 5001 y(\(nthb)g(\(-)h(x)g(1\))g(\(cdr)e(y\)\)\))
p eop
%%Page: 140 153
140 152 bop 555 538 a FA(140)858 b Fu(O)n(THER)18 b(MA)n(CR)n(O)g(PITF)
l(ALLS)p 555 745 2678 4 v 553 2290 4 1545 v 605 886 a
FA(This)i(will)h(w)o(ork:)605 1052 y Fs(\(defun)41 b(ntha)h(\(n)h
(lst\))692 1152 y(\(if)f(\(=)h(n)g(0\))866 1252 y(\(car)f(lst\))866
1351 y(\(ntha)g(\(-)h(n)g(1\))g(\(cdr)e(lst\)\)\)\))605
1559 y FA(This)20 b(w)o(on')o(t)f(compile:)605 1725 y
Fs(\(defmacro)40 b(nthb)i(\(n)g(lst\))692 1825 y(`\(if)g(\(=)h(,n)f
(0\))910 1924 y(\(car)g(,lst\))910 2024 y(\(nthb)f(\(-)i(,n)g(1\))g
(\(cdr)f(,lst\)\)\)\))988 2211 y FA(Figure)20 b(10.2:)28
b(Mistak)o(en)20 b(analogy)f(to)h(a)h(recursi)n(v)o(e)d(function.)p
3231 2290 V 555 2293 2678 4 v 555 2507 a(which)i(will)h(in)f(turn)f(e)o
(xpand)g(into:)555 2676 y Fs(\(if)42 b(\(=)h(x)g(0\))729
2776 y(\(car)f(y\))729 2876 y(\(if)h(\(=)f(\(-)h(x)g(1\))g(0\))904
2975 y(\(car)f(\(cdr)g(y\)\))904 3075 y(\(nthb)f(\(-)i(\(-)g(x)g(1\))g
(1\))f(\(cdr)g(\(cdr)g(y\)\)\)\)\))555 3250 y FA(and)20
b(so)g(on)g(into)g(an)h(in\002nite)f(loop.)28 b(It')-5
b(s)21 b(\002ne)g(for)e(a)i(macro)e(to)i(e)o(xpand)d(into)i(a)h(call)g
(to)f(itself,)555 3354 y(just)h(so)f(long)g(as)h(it)f(doesn')o(t)f(al)o
(w)o(ays)i(do)f(so.)680 3459 y(The)14 b(dangerous)g(thing)g(ab)o(ou)o
(t)g(rec)o(ursi)n(v)n(e)g(m)o(acro)o(s)g(lik)o(e)g Fs(n)o(th)o(b)g
FA(is)g(th)o(at)g(the)n(y)g(u)o(sually)f(w)o(or)o(k)555
3563 y(\002ne)18 b(under)f(the)i(interpreter)-5 b(.)27
b(Then)18 b(when)g(you)f(\002nally)h(ha)n(v)o(e)g(your)f(program)f(w)o
(orking)h(and)555 3668 y(you)j(try)h(to)g(compile)f(it,)h(it)h(w)o(on')
o(t)e(e)n(v)o(en)g(compile.)30 b(Not)21 b(only)f(that,)h(b)n(ut)g
(there)f(will)i(usually)555 3773 y(be)j(no)f(indication)f(that)i(the)f
(problem)f(is)j(due)e(to)h(a)g(recursi)n(v)o(e)e(macro;)j(the)e
(compiler)g(will)555 3877 y(simply)c(go)g(into)g(an)g(in\002nite)g
(loop)f(and)h(lea)n(v)o(e)g(you)f(to)h(\002gure)g(out)g(what)g(went)g
(wrong.)680 3977 y(In)29 b(this)h(case,)j Fs(ntha)28
b FA(is)j(tail\255recursi)n(v)o(e.)56 b(A)30 b(tail\255recursi)n(v)o(e)
e(function)g(can)i(easily)g(be)555 4077 y(transformed)18
b(into)h(an)h(iterati)n(v)o(e)f(equi)n(v)n(alent,)f(and)h
Ft(then)g FA(used)h(as)g(a)h(model)e(for)g(a)h(macro.)28
b(A)555 4176 y(macro)19 b(lik)o(e)i Fs(nthb)e FA(could)g(be)h(written)
555 4332 y Fs(\(defmacro)40 b(nthc)i(\(n)h(lst\))642
4431 y(`\(do)f(\(\(n2)g(,n)h(\(1-)f(n2\)\))904 4531 y(\(lst2)f(,lst)h
(\(cdr)g(lst2\)\)\))860 4631 y(\(\(=)g(n2)h(0\))g(\(car)f(lst2\)\)\)\))
555 4791 y FA(so)20 b(it)h(is)g(not)f(impossible)f(in)h(principle)f(to)
h(duplicate)f(a)h(recursi)n(v)o(e)f(function)f(with)i(a)h(macro.)555
4896 y(Ho)n(we)n(v)o(er)m(,)k(transforming)d(more)j(complicated)f
(recursi)n(v)o(e)g(functions)g(could)g(be)h(dif)n(\002cult,)555
5001 y(or)20 b(e)n(v)o(en)f(impossible.)p eop
%%Page: 141 154
141 153 bop 555 538 a Ft(10.4)1046 b Fu(RECURSION)1028
b FA(141)p 555 745 2678 4 v 553 2466 4 1721 v 605 888
a Fs(\(defmacro)40 b(nthd)i(\(n)g(lst\))692 988 y(`\(nth-fn)e(,n)j
(,lst\)\))605 1187 y(\(defun)e(nth-fn)g(\(n)i(lst\))692
1287 y(\(if)f(\(=)h(n)g(0\))866 1386 y(\(car)f(lst\))866
1486 y(\(nth-fn)f(\(-)i(n)g(1\))g(\(cdr)f(lst\)\)\)\))605
1685 y(\(defmacro)e(nthe)i(\(n)g(lst\))692 1785 y(`\(labels)e
(\(\(nth-fn)h(\(n)h(lst\))1215 1884 y(\(if)g(\(=)h(n)g(0\))1389
1984 y(\(car)f(lst\))1389 2084 y(\(nth-fn)f(\(-)i(n)g(1\))g(\(cdr)f
(lst\)\)\)\)\))823 2183 y(\(nth-fn)e(,n)j(,lst\)\)\))1191
2388 y FA(Figure)19 b(10.3:)29 b(T)-7 b(w)o(o)20 b(w)o(ays)h(to)f
(\002x)h(the)f(problem.)p 3231 2466 V 555 2469 2678 4
v 680 2693 a(Depending)k(on)j(what)g(you)f(need)g(a)h(macro)f(for)m(,)i
(you)e(may)g(\002nd)h(it)h(suf)n(\002cient)e(to)h(use)555
2798 y(instead)i(a)g(combination)d(of)j(macro)e(and)i(function.)53
b(Figure)28 b(10.3)f(sho)n(ws)i(tw)o(o)g(w)o(ays)g(to)555
2902 y(mak)o(e)17 b(what)g(appears)f(to)h(be)g(a)h(recursi)n(v)o(e)d
(macro.)27 b(The)17 b(\002rst)h(strate)o(gy)-5 b(,)16
b(embodied)f(by)i Fs(nthd)p FA(,)555 3007 y(is)29 b(simply)e(to)h(mak)o
(e)g(the)g(macro)f(e)o(xpand)f(into)i(a)g(call)g(to)g(a)h(recursi)n(v)o
(e)d(function.)51 b(If,)29 b(for)555 3112 y(e)o(xample,)22
b(you)g(need)g(a)i(macro)e(only)g(to)h(sa)n(v)o(e)g(users)g(the)g
(trouble)f(of)h(quoting)e(ar)o(guments,)555 3216 y(then)f(this)g
(approach)e(should)i(suf)n(\002ce.)680 3321 y(If)30 b(you)g(need)h(a)g
(macro)f(because)g(you)g(w)o(ant)h(its)h(whole)e(e)o(xpansion)f(to)i
(be)g(inserted)555 3425 y(into)23 b(the)g(le)o(xical)f(en)m(vironment)e
(of)i(the)h(macro)f(call,)i(then)e(you)g(w)o(ould)h(more)f(lik)o(ely)g
(w)o(ant)555 3530 y(to)j(follo)n(w)g(the)g(e)o(xample)e(of)i
Fs(nthe)p FA(.)43 b(The)24 b(b)n(uilt\255in)h Fs(labels)e
FA(special)i(form)f(\(Section)h(2.7\))555 3635 y(creates)i(a)h(local)f
(function)e(de\002nition.)49 b(While)28 b(each)f(e)o(xpansion)e(of)i
Fs(nthc)f FA(will)i(call)g(the)555 3739 y(globally)k(de\002ned)g
(function)g Fs(nth-fn)p FA(,)i(each)f(e)o(xpansion)f(of)h
Fs(nthe)f FA(will)i(ha)n(v)o(e)f(its)h(o)n(wn)555 3844
y(v)o(ersion)19 b(of)h(such)g(a)g(function)f(within)h(it.)680
3948 y(Although)12 b(you)h(can')o(t)f(translate)i(a)g(recursi)n(v)o(e)f
(function)f(directly)h(into)h(a)g(macro,)g(you)f(can)555
4053 y(write)20 b(a)h(macro)e(whose)h(e)o(xpansion)e(is)j(recursi)n(v)o
(ely)e(generated.)27 b(The)20 b(e)o(xpansion)e(function)555
4158 y(of)e(a)h(macro)e(is)i(a)g(re)o(gular)d(Lisp)j(function,)e(and)g
(can)h(of)g(course)g(be)g(recursi)n(v)o(e.)26 b(F)o(or)16
b(e)o(xample,)555 4262 y(if)j(we)g(were)g(to)g(de\002ne)f(a)i(v)o
(ersion)d(of)i(the)g(b)n(uilt\255in)f Fs(or)p FA(,)g(we)i(w)o(ould)e(w)
o(ant)h(to)g(use)g(a)g(recursi)n(v)o(e)555 4367 y(e)o(xpansion)f
(function.)680 4471 y(Figure)f(10.4)g(sho)n(ws)i(tw)o(o)f(w)o(ays)h(of)
f(de\002ning)f(recursi)n(v)o(e)g(e)o(xpansion)f(functions)h(for)h
Fs(or)p FA(.)555 4576 y(The)h(macro)e Fs(ora)i FA(calls)g(the)g
(recursi)n(v)o(e)e(function)h Fs(or-expand)d FA(to)k(generate)f(its)i
(e)o(xpansion.)555 4681 y(This)i(macro)g(will)g(w)o(ork,)g(and)g(so)g
(will)h(the)f(equi)n(v)n(alent)f Fs(orb)p FA(.)34 b(Although)20
b Fs(orb)i FA(recurses,)g(it)555 4785 y(recurses)i(on)h(the)g(ar)o
(guments)e(to)i(the)g(macro)e(\(which)h(are)h(a)n(v)n(ailable)g(at)g
(macroe)o(xpansion)555 4890 y(time\),)31 b(not)d(upon)g(their)g(v)n
(alues)h(\(which)f(aren')o(t\).)53 b(It)30 b(might)e(seem)h(as)h(if)f
(the)g(e)o(xpansion)555 4995 y(w)o(ould)i(contain)g(a)i(reference)d(to)
i Fs(orb)g FA(itself,)j(b)n(ut)d(the)g(call)h(to)f Fs(orb)f
FA(generated)f(by)i(one)p eop
%%Page: 142 155
142 154 bop 555 538 a FA(142)858 b Fu(O)n(THER)18 b(MA)n(CR)n(O)g(PITF)
l(ALLS)p 555 745 2678 4 v 553 3063 4 2319 v 605 888 a
Fs(\(defmacro)40 b(ora)i(\(&rest)f(args\))692 988 y(\(or-expand)e
(args\)\))605 1187 y(\(defun)i(or-expand)f(\(args\))692
1287 y(\(if)i(\(null)g(args\))910 1386 y(nil)866 1486
y(\(let)g(\(\(sym)g(\(gensym\)\)\))954 1586 y(`\(let)f(\(\(,sym)g
(,\(car)h(args\)\)\))1084 1685 y(\(if)h(,sym)1259 1785
y(,sym)1259 1884 y(,\(or-expand)c(\(cdr)j(args\)\)\)\)\)\)\))605
2084 y(\(defmacro)e(orb)i(\(&rest)f(args\))692 2183 y(\(if)h(\(null)g
(args\))866 2283 y(nil)866 2383 y(\(let)g(\(\(sym)g(\(gensym\)\)\))954
2482 y(`\(let)f(\(\(,sym)g(,\(car)h(args\)\)\))1084 2582
y(\(if)h(,sym)1259 2681 y(,sym)1259 2781 y(\(orb)f(,@\(cdr)f
(args\)\)\)\)\)\)\))1158 2985 y FA(Figure)20 b(10.4:)28
b(Recursi)n(v)o(e)19 b(e)o(xpansion)f(functions.)p 3231
3063 V 555 3067 2678 4 v 555 3291 a(macroe)o(xpansion)23
b(step)k(will)g(be)g(replaced)e(by)i(a)g Fs(let)f FA(in)g(the)h(ne)o
(xt)f(one,)h(yielding)f(in)h(the)555 3396 y(\002nal)f(e)o(xpansion)e
(nothing)h(more)g(than)h(a)g(nested)g(stack)h(of)e Fs(let)p
FA(s;)k Fs(\(orb)42 b(x)h(y\))26 b FA(e)o(xpands)555
3500 y(into)20 b(code)f(equi)n(v)n(alent)g(to:)555 3683
y Fs(\(let)42 b(\(\(g2)g(x\)\))642 3782 y(\(if)h(g2)817
3882 y(g2)817 3982 y(\(let)e(\(\(g3)h(y\)\))904 4081
y(\(if)g(g3)h(g3)g(nil\)\)\)\))555 4269 y FA(In)29 b(f)o(act,)i
Fs(ora)d FA(and)h Fs(orb)f FA(are)h(equi)n(v)n(alent,)g(and)g(which)f
(style)i(to)f(use)g(is)h(just)g(a)f(matter)g(of)555 4374
y(personal)19 b(preference.)p eop
%%Page: 143 156
143 155 bop 555 1610 a Fn(11)p 555 1872 2686 3 v 555
2131 a Fx(Classic)41 b(Macr)m(os)555 2568 y FA(This)33
b(chapter)f(sho)n(ws)h(ho)n(w)g(to)g(de\002ne)g(the)g(most)g(commonly)e
(used)i(types)g(of)f(macros.)555 2672 y(The)o(y)26 b(f)o(all)i(into)f
(three)f(cate)o(gories\227with)g(a)i(f)o(air)f(amount)f(of)g(o)o(v)o
(erlap.)49 b(The)26 b(\002rst)i(group)555 2777 y(are)h(macros)f(which)h
(create)g(conte)o(xt.)55 b(An)o(y)28 b(operator)f(which)i(causes)g(its)
h(ar)o(guments)d(to)555 2882 y(be)d(e)n(v)n(aluated)e(in)i(a)h(ne)n(w)e
(conte)o(xt)g(will)h(probably)e(ha)n(v)o(e)h(to)h(be)g(de\002ned)f(as)h
(a)h(macro.)39 b(The)555 2986 y(\002rst)20 b(tw)o(o)g(sections)g
(describe)f(the)g(tw)o(o)h(basic)g(types)f(of)h(conte)o(xt,)e(and)h
(sho)n(w)g(ho)n(w)g(to)h(de\002ne)555 3091 y(macros)g(for)f(each.)680
3195 y(The)i(ne)o(xt)h(three)g(sections)g(describe)g(macros)f(for)h
(conditional)e(and)i(repeated)f(e)n(v)n(alua\255)555
3300 y(tion.)44 b(An)26 b(operator)d(whose)i(ar)o(guments)e(are)j(to)f
(be)g(e)n(v)n(aluated)f(less)j(than)e(once,)g(or)g(more)555
3405 y(than)18 b(once,)f(must)i(also)f(be)g(de\002ned)f(as)i(a)g
(macro.)27 b(There)18 b(is)h(no)e(sharp)h(distinction)f(between)555
3509 y(operators)24 b(for)g(conditional)f(and)i(repeated)f(e)n(v)n
(aluation:)38 b(some)25 b(of)g(the)g(e)o(xamples)f(in)h(this)555
3614 y(chapter)18 b(do)g(both)h(\(as)g(well)g(as)h(binding\).)27
b(The)18 b(\002nal)h(section)g(e)o(xplains)f(another)g(similarity)555
3718 y(between)27 b(conditional)f(and)h(repeated)g(e)n(v)n(aluation:)43
b(in)28 b(some)f(cases,)j(both)d(can)h(be)g(done)555
3823 y(with)20 b(functions.)555 4071 y Fw(11.1)99 b(Cr)n(eating)25
b(Context)555 4262 y FA(Conte)o(xt)f(here)f(has)i(tw)o(o)g(senses.)42
b(One)24 b(sort)h(of)f(conte)o(xt)f(is)i(a)g(le)o(xical)f(en)m
(vironment.)39 b(The)555 4367 y Fs(let)22 b FA(special)h(form)e
(creates)i(a)g(ne)n(w)f(le)o(xical)h(en)m(vironment;)e(the)h(e)o
(xpressions)g(in)g(the)h(body)555 4471 y(of)h(a)h Fs(let)e
FA(will)i(be)f(e)n(v)n(aluated)f(in)i(an)f(en)m(vironment)d(which)j
(may)f(contain)h(ne)n(w)g(v)n(ariables.)555 4576 y(If)c
Fs(x)g FA(is)i(set)f(to)f Fs(a)g FA(at)h(the)f(tople)n(v)o(el,)f(then)
555 4733 y Fs(\(let)42 b(\(\(x)g('b\)\))g(\(list)g(x\)\))555
4896 y FA(will)21 b(nonetheless)e(return)f Fs(\(b\))p
FA(,)h(because)h(the)g(call)g(to)g Fs(list)f FA(will)i(be)f(made)f(in)h
(an)g(en)m(viron\255)555 5001 y(ment)g(containing)e(a)j(ne)n(w)f
Fs(x)p FA(,)g(whose)g(v)n(alue)f(is)i Fs(b)p FA(.)1835
5229 y(143)p eop
%%Page: 144 157
144 156 bop 555 538 a FA(144)960 b Fu(CLASSIC)19 b(MA)n(CR)n(OS)p
555 745 2678 4 v 553 1868 4 1123 v 605 888 a Fs(\(defmacro)40
b(our-let)g(\(binds)h(&body)h(body\))692 988 y(`\(\(lambda)e(,\(mapcar)
g(#'\(lambda)g(\(x\))1694 1087 y(\(if)j(\(consp)e(x\))i(\(car)f(x\))g
(x\)\))1520 1187 y(binds\))866 1287 y(,@body\))779 1386
y(,@\(mapcar)e(#'\(lambda)g(\(x\))1389 1486 y(\(if)j(\(consp)e(x\))i
(\(cadr)e(x\))i(nil\)\))1215 1586 y(binds\)\)\))1165
1790 y FA(Figure)20 b(11.1:)28 b(Macro)20 b(implementation)e(of)h
Fs(let)p FA(.)p 3231 1868 V 555 1871 2678 4 v 680 2087
a(An)e(operator)f(which)h(is)i(to)e(ha)n(v)o(e)g(a)h(body)e(of)i(e)o
(xpressions)e(must)i(usually)f(be)g(de\002ned)g(as)555
2192 y(a)i(macro.)27 b(Except)18 b(for)g(cases)h(lik)o(e)g
Fs(prog1)e FA(and)g Fs(progn)p FA(,)g(the)i(purpose)e(of)h(such)g(an)g
(operator)555 2297 y(will)23 b(usually)f(be)g(to)h(cause)f(the)g(body)f
(to)i(be)f(e)n(v)n(aluated)f(in)h(some)g(ne)n(w)g(conte)o(xt.)35
b(A)23 b(macro)555 2401 y(will)d(be)f(needed)e(to)j(wrap)e(conte)o
(xt\255creating)e(code)i(around)f(the)i(body)-5 b(,)18
b(e)n(v)o(en)g(if)h(the)g(conte)o(xt)555 2506 y(does)h(not)g(include)f
(ne)n(w)h(le)o(xical)g(v)n(ariables.)680 2610 y(Figure)29
b(11.1)h(sho)n(ws)g(ho)n(w)g Fs(let)g FA(could)g(be)g(de\002ned)g(as)h
(a)g(macro)e(on)h Fs(lambda)p FA(.)59 b(An)555 2715 y
Fs(our-let)18 b FA(e)o(xpands)g(into)i(a)h(function)d(application\227)
555 2888 y Fs(\(our-let)40 b(\(\(x)j(1\))f(\(y)h(2\)\))642
2987 y(\(+)g(x)g(y\)\))555 3165 y FA(e)o(xpands)19 b(into)555
3337 y Fs(\(\(lambda)40 b(\(x)j(y\))g(\(+)g(x)g(y\)\))f(1)h(2\))680
3515 y FA(Figure)20 b(11.2)g(contains)h(three)g(ne)n(w)g(macros)f
(which)h(establish)h(le)o(xical)f(en)m(vironments.)555
3619 y(Section)16 b(7.5)g(used)g Fs(when-bind)d FA(as)18
b(an)e(e)o(xample)f(of)h(parameter)f(list)j(destructuring,)c(so)j(this)
555 3724 y(macro)26 b(has)h(already)f(been)g(described)f(on)i(page)f
(94.)49 b(The)26 b(more)g(general)g Fs(when-bind*)555
3829 y FA(tak)o(es)34 b(a)g(list)h(of)e(pairs)h(of)f(the)h(form)f
Fs(\()p Ft(symbol)42 b(e)n(xpr)m(ession)p Fs(\))p FA(\227the)33
b(same)h(form)e(as)j(the)555 3933 y(\002rst)d(ar)o(gument)c(to)k
Fs(let)p FA(.)61 b(If)30 b(an)o(y)h Ft(e)n(xpr)m(ession)g
FA(returns)f Fs(nil)p FA(,)j(the)e(whole)f Fs(when-bind*)555
4038 y FA(e)o(xpression)24 b(returns)h Fs(nil)p FA(.)44
b(Otherwise)25 b(its)i(body)d(will)i(be)g(e)n(v)n(aluated)e(with)i
(each)f Ft(symbol)555 4142 y FA(bound)18 b(as)j(if)g(by)e
Fs(let*)p FA(:)555 4315 y Fs(>)43 b(\(when-bind*)c(\(\(x)k(\(find-if)d
(#'consp)h('\(a)h(\(1)h(2\))f(b\)\)\))1209 4415 y(\(y)h(\(find-if)d
(#'oddp)h(x\)\)\))729 4514 y(\(+)i(y)g(10\)\))555 4614
y(11)680 4791 y FA(Finally)-5 b(,)24 b(the)g(macro)g
Fs(with-gensyms)19 b FA(is)26 b(itself)f(for)e(use)i(in)f(writing)g
(macros.)41 b(Man)o(y)555 4896 y(macro)20 b(de\002nitions)g(be)o(gin)f
(with)i(the)g(creation)f(of)g(gensyms,)g(sometimes)h(quite)f(a)h
(number)555 5001 y(of)f(them.)29 b(The)20 b(macro)f Fs(with-redraw)d
FA(\(page)j(115\))g(had)h(to)g(create)g(\002v)o(e:)p
eop
%%Page: 145 158
145 157 bop 555 538 a Ft(11.1)919 b Fu(CREA)-7 b(TING)18
b(CONTEXT)900 b FA(145)p 555 745 2678 4 v 553 2765 4
2020 v 605 888 a Fs(\(defmacro)40 b(when-bind)g(\(\(var)h(expr\))h
(&body)f(body\))692 988 y(`\(let)h(\(\(,var)f(,expr\)\))823
1087 y(\(when)g(,var)910 1187 y(,@body\)\)\))605 1386
y(\(defmacro)f(when-bind*)f(\(binds)i(&body)h(body\))692
1486 y(\(if)g(\(null)g(binds\))866 1586 y(`\(progn)f(,@body\))866
1685 y(`\(let)h(\(,\(car)f(binds\)\))997 1785 y(\(if)h(,\(caar)g
(binds\))1171 1884 y(\(when-bind*)d(,\(cdr)j(binds\))f
(,@body\)\)\)\)\))605 2084 y(\(defmacro)f(with-gensyms)e(\(syms)k
(&body)f(body\))692 2183 y(`\(let)h(,\(mapcar)e(#'\(lambda)g(\(s\))1520
2283 y(`\(,s)i(\(gensym\)\)\))1346 2383 y(syms\))823
2482 y(,@body\)\))1186 2686 y FA(Figure)19 b(11.2:)28
b(Macros)20 b(which)g(bind)f(v)n(ariables.)p 3231 2765
V 555 2768 2678 4 v 555 2992 a Fs(\(defmacro)40 b(with-redraw)f
(\(\(var)i(objs\))h(&body)f(body\))642 3092 y(\(let)h(\(\(gob)g
(\(gensym\)\))904 3191 y(\(x0)g(\(gensym\)\))e(\(y0)i(\(gensym\)\))904
3291 y(\(x1)g(\(gensym\)\))e(\(y1)i(\(gensym\)\)\))729
3391 y(...\)\))555 3578 y FA(Such)27 b(de\002nitions)h(are)f
(simpli\002ed)h(by)f Fs(with-gensyms)p FA(,)f(which)h(binds)g(a)i
(whole)e(list)i(of)555 3683 y(v)n(ariables)19 b(to)i(gensyms.)28
b(W)m(ith)21 b(the)f(ne)n(w)g(macro)f(we)i(w)o(ould)e(write)h(just:)555
3865 y Fs(\(defmacro)40 b(with-redraw)f(\(\(var)i(objs\))h(&body)f
(body\))642 3965 y(\(with-gensyms)d(\(gob)k(x0)h(y0)g(x1)g(y1\))729
4065 y(...\)\))555 4252 y FA(This)20 b(ne)n(w)g(macro)g(will)h(be)f
(used)g(throughout)d(the)j(remaining)e(chapters.)680
4357 y(If)27 b(we)h(w)o(ant)g(to)g(bind)f(some)g(v)n(ariables)g(and)g
(then,)i(depending)c(on)i(some)h(condition,)555 4462
y(e)n(v)n(aluate)19 b(one)h(of)g(a)g(set)h(of)f(e)o(xpressions,)f(we)i
(just)f(use)h(a)f(conditional)f(within)h(a)g Fs(let)p
FA(:)555 4644 y Fs(\(let)42 b(\(\(sun-place)d('park\))i(\(rain-place)e
('library\)\))642 4744 y(\(if)k(\(sunny\))817 4843 y(\(visit)e
(sun-place\))817 4943 y(\(visit)g(rain-place\)\)\))p
eop
%%Page: 146 159
146 158 bop 555 538 a FA(146)960 b Fu(CLASSIC)19 b(MA)n(CR)n(OS)p
555 745 2678 4 v 553 3462 4 2717 v 605 888 a Fs(\(defmacro)40
b(condlet)g(\(clauses)h(&body)g(body\))692 988 y(\(let)h(\(\(bodfn)f
(\(gensym\)\))954 1087 y(\(vars)g(\(mapcar)g(#'\(lambda)f(\(v\))i
(\(cons)f(v)j(\(gensym\)\)\))1564 1187 y(\(remove-duplicat)o(es)1651
1287 y(\(mapcar)d(#'car)2000 1386 y(\(mappend)f(#'cdr)h
(clauses\)\)\)\)\)\))779 1486 y(`\(labels)f(\(\(,bodfn)h(,\(mapcar)f
(#'car)i(vars\))1346 1586 y(,@body\)\))910 1685 y(\(cond)f(,@\(mapcar)f
(#'\(lambda)g(\(cl\))1782 1785 y(\(condlet-clause)d(vars)42
b(cl)h(bodfn\)\))1607 1884 y(clauses\)\)\)\)\))605 2084
y(\(defun)e(condlet-clause)d(\(vars)j(cl)i(bodfn\))692
2183 y(`\(,\(car)e(cl\))h(\(let)g(,\(mapcar)e(#'cdr)i(vars\))1302
2283 y(\(let)g(,\(condlet-binds)c(vars)j(cl\))1389 2383
y(\(,bodfn)g(,@\(mapcar)f(#'cdr)h(vars\)\)\)\)\)\))605
2681 y(\(defun)g(condlet-binds)d(\(vars)k(cl\))692 2781
y(\(mapcar)f(#'\(lambda)f(\(bindform\))1215 2881 y(\(if)i(\(consp)f
(bindform\))1389 2980 y(\(cons)h(\(cdr)g(\(assoc)f(\(car)h(bindform\))e
(vars\)\))1651 3080 y(\(cdr)i(bindform\)\)\)\))1041 3180
y(\(cdr)g(cl\)\)\))1160 3384 y FA(Figure)19 b(11.3:)29
b(Combination)18 b(of)i Fs(cond)f FA(and)h Fs(let)p FA(.)p
3231 3462 V 555 3465 2678 4 v 555 3689 a(Unfortunately)-5
b(,)35 b(there)f(is)h(no)f(con)m(v)o(enient)e(idiom)h(for)h(the)h
(opposite)e(situation,)k(where)555 3794 y(we)31 b(al)o(w)o(ays)g(w)o
(ant)g(to)g(e)n(v)n(aluate)f(the)h(same)g(code,)i(b)n(ut)d(where)h(the)
f Ft(bindings)g FA(must)h(v)n(ary)555 3899 y(depending)18
b(on)h(some)h(condition.)680 4003 y(Figure)36 b(11.3)f(contains)h(a)h
(macro)f(intended)f(for)i(such)f(situations.)79 b(As)37
b(its)h(name)555 4108 y(suggests,)h Fs(condlet)34 b FA(beha)n(v)o(es)h
(lik)o(e)h(the)g(of)n(fspring)e(of)h Fs(cond)g FA(and)g
Fs(let)p FA(.)76 b(It)36 b(tak)o(es)g(as)555 4212 y(ar)o(guments)28
b(a)i(list)h(of)f(binding)e(clauses,)k(follo)n(wed)c(by)i(a)g(body)f
(of)g(code.)58 b(Each)29 b(of)h(the)555 4317 y(binding)15
b(clauses)i(is)g(guarded)e(by)h(a)h(test)h(e)o(xpression;)e(the)h(body)
e(of)h(code)g(will)h(be)g(e)n(v)n(aluated)555 4422 y(with)d(the)f
(bindings)f(speci\002ed)h(by)g(the)h(\002rst)g(binding)e(clause)h
(whose)g(test)i(e)o(xpression)c(returns)555 4526 y(true.)33
b(V)-9 b(ariables)21 b(which)f(occur)h(in)g(some)h(clauses)g(and)e(not)
i(others)e(will)j(be)e(bound)f(to)h Fs(nil)555 4631 y
FA(if)f(the)h(successful)f(clause)g(does)g(not)g(specify)f(bindings)g
(for)h(them:)p eop
%%Page: 147 160
147 159 bop 555 538 a Ft(11.2)933 b Fu(THE)18 b Fo(with-)i
Fu(MA)n(CR)n(O)915 b FA(147)555 801 y Fs(>)43 b(\(condlet)d(\(\(\(=)i
(1)i(2\))e(\(x)h(\(princ)e('a\)\))h(\(y)h(\(princ)e('b\)\)\))1078
900 y(\(\(=)h(1)i(1\))e(\(y)h(\(princ)e('c\)\))h(\(x)h(\(princ)e
('d\)\)\))1078 1000 y(\(t)304 b(\(x)43 b(\(princ)e('e\)\))h(\(z)h
(\(princ)e('f\)\)\)\))729 1100 y(\(list)h(x)h(y)g(z\)\))555
1199 y(CD)555 1299 y(\(D)g(C)g(NIL\))680 1482 y FA(The)23
b(de\002nition)g(of)h Fs(condlet)e FA(can)i(be)g(understood)d(as)k(a)g
(generalization)c(of)j(the)g(def\255)555 1587 y(inition)g(of)h
Fs(our-let)p FA(.)41 b(The)25 b(latter)g(mak)o(es)g(its)h(body)d(into)i
(a)g(function,)f(which)h(is)h(applied)555 1691 y(to)20
b(the)g(results)g(of)g(e)n(v)n(aluating)e(the)i(initial\255v)n(alue)e
(forms.)29 b(A)20 b Fs(condlet)d FA(e)o(xpands)i(into)g(code)555
1796 y(which)24 b(de\002nes)g(a)g(local)g(function)f(with)h
Fs(labels)p FA(;)g(within)g(it)h(a)f Fs(cond)g FA(clause)g(determines)
555 1900 y(which)c(set)h(of)f(initial\255v)n(alue)e(forms)i(will)h(be)f
(e)n(v)n(aluated)f(and)g(passed)h(to)h(the)f(function.)680
2005 y(Notice)36 b(that)g(the)g(e)o(xpander)e(uses)j
Fs(mappend)d FA(instead)i(of)g Fs(mapcan)f FA(to)h(e)o(xtract)g(the)555
2110 y(v)n(ariable)21 b(names)h(from)g(the)g(binding)f(clauses.)36
b(This)22 b(is)i(because)d Fs(mapcan)g FA(is)i(destructi)n(v)o(e,)555
2214 y(and)d(as)h(Section)e(10.3)g(w)o(arned,)g(it)i(is)g(dangerous)d
(to)j(modify)d(parameter)h(list)i(structure.)555 2466
y Fw(11.2)99 b(The)26 b Fh(with-)g Fw(Macr)n(o)555 2657
y FA(There)h(is)i(another)d(kind)h(of)g(conte)o(xt)g(besides)h(a)g(le)o
(xical)f(en)m(vironment.)49 b(In)28 b(the)f(broader)555
2761 y(sense,)15 b(the)f(conte)o(xt)f(is)h(the)g(state)h(of)e(the)h(w)o
(orld,)g(including)e(the)i(v)n(alues)f(of)h(special)g(v)n(ariables,)555
2866 y(the)28 b(contents)g(of)g(data)g(structures,)i(and)e(the)g(state)
h(of)f(things)g(outside)g(Lisp.)54 b(Operators)555 2971
y(which)20 b(b)n(uild)g(this)h(kind)f(of)h(conte)o(xt)e(must)i(be)f
(de\002ned)g(as)h(macros)f(too,)g(unless)h(their)f(code)555
3075 y(bodies)g(are)g(to)g(be)g(packaged)e(up)i(in)g(closures.)680
3180 y(The)29 b(names)h(of)f(conte)o(xt\255b)n(uilding)e(macros)i
(often)g(be)o(gin)g(with)h Fs(with-)p FA(.)57 b(The)30
b(most)555 3284 y(commonly)d(used)h(macro)h(of)f(this)i(type)e(is)i
(probably)d Fs(with-open-file)p FA(.)50 b(Its)30 b(body)e(is)555
3389 y(e)n(v)n(aluated)19 b(with)h(a)h(ne)n(wly)e(opened)g(\002le)i
(bound)d(to)i(a)h(user)n(\255supplied)d(v)n(ariable:)555
3567 y Fs(\(with-open-file)37 b(\(s)43 b("dump")e(:direction)f
(:output\))642 3667 y(\(princ)h(99)i(s\)\))555 3850 y
FA(After)23 b(e)n(v)n(aluation)f(of)h(this)h(e)o(xpression)e(the)h
(\002le)h Fs("dump")e FA(will)i(automatically)e(be)h(closed,)555
3955 y(and)d(its)h(contents)e(will)i(be)f(the)h(tw)o(o)f(characters)f
Fs("99")p FA(.)680 4059 y(This)14 b(operator)g(clearly)g(has)g(to)g(b)o
(e)g(de\002n)o(ed)f(as)h(a)g(ma)o(cro)o(,)9 b(because)14
b(it)g(binds)g Fs(s)p FA(.)25 b(Ho)n(we)n(v)o(er)m(,)555
4164 y(operators)20 b(which)g(cause)h(forms)g(to)g(be)g(e)n(v)n
(aluated)f(in)h(a)h(ne)n(w)f(conte)o(xt)e(must)j(be)f(de\002ned)f(as)
555 4268 y(macros)c(an)o(yw)o(ay)-5 b(.)27 b(The)16 b
Fs(ignore-errors)c FA(macro,)17 b(ne)n(w)f(in)h Fr(CL)-6
b(TL)p FA(2,)17 b(causes)g(its)h(ar)o(guments)555 4373
y(to)34 b(be)f(e)n(v)n(aluated)f(as)i(if)g(in)f(a)h Fs(progn)p
FA(.)67 b(If)33 b(an)h(error)e(occurs)h(at)g(an)o(y)g(point,)j(the)d
(whole)555 4478 y Fs(ignore-errors)19 b FA(form)24 b(simply)g(returns)f
Fs(nil)p FA(.)41 b(\(This)24 b(w)o(ould)g(be)g(useful,)h(for)e(e)o
(xample,)555 4582 y(when)35 b(reading)e(input)i(typed)f(by)g(the)i
(user)-5 b(.\))74 b(Though)33 b Fs(ignore-errors)d FA(creates)35
b(no)555 4687 y(v)n(ariables,)20 b(it)h(still)h(must)f(be)f(de\002ned)g
(as)h(a)g(macro,)f(because)g(its)i(ar)o(guments)c(are)j(e)n(v)n
(aluated)555 4791 y(in)f(a)h(ne)n(w)f(conte)o(xt.)680
4896 y(Generally)-5 b(,)33 b(macros)f(which)g(create)g(conte)o(xt)g
(will)h(e)o(xpand)d(into)j(a)f(block)g(of)g(code;)555
5001 y(additional)24 b(e)o(xpressions)h(may)g(be)h(placed)f(before)f
(the)i(body)-5 b(,)25 b(after)h(it,)h(or)f(both.)45 b(If)25
b(code)p eop
%%Page: 148 161
148 160 bop 555 538 a FA(148)960 b Fu(CLASSIC)19 b(MA)n(CR)n(OS)555
801 y FA(occurs)32 b(after)g(the)h(body)-5 b(,)34 b(its)f(purpose)e
(may)i(be)f(to)h(lea)n(v)o(e)f(the)h(system)g(in)g(a)g(consistent)555
905 y(state\227to)26 b(clean)g(up)g(something.)45 b(F)o(or)25
b(e)o(xample,)h Fs(with-open-file)21 b FA(has)26 b(to)g(close)h(the)555
1010 y(\002le)22 b(it)g(opened.)30 b(In)21 b(such)g(situations,)g(it)h
(is)g(typical)e(to)i(mak)o(e)e(the)i(conte)o(xt\255creating)c(macro)555
1114 y(e)o(xpand)g(into)i(an)g Fs(unwind-protect)p FA(.)680
1219 y(The)30 b(purpose)f(of)i Fs(unwind-protect)26 b
FA(is)32 b(to)f(ensure)f(that)h(certain)f(e)o(xpressions)g(are)555
1324 y(e)n(v)n(aluated)19 b(e)n(v)o(en)g(if)h(e)o(x)o(ecution)e(is)j
(interrupted.)27 b(It)21 b(tak)o(es)f(one)g(or)g(more)f(ar)o(guments,)f
(which)555 1428 y(are)28 b(e)n(v)n(aluated)f(in)i(order)-5
b(.)53 b(If)29 b(all)g(goes)f(smoothly)f(it)i(will)h(return)d(the)h(v)n
(alue)g(of)g(the)h(\002rst)555 1533 y(ar)o(gument,)35
b(lik)o(e)f(a)g Fs(prog1)p FA(.)69 b(The)34 b(dif)n(ference)e(is,)38
b(the)c(remaining)e(ar)o(guments)g(will)j(be)555 1638
y(e)n(v)n(aluated)19 b(e)n(v)o(en)g(if)h(an)h(error)e(or)h(thro)n(w)f
(interrupts)g(e)n(v)n(aluation)f(of)i(the)g(\002rst.)555
1804 y Fs(>)43 b(\(setq)f(x)h('a\))555 1903 y(A)555 2003
y(>)g(\(unwind-protect)729 2103 y(\(progn)e(\(princ)h("What)f
(error?"\))1034 2202 y(\(error)h("This)f(error."\)\))729
2302 y(\(setq)h(x)h('b\)\))555 2401 y(What)f(error?)555
2501 y(>>Error:)e(This)i(error.)555 2672 y FA(The)21
b Fs(unwind-protect)15 b FA(form)20 b(as)i(a)g(whole)e(yields)h(an)g
(error)-5 b(.)31 b(Ho)n(we)n(v)o(er)m(,)19 b(after)i(returning)555
2777 y(to)f(the)h(tople)n(v)o(el,)d(we)j(notice)e(that)i(the)f(second)f
(ar)o(gument)f(still)j(got)f(e)n(v)n(aluated:)555 2948
y Fs(>)43 b(x)555 3053 y(B)555 3224 y FA(Because)26 b
Fs(with-open-file)21 b FA(e)o(xpands)k(into)g(an)i Fs(unwind-protect)p
FA(,)22 b(the)k(\002le)g(it)h(opens)555 3328 y(will)21
b(usually)f(be)g(closed)g(e)n(v)o(en)f(if)h(an)g(error)f(occurs)h
(during)e(the)j(e)n(v)n(aluation)d(of)i(its)h(body)-5
b(.)680 3433 y(Conte)o(xt\255creating)23 b(macros)i(are)h(mostly)f
(written)h(for)f(speci\002c)h(applications.)45 b(As)27
b(an)555 3538 y(e)o(xample,)h(suppose)e(we)i(are)f(writing)g(a)h
(program)d(which)i(deals)h(with)f(multiple,)h(remote)555
3642 y(databases.)42 b(The)25 b(program)d(talks)j(to)g(one)f(database)g
(at)h(a)g(time,)h(indicated)e(by)g(the)g(global)555 3747
y(v)n(ariable)17 b Fs(*db*)p FA(.)27 b(Before)17 b(using)g(a)h
(database,)g(we)g(ha)n(v)o(e)f(to)h(lock)f(it,)i(so)f(that)g(no)f(one)g
(else)i(can)555 3851 y(use)j(it)h(at)f(the)g(same)g(time.)34
b(When)22 b(we)g(are)g(\002nished)f(we)h(ha)n(v)o(e)f(to)h(release)g
(the)g(lock.)34 b(If)21 b(we)555 3956 y(w)o(ant)f(the)h(v)n(alue)e(of)h
(the)g(query)f Fs(q)h FA(on)g(the)g(database)g Fs(db)p
FA(,)g(we)g(might)g(say)g(something)f(lik)o(e:)555 4122
y Fs(\(let)42 b(\(\(temp)f(*db*\)\))642 4222 y(\(setq)h(*db*)g(db\))642
4321 y(\(lock)g(*db*\))642 4421 y(\(prog1)f(\(eval-query)e(q\))947
4521 y(\(release)i(*db*\))947 4620 y(\(setq)h(*db*)g(temp\)\)\))680
4791 y FA(W)m(ith)22 b(a)g(macro)f(we)h(can)g(hide)g(all)g(this)g
(bookk)o(eeping.)31 b(Figure)22 b(11.4)e(de\002nes)i(a)h(macro)555
4896 y(which)d(will)i(allo)n(w)e(us)h(to)g(deal)g(with)g(databases)f
(at)i(a)f(higher)e(le)n(v)o(el)i(of)f(abstraction.)30
b(Using)555 5001 y Fs(with-db)p FA(,)18 b(we)i(w)o(ould)g(say)g(just:)p
eop
%%Page: 149 162
149 161 bop 555 538 a Ft(11.2)933 b Fu(THE)18 b Fo(with-)i
Fu(MA)n(CR)n(O)915 b FA(149)p 555 745 2678 4 v 553 4083
4 3338 v 605 886 a(Pure)20 b(macro:)605 1052 y Fs(\(defmacro)40
b(with-db)g(\(db)j(&body)e(body\))692 1152 y(\(let)h(\(\(temp)f
(\(gensym\)\)\))779 1252 y(`\(let)h(\(\(,temp)e(*db*\)\))910
1351 y(\(unwind-protect)997 1451 y(\(progn)1084 1551
y(\(setq)i(*db*)g(,db\))1084 1650 y(\(lock)g(*db*\))1084
1750 y(,@body\))997 1849 y(\(progn)1084 1949 y(\(release)f(*db*\))1084
2049 y(\(setq)h(*db*)g(,temp\)\)\)\)\)\))605 2256 y FA(Combination)18
b(of)i(macro)f(and)h(function:)605 2422 y Fs(\(defmacro)40
b(with-db)g(\(db)j(&body)e(body\))692 2522 y(\(let)h(\(\(gbod)f
(\(gensym\)\)\))779 2622 y(`\(let)h(\(\(,gbod)e(#'\(lambda)g(\(\))j
(,@body\)\)\))910 2721 y(\(declare)d(\(dynamic-extent)e(,gbod\)\))910
2821 y(\(with-db-fn)h(*db*)j(,db)g(,gbod\)\)\)\))605
3020 y(\(defun)f(with-db-fn)e(\(old-db)i(new-db)g(body\))692
3120 y(\(unwind-protect)779 3219 y(\(progn)866 3319 y(\(setq)h(*db*)g
(new-db\))866 3419 y(\(lock)g(*db*\))866 3518 y(\(funcall)f(body\)\))
779 3618 y(\(progn)866 3717 y(\(release)g(*db*\))866
3817 y(\(setq)h(*db*)g(old-db\)\)\)\))1279 4005 y FA(Figure)19
b(11.4:)28 b(A)21 b(typical)f Fs(with-)f FA(macro.)p
3231 4083 V 555 4086 2678 4 v 555 4303 a Fs(\(with-db)40
b(db)642 4403 y(\(eval-query)f(q\)\))555 4582 y FA(Calling)d
Fs(with-db)e FA(is)j(also)f(safer)m(,)j(because)d(it)h(e)o(xpands)d
(into)i(an)g Fs(unwind-protect)555 4687 y FA(instead)20
b(of)g(a)g(simple)h Fs(prog1)p FA(.)680 4791 y(The)26
b(tw)o(o)h(de\002nitions)f(of)g Fs(with-db)f FA(in)h(Figure)g(11.4)g
(illustrate)h(tw)o(o)g(possible)f(w)o(ays)555 4896 y(to)d(write)h(this)
g(kind)e(of)h(macro.)38 b(The)23 b(\002rst)h(is)g(a)g(pure)e(macro,)h
(the)h(second)e(a)i(combination)555 5001 y(of)g(a)g(function)e(and)i(a)
g(macro.)40 b(The)23 b(second)g(approach)f(becomes)h(more)g(practical)h
(as)h(the)p eop
%%Page: 150 163
150 162 bop 555 538 a FA(150)960 b Fu(CLASSIC)19 b(MA)n(CR)n(OS)p
555 745 2678 4 v 553 2266 4 1522 v 605 888 a Fs(\(defmacro)40
b(if3)i(\(test)g(t-case)f(nil-case)f(?-case\))692 988
y(`\(case)h(,test)823 1087 y(\(\(nil\))g(,nil-case\))823
1187 y(\(?)217 b(,?-case\))823 1287 y(\(t)g(,t-case\)\)\))605
1486 y(\(defmacro)40 b(nif)i(\(expr)g(pos)g(zero)g(neg\))692
1586 y(\(let)g(\(\(g)g(\(gensym\)\)\))779 1685 y(`\(let)g(\(\(,g)g
(,expr\)\))910 1785 y(\(cond)f(\(\(plusp)g(,g\))h(,pos\))1171
1884 y(\(\(zerop)f(,g\))h(,zero\))1171 1984 y(\(t)h(,neg\)\)\)\)\))1104
2188 y FA(Figure)19 b(11.5:)28 b(Macros)20 b(for)g(conditional)e(e)n(v)
n(aluation.)p 3231 2266 V 555 2270 2678 4 v 555 2494
a(desired)i Fs(with-)e FA(macro)h(gro)n(ws)h(in)g(comple)o(xity)-5
b(.)680 2598 y(In)18 b Fr(CL)-6 b(TL)p FA(2)18 b(Common)g(Lisp,)h(the)g
Fs(dynamic-extent)14 b FA(declaration)j(allo)n(ws)i(the)g(closure)555
2703 y(containing)k(the)h(body)f(to)i(be)g(allocated)e(more)h(ef)n
(\002ciently)g(\(in)g Fr(CL)-6 b(TL)p FA(1)24 b(implementations,)555
2808 y(it)33 b(will)g(be)f(ignored\).)64 b(W)-7 b(e)33
b(only)f(need)f(this)i(closure)f(for)f(the)i(duration)d(of)i(the)h
(call)f(to)555 2912 y Fs(with-db-fn)p FA(,)15 b(and)j(the)h
(declaration)e(says)j(as)f(much,)f(allo)n(wing)g(the)g(compiler)g(to)h
(allocate)555 3017 y(space)h(for)f(it)i(on)e(the)h(stack.)29
b(This)20 b(space)g(will)h(be)e(reclaimed)g(automatically)f(on)i(e)o
(xit)g(from)555 3122 y(the)g Fs(let)g FA(e)o(xpression,)e(instead)i(of)
g(being)f(reclaimed)g(later)i(by)e(the)i(garbage\255collector)-5
b(.)555 3374 y Fw(11.3)99 b(Conditional)25 b(Ev)o(aluation)555
3565 y FA(Sometimes)33 b(we)h(w)o(ant)g(an)g(ar)o(gument)d(in)j(a)g
(macro)f(call)h(to)g(be)g(e)n(v)n(aluated)e(only)h(under)555
3669 y(certain)19 b(conditions.)27 b(This)20 b(is)g(be)o(yond)d(the)j
(ability)f(of)g(functions,)f(which)h(al)o(w)o(ays)h(e)n(v)n(aluate)555
3774 y(all)28 b(their)f(ar)o(guments.)50 b(Built\255in)27
b(operators)f(lik)o(e)i Fs(if)p FA(,)h Fs(and)p FA(,)f(and)f
Fs(cond)g FA(protect)f(some)i(of)555 3879 y(their)17
b(ar)o(guments)f(from)h(e)n(v)n(aluation)f(unless)i(other)f(ar)o
(guments)e(return)i(certain)g(v)n(alues.)28 b(F)o(or)555
3983 y(e)o(xample,)19 b(in)h(this)h(e)o(xpression)555
4166 y Fs(\(if)42 b(t)729 4266 y('phew)729 4365 y(\(/)h(x)g(0\)\))555
4553 y FA(the)21 b(third)f(ar)o(gument)e(w)o(ould)i(cause)h(a)g(di)n
(vision\255by\255zero)c(error)j(if)h(it)g(were)g(e)n(v)n(aluated.)29
b(But)555 4657 y(since)24 b(only)e(the)h(\002rst)i(tw)o(o)e(ar)o
(guments)e(e)n(v)o(er)i(will)h(be)f(e)n(v)n(aluated,)g(the)g
Fs(if)g FA(as)h(a)g(whole)f(will)555 4762 y(al)o(w)o(ays)e(safely)f
(return)f Fs(phew)p FA(.)680 4867 y(W)-7 b(e)19 b(can)f(create)g(ne)n
(w)h(operators)d(of)j(this)f(sort)h(by)f(writing)g(macros)f(which)h(e)o
(xpand)f(into)555 4971 y(calls)g(to)f(the)h(e)o(xisting)e(ones.)28
b(The)15 b(tw)o(o)i(macros)e(in)i(Figure)e(11.5)g(are)h(tw)o(o)h(of)f
(man)o(y)f(possible)p eop
%%Page: 151 164
151 163 bop 555 538 a Ft(11.3)815 b Fu(CONDITION)n(AL)19
b(EV)-8 b(ALU)n(A)h(TION)797 b FA(151)555 801 y(v)n(ariations)19
b(on)h Fs(if)p FA(.)29 b(The)20 b(de\002nition)f(of)h
Fs(if3)g FA(sho)n(ws)g(ho)n(w)g(we)h(could)e(de\002ne)h(a)g
(conditional)555 905 y(for)32 b(a)h(three\255v)n(alued)d(logic.)66
b(Instead)32 b(of)h(treating)e Fs(nil)h FA(as)i(f)o(alse)f(and)f(e)n(v)
o(erything)e(else)555 1010 y(as)23 b(true,)g(this)g(macro)e(considers)h
(three)g(cate)o(gories)f(of)h(truth:)33 b(true,)23 b(f)o(alse,)g(and)f
Ft(uncertain)p FA(,)555 1114 y(represented)13 b(as)i
Fs(?)p FA(.)28 b(It)15 b(might)f(be)g(used)h(as)g(in)g(the)g(follo)n
(wing)e(description)g(of)h(a)h(\002v)o(e)g(year)n(\255old:)555
1289 y Fs(\(while)41 b(\(not)h(sick\))642 1389 y(\(if3)g
(\(cake-permitted\))860 1488 y(\(eat-cake\))860 1588
y(\(throw)f('tantrum)f(nil\))860 1687 y(\(plead-insistent)o(ly\))o
(\)\))555 1867 y FA(The)16 b(ne)n(w)h(conditional)e(e)o(xpands)g(into)h
(a)h Fs(case)p FA(.)27 b(\(The)16 b Fs(nil)g FA(k)o(e)o(y)g(has)h(to)g
(be)f(enclosed)g(within)555 1971 y(a)24 b(list)h(because)e(a)i
Fs(nil)e FA(k)o(e)o(y)g(alone)g(w)o(ould)h(be)f(ambiguous.\))38
b(Only)24 b(one)f(of)g(the)h(last)h(three)555 2076 y(ar)o(guments)18
b(will)j(be)f(e)n(v)n(aluated,)f(depending)e(on)j(the)g(v)n(alue)g(of)g
(the)g(\002rst.)680 2181 y(The)d(name)h Fs(nif)f FA(stands)h(for)g
(\223numeric)e(if.)-6 b(\224)29 b(Another)16 b(implementation)g(of)i
(this)h(macro)555 2285 y(appeared)28 b(on)i(page)f(86.)58
b(It)31 b(tak)o(es)f(a)h(numeric)d(e)o(xpression)h(as)h(its)h(\002rst)g
(ar)o(gument,)f(and)555 2390 y(depending)18 b(on)h(its)j(sign)e(e)n(v)n
(aluates)f(one)h(of)g(the)g(remaining)e(three)i(ar)o(guments.)555
2564 y Fs(>)43 b(\(mapcar)e(#'\(lambda)f(\(x\))1165 2664
y(\(nif)i(x)h('p)g('z)g('n\)\))991 2764 y('\(0)f(1)h(-1\)\))555
2863 y(\(Z)g(P)g(N\))680 3043 y FA(Figure)14 b(11.6)h(contains)g(se)n
(v)o(eral)g(more)g(macros)g(which)g(tak)o(e)g(adv)n(antage)f(of)h
(conditional)555 3147 y(e)n(v)n(aluation.)50 b(The)27
b(macro)g Fs(in)g FA(is)h(to)g(test)h(ef)n(\002ciently)d(for)h(set)i
(membership.)49 b(When)27 b(you)555 3252 y(w)o(ant)18
b(to)g(test)h(whether)d(an)i(object)g(is)g(one)g(of)f(a)h(set)h(of)f
(alternati)n(v)o(es,)f(you)g(could)f(e)o(xpress)i(the)555
3356 y(query)h(as)i(a)f(disjunction:)555 3531 y Fs(\(let)42
b(\(\(x)g(\(foo\)\)\))642 3631 y(\(or)h(\(eql)e(x)j(\(bar\)\))d(\(eql)h
(x)h(\(baz\)\)\)\))555 3810 y FA(or)20 b(you)f(could)g(e)o(xpress)h(it)
h(in)f(terms)g(of)g(set)h(membership:)555 3984 y Fs(\(member)41
b(\(foo\))g(\(list)h(\(bar\))f(\(baz\)\)\))555 4164 y
FA(The)33 b(latter)h(is)g(more)f(abstract,)j(b)n(ut)e(less)g(ef)n
(\002cient.)69 b(The)33 b Fs(member)e FA(e)o(xpression)h(incurs)555
4268 y(unnecessary)e(costs)i(from)f(tw)o(o)h(sources.)63
b(It)32 b(conses,)i(because)d(it)h(must)g(assemble)g(the)555
4373 y(alternati)n(v)o(es)23 b(into)h(a)h(list)h(for)d
Fs(member)g FA(to)h(search.)42 b(And)24 b(to)g(form)f(the)i(alternati)n
(v)o(es)e(into)h(a)555 4478 y(list)i(the)o(y)e(all)i(ha)n(v)o(e)e(to)i
(be)f(e)n(v)n(aluated,)f(e)n(v)o(en)g(though)f(some)i(of)g(the)g(v)n
(alues)f(may)h(ne)n(v)o(er)f(be)555 4582 y(needed.)j(If)17
b(the)h(v)n(alue)e(of)h Fs(\(foo\))f FA(is)j(equal)d(to)i(the)f(v)n
(alue)g(of)g Fs(\(bar\))p FA(,)f(then)h(there)g(is)h(no)f(need)555
4687 y(to)j(e)n(v)n(aluate)f Fs(\(baz\))p FA(.)28 b(Whate)n(v)o(er)19
b(its)i(conceptual)d(adv)n(antages,)h(this)h(is)h(not)f(a)h(good)d(w)o
(ay)i(to)555 4791 y(use)j Fs(member)p FA(.)33 b(W)-7
b(e)24 b(can)e(get)g(the)h(same)f(abstraction)g(more)f(ef)n
(\002ciently)h(with)g(a)h(macro:)33 b Fs(in)555 4896
y FA(combines)19 b(the)i(abstraction)e(of)h Fs(member)f
FA(with)h(the)h(ef)n(\002cienc)o(y)e(of)h Fs(or)p FA(.)30
b(The)20 b(equi)n(v)n(alent)f Fs(in)555 5001 y FA(e)o(xpression)p
eop
%%Page: 152 165
152 164 bop 555 538 a FA(152)960 b Fu(CLASSIC)19 b(MA)n(CR)n(OS)p
555 745 2678 4 v 553 3960 4 3215 v 605 888 a Fs(\(defmacro)40
b(in)i(\(obj)g(&rest)g(choices\))692 988 y(\(let)g(\(\(insym)f
(\(gensym\)\)\))779 1087 y(`\(let)h(\(\(,insym)e(,obj\)\))910
1187 y(\(or)i(,@\(mapcar)e(#'\(lambda)g(\(c\))i(`\(eql)g(,insym)f
(,c\)\))1520 1287 y(choices\)\)\)\)\))605 1486 y(\(defmacro)f(inq)i
(\(obj)g(&rest)f(args\))692 1586 y(`\(in)h(,obj)g(,@\(mapcar)e
(#'\(lambda)g(\(a\))1738 1685 y(`',a\))1564 1785 y(args\)\)\))605
1984 y(\(defmacro)g(in-if)h(\(fn)i(&rest)e(choices\))692
2084 y(\(let)h(\(\(fnsym)f(\(gensym\)\)\))779 2183 y(`\(let)h
(\(\(,fnsym)e(,fn\)\))910 2283 y(\(or)i(,@\(mapcar)e(#'\(lambda)g
(\(c\))1694 2383 y(`\(funcall)g(,fnsym)h(,c\)\))1520
2482 y(choices\)\)\)\)\))605 2681 y(\(defmacro)f(>case)h(\(expr)h
(&rest)f(clauses\))692 2781 y(\(let)h(\(\(g)g(\(gensym\)\)\))779
2881 y(`\(let)g(\(\(,g)g(,expr\)\))910 2980 y(\(cond)f(,@\(mapcar)f
(#'\(lambda)g(\(cl\))i(\(>casex)f(g)i(cl\)\))1607 3080
y(clauses\)\)\)\)\))605 3279 y(\(defun)e(>casex)g(\(g)i(cl\))692
3379 y(\(let)f(\(\(key)f(\(car)h(cl\)\))g(\(rest)g(\(cdr)g(cl\)\)\))779
3478 y(\(cond)g(\(\(consp)e(key\))i(`\(\(in)g(,g)h(,@key\))e
(,@rest\)\))1041 3578 y(\(\(inq)g(key)i(t)g(otherwise\))c(`\(t)k
(,@rest\)\))1041 3678 y(\(t)f(\(error)g("bad)f(>case)h
(clause"\)\)\)\)\))1104 3882 y FA(Figure)19 b(11.6:)28
b(Macros)20 b(for)g(conditional)e(e)n(v)n(aluation.)p
3231 3960 V 555 3963 2678 4 v 555 4177 a Fs(\(in)42 b(\(foo\))g
(\(bar\))f(\(baz\)\))555 4352 y FA(has)20 b(the)h(same)f(shape)g(as)h
(the)f Fs(member)e FA(e)o(xpression,)h(b)n(ut)h(e)o(xpands)e(into)555
4522 y Fs(\(let)42 b(\(\(#:g25)f(\(foo\)\)\))642 4622
y(\(or)i(\(eql)e(#:g25)h(\(bar\)\))817 4721 y(\(eql)f(#:g25)h
(\(baz\)\)\)\))555 4896 y FA(As)31 b(is)g(often)e(the)h(case,)j(when)c
(f)o(aced)h(with)g(a)g(choice)f(between)h(a)g(clean)g(idiom)f(and)h(an)
555 5001 y(ef)n(\002cient)20 b(one,)h(we)g(go)f(between)h(the)g(horns)e
(of)i(the)g(dilemma)f(by)h(writing)f(a)h(macro)f(which)p
eop
%%Page: 153 166
153 165 bop 555 538 a Ft(11.4)815 b Fu(CONDITION)n(AL)19
b(EV)-8 b(ALU)n(A)h(TION)797 b FA(153)555 801 y(transforms)19
b(the)h(former)f(into)h(the)g(latter)-5 b(.)680 905 y(Pronounced)18
b(\223in)j(queue,)-6 b(\224)19 b Fs(inq)h FA(is)i(a)g(quoting)d(v)n
(ariant)h(of)g Fs(in)p FA(,)h(as)h Fs(setq)d FA(used)i(to)g(be)g(of)555
1010 y Fs(set)p FA(.)28 b(The)20 b(e)o(xpression)555
1190 y Fs(\(inq)42 b(operator)e(+)j(-)h(*\))555 1375
y FA(e)o(xpands)19 b(into)555 1556 y Fs(\(in)42 b(operator)f('+)h('-)h
('*\))680 1741 y FA(As)26 b Fs(member)d FA(does)i(by)g(def)o(ault,)h
Fs(in)f FA(and)g Fs(inq)g FA(use)g Fs(eql)g FA(to)g(test)i(for)d
(equality)-5 b(.)44 b(When)555 1845 y(you)27 b(w)o(ant)g(to)h(use)g
(some)f(other)g(test\227or)g(an)o(y)g(other)f(function)g(of)h(one)g(ar)
o(gument\227you)555 1950 y(can)22 b(use)h(the)f(more)g(general)f
Fs(in-if)p FA(.)35 b(What)22 b Fs(in)h FA(is)g(to)f Fs(member)p
FA(,)f Fs(in-if)g FA(is)j(to)e Fs(some)p FA(.)35 b(The)555
2055 y(e)o(xpression)555 2240 y Fs(\(member)41 b(x)i(\(list)e(a)j(b\))e
(:test)g(#'equal\))555 2425 y FA(can)20 b(be)g(duplicated)f(by)555
2610 y Fs(\(in-if)41 b(#'\(lambda)f(\(y\))i(\(equal)f(x)j(y\)\))e(a)h
(b\))555 2795 y FA(and)555 2981 y Fs(\(some)f(#'oddp)f(\(list)g(a)i
(b\)\))555 3166 y FA(becomes)555 3351 y Fs(\(in-if)e(#'oddp)g(a)i(b\))
680 3536 y FA(Using)20 b(a)g(combination)e(of)i Fs(cond)f
FA(and)h Fs(in)p FA(,)g(we)g(can)h(de\002ne)e(a)i(useful)f(v)n(ariant)f
(of)h Fs(case)p FA(.)555 3641 y(The)14 b(Common)f(Lisp)h
Fs(case)f FA(macro)h(assumes)g(that)g(its)i(k)o(e)o(ys)d(are)i
(constants.)26 b(Sometimes)14 b(we)555 3745 y(may)22
b(w)o(ant)g(the)g(beha)n(vior)e(of)i(a)h Fs(case)e FA(e)o(xpression,)g
(b)n(ut)h(with)g(k)o(e)o(ys)g(which)f(are)h(e)n(v)n(aluated.)555
3850 y(F)o(or)30 b(such)h(situations)f(we)h(de\002ne)f
Fs(>case)p FA(,)i(lik)o(e)f Fs(case)e FA(e)o(xcept)h(that)h(the)g(k)o
(e)o(ys)f(guarding)555 3955 y(each)24 b(clause)g(are)g(e)n(v)n(aluated)
f(before)f(comparison.)39 b(\(The)24 b Fs(>)g FA(in)g(the)g(name)g(is)h
(intended)d(to)555 4059 y(suggest)c(the)g(arro)n(w)f(notation)f(used)i
(to)g(represent)f(e)n(v)n(aluation.\))26 b(Because)18
b Fs(>case)f FA(uses)h Fs(in)p FA(,)555 4164 y(it)j(e)n(v)n(aluates)e
(no)h(more)g(of)g(the)g(k)o(e)o(ys)g(than)f(it)i(needs)f(to.)680
4268 y(Since)e(k)o(e)o(ys)f(can)h(be)g(Lisp)g(e)o(xpressions,)f(there)g
(is)i(no)f(w)o(ay)g(to)g(tell)g(if)h Fs(\(x)42 b(y\))18
b FA(is)h(a)f(call)h(or)555 4373 y(a)j(list)h(of)f(tw)o(o)g(k)o(e)o
(ys.)34 b(T)-7 b(o)22 b(a)n(v)n(oid)g(ambiguity)-5 b(,)20
b(k)o(e)o(ys)i(\(other)e(than)i Fs(t)g FA(and)f Fs(otherwise)p
FA(\))e(must)555 4478 y(al)o(w)o(ays)j(be)g(gi)n(v)o(en)f(in)h(a)g
(list,)i(e)n(v)o(en)d(if)h(there)f(is)i(only)e(one)h(of)g(them.)34
b(In)21 b Fs(case)g FA(e)o(xpressions,)555 4582 y Fs(nil)i
FA(may)g(not)g(appear)g(as)h(the)g(car)f(of)h(a)g(clause)f(on)g
(grounds)f(of)h(ambiguity)-5 b(.)38 b(In)23 b(a)h Fs(>case)555
4687 y FA(e)o(xpression,)g Fs(nil)f FA(is)j(no)d(longer)h(ambiguous)e
(as)j(the)f(car)h(of)f(a)g(clause,)i(b)n(ut)e(it)h(does)f(mean)555
4791 y(that)c(the)g(rest)h(of)f(the)g(clause)g(will)h(ne)n(v)o(er)e(be)
h(e)n(v)n(aluated.)680 4896 y(F)o(or)30 b(clarity)-5
b(,)33 b(the)f(code)e(that)h(generates)g(the)g(e)o(xpansion)e(of)i
(each)g Fs(>case)e FA(clause)j(is)555 5001 y(de\002ned)19
b(as)i(a)g(separate)e(function,)g Fs(>casex)p FA(.)27
b(Notice)20 b(that)g Fs(>casex)f FA(itself)h(uses)h Fs(inq)p
FA(.)p eop
%%Page: 154 167
154 166 bop 555 538 a FA(154)960 b Fu(CLASSIC)19 b(MA)n(CR)n(OS)p
555 745 2678 4 v 553 2665 4 1920 v 605 888 a Fs(\(defmacro)40
b(while)h(\(test)h(&body)f(body\))692 988 y(`\(do)h(\(\))910
1087 y(\(\(not)f(,test\)\))823 1187 y(,@body\)\))605
1386 y(\(defmacro)f(till)i(\(test)f(&body)h(body\))692
1486 y(`\(do)g(\(\))910 1586 y(\(,test\))823 1685 y(,@body\)\))605
1884 y(\(defmacro)e(for)i(\(\(var)g(start)f(stop\))h(&body)f(body\))692
1984 y(\(let)h(\(\(gstop)f(\(gensym\)\)\))779 2084 y(`\(do)h(\(\(,var)f
(,start)g(\(1+)i(,var\)\))1041 2183 y(\(,gstop)d(,stop\)\))997
2283 y(\(\(>)i(,var)g(,gstop\)\))910 2383 y(,@body\)\)\))1269
2587 y FA(Figure)19 b(11.7:)29 b(Simple)20 b(iteration)f(macros.)p
3231 2665 V 555 2668 2678 4 v 555 2890 a Fw(11.4)99 b(Iteration)555
3081 y FA(Sometimes)36 b(the)h(trouble)e(with)i(functions)f(is)h(not)g
(that)f(their)h(ar)o(guments)d(are)j(al)o(w)o(ays)555
3186 y(e)n(v)n(aluated,)31 b(b)n(ut)f(that)g(the)o(y)f(are)h(e)n(v)n
(aluated)e(only)h(once.)58 b(Because)30 b(each)g(ar)o(gument)d(to)j(a)
555 3290 y(function)24 b(will)i(be)f(e)n(v)n(aluated)f(e)o(xactly)g
(once,)i(if)f(we)h(w)o(ant)f(to)h(de\002ne)e(an)i(operator)d(which)555
3395 y(tak)o(es)d(some)g(body)f(of)g(e)o(xpressions)g(and)g(iterates)i
(through)c(them,)j(we)g(will)h(ha)n(v)o(e)e(to)h(de\002ne)555
3499 y(it)h(as)g(a)f(macro.)680 3604 y(The)30 b(simplest)g(e)o(xample)f
(w)o(ould)h(be)g(a)h(macro)f(which)g(e)n(v)n(aluated)f(its)i(ar)o
(guments)d(in)555 3709 y(sequence)19 b(fore)n(v)o(er:)555
3889 y Fs(\(defmacro)40 b(forever)h(\(&body)g(body\))642
3989 y(`\(do)h(\(\))860 4088 y(\(nil\))773 4188 y(,@body\)\))555
4373 y FA(This)20 b(is)h(just)g(what)f(the)g(b)n(uilt\255in)f
Fs(loop)g FA(macro)g(does)h(if)h(you)e(gi)n(v)o(e)g(it)i(no)e(loop)h(k)
o(e)o(yw)o(ords.)27 b(It)555 4478 y(might)20 b(seem)h(that)h(there)e
(is)i(not)f(much)f(future)g(\(or)g(too)h(much)f(future\))f(in)i
(looping)e(fore)n(v)o(er)-5 b(.)555 4582 y(But)29 b(combined)c(with)k
Fs(block)d FA(and)i Fs(return-from)p FA(,)d(this)k(kind)e(of)h(macro)f
(becomes)g(the)555 4687 y(most)19 b(natural)f(w)o(ay)h(to)g(e)o(xpress)
f(loops)g(where)h(termination)e(is)j(al)o(w)o(ays)f(in)g(the)g(nature)f
(of)h(an)555 4791 y(emer)o(genc)o(y)-5 b(.)680 4896 y(Some)32
b(of)h(the)g(simplest)h(macros)e(for)g(iteration)h(are)g(sho)n(wn)f(in)
h(Figure)g(11.7.)66 b(W)-7 b(e)555 5001 y(ha)n(v)o(e)27
b(already)g(seen)g Fs(while)g FA(\(page)f(91\),)j(whose)e(body)g(will)h
(be)g(e)n(v)n(aluated)e(while)i(a)g(test)p eop
%%Page: 155 168
155 167 bop 555 538 a Ft(11.4)1059 b Fu(ITERA)-7 b(TION)1041
b FA(155)555 801 y(e)o(xpression)24 b(returns)h(true.)45
b(Its)27 b(con)m(v)o(erse)c(is)k Fs(till)p FA(,)f(which)f(does)g(the)h
(same)g(while)g(a)g(test)555 905 y(e)o(xpression)c(returns)h(f)o(alse.)
41 b(Finally)24 b Fs(for)p FA(,)g(also)h(seen)f(before)e(\(page)h
(129\),)h(iterates)g(for)f(a)555 1010 y(range)c(of)h(numbers.)680
1114 y(By)28 b(de\002ning)f(these)i(macros)f(to)g(e)o(xpand)e(into)j
Fs(do)p FA(s,)h(we)e(enable)g(the)g(use)h(of)f Fs(go)g
FA(and)555 1219 y Fs(return)14 b FA(within)h(their)h(bodies.)27
b(As)17 b Fs(do)e FA(inherits)g(these)h(rights)g(from)f
Fs(block)f FA(and)h Fs(tagbody)p FA(,)555 1324 y Fs(while)p
FA(,)20 b Fs(till)p FA(,)g(and)h Fs(for)f FA(inherit)h(them)g(from)f
Fs(do)p FA(.)32 b(As)22 b(e)o(xplained)d(on)i(page)g(131,)f(the)h
Fs(nil)555 1428 y FA(tag)27 b(of)h(the)f(implicit)h Fs(block)d
FA(around)h Fs(do)h FA(will)h(be)g(captured)e(by)h(the)g(macros)g
(de\002ned)f(in)555 1533 y(Figure)13 b(11.7.)26 b(This)14
b(is)g(more)f(of)g(a)h(feature)f(than)g(a)h(b)n(ug,)g(b)n(ut)g(it)g
(should)f(at)h(least)g(be)f(mentioned)555 1638 y(e)o(xplicitly)-5
b(.)680 1742 y(Macros)30 b(are)g(indispensable)g(when)g(we)h(need)f(to)
g(de\002ne)h(more)e(po)n(werful)g(iteration)555 1847
y(constructs.)53 b(Figure)27 b(11.8)g(contains)h(tw)o(o)g
(generalizations)f(of)h Fs(dolist)p FA(;)i(both)e(e)n(v)n(aluate)555
1951 y(their)e(body)f(with)i(a)f(tuple)g(of)g(v)n(ariables)g(bound)e
(to)j(successi)n(v)o(e)f(subsequences)f(of)h(a)h(list.)555
2056 y(F)o(or)20 b(e)o(xample,)e(gi)n(v)o(en)h(tw)o(o)i(parameters,)d
Fs(do-tuples/o)f FA(will)k(iterate)f(by)g(pairs:)555
2239 y Fs(>)43 b(\(do-tuples/o)c(\(x)k(y\))f('\(a)h(b)g(c)g(d\))729
2338 y(\(princ)e(\(list)h(x)h(y\)\)\))555 2438 y(\(A)g(B\)\(B)f(C\)\(C)
g(D\))555 2537 y(NIL)555 2725 y FA(Gi)n(v)o(en)33 b(the)h(same)g(ar)o
(guments,)g Fs(do-tuples/c)c FA(will)35 b(do)e(the)h(same)g(thing,)i
(then)d(wrap)555 2830 y(around)18 b(to)j(the)f(front)f(of)h(the)g
(list:)555 3012 y Fs(>)43 b(\(do-tuples/c)c(\(x)k(y\))f('\(a)h(b)g(c)g
(d\))729 3112 y(\(princ)e(\(list)h(x)h(y\)\)\))555 3212
y(\(A)g(B\)\(B)f(C\)\(C)g(D\)\(D)g(A\))555 3311 y(NIL)555
3499 y FA(Both)20 b(macros)g(return)f Fs(nil)p FA(,)g(unless)h(an)g(e)o
(xplicit)g Fs(return)e FA(occurs)i(within)g(the)g(body)-5
b(.)680 3603 y(This)15 b(kind)f(of)h(iteration)f(is)i(often)f(needed)e
(in)j(programs)d(which)i(deal)g(with)g(some)g(notion)555
3708 y(of)25 b(a)h(path.)45 b(The)25 b(suf)n(\002x)o(es)g
Fs(/o)g FA(and)g Fs(/c)g FA(are)h(intended)e(to)i(suggest)f(that)g(the)
h(tw)o(o)g(v)o(ersions)555 3813 y(tra)n(v)o(erse)d(open)g(and)g(closed)
g(paths,)h(respecti)n(v)o(ely)-5 b(.)38 b(F)o(or)23 b(e)o(xample,)g(if)
h Fs(points)d FA(is)k(a)f(list)h(of)555 3917 y(points)16
b(and)g Fs(\(drawline)40 b Ft(x)j(y)p Fs(\))17 b FA(dra)o(ws)f(the)g
(line)h(between)f Ft(x)g FA(and)g Ft(y)-5 b(,)18 b FA(then)e(to)h(dra)o
(w)f(the)g(path)555 4022 y(from)j(the)h(\002rst)h(point)f(to)g(the)g
(last)h(we)g(write.)555 4205 y Fs(\(do-tuples/o)39 b(\(x)j(y\))h
(points)e(\(drawline)f(x)j(y\)\))555 4392 y FA(whereas,)20
b(if)h Fs(points)d FA(is)k(a)f(list)g(of)f(the)h(v)o(ertices)f(of)g(a)h
(polygon,)d(to)j(dra)o(w)e(its)j(perimeter)d(we)555 4497
y(write)555 4679 y Fs(\(do-tuples/c)39 b(\(x)j(y\))h(points)e
(\(drawline)f(x)j(y\)\))680 4867 y FA(The)32 b(list)j(of)e(parameters)f
(gi)n(v)o(en)g(as)i(the)f(\002rst)h(ar)o(gument)d(can)i(be)g(an)o(y)g
(length,)i(and)555 4972 y(iteration)18 b(will)i(proceed)d(by)h(tuples)h
(of)f(that)h(length.)28 b(If)18 b(just)i(one)e(parameter)f(is)j(gi)n(v)
o(en,)d(both)p eop
%%Page: 156 169
156 168 bop 555 538 a FA(156)960 b Fu(CLASSIC)19 b(MA)n(CR)n(OS)p
555 874 2678 4 v 553 4786 4 3913 v 605 1017 a Fs(\(defmacro)40
b(do-tuples/o)f(\(parms)i(source)g(&body)g(body\))692
1116 y(\(if)h(parms)866 1216 y(\(let)g(\(\(src)g(\(gensym\)\)\))954
1315 y(`\(prog)f(\(\(,src)g(,source\)\))1084 1415 y(\(mapc)h
(#'\(lambda)e(,parms)h(,@body\))1346 1515 y(,@\(map0-n)f(#'\(lambda)g
(\(n\))1956 1614 y(`\(nthcdr)g(,n)j(,src\)\))1782 1714
y(\(1-)f(\(length)f(parms\)\)\)\)\)\)\)\))605 1913 y(\(defmacro)f
(do-tuples/c)f(\(parms)i(source)g(&body)g(body\))692
2013 y(\(if)h(parms)866 2112 y(\(with-gensyms)d(\(src)i(rest)h(bodfn\))
954 2212 y(\(let)f(\(\(len)h(\(length)f(parms\)\)\))1041
2312 y(`\(let)g(\(\(,src)g(,source\)\))1171 2411 y(\(when)h(\(nthcdr)f
(,\(1-)h(len\))g(,src\))1259 2511 y(\(labels)e(\(\(,bodfn)h(,parms)g
(,@body\)\))1346 2611 y(\(do)h(\(\(,rest)f(,src)h(\(cdr)g(,rest\)\)\))
1520 2710 y(\(\(not)g(\(nthcdr)e(,\(1-)i(len\))g(,rest\)\))1564
2810 y(,@\(mapcar)e(#'\(lambda)f(\(args\))2174 2910 y(`\(,bodfn)h
(,@args\)\))2000 3009 y(\(dt-args)g(len)i(rest)g(src\)\))1564
3109 y(nil\))1433 3208 y(\(,bodfn)f(,@\(map1-n)f(#'\(lambda)f(\(n\))
2392 3308 y(`\(nth)i(,\(1-)h(n\))2653 3408 y(,rest\)\))2218
3507 y(len\)\)\)\)\)\)\)\)\)\))605 3707 y(\(defun)f(dt-args)g(\(len)h
(rest)f(src\))692 3806 y(\(map0-n)g(#'\(lambda)f(\(m\))1215
3906 y(\(map1-n)h(#'\(lambda)f(\(n\))1738 4005 y(\(let)i(\(\(x)g(\(+)h
(m)g(n\)\)\))1825 4105 y(\(if)g(\(>=)f(x)h(len\))2000
4205 y(`\(nth)e(,\(-)h(x)i(len\))e(,src\))2000 4304 y(`\(nth)f(,\(1-)h
(x\))h(,rest\)\)\)\))1564 4404 y(len\)\))1041 4504 y(\(-)f(len)h
(2\)\)\))1045 4708 y FA(Figure)20 b(11.8:)28 b(Macros)20
b(for)f(iteration)h(by)g(subsequences.)p 3231 4786 V
555 4789 2678 4 v eop
%%Page: 157 170
157 169 bop 555 538 a Ft(11.4)1059 b Fu(ITERA)-7 b(TION)1041
b FA(157)p 555 745 2678 4 v 553 3177 4 2432 v 605 888
a Fs(\(do-tuples/c)38 b(\(x)43 b(y)g(z\))g('\(a)f(b)i(c)f(d\))692
988 y(\(princ)e(\(list)h(x)h(y)g(z\)\)\))605 1217 y FA(e)o(xpands)18
b(into:)605 1400 y Fs(\(let)42 b(\(\(#:g2)f('\(a)h(b)h(c)h(d\)\)\))692
1499 y(\(when)e(\(nthcdr)e(2)j(#:g2\))779 1599 y(\(labels)e(\(\(#:g4)g
(\(x)i(y)g(z\))1259 1698 y(\(princ)e(\(list)g(x)i(y)h(z\)\)\)\))866
1798 y(\(do)f(\(\(#:g3)e(#:g2)h(\(cdr)g(#:g3\)\)\))1041
1898 y(\(\(not)f(\(nthcdr)g(2)i(#:g3\)\))1084 1997 y(\(#:g4)f(\(nth)g
(0)h(#:g3\))1346 2097 y(\(nth)f(1)h(#:g3\))1346 2197
y(\(nth)f(0)h(#:g2\)\))1084 2296 y(\(#:g4)f(\(nth)g(1)h(#:g3\))1346
2396 y(\(nth)f(0)h(#:g2\))1346 2495 y(\(nth)f(1)h(#:g2\)\))1084
2595 y(nil\))954 2695 y(\(#:g4)e(\(nth)h(0)h(#:g3\))1215
2794 y(\(nth)f(1)h(#:g3\))1215 2894 y(\(nth)f(2)h(#:g3\)\)\)\)\)\))1053
3098 y FA(Figure)20 b(11.9:)28 b(Expansion)18 b(of)i(a)h(call)g(to)f
Fs(do-tuples/c)p FA(.)p 3231 3177 V 555 3180 2678 4 v
555 3397 a(de)o(generate)e(to)i Fs(dolist)p FA(:)555
3570 y Fs(>)43 b(\(do-tuples/o)c(\(x\))j('\(a)g(b)i(c\))e(\(princ)g
(x\)\))555 3669 y(ABC)555 3769 y(NIL)555 3869 y(>)h(\(do-tuples/c)c
(\(x\))j('\(a)g(b)i(c\))e(\(princ)g(x\)\))555 3968 y(ABC)555
4068 y(NIL)680 4246 y FA(The)20 b(de\002nition)g(of)h
Fs(do-tuples/c)c FA(is)22 b(more)f(comple)o(x)e(than)i(that)g(of)g
Fs(do-tuples/o)p FA(,)555 4351 y(because)32 b(it)g(has)h(to)f(wrap)g
(around)e(on)i(reaching)f(the)h(end)f(of)h(the)g(list.)67
b(If)32 b(there)f(are)h Ft(n)555 4455 y FA(parameters,)19
b Fs(do-tuples/c)d FA(must)k(do)g Ft(n)p Fq(\000)p FA(1)f(more)h
(iterations)f(before)g(returning:)555 4628 y Fs(>)43
b(\(do-tuples/c)c(\(x)k(y)g(z\))f('\(a)h(b)g(c)g(d\))729
4728 y(\(princ)e(\(list)h(x)h(y)g(z\)\)\))555 4828 y(\(A)g(B)g(C\)\(B)f
(C)h(D\)\(C)f(D)h(A\)\(D)f(A)h(B\))555 4927 y(NIL)p eop
%%Page: 158 171
158 170 bop 555 538 a FA(158)960 b Fu(CLASSIC)19 b(MA)n(CR)n(OS)555
801 y Fs(>)43 b(\(do-tuples/c)c(\(w)k(x)g(y)g(z\))g('\(a)f(b)h(c)g(d\))
729 900 y(\(princ)e(\(list)h(w)h(x)g(y)g(z\)\)\))555
1000 y(\(A)g(B)g(C)g(D\)\(B)f(C)h(D)g(A\)\(C)f(D)h(A)h(B\)\(D)e(A)h(B)g
(C\))555 1100 y(NIL)555 1280 y FA(The)22 b(e)o(xpansion)f(of)h(the)g
(former)f(call)i(to)g Fs(do-tuples/c)18 b FA(is)24 b(sho)n(wn)e(in)g
(Figure)g(11.9.)35 b(The)555 1385 y(hard)20 b(part)h(to)h(generate)e
(is)i(the)f(sequence)f(of)h(calls)h(representing)e(the)h(wrap)g(around)
e(to)j(the)555 1489 y(front)17 b(of)g(the)h(list.)29
b(These)18 b(calls)g(\(in)g(this)g(case,)g(tw)o(o)g(of)f(them\))g(are)h
(generated)e(by)h Fs(dt-args)p FA(.)555 1741 y Fw(11.5)99
b(Iteration)25 b(with)g(Multiple)h(V)-9 b(alues)680 1932
y FA(The)22 b(b)n(uilt\255in)h Fs(do)f FA(macros)h(ha)n(v)o(e)f(been)h
(around)e(longer)g(than)i(multiple)f(return)g(v)n(alues.)555
2036 y(F)o(ortunately)c Fs(do)h FA(can)h(e)n(v)n(olv)o(e)f(to)h(suit)g
(the)g(ne)n(w)f(situation,)h(because)f(the)h(e)n(v)n(olution)e(of)h
(Lisp)555 2141 y(is)f(in)f(the)f(hands)g(of)h(the)g(programmer)-5
b(.)25 b(Figure)16 b(11.10)f(contains)h(a)i(v)o(ersion)d(of)i
Fs(do*)f FA(adapted)555 2245 y(for)24 b(multiple)g(v)n(alues.)42
b(W)m(ith)25 b Fs(mvdo*)p FA(,)f(each)g(of)h(the)f(initial)h(clauses)g
(can)f(bind)g(more)g(than)555 2350 y(one)c(v)n(ariable:)555
2526 y Fs(>)43 b(\(mvdo*)e(\(\(x)i(1)g(\(1+)f(x\)\))991
2625 y(\(\(y)g(z\))h(\(values)e(0)i(0\))g(\(values)d(z)j(x\)\)\))947
2725 y(\(\(>)g(x)g(5\))g(\(list)e(x)i(y)g(z\)\))729 2825
y(\(princ)e(\(list)h(x)h(y)g(z\)\)\))555 2924 y(\(1)g(0)g(0\)\(2)f(0)h
(2\)\(3)f(2)h(3\)\(4)f(3)h(4\)\(5)f(4)h(5\))555 3024
y(\(6)g(5)g(6\))555 3205 y FA(This)30 b(kind)f(of)h(iteration)f(is)i
(useful,)g(for)f(e)o(xample,)g(in)g(interacti)n(v)o(e)f(graphics)g
(programs,)555 3309 y(which)20 b(often)f(ha)n(v)o(e)h(to)g(deal)g(with)
g(multiple)g(quantities)g(lik)o(e)g(coordinates)f(and)g(re)o(gions.)680
3414 y(Suppose)h(that)h(we)h(w)o(ant)f(to)h(write)f(a)h(simple)f
(interacti)n(v)o(e)f(game,)h(in)g(which)g(the)g(object)555
3518 y(is)d(to)f(a)n(v)n(oid)g(being)f(squashed)f(between)i(tw)o(o)g
(pursuing)e(objects.)28 b(If)16 b(the)h(tw)o(o)h(pursuers)d(both)555
3623 y(hit)25 b(you)e(at)i(the)g(same)g(time,)g(you)f(lose;)j(if)e(the)
o(y)e(crash)i(into)f(one)g(another)f(\002rst,)j(you)e(win.)555
3728 y(Figure)16 b(11.11)e(sho)n(ws)i(ho)n(w)g(the)g(main)g(loop)f(of)h
(this)h(game)e(could)h(be)g(written)g(using)f Fs(mvdo*)p
FA(.)680 3832 y(It)k(is)i(also)f(possible)f(to)h(write)g(an)f
Fs(mvdo)p FA(,)g(which)g(binds)g(its)i(local)e(v)n(ariables)g(in)h
(parallel:)555 4008 y Fs(>)43 b(\(mvdo)f(\(\(x)g(1)h(\(1+)g(x\)\))947
4108 y(\(\(y)g(z\))f(\(values)f(0)i(0\))g(\(values)e(z)i(x\)\)\))904
4207 y(\(\(>)f(x)h(5\))g(\(list)e(x)j(y)f(z\)\))729 4307
y(\(princ)e(\(list)h(x)h(y)g(z\)\)\))555 4406 y(\(1)g(0)g(0\)\(2)f(0)h
(1\)\(3)f(1)h(2\)\(4)f(2)h(3\)\(5)f(3)h(4\))555 4506
y(\(6)g(4)g(5\))555 4687 y FA(The)25 b(need)g(for)g Fs(psetq)f
FA(in)i(de\002ning)f Fs(do)g FA(w)o(as)h(described)f(on)g(page)g(96.)45
b(T)-7 b(o)26 b(de\002ne)f Fs(mvdo)p FA(,)555 4791 y(we)i(need)f(a)i
(multiple\255v)n(alue)c(v)o(ersion)i(of)g Fs(psetq)p
FA(.)48 b(Since)26 b(Common)g(Lisp)h(doesn')o(t)e(ha)n(v)o(e)-2786
b Fq(\016)555 4896 y FA(one,)23 b(we)h(ha)n(v)o(e)f(to)h(write)f(it)h
(ourselv)o(es,)f(as)h(in)g(Figure)f(11.12.)37 b(The)23
b(ne)n(w)g(macro)g(w)o(orks)g(as)555 5001 y(follo)n(ws:)p
eop
%%Page: 159 172
159 171 bop 555 538 a Ft(11.5)694 b Fu(ITERA)-7 b(TION)18
b(WITH)h(MUL)-5 b(TIPLE)16 b(V)-8 b(ALUES)677 b FA(159)p
555 745 2678 4 v 553 4060 4 3315 v 605 888 a Fs(\(defmacro)40
b(mvdo*)h(\(parm-cl)f(test-cl)h(&body)h(body\))692 988
y(\(mvdo-gen)e(parm-cl)h(parm-cl)f(test-cl)h(body\)\))605
1187 y(\(defun)g(mvdo-gen)f(\(binds)h(rebinds)g(test)h(body\))692
1287 y(\(if)g(\(null)g(binds\))866 1386 y(\(let)g(\(\(label)f
(\(gensym\)\)\))954 1486 y(`\(prog)g(nil)1084 1586 y(,label)1084
1685 y(\(if)i(,\(car)e(test\))1259 1785 y(\(return)f(\(progn)h(,@\(cdr)
h(test\)\)\)\))1084 1884 y(,@body)1084 1984 y(,@\(mvdo-rebind-ge)o(n)37
b(rebinds\))1084 2084 y(\(go)43 b(,label\)\)\))866 2183
y(\(let)f(\(\(rec)g(\(mvdo-gen)e(\(cdr)i(binds\))f(rebinds)f(test)i
(body\)\)\))954 2283 y(\(let)f(\(\(var/s)g(\(caar)h(binds\)\))e(\(expr)
i(\(cadar)f(binds\)\)\))1041 2383 y(\(if)h(\(atom)g(var/s\))1215
2482 y(`\(let)g(\(\(,var/s)e(,expr\)\))h(,rec\))1215
2582 y(`\(multiple-value)o(-bi)o(nd)c(,var/s)k(,expr)h
(,rec\)\)\)\)\)\))605 2781 y(\(defun)f(mvdo-rebind-gen)c(\(rebinds\))
692 2881 y(\(cond)42 b(\(\(null)f(rebinds\))f(nil\))954
2980 y(\(\(<)i(\(length)f(\(car)g(rebinds\)\))f(3\))997
3080 y(\(mvdo-rebind-gen)d(\(cdr)42 b(rebinds\)\)\))954
3180 y(\(t)997 3279 y(\(cons)g(\(list)f(\(if)h(\(atom)g(\(caar)g
(rebinds\)\))1694 3379 y('setq)1694 3478 y('multiple-value-s)o(etq)o
(\))1520 3578 y(\(caar)g(rebinds\))1520 3678 y(\(third)f(\(car)h
(rebinds\)\)\))1259 3777 y(\(mvdo-rebind-ge)o(n)c(\(cdr)k
(rebinds\)\)\)\)\)\))1012 3982 y FA(Figure)20 b(11.10:)28
b(Multiple)20 b(v)n(alue)f(binding)g(v)o(ersion)f(of)i
Fs(do*)p FA(.)p 3231 4060 V 555 4063 2678 4 v 555 4287
a Fs(>)43 b(\(let)f(\(\(w)g(0\))h(\(x)g(1\))g(\(y)f(2\))h(\(z)g(3\)\))
729 4387 y(\(mvpsetq)e(\(w)h(x\))h(\(values)e('a)i('b\))f(\(y)h(z\))f
(\(values)f(w)i(x\)\))729 4486 y(\(list)f(w)h(x)g(y)g(z\)\))555
4586 y(\(A)g(B)g(0)g(1\))555 4774 y FA(The)27 b(de\002nition)g(of)g
Fs(mvpsetq)e FA(relies)j(on)g(three)f(utility)g(functions:)43
b Fs(mklist)26 b FA(\(page)h(45\),)555 4878 y Fs(group)19
b FA(\(page)g(47\),)g(and)h Fs(shuffle)p FA(,)d(de\002ned)i(here,)h
(which)f(interlea)n(v)o(es)h(tw)o(o)g(lists:)p eop
%%Page: 160 173
160 172 bop 555 538 a FA(160)960 b Fu(CLASSIC)19 b(MA)n(CR)n(OS)p
555 745 2678 4 v 553 3988 4 3243 v 605 888 a Fs(\(mvdo*)41
b(\(\(\(px)g(py\))i(\(pos)f(player\))128 b(\(move)41
b(player)g(mx)i(my\)\))954 988 y(\(\(x1)e(y1\))i(\(pos)f(obj1\))216
b(\(move)41 b(obj1)h(\(-)h(px)g(x1\))2479 1087 y(\(-)g(py)g(y1\)\)\))
954 1187 y(\(\(x2)e(y2\))i(\(pos)f(obj2\))216 b(\(move)41
b(obj2)h(\(-)h(px)g(x2\))2479 1287 y(\(-)g(py)g(y2\)\)\))954
1386 y(\(\(mx)e(my\))i(\(mouse-vector\))38 b(\(mouse-vector\)\))954
1486 y(\(win)216 b(nil)522 b(\(touch)41 b(obj1)h(obj2\)\))954
1586 y(\(lose)172 b(nil)522 b(\(and)42 b(\(touch)f(obj1)h(player\))2218
1685 y(\(touch)f(obj2)h(player\)\)\)\))910 1785 y(\(\(or)g(win)g
(lose\))g(\(if)g(win)g('win)g('lose\)\))692 1884 y(\(clear\))692
1984 y(\(draw)g(obj1\))692 2084 y(\(draw)g(obj2\))692
2183 y(\(draw)g(player\)\))605 2495 y(\(pos)g Ft(obj)p
Fs(\))23 b FA(returns)g(tw)o(o)h(v)n(alues)g Fs(x,y)f
FA(representing)f(the)i(position)f(of)g Ft(obj)p FA(.)40
b(Initially)-5 b(,)605 2600 y(the)20 b(three)g(objects)g(ha)n(v)o(e)f
(random)g(positions.)605 2788 y Fs(\(move)41 b Ft(obj)i(dx)g(dy)p
Fs(\))19 b FA(mo)o(v)o(es)f(the)i(object)f Ft(obj)g FA(depending)d(on)j
(its)i(type)e(and)g(the)g(v)o(ector)605 2892 y Fq(h)p
Ft(dx,dy)p Fq(i)p FA(.)29 b(Returns)20 b(tw)o(o)g(v)n(alues)g
Fs(x,y)f FA(indicating)g(the)h(ne)n(w)g(position.)605
3080 y Fs(\(mouse-vector\))15 b FA(returns)20 b(tw)o(o)g(v)n(alues)h
Fs(dx,dy)e FA(indicating)g(the)h(current)f(mo)o(v)o(ement)605
3185 y(of)h(the)g(mouse.)605 3372 y Fs(\(touch)41 b Ft(obj1)h(obj2)p
Fs(\))19 b FA(returns)g(true)h(if)h Ft(obj1)e FA(and)h
Ft(obj2)f FA(are)h(touching.)605 3560 y Fs(\(clear\))e
FA(clears)i(the)g(game)f(re)o(gion.)605 3747 y Fs(\(draw)41
b Ft(obj)p Fs(\))20 b FA(dra)o(ws)g Ft(obj)f FA(at)i(its)g(current)e
(position.)1346 3910 y(Figure)h(11.11:)28 b(A)20 b(game)f(of)h(squash.)
p 3231 3988 V 555 3992 2678 4 v 555 4216 a Fs(>)43 b(\(shuffle)d('\(a)j
(b)g(c\))g('\(1)f(2)h(3)g(4\)\))555 4315 y(\(A)g(1)g(B)g(2)g(C)g(3)h
(4\))680 4503 y FA(W)m(ith)25 b Fs(mvpsetq)p FA(,)e(we)j(can)e
(de\002ne)h Fs(mvdo)f FA(as)h(in)g(Figure)g(11.13.)42
b(Lik)o(e)24 b Fs(condlet)p FA(,)g(this)555 4608 y(macro)i(uses)i
Fs(mappend)d FA(instead)i(of)f Fs(mapcar)g FA(to)h(a)n(v)n(oid)g
(modifying)d(the)k(original)e(macro)555 4712 y(call.)k(The)19
b Fs(mappend)p FA(\255)p Fs(mklist)c FA(idiom)20 b(\003attens)h(a)f
(tree)g(by)g(one)g(le)n(v)o(el:)555 4895 y Fs(>)43 b(\(mappend)d
(#'mklist)h('\(\(a)h(b)h(c\))g(d)g(\(e)g(\(f)f(g\))h(h\))g(\(\(i\)\))e
(j\)\))555 4995 y(\(A)i(B)g(C)g(D)g(E)g(\(F)g(G\))g(H)g(\(I\))f(J\))p
eop
%%Page: 161 174
161 173 bop 555 538 a Ft(11.6)935 b Fu(NEED)18 b(FOR)h(MA)n(CR)n(OS)917
b FA(161)p 555 745 2678 4 v 553 3960 4 3216 v 605 888
a Fs(\(defmacro)40 b(mvpsetq)g(\(&rest)h(args\))692 988
y(\(let*)h(\(\(pairs)e(\(group)h(args)h(2\)\))997 1087
y(\(syms)85 b(\(mapcar)41 b(#'\(lambda)f(\(p\))1825 1187
y(\(mapcar)h(#'\(lambda)f(\(x\))i(\(gensym\)\))2174 1287
y(\(mklist)f(\(car)h(p\)\)\)\))1651 1386 y(pairs\)\)\))779
1486 y(\(labels)f(\(\(rec)g(\(ps)i(ss\))1259 1586 y(\(if)f(\(null)f
(ps\))1433 1685 y(`\(setq)1520 1785 y(,@\(mapcan)f(#'\(lambda)g(\(p)j
(s\))2130 1884 y(\(shuffle)e(\(mklist)f(\(car)i(p\)\))2523
1984 y(s\)\))1956 2084 y(pairs)g(syms\)\))1433 2183 y(\(let)g(\(\(body)
f(\(rec)h(\(cdr)g(ps\))g(\(cdr)g(ss\)\)\)\))1520 2283
y(\(let)g(\(\(var/s)f(\(caar)g(ps\)\))1782 2383 y(\(expr)g(\(cadar)g
(ps\)\)\))1607 2482 y(\(if)i(\(consp)e(var/s\))1782 2582
y(`\(multiple-valu)o(e-b)o(in)o(d)d(,\(car)j(ss\))2741
2681 y(,expr)1912 2781 y(,body\))1782 2881 y(`\(let)g(\(\(,@\(car)f
(ss\))j(,expr\)\))1912 2980 y(,body\)\)\)\)\)\)\))866
3080 y(\(rec)f(pairs)g(syms\)\)\)\))605 3279 y(\(defun)f(shuffle)g(\(x)
h(y\))692 3379 y(\(cond)g(\(\(null)f(x\))h(y\))954 3478
y(\(\(null)f(y\))h(x\))954 3578 y(\(t)g(\(list*)f(\(car)h(x\))h(\(car)f
(y\))1389 3678 y(\(shuffle)f(\(cdr)h(x\))g(\(cdr)g(y\)\)\)\)\)\))1106
3882 y FA(Figure)20 b(11.12:)27 b(Multiple)20 b(v)n(alue)g(v)o(ersion)f
(of)h Fs(psetq)p FA(.)p 3231 3960 V 555 3964 2678 4 v
555 4188 a(T)-7 b(o)21 b(help)g(in)h(understanding)c(this)k(rather)e
(lar)o(ge)h(macro,)f(Figure)h(11.14)e(contains)i(a)h(sample)555
4292 y(e)o(xpansion.)555 4545 y Fw(11.6)99 b(Need)26
b(f)n(or)e(Macr)n(os)555 4736 y FA(Macros)17 b(aren')o(t)f(the)i(only)f
(w)o(ay)g(to)h(protect)f(ar)o(guments)e(against)i(e)n(v)n(aluation.)27
b(Another)16 b(is)i(to)555 4840 y(wrap)24 b(them)g(in)g(closures.)41
b(Conditional)23 b(and)h(repeated)f(e)n(v)n(aluation)g(are)h(similar)g
(because)555 4945 y(neither)14 b(problem)g(inherently)f(req)o(uir)o(es)
h(macr)o(os.)21 b(F)o(or)14 b(e)o(xample,)e(we)i(could)g(write)g(a)g(v)
o(ersion)p eop
%%Page: 162 175
162 174 bop 555 538 a FA(162)960 b Fu(CLASSIC)19 b(MA)n(CR)n(OS)p
555 745 2678 4 v 553 3761 4 3016 v 605 888 a Fs(\(defmacro)40
b(mvdo)i(\(binds)f(\(test)g(&rest)h(result\))e(&body)i(body\))692
988 y(\(let)g(\(\(label)f(\(gensym\)\))954 1087 y(\(temps)g(\(mapcar)f
(#'\(lambda)g(\(b\))1782 1187 y(\(if)i(\(listp)f(\(car)h(b\)\))1956
1287 y(\(mapcar)f(#'\(lambda)f(\(x\))2479 1386 y(\(gensym\)\))2305
1486 y(\(car)i(b\)\))1956 1586 y(\(gensym\)\)\))1607
1685 y(binds\)\)\))779 1785 y(`\(let)g(,\(mappend)e(#'mklist)g(temps\))
910 1884 y(\(mvpsetq)g(,@\(mapcan)g(#'\(lambda)g(\(b)j(var\))1912
1984 y(\(list)f(var)g(\(cadr)g(b\)\)\))1738 2084 y(binds)1738
2183 y(temps\)\))910 2283 y(\(prog)f(,\(mapcar)g(#'\(lambda)f(\(b)i
(var\))g(\(list)g(b)h(var\)\))1520 2383 y(\(mappend)d(#'mklist)h
(\(mapcar)f(#'car)i(binds\)\))1520 2482 y(\(mappend)e(#'mklist)h
(temps\)\))997 2582 y(,label)997 2681 y(\(if)h(,test)1171
2781 y(\(return)f(\(progn)g(,@result\)\)\))997 2881 y(,@body)997
2980 y(\(mvpsetq)f(,@\(mapcan)g(#'\(lambda)g(\(b\))2000
3080 y(\(if)i(\(third)f(b\))2174 3180 y(\(list)g(\(car)h(b\))2435
3279 y(\(third)g(b\)\)\)\))1825 3379 y(binds\)\))997
3478 y(\(go)g(,label\)\)\)\)\))1034 3683 y FA(Figure)20
b(11.13:)28 b(Multiple)19 b(v)n(alue)h(binding)e(v)o(ersion)h(of)h
Fs(do)p FA(.)p 3231 3761 V 555 3764 2678 4 v 555 3988
a(of)g Fs(if)g FA(as)h(a)f(function:)555 4171 y Fs(\(defun)41
b(fnif)h(\(test)g(then)f(&optional)f(else\))642 4271
y(\(if)j(test)817 4370 y(\(funcall)d(then\))817 4470
y(\(if)i(else)g(\(funcall)e(else\)\)\)\))555 4657 y FA(W)-7
b(e)22 b(w)o(ould)f(protect)f(the)h Fs(then)f FA(and)g
Fs(else)g FA(ar)o(guments)g(by)g(e)o(xpressing)g(them)g(as)i(closures,)
555 4762 y(so)f(instead)f(of)555 4945 y Fs(\(if)42 b(\(rich\))f
(\(go-sailing\))e(\(rob-bank\)\))p eop
%%Page: 163 176
163 175 bop 555 538 a Ft(11.6)935 b Fu(NEED)18 b(FOR)h(MA)n(CR)n(OS)917
b FA(163)p 555 745 2678 4 v 553 2877 4 2133 v 605 888
a Fs(\(mvdo)41 b(\(\(x)i(1)g(\(1+)f(x\)\))910 988 y(\(\(y)g(z\))h
(\(values)e(0)i(0\))g(\(values)d(z)k(x\)\)\))866 1087
y(\(\(>)f(x)g(5\))g(\(list)e(x)i(y)g(z\)\))692 1187 y(\(princ)e(\(list)
h(x)h(y)g(z\)\)\))605 1416 y FA(e)o(xpands)18 b(into:)605
1599 y Fs(\(let)42 b(\(#:g2)f(#:g3)h(#:g4\))692 1698
y(\(mvpsetq)e(#:g2)i(1)1084 1798 y(\(#:g3)g(#:g4\))f(\(values)g(0)i
(0\)\))692 1898 y(\(prog)f(\(\(x)g(#:g2\))f(\(y)i(#:g3\))f(\(z)g
(#:g4\)\))823 1997 y(#:g1)823 2097 y(\(if)g(\(>)h(x)g(5\))997
2197 y(\(return)e(\(progn)g(\(list)g(x)j(y)f(z\)\)\)\))823
2296 y(\(princ)e(\(list)g(x)j(y)f(z\)\))823 2396 y(\(mvpsetq)d(x)j
(\(1+)g(x\))1215 2495 y(\(y)g(z\))g(\(values)d(z)j(x\)\))823
2595 y(\(go)f(#:g1\)\)\))1185 2799 y FA(Figure)20 b(11.14:)27
b(Expansion)19 b(of)h(a)g(call)h(to)f Fs(mvdo)p FA(.)p
3231 2877 V 555 2881 2678 4 v 555 3087 a(we)h(w)o(ould)e(say)555
3248 y Fs(\(fnif)42 b(\(rich\))817 3348 y(#'\(lambda)d(\(\))k
(\(go-sailing\)\))817 3447 y(#'\(lambda)c(\(\))k(\(rob-bank\)\)\))555
3613 y FA(If)18 b(all)h(we)f(w)o(ant)h(is)g(conditional)d(e)n(v)n
(aluation,)h(macros)g(aren')o(t)g(absolutely)g(necessary)-5
b(.)28 b(The)o(y)555 3718 y(just)g(mak)o(e)f(programs)f(cleaner)-5
b(.)51 b(Ho)n(we)n(v)o(er)m(,)27 b(macros)g(are)g(necessary)g(when)g
(we)h(w)o(ant)f(to)555 3822 y(tak)o(e)20 b(apart)g(ar)o(gument)e
(forms,)h(or)h(bind)f(v)n(ariables)h(passed)g(as)h(ar)o(guments.)680
3927 y(The)c(same)g(applies)h(to)f(macros)g(for)g(iteration.)28
b(Although)15 b(macros)i(of)n(fer)f(the)i(only)f(w)o(ay)555
4031 y(to)23 b(de\002ne)g(an)g(iteration)f(construct)g(which)g(can)h
(be)g(follo)n(wed)f(by)g(a)i(body)d(of)i(e)o(xpressions,)555
4136 y(it)30 b(is)g(possible)f(to)g(do)g(iteration)f(with)i(functions,)
f(so)h(long)e(as)i(the)f(body)f(of)h(the)g(loop)g(is)555
4241 y(packaged)19 b(up)i(in)g(a)g(function)f(itself.)1625
4211 y Fm(1)1690 4241 y FA(The)h(b)n(uilt\255in)f(function)g
Fs(mapc)p FA(,)g(for)g(e)o(xample,)g(is)i(the)555 4345
y(functional)c(counterpart)g(of)i Fs(dolist)p FA(.)27
b(The)20 b(e)o(xpression)555 4506 y Fs(\(dolist)41 b(\(b)h(bananas\))
642 4606 y(\(peel)g(b\))642 4705 y(\(eat)g(b\)\))p 555
4756 1074 4 v 645 4812 a Fl(1)675 4835 y Fr(It')l(s)19
b(not)g Fi(impossible)i Fr(to)e(write)h(an)f(iteration)j(function)f
(which)e(doesn')o(t)h(need)g(its)f(ar)o(gument)h(wrapped)g(up)f(in)555
4918 y(a)f(function.)29 b(W)-5 b(e)17 b(could)i(write)g(a)f(function)i
(that)f(called)i Fk(eval)d Fr(on)g(e)o(xpressions)i(passed)e(to)h(it)f
(as)g(ar)o(guments.)28 b(F)o(or)555 5001 y(an)17 b(e)o(xplanation)k(of)
c(why)f(it')l(s)i(usually)h(bad)e(to)g(call)i Fk(eval)p
Fr(,)e(see)h(page)g(278.)p eop
%%Page: 164 177
164 176 bop 555 538 a FA(164)960 b Fu(CLASSIC)19 b(MA)n(CR)n(OS)555
801 y FA(has)h(the)h(same)f(side\255ef)n(fects)f(as)555
983 y Fs(\(mapc)42 b(#'\(lambda)d(\(b\))991 1083 y(\(peel)i(b\))991
1183 y(\(eat)h(b\)\))817 1282 y(bananas\))555 1470 y
FA(\(though)17 b(the)i(former)f(returns)g Fs(nil)g FA(and)h(the)g
(latter)g(returns)g(the)g(list)h Fs(bananas)p FA(\).)26
b(W)-7 b(e)21 b(could)555 1574 y(lik)o(e)n(wise)g(implement)d
Fs(forever)g FA(as)j(a)g(function,)555 1757 y Fs(\(defun)41
b(forever)g(\(fn\))642 1857 y(\(do)i(\(\))817 1956 y(\(nil\))729
2056 y(\(funcall)e(fn\)\)\))555 2244 y FA(if)20 b(we)h(were)f(willing)g
(to)g(pass)h(it)g(a)g(closure)e(instead)h(of)g(a)h(body)e(of)g(e)o
(xpressions.)680 2348 y(Ho)n(we)n(v)o(er)m(,)31 b(iteration)f
(constructs)g(usually)h(w)o(ant)g(to)g(do)f(more)h(than)f(just)h
(iterate,)j(as)555 2453 y Fs(forever)23 b FA(does:)39
b(the)o(y)24 b(usually)h(w)o(ant)g(to)h(do)e(a)i(combination)d(of)i
(binding)e(and)i(iteration.)555 2557 y(W)m(ith)14 b(a)g(function,)f
(the)h(prospects)f(for)g(binding)f(are)i(limited.)26
b(If)14 b(you)f(w)o(ant)h(to)f(bind)g(v)n(ariables)555
2662 y(to)27 b(successi)n(v)o(e)f(elements)g(of)g(lists,)j(you)c(can)h
(use)h(one)f(of)g(the)g(mapping)f(functions.)46 b(But)555
2767 y(if)25 b(the)f(requirements)e(get)j(much)e(more)h(complicated)f
(than)h(that,)h(you')o(ll)e(ha)n(v)o(e)h(to)h(write)f(a)555
2871 y(macro.)p eop
%%Page: 165 178
165 177 bop 555 1610 a Fn(12)p 555 1872 2686 3 v 555
2131 a Fx(Generalized)41 b(V)-15 b(ariables)555 2568
y FA(Chapter)34 b(8)g(mentioned)f(that)h(one)g(of)g(the)h(adv)n
(antages)e(of)h(macros)g(is)h(their)f(ability)g(to)555
2672 y(transform)19 b(their)i(ar)o(guments.)30 b(One)21
b(macro)f(of)h(this)g(sort)h(is)g Fs(setf)p FA(.)30 b(This)22
b(chapter)e(looks)g(at)555 2777 y(the)e(implications)g(of)g
Fs(setf)p FA(,)g(and)g(then)f(sho)n(ws)i(some)f(e)o(xamples)g(of)g
(macros)f(which)h(can)h(be)555 2882 y(b)n(uilt)h(upon)f(it.)680
2986 y(Writing)30 b(correct)f(macros)h(on)g Fs(setf)g
FA(is)h(surprisingly)e(dif)n(\002cult.)59 b(T)-7 b(o)31
b(introduce)e(the)555 3091 y(topic,)24 b(the)f(\002rst)h(section)g
(will)g(pro)o(vide)d(a)j(simple)g(e)o(xample)e(which)h(is)h(slightly)f
(incorrect.)555 3195 y(The)d(ne)o(xt)g(section)g(will)i(e)o(xplain)d
(what')-5 b(s)21 b(wrong)e(with)i(this)g(macro,)e(and)h(sho)n(w)h(ho)n
(w)f(to)g(\002x)555 3300 y(it.)39 b(The)22 b(third)h(and)f(fourth)g
(sections)h(present)f(e)o(xamples)g(of)h(utilities)h(b)n(uilt)f(on)g
Fs(setf)p FA(,)f(and)555 3405 y(the)e(\002nal)h(section)f(e)o(xplains)f
(ho)n(w)g(to)i(de\002ne)e(your)g(o)n(wn)h Fs(setf)f FA(in)m(v)o
(ersions.)555 3655 y Fw(12.1)99 b(The)26 b(Concept)555
3846 y FA(The)21 b(b)n(uilt\255in)g(macro)f Fs(setf)g
FA(is)i(a)g(generalization)d(of)i Fs(setq)p FA(.)31 b(The)21
b(\002rst)h(ar)o(gument)d(to)j Fs(setf)555 3950 y FA(can)e(be)g(a)h
(call)f(instead)g(of)g(just)h(a)g(v)n(ariable:)555 4119
y Fs(>)43 b(\(setq)f(lst)g('\(a)g(b)i(c\)\))555 4219
y(\(A)f(B)g(C\))555 4318 y(>)g(\(setf)f(\(car)g(lst\))g(480\))555
4418 y(480)555 4518 y(>)h(lst)555 4617 y(\(480)f(B)h(C\))555
4791 y FA(In)22 b(general)f Fs(\(setf)41 b Ft(x)j(y)p
Fs(\))22 b FA(can)f(be)h(understood)e(as)j(saying)e(\223see)i(to)f(it)g
(that)h Ft(x)f FA(e)n(v)n(aluates)f(to)555 4896 y Ft(y)p
FA(.)-6 b(\224)32 b(As)22 b(a)f(macro,)f Fs(setf)g FA(can)h(look)f
(inside)h(its)h(ar)o(guments)c(to)k(see)f(what)g(needs)g(to)g(be)g
(done)555 5001 y(to)k(mak)o(e)f(such)g(a)h(statement)f(true.)42
b(If)24 b(the)h(\002rst)g(ar)o(gument)d(\(after)i(macroe)o(xpansion\))d
(is)k(a)1835 5229 y(165)p eop
%%Page: 166 179
166 178 bop 555 538 a FA(166)836 b Fu(GENERALIZED)17
b(V)-8 b(ARIABLES)555 801 y FA(symbol,)23 b(the)h Fs(setf)f
FA(just)h(e)o(xpands)e(into)i(a)g Fs(setq)p FA(.)39 b(But)24
b(if)g(the)g(\002rst)g(ar)o(gument)e(is)i(a)h(query)-5
b(,)555 905 y(the)20 b Fs(setf)e FA(e)o(xpands)h(into)g(the)h
(corresponding)c(assertion.)29 b(Since)20 b(the)f(second)g(ar)o(gument)
f(is)555 1010 y(a)j(constant,)e(the)h(preceding)e(e)o(xample)h(could)g
(e)o(xpand)f(into:)555 1187 y Fs(\(progn)41 b(\(rplaca)g(lst)h(480\))g
(480\))555 1370 y FA(This)32 b(transformation)d(from)i(query)g(to)h
(assertion)g(is)g(called)g Ft(in)m(ver)o(sion.)64 b FA(All)33
b(the)f(most)555 1475 y(frequently)26 b(used)i(Common)e(Lisp)j(access)f
(functions)f(ha)n(v)o(e)h(prede\002ned)e(in)m(v)o(ersions,)i(in\255)555
1579 y(cluding)18 b Fs(car)p FA(,)h Fs(cdr)p FA(,)g Fs(nth)p
FA(,)g Fs(aref)p FA(,)f Fs(get)p FA(,)h Fs(gethash)p
FA(,)f(and)h(the)g(access)i(functions)d(created)h(by)555
1684 y Fs(defstruct)p FA(.)26 b(\(The)20 b(full)g(list)h(is)g(in)f
Fr(CL)-6 b(TL)p FA(2,)19 b(p.)h(125.\))680 1789 y(An)35
b(e)o(xpression)f(which)i(can)f(serv)o(e)g(as)i(the)f(\002rst)g(ar)o
(gument)d(to)j Fs(setf)f FA(is)i(called)e(a)555 1893
y Ft(g)o(ener)o(alized)c(variable)o(.)62 b FA(Generalized)31
b(v)n(ariables)g(ha)n(v)o(e)g(turned)f(out)i(to)g(be)f(a)h(po)n(werful)
555 1998 y(abstraction.)d(A)20 b(macro)g(call)h(resembles)f(a)g
(generalized)f(v)n(ariable)g(in)i(that)f(an)o(y)g(macro)f(call)555
2102 y(which)h(e)o(xpands)e(into)i(an)g(in)m(v)o(ertible)f(reference)f
(will)j(itself)g(be)f(in)m(v)o(ertible.)680 2207 y(When)e(we)g(also)h
(write)f(our)g(o)n(wn)g(macros)f(on)h(top)g(of)g Fs(setf)p
FA(,)g(the)g(combination)e(leads)i(to)555 2312 y(noticeably)h(cleaner)i
(programs.)30 b(One)21 b(of)f(the)h(macros)g(we)g(can)g(de\002ne)g(on)f
(top)h(of)g Fs(setf)f FA(is)555 2416 y Fs(toggle)p FA(,)840
2386 y Fm(1)555 2594 y Fs(\(defmacro)40 b(toggle)h(\(obj\))1393
b(;)43 b(wrong)642 2693 y(`\(setf)e(,obj)h(\(not)g(,obj\)\)\))555
2876 y FA(which)20 b(toggles)f(the)h(v)n(alue)g(of)g(a)h(generalized)d
(v)n(ariable:)555 3054 y Fs(>)43 b(\(let)f(\(\(lst)g('\(a)g(b)h
(c\)\)\))729 3153 y(\(toggle)e(\(car)h(lst\)\))729 3253
y(lst\))555 3352 y(\(NIL)g(B)h(C\))680 3535 y FA(No)n(w)22
b(consider)f(the)h(follo)n(wing)f(sample)h(application.)34
b(Suppose)21 b(someone\227a)g(soap\255)555 3640 y(opera)f(writer)m(,)h
(ener)o(getic)f(b)n(usybody)-5 b(,)18 b(or)j(party)g(of)n
(\002cial\227w)o(ants)g(to)g(maintain)f(a)i(database)555
3744 y(of)27 b(all)h(the)g(relations)f(between)f(the)i(inhabitants)e
(of)h(a)h(small)g(to)n(wn.)51 b(Among)26 b(the)h(tables)555
3849 y(required)18 b(is)k(one)d(which)h(records)f(people')-5
b(s)19 b(friends:)555 4027 y Fs(\(defvar)41 b(*friends*)f
(\(make-hash-tabl)o(e\)\))555 4209 y FA(The)35 b(entries)g(in)g(this)h
(hash\255table)e(are)h(themselv)o(es)f(hash\255tables,)k(in)d(which)g
(names)g(of)555 4314 y(potential)19 b(friends)h(are)g(mapped)e(to)j
Fs(t)f FA(or)g Fs(nil)p FA(:)555 4491 y Fs(\(setf)42
b(\(gethash)e('mary)h(*friends*\))f(\(make-hash-table)o(\)\))555
4674 y FA(T)-7 b(o)20 b(mak)o(e)g(John)g(the)g(friend)f(of)h(Mary)-5
b(,)19 b(we)h(w)o(ould)g(say:)555 4852 y Fs(\(setf)42
b(\(gethash)e('john)h(\(gethash)g('mary)g(*friends*\)\))e(t\))p
555 4921 1074 4 v 645 4977 a Fl(1)675 5001 y Fr(This)16
b(de\002nition)j(is)e(not)h(correct,)g(as)f(the)h(follo)n(wing)h
(section)g(will)f(e)o(xplain.)p eop
%%Page: 167 180
167 179 bop 555 538 a Ft(12.2)658 b Fu(THE)18 b(MUL)-5
b(TIPLE)17 b(EV)-8 b(ALU)n(A)h(TION)18 b(PR)n(OBLEM)640
b FA(167)680 801 y(The)23 b(to)n(wn)h(is)h(di)n(vided)e(between)h(tw)o
(o)g(f)o(actions.)41 b(As)25 b(f)o(actions)f(are)g(w)o(ont)g(to)g(do,)h
(each)555 905 y(says)30 b(\223an)o(yone)e(who)h(is)h(not)f(with)h(us)g
(is)h(against)e(us,)-6 b(\224)32 b(so)e(e)n(v)o(eryone)d(in)i(to)n(wn)g
(has)h(been)555 1010 y(compelled)22 b(to)j(join)e(one)h(side)g(or)g
(the)g(other)-5 b(.)40 b(Thus)24 b(when)f(someone)g(switches)i(sides,)g
(all)555 1114 y(his)c(friends)e(become)g(enemies)h(and)f(all)i(his)g
(enemies)f(become)f(friends.)680 1219 y(T)-7 b(o)23 b(toggle)g(whether)
f Fs(x)i FA(is)g(the)g(friend)e(of)h Fs(y)h FA(using)f(only)g(b)n
(uilt\255in)g(operators,)f(we)i(ha)n(v)o(e)555 1324 y(to)c(say:)555
1504 y Fs(\(setf)42 b(\(gethash)e(x)j(\(gethash)d(y)j(*friends*\)\))817
1604 y(\(not)e(\(gethash)g(x)i(\(gethash)d(y)j(*friends*\)\)\)\))555
1790 y FA(which)31 b(is)h(a)g(rather)f(complicated)f(e)o(xpression,)j
(though)c(much)i(simpler)g(than)g(it)h(w)o(ould)555 1894
y(ha)n(v)o(e)19 b(been)f(without)h Fs(setf)p FA(.)28
b(If)19 b(we)h(had)f(de\002ned)f(an)h(access)h(macro)f(upon)f(the)h
(database)g(as)555 1999 y(follo)n(ws:)555 2180 y Fs(\(defmacro)40
b(friend-of)g(\(p)i(q\))642 2279 y(`\(gethash)e(,p)j(\(gethash)d(,q)j
(*friends*\)\)\))555 2460 y FA(then)16 b(between)g(this)h(macro)f(and)g
Fs(toggle)p FA(,)g(we)h(w)o(ould)f(ha)n(v)o(e)g(been)g(better)g
(equipped)f(to)i(deal)555 2560 y(with)k(changes)g(to)g(the)g(database.)
32 b(The)21 b(pre)n(vious)e(update)i(could)f(ha)n(v)o(e)g(been)h(e)o
(xpressed)f(as)555 2659 y(simply:)555 2824 y Fs(\(toggle)41
b(\(friend-of)e(x)k(y\)\))680 2993 y FA(Generalized)32
b(v)n(ariables)h(are)g(lik)o(e)h(a)h(health)e(food)f(that)i(tastes)h
(good.)68 b(The)o(y)33 b(yield)555 3098 y(programs)i(which)h(are)g
(virtuously)f(modular)m(,)j(and)e(yet)h(beautifully)d(ele)o(gant.)77
b(If)36 b(you)555 3202 y(pro)o(vide)31 b(access)i(to)g(your)e(data)i
(structures)f(through)e(macros)i(or)g(in)m(v)o(ertible)f(functions,)555
3307 y(other)f(modules)f(can)h(use)h Fs(setf)e FA(to)i(modify)e(your)g
(data)h(structures)g(without)g(ha)n(ving)f(to)555 3412
y(kno)n(w)19 b(the)h(details)h(of)f(their)g(representation.)555
3664 y Fw(12.2)99 b(The)26 b(Multiple)f(Ev)o(aluation)g(Pr)n(oblem)555
3854 y FA(The)20 b(pre)n(vious)e(section)i(w)o(arned)g(that)g(our)f
(initial)i(de\002nition)e(of)h Fs(toggle)e FA(w)o(as)j(incorrect:)555
4035 y Fs(\(defmacro)40 b(toggle)h(\(obj\))1393 b(;)43
b(wrong)642 4135 y(`\(setf)e(,obj)h(\(not)g(,obj\)\)\))555
4320 y FA(It)16 b(is)g(subject)f(to)g(the)h(problem)d(described)h(in)i
(Section)f(10.1,)g(multiple)f(e)n(v)n(aluation.)26 b(T)m(rouble)555
4425 y(arises)21 b(when)e(its)i(ar)o(gument)d(has)i(side\255ef)n
(fects.)29 b(F)o(or)19 b(e)o(xample,)g(if)h Fs(lst)g
FA(is)h(a)f(list)h(of)f(objects,)555 4530 y(and)g(we)g(write:)555
4710 y Fs(\(toggle)41 b(\(nth)h(\(incf)f(i\))i(lst\)\))555
4896 y FA(then)28 b(we)i(w)o(ould)e(e)o(xpect)g(to)h(be)g(toggling)e
(the)i(\()p Fs(i)p Fj(+)p FA(1\)th)e(element.)55 b(Ho)n(we)n(v)o(er)m
(,)29 b(with)h(the)555 5001 y(current)19 b(de\002nition)g(of)h
Fs(toggle)e FA(this)j(call)f(will)h(e)o(xpand)e(into:)p
eop
%%Page: 168 181
168 180 bop 555 538 a FA(168)836 b Fu(GENERALIZED)17
b(V)-8 b(ARIABLES)555 801 y Fs(\(setf)42 b(\(nth)f(\(incf)h(i\))h
(lst\))817 900 y(\(not)e(\(nth)h(\(incf)g(i\))h(lst\)\)\))555
1088 y FA(This)33 b(increments)e Fs(i)i FA(twice,)i(and)d(sets)i(the)e
(\()p Fs(i)p Fj(+)p FA(1\)th)f(element)h(to)g(the)h(opposite)e(of)i
(the)555 1193 y(\()p Fs(i)p Fj(+)p FA(2\)th)18 b(element.)29
b(So)20 b(in)h(this)f(e)o(xample)555 1375 y Fs(>)43 b(\(let)f(\(\(lst)g
('\(t)g(nil)g(t\)\))904 1475 y(\(i)g(-1\)\))729 1574
y(\(toggle)f(\(nth)h(\(incf)f(i\))i(lst\)\))729 1674
y(lst\))555 1774 y(\(T)g(NIL)f(T\))555 1961 y FA(the)20
b(call)h(to)f Fs(toggle)e FA(seems)j(to)f(ha)n(v)o(e)g(no)g(ef)n(fect.)
680 2066 y(It)25 b(is)h(not)f(enough)e(just)j(to)f(tak)o(e)g(the)g(e)o
(xpression)f(gi)n(v)o(en)g(as)h(an)g(ar)o(gument)e(to)i
Fs(toggle)555 2171 y FA(and)15 b(insert)h(it)g(as)g(the)g(\002rst)g(ar)
o(gument)d(to)j Fs(setf)p FA(.)26 b(W)-7 b(e)17 b(ha)n(v)o(e)e(to)h
(look)e(inside)i(the)f(e)o(xpression)f(to)555 2275 y(see)j(what)g(it)g
(does:)27 b(if)17 b(it)h(contains)d(subforms,)h(we)h(ha)n(v)o(e)f(to)h
(break)e(them)h(apart)h(and)f(e)n(v)n(aluate)555 2380
y(them)24 b(separately)-5 b(,)23 b(in)h(case)h(the)o(y)e(ha)n(v)o(e)g
(side)i(ef)n(fects.)40 b(In)24 b(general,)f(this)i(is)g(a)f
(complicated)555 2484 y(b)n(usiness.)680 2589 y(T)-7
b(o)14 b(mak)o(e)g(it)g(easier)m(,)h(Common)e(Lisp)h(pro)o(vides)f(a)h
(macro)g(which)f(automatically)g(de\002nes)555 2694 y(a)18
b(limited)f(class)h(of)f(macros)f(on)h Fs(setf)p FA(.)27
b(This)18 b(macro)e(is)i(called)f Fs(define-modify-ma)o(cro)o
FA(,)555 2798 y(and)27 b(it)i(tak)o(es)f(three)g(ar)o(guments:)43
b(the)28 b(name)f(of)h(the)g(macro,)g(its)h(additional)e(parameters)555
2903 y(\(after)f(the)g(generalized)e(v)n(ariable\),)i(and)g(the)g(name)
g(of)g(the)g(function)2626 2873 y Fm(2)2684 2903 y FA(which)f(yields)i
(the)555 3007 y(ne)n(w)20 b(v)n(alue)g(for)f(the)h(generalized)f(v)n
(ariable.)680 3112 y(Using)h Fs(define-modify-m)o(acr)o(o)p
FA(,)14 b(we)21 b(could)e(de\002ne)h Fs(toggle)e FA(as)j(follo)n(ws:)
555 3295 y Fs(\(define-modify-m)o(acr)o(o)37 b(toggle)k(\(\))i(not\))
555 3482 y FA(P)o(araphrased,)25 b(this)i(says)f(\223to)g(e)n(v)n
(aluate)f(an)h(e)o(xpression)e(of)h(the)h(form)f Fs(\(toggle)41
b Ft(place)p Fs(\))p FA(,)555 3587 y(\002nd)21 b(the)g(location)f
(speci\002ed)h(by)g Ft(place)p FA(,)f(and)h(if)g(the)h(v)n(alue)e
(stored)h(there)f(is)i Ft(val)p FA(,)f(replace)g(it)555
3691 y(with)f(the)h(v)n(alue)e(of)h Fs(\(not)42 b Ft(val)p
Fs(\))p FA(.)-6 b(\224)29 b(Here)20 b(is)h(the)f(ne)n(w)g(macro)f(used)
h(in)h(the)f(same)g(e)o(xample:)555 3874 y Fs(>)43 b(\(let)f(\(\(lst)g
('\(t)g(nil)g(t\)\))904 3974 y(\(i)g(-1\)\))729 4073
y(\(toggle)f(\(nth)h(\(incf)f(i\))i(lst\)\))729 4173
y(lst\))555 4273 y(\(NIL)f(NIL)g(T\))555 4460 y FA(This)26
b(v)o(ersion)f(gi)n(v)o(es)h(the)g(correct)g(result,)h(b)n(ut)g(it)g
(could)e(be)h(made)g(more)f(general.)47 b(Since)555 4565
y Fs(setf)26 b FA(and)h Fs(setq)f FA(can)h(tak)o(e)g(an)g(arbitrary)e
(number)h(of)h(ar)o(guments,)f(so)i(should)e Fs(toggle)p
FA(.)555 4669 y(W)-7 b(e)18 b(can)f(add)f(this)h(capability)f(by)h
(de\002ning)e(another)h(macro)g(on)g(top)h(of)f(the)h(modify\255macro,)
555 4774 y(as)k(in)f(Figure)g(12.1.)p 555 4845 1074 4
v 645 4901 a Fl(2)675 4925 y Fr(A)c(function)j(name)f(in)f(the)h
(general)h(sense:)25 b(either)19 b Fk(1+)e Fr(or)g Fk(\(lambda)37
b(\(x\))f(\(+)g(x)g(1\)\))p Fr(.)p eop
%%Page: 169 182
169 181 bop 555 538 a Ft(12.3)997 b Fu(NEW)19 b(UTILITIES)977
b FA(169)p 555 745 2678 4 v 553 2665 4 1920 v 605 888
a Fs(\(defmacro)40 b(allf)i(\(val)g(&rest)f(args\))692
988 y(\(with-gensyms)d(\(gval\))779 1087 y(`\(let)k(\(\(,gval)e
(,val\)\))910 1187 y(\(setf)h(,@\(mapcan)f(#'\(lambda)g(\(a\))j(\(list)
e(a)i(gval\)\))1607 1287 y(args\)\)\)\)\))605 1486 y(\(defmacro)d(nilf)
i(\(&rest)f(args\))g(`\(allf)g(nil)i(,@args\)\))605 1685
y(\(defmacro)d(tf)i(\(&rest)g(args\))f(`\(allf)g(t)i(,@args\)\))605
1884 y(\(defmacro)d(toggle)h(\(&rest)g(args\))692 1984
y(`\(progn)823 2084 y(,@\(mapcar)f(#'\(lambda)f(\(a\))k(`\(toggle2)d
(,a\)\))1259 2183 y(args\)\)\))605 2383 y(\(define-modify-m)o(ac)o(ro)d
(toggle2)k(\(\))i(not\))884 2587 y FA(Figure)19 b(12.1:)29
b(Macros)19 b(which)h(operate)f(on)h(generalized)e(v)n(ariables.)p
3231 2665 V 555 2668 2678 4 v 555 2892 a Fw(12.3)99 b(New)25
b(Utilities)555 3083 y FA(This)g(section)f(gi)n(v)o(es)g(some)g(e)o
(xamples)f(of)i(ne)n(w)f(utilities)h(which)f(operate)f(on)h
(generalized)555 3188 y(v)n(ariables.)k(The)o(y)19 b(must)i(be)f
(macros)f(in)i(order)e(to)h(pass)h(their)f(ar)o(guments)e(intact)i(to)g
Fs(setf)p FA(.)680 3292 y(Figure)j(12.1)g(sho)n(ws)h(four)f(ne)n(w)h
(macros)g(b)n(uilt)g(upon)f Fs(setf)p FA(.)40 b(The)24
b(\002rst,)h Fs(allf)p FA(,)f(is)h(for)555 3397 y(setting)k(a)g(number)
e(of)h(generalized)f(v)n(ariables)h(to)g(the)h(same)g(v)n(alue.)54
b(Upon)27 b(it)j(are)e(b)n(uilt)555 3501 y Fs(nilf)18
b FA(and)g Fs(tf)p FA(,)g(which)g(set)i(their)e(ar)o(guments)e(to)j
Fs(nil)f FA(and)g Fs(t)p FA(,)h(respecti)n(v)o(ely)-5
b(.)27 b(These)18 b(macros)555 3606 y(are)i(simple,)g(b)n(ut)g(the)o(y)
g(mak)o(e)f(a)i(dif)n(ference.)680 3711 y(Lik)o(e)e Fs(setq)p
FA(,)g Fs(setf)f FA(can)i(tak)o(e)g(multiple)f(ar)o
(guments\227alternating)d(v)n(ariables)j(and)g(v)n(al\255)555
3815 y(ues:)555 3998 y Fs(\(setf)42 b(x)h(1)g(y)g(2\))555
4185 y FA(So)17 b(can)g(these)g(ne)n(w)g(utilities,)h(b)n(ut)g(you)e
(can)h(skip)g(gi)n(ving)e(half)i(the)g(ar)o(guments.)26
b(If)17 b(you)f(w)o(ant)555 4290 y(to)k(initialize)h(a)f(number)f(of)h
(v)n(ariables)f(to)h Fs(nil)p FA(,)g(instead)g(of)555
4473 y Fs(\(setf)42 b(x)h(nil)f(y)h(nil)g(z)g(nil\))555
4660 y FA(you)19 b(can)h(say)h(just)555 4843 y Fs(\(nilf)42
b(x)h(y)g(z\))p eop
%%Page: 170 183
170 182 bop 555 538 a FA(170)836 b Fu(GENERALIZED)17
b(V)-8 b(ARIABLES)p 555 745 2678 4 v 553 2067 4 1322
v 605 888 a Fs(\(define-modify-m)o(ac)o(ro)37 b(concf)42
b(\(obj\))f(nconc\))605 1087 y(\(define-modify-m)o(ac)o(ro)c(conc1f)k
(\(obj\))692 1187 y(\(lambda)g(\(place)g(obj\))779 1287
y(\(nconc)g(place)h(\(list)f(obj\)\)\)\))605 1486 y(\(define-modify-m)o
(ac)o(ro)c(concnew)k(\(obj)h(&rest)f(args\))692 1586
y(\(lambda)g(\(place)g(obj)h(&rest)g(args\))779 1685
y(\(unless)f(\(apply)g(#'member)f(obj)j(place)e(args\))866
1785 y(\(nconc)g(place)h(\(list)f(obj\)\)\)\)\))1005
1989 y FA(Figure)19 b(12.2:)28 b(List)21 b(operations)e(on)h
(generalized)e(v)n(ariables.)p 3231 2067 V 555 2070 2678
4 v 555 2285 a(The)25 b(last)h(macro,)g Fs(toggle)p FA(,)f(w)o(as)h
(described)e(in)i(the)f(pre)n(vious)f(section:)40 b(it)26
b(is)g(lik)o(e)g Fs(nilf)p FA(,)555 2390 y(b)n(ut)20
b(gi)n(v)o(es)g(each)g(of)g(its)h(ar)o(guments)d(the)i(opposite)f
(truth)h(v)n(alue.)680 2495 y(These)14 b(four)g(macros)g(illustrate)g
(an)f(impo)o(rtan)o(t)h(p)o(oint)f(abo)o(ut)h(o)o(pe)o(rato)o(rs)g(fo)o
(r)g(assign)o(men)o(t.)555 2599 y(Ev)o(en)j(if)i(we)g(only)e(intend)h
(to)g(use)h(an)f(operator)f(on)h(ordinary)e(v)n(ariables,)i(it')-5
b(s)19 b(w)o(orth)f(writing)555 2704 y(it)23 b(to)f(e)o(xpand)f(into)h
(a)g Fs(setf)g FA(instead)g(of)g(a)g Fs(setq)p FA(.)35
b(If)22 b(the)g(\002rst)h(ar)o(gument)d(is)j(a)g(symbol,)f(the)555
2808 y Fs(setf)d FA(will)j(e)o(xpand)c(into)i(a)h Fs(setq)e
FA(an)o(yw)o(ay)-5 b(.)29 b(Since)20 b(we)h(can)f(ha)n(v)o(e)g(the)g
(generality)f(of)i Fs(setf)555 2913 y FA(at)g(no)e(e)o(xtra)h(cost,)g
(it)h(is)g(rarely)f(desirable)f(to)h(use)h Fs(setq)e
FA(in)h(a)h(macroe)o(xpansion.)680 3018 y(Figure)14 b(12.2)g(contains)g
(three)g(macros)g(for)h(destructi)n(v)o(ely)e(modifying)f(the)j(ends)g
(of)f(lists.)555 3122 y(Section)20 b(3.1)f(mentioned)g(that)h(it)h(is)g
(unsafe)e(to)i(rely)f(on)555 3293 y Fs(\(nconc)41 b(x)i(y\))555
3469 y FA(for)20 b(side\255ef)n(fects,)f(and)g(that)i(one)e(must)h
(write)h(instead)555 3641 y Fs(\(setq)42 b(x)h(\(nconc)e(x)i(y\)\))555
3817 y FA(This)25 b(idiom)g(is)h(embodied)d(in)j Fs(concf)p
FA(.)42 b(The)25 b(more)f(specialized)h Fs(conc1f)e FA(and)i
Fs(concnew)555 3921 y FA(are)17 b(lik)o(e)h Fs(push)e
FA(and)h Fs(pushnew)e FA(for)i(the)g(other)g(end)g(of)g(the)g(list:)30
b Fs(conc1f)15 b FA(adds)i(one)g(element)555 4026 y(to)27
b(the)g(end)g(of)f(a)i(list,)h(and)e Fs(concnew)e FA(does)h(the)h
(same,)i(b)n(ut)e(only)f(if)h(the)h(element)e(is)i(not)555
4130 y(already)19 b(a)i(member)-5 b(.)680 4235 y(Section)16
b(2.2)h(mentioned)e(that)i(the)g(name)g(of)g(a)g(function)f(can)h(be)g
(a)g(lambda\255e)o(xpression)555 4340 y(as)30 b(well)f(as)h(a)f
(symbol.)55 b(Thus)28 b(it)i(is)g(\002ne)f(to)g(gi)n(v)o(e)f(a)h(whole)
g(lambda\255e)o(xpression)c(as)30 b(the)555 4444 y(third)18
b(ar)o(gument)e(to)i Fs(define-modify-ma)o(cro)o FA(,)13
b(as)19 b(in)g(the)f(de\002nition)f(of)h Fs(conc1f)p
FA(.)27 b(Using)555 4549 y Fs(conc1)19 b FA(from)g(page)g(45,)h(this)h
(macro)e(could)g(also)i(ha)n(v)o(e)e(been)h(written:)555
4720 y Fs(\(define-modify-m)o(acr)o(o)37 b(conc1f)k(\(obj\))h(conc1\))
680 4896 y FA(The)29 b(macros)g(in)h(Figure)e(12.2)h(should)g(be)g
(used)g(with)h(one)f(reserv)n(ation.)56 b(If)29 b(you')l(re)555
5001 y(planning)18 b(to)j(b)n(uild)f(a)g(list)h(by)f(adding)f(elements)
h(to)g(the)g(end,)g(it)h(may)f(be)g(preferable)e(to)i(use)p
eop
%%Page: 171 184
171 183 bop 555 538 a Ft(12.4)826 b Fu(MORE)19 b(COMPLEX)f(UTILITIES)
807 b FA(171)555 801 y Fs(push)p FA(,)20 b(and)h(then)g
Fs(nreverse)e FA(the)i(list.)34 b(It)22 b(is)g(cheaper)e(to)i(do)f
(something)f(to)h(the)h(front)e(of)h(a)555 905 y(list)f(than)e(to)i
(the)e(end,)h(because)f(to)h(do)g(something)e(to)i(the)g(end)f(you)g
(ha)n(v)o(e)h(to)g(get)g(there)f(\002rst.)555 1010 y(It)25
b(is)h(probably)d(to)i(encourage)e(ef)n(\002cient)h(programming)e(that)
j(Common)e(Lisp)j(has)f(man)o(y)555 1114 y(operators)19
b(for)g(the)h(former)f(and)h(fe)n(w)g(for)f(the)i(latter)-5
b(.)555 1365 y Fw(12.4)99 b(Mor)n(e)25 b(Complex)g(Utilities)555
1556 y FA(Not)e(all)g(macros)e(on)h Fs(setf)g FA(can)g(be)g(de\002ned)g
(with)g Fs(define-modify-mac)o(ro)o FA(.)31 b(Suppose,)555
1660 y(for)14 b(e)o(xample,)d(that)j(we)g(w)o(ant)g(to)g(de\002ne)g(a)g
(macro)p 1976 1660 27 4 v 39 w Fs(f)g FA(for)g(applying)g(a)g(fu)o
(nctio)o(n)f(destru)o(cti)n(v)o(e)o(ly)555 1765 y(to)20
b(a)g(generalized)e(v)n(ariable.)28 b(The)20 b(b)n(uilt\255in)f(macro)g
Fs(incf)f FA(is)j(an)f(abbre)n(viation)d(for)i Fs(setf)g
FA(of)555 1870 y Fs(+)p FA(.)29 b(Instead)20 b(of)555
2041 y Fs(\(setf)42 b(x)h(\(+)f(x)i(y\)\))555 2218 y
FA(we)21 b(say)f(just)555 2390 y Fs(\(incf)42 b(x)h(y\))555
2566 y FA(The)22 b(ne)n(w)p 871 2566 V 53 w Fs(f)g FA(is)h(to)f(be)g(a)
h(generalization)d(of)i(this)g(idea:)33 b(while)22 b
Fs(incf)f FA(e)o(xpands)g(into)h(a)g(call)555 2671 y(to)27
b Fs(+)p FA(,)p 745 2671 V 59 w Fs(f)g FA(will)g(e)o(xpand)e(into)h(a)h
(call)g(to)g(the)f(operator)f(gi)n(v)o(en)g(as)i(the)g(\002rst)g(ar)o
(gument.)46 b(F)o(or)555 2776 y(e)o(xample,)19 b(in)h(the)g
(de\002nition)f(of)h Fs(scale-objs)d FA(on)i(page)h(115,)f(we)i(had)e
(to)i(write)555 2947 y Fs(\(setf)42 b(\(obj-dx)e(o\))j(\(*)g(\(obj-dx)d
(o\))j(factor\)\))555 3124 y FA(W)m(ith)p 744 3124 V
52 w Fs(f)20 b FA(this)h(will)g(become)555 3295 y Fs(\(_f)42
b(*)i(\(obj-dx)c(o\))j(factor\))555 3472 y FA(The)20
b(incorrect)f(w)o(ay)h(to)g(write)p 1461 3472 V 52 w
Fs(f)g FA(w)o(ould)g(be:)555 3644 y Fs(\(defmacro)40
b(_f)j(\(op)f(place)f(&rest)h(args\))870 b(;)43 b(wrong)642
3743 y(`\(setf)e(,place)g(\(,op)h(,place)f(,@args\)\)\))555
3920 y FA(Unfortunately)-5 b(,)12 b(we)j(can')o(t)f(de\002ne)g(a)h
(correct)p 1865 3920 V 45 w Fs(f)f FA(with)h Fs(define-modify-ma)o(cro)
o FA(,)10 b(because)555 4025 y(the)20 b(operator)f(to)h(be)g(applied)f
(to)i(the)f(generalized)e(v)n(ariable)h(is)i(gi)n(v)o(en)e(as)i(an)f
(ar)o(gument.)680 4129 y(More)e(comple)o(x)e(macros)i(lik)o(e)h(this)g
(one)f(ha)n(v)o(e)g(to)h(be)g(written)f(by)g(hand.)28
b(T)-7 b(o)19 b(mak)o(e)f(such)555 4234 y(macros)j(easier)h(to)g
(write,)g(Common)f(Lisp)h(pro)o(vides)e(the)h(function)f
Fs(get-setf-method)p FA(,)555 4339 y(which)27 b(tak)o(es)i(a)f
(generalized)e(v)n(ariable)h(and)g(returns)g(all)i(the)f(information)d
(necessary)i(to)555 4443 y(retrie)n(v)o(e)13 b(or)g(set)g(its)g(v)n
(alue.)26 b(W)-7 b(e)13 b(will)g(see)g(ho)n(w)g(to)g(use)g(this)g
(information)g(by)g(hand\255generating)555 4548 y(an)20
b(e)o(xpansion)e(for:)555 4719 y Fs(\(incf)42 b(\(aref)f(a)i(\(incf)f
(i\)\)\))680 4896 y FA(When)30 b(we)h(call)h Fs(get-setf-method)25
b FA(on)30 b(the)h(generalized)e(v)n(ariable,)k(we)e(get)g(\002v)o(e)
555 5001 y(v)n(alues)20 b(intended)e(for)i(use)g(as)h(ingredients)e(in)
h(the)h(macroe)o(xpansion:)p eop
%%Page: 172 185
172 184 bop 555 538 a FA(172)836 b Fu(GENERALIZED)17
b(V)-8 b(ARIABLES)555 801 y Fs(>)43 b(\(get-setf-method)37
b('\(aref)k(a)i(\(incf)f(i\)\)\))555 900 y(\(#:G4)g(#:G5\))555
1000 y(\(A)h(\(INCF)e(I\)\))555 1100 y(\(#:G6\))555 1199
y(\(SYSTEM:SET-AREF)c(#:G6)42 b(#:G4)g(#:G5\))555 1299
y(\(AREF)g(#:G4)f(#:G5\))555 1486 y FA(The)20 b(\002rst)h(tw)o(o)g(v)n
(alues)f(are)g(lists)i(of)e(temporary)f(v)n(ariables)g(and)h(the)h(v)n
(alues)f(that)g(should)g(be)555 1591 y(assigned)g(to)g(them.)29
b(So)20 b(we)h(can)f(be)o(gin)f(the)h(e)o(xpansion)e(with:)555
1774 y Fs(\(let*)42 b(\(\(#:g4)f(a\))860 1873 y(\(#:g5)h(\(incf)f
(i\)\)\))642 1973 y(...\))555 2161 y FA(These)20 b(bindings)f(should)g
(be)h(created)f(in)i(a)f Fs(let*)f FA(because)h(in)g(the)g(general)f
(case)i(the)f(v)n(alue)555 2265 y(forms)j(can)h(refer)f(to)h(earlier)f
(v)n(ariables.)40 b(The)23 b(third)2090 2235 y Fm(3)2147
2265 y FA(and)g(\002fth)h(v)n(alues)g(are)f(another)g(tem\255)555
2370 y(porary)c(v)n(ariable)h(and)g(the)h(form)f(that)g(will)i(return)e
(the)g(original)g(v)n(alue)g(of)h(the)f(generalized)555
2474 y(v)n(ariable.)28 b(Since)20 b(we)h(w)o(ant)f(to)h(add)e
Fs(1)i FA(to)f(this)h(v)n(alue,)e(we)h(wrap)g(the)g(latter)h(in)f(a)h
(call)f(to)h Fs(1+)p FA(:)555 2657 y Fs(\(let*)42 b(\(\(#:g4)f(a\))860
2757 y(\(#:g5)h(\(incf)f(i\)\))860 2856 y(\(#:g6)h(\(1+)g(\(aref)f
(#:g4)h(#:g5\)\)\)\))642 2956 y(...\))555 3144 y FA(Finally)-5
b(,)29 b(the)e(fourth)f(v)n(alue)h(returned)f(by)h Fs(get-setf-method)
22 b FA(is)29 b(the)f(assignment)e(that)555 3248 y(must)20
b(be)g(made)g(within)g(the)g(scope)g(of)g(the)g(ne)n(w)g(bindings:)555
3431 y Fs(\(let*)42 b(\(\(#:g4)f(a\))860 3530 y(\(#:g5)h(\(incf)f
(i\)\))860 3630 y(\(#:g6)h(\(1+)g(\(aref)f(#:g4)h(#:g5\)\)\)\))642
3730 y(\(system:set-aref)37 b(#:g6)42 b(#:g4)g(#:g5\)\))555
3917 y FA(More)22 b(often)h(than)f(not,)h(this)h(form)e(will)i(refer)e
(to)h(internal)f(functions)g(which)g(are)h(not)g(part)555
4022 y(of)f(Common)f(Lisp.)36 b(Usually)23 b Fs(setf)e
FA(masks)i(the)f(presence)g(of)g(these)g(functions,)g(b)n(ut)g(the)o(y)
555 4127 y(ha)n(v)o(e)j(to)h(e)o(xist)g(some)n(where.)44
b(Ev)o(erything)23 b(about)h(them)i(is)g(implementation\255dependent,)
555 4231 y(so)i(portable)f(code)g(should)g(use)h(forms)f(returned)f(by)
h Fs(get-setf-method)p FA(,)d(rather)j(than)555 4336
y(referring)18 b(directly)i(to)g(functions)f(lik)o(e)h
Fs(system:set-aref)p FA(.)680 4440 y(No)n(w)14 b(to)h(implement)p
1310 4440 27 4 v 45 w Fs(f)g FA(we)g(write)g(a)h(macro)d(which)i(does)f
(almost)h(e)o(xactly)f(what)h(we)g(did)555 4545 y(when)22
b(e)o(xpanding)e Fs(incf)h FA(by)h(hand.)35 b(The)22
b(only)g(dif)n(ference)f(is)i(that,)g(instead)f(of)g(wrapping)555
4650 y(the)h(last)h(form)e(in)h(the)g Fs(let*)f FA(in)h(a)h(call)f(to)h
Fs(1+)p FA(,)f(we)g(wrap)g(it)h(in)f(an)g(e)o(xpression)e(made)i(from)
555 4754 y(the)d(ar)o(guments)e(to)p 1133 4754 V 52 w
Fs(f)p FA(.)29 b(The)20 b(de\002nition)f(of)p 1837 4754
V 52 w Fs(f)h FA(is)h(sho)n(wn)f(in)g(Figure)f(12.3.)p
555 4825 1074 4 v 645 4881 a Fl(3)675 4904 y Fr(The)e(third)h(v)n(alue)
i(is)d(currently)j(al)o(w)o(ays)f(a)f(list)g(of)g(one)g(element.)27
b(It)18 b(is)f(returned)i(as)f(a)f(list)i(to)f(pro)o(vide)h(the)f(\(so)
555 4987 y(f)o(ar)g(unconsummated\))h(potential)h(to)d(store)h
(multiple)h(v)n(alues)f(in)g(generalized)j(v)n(ariables.)p
eop
%%Page: 173 186
173 185 bop 555 538 a Ft(12.4)826 b Fu(MORE)19 b(COMPLEX)f(UTILITIES)
807 b FA(173)p 555 924 2678 4 v 553 4736 4 3813 v 605
1066 a Fs(\(defmacro)40 b(_f)i(\(op)h(place)e(&rest)h(args\))692
1166 y(\(multiple-value-)o(bin)o(d)37 b(\(vars)42 b(forms)f(var)i(set)f
(access\))1607 1266 y(\(get-setf-method)37 b(place\))779
1365 y(`\(let*)k(\(,@\(mapcar)f(#'list)h(vars)h(forms\))1128
1465 y(\(,\(car)f(var\))h(\(,op)g(,access)f(,@args\)\)\))910
1565 y(,set\)\)\))605 1764 y(\(defmacro)f(pull)i(\(obj)g(place)f(&rest)
h(args\))692 1863 y(\(multiple-value-)o(bin)o(d)37 b(\(vars)42
b(forms)f(var)i(set)f(access\))1607 1963 y(\(get-setf-method)37
b(place\))779 2063 y(\(let)42 b(\(\(g)g(\(gensym\)\)\))866
2162 y(`\(let*)f(\(\(,g)h(,obj\))1215 2262 y(,@\(mapcar)e(#'list)h
(vars)h(forms\))1215 2362 y(\(,\(car)f(var\))h(\(delete)f(,g)i(,access)
d(,@args\)\)\))997 2461 y(,set\)\)\)\))605 2660 y(\(defmacro)g(pull-if)
g(\(test)i(place)f(&rest)h(args\))692 2760 y(\(multiple-value-)o(bin)o
(d)37 b(\(vars)42 b(forms)f(var)i(set)f(access\))1607
2860 y(\(get-setf-method)37 b(place\))779 2959 y(\(let)42
b(\(\(g)g(\(gensym\)\)\))866 3059 y(`\(let*)f(\(\(,g)h(,test\))1215
3159 y(,@\(mapcar)e(#'list)h(vars)h(forms\))1215 3258
y(\(,\(car)f(var\))h(\(delete-if)e(,g)i(,access)f(,@args\)\)\))997
3358 y(,set\)\)\)\))605 3557 y(\(defmacro)f(popn)i(\(n)g(place\))692
3657 y(\(multiple-value-)o(bin)o(d)37 b(\(vars)42 b(forms)f(var)i(set)f
(access\))1607 3756 y(\(get-setf-method)37 b(place\))779
3856 y(\(with-gensyms)h(\(gn)43 b(glst\))866 3956 y(`\(let*)e(\(\(,gn)h
(,n\))1215 4055 y(,@\(mapcar)e(#'list)h(vars)h(forms\))1215
4155 y(\(,glst)f(,access\))1215 4254 y(\(,\(car)g(var\))h(\(nthcdr)f
(,gn)h(,glst\)\)\))997 4354 y(\(prog1)f(\(subseq)g(,glst)g(0)j(,gn\))
1302 4454 y(,set\)\)\)\)\))1143 4658 y FA(Figure)20 b(12.3:)28
b(More)19 b(comple)o(x)g(macros)g(on)h Fs(setf)p FA(.)p
3231 4736 V 555 4739 2678 4 v eop
%%Page: 174 187
174 186 bop 555 538 a FA(174)836 b Fu(GENERALIZED)17
b(V)-8 b(ARIABLES)680 801 y FA(This)25 b(utility)f(is)i(quite)f(a)g
(useful)f(one.)43 b(No)n(w)24 b(that)h(we)g(ha)n(v)o(e)g(it,)h(for)e(e)
o(xample,)h(we)g(can)555 905 y(easily)18 b(replace)g(an)o(y)f(named)g
(function)f(with)i(a)h(memoized)d(\(Section)h(5.3\))g(equi)n(v)n
(alent.)3094 875 y Fm(4)3154 905 y FA(T)-7 b(o)555 1010
y(memoize)19 b Fs(foo)h FA(we)g(w)o(ould)g(say:)555 1193
y Fs(\(_f)42 b(memoize)f(\(symbol-function)c('foo\)\))680
1380 y FA(Ha)n(ving)p 952 1380 27 4 v 54 w Fs(f)24 b
FA(also)g(mak)o(es)g(it)g(easy)g(to)g(de\002ne)f(other)g(macros)g(on)h
Fs(setf)p FA(.)39 b(F)o(or)23 b(e)o(xample,)555 1485
y(we)e(could)e(no)n(w)g(de\002ne)h Fs(conc1f)e FA(\(Figure)i(12.2\))e
(as:)555 1667 y Fs(\(defmacro)40 b(conc1f)h(\(lst)h(obj\))642
1767 y(`\(_f)g(nconc)g(,lst)g(\(list)f(,obj\)\)\))680
1955 y FA(Figure)29 b(12.3)g(contains)g(some)h(other)f(useful)h(macros)
f(on)h Fs(setf)p FA(.)58 b(The)29 b(ne)o(xt,)j Fs(pull)p
FA(,)555 2059 y(is)g(intended)d(as)j(a)f(complement)e(to)i(the)g(b)n
(uilt\255in)f Fs(pushnew)p FA(.)59 b(The)30 b(pair)h(are)f(lik)o(e)h
(more)555 2164 y(discerning)20 b(v)o(ersions)h(of)h Fs(push)f
FA(and)g Fs(pop)p FA(;)h Fs(pushnew)e FA(pushes)i(a)g(ne)n(w)g(element)
f(onto)g(a)h(list)555 2268 y(if)i(it)h(is)g(not)e(already)g(a)h(member)
m(,)f(and)h Fs(pull)f FA(destructi)n(v)o(ely)f(remo)o(v)o(es)g
(selected)i(elements)555 2373 y(from)19 b(a)h(list.)30
b(The)19 b Fs(&rest)f FA(parameter)g(in)i Fs(pull)p FA(')-5
b(s)19 b(de\002nition)g(mak)o(es)g Fs(pull)g FA(able)g(to)h(accept)555
2478 y(all)h(the)f(same)g(k)o(e)o(yw)o(ord)f(parameters)g(as)i
Fs(delete)p FA(:)555 2660 y Fs(>)43 b(\(setq)f(x)h('\(1)f(2)h(\(a)g
(b\))g(3\)\))555 2760 y(\(1)g(2)g(\(A)g(B\))f(3\))555
2860 y(>)h(\(pull)f(2)h(x\))555 2959 y(\(1)g(\(A)g(B\))f(3\))555
3059 y(>)h(\(pull)f('\(a)g(b\))h(x)g(:test)e(#'equal\))555
3158 y(\(1)i(3\))555 3258 y(>)g(x)555 3358 y(\(1)g(3\))555
3540 y FA(Y)-9 b(ou)20 b(could)f(almost)h(think)f(of)h(this)h(macro)e
(as)i(if)g(it)g(were)f(de\002ned:)555 3706 y Fs(\(defmacro)40
b(pull)i(\(obj)g(seq)g(&rest)g(args\))826 b(;)43 b(wrong)642
3806 y(`\(setf)e(,seq)h(\(delete)f(,obj)h(,seq)g(,@args\)\)\))555
3977 y FA(though)14 b(if)j(it)f(really)g(were)g(de\002ned)f(that)h(w)o
(ay)-5 b(,)16 b(it)h(w)o(ould)f(be)g(subject)f(to)i(problems)d(with)i
(both)555 4082 y(order)21 b(and)g(number)f(of)h(e)n(v)n(aluations.)33
b(W)-7 b(e)23 b(could)e(de\002ne)g(a)h(v)o(ersion)f(of)g
Fs(pull)g FA(as)h(a)h(simple)555 4186 y(modify\255macro:)555
4369 y Fs(\(define-modify-m)o(acr)o(o)37 b(pull)42 b(\(obj)g(&rest)g
(args\))642 4469 y(\(lambda)f(\(seq)h(obj)g(&rest)g(args\))729
4568 y(\(apply)f(#'delete)g(obj)h(seq)g(args\)\)\))p
555 4640 1074 4 v 645 4695 a Fl(4)675 4718 y Fr(Built\255in)31
b(functions)f(should)g(not)f(be)h(memoized)g(in)f(this)g(w)o(ay)l(,)j
(though.)61 b(Common)29 b(Lisp)f(forbids)i(the)555 4801
y(rede\002nition)20 b(of)d(b)o(uilt\255in)i(functions.)p
eop
%%Page: 175 188
175 187 bop 555 538 a Ft(12.4)826 b Fu(MORE)19 b(COMPLEX)f(UTILITIES)
807 b FA(175)555 801 y(b)n(ut)15 b(since)g(modify\255macros)d(must)j
(tak)o(e)g(the)g(generalized)e(v)n(ariable)h(as)i(their)e(\002rst)i(ar)
o(gument,)555 905 y(we)24 b(w)o(ould)f(ha)n(v)o(e)h(to)g(gi)n(v)o(e)f
(the)h(\002rst)g(tw)o(o)g(ar)o(guments)e(in)i(re)n(v)o(erse)f(order)m
(,)g(which)g(w)o(ould)h(be)555 1010 y(less)d(intuiti)n(v)o(e.)680
1114 y(The)k(more)h(general)f Fs(pull-if)f FA(tak)o(es)i(an)g(initial)h
(function)d(ar)o(gument,)i(and)f(e)o(xpands)555 1219
y(into)20 b(a)h Fs(delete-if)c FA(instead)j(of)f(a)i
Fs(delete)p FA(:)555 1402 y Fs(>)43 b(\(let)f(\(\(lst)g('\(1)g(2)h(3)g
(4)g(5)h(6\)\)\))729 1501 y(\(pull-if)d(#'oddp)g(lst\))729
1601 y(lst\))555 1701 y(\(2)i(4)g(6\))555 1888 y FA(These)15
b(tw)o(o)g(macros)g(illustrate)g(another)f(general)g(point.)26
b(If)15 b(the)g(underlying)e(function)g(tak)o(es)555
1993 y(optional)22 b(ar)o(guments,)f(so)j(should)e(the)h(macro)f(b)n
(uilt)h(upon)f(it.)38 b(Both)23 b Fs(pull)f FA(and)h
Fs(pull-if)555 2097 y FA(pass)e(optional)e(ar)o(guments)f(on)i(to)g
(their)g Fs(delete)p FA(s.)680 2202 y(The)j(\002nal)i(macro)e(in)h
(Figure)g(12.3,)g Fs(popn)p FA(,)g(is)h(a)g(generalization)d(of)i
Fs(pop)p FA(.)40 b(Instead)24 b(of)555 2307 y(popping)c(just)i(one)g
(element)f(of)h(a)h(list,)g(it)g(pops)e(and)h(returns)f(a)h
(subsequence)e(of)i(arbitrary)555 2411 y(length:)555
2594 y Fs(>)43 b(\(setq)f(x)h('\(a)f(b)h(c)h(d)f(e)g(f\)\))555
2694 y(\(A)g(B)g(C)g(D)g(E)g(F\))555 2793 y(>)g(\(popn)f(3)h(x\))555
2893 y(\(A)g(B)g(C\))555 2992 y(>)g(x)555 3092 y(\(D)g(E)g(F\))680
3280 y FA(Figure)13 b(12.4)f(contains)h(a)h(macro)f(which)g(sorts)h
(its)h(ar)o(guments.)25 b(If)13 b Fs(x)h FA(and)f Fs(y)h
FA(are)f(v)n(ariables)555 3384 y(and)24 b(we)g(w)o(ant)g(to)h(ensure)e
(that)h Fs(x)g FA(does)g(not)g(ha)n(v)o(e)g(the)g(lo)n(wer)f(of)h(the)g
(tw)o(o)h(v)n(alues,)f(we)h(can)555 3489 y(write:)555
3672 y Fs(\(if)42 b(\(>)h(y)g(x\))g(\(rotatef)d(x)j(y\)\))555
3859 y FA(But)29 b(if)f(we)h(w)o(ant)f(to)g(do)g(this)h(for)e(three)h
(or)g(more)f(v)n(ariables,)i(the)f(code)g(required)e(gro)n(ws)555
3964 y(rapidly)-5 b(.)44 b(Instead)25 b(of)g(writing)g(it)i(by)e(hand,)
h(we)g(can)f(ha)n(v)o(e)g Fs(sortf)f FA(write)i(it)g(for)f(us.)46
b(This)555 4068 y(macro)17 b(tak)o(es)i(a)f(comparison)e(operator)h
(plus)h(an)o(y)f(number)f(of)i(generalized)f(v)n(ariables,)g(and)555
4173 y(sw)o(aps)32 b(their)e(v)n(alues)h(until)g(the)o(y)f(are)h(in)g
(the)h(order)d(dictated)i(by)f(the)h(operator)-5 b(.)61
b(In)31 b(the)555 4278 y(simplest)21 b(case,)f(the)g(ar)o(guments)e
(could)i(be)g(ordinary)e(v)n(ariables:)555 4460 y Fs(>)43
b(\(setq)f(x)h(1)g(y)g(2)g(z)h(3\))555 4560 y(3)555 4660
y(>)f(\(sortf)e(>)i(x)h(y)f(z\))555 4759 y(3)555 4859
y(>)g(\(list)f(x)h(y)g(z\))555 4958 y(\(3)g(2)g(1\))p
eop
%%Page: 176 189
176 188 bop 555 538 a FA(176)836 b Fu(GENERALIZED)17
b(V)-8 b(ARIABLES)p 555 745 2678 4 v 553 3362 4 2617
v 605 888 a Fs(\(defmacro)40 b(sortf)h(\(op)i(&rest)e(places\))692
988 y(\(let*)h(\(\(meths)e(\(mapcar)h(#'\(lambda)f(\(p\))1825
1087 y(\(multiple-value-l)o(is)o(t)1912 1187 y(\(get-setf-method)d
(p\)\)\))1651 1287 y(places\)\))997 1386 y(\(temps)k(\(apply)g
(#'append)g(\(mapcar)f(#'third)h(meths\)\)\)\))779 1486
y(`\(let*)g(,\(mapcar)g(#'list)1477 1586 y(\(mapcan)f(#'\(lambda)g
(\(m\))2000 1685 y(\(append)g(\(first)h(m\))2348 1785
y(\(third)g(m\)\)\))1825 1884 y(meths\))1477 1984 y(\(mapcan)f
(#'\(lambda)g(\(m\))2000 2084 y(\(append)g(\(second)h(m\))2348
2183 y(\(list)h(\(fifth)f(m\)\)\)\))1825 2283 y(meths\)\))910
2383 y(,@\(mapcon)f(#'\(lambda)g(\(rest\))1520 2482 y(\(mapcar)1607
2582 y(#'\(lambda)g(\(arg\))1782 2681 y(`\(unless)g(\(,op)i(,\(car)f
(rest\))h(,arg\))1912 2781 y(\(rotatef)f(,\(car)g(rest\))h(,arg\)\)\))
1607 2881 y(\(cdr)g(rest\)\)\))1346 2980 y(temps\))910
3080 y(,@\(mapcar)e(#'fourth)g(meths\)\)\)\))1088 3284
y FA(Figure)20 b(12.4:)28 b(A)21 b(macro)e(which)h(sorts)g(its)i(ar)o
(guments.)p 3231 3362 V 555 3366 2678 4 v 555 3590 a(In)15
b(general,)g(the)o(y)g(could)f(be)h(an)o(y)g(in)m(v)o(ertible)e(e)o
(xpressions.)26 b(Suppose)15 b Fs(cake)f FA(is)i(an)f(in)m(v)o(ertible)
555 3694 y(function)29 b(which)h(returns)g(someone')-5
b(s)30 b(piece)g(of)h(cak)o(e,)i(and)d Fs(bigger)f FA(is)i(a)h
(comparison)555 3799 y(function)22 b(de\002ned)g(on)h(pieces)g(of)h
(cak)o(e.)38 b(If)24 b(we)f(w)o(ant)h(to)f(enforce)f(the)i(rule)f(that)
g(the)h Fs(cake)555 3904 y FA(of)19 b Fs(moe)g FA(is)h(no)f(less)h
(than)f(the)g Fs(cake)f FA(of)h Fs(larry)p FA(,)f(which)h(is)h(no)f
(less)h(than)f(that)g(of)g Fs(curly)p FA(,)f(we)555 4008
y(write:)555 4191 y Fs(\(sortf)41 b(bigger)g(\(cake)h('moe\))f(\(cake)h
('larry\))e(\(cake)i('curly\)\))680 4378 y FA(The)26
b(de\002nition)h(of)f Fs(sortf)g FA(is)i(similar)g(in)f(outline)g(to)g
(that)g(of)p 2564 4378 27 4 v 59 w Fs(f)p FA(.)50 b(It)27
b(be)o(gins)g(with)g(a)555 4483 y Fs(let*)16 b FA(in)i(which)f(the)g
(temporary)f(v)n(ariables)g(returned)g(by)h Fs(get-setf-method)12
b FA(are)17 b(bound)555 4588 y(to)j(the)h(initial)f(v)n(alues)g(of)g
(the)h(generalized)d(v)n(ariables.)29 b(The)20 b(core)g(of)g
Fs(sortf)f FA(is)i(the)f(central)555 4692 y Fs(mapcon)f
FA(e)o(xpression,)h(which)g(generates)g(code)h(to)g(sort)g(these)g
(temporary)e(v)n(ariables.)31 b(The)555 4797 y(code)18
b(generated)f(by)h(this)h(portion)e(of)i(the)f(macro)g(gro)n(ws)g(e)o
(xponentially)e(with)j(the)f(number)555 4902 y(of)27
b(ar)o(guments.)50 b(After)28 b(sorting,)g(the)g(generalized)e(v)n
(ariables)h(are)h(reassigned)e(using)i(the)p eop
%%Page: 177 190
177 189 bop 555 538 a Ft(12.4)826 b Fu(MORE)19 b(COMPLEX)f(UTILITIES)
807 b FA(177)p 555 745 2678 4 v 553 2977 4 2232 v 605
888 a Fs(\(sortf)41 b(>)i(x)g(\(aref)f(ar)h(\(incf)e(i\)\))h(\(car)g
(lst\)\))605 1117 y FA(e)o(xpands)18 b(\(in)i(one)g(possible)g
(implementation\))e(into:)605 1300 y Fs(\(let*)41 b(\(\(#:g1)g(x\))910
1400 y(\(#:g4)g(ar\))910 1499 y(\(#:g3)g(\(incf)h(i\)\))910
1599 y(\(#:g2)f(\(aref)h(#:g4)g(#:g3\)\))910 1698 y(\(#:g6)f(lst\))910
1798 y(\(#:g5)g(\(car)h(#:g6\)\)\))692 1898 y(\(unless)f(\(>)h(#:g1)g
(#:g2\))779 1997 y(\(rotatef)e(#:g1)i(#:g2\)\))692 2097
y(\(unless)f(\(>)h(#:g1)g(#:g5\))779 2197 y(\(rotatef)e(#:g1)i
(#:g5\)\))692 2296 y(\(unless)f(\(>)h(#:g2)g(#:g5\))779
2396 y(\(rotatef)e(#:g2)i(#:g5\)\))692 2495 y(\(setq)g(x)h(#:g1\))692
2595 y(\(system:set-aref)37 b(#:g2)42 b(#:g4)g(#:g3\))692
2695 y(\(system:set-car)37 b(#:g6)42 b(#:g5\)\))1184
2899 y FA(Figure)19 b(12.5:)29 b(Expansion)18 b(of)i(a)h(call)f(to)h
Fs(sortf)p FA(.)p 3231 2977 V 555 2980 2678 4 v 555 3205
a(forms)h(returned)f(by)h Fs(get-setf-method)o FA(.)31
b(The)22 b(algorithm)f(used)i(is)g(the)g Ft(O)p Fj(\()p
Ft(n)2899 3163 y Fm(2)2933 3205 y Fj(\))g FA(b)n(ubble\255)555
3309 y(sort,)d(b)n(ut)g(this)h(macro)e(is)i(not)f(intended)f(to)h(be)g
(called)g(with)g(huge)f(numbers)g(of)h(ar)o(guments.)680
3414 y(Figure)j(12.5)g(sho)n(ws)i(the)f(e)o(xpansion)e(of)i(a)h(call)f
(to)h Fs(sortf)p FA(.)40 b(In)24 b(the)g(initial)h Fs(let*)p
FA(,)f(the)555 3518 y(ar)o(guments)c(and)h(their)g(subforms)g(are)g
(carefully)g(e)n(v)n(aluated)f(in)i(left\255to\255right)d(order)-5
b(.)33 b(Then)555 3623 y(appear)f(three)h(e)o(xpressions)f(which)h
(compare)f(and)h(possibly)g(sw)o(ap)h(the)f(v)n(alues)g(of)h(the)555
3728 y(temporary)16 b(v)n(ariables:)28 b(the)18 b(\002rst)h(is)h
(compared)c(to)i(the)h(second,)e(then)h(the)g(\002rst)i(to)e(the)g
(third,)555 3832 y(then)k(the)h(second)f(to)h(the)g(third.)37
b(Finally)23 b(the)g(the)g(generalized)e(v)n(ariables)h(are)h
(reassigned)555 3937 y(left\255to\255right.)k(Although)16
b(the)j(issue)g(rarely)e(arises,)i(macro)f(ar)o(guments)e(should)i
(usually)g(be)555 4041 y(assigned)i(left\255to\255right,)e(as)i(well)h
(as)g(being)e(e)n(v)n(aluated)g(in)h(this)h(order)-5
b(.)680 4146 y(Operators)32 b(lik)o(e)p 1205 4146 27
4 v 66 w Fs(f)i FA(and)f Fs(sortf)f FA(bear)h(a)i(certain)e
(resemblance)f(to)i(functions)e(that)555 4251 y(tak)o(e)21
b(functional)e(ar)o(guments.)29 b(It)21 b(should)f(be)h(understood)e
(that)i(the)o(y)f(are)h(something)e(quite)555 4355 y(dif)n(ferent.)36
b(A)24 b(function)d(lik)o(e)i Fs(find-if)e FA(tak)o(es)j(a)f(function)e
(and)i(calls)h(it;)h(a)f(macro)e(lik)o(e)p 3170 4355
V 54 w Fs(f)555 4460 y FA(tak)o(es)k(a)g Ft(name)p FA(,)h(and)e(mak)o
(es)g(it)i(the)f(car)f(of)h(an)g(e)o(xpression.)44 b(Both)p
2569 4460 V 57 w Fs(f)26 b FA(and)f Fs(sortf)g FA(could)555
4564 y(ha)n(v)o(e)19 b(been)g(written)g(to)h(tak)o(e)f(functional)f(ar)
o(guments.)27 b(F)o(or)19 b(e)o(xample,)p 2615 4564 V
49 w Fs(f)h FA(could)e(ha)n(v)o(e)h(been)555 4669 y(written:)p
eop
%%Page: 178 191
178 190 bop 555 538 a FA(178)836 b Fu(GENERALIZED)17
b(V)-8 b(ARIABLES)555 801 y Fs(\(defmacro)40 b(_f)j(\(op)f(place)f
(&rest)h(args\))642 900 y(\(let)g(\(\(g)g(\(gensym\)\)\))729
1000 y(\(multiple-value-b)o(in)o(d)c(\(vars)j(forms)h(var)g(set)g
(access\))1645 1100 y(\(get-setf-metho)o(d)c(place\))729
1199 y(`\(let*)j(\(\(,g)h(,op\))1078 1299 y(,@\(mapcar)e(#'list)h(vars)
h(forms\))1078 1398 y(\(,\(car)f(var\))h(\(funcall)e(,g)j(,access)e
(,@args\)\)\))860 1498 y(,set\)\)\)\))555 1660 y FA(and)17
b(called)f Fs(\()p 957 1660 27 4 v 31 w(f)44 b(#'+)e(x)h(1\))p
FA(.)28 b(But)18 b(the)f(original)f(v)o(ersion)f(of)p
2355 1660 V 49 w Fs(f)i FA(can)g(do)g(an)o(ything)d(this)k(one)555
1765 y(could,)h(and)g(since)h(it)h(deals)f(in)g(names,)f(it)i(can)f
(also)g(tak)o(e)g(the)g(name)f(of)h(a)g(macro)f(or)g(special)555
1870 y(form.)28 b(As)21 b(well)g(as)g Fs(+)p FA(,)f(you)f(could)g
(call,)i(for)e(e)o(xample,)g Fs(nif)g FA(\(page)h(150\):)555
2027 y Fs(>)43 b(\(let)f(\(\(x)g(2\)\))729 2126 y(\(_f)h(nif)f(x)h('p)g
('z)g('n\))729 2226 y(x\))555 2326 y(P)555 2574 y Fw(12.5)99
b(De\002ning)26 b(In)l(v)o(ersions)555 2765 y FA(Section)36
b(12.1)f(e)o(xplained)f(that)i(an)o(y)g(macro)f(call)h(which)g(e)o
(xpands)e(into)i(an)g(in)m(v)o(ertible)555 2869 y(reference)23
b(will)i(itself)h(be)e(in)m(v)o(ertible.)41 b(Y)-9 b(ou)24
b(don')o(t)f(ha)n(v)o(e)i(to)f(de\002ne)h(operators)e(as)i(macros)555
2974 y(just)20 b(to)f(mak)o(e)g(them)g(in)m(v)o(ertible,)f(though.)27
b(By)20 b(using)e Fs(defsetf)f FA(you)i(can)g(tell)h(Lisp)g(ho)n(w)e
(to)555 3078 y(in)m(v)o(ert)h(an)o(y)g(function)g(or)h(macro)f(call.)
680 3183 y(This)k(macro)f(can)h(be)g(used)f(in)h(tw)o(o)h(w)o(ays.)38
b(In)22 b(the)h(simplest)h(case,)g(its)g(ar)o(guments)d(are)555
3288 y(tw)o(o)f(symbols:)555 3445 y Fs(\(defsetf)40 b(symbol-value)f
(set\))555 3607 y FA(In)20 b(the)g(more)g(complicated)e(form,)h(a)i
(call)f(to)h Fs(defsetf)d FA(is)j(lik)o(e)f(a)h(call)g(to)f
Fs(defmacro)p FA(,)d(with)555 3712 y(an)31 b(additional)e(parameter)h
(for)g(the)h(updated)f(v)n(alue)g(form.)60 b(F)o(or)31
b(e)o(xample,)h(this)f(w)o(ould)555 3816 y(de\002ne)20
b(a)g(possible)g(in)m(v)o(ersion)e(for)i Fs(car)p FA(:)555
3974 y Fs(\(defsetf)40 b(car)j(\(lst\))e(\(new-car\))642
4073 y(`\(progn)g(\(rplaca)g(,lst)g(,new-car\))991 4173
y(,new-car\)\))555 4335 y FA(There)28 b(is)i(one)e(important)g(dif)n
(ference)f(between)h Fs(defmacro)e FA(and)j Fs(defsetf)p
FA(:)44 b(the)29 b(latter)555 4440 y(automatically)16
b(creates)i(gensyms)e(for)h(its)h(ar)o(guments.)27 b(W)m(ith)17
b(the)h(de\002nition)e(gi)n(v)o(en)g(abo)o(v)o(e,)555
4544 y Fs(\(setf)42 b(\(car)f(x\))i(y\))20 b FA(w)o(ould)g(e)o(xpand)e
(into:)555 4702 y Fs(\(let*)42 b(\(\(#:g2)f(x\))860 4801
y(\(#:g1)h(y\)\))642 4901 y(\(progn)f(\(rplaca)g(#:g2)h(#:g1\))947
5001 y(#:g1\)\))p eop
%%Page: 179 192
179 191 bop 555 538 a Ft(12.5)887 b Fu(DEFINING)19 b(INVERSIONS)870
b FA(179)p 555 745 2678 4 v 553 2067 4 1322 v 605 888
a Fs(\(defvar)41 b(*cache*)f(\(make-hash-table\))o(\))605
1087 y(\(defun)h(retrieve)f(\(key\))692 1187 y(\(multiple-value-)o(bin)
o(d)d(\(x)43 b(y\))g(\(gethash)d(key)i(*cache*\))779
1287 y(\(if)h(y)954 1386 y(\(values)d(x)j(y\))954 1486
y(\(cdr)e(\(assoc)h(key)g(*world*\)\)\)\)\))605 1685
y(\(defsetf)e(retrieve)g(\(key\))i(\(val\))692 1785 y(`\(setf)f
(\(gethash)f(,key)i(*cache*\))f(,val\)\))1248 1989 y
FA(Figure)19 b(12.6:)29 b(An)20 b(asymmetric)f(in)m(v)o(ersion.)p
3231 2067 V 555 2070 2678 4 v 555 2286 a(Thus)27 b(we)g(can)h(write)f
Fs(defsetf)e FA(e)o(xpanders)g(without)i(ha)n(ving)f(to)h(w)o(orry)f
(about)h(v)n(ariable)555 2391 y(capture,)19 b(or)h(number)e(or)i(order)
f(of)h(e)n(v)n(aluations.)680 2496 y(In)g Fr(CL)-6 b(TL)p
FA(2)20 b(Common)g(Lisp,)h(it)h(is)g(possible)e(to)i(de\002ne)e
Fs(setf)g FA(in)m(v)o(ersions)f(directly)h(with)555 2600
y Fs(defun)p FA(,)e(so)j(the)f(pre)n(vious)f(e)o(xample)g(could)g(also)
h(be)g(written:)555 2773 y Fs(\(defun)41 b(\(setf)h(car\))g(\(new-car)e
(lst\))642 2872 y(\(rplaca)h(lst)h(new-car\))642 2972
y(new-car\))555 3149 y FA(The)30 b(updated)f(v)n(alue)g(should)h(be)g
(the)g(\002rst)h(parameter)e(in)i(such)f(a)h(function.)57
b(It)31 b(is)g(also)555 3254 y(con)m(v)o(entional)17
b(to)j(return)f(this)i(v)n(alue)f(as)h(the)f(v)n(alue)f(of)h(the)g
(function.)680 3359 y(The)k(e)o(xamples)g(so)i(f)o(ar)f(ha)n(v)o(e)g
(suggested)f(that)h(generalized)f(v)n(ariables)g(are)h(supposed)555
3463 y(to)k(refer)g(to)h(a)f(place)g(in)h(a)g(data)f(structure.)56
b(The)29 b(villain)g(carries)g(his)h(hostage)e(do)n(wn)g(to)555
3568 y(the)e(dungeon,)f(and)h(the)g(rescuing)f(hero)h(carries)g(her)g
(back)f(up)h(again;)i(the)o(y)e(both)f(follo)n(w)555
3673 y(the)i(same)f(path,)i(b)n(ut)e(in)h(dif)n(ferent)e(directions.)47
b(It')-5 b(s)28 b(not)e(surprising)f(if)i(people)f(ha)n(v)o(e)g(the)555
3777 y(impression)e(that)h Fs(setf)f FA(must)h(w)o(ork)g(this)g(w)o(ay)
-5 b(,)26 b(because)e(all)i(the)f(prede\002ned)e(in)m(v)o(ersions)555
3882 y(seem)f(to)g(be)f(of)g(this)h(form;)g(indeed,)e
Fs(place)g FA(is)j(the)f(con)m(v)o(entional)c(name)j(for)g(a)h
(parameter)555 3986 y(which)e(is)h(to)f(be)g(in)m(v)o(erted.)680
4091 y(In)g(principle,)g Fs(setf)g FA(is)i(more)e(general:)30
b(an)21 b(access)g(form)f(and)h(its)h(in)m(v)o(ersion)d(need)h(not)555
4196 y(e)n(v)o(en)27 b(operate)g(on)h(the)g(same)h(data)f(structure.)52
b(Suppose)28 b(that)g(in)g(some)g(application)f(we)555
4300 y(w)o(ant)22 b(to)g(cache)g(database)f(updates.)34
b(This)22 b(could)f(be)h(necessary)-5 b(,)21 b(for)g(e)o(xample,)g(if)h
(it)h(were)555 4405 y(not)h(ef)n(\002cient)g(to)g(do)g(real)g(updates)g
(on)f(the)i(\003y)-5 b(,)24 b(or)g(if)h(all)g(the)f(updates)f(had)h(to)
g(be)h(v)o(eri\002ed)555 4509 y(for)20 b(consistenc)o(y)e(before)h
(committing)g(to)h(them.)680 4614 y(Suppose)g(that)h
Fs(*world*)e FA(is)k(the)e(actual)g(database.)32 b(F)o(or)21
b(simplicity)-5 b(,)21 b(we)h(will)g(mak)o(e)f(it)555
4719 y(an)i(assoc\255list)i(whose)e(elements)g(are)h(of)f(the)g(form)g
Fs(\()p Ft(k)o(e)n(y)42 b Fs(.)h Ft(val)p Fs(\))p FA(.)c(Figure)23
b(12.6)g(sho)n(ws)g(a)555 4823 y(lookup)18 b(function)h(called)h
Fs(retrieve)p FA(.)26 b(If)20 b Fs(*world*)e FA(is)555
5001 y Fs(\(\(a)42 b(.)i(2\))e(\(b)h(.)g(16\))g(\(c)f(.)h(50\))g(\(d)g
(.)g(20\))f(\(f)h(.)g(12\)\))p eop
%%Page: 180 193
180 192 bop 555 538 a FA(180)836 b Fu(GENERALIZED)17
b(V)-8 b(ARIABLES)555 801 y FA(then)555 983 y Fs(>)43
b(\(retrieve)d('c\))555 1083 y(50)555 1271 y FA(Unlik)o(e)18
b(a)g(call)g(to)g Fs(car)p FA(,)g(a)g(call)g(to)g Fs(retrieve)d
FA(does)j(not)f(refer)g(to)h(a)h(speci\002c)f(place)f(in)h(a)h(data)555
1375 y(structure.)27 b(The)17 b(return)f(v)n(alue)h(could)f(come)g
(from)g(one)h(of)g(tw)o(o)g(places.)29 b(And)16 b(the)i(in)m(v)o
(ersion)555 1480 y(of)i(retrie)n(v)o(e,)f(also)h(de\002ned)f(in)i
(Figure)e(12.6,)g(only)g(refers)h(to)g(one)g(of)g(them:)555
1662 y Fs(>)43 b(\(setf)f(\(retrieve)e('n\))i(77\))555
1762 y(77)555 1862 y(>)h(\(retrieve)d('n\))555 1961 y(77)555
2061 y(T)555 2249 y FA(This)22 b(lookup)f(returns)g(a)h(second)g(v)n
(alue)f(of)h Fs(t)p FA(,)g(indicating)f(that)h(the)g(answer)g(w)o(as)h
(found)d(in)555 2353 y(the)g(cache.)680 2458 y(Lik)o(e)12
b(macros)g(themselv)o(es,)f(generalized)h(v)n(ariables)g(are)g(an)g
(abstraction)g(of)g(remarkab)o(le)555 2562 y(po)n(wer)-5
b(.)33 b(There)21 b(is)i(probably)d(more)g(to)i(be)g(disco)o(v)o(ered)e
(here.)33 b(Certainly)21 b(indi)n(vidual)f(users)555
2667 y(are)25 b(lik)o(ely)f(to)h(disco)o(v)o(er)f(w)o(ays)h(in)g(which)
f(the)h(use)g(of)g(generalized)e(v)n(ariables)h(could)g(lead)555
2772 y(to)34 b(more)f(ele)o(gant)f(or)i(more)f(po)n(werful)e(programs.)
68 b(But)35 b(it)f(may)f(also)h(be)g(possible)f(to)555
2876 y(use)24 b Fs(setf)g FA(in)m(v)o(ersion)e(in)i(ne)n(w)g(w)o(ays,)i
(or)d(to)i(disco)o(v)o(er)d(other)i(classes)h(of)f(similarly)g(useful)
555 2981 y(transformations.)-645 b Fq(\016)p eop
%%Page: 181 194
181 193 bop 555 1610 a Fn(13)p 555 1872 2686 3 v 555
2131 a Fx(Computation)43 b(at)f(Compile\255T)m(ime)555
2568 y FA(The)31 b(preceding)e(chapters)h(described)g(se)n(v)o(eral)h
(types)g(of)f(operators)g(which)h(ha)n(v)o(e)f(to)i(be)555
2672 y(implemented)c(by)i(macros.)59 b(This)30 b(one)g(describes)f(a)i
(class)g(of)f(problems)f(which)h(could)555 2777 y(be)c(solv)o(ed)e(by)i
(functions,)f(b)n(ut)g(where)g(macros)g(are)h(more)f(ef)n(\002cient.)45
b(Section)25 b(8.2)g(listed)555 2882 y(the)31 b(pros)f(and)g(cons)h(of)
f(using)g(macros)g(in)h(a)h(gi)n(v)o(en)d(situation.)60
b(Among)30 b(the)g(pros)h(w)o(as)555 2986 y(\223computation)e(at)i
(compile\255time.)-6 b(\224)60 b(By)31 b(de\002ning)f(an)h(operator)e
(as)j(a)f(macro,)i(you)d(can)555 3091 y(sometimes)22
b(mak)o(e)g(it)i(do)e(some)g(of)h(its)g(w)o(ork)f(when)g(it)i(is)f(e)o
(xpanded.)34 b(This)23 b(chapter)e(looks)555 3195 y(at)g(macros)e
(which)h(tak)o(e)g(adv)n(antage)e(of)i(this)h(possibility)-5
b(.)555 3444 y Fw(13.1)99 b(New)25 b(Utilities)555 3635
y FA(Section)17 b(8.2)f(raised)h(the)g(possibility)f(of)h(using)f
(macros)h(to)g(shift)g(computation)e(to)i(compile\255)555
3739 y(time.)40 b(There)23 b(we)h(had)g(as)g(an)g(e)o(xample)f(the)g
(macro)g Fs(avg)p FA(,)h(which)f(returns)g(the)h(a)n(v)o(erage)f(of)555
3844 y(its)e(ar)o(guments:)555 4004 y Fs(>)43 b(\(avg)f(pi)h(4)g(5\))
555 4103 y(4.047...)555 4268 y FA(Figure)18 b(13.1)g(sho)n(ws)h
Fs(avg)g FA(de\002ned)f(\002rst)i(as)f(a)h(function)d(and)i(then)f(as)i
(a)g(macro.)27 b(When)19 b Fs(avg)555 4373 y FA(is)28
b(de\002ned)e(as)h(a)h(macro,)f(the)g(call)g(to)g Fs(length)e
FA(can)i(be)g(made)f(at)h(compile\255time.)48 b(In)27
b(the)555 4478 y(macro)18 b(v)o(ersion)g(we)i(also)f(a)n(v)n(oid)g(the)
g(e)o(xpense)f(of)h(manipulating)e(the)i Fs(&rest)e FA(parameter)h(at)
555 4582 y(runtime.)28 b(In)20 b(man)o(y)f(implementations,)f
Fs(avg)h FA(will)i(be)g(f)o(aster)f(written)g(as)h(a)f(macro.)680
4687 y(The)h(kind)h(of)g(sa)n(vings)g(which)g(comes)g(from)f(kno)n
(wing)f(the)i(number)f(of)h(ar)o(guments)e(at)555 4791
y(e)o(xpansion\255time)c(can)i(be)h(combined)d(with)j(the)g(kind)f(we)h
(get)f(from)g Fs(in)g FA(\(page)g(152\),)f(where)555
4896 y(it)33 b(w)o(as)g(possible)e(to)i(a)n(v)n(oid)e(e)n(v)o(en)h(e)n
(v)n(aluating)e(some)i(of)g(the)g(ar)o(guments.)62 b(Figure)32
b(13.2)555 5001 y(contains)17 b(tw)o(o)h(v)o(ersions)f(of)h
Fs(most-of)p FA(,)e(which)h(returns)g(true)h(if)g(most)g(of)g(its)h(ar)
o(guments)d(do:)1835 5229 y(181)p eop
%%Page: 182 195
182 194 bop 555 538 a FA(182)733 b Fu(COMPUT)-6 b(A)f(TION)20
b(A)-7 b(T)18 b(COMPILE)p Fv(\255)p Fu(TIME)p 555 745
2678 4 v 553 1569 4 824 v 605 888 a Fs(\(defun)41 b(avg)h(\(&rest)f
(args\))692 988 y(\(/)i(\(apply)e(#'+)h(args\))g(\(length)e(args\)\)\))
605 1187 y(\(defmacro)g(avg)i(\(&rest)f(args\))692 1287
y(`\(/)h(\(+)h(,@args\))e(,\(length)f(args\)\)\))931
1491 y FA(Figure)20 b(13.1:)28 b(Shifting)19 b(computation)f(when)i
(\002nding)f(a)n(v)o(erages.)p 3231 1569 V 555 1572 2678
4 v 555 1700 V 553 3520 4 1820 v 605 1843 a Fs(\(defun)41
b(most-of)g(\(&rest)g(args\))692 1942 y(\(let)h(\(\(all)f(0\))954
2042 y(\(hits)g(0\)\))779 2141 y(\(dolist)g(\(a)i(args\))866
2241 y(\(incf)f(all\))866 2341 y(\(if)h(a)g(\(incf)e(hits\)\)\))779
2440 y(\(>)i(hits)f(\(/)h(all)f(2\)\)\)\))605 2640 y(\(defmacro)e
(most-of)g(\(&rest)h(args\))692 2739 y(\(let)h(\(\(need)f(\(floor)g
(\(/)i(\(length)e(args\))g(2\)\)\))954 2839 y(\(hits)g(\(gensym\)\)\))
779 2938 y(`\(let)h(\(\(,hits)e(0\)\))910 3038 y(\(or)i(,@\(mapcar)e
(#'\(lambda)g(\(a\))1694 3138 y(`\(and)i(,a)h(\(>)g(\(incf)e(,hits\))g
(,need\)\)\))1520 3237 y(args\)\)\)\)\))1089 3442 y FA(Figure)20
b(13.2:)28 b(Shifting)19 b(and)h(a)n(v)n(oiding)f(computation.)p
3231 3520 V 555 3523 2678 4 v 555 3747 a Fs(>)43 b(\(most-of)d(t)k(t)f
(t)g(nil\))555 3847 y(T)555 4034 y FA(The)24 b(macro)e(v)o(ersion)h(e)o
(xpands)f(into)i(code)f(which,)h(lik)o(e)g Fs(in)p FA(,)g(only)f(e)n(v)
n(aluates)h(as)g(man)o(y)f(of)555 4139 y(the)i(ar)o(guments)e(as)i(it)h
(needs)e(to.)44 b(F)o(or)24 b(e)o(xample,)g Fs(\(most-of)41
b(\(a\))h(\(b\))g(\(c\)\))24 b FA(e)o(xpands)555 4244
y(into)c(the)g(equi)n(v)n(alent)f(of:)555 4426 y Fs(\(let)42
b(\(\(count)f(0\)\))642 4526 y(\(or)i(\(and)e(\(a\))i(\(>)g(\(incf)e
(count\))g(1\)\))817 4625 y(\(and)g(\(b\))i(\(>)g(\(incf)e(count\))g
(1\)\))817 4725 y(\(and)g(\(c\))i(\(>)g(\(incf)e(count\))g(1\)\)\)\))
555 4913 y FA(In)20 b(the)g(best)h(case,)f(just)h(o)o(v)o(er)e(half)g
(the)i(ar)o(guments)d(will)j(be)f(e)n(v)n(aluated.)p
eop
%%Page: 183 196
183 195 bop 555 538 a Ft(13.1)997 b Fu(NEW)19 b(UTILITIES)977
b FA(183)p 555 924 2678 4 v 553 4736 4 3813 v 605 1066
a Fs(\(defun)41 b(nthmost)g(\(n)h(lst\))692 1166 y(\(nth)g(n)h(\(sort)f
(\(copy-list)d(lst\))j(#'>\)\)\))605 1365 y(\(defmacro)e(nthmost)g(\(n)
j(lst\))692 1465 y(\(if)f(\(and)g(\(integerp)e(n\))j(\(<)g(n)g(20\)\))
866 1565 y(\(with-gensyms)c(\(glst)i(gi\))954 1664 y(\(let)g(\(\(syms)h
(\(map0-n)e(#'\(lambda)g(\(x\))i(\(gensym\)\))e(n\)\)\))1041
1764 y(`\(let)h(\(\(,glst)g(,lst\)\))1171 1863 y(\(unless)g(\(<)i
(\(length)e(,glst\))g(,\(1+)h(n\)\))1259 1963 y(,@\(gen-start)c(glst)k
(syms\))1259 2063 y(\(dolist)e(\(,gi)i(,glst\))1346 2162
y(,\(nthmost-gen)c(gi)43 b(syms)f(t\)\))1259 2262 y(,\(car)f(\(last)h
(syms\)\)\)\)\)\))866 2362 y(`\(nth)g(,n)h(\(sort)e(\(copy-list)f
(,lst\))h(#'>\)\)\)\))605 2561 y(\(defun)g(gen-start)f(\(glst)h(syms\))
692 2660 y(\(reverse)779 2760 y(\(maplist)f(#'\(lambda)g(\(syms\))1346
2860 y(\(let)i(\(\(var)f(\(gensym\)\)\))1433 2959 y(`\(let)g(\(\(,var)h
(\(pop)g(,glst\)\)\))1564 3059 y(,\(nthmost-gen)c(var)k(\(reverse)f
(syms\)\)\)\)\))1171 3159 y(\(reverse)g(syms\)\)\)\))605
3358 y(\(defun)g(nthmost-gen)e(\(var)j(vars)g(&optional)e(long?\))692
3457 y(\(if)i(\(null)g(vars\))866 3557 y(nil)866 3657
y(\(let)g(\(\(else)f(\(nthmost-gen)e(var)j(\(cdr)g(vars\))g
(long?\)\)\))954 3756 y(\(if)g(\(and)g(\(not)g(long?\))f(\(null)g
(else\)\))1128 3856 y(`\(setq)g(,\(car)g(vars\))h(,var\))1128
3956 y(`\(if)g(\(>)h(,var)e(,\(car)h(vars\)\))1346 4055
y(\(setq)f(,@\(mapcan)f(#'list)2043 4155 y(\(reverse)g(vars\))2043
4254 y(\(cdr)i(\(reverse)e(vars\)\)\))1607 4354 y(,\(car)i(vars\))f
(,var\))1346 4454 y(,else\)\)\)\)\))979 4658 y FA(Figure)19
b(13.3:)29 b(Use)21 b(of)e(ar)o(guments)g(kno)n(wn)f(at)j
(compile\255time.)p 3231 4736 V 555 4739 2678 4 v eop
%%Page: 184 197
184 196 bop 555 538 a FA(184)733 b Fu(COMPUT)-6 b(A)f(TION)20
b(A)-7 b(T)18 b(COMPILE)p Fv(\255)p Fu(TIME)680 801 y
FA(A)23 b(macro)f(may)g(also)h(be)f(able)h(to)g(shift)g(computation)d
(to)j(compile\255time)e(if)i(the)g(v)n(alues)555 905
y(of)k(particular)e(ar)o(guments)g(are)i(kno)n(wn.)48
b(Figure)26 b(13.3)f(contains)i(an)f(e)o(xample)g(of)h(such)f(a)555
1010 y(macro.)h(The)17 b(function)e Fs(nthmost)g FA(tak)o(es)j(a)f
(number)f Ft(n)h FA(and)f(a)i(list)g(of)f(numbers,)f(and)g(returns)555
1114 y(the)k Ft(n)p FA(th)g(lar)o(gest)g(among)e(them;)i(lik)o(e)h
(other)e(sequence)g(functions,)g(it)i(is)g(zero\255inde)o(x)o(ed:)555
1297 y Fs(>)43 b(\(nthmost)d(2)k('\(2)e(6)h(1)g(5)g(3)h(4\)\))555
1397 y(4)555 1584 y FA(The)30 b(function)f(v)o(ersion)g(is)i(written)f
(v)o(ery)f(simply)-5 b(.)59 b(It)30 b(sorts)h(the)f(list)i(and)d(calls)
i Fs(nth)f FA(on)555 1689 y(the)d(result.)49 b(Since)27
b Fs(sort)e FA(is)j(destructi)n(v)o(e,)f Fs(nthmost)d
FA(copies)j(the)g(list)h(before)d(sorting)h(it.)555 1794
y(Written)i(thus,)i Fs(nthmost)c FA(is)j(inef)n(\002cient)f(is)h(tw)o
(o)f(respects:)46 b(it)29 b(conses,)g(and)f(it)h(sorts)g(the)555
1898 y(entire)20 b(list)h(of)f(ar)o(guments,)e(though)g(all)j(we)g
(care)f(about)f(are)h(the)g(top)g Ft(n)p FA(.)680 2003
y(If)h(we)g(kno)n(w)g Ft(n)g FA(at)h(compile\255time,)d(we)j(can)f
(approach)e(the)i(problem)f(dif)n(ferently)-5 b(.)30
b(The)555 2107 y(rest)f(of)f(the)h(code)f(in)h(Figure)f(13.3)f
(de\002nes)i(a)g(macro)f(v)o(ersion)f(of)h Fs(nthmost)p
FA(.)53 b(The)28 b(\002rst)555 2212 y(thing)d(this)h(macro)e(does)h(is)
h(look)f(at)h(its)g(\002rst)g(ar)o(gument.)43 b(If)25
b(the)h(\002rst)g(ar)o(gument)d(is)j(not)f(a)555 2317
y(literal)c(number)m(,)d(it)j(e)o(xpands)e(into)i(the)f(same)h(code)f
(we)h(sa)o(w)g(abo)o(v)o(e.)29 b(If)20 b(the)h(\002rst)g(ar)o(gument)
555 2421 y(is)f(a)f(number)m(,)d(we)j(can)g(follo)n(w)f(a)h(dif)n
(ferent)e(course.)28 b(If)19 b(you)e(w)o(anted)i(to)f(\002nd,)h(say)-5
b(,)18 b(the)h(third)555 2526 y(biggest)c(cookie)g(on)h(a)g(plate,)h
(you)e(could)f(do)i(it)h(by)e(looking)f(at)j(each)e(cookie)g(in)h
(turn,)g(al)o(w)o(ays)555 2630 y(k)o(eeping)j(in)h(your)e(hand)h(the)h
(three)g(biggest)f(found)g(so)h(f)o(ar)-5 b(.)29 b(When)20
b(you)f(ha)n(v)o(e)h(look)o(ed)e(at)j(all)555 2735 y(the)h(cookies,)f
(the)h(smallest)g(cookie)f(in)h(your)e(hand)h(is)i(the)e(one)h(you)e
(are)i(looking)e(for)-5 b(.)34 b(If)21 b Ft(n)555 2840
y FA(is)f(a)f(small)g(constant,)f(not)g(proportional)e(to)i(the)h
(number)e(of)h(cookies,)g(then)g(this)h(technique)555
2944 y(gets)i(you)e(a)h(gi)n(v)o(en)f(cookie)g(with)i(less)g(ef)n(fort)
e(that)h(it)h(w)o(ould)f(tak)o(e)g(to)g(sort)h(all)f(of)g(them)g
(\002rst.)680 3049 y(This)34 b(is)i(the)f(strate)o(gy)f(follo)n(wed)f
(when)h Ft(n)h FA(is)h(kno)n(wn)d(at)i(e)o(xpansion\255time.)70
b(In)35 b(its)555 3153 y(e)o(xpansion,)16 b(the)j(macro)e(creates)h
Ft(n)h FA(v)n(ariables,)e(then)h(calls)h Fs(nthmost-gen)14
b FA(to)19 b(generate)e(the)555 3258 y(code)22 b(which)g(has)h(to)g(be)
f(e)n(v)n(aluated)g(upon)f(looking)g(at)i(each)f(cookie.)36
b(Figure)22 b(13.4)g(sho)n(ws)555 3363 y(a)31 b(sample)f(macroe)o
(xpansion.)56 b(The)31 b(macro)e Fs(nthmost)f FA(beha)n(v)o(es)i(just)h
(lik)o(e)f(the)h(original)555 3467 y(function,)17 b(e)o(xcept)g(that)h
(it)h(can')o(t)e(be)h(passed)g(as)g(an)g(ar)o(gument)e(to)i
Fs(apply)p FA(.)27 b(The)18 b(justi\002cation)555 3572
y(for)j(using)f(a)i(macro)e(is)j(purely)d(one)g(of)h(ef)n(\002cienc)o
(y:)31 b(the)21 b(macro)f(v)o(ersion)g(does)h(not)g(cons)g(at)555
3677 y(runtime,)e(and)g(if)i Ft(n)f FA(is)h(a)g(small)g(constant,)e
(performs)f(fe)n(wer)i(comparisons.)680 3781 y(T)-7 b(o)20
b(ha)n(v)o(e)f(ef)n(\002cient)h(programs,)e(must)i(one)g(then)g(tak)o
(e)g(the)g(trouble)f(to)h(write)h(such)f(huge)555 3886
y(macros?)28 b(In)19 b(this)g(case,)h(probably)d(not.)28
b(The)19 b(tw)o(o)g(v)o(ersions)f(of)h Fs(nthmost)d FA(are)j(intended)f
(as)555 3990 y(an)k(e)o(xample)e(of)h(a)i(general)d(principle:)31
b(when)22 b(some)f(ar)o(guments)f(are)h(kno)n(wn)g(at)h(compile\255)555
4095 y(time,)k(you)d(can)i(use)g(a)g(macro)f(to)g(generate)g(more)g(ef)
n(\002cient)g(code.)42 b(Whether)24 b(or)g(not)g(you)555
4200 y(tak)o(e)k(adv)n(antage)e(of)i(this)h(possibility)f(will)g
(depend)f(on)h(ho)n(w)f(much)g(you)g(stand)h(to)h(gain,)555
4304 y(and)22 b(ho)n(w)g(much)f(more)h(ef)n(fort)f(it)i(will)g(tak)o(e)
f(to)h(write)f(an)h(ef)n(\002cient)f(macro)f(v)o(ersion.)35
b(Since)555 4409 y(the)25 b(macro)g(v)o(ersion)f(of)h
Fs(nthmost)e FA(is)j(long)e(and)h(complicated,)g(it)h(w)o(ould)e(only)h
(be)g(w)o(orth)555 4513 y(writing)18 b(in)g(e)o(xtreme)f(cases.)29
b(Ho)n(we)n(v)o(er)m(,)17 b(information)f(kno)n(wn)h(at)h
(compile\255time)f(is)i(al)o(w)o(ays)555 4618 y(a)i(f)o(actor)e(w)o
(orth)h(considering,)e(e)n(v)o(en)h(if)h(you)g(choose)f(not)h(to)g(tak)
o(e)g(adv)n(antage)f(of)h(it.)p eop
%%Page: 185 198
185 197 bop 555 538 a Ft(13.2)821 b Fu(EXAMPLE)p Fv(:)26
b Fu(BEZIER)17 b(CUR)-5 b(VES)803 b FA(185)p 555 745
2678 4 v 553 3694 4 2950 v 605 888 a Fs(\(nthmost)40
b(2)j(nums\))605 1071 y FA(e)o(xpands)18 b(into:)605
1237 y Fs(\(let)42 b(\(\(#:g7)f(nums\)\))692 1336 y(\(unless)g(\(<)h
(\(length)f(#:g7\))h(3\))779 1436 y(\(let)g(\(\(#:g6)f(\(pop)h
(#:g7\)\)\))866 1536 y(\(setq)g(#:g1)g(#:g6\)\))779 1635
y(\(let)g(\(\(#:g5)f(\(pop)h(#:g7\)\)\))866 1735 y(\(if)h(\(>)f(#:g5)g
(#:g1\))1041 1835 y(\(setq)f(#:g2)h(#:g1)g(#:g1)g(#:g5\))1041
1934 y(\(setq)f(#:g2)h(#:g5\)\)\))779 2034 y(\(let)g(\(\(#:g4)f(\(pop)h
(#:g7\)\)\))866 2134 y(\(if)h(\(>)f(#:g4)g(#:g1\))1041
2233 y(\(setq)f(#:g3)h(#:g2)g(#:g2)g(#:g1)g(#:g1)g(#:g4\))1041
2333 y(\(if)g(\(>)h(#:g4)f(#:g2\))1215 2432 y(\(setq)g(#:g3)f(#:g2)h
(#:g2)g(#:g4\))1215 2532 y(\(setq)g(#:g3)f(#:g4\)\)\)\))779
2632 y(\(dolist)g(\(#:g8)g(#:g7\))866 2731 y(\(if)i(\(>)f(#:g8)g
(#:g1\))1041 2831 y(\(setq)f(#:g3)h(#:g2)g(#:g2)g(#:g1)g(#:g1)g(#:g8\))
1041 2931 y(\(if)g(\(>)h(#:g8)f(#:g2\))1215 3030 y(\(setq)g(#:g3)f
(#:g2)h(#:g2)g(#:g8\))1215 3130 y(\(if)g(\(>)h(#:g8)f(#:g3\))1389
3229 y(\(setq)g(#:g3)g(#:g8\))1389 3329 y(nil\)\)\)\))779
3429 y(#:g3\)\))1282 3616 y FA(Figure)20 b(13.4:)28 b(Expansion)18
b(of)i Fs(nthmost)p FA(.)p 3231 3694 V 555 3698 2678
4 v 555 3922 a Fw(13.2)99 b(Example:)37 b(Bezier)25 b(Cur)o(v)o(es)555
4112 y FA(Lik)o(e)19 b(the)f Fs(with-)g FA(macro)g(\(Section)g(11.2\),)
f(the)i(macro)e(for)i(computation)d(at)j(compile\255time)555
4217 y(is)27 b(more)f(lik)o(ely)h(to)f(be)h(written)f(for)g(a)h
(speci\002c)g(application)e(than)h(as)h(a)g(general\255purpose)555
4322 y(utility)-5 b(.)64 b(Ho)n(w)32 b(much)f(can)h(a)g
(general\255purpose)d(utility)j(kno)n(w)e(at)j(compile\255time?)63
b(The)555 4426 y(number)29 b(of)i(ar)o(guments)d(it)k(has)f(been)f(gi)n
(v)o(en,)i(and)f(perhaps)e(some)i(of)f(their)h(v)n(alues.)61
b(If)555 4531 y(we)23 b(w)o(ant)f(to)h(use)f(other)g(constraints,)g
(the)o(y)g(will)h(probably)d(ha)n(v)o(e)i(to)g(be)h(ones)f(imposed)f
(by)555 4635 y(indi)n(vidual)d(programs.)680 4740 y(As)25
b(an)g(e)o(xample,)g(this)h(section)e(sho)n(ws)h(ho)n(w)g(macros)f(can)
h(speed)g(up)g(the)g(generation)555 4845 y(of)i(Bezier)h(curv)o(es.)49
b(Curv)o(es)27 b(must)h(be)f(generated)f(f)o(ast)i(if)f(the)o(y)g(are)g
(being)g(manipulated)555 4949 y(interacti)n(v)o(ely)-5
b(.)46 b(It)26 b(turns)g(out)h(that)f(if)h(the)f(number)f(of)h(se)o
(gments)g(in)g(the)h(curv)o(e)e(is)i(kno)n(wn)p eop
%%Page: 186 199
186 198 bop 555 538 a FA(186)733 b Fu(COMPUT)-6 b(A)f(TION)20
b(A)-7 b(T)18 b(COMPILE)p Fv(\255)p Fu(TIME)555 801 y
FA(beforehand,)c(most)j(of)f(the)g(computation)f(can)h(be)h(done)e(at)i
(compile\255time.)26 b(By)17 b(writing)f(our)555 905
y(curv)o(e\255generator)22 b(as)27 b(a)g(macro,)g(we)g(can)f(wea)n(v)o
(e)g(precomputed)e(v)n(alues)i(right)f(into)i(code.)555
1010 y(This)20 b(should)e(be)i(e)n(v)o(en)e(f)o(aster)i(than)f(the)h
(more)e(usual)i(optimization)e(of)h(storing)g(them)g(in)h(an)555
1114 y(array)-5 b(.)680 1219 y(A)30 b(Bezier)h(curv)o(e)d(is)j
(de\002ned)f(in)g(terms)g(of)g(four)f(points\227tw)o(o)g(endpoints)g
(and)g(tw)o(o)555 1324 y(control)h(points.)64 b(When)31
b(we)h(are)g(w)o(orking)e(in)i(tw)o(o)g(dimensions,)h(these)f(points)f
(de\002ne)555 1428 y(parametric)26 b(equations)g(for)g(the)h(x)g(and)g
(y)g(coordinates)f(of)g(points)h(on)g(the)g(curv)o(e.)49
b(If)27 b(the)555 1533 y(tw)o(o)22 b(endpoints)f(are)h(\()p
Ft(x)1236 1545 y Fm(0)1269 1533 y FA(,)h Ft(y)1350 1545
y Fm(0)1383 1533 y FA(\))f(and)g(\()p Ft(x)1641 1545
y Fm(3)1673 1533 y FA(,)h Ft(y)1754 1545 y Fm(3)1787
1533 y FA(\))g(and)e(the)h(tw)o(o)h(control)d(points)i(are)g(\()p
Ft(x)2923 1545 y Fm(1)2956 1533 y FA(,)h Ft(y)3037 1545
y Fm(1)3070 1533 y FA(\))f(and)555 1638 y(\()p Ft(x)620
1650 y Fm(2)653 1638 y FA(,)e Ft(y)731 1650 y Fm(2)764
1638 y FA(\),)g(then)g(the)g(equations)f(de\002ning)g(points)h(on)g
(the)g(curv)o(e)f(are:)763 1806 y Fg(x)39 b Ff(=)h(\()p
Fg(x)1020 1814 y Fl(3)1065 1806 y Fe(\000)17 b Fv(3)p
Fg(x)1223 1814 y Fl(2)1269 1806 y Ff(+)g Fv(3)p Fg(x)1427
1814 y Fl(1)1473 1806 y Fe(\000)g Fg(x)1594 1814 y Fl(0)1622
1806 y Ff(\))p Fg(u)1696 1771 y Fl(3)1743 1806 y Ff(+)f(\()p
Fv(3)p Fg(x)1930 1814 y Fl(2)1976 1806 y Fe(\000)h Fv(6)p
Fg(x)2134 1814 y Fl(1)2180 1806 y Ff(+)g Fv(3)p Fg(x)2338
1814 y Fl(0)2367 1806 y Ff(\))p Fg(u)2441 1771 y Fl(2)2487
1806 y Ff(+)g(\()p Fv(3)p Fg(x)2675 1814 y Fl(1)2721
1806 y Fe(\000)f Fv(3)p Fg(x)2878 1814 y Fl(0)2907 1806
y Ff(\))p Fg(u)h Ff(+)g Fg(x)3119 1814 y Fl(0)763 1975
y Fg(y)42 b Ff(=)e(\()p Fg(y)1011 1983 y Fl(3)1057 1975
y Fe(\000)16 b Fv(3)p Fg(y)1208 1983 y Fl(2)1255 1975
y Ff(+)h Fv(3)p Fg(y)1407 1983 y Fl(1)1453 1975 y Fe(\000)g
Fg(y)1568 1983 y Fl(0)1596 1975 y Ff(\))p Fg(u)1670 1940
y Fl(3)1717 1975 y Ff(+)f(\()p Fv(3)p Fg(y)1898 1983
y Fl(2)1945 1975 y Fe(\000)g Fv(6)p Fg(y)2096 1983 y
Fl(1)2143 1975 y Ff(+)h Fv(3)p Fg(y)2295 1983 y Fl(0)2324
1975 y Ff(\))p Fg(u)2398 1940 y Fl(2)2444 1975 y Ff(+)g(\()p
Fv(3)p Fg(y)2626 1983 y Fl(1)2672 1975 y Fe(\000)g Fv(3)p
Fg(y)2824 1983 y Fl(0)2853 1975 y Ff(\))p Fg(u)g Ff(+)g
Fg(y)3059 1983 y Fl(0)555 2153 y FA(If)k(we)h(e)n(v)n(aluate)e(these)h
(equations)f(for)h Ft(n)g FA(v)n(alues)g(of)f Ft(u)i
FA(between)e(0)h(and)g(1,)g(we)h(get)f Ft(n)g FA(points)555
2258 y(on)f(the)g(curv)o(e.)28 b(F)o(or)19 b(e)o(xample,)g(if)h(we)g(w)
o(ant)h(to)f(dra)o(w)f(the)h(curv)o(e)f(as)i(20)e(se)o(gments,)h(then)f
(we)555 2362 y(w)o(ould)h(e)n(v)n(aluate)f(the)i(equations)e(for)h
Ft(u)g FA(=)h(.05,)f(.1,)p Fy(:)14 b(:)g(:)o FA(,)21
b(.95.)29 b(There)20 b(is)h(no)f(need)g(to)h(e)n(v)n(aluate)555
2467 y(them)d(for)g Ft(u)g FA(of)g(0)h(or)f(1,)h(because)e(if)i
Ft(u)f FA(=)h(0)g(the)o(y)e(will)i(yield)f(the)h(\002rst)g(endpoint)e
(\()p Ft(x)2910 2479 y Fm(0)2942 2467 y FA(,)i Ft(y)3019
2479 y Fm(0)3052 2467 y FA(\),)g(and)555 2572 y(if)h
Ft(u)h FA(=)f(1)h(the)o(y)e(will)i(yield)f(the)g(second)f(endpoint)g
(\()p Ft(x)2068 2584 y Fm(3)2100 2572 y FA(,)i Ft(y)2179
2584 y Fm(3)2212 2572 y FA(\).)680 2676 y(An)f(ob)o(vious)e
(optimization)g(is)j(to)f(mak)o(e)g Ft(n)g FA(\002x)o(ed,)f(calculate)g
(the)h(po)n(wers)g(of)f Ft(u)h FA(before\255)555 2781
y(hand,)j(and)g(store)g(them)h(in)f(an)h(\()p Ft(n)p
Fq(\000)p FA(1\))e Fq(\002)h FA(3)h(array)-5 b(.)38 b(By)24
b(de\002ning)e(the)h(curv)o(e\255generator)d(as)555 2885
y(a)28 b(macro,)f(we)h(can)f(do)g(e)n(v)o(en)f(better)-5
b(.)50 b(If)28 b Ft(n)f FA(is)h(kno)n(wn)e(at)h(e)o(xpansion\255time,)f
(the)i(program)555 2990 y(could)17 b(simply)g(e)o(xpand)e(into)j
Ft(n)f FA(line\255dra)o(wing)f(commands.)26 b(The)17
b(precomputed)e(po)n(wers)i(of)555 3095 y Ft(u)p FA(,)k(instead)f(of)g
(being)g(stored)g(in)h(an)f(array)-5 b(,)19 b(could)h(be)g(inserted)g
(as)i(literal)f(v)n(alues)f(right)g(into)555 3199 y(the)g(macro)f(e)o
(xpansion.)680 3304 y(Figure)13 b(13.5)f(contains)h(a)h(curv)o
(e\255generating)c(macro)j(which)g(implements)g(this)h(strate)o(gy)-5
b(.)555 3408 y(Instead)18 b(of)g(dra)o(wing)f(lines)i(immediately)-5
b(,)17 b(it)i(dumps)f(the)g(generated)f(points)h(into)h(an)f(array)-5
b(.)555 3513 y(When)21 b(a)g(curv)o(e)e(is)j(mo)o(ving)d(interacti)n(v)
o(ely)-5 b(,)19 b(each)h(instance)h(has)g(to)g(be)f(dra)o(wn)g(twice:)
31 b(once)555 3618 y(to)c(sho)n(w)f(it,)j(and)d(again)f(to)i(erase)g
(it)g(before)e(dra)o(wing)g(the)i(ne)o(xt.)48 b(In)26
b(the)h(meantime,)g(the)555 3722 y(points)20 b(ha)n(v)o(e)f(to)i(be)f
(sa)n(v)o(ed)g(some)n(where.)680 3827 y(W)m(ith)25 b
Ft(n)g FA(=)g(20,)h Fs(genbez)d FA(e)o(xpands)g(into)i(21)g
Fs(setf)p FA(s.)43 b(Since)25 b(the)g(po)n(wers)f(of)h
Ft(u)g FA(appear)555 3931 y(directly)20 b(in)h(the)g(code,)g(we)g(sa)n
(v)o(e)g(the)g(cost)g(of)g(looking)e(them)i(up)g(at)g(runtime,)f(and)g
(the)h(cost)555 4036 y(of)j(computing)e(them)i(at)h(startup.)42
b(Lik)o(e)24 b(the)g(po)n(wers)g(of)g Ft(u)p FA(,)h(the)g(array)e
(indices)i(appear)e(as)555 4141 y(constants)e(in)g(the)g(e)o(xpansion,)
e(so)j(the)f(bounds\255checking)c(for)j(the)h Fs(\(setf)42
b(aref\))p FA(s)20 b(could)555 4245 y(also)h(be)f(done)f(at)h
(compile\255time.)555 4496 y Fw(13.3)99 b(A)n(pplications)555
4687 y FA(Later)28 b(chapters)f(contain)g(se)n(v)o(eral)g(other)g
(macros)g(which)h(use)g(information)e(a)n(v)n(ailable)h(at)555
4791 y(compile\255time.)k(A)22 b(good)e(e)o(xample)h(is)h
Fs(if-match)d FA(\(page)h(242\).)32 b(P)o(attern\255matchers)19
b(com\255)555 4896 y(pare)i(tw)o(o)h(sequences,)f(possibly)g
(containing)f(v)n(ariables,)h(to)h(see)g(if)h(there)e(is)h(some)g(w)o
(ay)g(of)555 5001 y(assigning)g(v)n(alues)g(to)h(the)g(v)n(ariables)f
(which)h(will)g(mak)o(e)g(the)f(tw)o(o)h(sequences)f(equal.)37
b(The)p eop
%%Page: 187 200
187 199 bop 555 538 a Ft(13.3)1006 b Fu(APPLICA)-7 b(TIONS)989
b FA(187)p 555 874 2678 4 v 553 4786 4 3913 v 605 1017
a Fs(\(defconstant)38 b(*segs*)k(20\))605 1116 y(\(defconstant)c(*du*)
130 b(\(/)42 b(1.0)h(*segs*\)\))605 1216 y(\(defconstant)38
b(*pts*)86 b(\(make-array)39 b(\(list)i(\(1+)h(*segs*\))f(2\)\)\))605
1415 y(\(defmacro)f(genbez)h(\(x0)h(y0)h(x1)g(y1)f(x2)h(y2)g(x3)g(y3\))
692 1515 y(\(with-gensyms)38 b(\(gx0)k(gx1)g(gy0)h(gy1)f(gx3)h(gy3\))
779 1614 y(`\(let)f(\(\(,gx0)f(,x0\))h(\(,gy0)f(,y0\))1084
1714 y(\(,gx1)h(,x1\))g(\(,gy1)f(,y1\))1084 1814 y(\(,gx3)h(,x3\))g
(\(,gy3)f(,y3\)\))910 1913 y(\(let)h(\(\(cx)g(\(*)h(\(-)f(,gx1)g
(,gx0\))g(3\)\))1171 2013 y(\(cy)h(\(*)g(\(-)f(,gy1)g(,gy0\))g(3\)\))
1171 2112 y(\(px)h(\(*)g(\(-)f(,x2)h(,gx1\))e(3\)\))1171
2212 y(\(py)i(\(*)g(\(-)f(,y2)h(,gy1\))e(3\)\)\))997
2312 y(\(let)h(\(\(bx)g(\(-)h(px)f(cx\)\))1259 2411 y(\(by)g(\(-)h(py)f
(cy\)\))1259 2511 y(\(ax)g(\(-)h(,gx3)f(px)g(,gx0\)\))1259
2611 y(\(ay)g(\(-)h(,gy3)f(py)g(,gy0\)\)\))1084 2710
y(\(setf)g(\(aref)f(*pts*)h(0)h(0\))g(,gx0)1346 2810
y(\(aref)e(*pts*)h(0)h(1\))g(,gy0\))1084 2910 y(,@\(map1-n)d
(#'\(lambda)g(\(n\))1694 3009 y(\(let*)i(\(\(u)g(\(*)h(n)g(*du*\)\))
2000 3109 y(\(u^2)f(\(*)g(u)h(u\)\))2000 3208 y(\(u^3)f(\(expt)f(u)i
(3\)\)\))1782 3308 y(`\(setf)e(\(aref)g(*pts*)h(,n)h(0\))2087
3408 y(\(+)g(\(*)f(ax)h(,u^3\))2218 3507 y(\(*)f(bx)h(,u^2\))2218
3607 y(\(*)f(cx)h(,u\))2218 3707 y(,gx0\))2087 3806 y(\(aref)e(*pts*)h
(,n)h(1\))2087 3906 y(\(+)g(\(*)f(ay)h(,u^3\))2218 4005
y(\(*)f(by)h(,u^2\))2218 4105 y(\(*)f(cy)h(,u\))2218
4205 y(,gy0\)\)\)\))1607 4304 y(\(1-)g(*segs*\)\))1171
4404 y(\(setf)f(\(aref)f(*pts*)h(*segs*)f(0\))i(,gx3)1433
4504 y(\(aref)e(*pts*)h(*segs*)f(1\))i(,gy3\)\)\)\)\)\))1076
4708 y FA(Figure)19 b(13.5:)29 b(Macro)19 b(for)h(generating)e(Bezier)i
(curv)o(es.)p 3231 4786 V 555 4789 2678 4 v eop
%%Page: 188 201
188 200 bop 555 538 a FA(188)733 b Fu(COMPUT)-6 b(A)f(TION)20
b(A)-7 b(T)18 b(COMPILE)p Fv(\255)p Fu(TIME)555 801 y
FA(design)f(of)h Fs(if-match)d FA(sho)n(ws)j(that)g(if)g(one)f(of)h
(the)g(sequences)f(is)i(kno)n(wn)d(at)i(compile\255time,)555
905 y(and)i(only)f(that)i(one)e(contains)h(v)n(ariables,)f(then)h
(matching)f(can)h(be)g(done)g(more)f(ef)n(\002ciently)-5
b(.)555 1010 y(Instead)24 b(of)h(comparing)e(the)i(tw)o(o)h(sequences)e
(at)h(runtime)f(and)h(consing)f(up)h(lists)h(to)f(hold)555
1114 y(the)i(v)n(ariable)g(bindings)e(established)i(in)h(the)f
(process,)h(we)g(can)f(ha)n(v)o(e)g(a)g(macro)g(generate)555
1219 y(code)21 b(to)h(perform)e(the)i(e)o(xact)f(comparisons)g
(dictated)g(by)g(the)h(kno)n(wn)f(sequence,)f(and)i(can)555
1324 y(store)e(the)g(bindings)f(in)h(real)h(Lisp)f(v)n(ariables.)680
1428 y(The)e(embedded)e(languages)h(described)g(in)h(Chapters)g
(19\22624)f(also,)i(for)e(the)i(most)f(part,)555 1533
y(tak)o(e)32 b(adv)n(antage)f(of)g(information)f(a)n(v)n(ailable)i(at)h
(compile\255time.)63 b(Since)33 b(an)f(embedded)555 1638
y(language)12 b(is)j(a)f(compiler)f(of)h(sorts,)h(it')-5
b(s)15 b(only)e(natural)g(that)h(it)h(should)d(use)j(such)e
(information.)555 1742 y(As)24 b(a)f(general)f(rule,)h(the)f(more)g
(elaborate)g(the)h(macro,)f(the)h(more)f(constraints)g(it)i(imposes)555
1847 y(on)15 b(its)h(ar)o(guments,)e(and)h(the)g(better)g(your)g
(chances)f(of)h(using)g(these)h(constraints)e(to)i(generate)555
1951 y(ef)n(\002cient)k(code.)p eop
%%Page: 189 202
189 201 bop 555 1610 a Fn(14)p 555 1872 2686 3 v 555
2131 a Fx(Anaphoric)42 b(Macr)m(os)555 2568 y FA(Chapter)18
b(9)g(treated)g(v)n(ariable)f(capture)g(e)o(xclusi)n(v)o(ely)f(as)j(a)g
(problem\227as)d(something)h(which)555 2672 y(happens)24
b(inadv)o(ertently)-5 b(,)24 b(and)h(which)h(can)f(only)g(af)n(fect)g
(programs)f(for)h(the)h(w)o(orse.)45 b(This)555 2777
y(chapter)18 b(will)i(sho)n(w)f(that)g(v)n(ariable)f(capture)h(can)g
(also)g(be)g(used)g(constructi)n(v)o(ely)-5 b(.)26 b(There)19
b(are)555 2882 y(some)h(useful)g(macros)f(which)h(couldn')o(t)e(be)i
(written)g(without)f(it.)680 2986 y(It')-5 b(s)26 b(not)f(uncommon)e
(in)i(a)h(Lisp)g(program)e(to)h(w)o(ant)h(to)g(test)g(whether)f(an)g(e)
o(xpression)555 3091 y(returns)15 b(a)i(non\255nil)d(v)n(alue,)i(and)f
(if)i(so,)g(to)f(do)f(something)g(with)h(the)g(v)n(alue.)27
b(If)16 b(the)g(e)o(xpression)555 3195 y(is)21 b(costly)f(to)h(e)n(v)n
(aluate,)e(then)g(one)h(must)g(normally)f(do)g(something)g(lik)o(e)i
(this:)555 3378 y Fs(\(let)42 b(\(\(result)e(\(big-long-calcula)o(ti)o
(on\))o(\)\))642 3478 y(\(if)j(result)817 3577 y(\(foo)e(result\)\)\))
555 3760 y FA(W)-7 b(ouldn')o(t)19 b(it)i(be)f(easier)g(if)h(we)f
(could)g(just)g(say)-5 b(,)20 b(as)h(we)f(w)o(ould)g(in)g(English:)555
3926 y Fs(\(if)42 b(\(big-long-calcula)o(ti)o(on\))729
4026 y(\(foo)g(it\)\))555 4197 y FA(By)16 b(taking)e(adv)n(antage)f(of)
i(v)n(ariable)g(capture,)f(we)i(can)f(write)h(a)f(v)o(ersion)f(of)h
Fs(if)g FA(which)g(w)o(orks)555 4301 y(just)21 b(this)f(w)o(ay)-5
b(.)555 4554 y Fw(14.1)99 b(Anaphoric)26 b(V)-9 b(ariants)555
4745 y FA(In)26 b(natural)g(language,)g(an)h Ft(anaphor)e
FA(is)i(an)g(e)o(xpression)e(which)h(refers)g(back)g(in)h(the)f
(con\255)555 4849 y(v)o(ersation.)35 b(The)23 b(most)f(common)f
(anaphor)g(in)i(English)f(is)h(probably)e(\223it,)-6
b(\224)23 b(as)h(in)f(\223Get)g(the)555 4954 y(wrench)i(and)g(put)g(it)
i(on)e(the)h(table.)-6 b(\224)46 b(Anaphora)24 b(are)i(a)g(great)f(con)
m(v)o(enience)e(in)j(e)n(v)o(eryday)1835 5229 y(189)p
eop
%%Page: 190 203
190 202 bop 555 538 a FA(190)910 b Fu(AN)n(APHORIC)19
b(MA)n(CR)n(OS)555 801 y FA(language\227imagine)12 b(trying)i(to)h(get)
h(along)e(without)g(them\227b)n(ut)h(the)o(y)f(don')o(t)g(appear)g
(much)555 905 y(in)g(programming)d(languages.)26 b(F)o(or)14
b(the)g(most)g(part,)h(this)g(is)g(good.)26 b(Anaphoric)12
b(e)o(xpressions)555 1010 y(are)22 b(often)f(genuinely)f(ambiguous,)f
(and)j(present\255day)d(programming)g(languages)h(are)i(not)555
1114 y(designed)d(to)h(handle)f(ambiguity)-5 b(.)680
1219 y(Ho)n(we)n(v)o(er)m(,)34 b(it)g(is)g(possible)f(to)h(introduce)d
(a)j(v)o(ery)e(limited)h(form)g(of)g(anaphora)e(into)555
1324 y(Lisp)24 b(programs)e(without)h(causing)g(ambiguity)-5
b(.)38 b(An)24 b(anaphor)m(,)e(it)j(turns)e(out,)h(is)h(a)f(lot)g(lik)o
(e)555 1428 y(a)32 b(captured)e(symbol.)63 b(W)-7 b(e)33
b(can)f(use)g(anaphora)e(in)i(programs)e(by)h(designating)f(certain)555
1533 y(symbols)c(to)h(serv)o(e)f(as)h(pronouns,)e(and)h(then)g(writing)
g(macros)g(intentionally)f(to)i(capture)555 1638 y(these)20
b(symbols.)680 1742 y(In)j(the)h(ne)n(w)g(v)o(ersion)e(of)i
Fs(if)p FA(,)g(the)g(symbol)f Fs(it)g FA(is)i(the)f(one)f(we)h(w)o(ant)
g(to)g(capture.)39 b(The)555 1847 y(anaphoric)18 b(if,)i(called)g
Fs(aif)g FA(for)f(short,)h(is)h(de\002ned)e(as)i(follo)n(ws:)555
2011 y Fs(\(defmacro)40 b(aif)i(\(test-form)e(then-form)g(&optional)f
(else-form\))642 2110 y(`\(let)j(\(\(it)g(,test-form\)\))773
2210 y(\(if)g(it)h(,then-form)c(,else-form\)\)\))555
2374 y FA(and)20 b(used)g(as)g(in)h(the)f(pre)n(vious)f(e)o(xample:)555
2525 y Fs(\(aif)42 b(\(big-long-calcul)o(at)o(ion)o(\))773
2625 y(\(foo)g(it\)\))555 2781 y FA(When)24 b(you)g(use)h(an)f
Fs(aif)p FA(,)h(the)g(symbol)e Fs(it)i FA(is)g(left)g(bound)e(to)h(the)
h(result)g(returned)d(by)j(the)555 2885 y(test)19 b(clause.)29
b(In)18 b(the)h(macro)f(call,)h Fs(it)f FA(seems)h(to)g(be)g(free,)f(b)
n(ut)g(in)h(f)o(act)g(the)g(e)o(xpression)e Fs(\(foo)555
2990 y(it\))22 b FA(will)g(be)h(inserted)e(by)h(e)o(xpansion)e(of)i
(the)g Fs(aif)g FA(into)g(a)g(conte)o(xt)f(in)i(which)e(the)i(symbol)
555 3095 y Fs(it)d FA(is)h(bound:)555 3258 y Fs(\(let)42
b(\(\(it)g(\(big-long-calcul)o(at)o(ion)o(\)\))o(\))642
3358 y(\(if)h(it)f(\(foo)g(it\))h(nil\)\))555 3527 y
FA(So)26 b(a)g(symbol)f(which)g(looks)g(free)h(in)f(the)h(source)f
(code)g(is)i(left)f(bound)e(by)h(the)h(macroe)o(x\255)555
3632 y(pansion.)j(All)21 b(the)f(anaphoric)e(macros)i(in)h(this)g
(chapter)e(use)i(some)f(v)n(ariation)f(of)h(the)g(same)555
3736 y(technique.)680 3841 y(Figure)26 b(14.1)f(contains)h(anaphoric)f
(v)n(ariants)h(of)h(se)n(v)o(eral)f(Common)f(Lisp)i(operators.)555
3945 y(After)20 b Fs(aif)f FA(comes)h Fs(awhen)p FA(,)f(the)h(ob)o
(vious)e(anaphoric)h(v)n(ariant)g(of)h Fs(when)p FA(:)555
4109 y Fs(\(awhen)41 b(\(big-long-calcul)o(ati)o(on)o(\))642
4209 y(\(foo)h(it\))642 4309 y(\(bar)g(it\)\))680 4478
y FA(Both)28 b Fs(aif)g FA(and)g Fs(awhen)f FA(are)h(frequently)f
(useful,)i(b)n(ut)g Fs(awhile)d FA(is)k(probably)c(unique)555
4582 y(among)21 b(the)h(anaphoric)e(macros)h(in)i(being)e(more)g(often)
g(needed)g(than)h(its)h(re)o(gular)d(cousin,)555 4687
y Fs(while)i FA(\(de\002ned)h(on)g(page)g(91\).)39 b(Macros)23
b(lik)o(e)h Fs(while)e FA(and)i Fs(awhile)d FA(are)j(typically)f(used)
555 4791 y(in)f(situations)f(where)g(a)h(program)d(needs)i(to)h(poll)f
(some)g(outside)g(source.)33 b(And)21 b(when)f(you)555
4896 y(are)f(polling)f(a)i(source,)e(unless)i(you)e(are)h(simply)g(w)o
(aiting)g(for)f(it)i(to)g(change)e(state,)i(you)e(will)555
5001 y(usually)i(w)o(ant)g(to)g(do)g(something)f(with)h(the)g(object)g
(you)f(\002nd)h(there:)p eop
%%Page: 191 204
191 203 bop 555 538 a Ft(14.1)886 b Fu(AN)n(APHORIC)19
b(V)-8 b(ARIANTS)868 b FA(191)p 555 745 2678 4 v 553
3761 4 3016 v 605 888 a Fs(\(defmacro)40 b(aif)i(\(test-form)d
(then-form)h(&optional)g(else-form\))692 988 y(`\(let)i(\(\(it)f
(,test-form\)\))823 1087 y(\(if)h(it)h(,then-form)c(,else-form\)\)\))
605 1287 y(\(defmacro)h(awhen)h(\(test-form)f(&body)h(body\))692
1386 y(`\(aif)h(,test-form)954 1486 y(\(progn)f(,@body\)\)\))605
1685 y(\(defmacro)f(awhile)h(\(expr)g(&body)h(body\))692
1785 y(`\(do)g(\(\(it)g(,expr)f(,expr\)\))910 1884 y(\(\(not)g(it\)\))
823 1984 y(,@body\)\))605 2183 y(\(defmacro)f(aand)i(\(&rest)f(args\))
692 2283 y(\(cond)h(\(\(null)f(args\))g(t\))954 2383
y(\(\(null)g(\(cdr)h(args\)\))f(\(car)h(args\)\))954
2482 y(\(t)g(`\(aif)g(,\(car)f(args\))h(\(aand)f(,@\(cdr)g
(args\)\)\)\)\)\))605 2681 y(\(defmacro)f(acond)h(\(&rest)g(clauses\))
692 2781 y(\(if)h(\(null)g(clauses\))866 2881 y(nil)866
2980 y(\(let)g(\(\(cl1)g(\(car)g(clauses\)\))1128 3080
y(\(sym)g(\(gensym\)\)\))954 3180 y(`\(let)f(\(\(,sym)g(,\(car)h
(cl1\)\)\))1084 3279 y(\(if)h(,sym)1259 3379 y(\(let)f(\(\(it)f
(,sym\)\))h(,@\(cdr)f(cl1\)\))1259 3478 y(\(acond)g(,@\(cdr)g
(clauses\)\)\)\)\)\)\))890 3683 y FA(Figure)20 b(14.1:)28
b(Anaphoric)18 b(v)n(ariants)i(of)g(Common)f(Lisp)h(operators.)p
3231 3761 V 555 3764 2678 4 v 555 3988 a Fs(\(awhile)41
b(\(poll)g(*fridge*\))642 4088 y(\(eat)h(it\)\))680 4271
y FA(The)29 b(de\002nition)g(of)h Fs(aand)f FA(is)i(a)g(bit)f(more)g
(complicated)e(than)i(the)g(preceding)e(ones.)555 4370
y(It)34 b(pro)o(vides)d(an)j(anaphoric)d(v)o(ersion)h(of)i
Fs(and)p FA(;)39 b(during)32 b(the)h(e)n(v)n(aluation)f(of)h(each)g(of)
h(its)555 4470 y(ar)o(guments,)19 b Fs(it)i FA(will)h(be)f(bound)e(to)j
(the)f(v)n(alue)f(returned)f(by)i(the)g(pre)n(vious)f(ar)o(gument.)3108
4440 y Fm(1)3171 4470 y FA(In)555 4569 y(practice,)k
Fs(aand)e FA(tends)i(to)g(be)f(used)h(in)g(programs)e(which)h(mak)o(e)g
(conditional)f(queries,)i(as)555 4669 y(in:)p 555 4723
1074 4 v 645 4778 a Fl(1)675 4802 y Fr(Although)k(one)g(tends)g(to)g
(think)h(of)e Fk(and)h Fr(and)g Fk(or)f Fr(together)m(,)32
b(there)d(w)o(ould)f(be)g(no)f(point)i(in)e(writing)i(an)555
4885 y(anaphoric)20 b(v)o(ersion)e(of)f Fk(or)p Fr(.)24
b(An)17 b(ar)o(gument)i(in)e(an)h Fk(or)f Fr(e)o(xpression)i(is)e(e)n
(v)n(aluated)k(only)c(if)h(the)g(pre)n(vious)g(ar)o(gument)555
4967 y(e)n(v)n(aluated)j(to)c Fk(nil)p Fr(,)g(so)g(there)h(w)o(ould)g
(be)f(nothing)i(useful)f(for)f(an)g(anaphor)i(to)e(refer)h(to)f(in)h
(an)f Fk(aor)p Fr(.)p eop
%%Page: 192 205
192 204 bop 555 538 a FA(192)910 b Fu(AN)n(APHORIC)19
b(MA)n(CR)n(OS)555 801 y Fs(\(aand)42 b(\(owner)f(x\))h(\(address)f
(it\))h(\(town)g(it\)\))555 967 y FA(which)16 b(returns)g(the)h(to)n
(wn)g(\(if)f(there)h(is)g(one\))f(of)h(the)g(address)f(\(if)h(there)f
(is)i(one\))e(of)h(the)g(o)n(wner)555 1066 y(\(if)j(there)g(is)h(one\))
e(of)h Fs(x)p FA(.)29 b(W)m(ithout)20 b Fs(aand)p FA(,)f(this)i(e)o
(xpression)d(w)o(ould)i(ha)n(v)o(e)f(to)i(be)f(written)555
1232 y Fs(\(let)42 b(\(\(own)f(\(owner)h(x\)\)\))642
1332 y(\(if)h(own)817 1432 y(\(let)e(\(\(adr)h(\(address)e(own\)\)\))
904 1531 y(\(if)i(adr)g(\(town)g(adr\)\)\)\)\))680 1702
y FA(The)23 b(de\002nition)h(of)g Fs(aand)f FA(sho)n(ws)h(that)g(the)h
(e)o(xpansion)d(will)j(v)n(ary)e(depending)f(on)i(the)555
1807 y(number)16 b(of)i(ar)o(guments)e(in)i(the)g(macro)f(call.)29
b(If)18 b(there)f(are)h(no)g(ar)o(guments,)e(then)h Fs(aand)p
FA(,)g(lik)o(e)555 1911 y(the)27 b(re)o(gular)f Fs(and)p
FA(,)i(should)f(simply)g(return)f Fs(t)p FA(.)50 b(Otherwise)27
b(the)h(e)o(xpansion)d(is)j(generated)555 2016 y(recursi)n(v)o(ely)-5
b(,)18 b(each)i(step)g(yielding)f(one)h(layer)f(in)i(a)f(chain)g(of)g
(nested)g Fs(aif)p FA(s:)555 2204 y Fs(\(aif)42 b Fq(h)p
FA(\002rst)21 b(ar)o(gument)p Fq(i)773 2308 y(h)p FA(e)o(xpansion)d
(for)i(rest)h(of)e(ar)o(guments)p Fq(i)p Fs(\))555 2529
y FA(The)d(e)o(xpansion)f(of)h(an)h Fs(aand)e FA(must)i(terminate)f
(when)g(there)g(is)h(one)f(ar)o(gument)e(left,)k(instead)555
2634 y(of)26 b(w)o(orking)e(its)j(w)o(ay)f(do)n(wn)f(to)h
Fs(nil)f FA(lik)o(e)h(most)g(recursi)n(v)o(e)f(functions.)44
b(If)26 b(the)g(recursion)555 2738 y(continued)j(until)i(no)g
(conjuncts)f(remained,)j(the)e(e)o(xpansion)e(w)o(ould)i(al)o(w)o(ays)g
(be)h(of)f(the)555 2843 y(form:)555 3031 y Fs(\(aif)42
b Fq(h)p Ft(c)842 3043 y Fm(1)875 3031 y Fq(i)773 3122
y Fs(.)773 3155 y(.)773 3189 y(.)773 3293 y(\(aif)g Fq(h)p
Ft(c)1060 3305 y Fm(n)1093 3293 y Fq(i)991 3398 y Fs(t\))p
Fy(:)14 b(:)g(:)o Fs(\))555 3619 y FA(Such)g(an)g(e)o(xpression)f(w)o
(ould)g(al)o(w)o(ays)i(return)e Fs(t)i FA(or)f Fs(nil)p
FA(,)g(and)g(the)g(e)o(xample)f(abo)o(v)o(e)g(w)o(ouldn')o(t)555
3723 y(w)o(ork)20 b(as)g(intended.)680 3828 y(Section)j(10.4)f(w)o
(arned)h(that)g(if)h(a)g(macro)f(al)o(w)o(ays)h(yielded)e(an)i(e)o
(xpansion)d(containing)555 3932 y(a)j(call)g(to)g(itself,)h(the)e(e)o
(xpansion)f(w)o(ould)h(ne)n(v)o(er)f(terminate.)39 b(Though)21
b(recursi)n(v)o(e,)i Fs(aand)g FA(is)555 4037 y(safe)d(because)g(in)g
(the)g(base)h(case)f(its)i(e)o(xpansion)c(doesn')o(t)g(refer)i(to)g
Fs(aand)p FA(.)680 4142 y(The)j(last)j(e)o(xample,)d
Fs(acond)p FA(,)h(is)h(meant)e(for)h(those)g(cases)h(where)f(the)g
(remainder)e(of)i(a)555 4246 y Fs(cond)16 b FA(clause)i(w)o(ants)f(to)h
(use)f(the)h(v)n(alue)e(returned)g(by)h(the)g(test)h(e)o(xpression.)27
b(\(This)17 b(situation)555 4351 y(arises)j(so)f(often)f(that)h(some)g
(Scheme)f(implementations)f(pro)o(vide)g(a)j(w)o(ay)f(to)g(use)g(the)g
(v)n(alue)555 4456 y(returned)f(by)i(the)g(test)h(e)o(xpression)e(in)h
(a)h Fs(cond)e FA(clause.\))680 4560 y(In)30 b(the)g(e)o(xpansion)f(of)
h(an)g Fs(acond)f FA(clause,)k(the)d(result)h(of)f(the)h(test)g(e)o
(xpression)e(will)555 4665 y(initially)16 b(be)h(k)o(ept)f(in)g(a)h
(gensymed)e(v)n(ariable,)h(in)g(order)g(that)g(the)g(symbol)g
Fs(it)g FA(may)g(be)g(bound)555 4769 y(only)d(within)g(the)g(remainder)
f(of)h(the)g(clause.)27 b(When)13 b(macros)g(create)g(bindings,)g(the)o
(y)g(should)555 4874 y(al)o(w)o(ays)25 b(do)e(so)i(o)o(v)o(er)e(the)h
(narro)n(west)f(possible)h(scope.)40 b(Here,)25 b(if)g(we)f(dispensed)f
(with)i(the)p eop
%%Page: 193 206
193 205 bop 555 538 a Ft(14.1)886 b Fu(AN)n(APHORIC)19
b(V)-8 b(ARIANTS)868 b FA(193)p 555 745 2678 4 v 553
2366 4 1621 v 605 888 a Fs(\(defmacro)40 b(alambda)g(\(parms)h(&body)h
(body\))692 988 y(`\(labels)e(\(\(self)h(,parms)g(,@body\)\))823
1087 y(#'self\)\))605 1287 y(\(defmacro)f(ablock)h(\(tag)h(&rest)f
(args\))692 1386 y(`\(block)g(,tag)823 1486 y(,\(funcall)f(\(alambda)g
(\(args\))1346 1586 y(\(case)h(\(length)g(args\))1433
1685 y(\(0)i(nil\))1433 1785 y(\(1)g(\(car)f(args\)\))1433
1884 y(\(t)h(`\(let)e(\(\(it)h(,\(car)g(args\)\)\))1694
1984 y(,\(self)g(\(cdr)g(args\)\)\)\)\)\))1259 2084 y(args\)\)\))1261
2288 y FA(Figure)19 b(14.2:)28 b(More)20 b(anaphoric)e(v)n(ariants.)p
3231 2366 V 555 2369 2678 4 v 555 2594 a(gensym)i(and)g(instead)h
(bound)f Fs(it)g FA(immediately)g(to)h(the)g(result)h(of)e(the)h(test)h
(e)o(xpression,)e(as)555 2698 y(in:)555 2881 y Fs(\(defmacro)40
b(acond)h(\(&rest)g(clauses\))1000 b(;)43 b(wrong)642
2980 y(\(if)g(\(null)e(clauses\))817 3080 y(nil)817 3180
y(\(let)g(\(\(cl1)h(\(car)g(clauses\)\)\))904 3279 y(`\(let)f(\(\(it)h
(,\(car)g(cl1\)\)\))1034 3379 y(\(if)h(it)1209 3479 y(\(progn)e
(,@\(cdr)g(cl1\)\))1209 3578 y(\(acond)g(,@\(cdr)g
(clauses\)\)\)\)\)\)\))555 3766 y FA(then)18 b(that)g(binding)e(of)i
Fs(it)f FA(w)o(ould)h(also)g(ha)n(v)o(e)f(within)h(its)h(scope)f(the)g
Ft(following)f FA(test)i(e)o(xpres\255)555 3870 y(sion.)680
3975 y(Figure)j(14.2)f(contains)h(some)h(more)f(complicated)f
(anaphoric)g(v)n(ariants.)36 b(The)23 b(macro)555 4080
y Fs(alambda)d FA(is)j(for)f(referring)e(literally)i(to)h(recursi)n(v)o
(e)e(functions.)34 b(When)22 b(does)g(one)g(w)o(ant)g(to)555
4184 y(refer)c(literally)g(to)g(a)h(recursi)n(v)o(e)e(function?)26
b(W)-7 b(e)20 b(can)e(refer)f(literally)i(to)f(a)h(function)d(by)i
(using)555 4289 y(a)j(sharp\255quoted)c(lambda\255e)o(xpression:)555
4471 y Fs(#'\(lambda)40 b(\(x\))i(\(*)h(x)g(2\)\))555
4659 y FA(But)22 b(as)h(Chapter)e(2)h(e)o(xplained,)e(you)h(can')o(t)g
(e)o(xpress)g(a)i(recursi)n(v)o(e)d(function)g(with)i(a)h(simple)555
4764 y(lambda\255e)o(xpression.)i(Instead)16 b(you)h(ha)n(v)o(e)f(to)i
(de\002ne)f(a)g(local)h(function)d(with)j Fs(labels)p
FA(.)26 b(The)555 4868 y(follo)n(wing)19 b(function)f(\(reproduced)f
(from)i(page)h(22\))p eop
%%Page: 194 207
194 206 bop 555 538 a FA(194)910 b Fu(AN)n(APHORIC)19
b(MA)n(CR)n(OS)555 801 y Fs(\(defun)41 b(count-instances)c(\(obj)42
b(lists\))642 900 y(\(labels)f(\(\(instances-in)d(\(list\))1122
1000 y(\(if)k(list)1296 1100 y(\(+)h(\(if)f(\(eq)g(\(car)g(list\))g
(obj\))g(1)h(0\))1427 1199 y(\(instances-in)38 b(\(cdr)k(list\)\)\))
1296 1299 y(0\)\)\))729 1398 y(\(mapcar)f(#'instances-in)d(lists\)\)\))
555 1586 y FA(tak)o(es)25 b(an)g(object)f(and)g(a)h(list,)i(and)d
(returns)g(a)h(list)h(of)e(the)h(number)e(of)h(occurrences)f(of)i(the)
555 1691 y(object)20 b(in)g(each)g(element:)555 1873
y Fs(>)43 b(\(count-instances)37 b('a)43 b('\(\(a)f(b)h(c\))g(\(d)g(a)g
(r)g(p)g(a\))g(\(d)g(a)g(r\))f(\(a)h(a\)\)\))555 1973
y(\(1)g(2)g(1)g(2\))555 2161 y FA(W)m(ith)28 b(anaphora)d(we)j(can)g
(mak)o(e)f(what)g(amounts)g(to)g(a)h(literal)g(recursi)n(v)o(e)e
(function.)50 b(The)555 2265 y Fs(alambda)21 b FA(macro)h(uses)h
Fs(labels)e FA(to)i(create)g(one,)g(and)f(thus)h(can)g(be)g(used)f(to)i
(e)o(xpress,)e(for)555 2370 y(e)o(xample,)d(the)h(f)o(actorial)f
(function:)555 2552 y Fs(\(alambda)40 b(\(x\))j(\(if)f(\(=)h(x)g(0\))g
(1)g(\(*)g(x)g(\(self)e(\(1-)i(x\)\)\)\)\))555 2740 y
FA(Using)30 b Fs(alambda)f FA(we)i(can)f(de\002ne)g(an)h(equi)n(v)n
(alent)d(v)o(ersion)i(of)g Fs(count-instances)25 b FA(as)555
2845 y(follo)n(ws:)555 3027 y Fs(\(defun)41 b(count-instances)c(\(obj)
42 b(lists\))642 3127 y(\(mapcar)f(\(alambda)f(\(list\))1078
3227 y(\(if)i(list)1252 3326 y(\(+)h(\(if)f(\(eq)h(\(car)f(list\))f
(obj\))h(1)h(0\))1383 3426 y(\(self)f(\(cdr)g(list\)\)\))1252
3525 y(0\)\))991 3625 y(lists\)\))555 3813 y FA(Unlik)o(e)19
b(the)h(other)e(macros)h(in)g(Figures)g(14.1)g(and)g(14.2,)f(which)h
(all)h(capture)e Fs(it)p FA(,)h Fs(alambda)555 3917 y
FA(captures)28 b Fs(self)p FA(.)54 b(An)28 b(instance)h(of)f
Fs(alambda)f FA(e)o(xpands)g(into)h(a)h Fs(labels)e FA(e)o(xpression)g
(in)555 4022 y(which)h Fs(self)f FA(is)i(bound)e(to)h(the)h(function)d
(being)i(de\002ned.)53 b(As)29 b(well)g(as)g(being)e(smaller)m(,)555
4127 y Fs(alambda)17 b FA(e)o(xpressions)i(look)g(lik)o(e)h(f)o
(amiliar)f Fs(lambda)f FA(e)o(xpressions,)h(making)f(code)h(which)555
4231 y(uses)i(them)f(easier)g(to)g(read.)680 4336 y(The)15
b(ne)n(w)g(macro)f(is)j(used)e(in)g(the)h(de\002nition)e(of)h
Fs(ablock)p FA(,)g(an)g(anaphoric)e(v)o(ersion)h(of)i(the)555
4440 y(b)n(uilt\255in)g Fs(block)e FA(special)j(form.)27
b(In)16 b(a)g Fs(block)p FA(,)f(the)i(ar)o(guments)d(are)i(e)n(v)n
(aluated)f(left\255to\255right.)555 4545 y(The)j(same)h(happens)e(in)h
(an)h Fs(ablock)p FA(,)d(b)n(ut)j(within)f(each)g(the)h(v)n(ariable)e
Fs(it)h FA(will)h(be)g(bound)d(to)555 4650 y(the)k(v)n(alue)g(of)g(the)
g(pre)n(vious)e(e)o(xpression.)680 4754 y(This)33 b(macro)g(should)g
(be)h(used)f(with)h(discretion.)69 b(Though)31 b(con)m(v)o(enient)g(at)
j(times,)555 4859 y Fs(ablock)12 b FA(w)o(ould)i(tend)f(to)i(beat)f
(what)g(could)f(be)h(nice)h(functional)d(programs)g(into)i(imperati)n
(v)o(e)555 4963 y(form.)28 b(The)20 b(follo)n(wing)f(is,)h
(unfortunately)-5 b(,)17 b(a)j(characteristically)f(ugly)h(e)o(xample:)
p eop
%%Page: 195 208
195 207 bop 555 538 a Ft(14.2)1091 b Fu(F)l(AILURE)1073
b FA(195)555 801 y Fs(>)43 b(\(ablock)e(north-pole)729
900 y(\(princ)g("ho)i("\))729 1000 y(\(princ)e(it\))729
1100 y(\(princ)g(it\))729 1199 y(\(return-from)e(north-pole\)\))555
1299 y(ho)k(ho)g(ho)555 1398 y(NIL)680 1580 y FA(Whene)n(v)o(er)32
b(a)j(macro)e(which)h(does)g(intentional)f(v)n(ariable)h(capture)f(is)i
(e)o(xported)d(to)555 1684 y(another)26 b(package,)h(it)h(is)g
(necessary)f(also)g(to)h(e)o(xport)d(the)j(symbol)e(being)g(captured.)
49 b(F)o(or)555 1789 y(e)o(xample,)15 b(where)n(v)o(er)f
Fs(aif)i FA(is)h(e)o(xported,)d Fs(it)i FA(should)f(be)h(as)h(well.)28
b(Otherwise)16 b(the)g Fs(it)g FA(which)555 1893 y(appears)j(in)h(the)g
(macro)f(de\002nition)g(w)o(ould)h(be)g(a)g(dif)n(ferent)e(symbol)h
(from)g(an)h Fs(it)g FA(used)g(in)g(a)555 1998 y(macro)f(call.)555
2250 y Fw(14.2)99 b(F)n(ailur)n(e)555 2440 y FA(In)21
b(Common)f(Lisp)i(the)f(symbol)g Fs(nil)f FA(has)i(at)g(least)g(three)f
(dif)n(ferent)f(jobs.)33 b(It)21 b(is)i(\002rst)f(of)f(all)555
2545 y(the)f(empty)g(list,)h(so)f(that)555 2721 y Fs(>)43
b(\(cdr)f('\(a\)\))555 2821 y(NIL)555 3002 y FA(As)21
b(well)g(as)g(the)f(empty)f(list,)i Fs(nil)f FA(is)h(used)f(to)g
(represent)f(f)o(alsity)-5 b(,)20 b(as)h(in)555 3178
y Fs(>)43 b(\(=)g(1)g(0\))555 3278 y(NIL)555 3459 y FA(And)22
b(\002nally)-5 b(,)23 b(functions)e(return)h Fs(nil)g
FA(to)h(indicate)f(f)o(ailure.)37 b(F)o(or)22 b(e)o(xample,)g(the)h
(job)f(of)h(the)555 3564 y(b)n(uilt\255in)g Fs(find-if)f
FA(is)i(to)g(return)f(the)h(\002rst)g(element)f(of)h(a)g(list)h(which)e
(satis\002es)i(some)f(test.)555 3668 y(If)c(no)g(such)g(element)f(is)i
(found,)e Fs(find-if)f FA(returns)h Fs(nil)p FA(:)555
3844 y Fs(>)43 b(\(find-if)d(#'oddp)i('\(2)g(4)h(6\)\))555
3944 y(NIL)555 4125 y FA(Unfortunately)-5 b(,)22 b(we)j(can')o(t)f
(tell)h(this)g(case)g(from)f(the)g(one)g(in)h(which)f
Fs(find-if)e FA(succeeds,)555 4230 y(b)n(ut)e(succeeds)g(in)g
(\002nding)f Fs(nil)p FA(:)555 4406 y Fs(>)43 b(\(find-if)d(#'null)i
('\(2)g(nil)g(6\)\))555 4506 y(NIL)555 4687 y FA(In)21
b(practice,)f(it)i(doesn')o(t)e(cause)h(too)g(much)f(trouble)g(to)h
(use)g Fs(nil)g FA(to)g(represent)f(both)g(f)o(alsity)555
4791 y(and)k(the)h(empty)f(list.)44 b(In)24 b(f)o(act,)i(it)g(can)e(be)
h(rather)f(con)m(v)o(enient.)40 b(Ho)n(we)n(v)o(er)m(,)24
b(it)h(is)h(a)f(pain)f(to)555 4896 y(ha)n(v)o(e)e Fs(nil)f
FA(represent)g(f)o(ailure)h(as)h(well,)g(because)e(it)i(means)f(that)g
(the)h(result)f(returned)e(by)i(a)555 5001 y(function)c(lik)o(e)j
Fs(find-if)d FA(can)i(be)g(ambiguous.)p eop
%%Page: 196 209
196 208 bop 555 538 a FA(196)910 b Fu(AN)n(APHORIC)19
b(MA)n(CR)n(OS)680 801 y FA(The)k(problem)f(of)i(distinguishing)e
(between)h(f)o(ailure)h(and)f(a)i Fs(nil)e FA(return)g(v)n(alue)g
(arises)555 905 y(with)e(an)o(y)f(function)f(which)h(looks)g(things)h
(up.)30 b(Common)20 b(Lisp)h(of)n(fers)f(no)g(less)i(than)e(three)555
1010 y(solutions)29 b(to)g(the)h(problem.)54 b(The)29
b(most)h(common)d(approach,)i(before)f(multiple)h(return)555
1114 y(v)n(alues,)24 b(w)o(as)g(to)f(return)g(gratuitous)f(list)i
(structure.)38 b(There)23 b(is)h(no)f(trouble)f(distinguishing)555
1219 y(f)o(ailure)30 b(with)i Fs(assoc)p FA(,)g(for)e(e)o(xample;)35
b(when)c(successful)f(it)i(returns)e(the)h(whole)g(pair)f(in)555
1324 y(question:)555 1494 y Fs(>)43 b(\(setq)f(synonyms)e('\(\(yes)h(.)
i(t\))g(\(no)f(.)i(nil\)\)\))555 1594 y(\(\(YES)e(.)h(T\))f(\(NO\)\))
555 1693 y(>)h(\(assoc)e('no)i(synonyms\))555 1793 y(\(NO\))555
1969 y FA(F)o(ollo)n(wing)20 b(this)i(approach,)e(if)i(we)g(were)f(w)o
(orried)g(about)f(ambiguity)g(with)i Fs(find-if)p FA(,)d(we)555
2073 y(w)o(ould)h(use)h Fs(member-if)p FA(,)c(which)k(instead)f(of)h
(just)g(returning)d(the)j(element)f(satisfying)h(the)555
2178 y(test,)g(returns)e(the)h(whole)g(cdr)g(which)f(be)o(gins)h(with)g
(it:)555 2348 y Fs(>)43 b(\(member-if)d(#'null)h('\(2)h(nil)g(6\)\))555
2448 y(\(NIL)g(6\))680 2624 y FA(Since)21 b(the)h(adv)o(ent)e(of)h
(multiple)g(return)f(v)n(alues,)h(there)g(has)h(been)f(another)f
(solution)g(to)555 2728 y(this)k(problem:)35 b(use)24
b(one)f(v)n(alue)g(for)g(data)h(and)f(a)h(second)f(to)h(indicate)f
(success)h(or)f(f)o(ailure.)555 2833 y(The)i(b)n(uilt\255in)g
Fs(gethash)f FA(w)o(orks)h(this)h(w)o(ay)-5 b(.)46 b(It)25
b(al)o(w)o(ays)i(returns)d(tw)o(o)i(v)n(alues,)h(the)e(second)555
2937 y(indicating)19 b(whether)g(an)o(ything)f(w)o(as)j(found:)555
3108 y Fs(>)43 b(\(setf)f(edible)956 b(\(make-hash-table)o(\))904
3208 y(\(gethash)40 b('olive-oil)f(edible\))i(t)904 3307
y(\(gethash)f('motor-oil)f(edible\))i(nil\))555 3407
y(NIL)555 3506 y(>)i(\(gethash)d('motor-oil)g(edible\))555
3606 y(NIL)555 3706 y(T)555 3881 y FA(So)27 b(if)f(you)g(w)o(ant)h(to)f
(detect)g(all)h(three)f(possible)h(cases,)h(you)e(can)g(use)h(an)f
(idiom)g(lik)o(e)h(the)555 3986 y(follo)n(wing:)555 4156
y Fs(\(defun)41 b(edible?)g(\(x\))642 4256 y(\(multiple-value-b)o(in)o
(d)c(\(val)42 b(found?\))f(\(gethash)f(x)k(edible\))729
4356 y(\(if)f(found?)904 4455 y(\(if)f(val)g('yes)g('no\))904
4555 y('maybe\)\)\))555 4730 y FA(thereby)19 b(distinguishing)f(f)o
(alsity)j(from)e(f)o(ailure:)555 4901 y Fs(>)43 b(\(mapcar)e(#'edible?)
f('\(motor-oil)f(olive-oil)h(iguana\)\))555 5001 y(\(NO)i(YES)h
(MAYBE\))p eop
%%Page: 197 210
197 209 bop 555 538 a Ft(14.3)1091 b Fu(F)l(AILURE)1073
b FA(197)680 801 y(Common)32 b(Lisp)h(supports)f(yet)i(a)g(third)e(w)o
(ay)i(of)f(indicating)f(f)o(ailure:)55 b(to)34 b(ha)n(v)o(e)f(the)555
905 y(access)28 b(function)e(tak)o(e)h(as)i(an)e(ar)o(gument)e(a)j
(special)g(object,)g(presumably)e(a)i(gensym,)f(to)555
1010 y(be)g(returned)e(in)i(case)g(of)f(f)o(ailure.)49
b(This)27 b(approach)d(is)k(used)f(with)g Fs(get)p FA(,)g(which)f(tak)o
(es)i(an)555 1114 y(optional)19 b(ar)o(gument)f(saying)h(what)h(to)h
(return)e(if)h(the)g(speci\002ed)g(property)e(isn')o(t)i(found:)555
1257 y Fs(>)43 b(\(get)f('life)g('meaning)e(\(gensym\)\))555
1357 y(#:G618)680 1504 y FA(Where)30 b(multiple)g(return)f(v)n(alues)h
(are)h(possible,)h(the)f(approach)d(used)j(by)f Fs(gethash)555
1609 y FA(is)i(the)g(cleanest.)63 b(W)-7 b(e)33 b(don')o(t)d(w)o(ant)h
(to)h(ha)n(v)o(e)f(to)h(pass)g(additional)e(ar)o(guments)f(to)j(e)n(v)o
(ery)555 1713 y(access)17 b(function,)e(as)i(we)f(do)g(with)h
Fs(get)p FA(.)27 b(And)16 b(between)f(the)h(other)g(tw)o(o)g(alternati)
n(v)o(es,)g(using)555 1818 y(multiple)d(v)n(alues)g(is)h(the)f(more)g
(general;)h Fs(find-if)d FA(could)i(be)g(written)g(to)g(return)g(tw)o
(o)g(v)n(alues,)555 1923 y(b)n(ut)21 b Fs(gethash)e FA(could)i(not,)g
(without)f(consing,)h(be)g(written)g(to)g(return)g(disambiguating)d
(list)555 2027 y(structure.)59 b(Thus)30 b(in)h(writing)e(ne)n(w)i
(functions)e(for)h(lookup,)h(or)f(for)g(other)f(tasks)i(where)555
2132 y(f)o(ailure)20 b(is)h(possible,)e(it)i(will)g(usually)f(be)g
(better)g(to)g(follo)n(w)g(the)g(model)f(of)h Fs(gethash)p
FA(.)680 2237 y(The)27 b(idiom)h(found)f(in)h Fs(edible?)e
FA(is)j(just)g(the)f(sort)g(of)g(bookk)o(eeping)d(which)j(is)h(well)555
2341 y(hidden)15 b(by)g(a)i(macro.)26 b(F)o(or)16 b(access)h(functions)
d(lik)o(e)j Fs(gethash)c FA(we)k(will)f(w)o(ant)h(a)f(ne)n(w)g(v)o
(ersion)555 2446 y(of)f Fs(aif)g FA(which,)h(instead)f(of)g(binding)f
(and)h(testing)g(the)h(same)g(v)n(alue,)f(binds)g(the)h(\002rst)g(b)n
(ut)f(also)555 2550 y(tests)24 b(the)f(second.)36 b(The)23
b(ne)n(w)g(v)o(ersion)e(of)i Fs(aif)p FA(,)g(called)f
Fs(aif2)p FA(,)h(is)g(sho)n(wn)g(in)g(Figure)f(14.3.)555
2655 y(Using)e(it)h(we)g(could)e(write)h Fs(edible?)e
FA(as:)555 2798 y Fs(\(defun)41 b(edible?)g(\(x\))642
2897 y(\(aif2)h(\(gethash)e(x)j(edible\))904 2997 y(\(if)f(it)h('yes)f
('no\))904 3096 y('maybe\)\))680 3244 y FA(Figure)26
b(14.3)g(also)i(contains)e(similarly)h(altered)g(v)o(ersions)f(of)h
Fs(awhen)p FA(,)g Fs(awhile)p FA(,)g(and)555 3349 y Fs(acond)p
FA(.)55 b(F)o(or)28 b(an)h(e)o(xample)f(of)h(the)g(use)h(of)e
Fs(acond2)p FA(,)i(see)f(the)g(de\002nition)f(of)h Fs(match)f
FA(on)555 3453 y(page)e(239.)48 b(By)27 b(using)f(this)h(macro)f(we)h
(are)g(able)f(to)h(e)o(xpress)f(in)h(the)f(form)g(of)g(a)i
Fs(cond)d FA(a)555 3558 y(function)18 b(that)j(w)o(ould)e(otherwise)h
(be)g(much)f(longer)g(and)h(less)h(symmetrical.)680 3662
y(The)h(b)n(uilt\255in)g Fs(read)f FA(indicates)i(f)o(ailure)f(in)h
(the)f(same)h(w)o(ay)g(as)g Fs(get)p FA(.)36 b(It)23
b(tak)o(es)g(optional)555 3767 y(ar)o(guments)h(saying)h(whether)f(or)i
(not)f(to)h(generate)e(an)i(error)e(in)i(case)g(of)g(eof,)g(and)f(if)h
(not,)555 3872 y(what)e(v)n(alue)f(to)h(return.)38 b(Figure)24
b(14.4)e(contains)h(an)h(alternati)n(v)o(e)e(v)o(ersion)h(of)g
Fs(read)g FA(which)555 3976 y(uses)c(a)g(second)e(return)h(v)n(alue)f
(to)i(indicate)f(f)o(ailure:)28 b Fs(read2)17 b FA(returns)g(tw)o(o)i
(v)n(alues,)f(the)g(input)555 4081 y(e)o(xpression)28
b(and)h(a)i(\003ag)e(which)h(is)g Fs(nil)g FA(upon)e(eof.)57
b(It)30 b(calls)h Fs(read)e FA(with)h(a)g(gensym)e(to)555
4185 y(be)f(returned)f(in)h(case)h(of)f(eof,)i(b)n(ut)e(to)g(sa)n(v)o
(e)h(the)f(trouble)f(of)h(b)n(uilding)f(the)i(gensym)e(each)555
4290 y(time)21 b Fs(read2)f FA(is)h(called,)g(the)g(function)e(is)j
(de\002ned)e(as)i(a)f(closure)f(with)h(a)h(pri)n(v)n(ate)d(cop)o(y)i
(of)f(a)555 4395 y(gensym)f(made)h(at)g(compile)g(time.)680
4499 y(Figure)c(14.4)g(also)i(contains)f(a)g(con)m(v)o(enient)e(macro)h
(to)i(iterate)f(o)o(v)o(er)f(the)h(e)o(xpressions)f(in)555
4604 y(a)j(\002le,)g(written)f(using)g Fs(awhile2)e FA(and)i
Fs(read2)p FA(.)27 b(Using)19 b Fs(do-file)d FA(we)j(could,)e(for)h(e)o
(xample,)555 4709 y(write)i(a)h(v)o(ersion)e(of)h Fs(load)f
FA(as:)555 4851 y Fs(\(defun)41 b(our-load)f(\(filename\))642
4951 y(\(do-file)g(filename)h(\(eval)g(it\)\)\))p eop
%%Page: 198 211
198 210 bop 555 538 a FA(198)910 b Fu(AN)n(APHORIC)19
b(MA)n(CR)n(OS)p 555 745 2678 4 v 553 3761 4 3016 v 605
888 a Fs(\(defmacro)40 b(aif2)i(\(test)f(&optional)f(then)i(else\))692
988 y(\(let)g(\(\(win)f(\(gensym\)\)\))779 1087 y(`\(multiple-value-)o
(bi)o(nd)c(\(it)42 b(,win\))g(,test)910 1187 y(\(if)g(\(or)h(it)f
(,win\))g(,then)f(,else\)\)\)\))605 1386 y(\(defmacro)f(awhen2)h
(\(test)g(&body)h(body\))692 1486 y(`\(aif2)f(,test)997
1586 y(\(progn)g(,@body\)\)\))605 1785 y(\(defmacro)f(awhile2)g(\(test)
i(&body)f(body\))692 1884 y(\(let)h(\(\(flag)f(\(gensym\)\)\))779
1984 y(`\(let)h(\(\(,flag)e(t\)\))910 2084 y(\(while)h(,flag)997
2183 y(\(aif2)h(,test)1259 2283 y(\(progn)f(,@body\))1259
2383 y(\(setq)g(,flag)h(nil\)\)\)\)\)\))605 2582 y(\(defmacro)e(acond2)
h(\(&rest)g(clauses\))692 2681 y(\(if)h(\(null)g(clauses\))866
2781 y(nil)866 2881 y(\(let)g(\(\(cl1)g(\(car)g(clauses\)\))1128
2980 y(\(val)g(\(gensym\)\))1128 3080 y(\(win)g(\(gensym\)\)\))954
3180 y(`\(multiple-valu)o(e-)o(bin)o(d)37 b(\(,val)42
b(,win\))f(,\(car)h(cl1\))1084 3279 y(\(if)h(\(or)f(,val)g(,win\))1259
3379 y(\(let)g(\(\(it)f(,val\)\))h(,@\(cdr)f(cl1\)\))1259
3478 y(\(acond2)f(,@\(cdr)h(clauses\)\)\)\)\)\)\))1115
3683 y FA(Figure)20 b(14.3:)28 b(Multiple\255v)n(alue)18
b(anaphoric)g(macros.)p 3231 3761 V 555 3764 2678 4 v
555 3966 a Fw(14.3)99 b(Refer)n(ential)26 b(T)-7 b(ranspar)n(ency)555
4157 y FA(Anaphoric)23 b(macros)h(are)h(sometimes)g(said)g(to)h
(violate)e(referential)g(transparenc)o(y)-5 b(,)23 b(which)555
4262 y(Gelernter)c(and)h(Jagannathan)e(de\002ne)h(as)i(follo)n(ws:)763
4422 y(A)34 b(language)e(is)i Ft(r)m(efer)m(entially)g(tr)o(anspar)m
(ent)e FA(if)i(\(a\))g(e)n(v)o(ery)e(sube)o(xpression)763
4527 y(can)c(be)h(replaced)e(by)i(an)o(y)f(other)f(that')-5
b(s)30 b(equal)e(to)h(it)g(in)g(v)n(alue)f(and)g(\(b\))g(all)-2577
b Fq(\016)763 4631 y FA(occurrences)23 b(of)i(an)h(e)o(xpression)e
(within)h(a)h(gi)n(v)o(en)e(conte)o(xt)g(yield)h(the)h(same)763
4736 y(v)n(alue.)680 4896 y(Note)13 b(that)g(this)g(standard)g(applies)
g(to)f(lan)o(gu)o(ages,)c(not)13 b(to)g(programs.)22
b(No)13 b(language)g(with)555 5001 y(assignment)19 b(is)i
(referentially)e(transparent.)28 b(The)19 b(\002rst)i(and)f(the)g(last)
h Fs(x)g FA(in)f(this)h(e)o(xpression)p eop
%%Page: 199 212
199 211 bop 555 538 a Ft(14.3)770 b Fu(REFERENTIAL)17
b(TRANSP)-5 b(ARENCY)752 b FA(199)p 555 745 2678 4 v
553 2067 4 1322 v 605 888 a Fs(\(let)42 b(\(\(g)g(\(gensym\)\)\))692
988 y(\(defun)f(read2)h(\(&optional)d(\(str)j(*standard-input*)o(\)\))
779 1087 y(\(let)g(\(\(val)g(\(read)f(str)h(nil)h(g\)\)\))866
1187 y(\(unless)e(\(equal)g(val)h(g\))h(\(values)e(val)h(t\)\)\)\)\))
605 1386 y(\(defmacro)e(do-file)g(\(filename)g(&body)i(body\))692
1486 y(\(let)g(\(\(str)f(\(gensym\)\)\))779 1586 y(`\(with-open-file)c
(\(,str)42 b(,filename\))910 1685 y(\(awhile2)e(\(read2)h(,str\))997
1785 y(,@body\)\)\)\))1466 1989 y FA(Figure)19 b(14.4:)29
b(File)21 b(utilities.)p 3231 2067 V 555 2070 2678 4
v 555 2295 a Fs(\(list)42 b(x)817 2394 y(\(setq)f(x)i(\(not)f(x\)\))817
2494 y(x\))555 2682 y FA(yield)23 b(dif)n(ferent)e(v)n(alues,)i
(because)f(a)i Fs(setq)e FA(interv)o(enes.)36 b(Admittedly)-5
b(,)22 b(this)h(is)h(ugly)f(code.)555 2786 y(The)d(f)o(act)g(that)h(it)
f(is)i(e)n(v)o(en)d(possible)h(means)g(that)g(Lisp)g(is)h(not)f
(referentially)f(transparent.)680 2891 y(Norvig)f(mentions)i(that)g(it)
h(w)o(ould)e(be)i(con)m(v)o(enient)c(to)j(rede\002ne)g
Fs(if)f FA(as:)545 b Fq(\016)555 3073 y Fs(\(defmacro)40
b(if)j(\(test)e(then)h(&optional)e(else\))642 3173 y(`\(let)i(\(\(that)
f(,test\)\))773 3273 y(\(if)h(that)g(,then)g(,else\)\)\))555
3460 y FA(b)n(ut)20 b(rejects)h(this)f(macro)g(on)f(the)i(grounds)d
(that)i(it)h(violates)f(referential)f(transparenc)o(y)-5
b(.)680 3565 y(Ho)n(we)n(v)o(er)m(,)15 b(the)h(problem)f(here)h(comes)g
(from)g(rede\002ning)f(b)n(uilt\255in)h(operators,)f(not)i(from)555
3669 y(using)28 b(anaphora.)53 b(Clause)29 b(\(b\))f(of)h(the)f
(de\002nition)g(abo)o(v)o(e)f(requires)h(that)h(an)f(e)o(xpression)555
3774 y(al)o(w)o(ays)20 b(return)f(the)h(same)g(v)n(alue)f(\223within)h
(a)g(gi)n(v)o(en)f(conte)o(xt.)-6 b(\224)28 b(It)20 b(is)h(no)f
(problem)e(if,)i(within)555 3879 y(this)h Fs(let)e FA(e)o(xpression,)
555 4061 y Fs(\(let)42 b(\(\(that)f('which\)\))642 4161
y(...\))555 4349 y FA(the)27 b(symbol)g Fs(that)f FA(denotes)g(a)i(ne)n
(w)f(v)n(ariable,)h(because)e Fs(let)h FA(is)h(adv)o(ertised)e(to)h
(create)g(a)555 4453 y(ne)n(w)20 b(conte)o(xt.)680 4558
y(The)15 b(trouble)h(with)g(the)g(macro)g(abo)o(v)o(e)e(is)k(that)e(it)
h(rede\002nes)e Fs(if)p FA(,)i(which)f(is)h Ft(not)f
FA(supposed)555 4662 y(to)27 b(create)g(a)g(ne)n(w)g(conte)o(xt.)49
b(This)27 b(problem)e(goes)i(a)o(w)o(ay)f(if)i(we)f(gi)n(v)o(e)f
(anaphoric)f(macros)555 4767 y(distinct)c(names.)30 b(\(As)21
b(of)f Fr(CL)-6 b(TL)p FA(2,)20 b(it)h(is)h(ille)o(gal)e(to)h
(rede\002ne)f Fs(if)g FA(an)o(yw)o(ay)-5 b(.\))29 b(As)21
b(long)f(as)h(it)h(is)555 4872 y(part)d(of)g(the)g(de\002nition)f(of)h
Fs(aif)g FA(that)g(it)h(establishes)g(a)g(ne)n(w)f(conte)o(xt)f(in)h
(which)g Fs(it)g FA(is)h(a)g(ne)n(w)555 4976 y(v)n(ariable,)f(such)h(a)
g(macro)g(does)g(not)f(violate)h(referential)f(transparenc)o(y)-5
b(.)p eop
%%Page: 200 213
200 212 bop 555 538 a FA(200)910 b Fu(AN)n(APHORIC)19
b(MA)n(CR)n(OS)680 801 y FA(No)n(w)-5 b(,)35 b Fs(aif)e
FA(does)g(violate)g(another)f(con)m(v)o(ention,)i(which)f(has)g
(nothing)f(to)h(do)g(with)555 905 y(referential)22 b(transparenc)o(y:)
34 b(that)24 b(ne)n(wly)f(established)h(v)n(ariables)f(someho)n(w)f(be)
i(indicated)555 1010 y(in)k(the)g(source)f(code.)52 b(The)27
b Fs(let)h FA(e)o(xpression)e(abo)o(v)o(e)g(clearly)h(indicates)h(that)
g Fs(that)f FA(will)555 1114 y(refer)19 b(to)h(a)g(ne)n(w)f(v)n
(ariable.)28 b(It)20 b(could)f(be)h(ar)o(gued)d(that)j(the)g(binding)e
(of)h Fs(it)h FA(within)f(an)h Fs(aif)f FA(is)555 1219
y(not)24 b(so)g(clear)-5 b(.)41 b(Ho)n(we)n(v)o(er)m(,)23
b(this)i(is)f(not)g(a)h(v)o(ery)e(strong)g(ar)o(gument:)34
b Fs(aif)24 b FA(only)f(creates)h(one)555 1324 y(v)n(ariable,)19
b(and)g(the)i(creation)e(of)h(that)g(v)n(ariable)f(is)i(the)g(only)e
(reason)g(to)i(use)f(it.)680 1428 y(Common)f(Lisp)i(itself)h(does)e
(not)h(treat)g(this)g(con)m(v)o(ention)d(as)j(in)m(violable.)30
b(The)20 b(binding)555 1533 y(of)d(the)g Fr(CLOS)h FA(function)d
Fs(call-next-method)d FA(depends)k(on)h(the)g(conte)o(xt)f(in)h(just)h
(the)f(same)555 1638 y(w)o(ay)27 b(that)f(the)h(binding)e(of)h(the)h
(symbol)e Fs(it)i FA(does)f(within)g(the)h(body)e(of)h(an)h
Fs(aif)p FA(.)47 b(\(F)o(or)26 b(a)555 1742 y(suggestion)i(of)g(ho)n(w)
h Fs(call-next-method)23 b FA(w)o(ould)28 b(be)h(implemented,)g(see)h
(the)f(macro)555 1847 y Fs(defmeth)24 b FA(on)h(page)g(358.\))45
b(In)26 b(an)o(y)f(case,)i(such)f(con)m(v)o(entions)d(are)j(only)f
(supposed)g(to)h(be)555 1951 y(a)j(means)f(to)g(an)g(end:)46
b(programs)26 b(which)i(are)g(easy)h(to)f(read.)53 b(And)28
b(anaphora)e(do)i(mak)o(e)555 2056 y(programs)18 b(easier)j(to)f(read,)
f(just)i(as)g(the)o(y)f(mak)o(e)f(English)h(easier)g(to)g(read.)p
eop
%%Page: 201 214
201 213 bop 555 1610 a Fn(15)p 555 1872 2686 3 v 555
2131 a Fx(Macr)m(os)40 b(Retur)n(ning)i(Functions)555
2568 y FA(Chapter)24 b(5)g(sho)n(wed)g(ho)n(w)g(to)h(write)f(functions)
f(which)h(return)g(other)f(functions.)41 b(Macros)555
2672 y(mak)o(e)17 b(the)g(task)h(of)f(combining)e(operators)h(much)g
(easier)-5 b(.)29 b(This)17 b(chapter)g(will)h(sho)n(w)f(ho)n(w)f(to)
555 2777 y(use)e(macros)f(to)h(b)n(uild)f(abstractions)g(which)g(are)g
(equi)n(v)n(alent)f(to)i(those)f(de\002ned)g(in)h(Chapter)f(5,)555
2882 y(b)n(ut)20 b(cleaner)g(and)f(more)h(ef)n(\002cient.)555
3132 y Fw(15.1)99 b(Building)25 b(Functions)555 3322
y FA(If)36 b Ft(f)h FA(and)e Ft(g)i FA(are)f(functions,)i(then)e
Ft(f)12 b Fq(\016)p Ft(g)p FA(\()p Ft(x)p FA(\))35 b(=)h
Ft(f)12 b FA(\()p Ft(g)p FA(\()p Ft(x)p FA(\)\).)76 b(Section)36
b(5.4)g(sho)n(wed)f(ho)n(w)g(to)555 3427 y(implement)19
b(the)h Fq(\016)g FA(operator)f(as)i(a)f(Lisp)h(function)d(called)i
Fs(compose)p FA(:)555 3594 y Fs(>)43 b(\(funcall)d(\(compose)h(#'list)g
(#'1+\))g(2\))555 3694 y(\(3\))680 3866 y FA(In)13 b(this)g(section,)g
(we)g(consider)g(w)o(ays)g(to)g(de\002ne)g(better)g(function)g(b)n
(uilde)o(rs)g(with)g(macr)o(os.)555 3971 y(Figure)i(15.1)g(contains)g
(a)i(general)e(function\255b)n(uilder)d(called)k Fs(fn)p
FA(,)g(which)g(b)n(uilds)f(compound)555 4075 y(functions)27
b(from)g(their)h(descriptions.)52 b(Its)29 b(ar)o(gument)d(should)h(be)
i(an)f(e)o(xpression)f(of)h(the)555 4180 y(form)c Fs(\()p
Ft(oper)o(ator)42 b Fs(.)h Ft(ar)m(guments)p Fs(\))p
FA(.)g(The)25 b Ft(oper)o(ator)f FA(can)h(be)g(the)g(name)g(of)g(a)g
(function)f(or)555 4284 y(macro\227or)c Fs(compose)p
FA(,)f(which)i(is)h(treated)f(specially)-5 b(.)32 b(The)21
b Ft(ar)m(guments)f FA(can)h(be)h(names)f(of)555 4389
y(functions)h(or)i(macros)f(of)h(one)f(ar)o(gument,)f(or)i(e)o
(xpressions)e(that)i(could)f(be)h(ar)o(guments)d(to)555
4494 y Fs(fn)p FA(.)29 b(F)o(or)20 b(e)o(xample,)555
4661 y Fs(\(fn)42 b(\(and)g(integerp)f(oddp\)\))555 4833
y FA(yields)20 b(a)h(function)d(equi)n(v)n(alent)h(to)555
5001 y Fs(#'\(lambda)40 b(\(x\))i(\(and)g(\(integerp)e(x\))j(\(oddp)e
(x\)\)\))1835 5229 y FA(201)p eop
%%Page: 202 215
202 214 bop 555 538 a FA(202)734 b Fu(MA)n(CR)n(OS)18
b(RETURNING)g(FUNCTIONS)p 555 745 2678 4 v 553 3562 4
2817 v 605 888 a Fs(\(defmacro)40 b(fn)i(\(expr\))g(`#',\(rbuild)d
(expr\)\))605 1087 y(\(defun)i(rbuild)g(\(expr\))692
1187 y(\(if)h(\(or)h(\(atom)e(expr\))h(\(eq)g(\(car)g(expr\))g
('lambda\)\))866 1287 y(expr)866 1386 y(\(if)h(\(eq)f(\(car)g(expr\))f
('compose\))1041 1486 y(\(build-compose)c(\(cdr)42 b(expr\)\))1041
1586 y(\(build-call)d(\(car)j(expr\))f(\(cdr)h(expr\)\)\)\)\))605
1785 y(\(defun)f(build-call)e(\(op)k(fns\))692 1884 y(\(let)f(\(\(g)g
(\(gensym\)\)\))779 1984 y(`\(lambda)e(\(,g\))910 2084
y(\(,op)i(,@\(mapcar)e(#'\(lambda)g(\(f\))1738 2183 y(`\(,\(rbuild)g
(f\))i(,g\)\))1564 2283 y(fns\)\)\)\)\))605 2482 y(\(defun)f
(build-compose)d(\(fns\))692 2582 y(\(let)k(\(\(g)g(\(gensym\)\)\))779
2681 y(`\(lambda)e(\(,g\))910 2781 y(,\(labels)g(\(\(rec)i(\(fns\))1433
2881 y(\(if)g(fns)1607 2980 y(`\(,\(rbuild)e(\(car)i(fns\)\))1694
3080 y(,\(rec)g(\(cdr)g(fns\)\)\))1607 3180 y(g\)\)\))1041
3279 y(\(rec)g(fns\)\)\)\)\))1120 3483 y FA(Figure)19
b(15.1:)29 b(General)19 b(function\255b)n(uilding)d(macro.)p
3231 3562 V 555 3565 2678 4 v 680 3789 a(If)i(we)h(use)g
Fs(compose)d FA(as)k(the)f(operator)m(,)d(we)j(get)g(a)g(function)e
(representing)g(the)h(compo\255)555 3894 y(sition)g(of)f(the)h(ar)o
(guments,)e(b)n(ut)h(without)g(the)h(e)o(xplicit)f Fs(funcall)p
FA(s)f(that)h(were)h(needed)e(when)555 3998 y(compose)j(w)o(as)i
(de\002ned)e(as)i(a)g(function.)27 b(F)o(or)20 b(e)o(xample,)555
4181 y Fs(\(fn)42 b(\(compose)f(list)h(1+)g(truncate\)\))555
4369 y FA(e)o(xpands)19 b(into:)555 4551 y Fs(#'\(lambda)40
b(\(#:g1\))h(\(list)g(\(1+)i(\(truncate)d(#:g1\)\)\)\))555
4739 y FA(which)32 b(enables)f(inline)h(compilation)e(of)i(simple)g
(functions)f(lik)o(e)i Fs(list)e FA(and)g Fs(1+)p FA(.)65
b(The)555 4843 y Fs(fn)22 b FA(macro)g(tak)o(es)h(names)g(of)f
(operators)f(in)i(the)g(general)f(sense;)i(lambda\255e)o(xpressions)c
(are)555 4948 y(allo)n(wed)g(too,)f(as)i(in)p eop
%%Page: 203 216
203 215 bop 555 538 a Ft(15.1)894 b Fu(B)o(UILDING)19
b(FUNCTIONS)877 b FA(203)555 801 y Fs(\(fn)42 b(\(compose)f(\(lambda)f
(\(x\))j(\(+)f(x)i(3\)\))e(truncate\)\))555 988 y FA(which)20
b(e)o(xpands)e(into)555 1171 y Fs(#'\(lambda)40 b(\(#:g2\))h
(\(\(lambda)f(\(x\))j(\(+)f(x)i(3\)\))e(\(truncate)e(#:g2\)\)\))555
1359 y FA(Here)27 b(the)h(function)e(e)o(xpressed)g(as)i(a)g
(lambda\255e)o(xpression)c(will)k(certainly)f(be)g(compiled)555
1463 y(inline,)k(whereas)e(a)g(sharp\255quoted)e(lambda\255e)o
(xpression)e(gi)n(v)o(en)j(as)i(an)f(ar)o(gument)e(to)j(the)555
1568 y(function)18 b Fs(compose)g FA(w)o(ould)i(ha)n(v)o(e)f(to)i(be)f
(funcalled.)680 1672 y(Section)k(5.4)h(sho)n(wed)f(ho)n(w)h(to)g
(de\002ne)g(three)g(more)f(function)f(b)n(uilders:)39
b Fs(fif)p FA(,)26 b Fs(fint)p FA(,)555 1777 y(and)g
Fs(fun)p FA(.)46 b(These)26 b(are)g(no)n(w)f(subsumed)g(in)h(the)g
(general)f Fs(fn)h FA(macro.)46 b(Using)26 b Fs(and)g
FA(as)h(the)555 1882 y(operator)18 b(yields)i(the)h(intersection)e(of)h
(the)g(operators)f(gi)n(v)o(en)g(as)h(ar)o(guments:)555
2064 y Fs(>)43 b(\(mapcar)e(\(fn)h(\(and)g(integerp)e(oddp\)\))991
2164 y('\(c)i(3)h(p)h(0\)\))555 2263 y(\(NIL)e(T)h(NIL)f(NIL\))555
2451 y FA(while)20 b Fs(or)g FA(yields)g(the)g(union:)555
2634 y Fs(>)43 b(\(mapcar)e(\(fn)h(\(or)h(integerp)d(symbolp\)\))991
2733 y('\(c)i(3)h(p)h(0.2\)\))555 2833 y(\(T)f(T)g(T)g(NIL\))555
3021 y FA(and)20 b Fs(if)g FA(yields)g(a)g(function)f(whose)h(body)e
(is)k(a)e(conditional:)555 3203 y Fs(>)43 b(\(map1-n)e(\(fn)h(\(if)h
(oddp)e(1+)i(identity\)\))d(6\))555 3303 y(\(2)j(2)g(4)g(4)g(6)g(6\))
555 3486 y FA(Ho)n(we)n(v)o(er)m(,)18 b(we)j(can)f(use)g(other)f(Lisp)i
(functions)e(besides)h(these)g(three:)555 3652 y Fs(>)43
b(\(mapcar)e(\(fn)h(\(list)g(1-)g(identity)f(1+\)\))991
3751 y('\(1)h(2)h(3\)\))555 3851 y(\(\(0)f(1)i(2\))e(\(1)h(2)g(3\))g
(\(2)g(3)g(4\)\))555 4022 y FA(and)20 b(the)g(ar)o(guments)e(in)i(the)h
Fs(fn)e FA(e)o(xpression)g(may)h(themselv)o(es)f(be)h(e)o(xpressions:)
555 4205 y Fs(>)43 b(\(remove-if)d(\(fn)i(\(or)g(\(and)g(integerp)f
(oddp\))1601 4304 y(\(and)h(consp)g(cdr\)\)\))1122 4404
y('\(1)g(\(a)h(b\))f(c)i(\(d\))e(2)h(3.4)g(\(e)f(f)h(g\)\)\))555
4503 y(\(C)g(\(D\))f(2)h(3.4\))680 4691 y FA(Making)14
b Fs(fn)g FA(treat)g Fs(compos)o(e)f FA(as)h(a)g(spec)o(ial)g(case)g(d)
o(oes)g(n)o(ot)f(mak)n(e)h(it)g(an)n(y)f(mo)o(re)h(p)o(o)n(we)o(rfu)o
(l.)555 4796 y(If)20 b(you)f(nest)i(the)f(ar)o(guments)e(to)j
Fs(fn)p FA(,)e(you)g(get)i(functional)d(composition.)27
b(F)o(or)20 b(e)o(xample,)555 4978 y Fs(\(fn)42 b(\(list)g(\(1+)g
(truncate\)\)\))p eop
%%Page: 204 217
204 216 bop 555 538 a FA(204)734 b Fu(MA)n(CR)n(OS)18
b(RETURNING)g(FUNCTIONS)555 801 y FA(e)o(xpands)h(into:)555
983 y Fs(#'\(lambda)40 b(\(#:g1\))729 1083 y(\(list)i(\(\(lambda)e
(\(#:g2\))h(\(1+)i(\(truncate)c(#:g2\)\)\))i(#:g1\)\)\))555
1271 y FA(which)20 b(beha)n(v)o(es)f(lik)o(e)555 1458
y Fs(\(compose)40 b(#'list)h(#'1+)h(#'truncate\))555
1646 y FA(The)22 b Fs(fn)g FA(macro)f(treats)i Fs(compose)d
FA(as)j(a)g(special)f(case)h(only)e(to)i(mak)o(e)f(such)g(calls)h
(easier)f(to)555 1750 y(read.)555 2003 y Fw(15.2)99 b(Recursion)26
b(on)f(Cdrs)555 2194 y FA(Sections)17 b(5.5)g(and)g(5.6)g(sho)n(wed)f
(ho)n(w)h(to)g(write)h(functions)e(that)h(b)n(uild)g(recursi)n(v)o(e)f
(functions.)555 2298 y(The)28 b(follo)n(wing)f(tw)o(o)h(sections)h(sho)
n(w)f(ho)n(w)g(anaphoric)e(macros)i(can)g(pro)o(vide)e(a)j(cleaner)555
2403 y(interf)o(ace)19 b(to)i(the)f(functions)f(we)h(de\002ned)f
(there.)680 2508 y(Section)e(5.5)g(sho)n(wed)f(ho)n(w)h(to)h(de\002ne)f
(a)h(\003at)g(list)h(recurser)d(b)n(uilder)h(called)g
Fs(lrec)p FA(.)27 b(W)m(ith)555 2612 y Fs(lrec)19 b FA(we)i(can)f(e)o
(xpress)f(a)i(call)f(to:)555 2795 y Fs(\(defun)41 b(our-every)f(\(fn)i
(lst\))642 2894 y(\(if)h(\(null)e(lst\))817 2994 y(t)817
3094 y(\(and)g(\(funcall)g(fn)h(\(car)g(lst\)\))1034
3193 y(\(our-every)e(fn)j(\(cdr)f(lst\)\)\)\)\))555 3381
y FA(for)20 b(e.g.)f Fs(oddp)g FA(as:)555 3564 y Fs(\(lrec)42
b(#'\(lambda)d(\(x)k(f\))g(\(and)f(\(oddp)f(x\))i(\(funcall)d(f\)\)\))
817 3663 y(t\))680 3851 y FA(Here)24 b(macros)g(could)f(mak)o(e)h(life)
h(easier)-5 b(.)43 b(Ho)n(w)24 b(much)g(do)g(we)h(really)f(ha)n(v)o(e)g
(to)h(say)f(to)555 3955 y(e)o(xpress)i(recursi)n(v)o(e)e(functions?)46
b(If)26 b(we)h(can)f(refer)f(anaphorically)f(to)j(the)f(current)f(car)h
(of)555 4060 y(the)20 b(list)g(\(as)g Fs(it)p FA(\))f(and)g(the)h
(recursi)n(v)o(e)e(call)i(\(as)g Fs(rec)p FA(\),)f(we)h(should)e(be)i
(able)f(to)h(mak)o(e)f(do)g(with)555 4165 y(something)g(lik)o(e:)555
4347 y Fs(\(alrec)41 b(\(and)h(\(oddp)g(it\))g(rec\))g(t\))555
4530 y FA(Figure)20 b(15.2)f(contains)g(the)h(de\002nition)f(of)h(the)g
(macro)g(which)f(will)i(allo)n(w)f(us)h(to)f(say)h(this.)555
4696 y Fs(>)43 b(\(funcall)d(\(alrec)i(\(and)f(\(oddp)h(it\))g(rec\))g
(t\))1034 4796 y('\(1)h(3)g(5\)\))555 4895 y(T)p eop
%%Page: 205 218
205 217 bop 555 538 a Ft(15.2)906 b Fu(RECURSION)18 b(ON)h(CDRS)889
b FA(205)p 555 745 2678 4 v 553 2864 4 2119 v 605 888
a Fs(\(defmacro)40 b(alrec)h(\(rec)h(&optional)e(base\))692
988 y("cltl2)h(version")692 1087 y(\(let)h(\(\(gfn)f(\(gensym\)\)\))779
1187 y(`\(lrec)g(#'\(lambda)f(\(it)i(,gfn\))1259 1287
y(\(symbol-macrole)o(t)c(\(\(rec)j(\(funcall)f(,gfn\)\)\))1346
1386 y(,rec\)\))1084 1486 y(,base\)\)\))605 1685 y(\(defmacro)g(alrec)h
(\(rec)h(&optional)e(base\))692 1785 y("cltl1)h(version")692
1884 y(\(let)h(\(\(gfn)f(\(gensym\)\)\))779 1984 y(`\(lrec)g
(#'\(lambda)f(\(it)i(,gfn\))1259 2084 y(\(labels)e(\(\(rec)i(\(\))h
(\(funcall)d(,gfn\)\)\))1346 2183 y(,rec\)\))1084 2283
y(,base\)\)\))605 2482 y(\(defmacro)g(on-cdrs)g(\(rec)i(base)g(&rest)g
(lsts\))692 2582 y(`\(funcall)e(\(alrec)h(,rec)h(#'\(lambda)e(\(\))j
(,base\)\))d(,@lsts\)\))1256 2786 y FA(Figure)20 b(15.2:)28
b(Macros)20 b(for)f(list)j(recursion.)p 3231 2864 V 555
2867 2678 4 v 680 3092 a(The)29 b(ne)n(w)h(macro)f(w)o(orks)h(by)f
(transforming)f(the)i(e)o(xpression)e(gi)n(v)o(en)h(as)h(the)g(second)
555 3196 y(ar)o(gument)22 b(into)h(a)i(function)d(to)i(be)g(passed)f
(to)h Fs(lrec)p FA(.)40 b(Since)24 b(the)f(second)g(ar)o(gument)f(may)
555 3301 y(refer)d(anaphorically)e(to)i Fs(it)g FA(or)h
Fs(rec)p FA(,)e(in)i(the)f(macro)g(e)o(xpansion)e(the)j(body)e(of)h
(the)g(function)555 3405 y(must)h(appear)f(within)h(the)g(scope)g(of)g
(bindings)f(established)h(for)f(these)i(symbols.)680
3510 y(Figure)k(15.2)f(actually)h(has)h(tw)o(o)g(dif)n(ferent)e(v)o
(ersions)h(of)h Fs(alrec)p FA(.)44 b(The)25 b(v)o(ersion)g(used)555
3615 y(in)h(the)g(preceding)f(e)o(xamples)g(requires)g(symbol)g(macros)
g(\(Section)h(7.11\).)45 b(Only)26 b(recent)555 3719
y(v)o(ersions)33 b(of)g(Common)f(Lisp)i(ha)n(v)o(e)f(symbol)f(macros,)k
(so)e(Figure)f(15.2)f(also)i(contains)555 3824 y(a)c(slightly)f(less)h
(con)m(v)o(enient)d(v)o(ersion)h(of)h Fs(alrec)f FA(in)i(which)e
Fs(rec)h FA(is)h(de\002ned)f(as)h(a)g(local)555 3929
y(function.)37 b(The)23 b(price)g(is)h(that,)g(as)g(a)g(function,)e
Fs(rec)g FA(w)o(ould)h(ha)n(v)o(e)g(to)g(be)g(enclosed)g(within)555
4033 y(parentheses:)555 4216 y Fs(\(alrec)41 b(\(and)h(\(oddp)g(it\))g
(\(rec\)\))f(t\))555 4403 y FA(The)13 b(original)g(v)o(ersion)g(is)g
(preferable)g(in)g(Commo)o(n)g(Lisp)f(implem)o(entatio)o(ns)h(which)f
(pro)n(vid)o(e)555 4508 y Fs(symbol-macrolet)p FA(.)680
4613 y(Common)18 b(Lisp,)i(with)h(its)g(separate)e(name\255space)g(for)
h(functions,)e(mak)o(es)i(it)h(a)o(wkw)o(ard)555 4717
y(to)f(use)h(these)f(recursion)f(b)n(uilders)g(to)i(de\002ne)e(named)h
(functions:)555 4900 y Fs(\(setf)42 b(\(symbol-functio)o(n)37
b('our-length\))817 4999 y(\(alrec)k(\(1+)h(rec\))g(0\)\))p
eop
%%Page: 206 219
206 218 bop 555 538 a FA(206)734 b Fu(MA)n(CR)n(OS)18
b(RETURNING)g(FUNCTIONS)p 555 745 2678 4 v 553 2167 4
1422 v 605 888 a Fs(\(defun)41 b(our-copy-list)d(\(lst\))692
988 y(\(on-cdrs)i(\(cons)i(it)h(rec\))e(nil)i(lst\)\))605
1187 y(\(defun)e(our-remove-dupli)o(ca)o(tes)c(\(lst\))692
1287 y(\(on-cdrs)j(\(adjoin)h(it)i(rec\))f(nil)g(lst\)\))605
1486 y(\(defun)f(our-find-if)e(\(fn)j(lst\))692 1586
y(\(on-cdrs)e(\(if)j(\(funcall)d(fn)j(it\))f(it)h(rec\))f(nil)g
(lst\)\))605 1785 y(\(defun)f(our-some)f(\(fn)j(lst\))692
1884 y(\(on-cdrs)d(\(or)j(\(funcall)d(fn)j(it\))f(rec\))g(nil)g
(lst\)\))882 2089 y FA(Figure)20 b(15.3:)28 b(Common)19
b(Lisp)h(functions)f(de\002ned)g(with)h Fs(on-cdrs)p
FA(.)p 3231 2167 V 555 2170 2678 4 v 555 2394 a(The)29
b(\002nal)h(macro)f(in)h(Figure)f(15.2)f(is)j(intended)d(to)i(mak)o(e)f
(this)h(more)f(abstract.)58 b(Using)555 2499 y Fs(on-cdrs)18
b FA(we)i(could)g(say)g(instead:)555 2682 y Fs(\(defun)41
b(our-length)f(\(lst\))642 2781 y(\(on-cdrs)g(\(1+)j(rec\))f(0)h
(lst\)\))555 2980 y(\(defun)e(our-every)f(\(fn)i(lst\))642
3080 y(\(on-cdrs)e(\(and)i(\(funcall)f(fn)h(it\))h(rec\))f(t)h(lst\)\))
680 3268 y FA(Figure)28 b(15.3)g(sho)n(ws)h(some)g(e)o(xisting)f
(Common)g(Lisp)h(functions)f(de\002ned)g(with)i(the)555
3372 y(ne)n(w)23 b(macro.)39 b(Expressed)23 b(with)h
Fs(on-cdrs)p FA(,)d(these)j(functions)f(are)g(reduced)f(to)i(their)g
(most)555 3477 y(basic)h(form,)f(and)g(we)g(notice)g(similarities)h
(between)f(them)g(which)f(might)h(not)g(otherwise)555
3581 y(ha)n(v)o(e)c(been)f(apparent.)680 3686 y(Figure)33
b(15.4)f(contains)i(some)f(ne)n(w)h(utilities)h(which)e(can)h(easily)g
(be)g(de\002ned)e(with)555 3791 y Fs(on-cdrs)p FA(.)42
b(The)24 b(\002rst)i(three,)g Fs(unions)p FA(,)e Fs(intersections)p
FA(,)e(and)i Fs(differences)d FA(imple\255)555 3895 y(ment)27
b(set)h(union,)f(intersection,)g(and)g(complement,)f(respecti)n(v)o
(ely)-5 b(.)48 b(Common)26 b(Lisp)h(has)555 4000 y(b)n(uilt\255in)22
b(functions)g(for)g(these)h(operations,)f(b)n(ut)h(the)o(y)f(can)h
(only)f(tak)o(e)h(tw)o(o)g(lists)i(at)e(a)h(time.)555
4105 y(Thus)c(if)g(we)h(w)o(ant)f(to)h(\002nd)e(the)i(union)e(of)g
(three)h(lists)i(we)e(ha)n(v)o(e)g(to)g(say:)555 4287
y Fs(>)43 b(\(union)e('\(a)i(b\))f(\(union)f('\(b)i(c\))g('\(c)f
(d\)\)\))555 4387 y(\(A)h(B)g(C)g(D\))555 4574 y FA(The)16
b(ne)n(w)g Fs(unions)f FA(beha)n(v)o(es)g(lik)o(e)i Fs(union)p
FA(,)f(b)n(ut)g(tak)o(es)h(an)f(arbitrary)f(number)g(of)h(ar)o
(guments,)555 4679 y(so)21 b(that)f(we)g(could)g(say:)555
4862 y Fs(>)43 b(\(unions)e('\(a)h(b\))h('\(b)f(c\))h('\(c)f(d\)\))555
4961 y(\(D)h(C)g(A)g(B\))p eop
%%Page: 207 220
207 219 bop 555 538 a Ft(15.2)906 b Fu(RECURSION)18 b(ON)h(CDRS)889
b FA(207)p 555 745 2678 4 v 553 2665 4 1920 v 605 888
a Fs(\(defun)41 b(unions)g(\(&rest)g(sets\))692 988 y(\(on-cdrs)f
(\(union)h(it)i(rec\))f(\(car)g(sets\))g(\(cdr)f(sets\)\)\))605
1187 y(\(defun)g(intersections)d(\(&rest)j(sets\))692
1287 y(\(unless)g(\(some)g(#'null)g(sets\))779 1386 y(\(on-cdrs)f
(\(intersection)f(it)j(rec\))g(\(car)g(sets\))g(\(cdr)g(sets\)\)\)\))
605 1586 y(\(defun)f(differences)e(\(set)j(&rest)f(outs\))692
1685 y(\(on-cdrs)f(\(set-difference)e(rec)k(it\))g(set)h(outs\)\))605
1884 y(\(defun)e(maxmin)g(\(args\))692 1984 y(\(when)h(args)779
2084 y(\(on-cdrs)e(\(multiple-value-b)o(ind)d(\(mx)42
b(mn\))g(rec)1259 2183 y(\(values)e(\(max)i(mx)h(it\))f(\(min)g(mn)h
(it\)\)\))1171 2283 y(\(values)e(\(car)h(args\))g(\(car)g(args\)\))1171
2383 y(\(cdr)g(args\)\)\)\))1073 2587 y FA(Figure)20
b(15.4:)28 b(Ne)n(w)21 b(utilities)g(de\002ned)e(with)h
Fs(on-cdrs)p FA(.)p 3231 2665 V 555 2668 2678 4 v 555
2884 a(Lik)o(e)c Fs(union)p FA(,)g Fs(unions)e FA(does)i(not)g(preserv)
o(e)f(the)i(order)e(of)h(the)h(elements)f(in)g(the)h(initial)f(lists.)
680 2989 y(The)23 b(same)i(relation)e(holds)h(between)f(the)i(Common)e
(Lisp)h Fs(intersection)c FA(and)k(the)555 3093 y(more)g(general)f
Fs(intersections)p FA(.)38 b(In)24 b(the)h(de\002nition)f(of)g(this)h
(function,)f(the)h(initial)g(test)555 3198 y(for)g(null)h(ar)o(guments)
d(w)o(as)k(added)e(for)g(ef)n(\002cienc)o(y;)i(it)g(short\255circuits)d
(the)i(computation)d(if)555 3303 y(one)d(of)g(the)g(sets)h(is)g(empty)
-5 b(.)680 3407 y(Common)20 b(Lisp)h(also)h(has)g(a)f(function)f
(called)h Fs(set-difference)p FA(,)c(which)k(tak)o(es)g(tw)o(o)555
3512 y(lists)h(and)d(returns)h(the)g(elements)g(of)g(the)g(\002rst)h
(which)e(are)h(not)g(in)h(the)f(second:)555 3684 y Fs(>)43
b(\(set-difference)38 b('\(a)k(b)h(c)g(d\))g('\(a)f(c\)\))555
3784 y(\(D)h(B\))555 3961 y FA(Our)34 b(ne)n(w)f(v)o(ersion)g(handles)g
(multiple)h(ar)o(guments)e(much)h(as)h Fs(-)g FA(does.)71
b(F)o(or)33 b(e)o(xample,)555 4065 y Fs(\(differences)39
b(x)k(y)g(z\))12 b FA(is)g(equi)n(v)n(alent)g(to)g Fs(\(set-differen)o
(ce)37 b(x)43 b(\(unions)e(y)i(z\)\))p FA(,)555 4170
y(though)18 b(without)i(the)g(consing)f(that)h(the)h(latter)f(w)o(ould)
f(entail.)555 4342 y Fs(>)43 b(\(differences)c('\(a)j(b)h(c)g(d)h(e\))e
('\(a)h(f\))g('\(d\)\))555 4442 y(\(B)g(C)g(E\))680 4619
y FA(These)22 b(set)h(operators)e(are)i(intended)e(only)g(as)j(e)o
(xamples.)35 b(There)21 b(is)j(no)e(real)g(need)g(for)555
4724 y(them,)i(because)e(the)o(y)h(represent)f(a)i(de)o(generate)d
(case)j(of)f(list)i(recursion)d(already)g(handled)555
4828 y(by)e(the)g(b)n(uilt\255in)g Fs(reduce)p FA(.)27
b(F)o(or)20 b(e)o(xample,)e(instead)i(of)555 5001 y Fs(\(unions)41
b(...\))p eop
%%Page: 208 221
208 220 bop 555 538 a FA(208)734 b Fu(MA)n(CR)n(OS)18
b(RETURNING)g(FUNCTIONS)555 801 y FA(you)h(might)h(as)h(well)f(say)h
(just)555 983 y Fs(\(\(lambda)40 b(\(&rest)h(args\))h(\(reduce)f
(#'union)f(args\)\))h(...\))555 1171 y FA(In)20 b(the)g(general)f
(case,)i Fs(on-cdrs)c FA(is)22 b(more)d(po)n(werful)f(than)i
Fs(reduce)p FA(,)e(ho)n(we)n(v)o(er)-5 b(.)680 1276 y(Because)20
b Fs(rec)g FA(refers)f(to)i(a)f(call)h(instead)f(of)g(a)h(v)n(alue,)e
(we)i(can)f(use)g Fs(on-cdrs)e FA(to)j(create)555 1380
y(functions)13 b(which)i(return)f(multiple)g(v)n(alues.)27
b(The)15 b(\002nal)g(function)e(in)i(Figure)f(15.4,)h
Fs(maxmin)p FA(,)555 1485 y(tak)o(es)25 b(adv)n(antage)d(of)i(this)h
(possibility)f(to)g(\002nd)g(both)g(the)g(maximum)f(and)h(minimum)f
(ele\255)555 1589 y(ments)d(in)g(a)h(single)f(tra)n(v)o(ersal)g(of)g(a)
g(list:)555 1772 y Fs(>)43 b(\(maxmin)e('\(3)h(4)h(2)h(8)f(5)g(1)g(6)g
(7\)\))555 1872 y(8)555 1971 y(1)680 2159 y FA(It)23
b(w)o(ould)g(also)h(ha)n(v)o(e)f(been)f(possible)h(to)h(use)g
Fs(on-cdrs)d FA(in)i(some)h(of)f(the)g(code)g(which)555
2263 y(appears)c(in)i(later)f(chapters.)28 b(F)o(or)20
b(e)o(xample,)f Fs(compile-cmds)c FA(\(page)20 b(310\))555
2446 y Fs(\(defun)41 b(compile-cmds)e(\(cmds\))642 2546
y(\(if)k(\(null)e(cmds\))817 2645 y('regs)817 2745 y(`\(,@\(car)f
(cmds\))h(,\(compile-cmds)d(\(cdr)k(cmds\)\)\)\)\))555
2933 y FA(could)19 b(ha)n(v)o(e)h(been)f(de\002ned)h(as)g(simply:)555
3115 y Fs(\(defun)41 b(compile-cmds)e(\(cmds\))642 3215
y(\(on-cdrs)h(`\(,@it)i(,rec\))f('regs)h(cmds\)\))555
3468 y Fw(15.3)99 b(Recursion)26 b(on)f(Subtr)n(ees)555
3658 y FA(What)i(macros)e(did)h(for)g(recursion)e(on)i(lists,)j(the)o
(y)c(can)h(also)h(do)f(for)f(recursion)g(on)h(trees.)555
3763 y(In)i(this)g(section,)i(we)e(use)g(macros)g(to)g(de\002ne)f
(cleaner)h(interf)o(aces)f(to)h(the)g(tree)g(recursers)555
3867 y(de\002ned)19 b(in)i(Section)e(5.6.)680 3972 y(In)14
b(Section)g(5.6)g(we)g(de\002ned)g(tw)o(o)f(tree)g(recu)o(rsion)g(b)m
(uilder)o(s,)d Fs(ttrav)p FA(,)i(which)i(al)o(w)o(ays)g(tra\255)555
4077 y(v)o(erses)k(the)f(whole)g(tree,)h(and)g Fs(trec)e
FA(which)i(is)g(more)f(comple)o(x,)f(b)n(ut)i(allo)n(ws)g(you)f(to)h
(control)555 4181 y(when)i(recursion)e(stops.)30 b(Using)20
b(these)g(functions)f(we)h(could)g(e)o(xpress)f Fs(our-copy-tree)555
4364 y(\(defun)41 b(our-copy-tree)d(\(tree\))642 4464
y(\(if)43 b(\(atom)e(tree\))817 4563 y(tree)817 4663
y(\(cons)g(\(our-copy-tree)d(\(car)k(tree\)\))1078 4762
y(\(if)g(\(cdr)g(tree\))g(\(our-copy-tree)c(\(cdr)k(tree\)\)\)\)\)\))
555 4950 y FA(as)p eop
%%Page: 209 222
209 221 bop 555 538 a Ft(15.4)835 b Fu(RECURSION)18 b(ON)h(SUBTREES)816
b FA(209)555 801 y Fs(\(ttrav)41 b(#'cons\))555 983 y
FA(and)20 b(a)g(call)h(to)f Fs(rfind-if)555 1160 y(\(defun)41
b(rfind-if)f(\(fn)j(tree\))642 1260 y(\(if)g(\(atom)e(tree\))817
1359 y(\(and)g(\(funcall)g(fn)h(tree\))g(tree\))817 1459
y(\(or)g(\(rfind-if)e(fn)i(\(car)g(tree\)\))991 1559
y(\(and)g(\(cdr)g(tree\))f(\(rfind-if)f(fn)j(\(cdr)f(tree\)\)\)\)\)\))
555 1741 y FA(for)20 b(e.g.)f Fs(oddp)g FA(as:)555 1918
y Fs(\(trec)42 b(#'\(lambda)d(\(o)k(l)g(r\))g(\(or)f(\(funcall)f(l\))h
(\(funcall)f(r\)\)\))817 2018 y(#'\(lambda)e(\(tree\))i(\(and)h(\(oddp)
g(tree\))f(tree\)\)\))680 2200 y FA(Anaphoric)15 b(macros)h(can)h(mak)o
(e)g(a)g(better)g(interf)o(ace)f(to)h Fs(trec)p FA(,)g(as)h(the)o(y)e
(did)h(for)f Fs(lrec)g FA(in)555 2304 y(the)21 b(pre)n(vious)f
(section.)33 b(A)22 b(macro)e(suf)n(\002cient)h(for)g(the)h(general)e
(case)i(will)g(ha)n(v)o(e)f(to)g(be)h(able)555 2409 y(to)27
b(refer)f(anaphorically)e(to)i(three)g(things:)42 b(the)27
b(current)e(tree,)j(which)e(we')o(ll)h(call)g Fs(it)p
FA(,)h(the)555 2514 y(recursion)c(do)n(wn)h(the)h(left)g(subtree,)h
(which)e(we')o(ll)h(call)h Fs(left)p FA(,)f(and)f(the)h(recursion)f(do)
n(wn)555 2618 y(the)18 b(right)g(subtree,)g(which)f(we')o(ll)i(call)g
Fs(right)p FA(.)27 b(W)m(ith)18 b(these)h(con)m(v)o(entions)c
(established,)j(we)555 2723 y(should)h(be)h(able)g(to)h(e)o(xpress)e
(the)h(preceding)f(functions)f(in)j(terms)f(of)g(a)g(ne)n(w)g(macro)g
(thus:)555 2900 y Fs(\(atrec)41 b(\(cons)h(left)g(right\)\))555
3099 y(\(atrec)f(\(or)h(left)g(right\))f(\(and)h(\(oddp)g(it\))g
(it\)\))555 3281 y FA(Figure)20 b(15.5)f(contains)g(the)h(de\002nition)
f(of)h(this)h(macro.)680 3386 y(In)13 b(v)o(ersions)g(of)h(Lisp)g
(which)g(don')o(t)e(ha)n(v)o(e)h Fs(symbol-macrolet)p
FA(,)d(we)k(can)g(de\002ne)f Fs(atrec)555 3491 y FA(using)20
b(the)h(second)g(de\002nition)e(in)j(Figure)e(15.5.)30
b(This)21 b(v)o(ersion)f(de\002nes)h Fs(left)f FA(and)g
Fs(right)555 3595 y FA(as)h(local)f(functions,)f(so)h
Fs(our-copy-tree)c FA(w)o(ould)j(ha)n(v)o(e)h(to)g(be)g(e)o(xpressed)f
(as:)555 3772 y Fs(\(atrec)41 b(\(cons)h(\(left\))f(\(right\)\)\))680
3955 y FA(F)o(or)26 b(con)m(v)o(enience,)g(we)h(also)h(de\002ne)f(a)g
(macro)f Fs(on-trees)p FA(,)g(which)h(is)h(analogous)d(to)555
4059 y Fs(on-cdrs)e FA(from)h(the)h(pre)n(vious)e(section.)43
b(Figure)24 b(15.6)g(sho)n(ws)h(the)g(four)f(functions)g(from)555
4164 y(Section)c(5.6)f(de\002ned)h(with)g Fs(on-trees)p
FA(.)680 4268 y(As)27 b(noted)f(in)g(Chapter)g(5,)i(functions)e(b)n
(uilt)g(by)h(the)f(recurser)g(generators)f(de\002ned)g(in)555
4373 y(that)g(chapter)e(will)j(not)e(be)h(tail\255recursi)n(v)o(e.)41
b(Using)24 b Fs(on-cdrs)f FA(or)h Fs(on-trees)e FA(to)j(de\002ne)f(a)
555 4478 y(function)i(will)j(not)f(necessarily)f(yield)h(the)g(most)g
(ef)n(\002cient)f(implementation.)51 b(Lik)o(e)28 b(the)555
4582 y(underlying)19 b Fs(trec)h FA(and)h Fs(lrec)p FA(,)f(these)i
(macros)f(are)g(mainly)g(for)g(use)g(in)h(prototypes)e(and)g(in)555
4687 y(parts)k(of)h(a)g(program)d(where)i(ef)n(\002cienc)o(y)f(is)i
(not)g(paramount.)39 b(Ho)n(we)n(v)o(er)m(,)24 b(the)g(underlying)555
4791 y(idea)h(of)g(this)h(chapter)e(and)h(Chapter)f(5)i(is)g(that)f
(one)g(can)g(write)g(function)f(generators)f(and)555
4896 y(put)f(a)g(clean)g(macro)g(interf)o(ace)f(on)h(them.)34
b(This)23 b(same)f(technique)f(could)g(equally)g(well)i(be)555
5001 y(used)d(to)g(b)n(uild)g(function)f(generators)f(which)i(yielded)f
(particularly)f(ef)n(\002cient)i(code.)p eop
%%Page: 210 223
210 222 bop 555 538 a FA(210)734 b Fu(MA)n(CR)n(OS)18
b(RETURNING)g(FUNCTIONS)p 555 758 2678 4 v 553 3076 4
2319 v 605 901 a Fs(\(defmacro)40 b(atrec)h(\(rec)h(&optional)e(\(base)
i('it\)\))692 1000 y("cltl2)f(version")692 1100 y(\(let)h(\(\(lfn)f
(\(gensym\)\))f(\(rfn)i(\(gensym\)\)\))779 1199 y(`\(trec)f(#'\(lambda)
f(\(it)i(,lfn)g(,rfn\))1259 1299 y(\(symbol-macrole)o(t)c(\(\(left)j
(\(funcall)f(,lfn\)\))2043 1399 y(\(right)h(\(funcall)g(,rfn\)\)\))1346
1498 y(,rec\)\))1084 1598 y(#'\(lambda)f(\(it\))i(,base\)\)\)\))605
1797 y(\(defmacro)e(atrec)h(\(rec)h(&optional)e(\(base)i('it\)\))692
1897 y("cltl1)f(version")692 1996 y(\(let)h(\(\(lfn)f(\(gensym\)\))f
(\(rfn)i(\(gensym\)\)\))779 2096 y(`\(trec)f(#'\(lambda)f(\(it)i(,lfn)g
(,rfn\))1259 2196 y(\(labels)e(\(\(left)h(\(\))i(\(funcall)d(,lfn\)\))
1651 2295 y(\(right)h(\(\))i(\(funcall)d(,rfn\)\)\))1346
2395 y(,rec\)\))1084 2495 y(#'\(lambda)g(\(it\))i(,base\)\)\)\))605
2694 y(\(defmacro)e(on-trees)g(\(rec)i(base)g(&rest)f(trees\))692
2794 y(`\(funcall)f(\(atrec)h(,rec)h(,base\))f(,@trees\)\))1177
2998 y FA(Figure)19 b(15.5:)28 b(Macros)20 b(for)g(recursion)e(on)i
(trees.)p 3231 3076 V 555 3079 2678 4 v 555 3281 V 553
4902 4 1621 v 605 3424 a Fs(\(defun)41 b(our-copy-tree)d(\(tree\))692
3524 y(\(on-trees)i(\(cons)h(left)h(right\))f(it)i(tree\)\))605
3723 y(\(defun)e(count-leaves)e(\(tree\))692 3823 y(\(on-trees)h(\(+)j
(left)f(\(or)g(right)f(1\)\))i(1)g(tree\)\))605 4022
y(\(defun)e(flatten)g(\(tree\))692 4121 y(\(on-trees)f(\(nconc)h(left)h
(right\))f(\(mklist)g(it\))h(tree\)\))605 4321 y(\(defun)f(rfind-if)f
(\(fn)j(tree\))692 4420 y(\(on-trees)d(\(or)i(left)g(right\))1128
4520 y(\(and)g(\(funcall)e(fn)j(it\))f(it\))1128 4620
y(tree\)\))1084 4824 y FA(Figure)19 b(15.6:)29 b(Functions)19
b(de\002ned)g(using)h Fs(on-trees)p FA(.)p 3231 4902
V 555 4905 2678 4 v eop
%%Page: 211 224
211 223 bop 555 538 a Ft(15.4)941 b Fu(LAZY)18 b(EV)-8
b(ALU)n(A)h(TION)922 b FA(211)p 555 745 2678 4 v 553
2865 4 2120 v 605 888 a Fs(\(defconstant)38 b(unforced)j(\(gensym\)\))
605 1087 y(\(defstruct)e(delay)85 b(forced)41 b(closure\))605
1287 y(\(defmacro)f(delay)h(\(expr\))692 1386 y(\(let)h(\(\(self)f
(\(gensym\)\)\))779 1486 y(`\(let)h(\(\(,self)e(\(make-delay)f(:forced)
i(unforced\)\)\))910 1586 y(\(setf)g(\(delay-closure)d(,self\))1171
1685 y(#'\(lambda)i(\(\))1346 1785 y(\(setf)h(\(delay-forced)e(,self\))
i(,expr\)\)\))910 1884 y(,self\)\)\))605 2084 y(\(defun)g(force)g
(\(x\))692 2183 y(\(if)h(\(delay-p)f(x\))866 2283 y(\(if)i(\(eq)f
(\(delay-forced)c(x\))43 b(unforced\))1041 2383 y(\(funcall)d
(\(delay-closure)e(x\)\))1041 2482 y(\(delay-forced)g(x\)\))866
2582 y(x\)\))1048 2786 y FA(Figure)20 b(15.7:)28 b(Implementation)18
b(of)i Fs(force)e FA(and)i Fs(delay)p FA(.)p 3231 2865
V 555 2868 2678 4 v 555 3092 a Fw(15.4)99 b(Lazy)25 b(Ev)o(aluation)555
3283 y Ft(Lazy)j(e)o(valuation)d FA(means)i(only)g(e)n(v)n(aluating)e
(an)i(e)o(xpression)f(when)h(you)f(need)h(its)h(v)n(alue.)555
3387 y(One)20 b(w)o(ay)g(to)g(use)g(lazy)g(e)n(v)n(aluation)e(is)j(to)f
(b)n(uild)g(an)g(object)f(kno)n(wn)f(as)j(a)f Ft(delay)p
FA(.)29 b(A)20 b(delay)g(is)555 3492 y(a)h(placeholder)d(for)i(the)g(v)
n(alue)g(of)g(some)g(e)o(xpression.)29 b(It)20 b(represents)g(a)h
(promise)e(to)i(deli)n(v)o(er)555 3596 y(the)k(v)n(alue)f(of)h(the)g(e)
o(xpression)e(if)j(it)g(is)f(needed)f(at)i(some)e(later)i(time.)43
b(Meanwhile,)25 b(since)555 3701 y(the)k(promise)f(is)i(a)f(Lisp)g
(object,)h(it)g(can)f(serv)o(e)f(man)o(y)g(of)h(the)f(purposes)g(of)h
(the)g(v)n(alue)f(it)555 3806 y(represents.)j(And)21
b(when)g(the)g(v)n(alue)g(of)g(the)g(e)o(xpression)f(is)i(needed,)e
(the)h(delay)g(can)g(return)555 3910 y(it.)680 4015 y(Scheme)28
b(has)i(b)n(uilt\255in)f(support)f(for)g(delays.)57 b(The)29
b(Scheme)f(operators)g Fs(force)g FA(and)555 4119 y Fs(delay)34
b FA(can)h(be)g(implemented)f(in)h(Common)f(Lisp)i(as)g(in)g(Figure)e
(15.7.)74 b(A)36 b(delay)f(is)555 4224 y(represented)17
b(as)j(a)f(tw)o(o\255part)f(structure.)28 b(The)19 b(\002rst)g(\002eld)
g(indicates)g(whether)f(the)h(delay)f(has)555 4329 y(been)k(e)n(v)n
(aluated)g(yet,)h(and)g(if)g(it)h(has,)g(contains)e(the)h(v)n(alue.)37
b(The)23 b(second)f(\002eld)h(contains)f(a)555 4433 y(closure)c(which)g
(can)g(be)h(called)f(to)h(\002nd)f(the)h(v)n(alue)e(that)i(the)g(delay)
f(represents.)27 b(The)19 b(macro)555 4538 y Fs(delay)g
FA(tak)o(es)h(an)g(e)o(xpression,)f(and)g(returns)h(a)g(delay)g
(representing)e(its)j(v)n(alue:)555 4720 y Fs(>)43 b(\(let)f(\(\(x)g
(2\)\))729 4820 y(\(setq)g(d)h(\(delay)e(\(1+)h(x\)\)\)\))555
4920 y(#S\(DELAY)e(...\))p eop
%%Page: 212 225
212 224 bop 555 538 a FA(212)734 b Fu(MA)n(CR)n(OS)18
b(RETURNING)g(FUNCTIONS)680 801 y FA(T)-7 b(o)25 b(call)g(the)g
(closure)g(within)f(a)i(delay)e(is)i(to)f Ft(for)m(ce)g
FA(the)g(delay)-5 b(.)43 b(The)25 b(function)e Fs(force)555
905 y FA(tak)o(es)g(an)o(y)g(object:)34 b(for)23 b(ordinary)e(objects)i
(it)g(is)h(the)f(identity)g(function,)f(b)n(ut)h(for)f(delays)h(it)555
1010 y(is)e(a)g(demand)d(for)i(the)g(v)n(alue)g(that)g(the)g(delay)g
(represents.)555 1193 y Fs(>)43 b(\(force)e('a\))555
1292 y(A)555 1392 y(>)i(\(force)e(d\))555 1491 y(3)555
1679 y FA(W)-7 b(e)27 b(use)e Fs(force)g FA(whene)n(v)o(er)e(we)j(are)f
(dealing)g(with)h(objects)f(that)h(might)f(be)g(delays.)45
b(F)o(or)555 1784 y(e)o(xample,)19 b(if)h(we)h(are)f(sorting)f(a)i
(list)g(which)f(might)f(contain)g(delays,)h(we)h(w)o(ould)e(say:)555
1966 y Fs(\(sort)42 b(lst)g(#'\(lambda)e(\(x)i(y\))h(\(>)g(\(force)e
(x\))i(\(force)e(y\)\)\)\))680 2154 y FA(It')-5 b(s)15
b(slightly)f(incon)m(v)o(enient)d(to)k(use)g(delays)f(in)h(this)g(nak)o
(ed)e(form.)27 b(In)14 b(a)h(real)f(application,)555
2259 y(the)o(y)19 b(might)h(be)g(hidden)f(beneath)g(another)g(layer)g
(of)h(abstraction.)p eop
%%Page: 213 226
213 225 bop 555 1610 a Fn(16)p 555 1872 2686 3 v 555
2131 a Fx(Macr)m(o\255De\002ning)42 b(Macr)m(os)555 2568
y FA(P)o(atterns)18 b(in)h(code)e(often)h(signal)g(the)g(need)g(for)f
(ne)n(w)h(abstractions.)28 b(This)18 b(rule)g(holds)g(just)h(as)555
2672 y(much)j(for)h(the)g(code)g(in)h(macros)e(themselv)o(es.)38
b(When)23 b(se)n(v)o(eral)g(macros)g(ha)n(v)o(e)f(de\002nitions)555
2777 y(of)27 b(a)h(similar)f(form,)h(we)f(may)g(be)g(able)g(to)h(write)
f(a)h(macro\255de\002ning)c(macro)i(to)i(produce)555
2882 y(them.)53 b(This)29 b(chapter)e(presents)h(three)g(e)o(xamples)f
(of)h(macro\255de\002ning)d(macros:)46 b(one)27 b(to)555
2986 y(de\002ne)20 b(abbre)n(viations,)d(one)j(to)g(de\002ne)g(access)g
(macros,)f(and)h(a)g(third)g(to)g(de\002ne)g(anaphoric)555
3091 y(macros)g(of)f(the)i(type)e(described)g(in)i(Section)e(14.1.)555
3344 y Fw(16.1)99 b(Ab)o(br)n(e)o(viations)555 3534 y
FA(The)26 b(simplest)g(use)h(of)e(macros)h(is)h(as)g(abbre)n(viations.)
44 b(Some)26 b(Common)f(Lisp)h(operators)555 3639 y(ha)n(v)o(e)k
(rather)f(long)g(names.)59 b(Ranking)29 b(high)h(among)e(them)i
(\(though)e(by)i(no)g(means)g(the)555 3743 y(longest\))35
b(is)i Fs(destructuring-bi)o(nd)p FA(,)d(which)h(has)i(18)e
(characters.)76 b(A)37 b(corollary)d(of)57 b Fq(\016)555
3848 y FA(Steele')-5 b(s)23 b(principle)d(\(page)h(43\))f(is)j(that)f
(commonly)d(used)j(operators)e(ought)g(to)i(ha)n(v)o(e)f(short)555
3953 y(names.)48 b(\(\223W)-7 b(e)27 b(think)f(of)g(addition)g(as)h
(cheap)f(partly)g(because)g(we)h(can)f(notate)g(it)h(with)g(a)555
4057 y(single)d(character:)37 b(`+'.)-6 b(\224\))41 b(The)24
b(b)n(uilt\255in)g Fs(destructuring-bin)o(d)19 b FA(macro)k(introduces)
g(a)555 4162 y(ne)n(w)17 b(layer)f(of)h(abstraction,)f(b)n(ut)h(the)g
(actual)g(gain)f(in)h(bre)n(vity)f(is)i(mask)o(ed)e(by)h(its)h(long)e
(name:)555 4344 y Fs(\(let)42 b(\(\(a)g(\(car)g(x\)\))h(\(b)f(\(cdr)g
(x\)\)\))g(...\))555 4544 y(\(destructuring-b)o(ind)37
b(\(a)42 b(.)i(b\))e(x)i(...\))555 4731 y FA(A)17 b(program,)d(lik)o(e)
j(printed)d(te)o(xt,)j(is)g(easiest)g(to)f(read)g(when)g(it)g(contains)
g(no)g(more)f(than)h(about)555 4836 y(70)j(characters)f(per)h(line.)29
b(W)-7 b(e)21 b(be)o(gin)d(at)i(a)g(disadv)n(antage)d(when)i(the)g
(lengths)g(of)g(indi)n(vidual)555 4941 y(names)h(are)g(a)h(quarter)d
(of)i(that.)1835 5229 y(213)p eop
%%Page: 214 227
214 226 bop 555 538 a FA(214)823 b Fu(MA)n(CR)n(O)p Fv(\255)p
Fu(DEFINING)18 b(MA)n(CR)n(OS)p 555 745 2678 4 v 553
1968 4 1223 v 605 888 a Fs(\(defmacro)40 b(abbrev)h(\(short)g(long\))
692 988 y(`\(defmacro)e(,short)j(\(&rest)f(args\))823
1087 y(`\(,',long)f(,@args\)\)\))605 1287 y(\(defmacro)g(abbrevs)g
(\(&rest)h(names\))692 1386 y(`\(progn)823 1486 y(,@\(mapcar)f
(#'\(lambda)f(\(pair\))1433 1586 y(`\(abbrev)h(,@pair\)\))1259
1685 y(\(group)h(names)g(2\)\)\)\))1043 1889 y FA(Figure)19
b(16.1:)28 b(Automatic)20 b(de\002nition)f(of)h(abbre)n(viations.)p
3231 1968 V 555 1971 2678 4 v 680 2195 a(F)o(ortunately)-5
b(,)13 b(in)h(a)h(language)e(lik)o(e)i(Lisp)f(you)g(don')o(t)f(ha)n(v)o
(e)h(to)g(li)n(v)o(e)h(with)f(all)h(the)g(decisions)555
2300 y(of)20 b(the)g(designers.)28 b(Ha)n(ving)20 b(de\002ned)555
2482 y Fs(\(defmacro)40 b(dbind)h(\(&rest)g(args\))642
2582 y(`\(destructuring-b)o(in)o(d)c(,@args\)\))555 2770
y FA(you)21 b(need)g(ne)n(v)o(er)f(use)i(the)g(long)f(name)g(again.)33
b(Lik)o(e)n(wise)22 b(for)f Fs(multiple-value-b)o(ind)o
FA(,)555 2874 y(which)f(is)h(longer)e(and)g(more)h(frequently)e(used.)
555 3057 y Fs(\(defmacro)40 b(mvbind)h(\(&rest)g(args\))642
3156 y(`\(multiple-value-)o(bi)o(nd)c(,@args\)\))555
3344 y FA(Notice)28 b(ho)n(w)g(nearly)f(identical)g(are)h(the)g
(de\002nitions)g(of)f Fs(dbind)g FA(and)g Fs(mvbind)p
FA(.)51 b(Indeed,)555 3449 y(this)18 b(formula)f(of)g
Fs(&rest)g FA(and)g(comma\255at)g(will)h(suf)n(\002ce)g(to)g(de\002ne)g
(an)g(abbre)n(viation)d(for)i(an)o(y)555 3553 y(function,)855
3523 y Fm(1)908 3553 y FA(macro,)k(or)g(special)h(form.)33
b(Why)21 b(crank)g(out)g(more)g(de\002nitions)g(on)g(the)g(model)555
3658 y(of)f Fs(mvbind)e FA(when)i(we)g(could)g(ha)n(v)o(e)f(a)i(macro)e
(do)h(it)h(for)e(us?)680 3762 y(T)-7 b(o)35 b(de\002ne)g(a)h
(macro\255de\002ning)c(macro)j(we)h(will)g(often)f(need)g(nested)g
(backquotes.)555 3867 y(Nested)18 b(backquotes)f(are)h(notoriously)e
(hard)h(to)i(understand.)26 b(Ev)o(entually)16 b(common)h(cases)555
3972 y(will)22 b(become)f(f)o(amiliar)m(,)g(b)n(ut)g(one)g(should)g
(not)g(e)o(xpect)g(to)h(be)f(able)h(to)g(look)e(at)j(an)e(arbitrary)555
4076 y(backquoted)26 b(e)o(xpression)g(and)i(say)g(what)g(it)h(will)g
(yield.)53 b(It)29 b(is)g(not)f(a)h(f)o(ault)f(in)g(Lisp)g(that)555
4181 y(this)g(is)h(so,)h(an)o(y)d(more)g(than)h(it)g(is)h(a)f(f)o(ault)
g(of)g(the)g(notation)e(that)i(one)g(can')o(t)f(just)h(look)f(at)555
4286 y(a)f(complicated)e(inte)o(gral)h(and)g(kno)n(w)g(what)h(its)g(v)n
(alue)g(will)g(be.)46 b(The)25 b(dif)n(\002culty)g(is)i(in)f(the)555
4390 y(problem,)18 b(not)i(the)g(notation.)680 4495 y(Ho)n(we)n(v)o(er)
m(,)26 b(as)h(we)g(do)f(when)g(\002nding)g(inte)o(grals,)h(we)g(can)g
(break)e(up)h(the)h(analysis)g(of)555 4599 y(backquotes)22
b(into)i(small)g(steps,)h(each)f(of)g(which)f(can)h(easily)g(be)g
(follo)n(wed.)39 b(Suppose)23 b(we)555 4704 y(w)o(ant)31
b(to)g(write)g(a)g(macro)f Fs(abbrev)p FA(,)h(which)g(will)g(allo)n(w)g
(us)g(to)g(de\002ne)g Fs(mvbind)e FA(just)i(by)555 4809
y(saying)p 555 4880 1074 4 v 645 4936 a Fl(1)675 4959
y Fr(Though)17 b(the)h(abbre)n(viation)j(can')o(t)d(be)f(passed)h(to)f
Fk(apply)h Fr(or)f Fk(funcall)p Fr(.)p eop
%%Page: 215 228
215 227 bop 555 538 a Ft(16.2)978 b Fu(ABBREVIA)-7 b(TIONS)960
b FA(215)555 801 y Fs(\(abbrev)41 b(mvbind)g(multiple-value-b)o(in)o
(d\))555 988 y FA(Figure)26 b(16.1)f(contains)h(a)g(de\002nition)g(of)g
(this)g(macro.)47 b(Where)26 b(did)g(it)h(come)f(from?)47
b(The)555 1093 y(de\002nition)13 b(of)g(such)g(a)h(macro)f(can)h(be)f
(deri)n(v)o(ed)f(from)h(a)h(sample)f(e)o(xpansion.)25
b(One)14 b(e)o(xpansion)555 1197 y(is:)555 1380 y Fs(\(defmacro)40
b(mvbind)h(\(&rest)g(args\))642 1480 y(`\(multiple-value-)o(bi)o(nd)c
(,@args\)\))555 1667 y FA(The)21 b(deri)n(v)n(ation)f(will)i(be)f
(easier)h(if)g(we)g(pull)f Fs(multiple-value-b)o(in)o(d)16
b FA(from)k(within)i(the)555 1772 y(backquote,)f(because)h(we)h(kno)n
(w)f(it)h(will)g(be)g(an)g(ar)o(gument)d(to)j(the)g(e)n(v)o(entual)e
(macro.)35 b(This)555 1877 y(yields)20 b(the)g(equi)n(v)n(alent)f
(de\002nition)555 2059 y Fs(\(defmacro)40 b(mvbind)h(\(&rest)g(args\))
642 2159 y(\(let)h(\(\(name)f('multiple-value-b)o(in)o(d\)\))729
2259 y(`\(,name)g(,@args\)\)\))555 2446 y FA(No)n(w)26
b(we)g(tak)o(e)f(this)i(e)o(xpression)d(and)h(turn)g(it)h(into)g(a)g
(template.)45 b(W)-7 b(e)27 b(af)n(\002x)e(a)h(backquote,)555
2551 y(and)20 b(replace)f(the)h(e)o(xpressions)f(which)h(will)h(v)n
(ary)-5 b(,)18 b(with)j(v)n(ariables.)555 2733 y Fs(`\(defmacro)39
b(,short)j(\(&rest)f(args\))686 2833 y(\(let)h(\(\(name)f(',long\)\))
773 2933 y(`\(,name)g(,@args\)\)\))555 3120 y FA(The)14
b(\002nal)g(step)g(is)h(to)f(simplify)f(this)i(e)o(xpression)d(by)i
(substituting)f Fs(',long)f FA(for)h Fs(name)g FA(within)555
3225 y(the)20 b(inner)g(backquote:)555 3408 y Fs(`\(defmacro)39
b(,short)j(\(&rest)f(args\))686 3507 y(`\(,',long)f(,@args\)\))555
3695 y FA(which)20 b(yields)g(the)g(body)f(of)h(the)g(macro)f
(de\002ned)g(in)i(Figure)e(16.1.)680 3799 y(Figure)e(16.1)h(also)h
(contains)f Fs(abbrevs)p FA(,)e(for)i(cases)i(where)e(we)h(w)o(ant)f
(to)h(de\002ne)f(se)n(v)o(eral)555 3904 y(abbre)n(viations)g(in)i(one)g
(shot.)555 4087 y Fs(\(abbrevs)40 b(dbind)85 b(destructuring-bin)o(d)
947 4186 y(mvbind)41 b(multiple-value-bi)o(nd)947 4286
y(mvsetq)g(multiple-value-se)o(tq\))555 4474 y FA(The)g(user)f(of)h
Fs(abbrevs)e FA(doesn')o(t)g(ha)n(v)o(e)i(to)g(insert)g(additional)e
(parentheses)h(because)555 4578 y Fs(abbrevs)32 b FA(calls)j
Fs(group)e FA(\(page)h(47\))f(to)i(group)d(its)k(ar)o(guments)c(by)i
(tw)o(os.)73 b(It')-5 b(s)35 b(gener)n(\255)555 4683
y(ally)e(a)g(good)f(thing)g(for)g(macros)g(to)h(sa)n(v)o(e)g(users)g
(from)f(typing)f(logically)h(unnecessary)555 4787 y(parentheses,)19
b(and)g Fs(group)g FA(will)i(be)f(useful)g(to)g(most)g(such)g(macros.)p
eop
%%Page: 216 229
216 228 bop 555 538 a FA(216)823 b Fu(MA)n(CR)n(O)p Fv(\255)p
Fu(DEFINING)18 b(MA)n(CR)n(OS)p 555 745 2678 4 v 553
1868 4 1123 v 605 888 a Fs(\(defmacro)40 b(propmacro)g(\(propname\))692
988 y(`\(defmacro)f(,propname)h(\(obj\))823 1087 y(`\(get)h(,obj)h
(',',propname\)\)\))605 1287 y(\(defmacro)e(propmacros)f(\(&rest)i
(props\))692 1386 y(`\(progn)823 1486 y(,@\(mapcar)f(#'\(lambda)f
(\(p\))k(`\(propmacro)c(,p\)\))1259 1586 y(props\)\)\))1029
1790 y FA(Figure)19 b(16.2:)29 b(Automatic)19 b(de\002nition)g(of)h
(access)h(macros.)p 3231 1868 V 555 1871 2678 4 v 555
2094 a Fw(16.2)99 b(Pr)n(operties)555 2285 y FA(Lisp)13
b(of)n(fers)g(man)o(y)g(w)o(ays)g(to)g(associate)g(properties)g(with)g
(objects.)22 b(If)13 b(the)g(object)g(in)g(question)555
2389 y(can)j(be)g(represented)e(as)j(a)g(symbol,)e(one)h(of)g(the)g
(most)g(con)m(v)o(enient)e(\(though)g(least)i(ef)n(\002cient\))555
2494 y(w)o(ays)k(is)h(to)f(use)g(the)f(symbol')-5 b(s)20
b(property)d(list.)30 b(T)-7 b(o)20 b(describe)f(the)h(f)o(act)g(that)g
(an)f(object)h Ft(o)f FA(has)555 2599 y(a)i(property)d
Ft(p)p FA(,)i(the)g(v)n(alue)f(of)h(which)g(is)h Ft(v)p
FA(,)f(we)h(modify)e(the)h(property)e(list)j(of)f Ft(o)p
FA(:)555 2811 y Fs(\(setf)42 b(\(get)f Ft(o)j(p)p Fs(\))e
Ft(v)p Fs(\))555 3024 y FA(So)20 b(to)h(say)f(that)g
Fs(ball1)f FA(has)i Fs(color)d(red)p FA(,)i(we)g(say:)555
3205 y Fs(\(setf)42 b(\(get)f('ball1)h('color\))e('red\))555
3391 y FA(If)23 b(we')l(re)g(going)f(to)h(refer)g(often)f(to)i(some)f
(property)e(of)i(objects,)g(we)h(can)f(de\002ne)g(a)h(macro)555
3495 y(to)c(retrie)n(v)o(e)f(it:)555 3677 y Fs(\(defmacro)40
b(color)h(\(obj\))642 3776 y(`\(get)h(,obj)g('color\)\))555
3962 y FA(and)20 b(thereafter)e(use)j Fs(color)e FA(in)h(place)g(of)g
Fs(get)p FA(:)555 4143 y Fs(>)43 b(\(color)e('ball1\))555
4243 y(RED)555 4429 y FA(Since)20 b(macro)f(calls)i(are)g(transparent)d
(to)i Fs(setf)g FA(\(see)g(Chapter)g(12\))f(we)i(can)f(also)g(say:)555
4610 y Fs(>)43 b(\(setf)f(\(color)f('ball1\))f('green\))555
4710 y(GREEN)680 4896 y FA(Such)28 b(macros)h(ha)n(v)o(e)g(the)g(adv)n
(antage)e(of)i(hiding)f(the)h(particular)f(w)o(ay)h(in)h(which)f(the)
555 5001 y(program)19 b(represents)i(the)g(color)g(of)g(an)g(object.)32
b(Property)20 b(lists)j(are)e(slo)n(w;)i(a)e(later)h(v)o(ersion)p
eop
%%Page: 217 230
217 229 bop 555 538 a Ft(16.2)1042 b Fu(PR)n(OPER)l(TIES)1024
b FA(217)555 801 y(of)36 b(the)h(program)d(might,)40
b(for)c(the)g(sak)o(e)h(of)f(speed,)k(represent)c(color)g(as)h(a)g
(\002eld)f(in)h(a)555 905 y(structure,)24 b(or)g(an)f(entry)h(in)g(a)g
(hash\255table.)40 b(When)24 b(data)g(is)g(reached)f(through)f(a)i(f)o
(acade)g(of)555 1010 y(macros)k(lik)o(e)h Fs(color)p
FA(,)g(it)g(becomes)e(easy)-5 b(,)30 b(e)n(v)o(en)e(in)h(a)g(comparati)
n(v)o(ely)c(mature)j(program,)555 1114 y(to)23 b(mak)o(e)g(perv)n(asi)n
(v)o(e)e(changes)h(to)h(the)g(lo)n(west\255le)n(v)o(el)f(code.)36
b(If)23 b(a)g(program)e(switches)j(from)555 1219 y(using)d(property)e
(lists)k(to)f(structures,)f(nothing)f(abo)o(v)o(e)f(the)j(f)o(acade)f
(of)g(access)h(macros)f(will)555 1324 y(ha)n(v)o(e)h(to)g(be)h
(changed;)e(none)h(of)g(the)g(code)g(which)g(looks)g(upon)e(the)j(f)o
(acade)f(need)f(e)n(v)o(en)h(be)555 1428 y(a)o(w)o(are)e(of)g(the)g
(reb)n(uilding)e(going)h(on)h(behind)f(it.)680 1533 y(F)o(or)i(the)h
(weight)f(property)-5 b(,)20 b(we)i(can)g(de\002ne)f(a)h(macro)f
(similar)h(to)g(the)g(one)g(written)f(for)555 1638 y(color:)555
1820 y Fs(\(defmacro)40 b(weight)h(\(obj\))642 1920 y(`\(get)h(,obj)g
('weight\)\))555 2107 y FA(Lik)o(e)29 b(the)f(abbre)n(viations)f(in)i
(the)f(pre)n(vious)f(section,)k(the)d(de\002nitions)g(of)h(of)f
Fs(color)f FA(and)555 2212 y Fs(weight)d FA(are)h(nearly)g(identical.)
44 b(Here)26 b Fs(propmacro)c FA(\(Figure)i(16.2\))g(can)i(play)f(the)g
(same)555 2317 y(role)20 b(as)h Fs(abbrev)d FA(did.)680
2421 y(A)27 b(macro\255de\002ning)d(macro)j(can)g(be)g(designed)f(by)h
(the)g(same)h(process)f(as)h(an)o(y)e(other)555 2526
y(macro:)i(look)18 b(at)i(the)f(macro)f(call,)i(then)e(its)i(intended)e
(e)o(xpansion,)f(then)i(\002gure)f(out)h(ho)n(w)f(to)555
2630 y(transform)h(the)h(former)e(into)i(the)h(latter)-5
b(.)29 b(W)-7 b(e)22 b(w)o(ant)555 2813 y Fs(\(propmacro)39
b(color\))555 3001 y FA(to)20 b(e)o(xpand)f(into)555
3183 y Fs(\(defmacro)40 b(color)h(\(obj\))642 3283 y(`\(get)h(,obj)g
('color\)\))555 3471 y FA(Though)22 b(this)j(e)o(xpression)e(is)i
(itself)g(a)g Fs(defmacro)p FA(,)e(we)h(can)h(still)g(mak)o(e)f(a)h
(template)f(of)g(it,)555 3575 y(by)k(backquoting)e(it)k(and)e(putting)g
(comma')l(d)f(parameter)g(names)i(in)g(place)f(of)h(instances)555
3680 y(of)h Fs(color)p FA(.)57 b(As)31 b(in)f(the)g(pre)n(vious)e
(section,)k(we)f(be)o(gin)e(by)g(transforming)f(it)i(so)h(that)f(no)555
3784 y(instances)20 b(of)g Fs(color)f FA(are)h(within)g(e)o(xisting)f
(backquotes:)555 3967 y Fs(\(defmacro)40 b(color)h(\(obj\))642
4067 y(\(let)h(\(\(p)g('color\)\))729 4166 y(`\(get)g(,obj)g(',p\)\)\))
555 4354 y FA(Then)19 b(we)i(go)f(ahead)f(and)h(mak)o(e)f(the)i
(template,)555 4537 y Fs(`\(defmacro)39 b(,propname)h(\(obj\))686
4636 y(\(let)i(\(\(p)g(',propname\)\))773 4736 y(`\(get)f(,obj)h
(',p\)\)\))555 4924 y FA(which)20 b(simpli\002es)g(to)2111
b Fq(\016)p eop
%%Page: 218 231
218 230 bop 555 538 a FA(218)823 b Fu(MA)n(CR)n(O)p Fv(\255)p
Fu(DEFINING)18 b(MA)n(CR)n(OS)555 801 y Fs(`\(defmacro)39
b(,propname)h(\(obj\))686 900 y(`\(get)h(,obj)h(',',propname\)\))680
1088 y FA(F)o(or)21 b(cases)i(where)e(a)i(group)d(of)i
(property\255names)d(all)j(ha)n(v)o(e)g(to)g(be)g(de\002ned)f(as)h
(macros,)555 1193 y(there)31 b(is)i Fs(propmacros)28
b FA(\(Figure)i(16.2\),)j(which)e(e)o(xpands)f(into)i(a)g(series)g(of)f
(indi)n(vidual)555 1297 y(calls)k(to)g Fs(propmacro)p
FA(.)69 b(Lik)o(e)34 b Fs(abbrevs)p FA(,)i(this)f(modest)f(piece)g(of)g
(code)g(is)h(actually)f(a)555 1402 y
(macro\255de\002ning\255macro\255de)o(\002ning)14 b(macro.)680
1506 y(Though)i(this)i(section)g(dealt)g(with)g(property)e(lists,)k
(the)e(technique)f(described)g(here)g(is)i(a)555 1611
y(general)g(one.)29 b(W)-7 b(e)21 b(could)e(use)i(it)g(to)f(de\002ne)g
(access)g(macros)g(on)g(data)g(stored)f(in)i(an)o(y)e(form.)555
1864 y Fw(16.3)99 b(Anaphoric)26 b(Macr)n(os)555 2054
y FA(Section)16 b(14.1)g(ga)n(v)o(e)g(de\002nitions)g(of)g(se)n(v)o
(eral)h(anaphoric)d(macros.)28 b(When)16 b(you)g(use)h(a)h(macro)555
2159 y(lik)o(e)h Fs(aif)g FA(or)g Fs(aand)p FA(,)f(during)g(the)h(e)n
(v)n(aluation)e(of)i(some)g(ar)o(guments)e(the)i(symbol)g
Fs(it)g FA(will)h(be)555 2263 y(bound)e(to)j(the)f(v)n(alues)g
(returned)e(by)i(other)f(ones.)29 b(So)21 b(instead)e(of)555
2446 y Fs(\(let)42 b(\(\(res)f(\(complicated-quer)o(y\)\))o(\))642
2546 y(\(if)i(res)817 2645 y(\(foo)e(res\)\)\))555 2833
y FA(you)19 b(can)h(use)h(just)555 3016 y Fs(\(aif)42
b(\(complicated-que)o(ry)o(\))773 3115 y(\(foo)g(it\)\))555
3303 y FA(and)20 b(instead)g(of)555 3486 y Fs(\(let)42
b(\(\(o)g(\(owner)f(x\)\)\))642 3585 y(\(and)h(o)h(\(let)f(\(\(a)h
(\(address)d(o\)\)\))1034 3685 y(\(and)i(a)i(\(city)d(a\)\)\)\)\))555
3872 y FA(simply)555 4055 y Fs(\(aand)h(\(owner)f(x\))h(\(address)f
(it\))h(\(city)g(it\)\))555 4243 y FA(Section)28 b(14.1)g(presented)f
(se)n(v)o(en)h(anaphoric)e(macros:)45 b Fs(aif)p FA(,)30
b Fs(awhen)p FA(,)f Fs(awhile)p FA(,)f Fs(acond)p FA(,)555
4347 y Fs(alambda)p FA(,)34 b Fs(ablock)p FA(,)g(and)f
Fs(aand)p FA(.)67 b(These)33 b(se)n(v)o(en)f(are)h(by)g(no)g(means)g
(the)g(only)f(useful)555 4452 y(anaphoric)17 b(macros)h(of)g(their)h
(type.)28 b(In)18 b(f)o(act,)h(we)h(can)e(de\002ne)g(an)h(anaphoric)e
(v)n(ariant)h(of)g(just)555 4557 y(about)24 b(an)o(y)g(Common)f(Lisp)i
(function)e(or)i(macro.)42 b(Man)o(y)23 b(of)i(these)g(macros)f(will)i
(be)e(lik)o(e)555 4661 y Fs(mapcon)p FA(:)k(rarely)19
b(used,)h(b)n(ut)g(indispensable)f(when)g(the)o(y)h(are)g(needed.)680
4766 y(F)o(or)j(e)o(xample,)g(we)h(can)g(de\002ne)f Fs(a+)h
FA(so)g(that,)h(as)f(with)g Fs(aand)p FA(,)g Fs(it)f
FA(is)i(al)o(w)o(ays)f(bound)e(to)555 4870 y(the)j(v)n(alue)f(returned)
f(by)i(the)g(pre)n(vious)e(ar)o(gument.)41 b(The)25 b(follo)n(wing)e
(function)h(calculates)555 4975 y(the)c(cost)h(of)f(dining)f(out)g(in)i
(Massachusetts:)p eop
%%Page: 219 232
219 231 bop 555 538 a Ft(16.3)909 b Fu(AN)n(APHORIC)19
b(MA)n(CR)n(OS)891 b FA(219)p 555 745 2678 4 v 553 3362
4 2617 v 605 888 a Fs(\(defmacro)40 b(a+)i(\(&rest)g(args\))692
988 y(\(a+expand)e(args)i(nil\)\))605 1187 y(\(defun)f(a+expand)f
(\(args)i(syms\))692 1287 y(\(if)g(args)866 1386 y(\(let)g(\(\(sym)g
(\(gensym\)\)\))954 1486 y(`\(let*)f(\(\(,sym)g(,\(car)g(args\)\))1302
1586 y(\(it)i(,sym\)\))1084 1685 y(,\(a+expand)d(\(cdr)i(args\))1651
1785 y(\(append)f(syms)h(\(list)f(sym\)\)\)\)\))866 1884
y(`\(+)i(,@syms\)\)\))605 2084 y(\(defmacro)d(alist)h(\(&rest)g(args\))
692 2183 y(\(alist-expand)d(args)k(nil\)\))605 2383 y(\(defun)f
(alist-expand)e(\(args)i(syms\))692 2482 y(\(if)h(args)866
2582 y(\(let)g(\(\(sym)g(\(gensym\)\)\))954 2681 y(`\(let*)f(\(\(,sym)g
(,\(car)g(args\)\))1302 2781 y(\(it)i(,sym\)\))1084 2881
y(,\(alist-expand)38 b(\(cdr)k(args\))1651 2980 y(\(append)f(syms)h
(\(list)f(sym\)\)\)\)\))866 3080 y(`\(list)g(,@syms\)\)\))1192
3284 y FA(Figure)20 b(16.3:)28 b(De\002nitions)20 b(of)g
Fs(a+)g FA(and)f Fs(alist)p FA(.)p 3231 3362 V 555 3366
2678 4 v 555 3590 a Fs(\(defun)41 b(mass-cost)f(\(menu-price\))642
3689 y(\(a+)j(menu-price)c(\(*)k(it)f(.05\))g(\(*)h(it)g(3\)\)\))555
3877 y FA(The)33 b(Massachusetts)h(Meals)g(T)-7 b(ax)33
b(is)h(5\045,)j(and)c(residents)g(often)g(calculate)g(the)g(tip)h(by)
555 3982 y(tripling)26 b(the)i(tax.)50 b(By)28 b(this)g(formula,)f(the)
h(total)f(cost)h(of)f(the)g(broiled)f(scrod)h(at)h(Dolphin)555
4086 y(Seafood)19 b(is)i(therefore:)555 4269 y Fs(>)43
b(\(mass-cost)d(7.95\))555 4369 y(9.54)555 4556 y FA(b)n(ut)20
b(this)h(includes)e(salad)i(and)e(a)i(bak)o(ed)e(potato.)680
4661 y(The)13 b(macro)g Fs(a+)p FA(,)d(de\002ned)j(in)g(Figure)g(16.3,)
8 b(relies)13 b(on)g(a)g(recursi)n(v)o(e)g(fun)o(ction,)8
b Fs(a+expand)p FA(,)555 4765 y(to)25 b(generate)e(its)i(e)o(xpansion.)
40 b(The)24 b(general)f(strate)o(gy)h(of)g Fs(a+expand)d
FA(is)26 b(to)e(cdr)g(do)n(wn)g(the)555 4870 y(list)c(of)f(ar)o
(guments)f(in)h(the)g(macro)g(call,)g(generating)f(a)h(series)h(of)f
(nested)g Fs(let)g FA(e)o(xpressions;)555 4975 y(each)c
Fs(let)g FA(lea)n(v)o(es)h Fs(it)f FA(bound)f(to)i(a)g(dif)n(ferent)e
(ar)o(gument,)g(b)n(ut)h(also)h(binds)f(a)h(distinct)g(gensym)p
eop
%%Page: 220 233
220 232 bop 555 538 a FA(220)823 b Fu(MA)n(CR)n(O)p Fv(\255)p
Fu(DEFINING)18 b(MA)n(CR)n(OS)p 555 745 2678 4 v 553
2665 4 1920 v 605 888 a Fs(\(defmacro)40 b(defanaph)g(\(name)h
(&optional)f(calls\))736 988 y(\(let)i(\(\(calls)e(\(or)j(calls)e
(\(pop-symbol)e(name\)\)\)\))779 1087 y(`\(defmacro)h(,name)h(\(&rest)g
(args\))910 1187 y(\(anaphex)f(args)i(\(list)g(',calls\)\)\)\)\))605
1386 y(\(defun)f(anaphex)g(\(args)g(expr\))692 1486 y(\(if)h(args)866
1586 y(\(let)g(\(\(sym)g(\(gensym\)\)\))954 1685 y(`\(let*)f(\(\(,sym)g
(,\(car)g(args\)\))1302 1785 y(\(it)i(,sym\)\))1084 1884
y(,\(anaphex)d(\(cdr)i(args\))1520 1984 y(\(append)f(expr)h(\(list)f
(sym\)\)\)\)\))866 2084 y(expr\)\))605 2283 y(\(defun)g(pop-symbol)e
(\(sym\))692 2383 y(\(intern)i(\(subseq)f(\(symbol-name)f(sym\))j
(1\)\)\))971 2587 y FA(Figure)20 b(16.4:)28 b(Automatic)19
b(de\002nition)g(of)h(anaphoric)e(macros.)p 3231 2665
V 555 2668 2678 4 v 555 2892 a(to)25 b(each)f(ar)o(gument.)40
b(The)24 b(e)o(xpansion)f(function)f(accumulates)i(a)h(list)h(of)e
(these)h(gensyms,)555 2997 y(and)19 b(when)g(it)i(reaches)e(the)h(end)f
(of)g(the)h(list)h(of)e(ar)o(guments)f(it)i(returns)f(a)h
Fs(+)g FA(e)o(xpression)e(with)555 3102 y(the)i(gensyms)g(as)g(the)h
(ar)o(guments.)27 b(So)20 b(the)g(e)o(xpression)555 3284
y Fs(\(a+)42 b(menu-price)e(\(*)j(it)f(.05\))g(\(*)h(it)g(3\)\))555
3472 y FA(yields)20 b(the)g(macroe)o(xpansion:)555 3655
y Fs(\(let*)42 b(\(\(#:g2)f(menu-price\))e(\(it)j(#:g2\)\))642
3754 y(\(let*)g(\(\(#:g3)f(\(*)i(it)f(0.05\)\))f(\(it)i(#:g3\)\))729
3854 y(\(let*)f(\(\(#:g4)f(\(*)i(it)f(3\)\))h(\(it)f(#:g4\)\))817
3953 y(\(+)g(#:g2)g(#:g3)g(#:g4\)\)\)\))680 4141 y FA(Figure)19
b(16.3)g(also)i(contains)e(the)h(de\002nition)f(of)h(the)g(analogous)f
Fs(alist)p FA(:)555 4324 y Fs(>)43 b(\(alist)e(1)i(\(+)g(2)g(it\))g
(\(+)f(2)i(it\)\))555 4423 y(\(1)f(3)g(5\))680 4611 y
FA(Once)21 b(again,)f(the)h(de\002nitions)g(of)g Fs(a+)g
FA(and)g Fs(alist)f FA(are)h(almost)g(identical.)33 b(If)21
b(we)g(w)o(ant)555 4716 y(to)k(de\002ne)e(more)h(macros)g(lik)o(e)g
(them,)h(these)g(too)f(will)h(be)f(mostly)h(duplicate)e(code.)41
b(Why)555 4820 y(not)23 b(ha)n(v)o(e)f(a)i(program)c(produce)h(it)j
(for)e(us?)39 b(The)22 b(macro)g Fs(defanaph)e FA(in)k(Figure)e(16.4)g
(will)555 4925 y(do)e(so.)29 b(W)m(ith)21 b Fs(defanaph)p
FA(,)c(de\002ning)i Fs(a+)h FA(and)f Fs(alist)g FA(is)i(as)g(simple)f
(as)p eop
%%Page: 221 234
221 233 bop 555 538 a Ft(16.3)909 b Fu(AN)n(APHORIC)19
b(MA)n(CR)n(OS)891 b FA(221)555 801 y Fs(\(defanaph)40
b(a+\))555 900 y(\(defanaph)g(alist\))555 1063 y FA(The)26
b(e)o(xpansions)e(of)i Fs(a+)g FA(and)g Fs(alist)f FA(so)h(de\002ned)g
(will)h(be)f(identical)g(to)g(the)g(e)o(xpansions)555
1168 y(made)14 b(by)g(the)h(code)f(in)h(Figure)f(16.3.)27
b(The)14 b(macro\255de\002ning)e(macro)h Fs(defanaph)f
FA(will)k(create)555 1273 y(an)k(anaphoric)e(v)n(ariant)h(of)h(an)o
(ything)e(whose)i(ar)o(guments)e(are)i(e)n(v)n(aluated)e(according)g
(to)j(the)555 1377 y(normal)i(e)n(v)n(aluation)f(rule)i(for)g
(functions.)39 b(That)24 b(is,)i Fs(defanaph)c FA(will)j(w)o(ork)e(for)
h(an)o(ything)555 1482 y(whose)h(ar)o(guments)e(are)j(all)g(e)n(v)n
(aluated,)e(and)h(e)n(v)n(aluated)f(left\255to\255right.)43
b(So)25 b(you)g(couldn')o(t)555 1586 y(use)17 b(this)g(v)o(ersion)e(of)
i Fs(defanaph)c FA(to)k(de\002ne)f Fs(aif)g FA(or)g Fs(awhile)p
FA(,)g(b)n(ut)g(you)g(can)g(use)h(it)g(to)g(de\002ne)555
1691 y(an)j(anaphoric)e(v)n(ariant)h(of)h(an)o(y)g(function.)680
1796 y(As)g Fs(a+)g FA(called)g Fs(a+expand)d FA(to)j(generate)f(its)i
(e)o(xpansion,)c Fs(defanaph)g FA(de\002nes)j(a)h(macro)555
1900 y(which)k(will)h(call)f Fs(anaphex)e FA(to)i(do)g(so.)45
b(The)25 b(generic)f(e)o(xpander)e Fs(anaphex)h FA(dif)n(fers)i(from)
555 2005 y Fs(a+expand)e FA(only)h(in)i(taking)e(as)i(an)f(ar)o(gument)
e(the)i(function)f(name)h(to)g(appear)f(\002nally)h(in)555
2109 y(the)20 b(e)o(xpansion.)27 b(In)20 b(f)o(act,)g
Fs(a+)g FA(could)g(no)n(w)f(be)h(de\002ned:)555 2268
y Fs(\(defmacro)40 b(a+)j(\(&rest)e(args\))642 2367 y(\(anaphex)f(args)
i('\(+\)\)\))555 2530 y FA(Neither)30 b Fs(anaphex)f
FA(nor)h Fs(a+expand)e FA(need)i(ha)n(v)o(e)g(been)h(de\002ned)e(as)j
(distinct)f(functions:)555 2635 y Fs(anaphex)25 b FA(could)h(ha)n(v)o
(e)g(been)g(de\002ned)g(with)h Fs(labels)e FA(or)i Fs(alambda)e
FA(within)i Fs(defanaph)p FA(.)555 2739 y(The)d(e)o(xpansion)e
(generators)h(are)h(here)g(brok)o(en)f(out)h(as)h(separate)e(functions)
g(only)h(for)g(the)555 2844 y(sak)o(e)c(of)g(clarity)-5
b(.)680 2949 y(By)19 b(def)o(ault,)f Fs(defanaph)e FA(determines)i
(what)h(to)g(call)g(in)g(the)g(e)o(xpansion)d(by)j(pulling)f(the)555
3053 y(\002rst)27 b(letter)g(\(presumably)d(an)i Fs(a)p
FA(\))g(from)f(the)i(front)e(of)h(its)i(ar)o(gument.)45
b(\(This)26 b(operation)f(is)555 3158 y(performed)e(by)i
Fs(pop-symbol)p FA(.\))40 b(If)25 b(the)h(user)f(prefers)f(to)i
(specify)e(an)h(alternate)g(name,)h(it)555 3262 y(can)e(be)f(gi)n(v)o
(en)g(as)h(an)g(optional)e(ar)o(gument.)38 b(Although)22
b Fs(defanaph)f FA(can)i(b)n(uild)h(anaphoric)555 3367
y(v)n(ariants)c(of)f(all)i(functions)e(and)h(some)g(macros,)f(it)i
(imposes)f(some)g(irksome)f(restrictions:)659 3530 y(1.)41
b(It)20 b(only)f(w)o(orks)h(for)g(operators)e(whose)i(ar)o(guments)e
(are)j(all)f(e)n(v)n(aluated.)659 3691 y(2.)41 b(In)28
b(the)g(macroe)o(xpansion,)f Fs(it)h FA(is)i(al)o(w)o(ays)f(bound)d(to)
j(successi)n(v)o(e)f(ar)o(guments.)52 b(In)763 3796 y(some)22
b(cases\227)p Fs(awhen)p FA(,)f(for)g(e)o(xample\227we)g(w)o(ant)h
Fs(it)g FA(to)h(stay)f(bound)f(to)h(the)g(v)n(alue)763
3901 y(of)d(the)i Ft(\002r)o(st)g FA(ar)o(gument.)659
4062 y(3.)41 b(It)22 b(w)o(on')o(t)f(w)o(ork)g(for)g(a)h(macro)f(lik)o
(e)i Fs(setf)p FA(,)e(which)g(e)o(xpects)g(a)i(generalized)d(v)n
(ariable)763 4166 y(as)g(its)i(\002rst)f(ar)o(gument.)555
4329 y(Let')-5 b(s)20 b(consider)f(ho)n(w)g(to)h(remo)o(v)o(e)d(some)j
(of)f(these)h(restrictions.)28 b(P)o(art)20 b(of)f(the)h(\002rst)g
(problem)555 4434 y(can)c(be)g(solv)o(ed)f(by)h(solving)f(the)h
(second.)27 b(T)-7 b(o)16 b(generate)f(e)o(xpansions)f(for)i(a)g(macro)
f(lik)o(e)h Fs(aif)p FA(,)555 4539 y(we)j(need)f(a)i(modi\002ed)d(v)o
(ersion)h(of)g Fs(anaphex)f FA(which)h(only)g(replaces)h(the)f(\002rst)
i(ar)o(gument)c(in)555 4643 y(the)k(macro)f(call:)555
4801 y Fs(\(defun)41 b(anaphex2)f(\(op)j(args\))642 4901
y(`\(let)f(\(\(it)g(,\(car)f(args\)\)\))773 5001 y(\(,op)h(it)h
(,@\(cdr)e(args\)\)\)\))p eop
%%Page: 222 235
222 234 bop 555 538 a FA(222)823 b Fu(MA)n(CR)n(O)p Fv(\255)p
Fu(DEFINING)18 b(MA)n(CR)n(OS)555 801 y FA(This)25 b(nonrecursi)n(v)o
(e)c(v)o(ersion)i(of)i Fs(anaphex)d FA(doesn')o(t)h(need)g(to)i(ensure)
f(that)g(the)h(macroe)o(x\255)555 905 y(pansion)j(will)h(bind)f
Fs(it)h FA(to)g(successi)n(v)o(e)g(ar)o(guments,)g(so)g(it)g(can)g
(generate)f(an)h(e)o(xpansion)555 1010 y(which)c(w)o(on')o(t)g
(necessarily)h(e)n(v)n(aluate)f(all)h(the)g(ar)o(guments)e(in)i(the)g
(macro)f(call.)47 b(Only)26 b(the)555 1114 y(\002rst)f(ar)o(gument)c
(must)j(be)g(e)n(v)n(aluated,)f(in)i(order)d(to)i(bind)f
Fs(it)h FA(to)g(its)h(v)n(alue.)40 b(So)24 b Fs(aif)g
FA(could)555 1219 y(be)c(de\002ned)f(as:)555 1400 y Fs(\(defmacro)40
b(aif)i(\(&rest)f(args\))642 1499 y(\(anaphex2)f('if)i(args\)\))555
1685 y FA(This)18 b(de\002nition)f(w)o(ould)g(dif)n(fer)g(from)f(the)i
(original)f(on)g(page)g(191)g(only)g(in)h(the)g(point)f(where)555
1789 y(it)k(w)o(ould)e(complain)g(if)h Fs(aif)f FA(were)h(gi)n(v)o(en)f
(the)h(wrong)f(number)f(of)i(ar)o(guments;)e(for)i(correct)555
1894 y(macro)f(calls,)i(the)f(tw)o(o)h(generate)e(identical)g(e)o
(xpansions.)680 1998 y(The)d(third)h(problem,)f(that)h
Fs(defanaph)e FA(w)o(on')o(t)h(w)o(ork)g(with)i(generalized)d(v)n
(ariables,)i(can)555 2103 y(be)25 b(solv)o(ed)f(by)g(using)p
1219 2103 27 4 v 56 w Fs(f)h FA(\(page)f(173\))g(in)h(the)g(e)o
(xpansion.)41 b(Operators)24 b(lik)o(e)h Fs(setf)f FA(can)h(be)555
2208 y(handled)19 b(by)g(a)i(v)n(ariant)e(of)h Fs(anaphex2)e
FA(de\002ned)h(as)i(follo)n(ws:)555 2388 y Fs(\(defun)41
b(anaphex3)f(\(op)j(args\))642 2488 y(`\(_f)f(\(lambda)f(\(it\))h
(\(,op)g(it)g(,@\(cdr)g(args\)\)\))e(,\(car)i(args\)\)\))555
2673 y FA(This)22 b(e)o(xpander)e(assumes)i(that)h(the)f(macro)f(call)h
(will)h(ha)n(v)o(e)f(one)f(or)h(more)f(ar)o(guments,)g(the)555
2778 y(\002rst)d(of)f(which)g(will)h(be)g(a)f(generalized)f(v)n
(ariable.)27 b(Using)17 b(it)i(we)e(could)g(de\002ne)g
Fs(asetf)f FA(thus:)555 2958 y Fs(\(defmacro)40 b(asetf)h(\(&rest)g
(args\))642 3058 y(\(anaphex3)f('setf)i(args\)\))680
3243 y FA(Figure)35 b(16.5)g(sho)n(ws)h(all)h(three)f(e)o(xpander)d
(functions)i(yok)o(ed)g(together)g(under)g(the)555 3348
y(control)18 b(of)i(a)f(single)h(macro,)e(the)i(ne)n(w)f
Fs(defanaph)p FA(.)26 b(The)20 b(user)f(signals)h(the)f(type)g(of)h
(macro)555 3453 y(e)o(xpansion)c(desired)i(with)g(the)g(optional)f
Fs(rule)g FA(k)o(e)o(yw)o(ord)f(parameter)m(,)g(which)i(speci\002es)h
(the)555 3557 y(e)n(v)n(aluation)j(rule)h(to)h(be)g(used)f(for)g(the)h
(ar)o(guments)d(in)j(the)g(macro)e(call.)40 b(If)24 b(this)g(parameter)
555 3662 y(is:)555 3847 y Fs(:all)40 b FA(\(the)24 b(def)o(ault\))g
(the)h(macroe)o(xpansion)c(will)26 b(be)f(on)f(the)h(model)f(of)g
Fs(alist)p FA(.)42 b(All)26 b(the)763 3952 y(ar)o(guments)17
b(in)j(the)f(macro)f(call)i(will)g(be)g(e)n(v)n(aluated,)e(with)h
Fs(it)h FA(al)o(w)o(ays)f(bound)f(to)i(the)763 4056 y(v)n(alue)f(of)h
(the)g(pre)n(vious)f(ar)o(gument.)555 4227 y Fs(:first)39
b FA(the)16 b(macroe)o(xpansion)c(will)17 b(be)e(on)h(the)g(model)f(of)
g Fs(aif)p FA(.)27 b(Only)16 b(the)f(\002rst)i(ar)o(gument)763
4331 y(will)j(necessarily)g(be)g(e)n(v)n(aluated,)f(and)g
Fs(it)h FA(will)h(be)f(bound)f(to)h(its)h(v)n(alue.)555
4501 y Fs(:place)39 b FA(the)22 b(macroe)o(xpansion)c(will)23
b(be)f(on)f(the)h(model)f(of)h Fs(asetf)p FA(.)33 b(The)21
b(\002rst)i(ar)o(gument)763 4606 y(will)f(be)f(treated)g(as)i(a)f
(generalized)d(v)n(ariable,)i(and)g Fs(it)g FA(will)i(be)e(bound)f(to)i
(its)g(initial)763 4711 y(v)n(alue.)555 4896 y(Using)27
b(the)h(ne)n(w)f Fs(defanaph)p FA(,)g(some)g(of)g(the)h(pre)n(vious)e
(e)o(xamples)g(w)o(ould)h(be)g(de\002ned)g(as)555 5001
y(follo)n(ws:)p eop
%%Page: 223 236
223 235 bop 555 538 a Ft(16.3)909 b Fu(AN)n(APHORIC)19
b(MA)n(CR)n(OS)891 b FA(223)p 555 745 2678 4 v 553 3363
4 2618 v 605 888 a Fs(\(defmacro)40 b(defanaph)g(\(name)h(&optional)f
(&key)i(calls)g(\(rule)f(:all\)\))692 988 y(\(let*)h(\(\(opname)e(\(or)
i(calls)g(\(pop-symbol)d(name\)\)\))997 1087 y(\(body)j(\(case)f(rule)
1346 1187 y(\(:all)128 b(`\(anaphex1)40 b(args)i('\(,opname\)\)\))1346
1287 y(\(:first)e(`\(anaphex2)g(',opname)g(args\)\))1346
1386 y(\(:place)g(`\(anaphex3)g(',opname)g(args\)\)\)\)\))779
1486 y(`\(defmacro)g(,name)h(\(&rest)g(args\))910 1586
y(,body\)\)\))605 1785 y(\(defun)g(anaphex1)f(\(args)i(call\))692
1884 y(\(if)g(args)866 1984 y(\(let)g(\(\(sym)g(\(gensym\)\)\))954
2084 y(`\(let*)f(\(\(,sym)g(,\(car)g(args\)\))1302 2183
y(\(it)i(,sym\)\))1084 2283 y(,\(anaphex1)d(\(cdr)i(args\))1564
2383 y(\(append)e(call)i(\(list)g(sym\)\)\)\)\))866 2482
y(call\)\))605 2681 y(\(defun)f(anaphex2)f(\(op)j(args\))692
2781 y(`\(let)f(\(\(it)f(,\(car)h(args\)\)\))f(\(,op)h(it)g(,@\(cdr)f
(args\)\)\)\))605 2980 y(\(defun)g(anaphex3)f(\(op)j(args\))692
3080 y(`\(_f)f(\(lambda)f(\(it\))h(\(,op)f(it)i(,@\(cdr)e(args\)\)\))g
(,\(car)h(args\)\)\))1258 3284 y FA(Figure)20 b(16.5:)28
b(More)20 b(general)f Fs(defanaph)p FA(.)p 3231 3363
V 555 3366 2678 4 v 555 3585 a Fs(\(defanaph)40 b(alist\))555
3684 y(\(defanaph)g(aif)i(:rule)g(:first\))555 3784 y(\(defanaph)e
(asetf)h(:rule)h(:place\))680 3965 y FA(One)13 b(of)g(the)g(adv)n
(antages)g(of)g Fs(asetf)g FA(is)g(that)g(it)g(mak)n(es)g(it)g
(possible)g(to)g(de\002ne)g(a)g(lar)n(ge)f(class)555
4069 y(of)25 b(macros)f(on)h(generalized)f(v)n(ariables)g(without)g(w)o
(orrying)g(about)g(multiple)h(e)n(v)n(aluation.)555 4174
y(F)o(or)20 b(e)o(xample,)e(we)j(could)e(de\002ne)h Fs(incf)f
FA(as:)555 4350 y Fs(\(defmacro)40 b(incf)i(\(place)f(&optional)f
(\(val)i(1\)\))642 4450 y(`\(asetf)f(,place)g(\(+)i(it)f(,val\)\)\))555
4630 y FA(and,)19 b(say)-5 b(,)20 b Fs(pull)f FA(\(page)g(173\))g(as:)
555 4806 y Fs(\(defmacro)40 b(pull)i(\(obj)g(place)f(&rest)h(args\))642
4906 y(`\(asetf)f(,place)g(\(delete)g(,obj)h(it)g(,@args\)\)\))p
eop
%%Page: 224 237
224 236 bop 555 1610 a Fn(17)p 555 1872 2686 3 v 555
2131 a Fx(Read\255Macr)m(os)555 2568 y FA(The)27 b(three)g(big)f
(moments)g(in)i(a)f(Lisp)h(e)o(xpression')-5 b(s)26 b(life)h(are)g
(read\255time,)g(compile\255time,)555 2672 y(and)h(runtime.)52
b(Functions)27 b(are)h(in)g(control)f(at)i(runtime.)52
b(Macros)28 b(gi)n(v)o(e)f(us)i(a)f(chance)f(to)555 2777
y(perform)h(transformations)g(on)i(programs)e(at)j(compile\255time.)58
b(This)30 b(chapter)f(discusses)555 2882 y(read\255macros,)18
b(which)h(do)h(their)g(w)o(ork)g(at)g(read\255time.)555
3134 y Fw(17.1)99 b(Macr)n(o)25 b(Characters)555 3325
y FA(In)e(k)o(eeping)e(with)i(the)g(general)f(philosophy)f(of)h(Lisp,)i
(you)e(ha)n(v)o(e)g(a)i(great)e(deal)h(of)g(control)555
3430 y(o)o(v)o(er)k(the)i(reader)-5 b(.)55 b(Its)29 b(beha)n(vior)e(is)
j(controlled)d(by)h(properties)g(and)g(v)n(ariables)g(that)h(can)555
3534 y(all)24 b(be)g(changed)e(on)h(the)h(\003y)-5 b(.)40
b(The)23 b(reader)g(can)g(be)h(programmed)d(at)j(se)n(v)o(eral)f(le)n
(v)o(els.)40 b(The)555 3639 y(easiest)21 b(w)o(ay)f(to)h(change)e(its)i
(beha)n(vior)d(is)j(by)f(de\002ning)f(ne)n(w)h(macro)f(characters.)680
3743 y(A)e Ft(macr)l(o)g(c)o(har)o(acter)f FA(is)i(a)g(character)d
(which)i(e)o(xacts)g(special)g(treatment)f(from)g(the)h(Lisp)555
3848 y(reader)-5 b(.)38 b(A)23 b(lo)n(wer)n(\255case)g
Fs(a)p FA(,)h(for)e(e)o(xample,)g(is)j(ordinarily)c(handled)g(just)j
(lik)o(e)g(a)f(lo)n(wer)n(\255case)555 3953 y Fs(b)p
FA(,)c(b)n(ut)g(a)g(left)g(parenthesis)e(is)j(something)d(dif)n
(ferent:)27 b(it)20 b(tells)f(Lisp)g(to)g(be)o(gin)e(reading)h(a)h
(list.)555 4057 y(Each)c(such)g(character)f(has)i(a)f(function)f
(associated)h(with)h(it)g(that)f(tells)h(the)g(Lisp)f(reader)g(what)555
4162 y(to)21 b(do)f(when)g(the)h(character)f(is)i(encountered.)28
b(Y)-9 b(ou)20 b(can)g(change)g(the)h(function)e(associated)555
4266 y(with)h(an)g(e)o(xisting)g(macro)f(character)m(,)g(or)g(de\002ne)
h(ne)n(w)g(macro)f(characters)h(of)g(your)e(o)n(wn.)680
4371 y(The)33 b(b)n(uilt\255in)g(function)f Fs(set-macro-charac)o(ter)
27 b FA(pro)o(vides)32 b(one)h(w)o(ay)h(to)g(de\002ne)555
4476 y(read\255macros.)74 b(It)36 b(tak)o(es)h(a)f(character)f(and)g(a)
i(function,)g(and)f(thereafter)e(when)i Fs(read)555 4580
y FA(encounters)18 b(the)j(character)m(,)d(it)j(returns)e(the)h(result)
h(of)f(calling)f(the)i(function.)680 4685 y(One)i(of)g(the)g(oldest)g
(read\255macros)e(in)i(Lisp)h(is)g Fs(')p FA(,)g(the)f(quote.)38
b(Y)-9 b(ou)22 b(could)g(do)h(without)555 4789 y Fs(')28
b FA(by)f(al)o(w)o(ays)h(writing)g Fs(\(quote)41 b(a\))27
b FA(instead)h(of)f Fs('a)p FA(,)i(b)n(ut)f(this)g(w)o(ould)f(be)h
(tiresome)f(and)555 4894 y(w)o(ould)18 b(mak)o(e)h(your)f(code)g
(harder)g(to)h(read.)28 b(The)19 b(quote)f(read\255macro)e(mak)o(es)j
(it)h(possible)e(to)555 4999 y(use)24 b Fs('a)g FA(as)g(an)g(abbre)n
(viation)d(for)j Fs(\(quote)41 b(a\))p FA(.)e(W)-7 b(e)25
b(could)e(de\002ne)h(it)g(as)h(in)f(Figure)f(17.1.)1835
5229 y(224)p eop
%%Page: 225 238
225 237 bop 555 538 a Ft(17.1)902 b Fu(MA)n(CR)n(O)18
b(CHARA)n(CTERS)884 b FA(225)p 555 745 2678 4 v 553 1370
4 625 v 605 888 a Fs(\(set-macro-chara)o(ct)o(er)37 b(#\\')692
988 y(#'\(lambda)j(\(stream)h(char\))866 1087 y(\(list)h('quote)f
(\(read)g(stream)h(t)h(nil)f(t\)\)\)\))1280 1292 y FA(Figure)20
b(17.1:)28 b(Possible)21 b(de\002nition)e(of)h Fs(')p
FA(.)p 3231 1370 V 555 1373 2678 4 v 555 1597 a(When)g
Fs(read)e FA(encounters)g(an)i(instance)f(of)h Fs(')g
FA(in)f(a)i(normal)d(conte)o(xt)h(\(e.g.)f(not)i(in)g
Fs("a'b")e FA(or)555 1702 y Fs(|a'b|)p FA(\),)h(it)k(will)f(return)e
(the)h(result)g(of)g(calling)g(this)h(function)e(on)h(the)g(current)f
(stream)h(and)555 1806 y(character)-5 b(.)30 b(\(The)20
b(function)g(ignores)f(this)j(second)e(parameter)m(,)f(which)h(will)h
(al)o(w)o(ays)h(be)f(the)555 1911 y(quote)e(character)-5
b(.\))28 b(So)21 b(when)e Fs(read)g FA(sees)i Fs('a)p
FA(,)f(it)h(will)g(return)e Fs(\(quote)41 b(a\))p FA(.)680
2016 y(The)25 b(last)h(three)f(ar)o(guments)e(to)i Fs(read)f
FA(control)h(respecti)n(v)o(ely)e(whether)i(encountering)555
2120 y(an)c(end\255of\255\002le)e(should)h(cause)h(an)g(error)m(,)f
(what)h(v)n(alue)f(to)i(return)e(otherwise,)g(and)h(whether)555
2225 y(the)16 b(call)g(to)g Fs(read)e FA(occurs)h(within)h(a)g(call)g
(to)g Fs(read)p FA(.)26 b(In)16 b(nearly)e(all)j(read\255macros,)d(the)
h(second)555 2330 y(and)20 b(fourth)e(ar)o(guments)g(should)i(be)g
Fs(t)p FA(,)g(and)f(the)i(third)e(ar)o(gument)f(is)j(therefore)e
(irrele)n(v)n(ant.)680 2434 y(Read\255macros)25 b(and)h(ordinary)e
(macros)i(are)h(both)f(functions)f(underneath.)46 b(And)26
b(lik)o(e)555 2539 y(the)16 b(functions)f(that)h(generate)e(macro)h(e)o
(xpansions,)g(the)h(functions)f(associated)g(with)i(macro)555
2643 y(characters)f(shouldn')o(t)e(ha)n(v)o(e)i(side\255ef)n(fects,)g
(e)o(xcept)g(on)g(the)h(stream)g(from)e(which)h(the)o(y)g(read.)555
2748 y(Common)32 b(Lisp)h(e)o(xplicitly)g(mak)o(es)g(no)g(guarantees)e
(about)i(when,)i(or)e(ho)n(w)g(often,)j(the)555 2853
y(function)18 b(associated)i(with)h(a)f(read\255macro)e(will)j(be)f
(called.)29 b(\(See)21 b Fr(CL)-6 b(TL)p FA(2,)18 b(p.)i(543.\))680
2957 y(Macros)28 b(and)h(read\255macros)e(see)i(your)f(program)f(at)j
(dif)n(ferent)d(stages.)57 b(Macros)29 b(get)555 3062
y(hold)h(of)g(the)g(program)f(when)h(it)h(has)f(already)g(been)g
(parsed)f(into)i(Lisp)f(objects)g(by)h(the)555 3166 y(reader)m(,)23
b(and)g(read\255macros)e(operate)h(on)i(a)g(program)d(while)i(it)i(is)f
(still)h(te)o(xt.)39 b(Ho)n(we)n(v)o(er)m(,)22 b(by)555
3271 y(in)m(v)n(oking)14 b Fs(read)i FA(on)g(this)h(te)o(xt,)g(a)g
(read\255macro)d(can,)i(if)h(it)g(chooses,)g(get)f(parsed)g(Lisp)h
(objects)555 3376 y(as)k(well.)30 b(Thus)19 b(read\255macros)f(are)j
(at)f(least)h(as)g(po)n(werful)e(as)h(ordinary)e(macros.)680
3480 y(Indeed,)24 b(read\255macros)f(are)j(more)e(po)n(werful)g(in)h
(at)h(least)g(tw)o(o)f(w)o(ays.)45 b(A)26 b(read\255macro)555
3585 y(af)n(fects)i(e)n(v)o(erything)e(read)h(by)h(Lisp,)i(while)f(a)f
(macro)g(will)h(only)e(be)h(e)o(xpanded)e(in)j(code.)555
3689 y(And)20 b(since)g(read\255macros)e(generally)h(call)h
Fs(read)g FA(recursi)n(v)o(ely)-5 b(,)17 b(an)j(e)o(xpression)f(lik)o
(e)555 3872 y Fs(''a)555 4060 y FA(becomes)555 4242 y
Fs(\(quote)41 b(\(quote)g(a\)\))555 4430 y FA(whereas)16
b(if)h(we)g(had)f(tried)g(to)h(de\002ne)f(an)g(abbre)n(viation)e(for)i
Fs(quote)f FA(using)h(a)h(normal)f(macro,)555 4613 y
Fs(\(defmacro)40 b(q)j(\(obj\))642 4712 y(`\(quote)e(,obj\)\))p
eop
%%Page: 226 239
226 238 bop 555 538 a FA(226)999 b Fu(READ)p Fv(\255)p
Fu(MA)n(CR)n(OS)p 555 745 2678 4 v 553 1469 4 725 v 605
888 a Fs(\(set-dispatch-ma)o(cr)o(o-c)o(ha)o(ra)o(cte)o(r)37
b(#\\#)43 b(#\\?)692 988 y(#'\(lambda)d(\(stream)h(char1)g(char2\))866
1087 y(`#'\(lambda)f(\(&rest)h(,\(gensym\)\))1084 1187
y(,\(read)g(stream)g(t)j(nil)e(t\)\)\)\))1064 1391 y
FA(Figure)19 b(17.2:)28 b(A)21 b(read\255macro)d(for)h(constant)h
(functions.)p 3231 1469 V 555 1473 2678 4 v 555 1695
a(it)h(w)o(ould)e(w)o(ork)h(in)g(isolation,)555 1876
y Fs(>)43 b(\(eq)g('a)f(\(q)h(a\)\))555 1976 y(T)555
2161 y FA(b)n(ut)20 b(not)g(when)g(nested.)28 b(F)o(or)20
b(e)o(xample,)555 2342 y Fs(\(q)43 b(\(q)g(a\)\))555
2528 y FA(w)o(ould)19 b(e)o(xpand)g(into)555 2708 y Fs(\(quote)41
b(\(q)i(a\)\))555 2961 y Fw(17.2)99 b(Dispatching)25
b(Macr)n(o)g(Characters)555 3151 y FA(The)30 b(sharp\255quote,)g(lik)o
(e)h(other)e(read\255macros)f(be)o(ginning)g(with)j Fs(#)p
FA(,)i(is)e(an)f(e)o(xample)f(of)h(a)555 3256 y(subspecies)24
b(called)g Ft(dispatc)o(hing)e FA(read\255macros.)40
b(These)24 b(appear)g(as)h(tw)o(o)f(characters,)h(the)555
3360 y(\002rst)16 b(of)f(which)g(is)h(called)f(the)g(dispatching)f
(character)-5 b(.)26 b(The)15 b(purpose)f(of)h(such)g(read\255macros)
555 3465 y(is)22 b(simply)e(to)h(mak)o(e)f(the)h(most)f(of)h(the)f
Fr(ASCII)i FA(character)d(set;)j(one)e(can)h(only)f(ha)n(v)o(e)g(so)h
(man)o(y)555 3570 y(one\255character)c(read\255macros.)680
3674 y(Y)-9 b(ou)30 b(can)i(\(with)f Fs(make-dispatch-ma)o(cr)o(o-c)o
(ha)o(rac)o(te)o(r)p FA(\))26 b(de\002ne)k(your)h(o)n(wn)f(dis\255)555
3779 y(patching)18 b(macro)h(characters,)f(b)n(ut)i(since)g
Fs(#)f FA(is)i(already)d(de\002ned)h(as)h(one,)f(you)g(may)g(as)h(well)
555 3883 y(use)h(it.)33 b(Some)21 b(combinations)e(be)o(ginning)g(with)
i Fs(#)h FA(are)f(e)o(xplicitly)f(reserv)o(ed)g(for)g(your)g(use;)555
3988 y(others)e(are)g(a)n(v)n(ailable)g(in)g(that)g(the)o(y)g(do)f(not)
h(yet)g(ha)n(v)o(e)g(a)h(prede\002ned)d(meaning)h(in)h(Common)555
4093 y(Lisp.)29 b(The)20 b(complete)f(list)j(appears)d(in)h
Fr(CL)-6 b(TL)p FA(2,)19 b(p.)h(531.)680 4197 y(Ne)n(w)34
b(dispatching)f(macro)h(character)g(combinations)e(can)j(be)f
(de\002ned)g(by)g(calling)555 4302 y(the)27 b(function)f
Fs(set-dispatch-macr)o(o-)o(ch)o(ara)o(ct)o(er)p FA(,)d(lik)o(e)28
b Fs(set-macro-charac)o(te)o(r)555 4407 y FA(e)o(xcept)c(that)h(it)h
(tak)o(es)f(tw)o(o)g(character)f(ar)o(guments.)42 b(One)24
b(of)h(the)g(combinations)e(reserv)o(ed)555 4511 y(to)j(the)g
(programmer)d(is)k Fs(#?)p FA(.)46 b(Figure)25 b(17.2)g(sho)n(ws)h(ho)n
(w)f(to)h(de\002ne)g(this)g(combination)e(as)555 4616
y(a)h(read\255macro)d(for)h(constant)h(functions.)40
b(No)n(w)24 b Fs(#?2)g FA(will)h(be)f(read)g(as)h(a)g(function)d(which)
555 4720 y(tak)o(es)f(an)o(y)e(number)f(of)i(ar)o(guments)e(and)i
(returns)f Fs(2)p FA(.)30 b(F)o(or)19 b(e)o(xample:)555
4901 y Fs(>)43 b(\(mapcar)e(#?2)h('\(a)h(b)g(c\)\))555
5001 y(\(2)g(2)g(2\))p eop
%%Page: 227 240
227 239 bop 555 538 a Ft(17.3)1038 b Fu(DELIMITERS)1018
b FA(227)p 555 745 2678 4 v 553 2067 4 1322 v 605 888
a Fs(\(set-macro-chara)o(ct)o(er)37 b(#\\])42 b(\(get-macro-charac)o
(ter)37 b(#\\\)\)\))605 1087 y(\(set-dispatch-ma)o(cr)o(o-c)o(ha)o(ra)o
(cte)o(r)g(#\\#)43 b(#\\[)692 1187 y(#'\(lambda)d(\(stream)h(char1)g
(char2\))866 1287 y(\(let)h(\(\(accum)f(nil\))1128 1386
y(\(pair)g(\(read-delimited-l)o(ist)c(#\\])42 b(stream)f(t\)\)\))954
1486 y(\(do)h(\(\(i)g(\(ceiling)e(\(car)i(pair\)\))g(\(1+)g(i\)\)\))
1128 1586 y(\(\(>)g(i)h(\(floor)e(\(cadr)h(pair\)\)\))1171
1685 y(\(list)g('quote)f(\(nreverse)f(accum\)\)\))1041
1785 y(\(push)h(i)i(accum\)\)\)\)\))1113 1989 y FA(Figure)20
b(17.3:)28 b(A)21 b(read\255macro)c(de\002ning)i(delimiters.)p
3231 2067 V 555 2070 2678 4 v 555 2285 a(This)j(e)o(xample)e(mak)o(es)i
(the)f(ne)n(w)h(operator)e(look)h(rather)f(pointless,)i(b)n(ut)g(in)g
(programs)d(that)555 2389 y(use)27 b(a)g(lot)g(of)g(functional)e(ar)o
(guments,)h(constant)g(functions)f(are)i(often)f(needed.)47
b(In)27 b(f)o(act,)555 2494 y(some)20 b(dialects)g(pro)o(vide)f(a)h(b)n
(uilt\255in)g(function)e(called)i Fs(always)f FA(for)g(de\002ning)g
(them.)680 2599 y(Note)28 b(that)g(it)h(is)g(perfectly)e(ok)g(to)i(use)
f(macro)f(characters)h(in)g(the)g(de\002nition)f(of)h(this)555
2703 y(macro)19 b(character:)28 b(as)20 b(with)g(an)o(y)f(Lisp)h(e)o
(xpression,)e(the)o(y)h(disappear)g(when)g(the)h(de\002nition)555
2808 y(is)k(read.)38 b(It)24 b(is)g(also)g(\002ne)f(to)h(use)f
(macro\255characters)e(after)i(the)g Fs(#?)p FA(.)39
b(The)23 b(de\002nition)f(of)h Fs(#?)555 2912 y FA(calls)e
Fs(read)p FA(,)e(so)h(macro\255characters)e(lik)o(e)i
Fs(')h FA(and)e Fs(#')h FA(beha)n(v)o(e)f(as)i(usual:)555
3083 y Fs(>)43 b(\(eq)g(\(funcall)d(#?'a\))h('a\))555
3183 y(T)555 3282 y(>)i(\(eq)g(\(funcall)d(#?#'oddp\))g
(\(symbol-functio)o(n)e('oddp\)\))555 3382 y(T)555 3632
y Fw(17.3)99 b(Delimiters)680 3823 y FA(After)20 b(simple)h(macro)f
(characters,)g(the)g(most)h(commonly)e(de\002ned)h(macro)g(characters)
555 3928 y(are)29 b(list)i(delimiters.)57 b(Another)28
b(character)g(combination)f(reserv)o(ed)h(for)h(the)g(user)h(is)g
Fs(#[)p FA(.)555 4032 y(Figure)25 b(17.3)f(gi)n(v)o(es)h(an)h(e)o
(xample)e(of)h(ho)n(w)g(this)h(character)e(might)h(be)h(de\002ned)e(as)
i(a)g(more)555 4137 y(elaborate)19 b(kind)h(of)g(left)h(parenthesis.)29
b(It)20 b(de\002nes)h(an)f(e)o(xpression)f(of)h(the)g(form)g
Fs(#[x)42 b(y])20 b FA(to)555 4241 y(read)g(as)h(a)f(list)h(of)f(all)h
(the)f(inte)o(gers)g(between)f Fs(x)h FA(and)g Fs(y)p
FA(,)g(inclusi)n(v)o(e:)555 4412 y Fs(>)43 b(#[2)g(7])555
4511 y(\(2)g(3)g(4)g(5)g(6)g(7\))555 4687 y FA(The)20
b(only)f(ne)n(w)h(thing)g(about)f(this)i(read\255macro)d(is)j(the)f
(call)h(to)f Fs(read-delimited-l)o(ist)o FA(,)555 4791
y(a)h(b)n(uilt\255in)f(function)f(pro)o(vided)f(just)j(for)f(such)g
(cases.)31 b(Its)21 b(\002rst)h(ar)o(gument)c(is)j(the)g(character)555
4896 y(to)e(treat)h(as)g(the)f(end)g(of)g(the)g(list.)30
b(F)o(or)19 b Fs(])g FA(to)g(be)h(recognized)d(as)j(a)f(delimiter)m(,)f
(it)i(must)g(\002rst)g(be)555 5001 y(gi)n(v)o(en)f(this)i(role,)e
(hence)h(the)g(preliminary)e(call)j(to)f Fs(set-macro-charac)o(te)o(r)p
FA(.)p eop
%%Page: 228 241
228 240 bop 555 538 a FA(228)999 b Fu(READ)p Fv(\255)p
Fu(MA)n(CR)n(OS)p 555 745 2678 4 v 553 2067 4 1322 v
605 888 a Fs(\(defmacro)40 b(defdelim)g(\(left)h(right)h(parms)g(&body)
f(body\))692 988 y(`\(ddfn)g(,left)h(,right)f(#'\(lambda)f(,parms)h
(,@body\)\)\))605 1187 y(\(let)h(\(\(rpar)f(\(get-macro-chara)o(ct)o
(er)c(#\\\))43 b(\)\)\))692 1287 y(\(defun)e(ddfn)h(\(left)g(right)f
(fn\))779 1386 y(\(set-macro-charac)o(te)o(r)c(right)42
b(rpar\))779 1486 y(\(set-dispatch-mac)o(ro)o(-c)o(har)o(ac)o(ter)37
b(#\\#)42 b(left)866 1586 y(#'\(lambda)e(\(stream)h(char1)g(char2\))
1041 1685 y(\(apply)g(fn)1346 1785 y(\(read-delimited-)o(li)o(st)c
(right)42 b(stream)f(t\)\)\)\)\)\))940 1989 y FA(Figure)20
b(17.4:)28 b(A)21 b(macro)e(for)h(de\002ning)e(delimiter)i
(read\255macros.)p 3231 2067 V 555 2070 2678 4 v 680
2295 a(Most)33 b(potential)g(delimiter)g(read\255macro)e(de\002nitions)
i(will)i(duplicate)d(a)i(lot)g(of)g(the)555 2399 y(code)d(in)h(Figure)e
(17.3.)63 b(A)32 b(macro)e(could)h(put)g(a)h(more)f(abstract)g(interf)o
(ace)g(on)g(all)h(this)555 2504 y(machinery)-5 b(.)25
b(Figure)16 b(17.4)f(sho)n(ws)h(ho)n(w)g(we)h(might)e(de\002ne)h(a)g
(utility)h(for)e(de\002ning)g(delimiter)555 2608 y(read\255macros.)34
b(The)23 b Fs(defdelim)c FA(macro)j(tak)o(es)h(tw)o(o)g(characters,)f
(a)h(parameter)e(list,)j(and)e(a)555 2713 y(body)14 b(of)h(code.)27
b(The)15 b(parameter)f(list)j(and)d(the)i(body)e(of)h(code)g
(implicitly)g(de\002ne)g(a)h(function.)555 2818 y(A)21
b(call)g(to)f Fs(defdelim)e FA(de\002nes)i(the)h(\002rst)g(character)e
(as)i(a)g(dispatching)e(read\255macro)f(which)555 2922
y(reads)j(up)f(to)h(the)g(second,)f(then)g(returns)g(the)h(result)g(of)
g(applying)e(this)i(function)e(to)i(what)g(it)555 3027
y(read.)680 3131 y(Incidentally)-5 b(,)12 b(the)h(body)f(of)h(the)g
(function)f(in)h(Figure)g(17.3)f(also)i(cries)f(out)g(for)g(a)h
(utility\227)555 3236 y(for)i(one)g(we)h(ha)n(v)o(e)e(already)h
(de\002ned,)g(in)g(f)o(act:)28 b Fs(mapa-b)p FA(,)15
b(from)h(page)f(54.)28 b(Using)16 b Fs(defdelim)555 3341
y FA(and)k Fs(mapa-b)p FA(,)e(the)i(read\255macro)e(de\002ned)h(in)h
(Figure)g(17.3)f(could)g(no)n(w)h(be)g(written:)555 3523
y Fs(\(defdelim)40 b(#\\[)i(#\\])h(\(x)f(y\))642 3623
y(\(list)g('quote)f(\(mapa-b)f(#'identity)g(\(ceiling)g(x\))j(\(floor)e
(y\)\)\)\))680 3811 y FA(Another)13 b(useful)h(delimiter)g
(read\255macro)f(w)o(ould)h(be)g(one)h(for)f(functional)f(composition.)
555 3915 y(Section)20 b(5.4)f(de\002ned)h(an)g(operator)e(for)i
(functional)e(composition:)555 4098 y Fs(>)43 b(\(let)f(\(\(f1)g
(\(compose)e(#'list)h(#'1+\)\))904 4197 y(\(f2)h(#'\(lambda)e(\(x\))i
(\(list)g(\(1+)g(x\)\)\)\)\))729 4297 y(\(equal)f(\(funcall)g(f1)h(7\))
h(\(funcall)e(f2)h(7\)\)\))555 4397 y(T)555 4584 y FA(When)24
b(we)h(are)f(composing)f(b)n(uilt\255in)g(functions)g(lik)o(e)i
Fs(list)e FA(and)h Fs(1+)p FA(,)h(there)f(is)h(no)f(reason)555
4689 y(to)i(w)o(ait)g(until)f(runtime)g(to)h(e)n(v)n(aluate)e(the)i
(call)g(to)g Fs(compose)p FA(.)43 b(Section)25 b(5.7)g(suggested)g(an)
555 4794 y(alternati)n(v)o(e;)19 b(by)h(pre\002xing)e(the)i
(sharp\255dot)f(read\255macro)f(to)i(a)h Fs(compose)c
FA(e)o(xpression,)555 4976 y Fs(#.\(compose)39 b(#'list)j(#'1+\))p
eop
%%Page: 229 242
229 241 bop 555 538 a Ft(17.4)888 b Fu(WHEN)19 b(WHA)-7
b(T)19 b(HAPPENS)871 b FA(229)p 555 745 2678 4 v 553
1270 4 525 v 605 888 a Fs(\(defdelim)40 b(#\\{)i(#\\})g(\(&rest)f
(args\))692 988 y(`\(fn)h(\(compose)e(,@args\)\)\))983
1192 y FA(Figure)19 b(17.5:)29 b(A)20 b(read\255macro)e(for)i
(functional)e(composition.)p 3231 1270 V 555 1273 2678
4 v 555 1498 a(we)j(could)e(cause)h(it)h(to)f(be)g(e)n(v)n(aluated)f
(at)i(read\255time.)680 1602 y(Here)h(we)h(sho)n(w)g(a)g(similar)g(b)n
(ut)g(cleaner)f(solution.)37 b(The)22 b(read\255macro)f(in)i(Figure)f
(17.5)555 1707 y(de\002nes)k(an)f(e)o(xpression)f(of)i(the)g(form)e
Fs(#{)p Ft(f)1835 1728 y Fm(1)1894 1707 y Ft(f)1930 1728
y Fm(2)1989 1707 y Fy(:)14 b(:)g(:)26 b Ft(f)2147 1728
y Fd(n)2181 1707 y Fs(})g FA(to)f(read)h(as)g(the)g(composition)e(of)
555 1811 y Ft(f)590 1833 y Fm(1)623 1811 y Fy(;)14 b
Ft(f)696 1833 y Fm(2)729 1811 y Fy(;)g(:)g(:)g(:)f(;)h
Ft(f)948 1833 y Fd(n)982 1811 y FA(.)29 b(Thus:)555 1994
y Fs(>)43 b(\(funcall)d(#{list)i(1+})g(7\))555 2094 y(\(8\))555
2281 y FA(It)24 b(w)o(orks)f(by)h(generating)d(a)j(call)g(to)g
Fs(fn)g FA(\(page)e(202\),)h(which)h(will)g(create)f(the)h(function)e
(at)555 2386 y(compile\255time.)555 2639 y Fw(17.4)99
b(When)26 b(What)e(Happens)555 2824 y FA(Finally)-5 b(,)14
b(it)g(might)f(be)g(useful)g(to)g(clear)g(up)g(a)h(possibly)f
(confusing)e(issue.)27 b(If)13 b(read\255macros)f(are)555
2924 y(in)m(v)n(ok)o(ed)i(before)g(ordinary)f(macros,)j(ho)n(w)f(is)h
(it)g(that)g(macros)f(can)g(e)o(xpand)f(into)h(e)o(xpressions)555
3024 y(which)20 b(contain)f(read\255macros?)27 b(F)o(or)20
b(e)o(xample,)e(the)j(macro:)555 3190 y Fs(\(defmacro)40
b(quotable)g(\(\))642 3289 y('\(list)h('able\)\))555
3460 y FA(generates)25 b(an)g(e)o(xpansion)e(with)j(a)g(quote)f(in)g
(it.)46 b(Or)26 b(does)f(it?)46 b(In)25 b(f)o(act,)i(what)e(happens)g
(is)555 3565 y(that)20 b(both)f(quotes)h(in)g(the)g(de\002nition)e(of)i
(this)h(macro)e(are)h(e)o(xpanded)d(when)i(the)h Fs(defmacro)555
3669 y FA(e)o(xpression)f(is)i(read,)e(yielding)555 3852
y Fs(\(defmacro)40 b(quotable)g(\(\))642 3952 y(\(quote)h(\(list)h
(\(quote)f(able\)\)\)\))555 4139 y FA(Usually)-5 b(,)32
b(there)e(is)i(no)e(harm)f(in)i(acting)f(as)h(if)f(macroe)o(xpansions)e
(could)h(contain)g(read\255)555 4244 y(macros,)f(because)f(the)g
(de\002nition)f(of)h(a)h(read\255macro)d(will)j(not)e(\(or)h(should)f
(not\))h(change)555 4349 y(between)19 b(read\255time)g(and)h
(compile\255time.)p eop
%%Page: 230 243
230 242 bop 555 1610 a Fn(18)p 555 1872 2686 3 v 555
2131 a Fx(Destructuring)555 2568 y FA(Destructuring)25
b(is)j(a)f(generalization)d(of)j(assignment.)48 b(The)26
b(operators)g Fs(setq)f FA(and)i Fs(setf)555 2672 y FA(do)21
b(assignments)f(to)h(indi)n(vidual)e(v)n(ariables.)31
b(Destructuring)19 b(combines)g(assignment)h(with)555
2777 y(access:)30 b(instead)20 b(of)g(gi)n(ving)e(a)j(single)f(v)n
(ariable)f(as)i(the)f(\002rst)h(ar)o(gument,)c(we)k(gi)n(v)o(e)e(a)h
(pattern)555 2882 y(of)28 b(v)n(ariables,)h(which)e(are)h(each)g
(assigned)g(the)g(v)n(alue)f(occurring)f(in)i(the)g(corresponding)555
2986 y(position)19 b(in)i(some)f(structure.)555 3239
y Fw(18.1)99 b(Destructuring)27 b(on)e(Lists)555 3430
y FA(As)19 b(of)e Fr(CL)-6 b(TL)p FA(2,)17 b(Common)g(Lisp)g(includes)h
(a)g(ne)n(w)f(macro)g(called)h Fs(destructuring-b)o(ind)o
FA(.)555 3534 y(This)30 b(macro)e(w)o(as)j(brie\003y)e(introduced)e(in)
i(Chapter)g(7.)58 b(Here)29 b(we)h(consider)e(it)j(in)e(more)555
3639 y(detail.)35 b(Suppose)21 b(that)h Fs(lst)g FA(is)h(a)f(list)i(of)
d(three)h(elements,)g(and)g(we)g(w)o(ant)g(to)h(bind)e
Fs(x)h FA(to)h(the)555 3743 y(\002rst,)h Fs(y)f FA(to)g(the)g(second,)g
(and)f Fs(z)h FA(to)g(the)g(third.)37 b(In)22 b(ra)o(w)h
Fr(CL)-6 b(TL)p FA(1)22 b(Common)f(Lisp,)j(we)f(w)o(ould)555
3848 y(ha)n(v)o(e)d(had)f(to)i(say:)555 4031 y Fs(\(let)42
b(\(\(x)g(\(first)f(lst\)\))817 4130 y(\(y)h(\(second)f(lst\)\))817
4230 y(\(z)h(\(third)f(lst\)\)\))642 4330 y(...\))555
4517 y FA(W)m(ith)20 b(the)h(ne)n(w)f(macro)f(we)h(can)g(say)h(instead)
555 4700 y Fs(\(destructuring-b)o(ind)37 b(\(x)42 b(y)i(z\))e(lst)642
4799 y(...\))1835 5229 y FA(230)p eop
%%Page: 231 244
231 243 bop 555 538 a Ft(18.2)918 b Fu(O)n(THER)17 b(STR)n(UCTURES)899
b FA(231)555 801 y(which)27 b(is)h(not)e(only)h(shorter)m(,)g(b)n(ut)g
(clearer)g(as)g(well.)51 b(Readers)27 b(grasp)f(visual)h(cues)h(much)
555 905 y(f)o(aster)20 b(than)f(te)o(xtual)h(ones.)28
b(In)20 b(the)g(latter)g(form)f(we)h(are)g(sho)n(wn)f(the)h
(relationship)e(between)555 1010 y Fs(x)p FA(,)i Fs(y)p
FA(,)g(and)g Fs(z)p FA(;)g(in)h(the)f(former)m(,)e(we)i(ha)n(v)o(e)g
(to)g(infer)g(it.)680 1114 y(If)g(such)h(a)g(simple)g(case)g(is)g(made)
g(clearer)f(by)g(the)h(use)g(of)f(destructuring,)f(imagine)h(the)555
1219 y(impro)o(v)o(ement)13 b(in)g(more)g(comp)o(le)o(x)g(o)o(nes.)21
b(The)13 b(\002rst)g(ar)o(gument)g(to)g Fs(destruct)o(ur)o(in)o(g-b)o
(in)o(d)555 1324 y FA(can)20 b(be)g(an)g(arbitrarily)f(comple)o(x)f
(tree.)30 b(Imagine)555 1506 y Fs(\(destructuring-b)o(ind)37
b(\(\(first)j(last\))i(\(month)f(day)h(year\))g(.)h(notes\))1427
1606 y(birthday)642 1706 y(...\))555 1893 y FA(written)34
b(using)g Fs(let)g FA(and)f(the)i(list)g(access)g(functions.)70
b(Which)34 b(raises)h(another)e(point:)555 1998 y(destructuring)18
b(mak)o(es)i(it)h(easier)f(to)h(write)f(programs)e(as)j(well)g(as)g
(easier)f(to)g(read)g(them.)680 2102 y(Destructuring)13
b(did)i(e)o(xist)g(in)g Fr(CL)-6 b(TL)p FA(1)14 b(Common)g(Lisp.)28
b(If)15 b(the)g(patterns)f(in)i(the)f(e)o(xamples)555
2207 y(abo)o(v)o(e)f(look)g(f)o(amiliar)m(,)h(it')-5
b(s)16 b(because)f(the)o(y)f(ha)n(v)o(e)h(the)g(same)g(form)g(as)h
(macro)e(parameter)f(lists.)555 2312 y(In)29 b(f)o(act,)j
Fs(destructuring-bi)o(nd)24 b Ft(is)30 b FA(the)g(code)f(used)g(to)h
(tak)o(e)f(apart)g(macro)g(ar)o(gument)555 2416 y(lists,)21
b(no)n(w)e(sold)h(separately)-5 b(.)28 b(Y)-9 b(ou)20
b(can)f(put)h(an)o(ything)e(in)i(the)g(pattern)f(that)h(you)f(w)o(ould)
g(put)555 2521 y(in)27 b(a)g(macro)f(parameter)f(list,)k(with)e(one)f
(unimportant)f(e)o(xception)g(\(the)h Fs(&environment)555
2625 y FA(k)o(e)o(yw)o(ord\).)680 2730 y(Establishing)d(bindings)g
Ft(en)h(masse)h FA(is)g(an)g(attracti)n(v)o(e)e(idea.)42
b(The)24 b(follo)n(wing)f(sections)555 2835 y(describe)c(se)n(v)o(eral)
h(v)n(ariations)f(upon)g(this)i(theme.)555 3087 y Fw(18.2)99
b(Other)25 b(Structur)n(es)555 3278 y FA(There)13 b(is)i(no)f(reason)f
(to)h(limit)h(destructuring)d(to)i(lists.)28 b(An)o(y)14
b(comple)o(x)e(object)h(is)i(a)g(candidate)555 3383 y(for)25
b(it.)47 b(This)26 b(section)g(sho)n(ws)g(ho)n(w)g(to)g(write)g(macros)
f(lik)o(e)h Fs(destructuring-bin)o(d)20 b FA(for)555
3487 y(other)f(kinds)h(of)g(objects.)680 3592 y(The)e(natural)h(ne)o
(xt)f(step)i(is)g(to)f(handle)g(sequences)f(generally)-5
b(.)27 b(Figure)19 b(18.1)f(contains)g(a)555 3696 y(macro)g(called)h
Fs(dbind)p FA(,)f(which)h(resembles)f Fs(destructuring-bin)o(d)p
FA(,)c(b)n(ut)19 b(w)o(orks)g(for)f(an)o(y)555 3801 y(kind)e(of)g
(sequence.)27 b(The)17 b(second)f(ar)o(gument)e(can)i(be)h(a)g(list,)i
(a)e(v)o(ector)m(,)e(or)i(an)o(y)f(combination)555 3906
y(thereof:)555 4088 y Fs(>)43 b(\(dbind)e(\(a)i(b)g(c\))g(#\(1)f(2)h
(3\))729 4188 y(\(list)f(a)h(b)g(c\)\))555 4288 y(\(1)g(2)g(3\))555
4387 y(>)g(\(dbind)e(\(a)i(\(b)g(c\))g(d\))f('\()h(1)g(#\(2)g(3\))f
(4\))729 4487 y(\(list)g(a)h(b)g(c)g(d\)\))555 4586 y(\(1)g(2)g(3)g
(4\))555 4686 y(>)g(\(dbind)e(\(a)i(\(b)g(.)g(c\))g(&rest)e(d\))i('\(1)
f("fribble")e(2)j(3)h(4\))729 4786 y(\(list)e(a)h(b)g(c)g(d\)\))555
4885 y(\(1)g(#\\f)f("ribble")e(\(2)j(3)g(4\)\))p eop
%%Page: 232 245
232 244 bop 555 538 a FA(232)969 b Fu(DESTR)n(UCTURING)p
555 824 2678 4 v 553 4836 4 4012 v 605 967 a Fs(\(defmacro)40
b(dbind)h(\(pat)h(seq)g(&body)g(body\))692 1066 y(\(let)g(\(\(gseq)f
(\(gensym\)\)\))779 1166 y(`\(let)h(\(\(,gseq)e(,seq\)\))910
1266 y(,\(dbind-ex)f(\(destruc)i(pat)h(gseq)g(#'atom\))f(body\)\)\)\))
605 1465 y(\(defun)g(destruc)g(\(pat)h(seq)g(&optional)e(\(atom?)h
(#'atom\))g(\(n)h(0\)\))692 1565 y(\(if)g(\(null)g(pat\))866
1664 y(nil)866 1764 y(\(let)g(\(\(rest)f(\(cond)h(\(\(funcall)e(atom?)h
(pat\))h(pat\))1651 1863 y(\(\(eq)g(\(car)g(pat\))g('&rest\))e(\(cadr)i
(pat\)\))1651 1963 y(\(\(eq)g(\(car)g(pat\))g('&body\))e(\(cadr)i
(pat\)\))1651 2063 y(\(t)h(nil\)\)\)\))910 2162 y(\(if)f(rest)1084
2262 y(`\(\(,rest)f(\(subseq)f(,seq)i(,n\)\)\))1084 2362
y(\(let)g(\(\(p)h(\(car)e(pat\)\))1346 2461 y(\(rec)h(\(destruc)e
(\(cdr)i(pat\))g(seq)g(atom?)g(\(1+)g(n\)\)\)\))1171
2561 y(\(if)h(\(funcall)d(atom?)i(p\))1346 2660 y(\(cons)f(`\(,p)h
(\(elt)g(,seq)g(,n\)\))1607 2760 y(rec\))1346 2860 y(\(let)g(\(\(var)f
(\(gensym\)\)\))1433 2959 y(\(cons)g(\(cons)h(`\(,var)f(\(elt)h(,seq)g
(,n\)\))1956 3059 y(\(destruc)e(p)j(var)g(atom?\)\))1694
3159 y(rec\)\)\)\)\)\)\)\))605 3358 y(\(defun)e(dbind-ex)f(\(binds)h
(body\))692 3457 y(\(if)h(\(null)g(binds\))866 3557 y(`\(progn)f
(,@body\))866 3657 y(`\(let)h(,\(mapcar)e(#'\(lambda)g(\(b\))1694
3756 y(\(if)j(\(consp)e(\(car)h(b\)\))1869 3856 y(\(car)g(b\))1869
3956 y(b\)\))1520 4055 y(binds\))954 4155 y(,\(dbind-ex)d(\(mapcan)i
(#'\(lambda)f(\(b\))1956 4254 y(\(if)i(\(consp)f(\(car)h(b\)\))2130
4354 y(\(cdr)g(b\)\)\))1782 4454 y(binds\))1433 4553
y(body\)\)\)\))996 4758 y FA(Figure)19 b(18.1:)28 b(General)20
b(sequence)f(destructuring)f(operator)-5 b(.)p 3231 4836
V 555 4839 2678 4 v eop
%%Page: 233 246
233 245 bop 555 538 a Ft(18.2)918 b Fu(O)n(THER)17 b(STR)n(UCTURES)899
b FA(233)555 801 y(The)17 b Fs(#\()g FA(read\255macro)e(is)j(for)f
(representing)e(v)o(ectors,)i(and)g Fs(#\\)g FA(for)f(representing)g
(characters.)555 905 y(Since)h Fs("abc")e FA(=)i Fs(#\(#\\a)41
b(#\\b)h(#\\c\))p FA(,)16 b(the)h(\002rst)g(element)f(of)g
Fs("fribble")e FA(is)j(the)g(character)555 1010 y Fs(#\\f)p
FA(.)69 b(F)o(or)33 b(the)h(sak)o(e)g(of)f(simplicity)-5
b(,)36 b Fs(dbind)d FA(supports)f(only)h(the)h Fs(&rest)e
FA(and)h Fs(&body)555 1114 y FA(k)o(e)o(yw)o(ords.)680
1219 y(Compared)15 b(to)j(most)f(of)g(the)h(macros)f(seen)g(so)h(f)o
(ar)m(,)f Fs(dbind)f FA(is)i(big.)28 b(It')-5 b(s)18
b(w)o(orth)f(studying)555 1324 y(the)24 b(implementation)d(of)i(this)h
(macro,)f(not)g(only)g(to)h(understand)d(ho)n(w)i(it)h(w)o(orks,)g(b)n
(ut)f(also)555 1428 y(because)k(it)h(embodies)e(a)i(general)f(lesson)h
(about)e(Lisp)i(programming.)48 b(As)28 b(section)f(3.4)555
1533 y(mentioned,)d(Lisp)h(programs)d(may)j(intentionally)e(be)h
(written)h(in)g(a)g(w)o(ay)g(that)g(will)g(mak)o(e)555
1638 y(them)e(easy)h(to)g(test.)41 b(In)24 b(most)f(code,)h(we)g(ha)n
(v)o(e)g(to)f(balance)g(this)i(desire)e(against)g(the)h(need)555
1742 y(for)30 b(speed.)59 b(F)o(ortunately)-5 b(,)30
b(as)h(Section)f(7.8)g(e)o(xplained,)h(speed)f(is)h(not)f(so)h
(important)d(in)555 1847 y(e)o(xpander)14 b(code.)28
b(When)16 b(writing)g(code)g(that)h(generates)f(macroe)o(xpansions,)d
(we)18 b(can)e(mak)o(e)555 1951 y(life)22 b(easier)h(for)e(ourselv)o
(es.)34 b(The)21 b(e)o(xpansion)g(of)g Fs(dbind)g FA(is)i(generated)d
(by)i(tw)o(o)g(functions,)555 2056 y Fs(destruc)16 b
FA(and)j Fs(dbind-ex)p FA(.)25 b(Perhaps)19 b(the)o(y)f(both)g(could)f
(be)i(combined)e(into)h(one)g(function)555 2161 y(which)25
b(w)o(ould)g(do)g(e)n(v)o(erything)d(in)k(a)g(single)f(pass.)46
b(But)26 b(why)e(bother?)44 b(As)26 b(tw)o(o)g(separate)555
2265 y(functions,)17 b(the)o(y)g(will)i(be)g(easier)f(to)g(test.)30
b(Why)17 b(trade)h(this)h(adv)n(antage)d(for)i(speed)g(we)g(don')o(t)
555 2370 y(need?)680 2474 y(The)f(\002rst)i(function,)d
Fs(destruc)p FA(,)g(tra)n(v)o(erses)h(the)h(pattern)f(and)h(associates)
g(each)g(v)n(ariable)555 2579 y(with)i(the)h(location)e(of)h(the)g
(corresponding)d(object)i(at)i(runtime:)555 2757 y Fs(>)43
b(\(destruc)d('\(a)j(b)g(c\))g('seq)f(#'atom\))555 2857
y(\(\(A)g(\(ELT)g(SEQ)h(0\)\))f(\(B)h(\(ELT)f(SEQ)g(1\)\))g(\(C)h
(\(ELT)f(SEQ)g(2\)\)\))555 3041 y FA(The)22 b(optional)f(third)h(ar)o
(gument)e(is)j(the)f(predicate)f(used)h(to)h(distinguish)e(pattern)h
(structure)555 3145 y(from)d(pattern)g(content.)680 3250
y(T)-7 b(o)26 b(mak)o(e)g(access)h(more)f(ef)n(\002cient,)i(a)f(ne)n(w)
f(v)n(ariable)f(\(a)i(gensym\))e(will)i(be)g(bound)d(to)555
3354 y(each)c(subsequence:)555 3533 y Fs(>)43 b(\(destruc)d('\(a)j(\(b)
g(.)g(c\))f(&rest)g(d\))h('seq\))555 3632 y(\(\(A)f(\(ELT)g(SEQ)h
(0\)\))599 3732 y(\(\(#:G2)e(\(ELT)h(SEQ)g(1\)\))g(\(B)h(\(ELT)f(#:G2)g
(0\)\))g(\(C)h(\(SUBSEQ)e(#:G2)h(1\)\)\))599 3832 y(\(D)g(\(SUBSEQ)f
(SEQ)h(2\)\)\))555 4015 y FA(The)31 b(output)e(of)i Fs(destruc)d
FA(is)k(sent)g(to)f Fs(dbind-ex)p FA(,)f(which)h(generates)f(the)g(b)n
(ulk)h(of)g(the)555 4120 y(macroe)o(xpansion.)h(It)23
b(translates)g(the)f(tree)h(produced)d(by)i Fs(destruc)e
FA(into)i(a)h(nested)f(series)555 4224 y(of)e Fs(let)p
FA(s:)555 4403 y Fs(>)43 b(\(dbind-ex)d(\(destruc)g('\(a)j(\(b)f(.)i
(c\))e(&rest)g(d\))h('seq\))e('\(body\)\))555 4503 y(\(LET)h(\(\(A)g
(\(ELT)g(SEQ)h(0\)\))817 4602 y(\(#:G4)e(\(ELT)h(SEQ)g(1\)\))817
4702 y(\(D)g(\(SUBSEQ)f(SEQ)h(2\)\)\))642 4801 y(\(LET)g(\(\(B)g(\(ELT)
g(#:G4)g(0\)\))904 4901 y(\(C)g(\(SUBSEQ)f(#:G4)h(1\)\)\))729
5001 y(\(PROGN)f(BODY\)\)\))p eop
%%Page: 234 247
234 246 bop 555 538 a FA(234)969 b Fu(DESTR)n(UCTURING)p
555 745 2678 4 v 553 3362 4 2617 v 605 888 a Fs(\(defmacro)40
b(with-matrix)f(\(pats)i(ar)i(&body)f(body\))692 988
y(\(let)g(\(\(gar)f(\(gensym\)\)\))779 1087 y(`\(let)h(\(\(,gar)f
(,ar\)\))910 1187 y(\(let)h(,\(let)f(\(\(row)h(-1\)\))1259
1287 y(\(mapcan)1346 1386 y(#'\(lambda)e(\(pat\))1520
1486 y(\(incf)i(row\))1520 1586 y(\(setq)g(col)g(-1\))1520
1685 y(\(mapcar)f(#'\(lambda)f(\(p\))2043 1785 y(`\(,p)i(\(aref)g(,gar)
2523 1884 y(,row)2523 1984 y(,\(incf)f(col\)\)\)\))1912
2084 y(pat\)\))1346 2183 y(pats\)\))997 2283 y(,@body\)\)\)\))605
2482 y(\(defmacro)f(with-array)f(\(pat)j(ar)h(&body)e(body\))692
2582 y(\(let)h(\(\(gar)f(\(gensym\)\)\))779 2681 y(`\(let)h(\(\(,gar)f
(,ar\)\))910 2781 y(\(let)h(,\(mapcar)e(#'\(lambda)g(\(p\))1694
2881 y(`\(,\(car)h(p\))i(\(aref)e(,gar)h(,@\(cdr)f(p\)\)\)\))1520
2980 y(pat\))997 3080 y(,@body\)\)\)\))1273 3284 y FA(Figure)20
b(18.2:)28 b(Destructuring)19 b(on)g(arrays.)p 3231 3362
V 555 3366 2678 4 v 680 3590 a(Note)g(that)g Fs(dbind)p
FA(,)e(lik)o(e)j Fs(destructuring-b)o(ind)o FA(,)14 b(assumes)19
b(that)g(it)h(will)g(\002nd)f(all)h(the)555 3694 y(list)h(structure)d
(it)i(is)h(looking)c(for)-5 b(.)29 b(Left\255o)o(v)o(er)17
b(v)n(ariables)i(are)g(not)g(simply)g(bound)f(to)h Fs(nil)p
FA(,)g(as)555 3799 y(with)h Fs(multiple-value-b)o(in)o(d)p
FA(.)k(If)19 b(the)h(sequence)f(gi)n(v)o(en)f(at)i(runtime)f(does)g
(not)h(ha)n(v)o(e)f(all)555 3904 y(the)h(e)o(xpected)f(elements,)g
(destructuring)f(operators)h(generate)g(an)h(error:)555
4086 y Fs(>)43 b(\(dbind)e(\(a)i(b)g(c\))g(\(list)e(1)j(2\)\))555
4186 y(>>Error:)c(2)j(is)g(not)g(a)g(valid)e(index)h(for)g(the)g
(sequence)f(\(1)h(2\))680 4374 y FA(What)20 b(other)f(objects)h(ha)n(v)
o(e)f(internal)g(structure?)29 b(There)19 b(are)h(arrays)f(generally)-5
b(,)18 b(which)555 4478 y(dif)n(fer)13 b(from)g(v)o(ectors)g(in)g(ha)n
(ving)f(mo)o(re)h(tha)o(n)g(o)o(ne)g(d)o(imen)o(sion.)21
b(If)13 b(we)g(de\002ne)g(a)g(destructuring)555 4583
y(macro)22 b(for)f(arrays,)i(ho)n(w)f(do)g(we)h(represent)e(the)i
(pattern?)35 b(F)o(or)22 b(tw)o(o\255dimensional)e(arrays,)555
4687 y(it)j(is)h(still)f(practical)f(to)h(use)g(a)g(list.)37
b(Figure)21 b(18.2)h(contains)g(a)h(macro,)e Fs(with-matrix)p
FA(,)e(for)555 4792 y(destructuring)f(on)i(tw)o(o\255dimensional)e
(arrays.)p eop
%%Page: 235 248
235 247 bop 555 538 a Ft(18.2)918 b Fu(O)n(THER)17 b(STR)n(UCTURES)899
b FA(235)p 555 745 2678 4 v 553 1768 4 1023 v 605 888
a Fs(\(defmacro)40 b(with-struct)f(\(\(name)i(.)i(fields\))e(struct)g
(&body)g(body\))692 988 y(\(let)h(\(\(gs)g(\(gensym\)\)\))779
1087 y(`\(let)g(\(\(,gs)f(,struct\)\))910 1187 y(\(let)h(,\(mapcar)e
(#'\(lambda)g(\(f\))1694 1287 y(`\(,f)i(\(,\(symb)f(name)h(f\))h
(,gs\)\)\))1520 1386 y(fields\))997 1486 y(,@body\)\)\)\))1213
1690 y FA(Figure)20 b(18.3:)28 b(Destructuring)19 b(on)g(structures.)p
3231 1768 V 555 1772 2678 4 v 555 1996 a Fs(>)43 b(\(setq)f(ar)g
(\(make-array)d('\(3)k(3\)\)\))555 2095 y(#<Simple-Array)38
b(T)43 b(\(3)g(3\))f(C2D39E>)555 2195 y(>)h(\(for)f(\(r)h(0)g(2\))729
2295 y(\(for)f(\(c)h(0)g(2\))817 2394 y(\(setf)e(\(aref)h(ar)g(r)h(c\))
g(\(+)g(\(*)g(r)g(10\))f(c\)\)\)\))555 2494 y(NIL)555
2594 y(>)h(\(with-matrix)c(\(\(a)j(b)h(c\))1252 2693
y(\(d)g(e)g(f\))1252 2793 y(\(g)g(h)g(i\)\))g(ar)729
2892 y(\(list)f(a)h(b)g(c)g(d)h(e)f(f)g(g)g(h)g(i\)\))555
2992 y(\(0)g(1)g(2)g(10)g(11)g(12)f(20)h(21)g(22\))680
3180 y FA(F)o(or)18 b(lar)o(ge)g(arrays)h(or)g(those)g(with)g
(dimension)e(3)j(or)e(higher)m(,)g(we)h(w)o(ant)g(a)h(dif)n(ferent)d
(kind)555 3284 y(of)g(approach.)26 b(W)-7 b(e)19 b(are)f(not)f(lik)o
(ely)g(to)h(w)o(ant)g(to)g(bind)e(v)n(ariables)h(to)h(each)f(element)g
(of)h(a)g(lar)o(ge)555 3389 y(array)-5 b(.)32 b(It)22
b(will)h(be)e(more)g(practical)g(to)h(mak)o(e)f(the)h(pattern)f(a)h
(sparse)g(representation)d(of)j(the)555 3493 y(array\227containing)c(v)
n(ariables)j(for)f(only)h(a)h(fe)n(w)f(elements,)g(plus)h(coordinates)d
(to)j(identify)555 3598 y(them.)34 b(The)22 b(second)f(macro)g(in)h
(Figure)g(18.2)f(is)i(b)n(uilt)f(on)f(this)i(principle.)33
b(Here)22 b(we)h(use)f(it)555 3703 y(to)e(get)h(the)f(diagonal)e(of)i
(our)g(pre)n(vious)e(array:)555 3885 y Fs(>)43 b(\(with-array)c(\(\(a)k
(0)g(0\))f(\(d)h(1)g(1\))g(\(i)g(2)g(2\)\))f(ar)729 3985
y(\(values)f(a)i(d)g(i\)\))555 4085 y(0)555 4184 y(11)555
4284 y(22)680 4471 y FA(W)m(ith)35 b(this)g(ne)n(w)g(macro)f(we)h(ha)n
(v)o(e)f(be)o(gun)g(to)h(mo)o(v)o(e)e(a)o(w)o(ay)i(from)f(patterns)g
(whose)555 4576 y(elements)17 b(must)h(occur)f(in)h(a)g(\002x)o(ed)f
(order)-5 b(.)27 b(W)-7 b(e)19 b(can)e(mak)o(e)h(a)g(similar)g(sort)f
(of)h(macro)f(to)g(bind)555 4681 y(v)n(ariables)23 b(to)h(\002elds)g
(in)g(structures)g(b)n(uilt)g(by)f Fs(defstruct)p FA(.)37
b(Such)24 b(a)g(macro)f(is)i(de\002ned)d(in)555 4785
y(Figure)f(18.3.)32 b(The)21 b(\002rst)h(ar)o(gument)e(in)h(the)h
(pattern)f(is)h(tak)o(en)f(to)h(be)f(the)h(pre\002x)f(associated)555
4890 y(with)h(the)h(structure,)e(and)h(the)g(rest)h(are)f(\002eld)h
(names.)35 b(T)-7 b(o)23 b(b)n(uild)e(access)i(calls,)h(this)f(macro)
555 4995 y(uses)e Fs(symb)e FA(\(page)g(58\).)p eop
%%Page: 236 249
236 248 bop 555 538 a FA(236)969 b Fu(DESTR)n(UCTURING)555
801 y Fs(>)43 b(\(defstruct)d(visitor)84 b(name)42 b(title)f(firm\))555
900 y(VISITOR)555 1000 y(>)i(\(setq)f(theo)g(\(make-visitor)c(:name)85
b("Theodebert")1732 1100 y(:title)41 b('king)1732 1199
y(:firm)85 b('franks\)\))555 1299 y(#S\(VISITOR)39 b(NAME)j
("Theodebert")d(TITLE)j(KING)f(FIRM)h(FRANKS\))555 1398
y(>)h(\(with-struct)c(\(visitor-)h(name)i(firm)g(title\))f(theo)729
1498 y(\(list)h(name)g(firm)g(title\)\))555 1598 y(\("Theodebert")c
(FRANKS)j(KING\))555 1933 y Fw(18.3)99 b(Refer)n(ence)555
2124 y FA(C)p Fr(LOS)26 b FA(brings)g(with)g(it)h(a)f(macro)f(for)h
(destructuring)e(on)h(instances.)47 b(Suppose)25 b Fs(tree)g
FA(is)i(a)555 2229 y(class)16 b(with)e(three)h(slots,)h
Fs(species)p FA(,)d Fs(age)p FA(,)i(and)f Fs(height)p
FA(,)g(and)g(that)g Fs(my-tree)f FA(is)i(an)g(instance)555
2333 y(of)20 b Fs(tree)p FA(.)28 b(W)m(ithin)555 2516
y Fs(\(with-slots)39 b(\(species)h(age)j(height\))d(my-tree)642
2616 y(...\))555 2803 y FA(we)17 b(can)g(refer)f(to)h(the)g(slots)g(of)
g Fs(my-tree)d FA(as)k(if)f(the)o(y)f(were)h(ordinary)e(v)n(ariables.)
27 b(W)m(ithin)17 b(the)555 2908 y(body)j(of)h(the)g
Fs(with-slots)p FA(,)c(the)k(symbol)g Fs(height)e FA(refers)h(to)i(the)
f Fs(height)e FA(slot.)32 b(It)22 b(is)g(not)555 3012
y(simply)e(bound)e(to)i(the)h(v)n(alue)e(stored)h(there,)f(b)n(ut)i
Ft(r)m(efer)o(s)g FA(to)f(the)h(slot,)f(so)h(that)f(if)g(we)h(write:)
555 3195 y Fs(\(setq)42 b(height)f(72\))555 3383 y FA(then)16
b(the)h Fs(height)d FA(slot)j(of)g Fs(my-tree)d FA(will)j(be)g(gi)n(v)o
(en)e(the)i(v)n(alue)f Fs(72)p FA(.)27 b(This)17 b(macro)f(w)o(orks)g
(by)555 3487 y(de\002ning)d Fs(height)f FA(as)i(a)h(symbol\255macro)c
(\(Section)i(7.11\))f(which)i(e)o(xpands)e(into)i(a)g(slot)g(refer)n
(\255)555 3592 y(ence.)29 b(In)19 b(f)o(act,)h(it)g(w)o(as)h(to)f
(support)e(macros)h(lik)o(e)h Fs(with-slots)c FA(that)k
Fs(symbol-macrolet)555 3696 y FA(w)o(as)h(added)e(to)h(Common)f(Lisp.)
680 3801 y(Whether)j(or)h(not)g Fs(with-slots)d FA(is)k(really)f(a)h
(destructuring)d(macro,)i(it)h(has)f(the)g(same)555 3906
y(role)k(pragmatically)e(as)i Fs(destructuring-bin)o(d)p
FA(.)44 b(As)27 b(con)m(v)o(entional)d(destructuring)h(is)555
4010 y(to)19 b(call\255by\255v)n(alue,)e(this)j(ne)n(w)f(kind)f(is)j
(to)e(call\255by\255name.)26 b(Whate)n(v)o(er)19 b(we)g(call)h(it,)g
(it)g(looks)e(to)555 4115 y(be)i(useful.)29 b(What)20
b(other)g(macros)f(can)h(we)h(de\002ne)e(on)h(the)g(same)h(principle?)
680 4219 y(W)-7 b(e)18 b(can)e(create)h(a)g(call\255by\255name)d(v)o
(ersion)i(of)h(an)o(y)f(destructuring)e(macro)i(by)g(making)g(it)555
4324 y(e)o(xpand)i(into)h(a)i Fs(symbol-macrolet)14 b
FA(rather)19 b(than)g(a)i Fs(let)p FA(.)28 b(Figure)19
b(18.4)g(sho)n(ws)h(a)g(v)o(ersion)555 4429 y(of)f Fs(dbind)e
FA(modi\002ed)h(to)h(beha)n(v)o(e)f(lik)o(e)i Fs(with-slots)p
FA(.)25 b(W)-7 b(e)20 b(can)f(use)g Fs(with-places)c
FA(as)20 b(we)555 4533 y(do)g Fs(dbind)p FA(:)555 4716
y Fs(>)43 b(\(with-places)c(\(a)k(b)g(c\))f(#\(1)h(2)g(3\))729
4816 y(\(list)f(a)h(b)g(c\)\))555 4915 y(\(1)g(2)g(3\))p
eop
%%Page: 237 250
237 249 bop 555 538 a Ft(18.3)1044 b Fu(REFERENCE)1025
b FA(237)p 555 745 2678 4 v 553 2864 4 2119 v 605 888
a Fs(\(defmacro)40 b(with-places)f(\(pat)j(seq)g(&body)g(body\))692
988 y(\(let)g(\(\(gseq)f(\(gensym\)\)\))779 1087 y(`\(let)h(\(\(,gseq)e
(,seq\)\))910 1187 y(,\(wplac-ex)f(\(destruc)i(pat)h(gseq)g(#'atom\))f
(body\)\)\)\))605 1386 y(\(defun)g(wplac-ex)f(\(binds)h(body\))692
1486 y(\(if)h(\(null)g(binds\))866 1586 y(`\(progn)f(,@body\))866
1685 y(`\(symbol-macrolet)c(,\(mapcar)j(#'\(lambda)g(\(b\))2218
1785 y(\(if)i(\(consp)f(\(car)h(b\)\))2392 1884 y(\(car)g(b\))2392
1984 y(b\)\))2043 2084 y(binds\))954 2183 y(,\(wplac-ex)d(\(mapcan)i
(#'\(lambda)f(\(b\))1956 2283 y(\(if)i(\(consp)f(\(car)h(b\)\))2130
2383 y(\(cdr)g(b\)\)\))1782 2482 y(binds\))1433 2582
y(body\)\)\)\))1037 2786 y FA(Figure)20 b(18.4:)28 b(Reference)19
b(destructuring)f(on)i(sequences.)p 3231 2864 V 555 2867
2678 4 v 555 3090 a(But)g(the)f(ne)n(w)h(macro)e(also)i(gi)n(v)o(es)f
(us)h(the)f(option)f(to)i Fs(setf)e FA(positions)h(in)h(sequences,)e
(as)i(we)555 3195 y(do)g(slots)h(in)f Fs(with-slots)p
FA(:)555 3375 y Fs(>)43 b(\(let)f(\(\(lst)g('\(1)g(\(2)h(3\))f(4\)\)\))
729 3475 y(\(with-places)d(\(a)k(\(b)f(.)i(c\))e(d\))h(lst)817
3575 y(\(setf)e(a)i('uno\))817 3674 y(\(setf)e(c)i('\(tre\)\)\))729
3774 y(lst\))555 3874 y(\(UNO)f(\(2)h(TRE\))f(4\))555
4059 y FA(As)18 b(in)f(a)h Fs(with-slots)p FA(,)c(the)j(v)n(ariables)f
(no)n(w)h(refer)f(to)i(the)f(corresponding)d(locations)i(in)i(the)555
4164 y(structure.)31 b(There)20 b(is)i(one)e(important)g(dif)n
(ference,)f(ho)n(we)n(v)o(er:)29 b(you)20 b(must)h(use)g
Fs(setf)f FA(rather)555 4268 y(than)27 b Fs(setq)g FA(to)g(set)i(these)
e(pseudo\255v)n(ariables.)49 b(The)27 b Fs(with-slots)d
FA(macro)i(must)i(in)m(v)n(ok)o(e)555 4373 y(a)d(code\255w)o(alk)o(er)e
(\(page)g(273\))g(to)i(transform)e Fs(setq)p FA(s)h(into)g
Fs(setf)p FA(s)g(within)g(its)i(body)-5 b(.)40 b(Here,)555
4478 y(writing)20 b(a)g(code\255w)o(alk)o(er)f(w)o(ould)g(be)h(a)h(lot)
f(of)g(code)g(for)f(a)i(small)g(re\002nement.)680 4582
y(If)e Fs(with-places)c FA(is)20 b(more)f(general)f(than)h
Fs(dbind)p FA(,)f(why)h(not)g(just)g(use)h(it)g(all)g(the)g(time?)555
4687 y(While)i Fs(dbind)e FA(associates)i(a)g(v)n(ariable)e(with)h(a)h
(v)n(alue,)f Fs(with-places)c FA(associates)22 b(it)g(with)555
4791 y(a)17 b(set)h(of)e(instructions)g(for)h(\002nding)e(a)i(v)n
(alue.)28 b(Ev)o(ery)15 b(reference)g(requires)h(a)i(lookup.)26
b(Where)555 4896 y Fs(dbind)h FA(w)o(ould)g(bind)g Fs(c)i
FA(to)f(the)g(v)n(alue)g(of)f Fs(\(elt)42 b(x)i(2\))p
FA(,)29 b Fs(with-places)24 b FA(will)29 b(mak)o(e)f
Fs(c)g FA(a)555 5001 y(symbol\255macro)21 b(that)i(e)o(xpands)f(into)i
Fs(\(elt)41 b(x)j(2\))p FA(.)38 b(So)24 b(if)g Fs(c)g
FA(is)g(e)n(v)n(aluated)e Ft(n)i FA(times)g(in)g(the)p
eop
%%Page: 238 251
238 250 bop 555 538 a FA(238)969 b Fu(DESTR)n(UCTURING)555
801 y FA(body)-5 b(,)14 b(that)h(will)g(entail)g Ft(n)g
FA(calls)g(to)g Fs(elt)p FA(.)27 b(Unless)15 b(you)f(actually)g(w)o
(ant)h(to)g Fs(setf)f FA(the)g(v)n(ariables)555 905 y(created)19
b(by)h(destructuring,)e Fs(dbind)h FA(will)h(be)h(f)o(aster)-5
b(.)680 1010 y(The)23 b(de\002nition)f(of)h Fs(with-places)c
FA(is)24 b(only)f(slightly)g(changed)e(from)i(that)g(of)g
Fs(dbind)555 1114 y FA(\(Figure)35 b(18.1\).)77 b(W)m(ithin)36
b Fs(wplac-ex)e FA(\(formerly)g Fs(dbind-ex)p FA(\))g(the)i
Fs(let)g FA(has)h(become)555 1219 y(a)d Fs(symbol-macrolet)p
FA(.)63 b(By)34 b(similar)f(alterations,)j(we)e(could)e(mak)o(e)h(a)h
(call\255by\255name)555 1324 y(v)o(ersion)19 b(of)h(an)o(y)f(normal)g
(destructuring)f(macro.)555 1576 y Fw(18.4)99 b(Matching)555
1767 y FA(As)25 b(destructuring)d(is)k(a)e(generalization)f(of)h
(assignment,)g Ft(pattern\255matc)o(hing)d FA(is)26 b(a)f(gener)n(\255)
555 1872 y(alization)20 b(of)h(destructuring.)28 b(The)20
b(term)h(\223pattern\255matching\224)c(has)k(man)o(y)e(senses.)32
b(In)20 b(this)555 1976 y(conte)o(xt,)h(it)h(means)f(comparing)f(tw)o
(o)i(structures,)f(possibly)g(containing)f(v)n(ariables,)h(to)h(see)555
2081 y(if)29 b(there)e(is)j(some)e(w)o(ay)g(of)g(assigning)g(v)n(alues)
g(to)g(the)h(v)n(ariables)e(which)h(mak)o(es)g(the)g(tw)o(o)555
2185 y(equal.)h(F)o(or)19 b(e)o(xample,)g(if)h Fs(?x)g
FA(and)g Fs(?y)g FA(are)g(v)n(ariables,)f(then)h(the)g(tw)o(o)h(lists)
555 2368 y Fs(\(p)43 b(?x)g(?y)f(c)h(?x\))555 2468 y(\(p)86
b(a)h(b)43 b(c)87 b(a\))555 2655 y FA(match)20 b(when)f
Fs(?x)h FA(=)h Fs(a)f FA(and)g Fs(?y)g FA(=)g Fs(b)p
FA(.)30 b(And)19 b(the)h(lists)555 2838 y Fs(\(p)43 b(?x)g(b)g(?y)f
(a\))555 2938 y(\(p)h(?y)g(b)86 b(c)43 b(a\))555 3125
y FA(match)20 b(when)f Fs(?x)h FA(=)h Fs(?y)f FA(=)g
Fs(c)p FA(.)680 3230 y(Suppose)c(a)i(program)d(w)o(orks)i(by)g(e)o
(xchanging)e(messages)j(with)f(some)h(outside)f(source.)555
3334 y(T)-7 b(o)22 b(respond)f(to)i(a)f(message,)h(the)f(program)e(has)
j(to)f(tell)h(what)g(kind)e(of)h(message)h(it)g(is,)g(and)555
3439 y(also)e(to)f(e)o(xtract)f(its)j(speci\002c)e(content.)29
b(W)m(ith)20 b(a)h(matching)e(operator)f(we)j(can)f(combine)f(the)555
3544 y(tw)o(o)h(steps.)680 3648 y(T)-7 b(o)26 b(be)g(able)h(to)f(write)
h(such)f(an)g(operator)e(we)j(ha)n(v)o(e)f(to)g(in)m(v)o(ent)f(some)h
(w)o(ay)h(of)f(distin\255)555 3753 y(guishing)d(v)n(ariables.)40
b(W)-7 b(e)25 b(can')o(t)e(just)h(say)h(that)f(all)g(symbols)g(are)g(v)
n(ariables,)g(because)f(we)555 3858 y(will)i(w)o(ant)f(symbols)g(to)g
(occur)f(as)i(ar)o(guments)d(within)i(patterns.)40 b(Here)24
b(we)g(will)h(say)f(that)555 3962 y(a)f(pattern)f(v)n(ariable)g(is)i(a)
f(symbol)f(be)o(ginning)f(with)i(a)g(question)f(mark.)36
b(If)23 b(it)h(becomes)e(in\255)555 4067 y(con)m(v)o(enient,)e(this)j
(con)m(v)o(ention)c(could)i(be)i(changed)d(simply)i(by)g(rede\002ning)e
(the)j(predicate)555 4171 y Fs(var?)p FA(.)680 4276 y(Figure)g(18.5)g
(contains)h(a)g(pattern\255matching)d(function)i(similar)h(to)g(ones)g
(that)h(appear)555 4381 y(in)18 b(se)n(v)o(eral)f(introductions)f(to)i
(Lisp.)28 b(W)-7 b(e)19 b(gi)n(v)o(e)e Fs(match)g FA(tw)o(o)h(lists,)h
(and)f(if)g(the)o(y)f(can)g(be)h(made)-2786 b Fq(\016)555
4485 y FA(to)20 b(match,)g(we)g(will)h(get)f(back)g(a)h(list)g(sho)n
(wing)e(ho)n(w:)555 4668 y Fs(>)43 b(\(match)e('\(p)i(a)g(b)g(c)g(a\))g
('\(p)f(?x)h(?y)g(c)g(?x\)\))555 4767 y(\(\(?Y)f(.)h(B\))g(\(?X)f(.)h
(A\)\))555 4867 y(T)p eop
%%Page: 239 252
239 251 bop 555 538 a Ft(18.4)1058 b Fu(MA)-7 b(TCHING)1040
b FA(239)p 555 745 2678 4 v 553 3163 4 2418 v 605 888
a Fs(\(defun)41 b(match)g(\(x)i(y)g(&optional)d(binds\))692
988 y(\(acond2)779 1087 y(\(\(or)i(\(eql)g(x)h(y\))g(\(eql)f(x)h('_\))f
(\(eql)g(y)i('_\)\))d(\(values)g(binds)h(t\)\))779 1187
y(\(\(binding)e(x)j(binds\))e(\(match)g(it)i(y)g(binds\)\))779
1287 y(\(\(binding)d(y)j(binds\))e(\(match)g(x)j(it)e(binds\)\))779
1386 y(\(\(varsym?)e(x\))j(\(values)d(\(cons)i(\(cons)g(x)h(y\))f
(binds\))g(t\)\))779 1486 y(\(\(varsym?)e(y\))j(\(values)d(\(cons)i
(\(cons)g(y)h(x\))f(binds\))g(t\)\))779 1586 y(\(\(and)g(\(consp)f(x\))
i(\(consp)e(y\))h(\(match)g(\(car)f(x\))i(\(car)f(y\))h(binds\)\))823
1685 y(\(match)e(\(cdr)h(x\))h(\(cdr)e(y\))i(it\)\))779
1785 y(\(t)g(\(values)e(nil)h(nil\)\)\)\))605 1984 y(\(defun)f(varsym?)
g(\(x\))692 2084 y(\(and)h(\(symbolp)e(x\))j(\(eq)f(\(char)g
(\(symbol-name)c(x\))43 b(0\))g(#\\?\)\)\))605 2283 y(\(defun)e
(binding)g(\(x)h(binds\))692 2383 y(\(labels)f(\(\(recbind)f(\(x)i
(binds\))1171 2482 y(\(aif)g(\(assoc)f(x)j(binds\))1389
2582 y(\(or)f(\(recbind)d(\(cdr)i(it\))g(binds\))1564
2681 y(it\)\)\)\))779 2781 y(\(let)g(\(\(b)g(\(recbind)f(x)i
(binds\)\)\))866 2881 y(\(values)e(\(cdr)h(b\))h(b\)\)\)\))1357
3085 y FA(Figure)20 b(18.5:)28 b(Matching)19 b(function.)p
3231 3163 V 555 3166 2678 4 v 555 3391 a Fs(>)43 b(\(match)e('\(p)i(?x)
f(b)i(?y)e(a\))h('\(p)f(?y)h(b)g(c)h(a\)\))555 3490 y(\(\(?Y)e(.)h(C\))
g(\(?X)f(.)h(?Y\)\))555 3590 y(T)555 3689 y(>)g(\(match)e('\(a)i(b)g
(c\))g('\(a)f(a)h(a\)\))555 3789 y(NIL)555 3889 y(NIL)555
4076 y FA(As)25 b Fs(match)d FA(compares)g(its)j(ar)o(guments)d
(element)h(by)g(element,)h(it)g(b)n(uilds)g(up)f(assignments)555
4181 y(of)j(v)n(alues)f(to)h(v)n(ariables,)g(called)g
Ft(bindings)p FA(,)f(in)h(the)g(parameter)e Fs(binds)p
FA(.)45 b(If)26 b(the)f(match)h(is)555 4285 y(successful,)19
b Fs(match)f FA(returns)g(the)h(bindings)f(generated,)g(otherwise)g(it)
i(returns)e Fs(nil)p FA(.)29 b(Since)555 4390 y(not)19
b(all)h(successful)f(matches)g(generate)g(an)o(y)f(bindings,)g
Fs(match)p FA(,)g(lik)o(e)i Fs(gethash)p FA(,)d(returns)h(a)555
4495 y(second)h(v)n(alue)h(to)g(indicate)g(whether)f(the)h(match)g
(succeeded)f(or)h(f)o(ailed:)555 4677 y Fs(>)43 b(\(match)e('\(p)i
(?x\))f('\(p)g(?x\)\))555 4777 y(NIL)555 4877 y(T)p eop
%%Page: 240 253
240 252 bop 555 538 a FA(240)969 b Fu(DESTR)n(UCTURING)p
555 745 2678 4 v 553 2665 4 1920 v 605 888 a Fs(\(defmacro)40
b(if-match)g(\(pat)i(seq)g(then)g(&optional)e(else\))692
988 y(`\(aif2)h(\(match)g(',pat)h(,seq\))997 1087 y(\(let)g(,\(mapcar)e
(#'\(lambda)g(\(v\))1782 1187 y(`\(,v)i(\(binding)e(',v)i(it\)\)\))1607
1287 y(\(vars-in)f(then)h(#'atom\)\))1084 1386 y(,then\))997
1486 y(,else\)\))605 1685 y(\(defun)f(vars-in)g(\(expr)g(&optional)f
(\(atom?)h(#'atom\)\))692 1785 y(\(if)h(\(funcall)f(atom?)g(expr\))866
1884 y(\(if)i(\(var?)e(expr\))h(\(list)f(expr\)\))866
1984 y(\(union)g(\(vars-in)g(\(car)h(expr\))f(atom?\))1171
2084 y(\(vars-in)g(\(cdr)h(expr\))f(atom?\)\)\)\))605
2283 y(\(defun)g(var?)h(\(x\))692 2383 y(\(and)g(\(symbolp)e(x\))j
(\(eq)f(\(char)g(\(symbol-name)c(x\))43 b(0\))g(#\\?\)\)\))1270
2587 y FA(Figure)19 b(18.6:)29 b(Slo)n(w)20 b(matching)f(operator)-5
b(.)p 3231 2665 V 555 2668 2678 4 v 555 2880 a(When)25
b Fs(match)e FA(returns)h Fs(nil)h FA(and)f Fs(t)h FA(as)h(abo)o(v)o
(e,)e(it)i(indicates)f(a)g(successful)g(match)f(which)555
2985 y(yielded)19 b(no)h(bindings.)680 3090 y(Lik)o(e)14
b(Prolog,)g Fs(match)f FA(treats)p 1537 3090 27 4 v 61
w(\(underscore\))e(as)k(a)g(wild\255card.)26 b(It)15
b(matches)e(e)n(v)o(erything,)555 3194 y(and)20 b(has)g(no)g(ef)n(fect)
f(on)h(the)g(bindings:)555 3362 y Fs(>)43 b(\(match)e('\(a)i(?x)f(b\))h
('\(_)f(1)i(_\)\))555 3462 y(\(\(?X)e(.)h(1\)\))555 3561
y(T)680 3734 y FA(Gi)n(v)o(en)25 b Fs(match)p FA(,)h(it)h(is)g(easy)f
(to)h(write)f(a)h(pattern\255matching)c(v)o(ersion)i(of)h
Fs(dbind)p FA(.)46 b(Fig\255)555 3838 y(ure)21 b(18.6)g(contains)g(a)h
(macro)e(called)i Fs(if-match)p FA(.)31 b(Lik)o(e)21
b Fs(dbind)p FA(,)g(its)h(\002rst)h(tw)o(o)f(ar)o(guments)555
3943 y(are)d(a)g(pattern)f(and)g(a)i(sequence,)d(and)i(it)g
(establishes)g(bindings)f(by)g(comparing)f(the)h(pattern)555
4048 y(with)e(the)g(sequence.)27 b(Ho)n(we)n(v)o(er)m(,)15
b(instead)h(of)g(a)g(body)f(it)i(has)f(tw)o(o)g(more)g(ar)o(guments:)25
b(a)17 b Fs(then)555 4152 y FA(clause)27 b(to)g(be)g(e)n(v)n(aluated,)g
(with)g(ne)n(w)f(bindings,)h(if)g(the)g(match)g(succeeds;)j(and)c(an)h
Fs(else)555 4257 y FA(clause)g(to)g(be)f(e)n(v)n(aluated)g(if)h(the)g
(match)f(f)o(ails.)49 b(Here)27 b(is)h(a)f(simple)g(function)e(which)h
(uses)555 4361 y Fs(if-match)p FA(:)555 4529 y Fs(\(defun)41
b(abab)h(\(seq\))642 4629 y(\(if-match)e(\(?x)i(?y)h(?x)g(?y\))f(seq)
817 4728 y(\(values)e(?x)j(?y\))817 4828 y(nil\)\))555
5001 y FA(If)13 b(the)h(match)e(succeeds,)j(it)f(will)g(establish)f(v)n
(alues)g(for)g Fs(?x)g FA(and)g Fs(?y)p FA(,)h(which)f(will)h(be)f
(returned:)p eop
%%Page: 241 254
241 253 bop 555 538 a Ft(18.4)1058 b Fu(MA)-7 b(TCHING)1040
b FA(241)555 801 y Fs(>)43 b(\(abab)f('\(hi)g(ho)g(hi)h(ho\)\))555
900 y(HI)555 1000 y(HO)680 1188 y FA(The)27 b(function)f
Fs(vars-in)g FA(returns)h(all)h(the)g(pattern)f(v)n(ariables)h(in)g(an)
g(e)o(xpression.)50 b(It)555 1292 y(calls)22 b Fs(var?)f
FA(to)h(test)g(if)g(something)e(is)j(a)f(v)n(ariable.)33
b(At)22 b(the)g(moment,)e Fs(var?)h FA(is)h(identical)f(to)555
1397 y Fs(varsym?)14 b FA(\(Figure)i(18.5\),)f(which)i(is)g(used)f(to)h
(detect)g(v)n(ariables)e(in)i(binding)e(lists.)29 b(W)-7
b(e)18 b(ha)n(v)o(e)555 1501 y(tw)o(o)i(distinct)f(functions)f(in)i
(case)f(we)h(w)o(ant)g(to)f(use)h(dif)n(ferent)e(representations)f(for)
i(the)g(tw)o(o)555 1606 y(kinds)h(of)g(v)n(ariables.)680
1711 y(As)k(de\002ned)f(in)h(Figure)f(18.6,)g Fs(if-match)e
FA(is)k(short,)f(b)n(ut)g(not)g(v)o(ery)e(ef)n(\002cient.)40
b(It)24 b(does)555 1815 y(too)f(much)g(w)o(ork)h(at)g(runtime.)39
b(W)-7 b(e)25 b(tra)n(v)o(erse)e(both)g(sequences)g(at)h(runtime,)g(e)n
(v)o(en)e(though)555 1920 y(the)16 b(\002rst)h(is)h(kno)n(wn)d(at)h
(compile\255time.)27 b(W)-7 b(orse)17 b(still,)h(during)c(the)j
(process)f(of)g(matching,)f(we)555 2024 y(cons)24 b(up)h(lists)g(to)g
(hold)f(the)h(v)n(ariable)e(bindings.)41 b(If)24 b(we)h(tak)o(e)g(adv)n
(antage)e(of)h(information)555 2129 y(kno)n(wn)c(at)j(compile\255time,)
e(we)h(can)g(write)g(a)g(v)o(ersion)f(of)h Fs(if-match)d
FA(which)j(performs)e(no)555 2234 y(unnecessary)e(comparisons,)h(and)g
(doesn')o(t)g(cons)h(at)h(all.)680 2338 y(If)g(one)g(of)g(the)g
(sequences)g(is)h(kno)n(wn)e(at)i(compile\255time,)e(and)h(only)g(that)
g(one)g(contains)555 2443 y(v)n(ariables,)34 b(then)d(we)h(can)g(go)f
(about)g(things)g(dif)n(ferently)-5 b(.)62 b(In)32 b(a)g(call)g(to)g
Fs(match)p FA(,)h(either)555 2547 y(ar)o(gument)24 b(could)h(contain)g
(v)n(ariables.)46 b(By)26 b(restricting)g(v)n(ariables)f(to)h(the)g
(\002rst)h(ar)o(gument)555 2652 y(of)h Fs(if-match)p
FA(,)g(we)g(mak)o(e)g(it)h(possible)f(to)h(tell)g(at)g(compile\255time)
d(which)i(v)n(ariables)g(will)555 2757 y(be)23 b(in)m(v)n(olv)o(ed)d
(in)j(the)g(match.)36 b(Then)22 b(instead)h(of)f(creating)g(lists)i(of)
f(v)n(ariable)e(bindings,)h(we)555 2861 y(could)d(k)o(eep)h(the)g(v)n
(alues)g(of)g(v)n(ariables)f(in)i(the)f(v)n(ariables)f(themselv)o(es.)
680 2966 y(The)f(ne)n(w)g(v)o(ersion)f(of)h Fs(if-match)e
FA(appears)i(in)g(Figure)g(18.7)f(and)h(18.8.)28 b(When)18
b(we)h(can)555 3070 y(predict)27 b(what)h(code)f(w)o(ould)h(be)f(e)n(v)
n(aluated)g(at)h(runtime,)h(we)f(can)g(simply)g(generate)e(it)j(at)555
3175 y(compile\255time.)g(Here,)21 b(instead)f(of)h(e)o(xpanding)d
(into)i(a)h(call)h(to)e Fs(match)p FA(,)g(we)h(generate)e(code)555
3280 y(which)h(performs)e(just)j(the)f(right)g(comparisons.)680
3384 y(If)e(we)h(are)g(going)e(to)i(use)g(the)f(v)n(ariable)g
Fs(?x)g FA(to)h(contain)f(the)g(binding)f(of)h Fs(?x)p
FA(,)h(ho)n(w)f(do)g(we)555 3489 y(represent)i(a)h(v)n(ariable)f(for)g
(which)h(no)f(binding)g(has)h(yet)g(been)f(established)h(by)f(the)h
(match?)555 3594 y(Here)c(we)h(will)g(indicate)f(that)g(a)h(pattern)e
(v)n(ariable)g(is)j(unbound)14 b(by)j(binding)f(it)i(to)f(a)h(gensym.)
555 3698 y(So)24 b Fs(if-match)d FA(be)o(gins)i(by)g(generating)f(code)
h(which)g(will)h(bind)f(all)h(the)g(v)n(ariables)f(in)h(the)555
3803 y(pattern)c(to)h(gensyms.)29 b(In)21 b(this)g(case,)g(instead)f
(of)h(e)o(xpanding)d(into)i(a)h Fs(with-gensyms)p FA(,)16
b(it')-5 b(s)555 3907 y(safe)23 b(to)g(mak)o(e)f(the)h(gensyms)e(once)h
(at)h(compile\255time)e(and)h(insert)h(them)f(directly)g(into)h(the)555
4012 y(e)o(xpansion.)680 4117 y(The)32 b(rest)i(of)f(the)g(e)o
(xpansion)e(is)j(generated)e(by)h Fs(pat-match)p FA(.)65
b(This)33 b(macro)f(tak)o(es)555 4221 y(the)e(same)h(ar)o(guments)d(as)
j Fs(if-match)p FA(;)i(the)d(only)f(dif)n(ference)g(is)i(that)f(it)h
(establishes)g(no)555 4326 y(ne)n(w)25 b(bindings)e(for)h(pattern)g(v)n
(ariables.)43 b(In)25 b(some)f(situations)h(this)h(is)f(an)g(adv)n
(antage,)f(and)555 4430 y(Chapter)c(19)f(will)i(use)g
Fs(pat-match)c FA(as)k(an)f(operator)e(in)j(its)g(o)n(wn)e(right.)680
4535 y(In)31 b(the)h(ne)n(w)g(matching)e(operator)m(,)i(the)g
(distinction)f(between)g(pattern)g(content)g(and)555
4640 y(pattern)21 b(structure)g(will)i(be)f(de\002ned)g(by)f(the)h
(function)f Fs(simple?)p FA(.)33 b(If)22 b(we)g(w)o(ant)g(to)h(be)f
(able)555 4744 y(to)c(use)g(quoted)e(literals)i(in)f(patterns,)h(the)f
(destructuring)f(code)g(\(and)h Fs(vars-in)p FA(\))e(ha)n(v)o(e)i(to)h
(be)555 4849 y(told)24 b(not)g(to)g(go)g(inside)g(lists)h(whose)f
(\002rst)h(element)e(is)i Fs(quote)p FA(.)40 b(W)m(ith)24
b(the)g(ne)n(w)g(matching)555 4953 y(operator)m(,)17
b(we)i(will)h(be)f(able)g(to)g(use)g(lists)h(as)g(pattern)e(elements,)h
(simply)f(by)h(quoting)e(them.)p eop
%%Page: 242 255
242 254 bop 555 538 a FA(242)969 b Fu(DESTR)n(UCTURING)p
555 745 2678 4 v 553 3462 4 2717 v 605 888 a Fs(\(defmacro)40
b(if-match)g(\(pat)i(seq)g(then)g(&optional)e(else\))692
988 y(`\(let)i(,\(mapcar)e(#'\(lambda)g(\(v\))i(`\(,v)g
(',\(gensym\)\)\))1346 1087 y(\(vars-in)e(pat)i(#'simple?\)\))823
1187 y(\(pat-match)d(,pat)j(,seq)g(,then)g(,else\)\)\))605
1386 y(\(defmacro)e(pat-match)g(\(pat)h(seq)i(then)f(else\))692
1486 y(\(if)g(\(simple?)f(pat\))866 1586 y(\(match1)g(`\(\(,pat)g
(,seq\)\))g(then)h(else\))866 1685 y(\(with-gensyms)d(\(gseq)i(gelse\))
954 1785 y(`\(labels)f(\(\(,gelse)g(\(\))j(,else\)\))1084
1884 y(,\(gen-match)c(\(cons)j(\(list)f(gseq)h(seq\))1869
1984 y(\(destruc)e(pat)i(gseq)g(#'simple?\)\))1607 2084
y(then)1607 2183 y(`\(,gelse\)\)\)\)\)\))605 2383 y(\(defun)f(simple?)g
(\(x\))h(\(or)g(\(atom)g(x\))h(\(eq)f(\(car)g(x\))h('quote\)\)\))605
2582 y(\(defun)e(gen-match)f(\(refs)h(then)h(else\))692
2681 y(\(if)g(\(null)g(refs\))866 2781 y(then)866 2881
y(\(let)g(\(\(then)f(\(gen-match)f(\(cdr)i(refs\))f(then)h(else\)\)\))
954 2980 y(\(if)g(\(simple?)e(\(caar)i(refs\)\))1128
3080 y(\(match1)f(refs)g(then)h(else\))1128 3180 y(\(gen-match)d(\(car)
j(refs\))g(then)g(else\)\)\)\)\))1285 3384 y FA(Figure)20
b(18.7:)28 b(F)o(ast)21 b(matching)e(operator)-5 b(.)p
3231 3462 V 555 3465 2678 4 v 680 3689 a(Lik)o(e)32 b
Fs(dbind)p FA(,)j Fs(pat-match)30 b FA(calls)k Fs(destruc)c
FA(to)j(get)h(a)f(list)h(of)f(the)g(calls)h(that)f(will)555
3794 y(tak)o(e)26 b(apart)f(its)i(ar)o(gument)c(at)j(runtime.)45
b(This)25 b(list)i(is)g(passed)e(on)h(to)f Fs(gen-match)p
FA(,)f(which)555 3899 y(recursi)n(v)o(ely)g(generates)h(matching)f
(code)h(for)g(nested)g(patterns,)i(and)e(thence)g(to)h
Fs(match1)p FA(,)555 4003 y(which)20 b(generates)f(match)h(code)f(for)h
(each)f(leaf)i(of)f(the)g(pattern)f(tree.)680 4108 y(Most)j(of)g(the)h
(code)f(which)g(will)h(appear)e(in)i(the)f(e)o(xpansion)f(of)h(an)g
Fs(if-match)e FA(comes)555 4212 y(from)e Fs(match1)p
FA(,)g(which)g(is)j(sho)n(wn)d(in)i(Figure)f(18.8.)27
b(This)20 b(function)d(considers)i(four)f(cases.)555
4317 y(If)f(the)f(pattern)g(ar)o(gument)e(is)k(a)f(gensym,)f(then)g(it)
i(is)f(one)f(of)h(the)g(in)m(visible)e(v)n(ariables)h(created)555
4422 y(by)i Fs(destruc)e FA(to)i(hold)g(sublists,)h(and)e(all)i(we)g
(need)e(to)i(do)f(at)g(runtime)f(is)j(test)f(that)f(it)h(has)g(the)555
4526 y(right)j(length.)36 b(If)23 b(the)f(pattern)g(element)g(is)i(a)f
(wildcard)f(\()p 2230 4526 27 4 v 31 w(\),)h(no)g(code)f(need)g(be)h
(generated.)555 4631 y(If)k(the)f(pattern)g(element)g(is)i(a)f(v)n
(ariable,)g Fs(match1)d FA(generates)i(code)g(to)h(match)f(it)h
(against,)555 4735 y(or)c(set)i(it)f(to,)g(the)g(corresponding)c(part)j
(of)g(the)g(sequence)g(gi)n(v)o(en)f(at)i(runtime.)38
b(Otherwise,)555 4840 y(the)26 b(pattern)e(element)h(is)i(tak)o(en)e
(to)h(be)f(a)h(literal)g(v)n(alue,)g(and)f Fs(match1)f
FA(generates)h(code)f(to)555 4945 y(compare)19 b(it)i(with)f(the)g
(corresponding)d(part)j(of)g(the)g(sequence.)p eop
%%Page: 243 256
243 255 bop 555 538 a Ft(18.4)1058 b Fu(MA)-7 b(TCHING)1040
b FA(243)p 555 745 2678 4 v 553 3562 4 2817 v 605 888
a Fs(\(defun)41 b(match1)g(\(refs)h(then)f(else\))692
988 y(\(dbind)g(\(\(pat)h(expr\))f(.)i(rest\))f(refs)779
1087 y(\(cond)g(\(\(gensym?)e(pat\))1084 1187 y(`\(let)i(\(\(,pat)f
(,expr\)\))1215 1287 y(\(if)h(\(and)g(\(typep)f(,pat)h('sequence\))1607
1386 y(,\(length-test)d(pat)j(rest\)\))1389 1486 y(,then)1389
1586 y(,else\)\)\))1041 1685 y(\(\(eq)g(pat)g('_\))g(then\))1041
1785 y(\(\(var?)f(pat\))1084 1884 y(\(let)h(\(\(ge)g(\(gensym\)\)\))
1171 1984 y(`\(let)g(\(\(,ge)f(,expr\)\))1302 2084 y(\(if)i(\(or)f
(\(gensym?)e(,pat\))i(\(equal)f(,pat)h(,ge\)\))1477 2183
y(\(let)f(\(\(,pat)h(,ge\)\))f(,then\))1477 2283 y(,else\)\)\)\))1041
2383 y(\(t)h(`\(if)g(\(equal)f(,pat)h(,expr\))g(,then)f
(,else\)\)\)\)\))605 2582 y(\(defun)g(gensym?)g(\(s\))692
2681 y(\(and)h(\(symbolp)e(s\))j(\(not)f(\(symbol-package)37
b(s\)\)\)\))605 2881 y(\(defun)k(length-test)e(\(pat)j(rest\))692
2980 y(\(let)g(\(\(fin)f(\(caadar)g(\(last)h(rest\)\)\)\))779
3080 y(\(if)h(\(or)f(\(consp)f(fin\))h(\(eq)g(fin)h('elt\)\))954
3180 y(`\(=)f(\(length)f(,pat\))g(,\(length)f(rest\)\))954
3279 y(`\(>)i(\(length)f(,pat\))g(,\(-)h(\(length)f(rest\))h
(2\)\)\)\)\))1081 3483 y FA(Figure)20 b(18.8:)28 b(F)o(ast)21
b(matching)e(operator)f(\(continued\).)p 3231 3562 V
555 3565 2678 4 v 680 3789 a(Let')-5 b(s)31 b(look)f(at)h(e)o(xamples)f
(of)h(ho)n(w)f(some)h(parts)f(of)h(the)g(e)o(xpansion)e(are)i
(generated.)555 3894 y(Suppose)19 b(we)i(be)o(gin)e(with)555
4076 y Fs(\(if-match)40 b(\(?x)i('a\))h(seq)729 4176
y(\(print)e(?x\))729 4276 y(nil\))555 4463 y FA(The)18
b(pattern)f(will)i(be)g(passed)f(to)g Fs(destruc)p FA(,)e(with)j(some)f
(gensym)f(\(call)i(it)g Fs(g)f FA(for)g(le)o(gibility\))555
4568 y(to)i(represent)f(the)i(sequence:)555 4750 y Fs(\(destruc)40
b('\(?x)i('a\))h('g)f(#'simple?\))555 4933 y FA(yielding:)p
eop
%%Page: 244 257
244 256 bop 555 538 a FA(244)969 b Fu(DESTR)n(UCTURING)555
801 y Fs(\(\(?x)42 b(\(elt)g(g)h(0\)\))f(\(\(quote)f(a\))i(\(elt)f(g)h
(1\)\)\))555 972 y FA(On)20 b(the)g(front)g(of)f(this)i(list)g(we)g
(cons)f Fs(\(g)43 b(seq\))p FA(:)555 1154 y Fs(\(\(g)f(seq\))g(\(?x)h
(\(elt)f(g)h(0\)\))f(\(\(quote)f(a\))i(\(elt)e(g)j(1\)\)\))555
1342 y FA(and)14 b(send)g(the)g(whole)g(thing)g(to)f
Fs(ge)o(n-m)o(at)o(ch)p FA(.)21 b(Lik)o(e)14 b(the)g(nai)n(v)o(e)g
(implementation)g(o)o(f)f Fs(len)o(gt)o(h)555 1447 y
FA(\(page)26 b(22\),)h Fs(gen-match)c FA(\002rst)28 b(recurses)e(all)h
(the)g(w)o(ay)g(to)g(the)f(end)h(of)f(the)h(list,)i(and)d(then)555
1551 y(b)n(uilds)k(its)h(return)e(v)n(alue)h(on)f(the)i(w)o(ay)f(back)f
(up.)59 b(When)30 b(it)h(has)f(run)f(out)h(of)g(elements,)555
1656 y Fs(gen-match)15 b FA(returns)j(its)h Fs(then)f
FA(ar)o(gument,)e(which)i(will)h(be)f Fs(?x)p FA(.)28
b(On)19 b(the)f(w)o(ay)h(back)f(up)g(the)555 1760 y(recursion,)g(this)h
(return)f(v)n(alue)h(will)h(be)f(passed)g(as)h(the)f
Fs(then)g FA(ar)o(gument)d(to)k Fs(match1)p FA(.)27 b(No)n(w)555
1865 y(we)21 b(will)f(ha)n(v)o(e)g(a)h(call)f(lik)o(e:)555
2032 y Fs(\(match1)41 b('\(\(\(quote)f(a\))i(\(elt)g(g)h(1\)\)\))f
('\(print)f(?x\))h(')p Fq(h)p FA(else)21 b(function)p
Fq(i)p Fs(\))555 2199 y FA(yielding:)555 2386 y Fs(\(if)42
b(\(equal)f(\(quote)h(a\))g(\(elt)g(g)h(1\)\))729 2491
y(\(print)e(?x\))729 2596 y Fq(h)p FA(else)21 b(function)p
Fq(i)p Fs(\))555 2825 y FA(This)g(will)h(in)g(turn)e(become)g(the)h
Fs(then)f FA(ar)o(gument)f(to)i(another)f(call)i(to)f
Fs(match1)p FA(,)e(the)i(v)n(alue)555 2929 y(of)29 b(which)f(will)i
(become)e(the)h Fs(then)f FA(ar)o(gument)e(of)j(the)g(last)h(call)f(to)
g Fs(match1)p FA(.)54 b(The)29 b(full)555 3034 y(e)o(xpansion)18
b(of)i(this)h Fs(if-match)c FA(is)k(sho)n(wn)f(in)g(Figure)g(18.9.)680
3139 y(In)25 b(this)h(e)o(xpansion)d(gensyms)i(are)g(used)g(in)h(tw)o
(o)g(completely)e(unrelated)g(w)o(ays.)45 b(The)555 3243
y(v)n(ariables)19 b(used)h(to)f(hold)g(parts)h(of)g(the)g(tree)f(at)i
(runtime)d(ha)n(v)o(e)i(gensymed)e(names,)h(in)h(order)555
3348 y(to)j(a)n(v)n(oid)g(capture.)37 b(And)23 b(the)g(v)n(ariable)f
Fs(?x)h FA(is)h(initially)f(bound)e(to)j(a)f(gensym,)g(to)g(indicate)
555 3452 y(that)d(it)h(hasn')o(t)e(yet)i(been)e(assigned)h(a)g(v)n
(alue)g(by)g(matching.)-1833 b Fq(\016)680 3557 y FA(In)16
b(the)h(ne)n(w)g Fs(if-match)p FA(,)e(the)i(pattern)f(elements)h(are)g
(no)n(w)f(e)n(v)n(aluated)g(instead)h(of)g(being)555
3662 y(implicitly)j(quoted.)28 b(This)20 b(means)g(that)g(Lisp)h(v)n
(ariables)e(can)h(be)g(used)g(in)h(patterns,)e(as)i(well)-2785
b Fq(\016)555 3766 y FA(as)21 b(quoted)e(e)o(xpressions:)555
3949 y Fs(>)43 b(\(let)f(\(\(n)g(3\)\))729 4048 y(\(if-match)e(\(?x)j
(n)g('n)f('\(a)h(b\)\))f('\(1)h(3)g(n)g(\(a)g(b\)\))817
4148 y(?x\)\))555 4248 y(1)555 4435 y FA(T)-7 b(w)o(o)25
b(further)e(impro)o(v)o(ements)f(appear)i(because)g(the)h(ne)n(w)f(v)o
(ersion)g(calls)h Fs(destruc)e FA(\(Fig\255)555 4540
y(ure)16 b(18.1\).)26 b(The)16 b(pattern)f(can)h(no)n(w)f(contain)g
Fs(&rest)g FA(or)h Fs(&body)e FA(k)o(e)o(yw)o(ords)h(\()p
Fs(match)f FA(doesn')o(t)555 4645 y(bother)25 b(with)h(those\).)47
b(And)26 b(because)f Fs(destruc)f FA(uses)j(the)f(generic)f(sequence)g
(operators)555 4749 y Fs(elt)18 b FA(and)g Fs(subseq)p
FA(,)f(the)i(ne)n(w)f Fs(if-match)e FA(will)j(w)o(ork)f(for)h(an)o(y)e
(kind)h(of)h(sequence.)27 b(If)19 b Fs(abab)555 4854
y FA(is)i(de\002ned)e(with)i(the)f(ne)n(w)g(v)o(ersion,)f(it)h(can)g
(be)h(used)f(also)g(on)g(v)o(ectors)f(and)h(strings:)p
eop
%%Page: 245 258
245 257 bop 555 538 a Ft(18.4)1058 b Fu(MA)-7 b(TCHING)1040
b FA(245)p 555 745 2678 4 v 553 2839 4 2094 v 605 888
a Fs(\(if-match)40 b(\(?x)i('a\))g(seq)779 988 y(\(print)f(?x\)\))605
1212 y FA(e)o(xpands)18 b(into:)605 1378 y Fs(\(let)42
b(\(\(?x)g('#:g1\)\))692 1478 y(\(labels)f(\(\(#:g3)g(nil)h(nil\)\))779
1577 y(\(let)g(\(\(#:g2)f(seq\)\))866 1677 y(\(if)i(\(and)f(\(typep)f
(#:g2)h('sequence\))1259 1777 y(\(=)g(\(length)f(#:g2\))h(2\)\))1041
1876 y(\(let)g(\(\(#:g5)f(\(elt)h(#:g2)g(0\)\)\))1128
1976 y(\(if)g(\(or)h(\(gensym?)d(x\))j(\(equal)e(?x)h(#:g5\)\))1302
2075 y(\(let)g(\(\(?x)g(#:g5\)\))1433 2175 y(\(if)g(\(equal)f('a)i
(\(elt)f(#:g2)g(1\)\))1607 2275 y(\(print)f(?x\))1607
2374 y(\(#:g3\)\)\))1302 2474 y(\(#:g3\)\)\))1041 2574
y(\(#:g3\)\)\)\)\))1211 2761 y FA(Figure)19 b(18.9:)29
b(Expansion)18 b(of)i(an)g Fs(if-match)p FA(.)p 3231
2839 V 555 2843 2678 4 v 555 3053 a Fs(>)43 b(\(abab)f("abab"\))555
3152 y(#\\a)555 3252 y(#\\b)555 3352 y(>)h(\(abab)f(#\(1)g(2)h(1)g
(2\)\))555 3451 y(1)555 3551 y(2)555 3721 y FA(In)20
b(f)o(act,)g(patterns)g(can)g(be)g(as)h(comple)o(x)d(as)j(patterns)f
(to)g Fs(dbind)p FA(:)555 3886 y Fs(>)43 b(\(if-match)d(\(?x)i(\(1)h(.)
g(?y\))g(.)g(?x\))f('\(\(a)g(b\))h(#\(1)f(2)h(3\))g(a)g(b\))817
3986 y(\(values)d(?x)j(?y\)\))555 4085 y(\(A)g(B\))555
4185 y(#\(2)f(3\))555 4355 y FA(Notice)23 b(that,)h(in)f(the)h(second)e
(return)g(v)n(alue,)h(the)h(elements)f(of)g(the)g(v)o(ector)f(are)h
(displayed.)555 4460 y(T)-7 b(o)20 b(ha)n(v)o(e)g(v)o(ectors)f(printed)
g(this)i(w)o(ay)-5 b(,)20 b(set)g Fs(*print-array*)c
FA(to)k Fs(t)p FA(.)680 4564 y(In)31 b(this)h(chapter)e(we)i(are)f(be)o
(ginning)e(to)i(cross)h(the)f(line)h(into)f(a)h(ne)n(w)f(kind)g(of)g
(pro\255)555 4669 y(gramming.)36 b(W)-7 b(e)24 b(be)o(gan)e(with)h
(simple)g(macros)g(for)f(destructuring.)36 b(In)23 b(the)g(\002nal)h(v)
o(ersion)555 4773 y(of)30 b Fs(if-match)e FA(we)j(ha)n(v)o(e)f
(something)f(that)h(looks)g(more)g(lik)o(e)h(its)h(o)n(wn)d(language.)
59 b(The)555 4878 y(remaining)15 b(chapters)h(describe)g(a)h(whole)g
(class)h(of)e(programs)f(which)h(operate)g(on)h(the)f(same)555
4983 y(philosophy)-5 b(.)p eop
%%Page: 246 259
246 258 bop 555 1610 a Fn(19)p 555 1872 2686 3 v 555
2131 a Fx(A)41 b(Query)h(Compiler)555 2568 y FA(Some)17
b(of)f(the)h(macros)f(de\002ned)g(in)h(the)g(preceding)e(chapter)g
(were)i(lar)o(ge)f(ones.)28 b(T)-7 b(o)17 b(generate)555
2672 y(its)37 b(e)o(xpansion,)g Fs(if-match)c FA(needed)h(all)i(the)g
(code)f(in)h(Figures)f(18.7)f(and)i(18.8,)i(plus)555
2777 y Fs(destruc)23 b FA(from)h(Figure)h(18.1.)44 b(Macros)25
b(of)g(this)h(size)g(lead)g(naturally)e(to)h(our)g(last)h(topic,)555
2882 y(embedded)17 b(languages.)27 b(If)19 b(small)g(macros)g(are)g(e)o
(xtensions)e(to)j(Lisp,)f(lar)o(ge)f(macros)g(de\002ne)555
2986 y(sub\255languages)f(within)i(it\227possibly)g(with)h(their)f(o)n
(wn)g(syntax)g(or)g(control)f(structure.)28 b(W)-7 b(e)555
3091 y(sa)o(w)20 b(the)g(be)o(ginning)d(of)j(this)g(in)g
Fs(if-match)p FA(,)d(which)i(had)h(its)h(o)n(wn)e(distinct)h
(representation)555 3195 y(for)g(v)n(ariables.)680 3300
y(A)k(language)e(implemented)g(within)i(Lisp)g(is)g(called)g(an)g
Ft(embedded)e(langua)o(g)o(e)o(.)38 b FA(Lik)o(e)555
3405 y(\223utility)-5 b(,)f(\224)22 b(the)h(term)f(is)i(not)e(a)h
(precisely)f(de\002ned)f(one;)i Fs(if-match)d FA(probably)h(still)i
(counts)555 3509 y(as)e(a)g(utility)-5 b(,)19 b(b)n(ut)h(it)h(is)g
(getting)f(close)g(to)g(the)h(borderline.)680 3614 y(An)g(embedded)e
(language)h(is)j(not)e(a)h(lik)o(e)f(a)h(language)e(implemented)g(by)h
(a)h(traditional)555 3718 y(compiler)c(or)h(interpreter)-5
b(.)28 b(It)20 b(is)g(implemented)d(within)j(some)f(e)o(xisting)g
(language,)e(usually)555 3823 y(by)24 b(transformation.)38
b(There)23 b(need)h(be)g(no)f(barrier)g(between)g(the)h(base)h
(language)d(and)i(the)555 3928 y(e)o(xtension:)g(it)13
b(should)g(be)g(possible)g(to)g(intermingle)g(the)g(tw)o(o)g(freely)-5
b(.)23 b(F)o(or)13 b(the)g(implementor)m(,)555 4032 y(this)19
b(can)f(mean)g(a)h(huge)e(sa)n(ving)h(of)g(ef)n(fort.)28
b(Y)-9 b(ou)17 b(can)i(embed)e(just)i(what)f(you)g(need,)f(and)h(for)
555 4137 y(the)i(rest,)h(use)f(the)g(base)h(language.)680
4242 y(T)m(ransformation,)e(in)j(Lisp,)h(suggests)f(macros.)35
b(T)-7 b(o)22 b(some)g(e)o(xtent,)g(you)f(could)g(imple\255)555
4346 y(ment)d(embedded)e(languages)g(with)j(preprocessors.)26
b(But)19 b(preprocessors)d(usually)i(operate)555 4451
y(only)i(on)g(te)o(xt,)g(while)h(macros)f(tak)o(e)g(adv)n(antage)f(of)h
(a)h(unique)e(property)g(of)h(Lisp:)30 b(between)555
4555 y(the)g(reader)g(and)f(the)i(compiler)m(,)f(your)f(Lisp)i(program)
d(is)j(represented)e(as)i(lists)g(of)f(Lisp)555 4660
y(objects.)f(T)m(ransformations)18 b(done)h(at)h(this)h(stage)f(can)g
(be)h(much)e(smarter)-5 b(.)680 4765 y(The)14 b(best\255kno)n(wn)f(e)o
(xample)h(of)h(an)g(embedded)e(language)g(is)j Fr(CLOS)p
FA(,)g(the)g(Common)d(Lisp)555 4869 y(Object)g(System.)27
b(If)14 b(you)e(w)o(anted)h(to)h(mak)o(e)f(an)g(object\255oriented)e(v)
o(ersion)h(of)h(a)h(con)m(v)o(entional)555 4974 y(language,)24
b(you)g(w)o(ould)g(ha)n(v)o(e)g(to)h(write)f(a)h(ne)n(w)g(compiler)-5
b(.)42 b(Not)24 b(so)i(in)e(Lisp.)43 b(T)l(uning)24 b(the)1835
5229 y(246)p eop
%%Page: 247 260
247 259 bop 555 538 a Ft(19.1)997 b Fu(THE)18 b(D)n(A)-7
b(T)h(AB)n(ASE)979 b FA(247)555 801 y(compiler)20 b(will)h(mak)o(e)f
Fr(CLOS)i FA(run)e(f)o(aster)m(,)g(b)n(ut)h(in)g(principle)f(the)g
(compiler)g(doesn')o(t)f(ha)n(v)o(e)h(to)555 905 y(be)g(changed)f(at)h
(all.)30 b(The)20 b(whole)f(thing)h(can)g(be)g(written)g(in)g(Lisp.)680
1010 y(The)h(remaining)f(chapters)g(gi)n(v)o(e)h(e)o(xamples)f(of)i
(embedded)d(languages.)32 b(This)22 b(chapter)555 1114
y(describes)d(ho)n(w)g(to)h(embed)e(in)i(Lisp)g(a)g(program)d(to)j
(answer)f(queries)g(on)g(a)h(database.)29 b(\(Y)-9 b(ou)555
1219 y(will)22 b(notice)f(in)g(this)h(program)d(a)j(certain)f(f)o
(amily)f(resemblance)g(to)i Fs(if-match)p FA(.\))29 b(The)21
b(\002rst)555 1324 y(sections)d(describe)g(ho)n(w)f(to)i(write)f(a)h
(system)f(which)g(interprets)f(queries.)28 b(This)19
b(program)d(is)555 1428 y(then)j(reimplemented)e(as)j(a)f(query)f
(compiler)n(\227in)g(essence,)i(as)g(one)e(big)h(macro\227making)555
1533 y(it)i(both)e(more)h(ef)n(\002cient)f(and)h(better)g(inte)o
(grated)e(with)j(Lisp.)555 1786 y Fw(19.1)99 b(The)26
b(Database)555 1976 y FA(F)o(or)g(our)f(present)g(purposes,)h(the)g
(format)e(of)i(the)g(database)f(doesn')o(t)f(matter)i(v)o(ery)f(much.)
555 2081 y(Here,)17 b(for)g(the)g(sak)o(e)h(of)f(con)m(v)o(enience,)e
(we)i(will)h(store)f(information)e(in)j(lists.)29 b(F)o(or)17
b(e)o(xample,)555 2185 y(we)k(will)g(represent)e(the)h(f)o(act)g(that)h
(Joshua)e(Re)o(ynolds)h(w)o(as)h(an)f(English)f(painter)h(who)f(li)n(v)
o(ed)555 2290 y(from)g(1723)g(to)h(1792)f(by:)555 2473
y Fs(\(painter)40 b(reynolds)h(joshua)g(english\))555
2572 y(\(dates)g(reynolds)f(1723)i(1792\))555 2755 y
FA(There)19 b(is)j(no)e(canonical)f(w)o(ay)h(of)g(reducing)e
(information)g(to)j(lists.)30 b(W)-7 b(e)22 b(could)d(just)i(as)g(well)
555 2855 y(ha)n(v)o(e)f(used)g(one)f(big)h(list:)555
3021 y Fs(\(painter)40 b(reynolds)h(joshua)g(1723)h(1792)g(english\))
555 3192 y FA(It)18 b(is)g(up)f(to)g(the)h(user)f(to)g(decide)g(ho)n(w)
g(to)g(or)o(ganize)e(database)i(entries.)28 b(The)17
b(only)f(restriction)555 3296 y(is)22 b(that)f(the)g(entries)g(\()p
Ft(facts)p FA(\))g(will)h(be)f(inde)o(x)o(ed)e(under)g(their)i(\002rst)
h(element)e(\(the)h Ft(pr)m(edicate)p FA(\).)555 3401
y(W)m(ithin)28 b(those)h(bounds,)f(an)o(y)g(consistent)g(form)g(will)h
(do,)h(although)c(some)j(forms)e(might)555 3506 y(mak)o(e)20
b(for)f(f)o(aster)i(queries)e(than)h(others.)680 3610
y(An)o(y)28 b(database)g(system)i(needs)e(at)i(least)g(tw)o(o)f
(operations:)46 b(one)28 b(for)h(modifying)e(the)555
3715 y(database,)17 b(and)g(one)f(for)h(e)o(xamining)e(it.)29
b(The)17 b(code)f(sho)n(wn)h(in)g(Figure)g(19.1)f(pro)o(vides)f(these)
555 3819 y(operations)22 b(in)j(a)f(basic)g(form.)39
b(A)25 b(database)e(is)i(represented)d(as)j(a)f(hash\255table)f
(\002lled)h(with)555 3924 y(lists)e(of)e(f)o(acts,)g(hashed)f
(according)f(to)j(their)f(predicate.)680 4029 y(Although)36
b(the)j(database)f(functions)g(de\002ned)f(in)i(Figure)f(19.1)g
(support)f(multiple)555 4133 y(databases,)29 b(the)o(y)e(all)i(def)o
(ault)e(to)h(operations)e(on)h Fs(*default-db*)p FA(.)48
b(As)29 b(with)f(packages)555 4238 y(in)d(Common)f(Lisp,)j(programs)c
(which)i(don')o(t)e(need)i(multiple)f(databases)h(need)g(not)g(e)n(v)o
(en)555 4342 y(mention)19 b(them.)29 b(In)20 b(this)g(chapter)f(all)i
(the)f(e)o(xamples)f(will)i(just)g(use)g(the)f Fs(*default-db*)p
FA(.)680 4447 y(W)-7 b(e)35 b(initialize)g(the)f(system)h(by)f(calling)
f Fs(clear-db)p FA(,)i(which)f(empties)g(the)h(current)555
4552 y(database.)29 b(W)-7 b(e)21 b(can)e(look)h(up)f(f)o(acts)i(with)f
(a)g(gi)n(v)o(en)f(predicate)g(with)h Fs(db-query)p FA(,)d(and)j
(insert)555 4656 y(ne)n(w)26 b(f)o(acts)g(into)g(a)g(database)g(entry)f
(with)h Fs(db-push)p FA(.)44 b(As)26 b(e)o(xplained)f(in)h(Section)f
(12.1,)h(a)555 4761 y(macro)d(which)g(e)o(xpands)f(into)h(an)g(in)m(v)o
(ertible)f(reference)g(will)i(itself)h(be)e(in)m(v)o(ertible.)38
b(Since)555 4865 y Fs(db-query)18 b FA(is)k(de\002ned)e(this)h(w)o(ay)
-5 b(,)21 b(we)g(can)g(simply)f(push)g(ne)n(w)h(f)o(acts)g(onto)f(the)h
Fs(db-query)555 4970 y FA(of)30 b(their)g(predicates.)58
b(In)29 b(Common)g(Lisp,)j(hash\255table)d(entries)h(are)g(initialized)
g(to)g Fs(nil)p eop
%%Page: 248 261
248 260 bop 555 538 a FA(248)924 b Fu(A)19 b(Q)o(UER)l(Y)g(COMPILER)p
555 745 2678 4 v 553 2765 4 2020 v 605 888 a Fs(\(defun)41
b(make-db)g(\(&optional)e(\(size)j(100\)\))692 988 y(\(make-hash-table)
37 b(:size)k(size\)\))605 1187 y(\(defvar)g(*default-db*)d
(\(make-db\)\))605 1386 y(\(defun)j(clear-db)f(\(&optional)g(\(db)i
(*default-db*\)\))692 1486 y(\(clrhash)e(db\)\))605 1685
y(\(defmacro)g(db-query)g(\(key)i(&optional)e(\(db)i('*default-db*\)\))
692 1785 y(`\(gethash)e(,key)i(,db\)\))605 1984 y(\(defun)f(db-push)g
(\(key)h(val)g(&optional)e(\(db)i(*default-db*\)\))692
2084 y(\(push)g(val)g(\(db-query)e(key)i(db\)\)\))605
2283 y(\(defmacro)e(fact)i(\(pred)f(&rest)h(args\))692
2383 y(`\(progn)f(\(db-push)f(',pred)h(',args\))1041
2482 y(',args\)\))1255 2686 y FA(Figure)19 b(19.1:)29
b(Basic)21 b(database)f(functions.)p 3231 2765 V 555
2768 2678 4 v 555 2985 a(unless)j(speci\002ed)g(otherwise,)g(so)g(an)o
(y)f(k)o(e)o(y)g(initially)h(has)h(an)e(empty)h(list)h(associated)e
(with)555 3090 y(it.)30 b(Finally)-5 b(,)19 b(the)h(macro)g
Fs(fact)f FA(adds)h(a)g(ne)n(w)g(f)o(act)h(to)f(the)g(database.)555
3264 y Fs(>)43 b(\(fact)f(painter)e(reynolds)h(joshua)g(english\))555
3364 y(\(REYNOLDS)f(JOSHUA)h(ENGLISH\))555 3463 y(>)i(\(fact)f(painter)
e(canale)h(antonio)g(venetian\))555 3563 y(\(CANALE)g(ANTONIO)f
(VENETIAN\))555 3662 y(>)j(\(db-query)d('painter\))555
3762 y(\(\(CANALE)g(ANTONIO)h(VENETIAN\))599 3862 y(\(REYNOLDS)e
(JOSHUA)j(ENGLISH\)\))555 3961 y(T)555 4140 y FA(The)32
b Fs(t)g FA(returned)f(as)h(the)h(second)e(v)n(alue)g(by)h
Fs(db-query)e FA(appears)h(because)g Fs(db-query)555
4245 y FA(e)o(xpands)24 b(into)h(a)i Fs(gethash)p FA(,)d(which)h
(returns)g(as)h(its)h(second)e(v)n(alue)g(a)h(\003ag)g(to)g
(distinguish)555 4350 y(between)19 b(\002nding)g(no)h(entry)g(and)f
(\002nding)g(an)h(entry)g(whose)g(v)n(alue)f(is)i Fs(nil)p
FA(.)555 4601 y Fw(19.2)99 b(P)o(atter)o(n\255Matching)26
b(Queries)555 4791 y FA(Calling)k Fs(db-query)e FA(is)j(not)f(a)g(v)o
(ery)f(\003e)o(xible)h(w)o(ay)g(of)g(looking)e(at)j(the)f(contents)g
(of)g(the)555 4896 y(database.)50 b(Usually)27 b(the)h(user)f(w)o(ants)
h(to)g(ask)f(questions)g(which)g(depend)e(on)i(more)g(than)555
5001 y(just)h(the)g(\002rst)h(element)e(of)h(a)g(f)o(act.)52
b(A)29 b Ft(query)e(langua)o(g)o(e)f FA(is)j(a)f(language)e(for)h(e)o
(xpressing)p eop
%%Page: 249 262
249 261 bop 555 538 a Ft(19.2)781 b Fu(P)-5 b(A)e(TTERN)p
Fv(\255)p Fu(MA)g(TCHING)18 b(Q)o(UERIES)764 b FA(249)p
555 745 2678 4 v 553 1775 4 1031 v 605 900 a Fq(h)p FA(query)p
Fq(i)163 b FA(:)30 b Fs(\()p Fq(h)p FA(symbol)p Fq(i)19
b(h)p FA(ar)o(gument)p Fq(i)p FA(*)p Fs(\))1023 1000
y FA(:)30 b Fs(\(not)42 b Fq(h)p FA(query)p Fq(i)p Fs(\))1023
1100 y FA(:)30 b Fs(\(and)42 b Fq(h)p FA(query)p Fq(i)p
FA(*)p Fs(\))1023 1199 y FA(:)30 b Fs(\(or)42 b Fq(h)p
FA(query)p Fq(i)p FA(*)p Fs(\))605 1299 y Fq(h)p FA(ar)o(gument)p
Fq(i)d FA(:)30 b Fs(?)p Fq(h)p FA(symbol)p Fq(i)1023
1398 y FA(:)g Fq(h)p FA(symbol)p Fq(i)1023 1498 y FA(:)g
Fq(h)p FA(number)p Fq(i)1375 1697 y FA(Figure)19 b(19.2:)29
b(Syntax)19 b(of)h(queries.)p 3231 1775 V 555 1779 2678
4 v 555 2003 a(more)g(complicated)f(questions.)30 b(In)20
b(a)i(typical)e(query)f(language,)g(the)i(user)f(can)h(ask)g(for)f(all)
555 2107 y(the)i(v)n(alues)g(which)g(satisfy)g(some)g(combination)e(of)
i(restrictions\227for)e(e)o(xample,)h(the)i(last)555
2212 y(names)d(of)g(all)h(the)f(painters)f(born)g(in)i(1697.)680
2317 y(Our)16 b(program)f(will)j(pro)o(vide)d(a)j(declarati)n(v)o(e)d
(query)h(language.)26 b(In)17 b(a)g(declarati)n(v)o(e)f(query)555
2421 y(language,)f(the)i(user)f(speci\002es)h(the)g(constraints)f
(which)g(answers)g(must)h(satisfy)-5 b(,)16 b(and)g(lea)n(v)o(es)555
2526 y(it)g(to)g(the)g(system)g(to)g(\002gure)f(out)g(ho)n(w)g(to)h
(generate)f(them.)27 b(This)16 b(w)o(ay)g(of)f(e)o(xpressing)f(queries)
555 2631 y(is)24 b(close)f(to)g(the)g(form)f(people)g(use)h(in)g(e)n(v)
o(eryday)e(con)m(v)o(ersation.)34 b(W)m(ith)24 b(our)e(program,)f(we)
555 2735 y(will)28 b(be)f(able)f(to)i(e)o(xpress)e(the)h(sample)g
(query)e(by)i(asking)f(for)g(all)i(the)f Ft(x)g FA(such)g(that)g(there)
555 2840 y(is)c(a)g(f)o(act)f(of)g(the)h(form)e Fs(\(painter)40
b Ft(x)j Fs(...\))p FA(,)22 b(and)g(a)g(f)o(act)h(of)f(the)g(form)f
Fs(\(dates)41 b Ft(x)j Fs(1697)555 2944 y(...\))p FA(.)28
b(W)-7 b(e)21 b(will)g(be)f(able)h(to)f(refer)f(to)i(all)f(the)h
(painters)e(born)g(in)i(1697)d(by)i(writing:)555 3127
y Fs(\(and)42 b(\(painter)e(?x)j(?y)g(?z\))773 3227 y(\(dates)e(?x)i
(1697)f(?w\)\))555 3414 y FA(As)16 b(well)h(as)f(accepting)e(simple)i
(queries)f(consisting)g(of)g(a)h(predicate)e(and)h(some)h(ar)o
(guments,)555 3519 y(our)i(program)e(will)j(be)g(able)f(to)h(answer)f
(arbitrarily)f(comple)o(x)g(queries)g(joined)h(together)f(by)555
3623 y(logical)22 b(operators)e(lik)o(e)i Fs(and)f FA(and)h
Fs(or)p FA(.)34 b(The)22 b(syntax)f(of)h(the)g(query)e(language)g(is)j
(sho)n(wn)e(in)555 3728 y(Figure)f(19.2.)680 3833 y(Since)i(f)o(acts)h
(are)f(inde)o(x)o(ed)f(under)g(their)h(predicates,)g(v)n(ariables)f
(cannot)h(appear)f(in)i(the)555 3937 y(predicate)i(position.)45
b(If)26 b(you)f(were)g(willing)h(to)g(gi)n(v)o(e)f(up)g(the)h
(bene\002ts)g(of)g(inde)o(xing,)e(you)555 4042 y(could)c(get)g(around)f
(this)i(restriction)f(by)g(al)o(w)o(ays)h(using)f(the)h(same)g
(predicate,)e(and)h(making)555 4146 y(the)g(\002rst)h(ar)o(gument)d
(the)i Ft(de)g(facto)g FA(predicate.)680 4251 y(Lik)o(e)k(man)o(y)f
(such)h(systems,)i(this)f(program)d(has)j(a)g(sk)o(eptic')-5
b(s)25 b(notion)e(of)h(truth:)38 b(some)555 4356 y(f)o(acts)26
b(are)g(kno)n(wn,)g(and)f(e)n(v)o(erything)e(else)k(is)g(f)o(alse.)47
b(The)25 b Fs(not)h FA(operator)e(succeeds)h(if)i(the)555
4460 y(f)o(act)d(in)h(question)e(is)i(not)f(present)f(in)i(the)f
(database.)41 b(T)-7 b(o)24 b(a)h(de)o(gree,)e(you)g(could)h(represent)
555 4565 y(e)o(xplicit)c(f)o(alsity)g(by)g(the)g Ft(W)-8
b(ayne')m(s)20 b(W)-8 b(orld)20 b FA(method:)555 4748
y Fs(\(edible)41 b(motor-oil)f(not\))555 4935 y FA(Ho)n(we)n(v)o(er)m
(,)18 b(the)i Fs(not)g FA(operator)e(w)o(ouldn')o(t)g(treat)j(these)f
(f)o(acts)h(dif)n(ferently)d(from)h(an)o(y)g(others.)p
eop
%%Page: 250 263
250 262 bop 555 538 a FA(250)924 b Fu(A)19 b(Q)o(UER)l(Y)g(COMPILER)680
801 y FA(In)24 b(programming)d(languages)j(there)g(is)i(a)f
(fundamental)e(distinction)h(between)g(inter)n(\255)555
905 y(preted)k(and)g(compiled)g(programs.)53 b(In)29
b(this)g(chapter)f(we)h(e)o(xamine)f(the)h(same)g(question)555
1010 y(with)17 b(respect)g(to)g(queries.)27 b(A)18 b(query)e
(interpreter)f(accepts)i(a)g(query)f(and)g(uses)i(it)g(to)f(generate)
555 1114 y(answers)28 b(from)e(the)i(database.)51 b(A)28
b(query)f(compiler)f(accepts)i(a)g(query)e(and)h(generates)g(a)555
1219 y Ft(pr)l(o)o(gr)o(am)15 b FA(which,)h(when)g(run,)g(yields)f(the)
h(same)h(result.)27 b(The)16 b(follo)n(wing)e(sections)i(describe)555
1324 y(a)21 b(query)d(interpreter)h(and)h(then)f(a)i(query)e(compiler)
-5 b(.)555 1576 y Fw(19.3)99 b(A)25 b(Query)g(Inter)o(pr)n(eter)680
1767 y FA(T)-7 b(o)22 b(implement)f(a)i(declarati)n(v)o(e)d(query)h
(language)g(we)h(will)h(use)g(the)f(pattern\255matching)555
1872 y(utilities)30 b(de\002ned)e(in)h(Section)f(18.4.)54
b(The)29 b(functions)e(sho)n(wn)i(in)g(Figure)f(19.3)g(interpret)555
1976 y(queries)f(of)h(the)g(form)f(sho)n(wn)g(in)h(Figure)f(19.2.)51
b(The)28 b(central)f(function)f(in)i(this)g(code)g(is)555
2081 y Fs(interpret-query)p FA(,)16 b(which)21 b(recursi)n(v)o(ely)f(w)
o(orks)h(through)e(the)j(structure)e(of)h(a)h(comple)o(x)555
2185 y(query)-5 b(,)31 b(generating)e(bindings)g(in)i(the)f(process.)60
b(The)30 b(e)n(v)n(aluation)f(of)h(comple)o(x)f(queries)555
2290 y(proceeds)19 b(left\255to\255right,)f(as)j(in)f(Common)f(Lisp)h
(itself.)680 2395 y(When)i(the)g(recursion)f(gets)h(do)n(wn)f(to)i
(patterns)f(for)f(f)o(acts,)i Fs(interpret-query)17 b
FA(calls)555 2499 y Fs(lookup)p FA(.)33 b(This)23 b(is)g(where)e(the)h
(pattern\255matching)d(occurs.)35 b(The)22 b(function)e
Fs(lookup)g FA(tak)o(es)555 2604 y(a)h(pattern)f(consisting)f(of)i(a)f
(predicate)g(and)g(a)h(list)g(of)f(ar)o(guments,)f(and)h(returns)f(a)i
(list)h(of)e(all)555 2708 y(the)j(bindings)e(which)h(mak)o(e)h(the)g
(pattern)f(match)g(some)h(f)o(act)g(in)f(the)h(database.)37
b(It)23 b(gets)g(all)555 2813 y(the)17 b(database)f(entries)g(for)g
(the)h(predicate,)f(and)g(calls)h Fs(match)e FA(\(page)h(239\))f(to)i
(compare)e(each)555 2918 y(of)20 b(them)h(against)f(the)h(pattern.)30
b(Each)20 b(successful)g(match)h(returns)e(a)j(list)f(of)g(bindings,)e
(and)555 3022 y Fs(lookup)f FA(in)j(turn)e(returns)g(a)i(list)g(of)f
(all)h(these)f(lists.)555 3205 y Fs(>)43 b(\(lookup)e('painter)f('\(?x)
i(?y)h(english\)\))555 3305 y(\(\(\(?Y)f(.)h(JOSHUA\))d(\(?X)j(.)g
(REYNOLDS\)\)\))680 3492 y FA(These)33 b(results)g(are)g(then)g
(\002ltered)g(or)g(combined)e(depending)g(on)i(the)g(surrounding)555
3597 y(logical)23 b(operators.)36 b(The)22 b(\002nal)h(result)g(is)h
(returned)e(as)h(a)h(list)g(of)e(sets)j(of)d(bindings.)36
b(Gi)n(v)o(en)555 3701 y(the)e(assertions)h(sho)n(wn)e(in)h(Figure)g
(19.4,)i(here)e(is)h(the)g(e)o(xample)e(from)g(earlier)h(in)g(this)555
3806 y(chapter:)555 3989 y Fs(>)43 b(\(interpret-query)37
b('\(and)42 b(\(painter)e(?x)j(?y)f(?z\))1645 4088 y(\(dates)f(?x)i
(1697)e(?w\)\)\))555 4188 y(\(\(\(?W)h(.)h(1768\))e(\(?Z)i(.)g
(VENETIAN\))d(\(?Y)i(.)h(ANTONIO\))d(\(?X)j(.)g(CANALE\)\))599
4288 y(\(\(?W)f(.)h(1772\))e(\(?Z)i(.)g(ENGLISH\))d(\(?Y)i(.)i
(WILLIAM\))c(\(?X)i(.)h(HOGARTH\)\)\))555 4475 y FA(As)26
b(a)f(general)f(rule,)i(queries)e(can)h(be)g(combined)d(and)j(nested)g
(without)f(restriction.)42 b(In)25 b(a)555 4580 y(fe)n(w)d(cases)g
(there)f(are)h(subtle)f(restrictions)h(on)f(the)h(syntax)f(of)g
(queries,)g(b)n(ut)h(these)g(are)f(best)555 4684 y(dealt)f(with)h
(after)e(looking)g(at)i(some)f(e)o(xamples)f(of)h(ho)n(w)f(this)i(code)
e(is)j(used.)680 4789 y(The)d(macro)g Fs(with-answer)d
FA(pro)o(vides)i(a)i(clean)g(w)o(ay)g(of)f(using)h(the)g(query)e
(interpreter)555 4894 y(within)32 b(Lisp)h(programs.)64
b(It)33 b(tak)o(es)g(as)g(its)g(\002rst)h(ar)o(gument)c(an)o(y)i(le)o
(gal)f(query;)38 b(the)32 b(rest)555 4998 y(of)27 b(the)g(ar)o(guments)
e(are)j(treated)e(as)i(a)g(body)e(of)h(code.)49 b(A)28
b Fs(with-answer)23 b FA(e)o(xpands)j(into)p eop
%%Page: 251 264
251 263 bop 555 538 a Ft(19.3)875 b Fu(A)19 b(Q)o(UER)l(Y)g
(INTERPRETER)855 b FA(251)p 555 874 2678 4 v 553 4786
4 3913 v 605 1017 a Fs(\(defmacro)40 b(with-answer)f(\(query)i(&body)g
(body\))692 1116 y(\(let)h(\(\(binds)f(\(gensym\)\)\))779
1216 y(`\(dolist)f(\(,binds)h(\(interpret-query)c(',query\)\))910
1315 y(\(let)42 b(,\(mapcar)e(#'\(lambda)g(\(v\))1694
1415 y(`\(,v)i(\(binding)f(',v)h(,binds\)\)\))1520 1515
y(\(vars-in)e(query)i(#'atom\)\))997 1614 y(,@body\)\)\)\))605
1814 y(\(defun)f(interpret-query)c(\(expr)42 b(&optional)e(binds\))692
1913 y(\(case)i(\(car)f(expr\))779 2013 y(\(and)86 b(\(interpret-and)37
b(\(reverse)k(\(cdr)h(expr\)\))f(binds\)\))779 2112 y(\(or)130
b(\(interpret-or)38 b(\(cdr)k(expr\))f(binds\)\))779
2212 y(\(not)86 b(\(interpret-not)37 b(\(cadr)42 b(expr\))g(binds\)\))
779 2312 y(\(t)174 b(\(lookup)40 b(\(car)i(expr\))g(\(cdr)g(expr\))f
(binds\)\)\)\))605 2511 y(\(defun)g(interpret-and)d(\(clauses)i
(binds\))692 2611 y(\(if)i(\(null)g(clauses\))866 2710
y(\(list)g(binds\))866 2810 y(\(mapcan)f(#'\(lambda)f(\(b\))1389
2910 y(\(interpret-query)d(\(car)42 b(clauses\))f(b\)\))1215
3009 y(\(interpret-and)d(\(cdr)k(clauses\))e(binds\)\)\)\))605
3208 y(\(defun)h(interpret-or)e(\(clauses)h(binds\))692
3308 y(\(mapcan)h(#'\(lambda)f(\(c\))1215 3408 y(\(interpret-query)d(c)
43 b(binds\)\))1041 3507 y(clauses\)\))605 3707 y(\(defun)e
(interpret-not)d(\(clause)j(binds\))692 3806 y(\(if)h
(\(interpret-query)37 b(clause)k(binds\))866 3906 y(nil)866
4005 y(\(list)h(binds\)\)\))605 4205 y(\(defun)f(lookup)g(\(pred)h
(args)f(&optional)f(binds\))692 4304 y(\(mapcan)h(#'\(lambda)f(\(x\))
1215 4404 y(\(aif2)i(\(match)f(x)i(args)f(binds\))f(\(list)g(it\)\)\))
1041 4504 y(\(db-query)f(pred\)\)\))1381 4708 y FA(Figure)19
b(19.3:)28 b(Query)20 b(interpreter)-5 b(.)p 3231 4786
V 555 4789 2678 4 v eop
%%Page: 252 265
252 264 bop 555 538 a FA(252)924 b Fu(A)19 b(Q)o(UER)l(Y)g(COMPILER)p
555 745 2678 4 v 553 1768 4 1023 v 605 888 a Fs(\(clear-db\))605
988 y(\(fact)41 b(painter)g(hogarth)g(william)f(english\))605
1087 y(\(fact)h(painter)g(canale)g(antonio)g(venetian\))605
1187 y(\(fact)g(painter)g(reynolds)f(joshua)h(english\))605
1287 y(\(fact)g(dates)h(hogarth)f(1697)g(1772\))605 1386
y(\(fact)g(dates)h(canale)f(1697)h(1768\))605 1486 y(\(fact)f(dates)h
(reynolds)e(1723)i(1792\))1245 1690 y FA(Figure)19 b(19.4:)29
b(Assertion)20 b(of)g(sample)g(f)o(acts.)p 3231 1768
V 555 1772 2678 4 v 555 1991 a(code)j(which)g(collects)g(all)h(the)g
(sets)g(of)g(bindings)e(generated)f(by)j(the)f(query)-5
b(,)22 b(then)h(iterates)555 2096 y(through)17 b(the)h(body)g(with)g
(the)h(v)n(ariables)f(in)h(the)g(query)e(bound)g(as)i(speci\002ed)g(by)
f(each)g(set)i(of)555 2200 y(bindings.)41 b(V)-9 b(ariables)24
b(which)g(appear)f(in)i(the)g(query)e(of)h(a)h Fs(with-answer)c
FA(can)j(\(usually\))555 2305 y(be)e(used)h(within)f(its)i(body)-5
b(.)34 b(When)23 b(the)f(query)f(is)j(successful)e(b)n(ut)h(contains)e
(no)i(v)n(ariables,)555 2409 y Fs(with-answer)16 b FA(e)n(v)n(aluates)k
(the)g(body)f(of)h(code)f(just)i(once.)680 2514 y(W)m(ith)h(the)g
(database)f(as)i(de\002ned)e(in)h(Figure)g(19.4,)f(Figure)g(19.5)g(sho)
n(ws)h(some)g(sample)555 2619 y(queries,)f(accompanied)d(by)j(English)g
(translations.)31 b(Because)22 b(pattern\255matching)17
b(is)23 b(done)555 2723 y(with)d Fs(match)p FA(,)f(it)i(is)g(possible)f
(to)g(use)h(the)f(underscore)e(as)j(a)f(wild\255card)f(in)h(patterns.)
680 2828 y(T)-7 b(o)22 b(k)o(eep)g(these)g(e)o(xamples)g(short,)g(the)g
(code)g(within)g(the)g(bodies)g(of)g(the)g(queries)g(does)555
2932 y(nothing)c(more)i(than)f(print)h(some)g(result.)29
b(In)20 b(general,)e(the)j(body)d(of)i(a)h Fs(with-answer)16
b FA(can)555 3037 y(consist)k(of)g(an)o(y)g(Lisp)g(e)o(xpressions.)555
3289 y Fw(19.4)99 b(Restrictions)25 b(on)g(Binding)555
3479 y FA(There)j(are)h(some)f(restrictions)h(on)f(which)h(v)n
(ariables)f(will)h(be)g(bound)e(by)h(a)i(query)-5 b(.)53
b(F)o(or)555 3584 y(e)o(xample,)19 b(why)g(should)g(the)h(query)555
3761 y Fs(\(not)42 b(\(painter)e(?x)j(?y)g(?z\)\))555
3942 y FA(assign)23 b(an)o(y)f(bindings)g(to)h Fs(?x)g
FA(and)f Fs(?y)h FA(at)g(all?)38 b(There)22 b(are)h(an)g(in\002nite)g
(number)e(of)i(combi\255)555 4047 y(nations)h(of)g Fs(?x)g
FA(and)f Fs(?y)h FA(which)g(are)g Ft(not)g FA(the)h(name)e(of)h(some)g
(painter)-5 b(.)41 b(Thus)24 b(we)h(add)f(the)555 4152
y(follo)n(wing)d(restriction:)34 b(the)23 b Fs(not)f
FA(operator)f(will)j(\002lter)f(out)f(bindings)g(which)g(are)h(already)
555 4256 y(generated,)18 b(as)j(in)555 4433 y Fs(\(and)42
b(\(painter)e(?x)j(?y)g(?z\))f(\(not)g(\(dates)f(?x)i(1772)f(?d\)\)\))
555 4615 y FA(b)n(ut)25 b(you)g(cannot)f(e)o(xpect)g(it)i(to)f
(generate)f(bindings)g(all)i(by)f(itself.)44 b(W)-7 b(e)27
b(ha)n(v)o(e)d(to)i(generate)555 4719 y(sets)18 b(of)e(bindings)f(by)h
(looking)e(for)i(painters)g(before)f(we)i(can)f(screen)g(out)g(the)h
(ones)f(not)g(born)555 4824 y(in)k(1772.)28 b(If)20 b(we)h(had)e(put)h
(the)g(clauses)h(in)f(the)h(re)n(v)o(erse)e(order:)555
5001 y Fs(\(and)42 b(\(not)g(\(dates)f(?x)i(1772)f(?d\)\))g(\(painter)e
(?x)j(?y)f(?z\)\))217 b(;)43 b(wrong)p eop
%%Page: 253 266
253 265 bop 555 538 a Ft(19.4)816 b Fu(RESTRICTIONS)18
b(ON)h(BINDING)799 b FA(253)p 555 745 2678 4 v 553 4108
4 3363 v 605 887 a Ft(The)20 b(\002r)o(st)h(name)f(and)f(nationality)g
(of)h(e)o(very)g(painter)g(called)g(Ho)o(garth.)605 1053
y Fs(>)43 b(\(with-answer)c(\(painter)h(hogarth)h(?x)h(?y\))779
1152 y(\(princ)f(\(list)h(?x)h(?y\)\)\))605 1252 y(\(WILLIAM)d
(ENGLISH\))605 1352 y(NIL)605 1518 y Ft(The)20 b(last)h(name)e(of)i(e)o
(very)f(painter)g(born)f(in)i(1697.)27 b(\(Our)20 b(original)g(e)n
(xample)o(.\))605 1684 y Fs(>)43 b(\(with-answer)c(\(and)j(\(painter)e
(?x)j(_)g(_\))1477 1783 y(\(dates)e(?x)h(1697)g(_\)\))779
1883 y(\(princ)f(\(list)h(?x\)\)\))605 1983 y(\(CANALE\)\(HOGARTH)o(\))
605 2082 y(NIL)605 2248 y Ft(The)20 b(last)h(name)e(and)h(year)g(of)g
(birth)h(of)f(e)o(veryone)f(who)h(died)g(in)g(1772)f(or)i(1792.)605
2414 y Fs(>)43 b(\(with-answer)c(\(or)j(\(dates)f(?x)i(?y)g(1772\))1433
2514 y(\(dates)e(?x)i(?y)g(1792\)\))779 2614 y(\(princ)e(\(list)h(?x)h
(?y\)\)\))605 2713 y(\(HOGARTH)d(1697\)\(REYNOLDS)e(1723\))605
2813 y(NIL)605 2979 y Ft(The)23 b(last)h(name)e(of)i(e)o(very)f
(English)g(painter)f(not)h(born)g(the)g(same)g(year)h(as)f(a)h(V)-9
b(enetian)605 3078 y(one)o(.)605 3244 y Fs(>)43 b(\(with-answer)c
(\(and)j(\(painter)e(?x)j(_)g(english\))1477 3344 y(\(dates)e(?x)h(?b)h
(_\))1477 3444 y(\(not)e(\(and)h(\(painter)f(?x2)h(_)h(venetian\))1912
3543 y(\(dates)f(?x2)g(?b)h(_\)\)\)\))779 3643 y(\(princ)e(?x\)\))605
3743 y(REYNOLDS)605 3842 y(NIL)1204 4030 y FA(Figure)20
b(19.5:)28 b(The)20 b(query)f(interpreter)f(in)j(use.)p
3231 4108 V 555 4111 2678 4 v 555 4317 a(then)d(we)h(w)o(ould)f(get)h
Fs(nil)f FA(as)h(the)g(result)f(if)h(there)g(were)f Ft(any)g
FA(painters)g(born)g(in)g(1772.)28 b(Ev)o(en)555 4422
y(in)22 b(the)g(\002rst)h(e)o(xample,)d(we)j(shouldn')o(t)c(e)o(xpect)i
(to)h(be)g(able)g(to)g(use)g(the)g(v)n(alue)f(of)h Fs(?d)g
FA(within)555 4527 y(the)e(body)f(of)h(a)h Fs(with-answer)16
b FA(e)o(xpression.)680 4631 y(Also,)h(e)o(xpressions)e(of)i(the)f
(form)g Fs(\(or)42 b Ft(q)1878 4643 y Fm(1)1925 4631
y Fy(:)14 b(:)g(:)43 b Ft(q)2107 4643 y Fc(n)2152 4631
y Fs(\))16 b FA(are)h(only)f(guaranteed)e(to)j(generate)555
4736 y(real)34 b(bindings)e(for)h(v)n(ariables)g(which)h(appear)e(in)i
(all)h(of)e(the)h Ft(q)2488 4748 y Fd(i)2508 4736 y FA(.)71
b(If)33 b(a)i Fs(with-answer)555 4840 y FA(contained)19
b(the)h(query)555 5001 y Fs(\(or)42 b(\(painter)f(?x)h(?y)h(?z\))f
(\(dates)g(?x)g(?b)h(?d\)\))p eop
%%Page: 254 267
254 266 bop 555 538 a FA(254)924 b Fu(A)19 b(Q)o(UER)l(Y)g(COMPILER)555
801 y FA(you)36 b(could)f(e)o(xpect)g(to)i(use)g(the)f(binding)f(of)h
Fs(?x)p FA(,)k(because)35 b(no)h(matter)h(which)e(of)i(the)555
905 y(subqueries)23 b(succeeds,)i(it)h(will)f(generate)e(a)i(binding)e
(for)h Fs(?x)p FA(.)42 b(But)25 b(neither)f Fs(?y)g FA(nor)g
Fs(?b)h FA(is)555 1010 y(guaranteed)19 b(to)j(get)f(a)h(binding)e(from)
h(the)g(query)-5 b(,)20 b(though)g(one)h(or)g(the)g(other)g(will.)34
b(P)o(attern)555 1114 y(v)n(ariables)19 b(not)h(bound)f(by)g(the)i
(query)d(will)j(be)f Fs(nil)g FA(for)f(that)i(iteration.)-2172
b Fq(\016)555 1367 y Fw(19.5)99 b(A)25 b(Query)g(Compiler)555
1558 y FA(The)k(code)g(in)h(Figure)f(19.3)g(does)g(what)h(we)g(w)o
(ant,)i(b)n(ut)e(inef)n(\002ciently)-5 b(.)55 b(It)30
b(analyzes)g(the)555 1662 y(structure)f(of)h(the)g(query)e(at)i
(runtime,)h(though)d(it)j(is)g(kno)n(wn)d(at)j(compile\255time.)56
b(And)30 b(it)555 1767 y(conses)19 b(up)g(lists)i(to)f(hold)e(v)n
(ariable)g(bindings,)g(when)h(we)h(could)e(use)i(the)f(v)n(ariables)g
(to)g(hold)555 1872 y(their)c(o)n(wn)h(v)n(alues.)27
b(Both)16 b(of)f(these)h(problems)e(can)i(be)f(solv)o(ed)g(by)g
(de\002ning)g Fs(with-answer)555 1976 y FA(in)20 b(a)h(dif)n(ferent)d
(w)o(ay)-5 b(.)680 2081 y(Figure)26 b(19.6)f(de\002nes)h(a)i(ne)n(w)e
(v)o(ersion)f(of)i Fs(with-answer)p FA(.)44 b(The)27
b(ne)n(w)f(v)o(ersion)f(con\255)555 2185 y(tinues)f(a)h(trend)f(which)f
(be)o(gan)g(with)i Fs(avg)e FA(\(page)h(182\),)g(and)f(continued)g
(with)h Fs(if-match)555 2290 y FA(\(page)j(242\):)44
b(it)29 b(does)f(at)g(compile\255time)f(much)g(of)h(the)g(w)o(ork)f
(that)h(the)g(old)g(v)o(ersion)f(did)555 2395 y(at)i(runtime.)54
b(The)28 b(code)g(in)h(Figure)f(19.6)g(bears)g(a)h(super\002cial)f
(resemblance)g(to)h(that)f(in)555 2499 y(Figure)f(19.3,)h(b)n(ut)g
(none)e(of)i(these)f(functions)g(are)g(called)h(at)g(runtime.)50
b(Instead)27 b(of)g(gen\255)555 2604 y(erating)j(bindings,)i(the)o(y)e
(generate)f(code,)k(which)d(becomes)g(part)g(of)g(the)h(e)o(xpansion)e
(of)555 2708 y Fs(with-answer)p FA(.)j(At)23 b(runtime)e(this)i(code)f
(will)h(generate)e(all)i(the)f(bindings)f(which)h(satisfy)555
2813 y(the)e(query)f(according)f(to)i(the)h(current)e(state)h(of)g(the)
h(database.)680 2918 y(In)f(ef)n(fect,)h(this)h(program)d(is)j(one)e
(big)h(macro.)31 b(Figure)21 b(19.7)f(sho)n(ws)h(the)g(macroe)o
(xpan\255)555 3022 y(sion)27 b(of)g(a)g Fs(with-answer)p
FA(.)45 b(Most)27 b(of)g(the)g(w)o(ork)f(is)i(done)e(by)g
Fs(pat-match)e FA(\(page)i(242\),)555 3127 y(which)f(is)i(itself)f(a)g
(macro.)44 b(No)n(w)25 b(the)h(only)f(ne)n(w)g(functions)f(needed)h(at)
h(runtime)e(are)i(the)555 3232 y(basic)20 b(database)g(functions)f(sho)
n(wn)g(in)i(Figure)e(19.1.)680 3336 y(When)j Fs(with-answer)d
FA(is)k(called)g(from)e(the)i(tople)n(v)o(el,)f(query)f(compilation)g
(has)i(little)555 3441 y(adv)n(antage.)31 b(The)21 b(code)g
(representing)f(the)h(query)f(is)j(generated,)d(e)n(v)n(aluated,)g
(then)h(thro)n(wn)555 3545 y(a)o(w)o(ay)-5 b(.)36 b(But)24
b(when)e(a)h Fs(with-answer)c FA(e)o(xpression)j(appears)f(within)i(a)g
(Lisp)g(program,)f(the)555 3650 y(code)k(representing)f(the)j(query)d
(becomes)i(part)f(of)h(its)h(macroe)o(xpansion.)47 b(So)27
b(when)g(the)555 3755 y(containing)h(program)g(is)k(compiled,)f(the)f
(code)g(for)f(all)i(the)f(queries)g(will)h(be)f(compiled)555
3859 y(inline)20 b(in)g(the)g(process.)680 3964 y(Although)h(the)h
(primary)f(adv)n(antage)g(of)i(the)g(ne)n(w)f(approach)f(is)i(speed,)g
(it)h(also)f(mak)o(es)555 4068 y Fs(with-answer)d FA(e)o(xpressions)j
(better)h(inte)o(grated)e(with)j(the)f(code)f(in)i(which)e(the)o(y)h
(appear)-5 b(.)555 4173 y(This)23 b(sho)n(ws)g(in)g(tw)o(o)h
(speci\002c)f(impro)o(v)o(ements.)35 b(First,)24 b(the)f(ar)o(guments)e
(within)i(the)g(query)555 4278 y(no)n(w)d(get)g(e)n(v)n(aluated,)e(so)j
(we)f(can)g(say:)555 4460 y Fs(>)43 b(\(setq)f(my-favorite-yea)o(r)c
(1723\))555 4560 y(1723)555 4660 y(>)43 b(\(with-answer)c(\(dates)i(?x)
i(my-favorite-yea)o(r)38 b(?d\))729 4759 y(\(format)j(t)i("~A)g(was)f
(born)g(in)h(my)f(favorite)f(year.~\045")f(?x\)\))555
4859 y(REYNOLDS)g(was)j(born)f(in)g(my)h(favorite)d(year.)555
4958 y(NIL)p eop
%%Page: 255 268
255 267 bop 555 538 a Ft(19.5)923 b Fu(A)19 b(Q)o(UER)l(Y)g(COMPILER)
905 b FA(255)p 555 745 2678 4 v 553 4956 4 4212 v 605
888 a Fs(\(defmacro)40 b(with-answer)f(\(query)i(&body)g(body\))692
988 y(`\(with-gensyms)d(,\(vars-in)i(query)h(#'simple?\))823
1087 y(,\(compile-query)c(query)42 b(`\(progn)e(,@body\)\)\)\))605
1287 y(\(defun)h(compile-query)d(\(q)43 b(body\))692
1386 y(\(case)f(\(car)f(q\))779 1486 y(\(and)86 b(\(compile-and)38
b(\(cdr)k(q\))h(body\)\))779 1586 y(\(or)130 b(\(compile-or)82
b(\(cdr)42 b(q\))h(body\)\))779 1685 y(\(not)86 b(\(compile-not)38
b(\(cadr)k(q\))h(body\)\))779 1785 y(\(lisp)f(`\(if)g(,\(cadr)f(q\))h
(,body\)\))779 1884 y(\(t)174 b(\(compile-simple)37 b(q)43
b(body\)\)\)\))605 2084 y(\(defun)e(compile-simple)d(\(q)k(body\))692
2183 y(\(let)g(\(\(fact)f(\(gensym\)\)\))779 2283 y(`\(dolist)f
(\(,fact)i(\(db-query)d(',\(car)j(q\)\)\))910 2383 y(\(pat-match)d
(,\(cdr)j(q\))h(,fact)e(,body)h(nil\)\)\)\))605 2582
y(\(defun)f(compile-and)e(\(clauses)h(body\))692 2681
y(\(if)i(\(null)g(clauses\))866 2781 y(body)866 2881
y(\(compile-query)c(\(car)k(clauses\))1520 2980 y(\(compile-and)d
(\(cdr)j(clauses\))e(body\)\)\)\))605 3180 y(\(defun)h(compile-or)e
(\(clauses)i(body\))692 3279 y(\(if)h(\(null)g(clauses\))866
3379 y(nil)866 3478 y(\(let)g(\(\(gbod)f(\(gensym\)\))1128
3578 y(\(vars)g(\(vars-in)g(body)h(#'simple?\)\)\))954
3678 y(`\(labels)e(\(\(,gbod)g(,vars)i(,body\)\))1084
3777 y(,@\(mapcar)e(#'\(lambda)g(\(cl\))1694 3877 y(\(compile-query)e
(cl)43 b(`\(,gbod)e(,@vars\)\)\))1520 3977 y(clauses\)\)\)\)\))605
4176 y(\(defun)g(compile-not)e(\(q)k(body\))692 4275
y(\(let)f(\(\(tag)f(\(gensym\)\)\))779 4375 y(`\(if)h(\(block)f(,tag)
1084 4475 y(,\(compile-query)d(q)43 b(`\(return-from)38
b(,tag)k(nil\)\))1084 4574 y(t\))997 4674 y(,body\)\)\))1406
4878 y FA(Figure)19 b(19.6:)29 b(Query)19 b(compiler)-5
b(.)p 3231 4956 V 555 4960 2678 4 v eop
%%Page: 256 269
256 268 bop 555 538 a FA(256)924 b Fu(A)19 b(Q)o(UER)l(Y)g(COMPILER)p
555 745 2678 4 v 553 2906 4 2161 v 605 888 a Fs(\(with-answer)38
b(\(painter)j(?x)h(?y)h(?z\))692 988 y(\(format)e(t)i("~A)f(~A)h(is)g
(a)g(painter.~\045")c(?y)k(?x\)\))605 1204 y FA(is)21
b(e)o(xpanded)d(by)h(the)i(query)d(interpreter)h(into:)605
1370 y Fs(\(dolist)41 b(\(#:g1)g(\(interpret-query)c('\(painter)j(?x)j
(?y)f(?z\)\)\))692 1469 y(\(let)g(\(\(?x)g(\(binding)e('?x)i(#:g1\)\))
954 1569 y(\(?y)g(\(binding)e('?y)i(#:g1\)\))954 1669
y(\(?z)g(\(binding)e('?z)i(#:g1\)\)\))779 1768 y(\(format)f(t)i("~A)f
(~A)h(is)g(a)g(painter.~\045")c(?y)k(?x\)\)\))605 1976
y FA(and)19 b(by)h(the)g(query)f(compiler)g(into:)605
2142 y Fs(\(with-gensyms)38 b(\(?x)k(?y)h(?z\))692 2241
y(\(dolist)e(\(#:g1)g(\(db-query)f('painter\)\))779 2341
y(\(pat-match)g(\(?x)i(?y)h(?z\))f(#:g1)997 2441 y(\(progn)1084
2540 y(\(format)f(t)i("~A)f(~A)h(is)g(a)g(painter.~\045")c(?y)k(?x\)\))
997 2640 y(nil\)\)\))1095 2828 y FA(Figure)19 b(19.7:)29
b(T)-7 b(w)o(o)20 b(e)o(xpansions)f(of)g(the)i(same)f(query)-5
b(.)p 3231 2906 V 555 2909 2678 4 v 555 3120 a(This)21
b(could)f(ha)n(v)o(e)g(been)g(done)g(in)h(the)g(query)e(interpreter)m
(,)g(b)n(ut)h(only)g(at)i(the)e(cost)i(of)e(calling)555
3224 y Fs(eval)g FA(e)o(xplicitly)-5 b(.)30 b(And)20
b(e)n(v)o(en)g(then,)h(it)g(w)o(ouldn')o(t)e(ha)n(v)o(e)i(been)f
(possible)h(to)g(refer)f(to)h(le)o(xical)555 3329 y(v)n(ariables)e(in)i
(the)f(query)f(ar)o(guments.)680 3434 y(Since)j(ar)o(guments)e(within)j
(queries)e(are)i(no)n(w)f(e)n(v)n(aluated,)f(an)o(y)h(literal)g(ar)o
(gument)e(\(e.g.)555 3538 y Fs(english)p FA(\))c(that)i(doesn')o(t)f(e)
n(v)n(aluate)g(to)h(itself)h(should)e(no)n(w)h(be)g(quoted.)27
b(\(See)19 b(Figure)e(19.8.\))680 3643 y(The)27 b(second)f(adv)n
(antage)f(of)i(the)h(ne)n(w)f(approach)e(is)j(that)g(it)g(is)g(no)n(w)f
(much)f(easier)h(to)555 3747 y(include)18 b(normal)f(Lisp)i(e)o
(xpressions)e(within)i(queries.)28 b(The)18 b(query)g(compiler)f(adds)i
(a)g Fs(lisp)555 3852 y FA(operator)m(,)g(which)i(may)f(be)h(follo)n
(wed)f(by)h(an)o(y)f(Lisp)i(e)o(xpression.)30 b(Lik)o(e)21
b(the)g Fs(not)g FA(operator)m(,)555 3957 y(it)31 b(cannot)d(generate)h
(bindings)f(by)h(itself,)k(b)n(ut)d(it)g(will)h(screen)e(out)h
(bindings)e(for)h(which)555 4061 y(the)g(e)o(xpression)e(returns)h
Fs(nil)p FA(.)54 b(The)29 b Fs(lisp)f FA(operator)f(is)i(useful)g(for)f
(getting)g(at)h(b)n(uilt\255in)555 4166 y(predicates)19
b(lik)o(e)i Fs(>)p FA(:)555 4332 y Fs(>)43 b(\(with-answer)c(\(and)j
(\(dates)f(?x)i(?b)f(?d\))1427 4431 y(\(lisp)f(\(>)i(\(-)g(?d)g(?b\))f
(70\)\)\))729 4531 y(\(format)f(t)i("~A)g(lived)e(over)h(70)h
(years.~\045")d(?x\)\))555 4631 y(CANALE)h(lived)h(over)g(70)g(years.)
555 4730 y(HOGARTH)f(lived)g(over)h(70)h(years.)555 4830
y(NIL)555 5001 y FA(A)24 b(well\255implemented)d(embedded)g(language)h
(can)h(ha)n(v)o(e)g(a)h(seamless)g(interf)o(ace)f(with)h(the)p
eop
%%Page: 257 270
257 269 bop 555 538 a Ft(19.5)923 b Fu(A)19 b(Q)o(UER)l(Y)g(COMPILER)
905 b FA(257)p 555 745 2678 4 v 553 3577 4 2832 v 605
887 a Ft(The)20 b(\002r)o(st)h(name)f(and)f(nationality)g(of)h(e)o
(very)g(painter)g(called)g(Ho)o(garth.)605 1053 y Fs(>)43
b(\(with-answer)c(\(painter)h('hogarth)g(?x)j(?y\))779
1152 y(\(princ)e(\(list)h(?x)h(?y\)\)\))605 1252 y(\(WILLIAM)d
(ENGLISH\))605 1352 y(NIL)605 1518 y Ft(The)17 b(last)h(name)f(of)g(e)o
(very)h(English)e(painter)h(not)g(born)g(in)g(the)h(same)f(year)g(as)h
(a)g(V)-9 b(enetian)605 1617 y(painter)g(.)605 1783 y
Fs(>)43 b(\(with-answer)c(\(and)j(\(painter)e(?x)j(_)g('english\))1477
1883 y(\(dates)e(?x)h(?b)h(_\))1477 1983 y(\(not)e(\(and)h(\(painter)f
(?x2)h(_)h('venetian\))1912 2082 y(\(dates)f(?x2)g(?b)h(_\)\)\)\))779
2182 y(\(princ)e(?x\)\))605 2281 y(REYNOLDS)605 2381
y(NIL)605 2547 y Ft(The)21 b(last)h(name)f(and)f(year)h(of)h(death)e
(of)h(e)o(very)h(painter)e(who)h(died)g(between)g(1770)f(and)605
2647 y(1800)f(e)n(xclusive)o(.)605 2813 y Fs(>)43 b(\(with-answer)c
(\(and)j(\(painter)e(?x)j(_)g(_\))1477 2912 y(\(dates)e(?x)h(_)i(?d\))
1477 3012 y(\(lisp)d(\(<)i(1770)f(?d)h(1800\)\)\))779
3112 y(\(princ)e(\(list)h(?x)h(?d\)\)\))605 3211 y(\(REYNOLDS)d
(1792\)\(HOGARTH)e(1772\))605 3311 y(NIL)1230 3499 y
FA(Figure)19 b(19.8:)28 b(The)20 b(query)f(compiler)g(in)h(use.)p
3231 3577 V 555 3580 2678 4 v 555 3804 a(base)g(language)f(on)h(both)f
(sides.)680 3909 y(Aside)30 b(from)f(these)i(tw)o(o)g(additions\227the)
e(e)n(v)n(aluation)f(of)i(ar)o(guments)f(and)g(the)i(ne)n(w)555
4013 y Fs(lisp)21 b FA(operator)n(\227the)f(query)g(language)h
(supported)f(by)h(the)h(query)f(compiler)f(is)j(identical)555
4118 y(to)k(that)g(supported)f(by)g(the)h(interpreter)-5
b(.)49 b(Figure)26 b(19.8)g(sho)n(ws)h(e)o(xamples)f(of)h(the)g
(results)555 4223 y(generated)18 b(by)i(the)g(query)f(compiler)g(with)i
(the)f(database)f(as)i(de\002ned)e(in)i(Figure)e(19.4.)680
4327 y(Section)35 b(17.2)h(ga)n(v)o(e)f(tw)o(o)i(reasons)e(why)h(it)h
(is)g(better)f(to)h(compile)e(an)h(e)o(xpression)555
4432 y(than)27 b(feed)f(it,)j(as)f(a)g(list,)h(to)f Fs(eval)p
FA(.)48 b(The)27 b(former)f(is)i(f)o(aster)m(,)g(and)f(allo)n(ws)g(the)
g(e)o(xpression)555 4536 y(to)35 b(be)f(e)n(v)n(aluated)f(in)i(the)f
(surrounding)d(le)o(xical)j(conte)o(xt.)71 b(The)34 b(adv)n(antages)f
(of)h(query)555 4641 y(compilation)21 b(are)h(e)o(xactly)g(analogous.)
34 b(W)-7 b(ork)22 b(that)h(used)f(to)h(be)f(done)f(at)i(runtime)f(is)h
(no)n(w)555 4746 y(done)e(at)i(compile\255time.)35 b(And)21
b(because)h(the)h(queries)e(are)i(compiled)e(as)i(a)g(piece)f(with)h
(the)555 4850 y(surrounding)17 b(Lisp)j(code,)g(the)o(y)f(can)h(tak)o
(e)g(adv)n(antage)f(of)g(the)i(le)o(xical)f(conte)o(xt.)p
eop
%%Page: 258 271
258 270 bop 555 1610 a Fn(20)p 555 1872 2686 3 v 555
2131 a Fx(Continuations)555 2568 y FA(A)16 b(continuation)e(is)j(a)f
(program)e(frozen)g(in)i(action:)27 b(a)16 b(single)g(functional)e
(object)h(containing)555 2672 y(the)22 b(state)g(of)f(a)h(computation.)
31 b(When)21 b(the)h(object)f(is)h(e)n(v)n(aluated,)e(the)i(stored)f
(computation)555 2777 y(is)36 b(restarted)e(where)h(it)g(left)g(of)n
(f.)73 b(In)35 b(solving)f(certain)g(types)h(of)g(problems)e(it)j(can)f
(be)555 2882 y(a)e(great)g(help)f(to)h(be)g(able)f(to)h(sa)n(v)o(e)g
(the)g(state)g(of)g(a)g(program)e(and)h(restart)h(it)g(later)-5
b(.)68 b(In)555 2986 y(multiprocessing,)15 b(for)h(e)o(xample,)g(a)i
(continuation)c(con)m(v)o(eniently)g(represents)i(a)h(suspended)555
3091 y(process.)27 b(In)15 b(nondeterministic)e(search)i(programs,)f(a)
i(continuation)d(can)i(represent)f(a)i(node)555 3195
y(in)k(the)h(search)e(tree.)680 3300 y(Continuations)30
b(can)h(be)h(dif)n(\002cult)f(to)h(understand.)62 b(This)32
b(chapter)f(approaches)f(the)555 3405 y(topic)18 b(in)g(tw)o(o)g
(steps.)29 b(The)18 b(\002rst)h(part)e(of)h(the)g(chapter)f(looks)h(at)
g(the)g(use)h(of)e(continuations)f(in)555 3509 y(Scheme,)j(which)g(has)
g(b)n(uilt\255in)g(support)f(for)h(them.)29 b(Once)19
b(the)h(beha)n(vior)d(of)j(continuations)-2788 b Fq(\016)555
3614 y FA(has)13 b(been)g(e)o(xplained,)e(the)i(second)g(part)g(sho)n
(ws)g(ho)n(w)g(to)g(use)g(macro)o(s)g(to)g(b)n(uild)g(c)o(on)o
(tinuatio)o(ns)555 3718 y(in)32 b(Common)e(Lisp)h(programs.)61
b(Chapters)31 b(21\22624)e(will)j(all)g(mak)o(e)f(use)h(of)f(the)g
(macros)555 3823 y(de\002ned)19 b(here.)555 4076 y Fw(20.1)99
b(Scheme)26 b(Continuations)680 4266 y FA(One)21 b(of)h(the)f
(principal)g(w)o(ays)h(in)g(which)f(Scheme)g(dif)n(fers)g(from)g
(Common)f(Lisp)i(is)h(its)555 4371 y(e)o(xplicit)c(support)f(for)h
(continuations.)27 b(This)20 b(section)g(sho)n(ws)g(ho)n(w)f
(continuations)e(w)o(ork)i(in)555 4476 y(Scheme.)28 b(\(Figure)17
b(20.1)g(lists)i(some)f(other)f(dif)n(ferences)g(between)g(Scheme)g
(and)h(Common)555 4580 y(Lisp.\))680 4685 y(A)i(continuation)e(is)j(a)g
(function)e(representing)f(the)i(future)f(of)h(a)h(computation.)27
b(When\255)555 4789 y(e)n(v)o(er)22 b(an)g(e)o(xpression)g(is)h(e)n(v)n
(aluated,)f(something)f(is)j(w)o(aiting)e(for)g(the)h(v)n(alue)f(it)i
(will)f(return.)555 4894 y(F)o(or)d(e)o(xample,)e(in)1835
5229 y(258)p eop
%%Page: 259 272
259 271 bop 555 538 a Ft(20.1)845 b Fu(SCHEME)18 b(CONTINU)n(A)-7
b(TIONS)828 b FA(259)p 555 745 2678 4 v 553 4971 4 4226
v 605 886 a(1.)41 b(Scheme)k(mak)o(es)h(no)f(distinction)g(between)g
(what)h(Common)e(Lisp)i(calls)h(the)605 986 y Fs(symbol-value)31
b FA(and)j Fs(symbol-function)c FA(of)35 b(a)h(symbol.)73
b(In)35 b(Scheme,)j(a)e(v)n(ari\255)605 1086 y(able)25
b(has)g(a)h(single)f(v)n(alue,)g(which)g(can)g(be)g(either)g(a)g
(function)f(or)h(some)g(other)f(sort)h(of)605 1185 y(object.)51
b(Thus)27 b(there)g(is)i(no)e(need)g(for)g(sharp\255quote)e(or)i
Fs(funcall)f FA(in)h(Scheme.)51 b(The)605 1285 y(Common)19
b(Lisp:)605 1445 y Fs(\(let)42 b(\(\(f)g(#'\(lambda)e(\(x\))i(\(1+)h
(x\)\)\)\))692 1544 y(\(funcall)d(f)j(2\)\))605 1710
y FA(w)o(ould)19 b(be)h(in)h(Scheme:)605 1876 y Fs(\(let)42
b(\(\(f)g(\(lambda)f(\(x\))h(\(1+)g(x\)\)\)\))692 1976
y(\(f)h(2\)\))605 2147 y FA(2.)e(Since)20 b(Scheme)g(has)g(only)g(one)g
(name\255space,)e(it)j(doesn')o(t)e(need)h(separate)g(operators)605
2252 y(\(e.g.)g Fs(defun)f FA(and)i Fs(setq)p FA(\))e(for)h
(assignments)h(in)g(each.)31 b(Instead)20 b(it)h(has)h
Fs(define)p FA(,)d(which)605 2356 y(is)29 b(roughly)d(equi)n(v)n(alent)
g(to)i Fs(defvar)p FA(,)g(and)f Fs(set!)p FA(,)i(which)e(tak)o(es)i
(the)f(place)g(of)f Fs(setq)p FA(.)605 2461 y(Global)j(v)n(ariables)g
(must)h(be)g(created)g(with)g Fs(define)e FA(before)g(the)o(y)h(can)h
(be)g(set)h(with)605 2565 y Fs(set!)p FA(.)605 2730 y(3.)41
b(In)19 b(Scheme,)g(named)f(functions)h(are)g(usually)g(de\002ned)g
(with)h Fs(define)p FA(,)e(which)h(tak)o(es)605 2835
y(the)h(place)g(of)g Fs(defun)f FA(as)h(well)h(as)g Fs(defvar)p
FA(.)27 b(The)20 b(Common)f(Lisp:)605 3006 y Fs(\(defun)41
b(foo)h(\(x\))h(\(1+)f(x\)\))605 3172 y FA(has)20 b(tw)o(o)h(possible)f
(Scheme)f(translations:)605 3338 y Fs(\(define)41 b(foo)h(\(lambda)f
(\(x\))h(\(1+)g(x\)\)\))605 3437 y(\(define)f(\(foo)g(x\))i(\(1+)g
(x\)\))605 3608 y FA(4.)e(In)17 b(Common)f(Lisp,)i(the)g(ar)o(guments)d
(to)j(a)g(function)e(are)h(e)n(v)n(aluated)f(left\255to\255right.)26
b(In)605 3713 y(Scheme,)13 b(the)g(order)g(of)g(e)n(v)n(aluation)g(is)g
(deliber)o(ately)g(u)o(nspec)o(i\002ed.)21 b(\(And)13
b(implementors)605 3818 y(delight)19 b(in)i(surprising)d(those)i(who)g
(for)o(get)f(this.\))605 3982 y(5.)41 b(Instead)19 b(of)h
Fs(t)h FA(and)f Fs(nil)p FA(,)f(Scheme)h(has)h Fs(#t)f
FA(and)g Fs(#f)p FA(.)30 b(The)20 b(empty)f(list,)i Fs(\(\))p
FA(,)f(is)i(true)e(in)605 4087 y(some)g(implementations)e(and)i(f)o
(alse)g(in)h(others.)605 4251 y(6.)41 b(The)34 b(def)o(ault)f(clause)i
(in)f Fs(cond)g FA(and)f Fs(case)h FA(e)o(xpressions)f(has)h(the)h(k)o
(e)o(y)f Fs(else)f FA(in)605 4356 y(Scheme,)19 b(instead)h(of)g
Fs(t)g FA(as)h(in)g(Common)d(Lisp.)605 4521 y(7.)41 b(Se)n(v)o(eral)23
b(b)n(uilt\255in)h(operators)e(ha)n(v)o(e)i(dif)n(ferent)e(names:)38
b Fs(consp)22 b FA(is)j Fs(pair?)p FA(,)f Fs(null)f FA(is)605
4625 y Fs(null?)p FA(,)15 b Fs(mapcar)g FA(is)i(\(almost\))f
Fs(map)p FA(,)h(and)f(so)h(on.)27 b(Ordinarily)15 b(these)i(should)e
(be)i(ob)o(vious)605 4730 y(from)i(the)h(conte)o(xt.)767
4893 y(Figure)g(20.1:)28 b(Some)20 b(dif)n(ferences)e(between)i(Scheme)
f(and)h(Common)f(Lisp.)p 3231 4971 V 555 4974 2678 4
v eop
%%Page: 260 273
260 272 bop 555 538 a FA(260)977 b Fu(CONTINU)n(A)-7
b(TIONS)555 801 y Fs(\(/)43 b(\(-)g(x)g(1\))f(2\))555
988 y FA(when)23 b Fs(\(-)43 b(x)g(1\))24 b FA(is)h(e)n(v)n(aluated,)e
(the)h(outer)f Fs(/)h FA(e)o(xpression)e(is)j(w)o(aiting)f(for)f(the)h
(v)n(alue,)g(and)555 1093 y(something)e(else)j(is)f(w)o(aiting)g(for)f
Ft(its)i FA(v)n(alue,)f(and)f(so)h(on)f(and)g(so)h(on,)g(all)h(the)f(w)
o(ay)f(back)g(to)555 1197 y(the)d(tople)n(v)o(el\227where)e
Fs(print)h FA(is)i(w)o(aiting.)680 1302 y(W)-7 b(e)36
b(can)f(think)f(of)h(the)h(continuation)d(at)i(an)o(y)g(gi)n(v)o(en)f
(time)h(as)h(a)g(function)d(of)i(one)555 1407 y(ar)o(gument.)30
b(If)21 b(the)g(pre)n(vious)f(e)o(xpression)f(were)i(typed)f(into)h
(the)g(tople)n(v)o(el,)f(then)h(when)g(the)555 1511 y(sube)o(xpression)
d Fs(\(-)43 b(x)g(1\))20 b FA(w)o(as)h(e)n(v)n(aluated,)d(the)j
(continuation)c(w)o(ould)j(be:)555 1694 y Fs(\(lambda)41
b(\(val\))g(\(/)i(val)f(2\)\))555 1882 y FA(That)32 b(is,)k(the)c
(remainder)e(of)i(the)g(computation)e(could)h(be)h(duplicated)f(by)g
(calling)h(this)555 1986 y(function)22 b(on)h(the)g(return)g(v)n(alue.)
38 b(If)23 b(instead)g(the)h(e)o(xpression)e(occurred)f(in)j(the)f
(follo)n(wing)555 2091 y(conte)o(xt)555 2273 y Fs(\(define)41
b(\(f1)h(w\))642 2373 y(\(let)g(\(\(y)g(\(f2)h(w\)\)\))729
2473 y(\(if)g(\(integer?)d(y\))i(\(list)g('a)h(y\))f('b\)\)\))555
2672 y(\(define)f(\(f2)h(x\))642 2772 y(\(/)h(\(-)g(x)g(1\))g(2\)\))555
2959 y FA(and)30 b Fs(f1)g FA(were)h(called)f(from)f(the)i(tople)n(v)o
(el,)h(then)e(when)g Fs(\(-)42 b(x)i(1\))30 b FA(w)o(as)h(e)n(v)n
(aluated,)h(the)555 3064 y(continuation)18 b(w)o(ould)h(be)h(equi)n(v)n
(alent)f(to)555 3246 y Fs(\(lambda)41 b(\(val\))642 3346
y(\(let)h(\(\(y)g(\(/)h(val)g(2\)\)\))729 3446 y(\(if)g(\(integer?)d
(y\))i(\(list)g('a)h(y\))f('b\)\)\))680 3633 y FA(In)23
b(Scheme,)h(continuations)e(are)i(\002rst\255class)g(objects,)g(just)h
(lik)o(e)f(functions.)39 b(Y)-9 b(ou)23 b(can)555 3738
y(ask)h(Scheme)f(for)g(the)h(current)e(continuation,)g(and)i(it)g(will)
g(mak)o(e)g(you)f(a)h(function)e(of)h(one)555 3843 y(ar)o(gument)16
b(representing)h(the)i(future)f(of)g(the)h(computation.)27
b(Y)-9 b(ou)18 b(can)g(sa)n(v)o(e)i(this)f(object)f(for)555
3947 y(as)23 b(long)e(as)j(you)d(lik)o(e,)i(and)f(when)f(you)h(call)g
(it,)i(it)f(will)g(restart)f(the)g(computation)e(that)j(w)o(as)555
4052 y(taking)c(place)h(when)g(it)h(w)o(as)g(created.)680
4156 y(Continuations)d(can)i(be)h(understood)c(as)k(a)g(generalization)
d(of)i(closures.)29 b(A)21 b(closure)f(is)555 4261 y(a)i(function)f
(plus)h(pointers)f(to)h(the)g(le)o(xical)g(v)n(ariables)f(visible)h(at)
h(the)f(time)g(it)h(w)o(as)g(created.)555 4366 y(A)e(continuation)d(is)
j(a)g(function)e(plus)h(a)h(pointer)e(to)i(the)f(whole)g(stack)h
(pending)d(at)j(the)f(time)555 4470 y(it)i(w)o(as)g(created.)32
b(When)22 b(a)f(continuation)e(is)k(e)n(v)n(aluated,)d(it)i(returns)e
(a)i(v)n(alue)f(using)g(its)h(o)n(wn)555 4575 y(cop)o(y)f(of)g(the)g
(stack,)h(ignoring)d(the)j(current)e(one.)32 b(If)22
b(a)g(continuation)d(is)j(created)f(at)h Ft(T)3065 4587
y Fm(1)3120 4575 y FA(and)555 4679 y(e)n(v)n(aluated)d(at)h
Ft(T)1016 4691 y Fm(2)1050 4679 y FA(,)g(it)h(will)g(be)f(e)n(v)n
(aluated)f(with)h(the)h(stack)f(that)g(w)o(as)h(pending)e(at)h
Ft(T)2933 4691 y Fm(1)2967 4679 y FA(.)680 4784 y(Scheme)34
b(programs)f(ha)n(v)o(e)i(access)g(to)h(the)f(current)e(continuation)g
(via)i(the)g(b)n(uilt\255in)555 4889 y(operator)29 b
Fs(call-with-current)o(-co)o(nt)o(in)o(uat)o(io)o(n)d
FA(\()p Fs(call/cc)i FA(for)j(short\).)61 b(When)31 b(a)555
4993 y(program)18 b(calls)j Fs(call/cc)d FA(on)i(a)g(function)f(of)h
(one)f(ar)o(gument:)p eop
%%Page: 261 274
261 273 bop 555 538 a Ft(20.1)845 b Fu(SCHEME)18 b(CONTINU)n(A)-7
b(TIONS)828 b FA(261)555 801 y Fs(\(call-with-curre)o(nt-)o(co)o(nt)o
(inu)o(at)o(ion)642 900 y(\(lambda)41 b(\(cc\))729 1000
y(...\)\))555 1162 y FA(the)16 b(function)f(will)i(be)f(passed)h
(another)e(function)f(representing)h(the)h(current)f(continuation.)555
1266 y(By)k(storing)e(the)i(v)n(alue)e(of)h Fs(cc)g FA(some)n(where,)f
(we)i(sa)n(v)o(e)f(the)h(state)g(of)f(the)g(computation)e(at)j(the)555
1371 y(point)g(of)h(the)h Fs(call/cc)p FA(.)680 1475
y(In)28 b(this)g(e)o(xample,)h(we)g Fs(append)d FA(together)h(a)i(list)
g(whose)f(last)h(element)f(is)h(the)f(v)n(alue)555 1580
y(returned)18 b(by)i(a)h Fs(call/cc)d FA(e)o(xpression:)555
1737 y Fs(>)43 b(\(define)e(frozen\))555 1836 y(FROZEN)555
1936 y(>)i(\(append)e('\(the)g(call/cc)g(returned\))991
2036 y(\(list)g(\(call-with-curren)o(t-c)o(on)o(ti)o(nua)o(ti)o(on)1340
2135 y(\(lambda)f(\(cc\))1427 2235 y(\(set!)h(frozen)g(cc\))1427
2335 y('a\)\)\)\))555 2434 y(\(THE)h(CALL/CC)f(RETURNED)f(A\))555
2596 y FA(The)31 b Fs(call/cc)f FA(returns)h Fs(a)p FA(,)j(b)n(ut)e
(\002rst)g(sa)n(v)o(es)g(the)g(continuation)d(in)j(the)g(global)f(v)n
(ariable)555 2700 y Fs(frozen)p FA(.)680 2805 y(Calling)21
b Fs(frozen)f FA(will)i(restart)g(the)g(old)f(computation)e(at)k(the)e
(point)g(of)g(the)h Fs(call/cc)p FA(.)555 2910 y(Whate)n(v)o(er)d(v)n
(alue)h(we)g(pass)h(to)f Fs(frozen)f FA(will)h(be)h(returned)d(as)j
(the)f(v)n(alue)g(of)g(the)g Fs(call/cc)p FA(:)555 3066
y Fs(>)43 b(\(frozen)e('again\))555 3166 y(\(THE)h(CALL/CC)f(RETURNED)f
(AGAIN\))555 3328 y FA(Continuations)21 b(aren')o(t)g(used)h(up)g(by)g
(being)g(e)n(v)n(aluated.)34 b(The)o(y)22 b(can)g(be)h(called)f
(repeatedly)-5 b(,)555 3432 y(just)21 b(lik)o(e)f(an)o(y)g(other)f
(functional)f(object:)555 3589 y Fs(>)43 b(\(frozen)e('thrice\))555
3689 y(\(THE)h(CALL/CC)f(RETURNED)f(THRICE\))680 3850
y FA(When)28 b(we)i(call)f(a)g(continuation)e(within)h(some)h(other)f
(computation,)h(we)g(see)g(more)555 3955 y(clearly)20
b(what)g(it)h(means)f(to)g(return)f(back)g(up)h(the)g(old)g(stack:)555
4112 y Fs(>)43 b(\(+)g(1)g(\(frozen)e('safely\)\))555
4211 y(\(THE)h(CALL/CC)f(RETURNED)f(SAFELY\))555 4373
y FA(Here,)34 b(the)e(pending)d Fs(+)j FA(is)g(ignored)e(when)h
Fs(frozen)f FA(is)i(called.)63 b(The)32 b(latter)f(returns)g(up)555
4478 y(the)d(stack)g(that)h(w)o(as)g(pending)d(at)i(the)h(time)f(it)h
(w)o(as)g(\002rst)g(created:)44 b(through)26 b Fs(list)p
FA(,)j(then)555 4582 y Fs(append)p FA(,)22 b(to)i(the)g(tople)n(v)o
(el.)38 b(If)23 b Fs(frozen)f FA(returned)f(a)j(v)n(alue)f(lik)o(e)h(a)
g(normal)f(function)e(call,)555 4687 y(the)f(e)o(xpression)f(abo)o(v)o
(e)f(w)o(ould)i(ha)n(v)o(e)f(yielded)h(an)g(error)f(when)g
Fs(+)i FA(tried)f(to)g(add)g Fs(1)g FA(to)g(a)h(list.)680
4791 y(Continuations)15 b(do)h(not)g(get)h(unique)e(copies)i(of)f(the)h
(stack.)28 b(The)o(y)16 b(may)g(share)g(v)n(ariables)555
4896 y(with)26 b(other)f(continuations,)f(or)i(with)g(the)f
(computation)f(currently)f(in)j(progress.)45 b(In)25
b(this)555 5001 y(e)o(xample,)19 b(tw)o(o)h(continuations)e(share)i
(the)g(same)h(stack:)p eop
%%Page: 262 275
262 274 bop 555 538 a FA(262)977 b Fu(CONTINU)n(A)-7
b(TIONS)555 801 y Fs(>)43 b(\(define)e(froz1\))555 900
y(FROZ1)555 1000 y(>)i(\(define)e(froz2\))555 1100 y(FROZ2)555
1199 y(>)i(\(let)f(\(\(x)g(0\)\))729 1299 y(\(call-with-curren)o(t-)o
(con)o(ti)o(nua)o(ti)o(on)817 1398 y(\(lambda)e(\(cc\))904
1498 y(\(set!)h(froz1)h(cc\))904 1598 y(\(set!)f(froz2)h(cc\)\)\))729
1697 y(\(set!)g(x)h(\(1+)f(x\)\))729 1797 y(x\))555 1897
y(1)555 2072 y FA(so)21 b(calls)f(to)h(either)f(will)h(return)e
(successi)n(v)o(e)g(inte)o(gers:)555 2242 y Fs(>)43 b(\(froz2)e(\(\)\))
555 2342 y(2)555 2441 y(>)i(\(froz1)e(\(\)\))555 2541
y(3)555 2716 y FA(Since)28 b(the)g(v)n(alue)f(of)h(the)g
Fs(call/cc)d FA(e)o(xpression)i(will)i(be)e(discarded,)i(it)f(doesn')o
(t)f(matter)555 2821 y(what)20 b(ar)o(gument)e(we)j(gi)n(v)o(e)e(to)h
Fs(froz1)f FA(and)h Fs(froz2)p FA(.)680 2926 y(No)n(w)29
b(that)g(we)h(can)g(store)f(the)g(state)i(of)e(a)h(computation,)f(what)
g(do)g(we)h(do)f(with)h(it?)555 3030 y(Chapters)e(21\22624)f(are)h(de)n
(v)n(oted)f(to)i(applications)e(which)h(use)h(continuations.)52
b(Here)28 b(we)555 3135 y(will)g(consider)f(a)h(simple)g(e)o(xample)e
(which)h(con)m(v)o(e)o(ys)f(well)i(the)g(\003a)n(v)n(or)g(of)f
(programming)555 3239 y(with)20 b(sa)n(v)o(ed)f(states:)30
b(we)20 b(ha)n(v)o(e)f(a)g(set)i(of)e(trees,)h(and)e(we)i(w)o(ant)g(to)
f(generate)g(lists)h(containing)555 3344 y(one)c(element)g(from)g(each)
h(tree,)g(until)f(we)h(get)g(a)g(combination)e(satisfying)h(some)h
(condition.)680 3449 y(T)m(rees)h(can)h(be)g(represented)e(as)i(nested)
g(lists.)30 b(P)o(age)19 b(70)f(described)g(a)h(w)o(ay)g(to)g
(represent)555 3553 y(one)d(kind)g(of)g(tree)h(as)g(a)g(list.)29
b(Here)16 b(we)h(use)g(another)m(,)e(which)h(allo)n(ws)h(interior)f
(nodes)f(to)i(ha)n(v)o(e)555 3658 y(\(atomic\))25 b(v)n(alues,)i(and)e
(an)o(y)g(number)f(of)i(children.)45 b(In)26 b(this)h(representation,)e
(an)h(interior)555 3762 y(node)k(becomes)g(a)i(list;)38
b(its)32 b(car)f(contains)g(the)g(v)n(alue)g(stored)f(at)i(the)f(node,)
i(and)e(its)h(cdr)555 3867 y(contains)26 b(the)h(representations)e(of)i
(the)g(node')-5 b(s)26 b(children.)48 b(F)o(or)27 b(e)o(xample,)g(the)g
(tw)o(o)g(trees)555 3972 y(sho)n(wn)19 b(in)i(Figure)e(20.2)g(can)h(be)
g(represented:)555 4142 y Fs(\(define)41 b(t1)h('\(a)h(\(b)g(\(d)f
(h\)\))h(\(c)f(e)i(\(f)e(i\))h(g\)\)\))555 4242 y(\(define)e(t2)h('\(1)
h(\(2)g(\(3)f(6)h(7\))g(4)g(5\)\)\))680 4417 y FA(Figure)14
b(20.3)h(contains)f(functions)g(which)h(do)g(depth\255\002rst)g(tra)n
(v)o(ersals)g(on)g(such)g(trees.)28 b(In)555 4521 y(a)19
b(real)g(program)e(we)i(w)o(ould)f(w)o(ant)h(to)f(do)h(something)e
(with)i(the)g(nodes)f(as)h(we)g(encountered)555 4626
y(them.)31 b(Here)21 b(we)g(just)h(print)e(them.)32 b(The)20
b(function)g Fs(dft)p FA(,)g(gi)n(v)o(en)g(for)g(comparison,)f(does)i
(an)555 4731 y(ordinary)d(depth\255\002rst)h(tra)n(v)o(ersal:)555
4901 y Fs(>)43 b(\(dft)f(t1\))555 5001 y(ABDHCEFIG\(\))p
eop
%%Page: 263 276
263 275 bop 555 538 a Ft(20.1)845 b Fu(SCHEME)18 b(CONTINU)n(A)-7
b(TIONS)828 b FA(263)p 555 745 2678 4 v 553 2105 4 1360
v 605 1911 a @beginspecial @setspecial @endspecial 1492
2027 a(Figure)19 b(20.2:)29 b(T)-7 b(w)o(o)20 b(T)m(rees.)p
3231 2105 V 555 2108 2678 4 v 555 2332 a(The)31 b(function)e
Fs(dft-node)f FA(follo)n(ws)j(the)g(same)g(path)g(through)e(the)i
(tree,)j(b)n(ut)d(deals)g(out)555 2437 y(nodes)25 b(one)h(at)h(a)g
(time.)47 b(When)26 b Fs(dft-node)e FA(reaches)h(a)i(node,)f(it)h
(follo)n(ws)f(the)g(car)h(of)f(the)555 2542 y(node,)19
b(and)h(pushes)f(onto)h Fs(*saved*)e FA(a)i(continuation)e(to)i(e)o
(xplore)f(the)h(cdr)-5 b(.)555 2724 y Fs(>)43 b(\(dft-node)d(t1\))555
2824 y(A)555 3011 y FA(Calling)33 b Fs(restart)e FA(continues)h(the)h
(tra)n(v)o(ersal,)j(by)d(popping)d(the)k(most)f(recently)f(sa)n(v)o(ed)
555 3116 y(continuation)18 b(and)i(calling)f(it.)555
3299 y Fs(>)43 b(\(restart\))555 3398 y(B)555 3586 y
FA(Ev)o(entually)27 b(there)h(will)i(be)f(no)g(sa)n(v)o(ed)f(states)i
(left,)h(a)f(f)o(act)f(which)f Fs(restart)f FA(signals)i(by)555
3691 y(returning)18 b Fs(done)p FA(:)555 3868 y Fs(.)555
3902 y(.)555 3935 y(.)555 4040 y(>)43 b(\(restart\))555
4144 y(G)555 4249 y(>)g(\(restart\))555 4353 y(DONE)555
4558 y FA(Finally)-5 b(,)19 b(the)i(function)d Fs(dft2)h
FA(neatly)h(packages)f(up)h(what)g(we)g(just)h(did)f(by)g(hand:)555
4740 y Fs(>)43 b(\(dft2)f(t1\))555 4840 y(ABDHCEFIG\(\))p
eop
%%Page: 264 277
264 276 bop 555 538 a FA(264)977 b Fu(CONTINU)n(A)-7
b(TIONS)p 555 745 2678 4 v 553 4259 4 3514 v 605 888
a Fs(\(define)41 b(\(dft)g(tree\))692 988 y(\(cond)h(\(\(null?)e
(tree\))i(\(\)\))954 1087 y(\(\(not)f(\(pair?)g(tree\)\))g(\(write)g
(tree\)\))954 1187 y(\(else)g(\(dft)h(\(car)g(tree\)\))1215
1287 y(\(dft)g(\(cdr)g(tree\)\)\)\)\))605 1486 y(\(define)f(*saved*)f
(\(\)\))605 1685 y(\(define)h(\(dft-node)e(tree\))692
1785 y(\(cond)j(\(\(null?)e(tree\))i(\(restart\)\))954
1884 y(\(\(not)f(\(pair?)g(tree\)\))g(tree\))954 1984
y(\(else)g(\(call-with-curre)o(nt-)o(co)o(nti)o(nu)o(at)o(ion)1302
2084 y(\(lambda)g(\(cc\))1389 2183 y(\(set!)h(*saved*)1651
2283 y(\(cons)f(\(lambda)g(\(\))2000 2383 y(\(cc)h(\(dft-node)e(\(cdr)i
(tree\)\)\)\))1912 2482 y(*saved*\)\))1389 2582 y(\(dft-node)e(\(car)i
(tree\)\)\)\)\)\)\))605 2781 y(\(define)f(\(restart\))692
2881 y(\(if)h(\(null?)f(*saved*\))866 2980 y('done)866
3080 y(\(let)h(\(\(cont)f(\(car)h(*saved*\)\)\))954 3180
y(\(set!)f(*saved*)g(\(cdr)h(*saved*\)\))954 3279 y(\(cont\)\)\)\))605
3478 y(\(define)f(\(dft2)g(tree\))692 3578 y(\(set!)h(*saved*)e(\(\)\))
692 3678 y(\(let)i(\(\(node)f(\(dft-node)f(tree\)\)\))779
3777 y(\(cond)i(\(\(eq?)f(node)h('done\))f(\(\)\))1041
3877 y(\(else)g(\(write)g(node\))1302 3977 y(\(restart\)\)\)\)\))1104
4181 y FA(Figure)20 b(20.3:)28 b(T)m(ree)20 b(tra)n(v)o(ersal)g(using)g
(continuations.)p 3231 4259 V 555 4262 2678 4 v 555 4486
a(Notice)c(that)g(there)f(is)i(no)f(e)o(xplicit)f(recursion)g(or)g
(iteration)h(in)g(the)g(de\002nition)f(of)g Fs(dft2)p
FA(:)27 b(suc\255)555 4591 y(cessi)n(v)o(e)22 b(nodes)g(are)g(printed)f
(because)g(the)i(continuations)d(in)m(v)n(ok)o(ed)g(by)i
Fs(restart)e FA(al)o(w)o(ays)555 4696 y(return)f(back)h(through)e(the)i
(same)g Fs(cond)f FA(clause)h(in)h Fs(dft-node)p FA(.)680
4800 y(This)27 b(kind)f(of)h(program)e(w)o(orks)i(lik)o(e)g(a)h(mine.)
49 b(It)28 b(digs)f(the)g(initial)g(shaft)g(by)g(calling)555
4905 y Fs(dft-node)p FA(.)f(So)21 b(long)e(as)i(the)f(v)n(alue)f
(returned)g(is)i(not)e Fs(done)p FA(,)g(the)h(code)g(follo)n(wing)e
(the)i(call)p eop
%%Page: 265 278
265 277 bop 555 538 a Ft(20.2)845 b Fu(SCHEME)18 b(CONTINU)n(A)-7
b(TIONS)828 b FA(265)555 801 y(to)21 b Fs(dft-node)e
FA(will)j(call)g Fs(restart)p FA(,)d(which)i(sends)g(control)f(back)h
(do)n(wn)f(the)h(stack)h(again.)555 905 y(This)14 b(process)f
(continues)g(until)g(the)h(return)f(v)n(alue)g(signals)h(that)g(the)f
(mine)h(is)g(empty)-5 b(.)26 b(Instead)555 1010 y(of)h(printing)e(this)
j(v)n(alue,)f Fs(dft2)f FA(returns)g Fs(#f)p FA(.)50
b(Search)26 b(with)h(continuations)e(represents)h(a)555
1114 y(no)o(v)o(el)17 b(w)o(ay)i(of)f(thinking)f(about)g(programs:)27
b(put)19 b(the)f(right)g(code)g(in)h(the)f(stack,)h(and)f(get)h(the)555
1219 y(result)h(by)g(repeatedly)f(returning)f(up)h(through)f(it.)680
1324 y(If)27 b(we)i(only)e(w)o(ant)h(to)g(tra)n(v)o(erse)g(one)f(tree)h
(at)h(a)f(time,)i(as)f(in)f Fs(dft2)p FA(,)h(then)e(there)h(is)h(no)555
1428 y(reason)19 b(to)h(bother)f(using)g(this)h(technique.)28
b(The)19 b(adv)n(antage)f(of)i Fs(dft-node)d FA(is)k(that)f(we)g(can)
555 1533 y(ha)n(v)o(e)26 b(se)n(v)o(eral)g(instances)h(of)g(it)g(going)
f(at)h(once.)48 b(Suppose)26 b(we)h(ha)n(v)o(e)f Ft(two)h
FA(trees,)i(and)d(we)555 1638 y(w)o(ant)20 b(to)h(generate,)d(in)j
(depth\255\002rst)e(order)m(,)f(the)i(cross\255product)e(of)i(their)g
(elements.)555 1842 y Fs(>)43 b(\(set!)f(*saved*)e(\(\)\))555
1946 y(\(\))555 2051 y(>)j(\(let)f(\(\(node1)f(\(dft-node)f(t1\)\)\))
729 2156 y(\(if)j(\(eq?)f(node1)f('done\))904 2260 y('done)904
2365 y(\(list)g(node1)h(\(dft-node)e(t2\)\)\)\))555 2469
y(\(A)j(1\))555 2574 y(>)g(\(restart\))555 2679 y(\(A)g(2\))555
2770 y(.)555 2803 y(.)555 2837 y(.)555 2941 y(>)g(\(restart\))555
3046 y(\(B)g(1\))555 3137 y(.)555 3171 y(.)555 3204 y(.)555
3408 y FA(Using)27 b(normal)f(techniques,)h(we)h(w)o(ould)e(ha)n(v)o(e)
h(had)g(to)g(tak)o(e)g(e)o(xplicit)g(steps)h(to)f(sa)n(v)o(e)g(our)555
3513 y(place)20 b(in)g(the)g(tw)o(o)g(trees.)29 b(W)m(ith)21
b(continuations,)c(the)j(state)h(of)f(the)g(tw)o(o)g(ongoing)e(tra)n(v)
o(ersals)555 3617 y(is)27 b(maintained)e(automatically)-5
b(.)46 b(In)26 b(a)h(simple)f(case)h(lik)o(e)g(this)g(one,)g(sa)n(ving)
f(our)f(place)h(in)555 3722 y(the)e(tree)g(w)o(ould)f(not)g(be)h(so)g
(dif)n(\002cult.)40 b(The)23 b(trees)i(are)e(permanent)f(data)i
(structures,)g(so)g(at)555 3826 y(least)19 b(we)g(ha)n(v)o(e)f(some)h
(w)o(ay)f(of)g(getting)g(hold)g(of)g(\223our)g(place\224)g(in)h(the)f
(tree.)29 b(The)18 b(great)g(thing)555 3931 y(about)j(continuations)f
(is)j(that)f(the)o(y)f(can)h(just)g(as)h(easily)f(sa)n(v)o(e)g(our)f
(place)h(in)g(the)g(middle)f(of)555 4036 y Ft(any)j FA(computation,)e
(e)n(v)o(en)i(if)g(there)g(are)g(no)g(permanent)f(data)h(structures)f
(associated)h(with)555 4140 y(it.)40 b(The)24 b(computation)d(need)i
(not)g(e)n(v)o(en)g(ha)n(v)o(e)g(a)h(\002nite)g(number)e(of)i(states,)h
(so)f(long)f(as)h(we)555 4245 y(only)19 b(w)o(ant)i(to)f(restart)g(a)h
(\002nite)f(number)f(of)h(them.)680 4350 y(As)e(Chapter)e(24)h(will)h
(sho)n(w)-5 b(,)17 b(both)f(of)h(these)h(considerations)d(turn)i(out)g
(to)g(be)g(important)555 4454 y(in)24 b(the)g(implementation)d(of)j
(Prolog.)39 b(In)24 b(Prolog)e(programs,)h(the)h(\223search)f
(trees\224)h(are)g(not)555 4559 y(real)17 b(data)f(structures,)g(b)n
(ut)h(are)f(implicit)h(in)f(the)h(w)o(ay)f(the)h(program)d(generates)i
(results.)28 b(And)555 4663 y(the)23 b(trees)h(are)f(often)g
(in\002nite,)g(in)h(which)f(case)g(we)h(cannot)e(hope)g(to)i(search)f
(the)g(whole)g(of)555 4768 y(one)f(before)e(searching)h(the)h(ne)o(xt;)
g(we)h(ha)n(v)o(e)e(no)h(choice)f(b)n(ut)h(to)g(sa)n(v)o(e)h(our)e
(place,)h(one)g(w)o(ay)555 4873 y(or)e(another)-5 b(.)p
eop
%%Page: 266 279
266 278 bop 555 538 a FA(266)977 b Fu(CONTINU)n(A)-7
b(TIONS)555 801 y Fw(20.2)99 b(Continuation\255P)o(assing)25
b(Macr)n(os)555 991 y FA(Common)e(Lisp)h(doesn')o(t)f(pro)o(vide)f
Fs(call/cc)p FA(,)h(b)n(ut)h(with)h(a)f(little)i(e)o(xtra)d(ef)n(fort)g
(we)i(can)f(do)555 1096 y(the)f(same)h(things)e(as)i(we)g(can)f(in)g
(Scheme.)38 b(This)23 b(section)g(sho)n(ws)g(ho)n(w)g(to)g(use)h
(macros)e(to)555 1200 y(b)n(uild)27 b(continuations)e(in)j(Common)e
(Lisp)i(programs.)49 b(Scheme)26 b(continuations)g(ga)n(v)o(e)g(us)555
1305 y(tw)o(o)20 b(things:)659 1471 y(1.)41 b(The)19
b(bindings)g(of)h(all)h(v)n(ariables)e(at)i(the)f(time)h(the)f
(continuation)e(w)o(as)j(made.)659 1639 y(2.)41 b(The)19
b(state)i(of)f(the)g(computation\227what)e(w)o(as)j(going)e(to)h
(happen)f(from)g(then)g(on.)555 1805 y(In)14 b(a)g(le)o(xically)f
(scoped)g(Lisp,)i(closures)e(gi)n(v)o(e)g(us)h(the)g(\002rst)h(of)e
(these.)28 b(It)14 b(turns)f(out)h(that)g(we)g(can)555
1910 y(also)23 b(use)h(closures)e(to)h(maintain)g(the)g(second,)f(by)h
(storing)f(the)h(state)h(of)f(the)g(computation)555 2014
y(in)d(v)n(ariable)f(bindings)g(as)i(well.)680 2119 y(The)g(macros)g
(sho)n(wn)g(in)i(Figure)e(20.4)g(mak)o(e)g(it)i(possible)e(to)h(do)g
(function)e(calls)j(while)555 2224 y(preserving)18 b(continuations.)27
b(These)20 b(macros)f(replace)g(the)h(b)n(uilt\255in)g(Common)e(Lisp)i
(forms)555 2328 y(for)g(de\002ning)e(functions,)h(calling)h(them,)f
(and)h(returning)e(v)n(alues.)680 2433 y(Functions)d(which)h(w)o(ant)g
(to)h(use)f(continuations)f(\(or)g(call)i(functions)e(which)h(do\))g
(should)555 2537 y(be)22 b(de\002ned)g(with)h Fs(=defun)d
FA(instead)i(of)h Fs(defun)p FA(.)34 b(The)23 b(syntax)e(of)i
Fs(=defun)d FA(is)k(the)e(same)h(as)-2785 b Fq(\016)555
2642 y FA(that)19 b(of)g Fs(defun)p FA(,)e(b)n(ut)i(its)h(ef)n(fect)f
(is)h(subtly)f(dif)n(ferent.)27 b(Instead)18 b(of)h(de\002ning)f(just)h
(a)h(function,)555 2747 y Fs(=defun)14 b FA(de\002nes)h(a)h(function)e
(and)h(a)h(macro)f(which)g(e)o(xpands)f(into)h(a)h(call)g(to)g(it.)29
b(\(The)15 b(macro)555 2851 y(must)21 b(be)f(de\002ned)g(\002rst,)h(in)
g(case)g(the)g(function)e(calls)j(itself.\))31 b(The)20
b(function)f(will)i(ha)n(v)o(e)g(the)555 2956 y(body)f(that)i(w)o(as)h
(passed)e(to)h Fs(=defun)p FA(,)e(b)n(ut)i(will)g(ha)n(v)o(e)g(an)f
(additional)g(parameter)m(,)f Fs(*cont*)p FA(,)555 3060
y(consed)k(onto)f(its)j(parameter)c(list.)43 b(In)25
b(the)f(e)o(xpansion)e(of)i(the)h(macro,)f(this)h(function)e(will)555
3165 y(recei)n(v)o(e)c Fs(*cont*)f FA(along)i(with)g(its)h(other)f(ar)o
(guments.)27 b(So)555 3341 y Fs(\(=defun)41 b(add1)h(\(x\))g(\(=values)
e(\(1+)j(x\)\)\))555 3517 y FA(macroe)o(xpands)17 b(into)555
3678 y Fs(\(progn)41 b(\(defmacro)f(add1)i(\(x\))947
3778 y(`\(=add1)f(*cont*)g(,x\)\))860 3878 y(\(defun)g(=add1)h
(\(*cont*)e(x\))947 3977 y(\(=values)h(\(1+)h(x\)\)\)\))555
4143 y FA(When)30 b(we)h(call)h Fs(add1)p FA(,)f(we)h(are)e(actually)g
(calling)g(not)h(a)g(function)e(b)n(ut)h(a)h(macro.)60
b(The)555 4248 y(macro)23 b(e)o(xpands)g(into)h(a)g(function)f(call,)
1741 4217 y Fm(1)1799 4248 y FA(b)n(ut)i(with)f(one)g(e)o(xtra)f
(parameter:)36 b Fs(*cont*)p FA(.)j(So)555 4352 y(the)26
b(current)f(v)n(alue)g(of)g Fs(*cont*)f FA(is)j(al)o(w)o(ays)g(passed)e
(implicitly)h(in)g(a)g(call)g(to)h(an)e(operator)555
4457 y(de\002ned)19 b(with)i Fs(=defun)p FA(.)680 4561
y(What)35 b(is)g Fs(*cont*)e FA(for?)72 b(It)35 b(will)g(be)f(bound)f
(to)i(the)g(current)e(continuation.)70 b(The)555 4666
y(de\002nition)25 b(of)g Fs(=values)f FA(sho)n(ws)i(ho)n(w)f(this)i
(continuation)c(will)k(be)f(used.)46 b(An)o(y)25 b(function)555
4771 y(de\002ned)30 b(using)h Fs(=defun)f FA(must)h(return)f(with)i
Fs(=values)p FA(,)g(or)f(call)h(some)f(other)f(function)p
555 4839 1074 4 v 645 4894 a Fl(1)675 4918 y Fr(Functions)17
b(created)h(by)d Fk(=defun)i Fr(are)f(deliberately)k(gi)n(v)o(en)d
(interned)h(names,)e(to)f(mak)o(e)i(it)f(possible)h(to)f
Fk(trace)555 5001 y Fr(them.)24 b(If)17 b(tracing)i(were)f(ne)n(v)o(er)
g(necessary)l(,)g(it)g(w)o(ould)g(be)f(safer)h(to)f(gensym)g(the)h
(names.)p eop
%%Page: 267 280
267 279 bop 555 538 a Ft(20.2)725 b Fu(CONTINU)n(A)-7
b(TION)p Fv(\255)p Fu(P)i(ASSING)19 b(MA)n(CR)n(OS)707
b FA(267)p 555 745 2678 4 v 553 3462 4 2717 v 605 888
a Fs(\(setq)41 b(*cont*)g(#'identity\))605 1087 y(\(defmacro)f(=lambda)
g(\(parms)h(&body)h(body\))692 1187 y(`#'\(lambda)d(\(*cont*)i
(,@parms\))f(,@body\)\))605 1386 y(\(defmacro)g(=defun)h(\(name)g
(parms)h(&body)f(body\))692 1486 y(\(let)h(\(\(f)g(\(intern)f
(\(concatenate)e('string)2000 1586 y("=")j(\(symbol-name)d
(name\)\)\)\)\))779 1685 y(`\(progn)910 1785 y(\(defmacro)h(,name)h
(,parms)997 1884 y(`\(,',f)g(*cont*)g(,,@parms\)\))910
1984 y(\(defun)g(,f)i(\(*cont*)d(,@parms\))h(,@body\)\)\)\))605
2183 y(\(defmacro)f(=bind)h(\(parms)g(expr)h(&body)g(body\))692
2283 y(`\(let)g(\(\(*cont*)e(#'\(lambda)g(,parms)h(,@body\)\)\))f
(,expr\)\))605 2482 y(\(defmacro)g(=values)g(\(&rest)h(retvals\))692
2582 y(`\(funcall)f(*cont*)h(,@retvals\)\))605 2781 y(\(defmacro)f
(=funcall)g(\(fn)i(&rest)g(args\))692 2881 y(`\(funcall)e(,fn)i(*cont*)
f(,@args\)\))605 3080 y(\(defmacro)f(=apply)h(\(fn)h(&rest)g(args\))692
3180 y(`\(apply)f(,fn)h(*cont*)f(,@args\)\))1180 3384
y FA(Figure)19 b(20.4:)29 b(Continuation\255passing)17
b(macros.)p 3231 3462 V 555 3465 2678 4 v 555 3689 a(which)22
b(does)h(so.)38 b(The)22 b(syntax)h(of)f Fs(=values)f
FA(is)j(the)f(same)g(as)g(that)g(of)g(the)g(Common)e(Lisp)555
3794 y(form)26 b Fs(values)p FA(.)46 b(It)27 b(can)f(return)g(multiple)
g(v)n(alues)g(if)h(there)f(is)h(an)g Fs(=bind)e FA(with)i(the)f(same)
555 3899 y(number)i(of)h(ar)o(guments)f(w)o(aiting)i(for)f(them,)i(b)n
(ut)f(can')o(t)f(return)f(multiple)h(v)n(alues)h(to)g(the)555
4003 y(tople)n(v)o(el.)2456 b Fq(\016)680 4108 y FA(The)22
b(parameter)f Fs(*cont*)f FA(tells)j(a)g(function)e(de\002ned)g(with)i
Fs(=defun)d FA(what)j(to)f(do)g(with)555 4212 y(its)k(return)e(v)n
(alue.)44 b(When)25 b Fs(=values)e FA(is)j(macroe)o(xpanded)c(it)k
(will)g(capture)e Fs(*cont*)p FA(,)g(and)555 4317 y(use)c(it)h(to)g
(simulate)f(returning)e(from)h(the)h(function.)28 b(The)20
b(e)o(xpression)555 4500 y Fs(>)43 b(\(=values)d(\(1+)j(n\)\))555
4682 y FA(e)o(xpands)19 b(into)555 4848 y Fs(\(funcall)40
b(*cont*)h(\(1+)i(n\)\))p eop
%%Page: 268 281
268 280 bop 555 538 a FA(268)977 b Fu(CONTINU)n(A)-7
b(TIONS)555 801 y FA(At)21 b(the)f(tople)n(v)o(el,)f(the)h(v)n(alue)g
(of)g Fs(*cont*)e FA(is)k Fs(identity)p FA(,)17 b(which)j(just)g
(returns)g(whate)n(v)o(er)f(is)555 905 y(passed)25 b(to)g(it.)45
b(When)25 b(we)g(call)h Fs(\(add1)41 b(2\))25 b FA(from)f(the)h(tople)n
(v)o(el,)g(the)g(call)g(gets)h(macroe)o(x\255)555 1010
y(panded)19 b(into)g(the)i(equi)n(v)n(alent)d(of)555
1193 y Fs(\(funcall)40 b(#'\(lambda)g(\(*cont*)h(n\))i(\(=values)d
(\(1+)i(n\)\)\))g(*cont*)f(2\))555 1380 y FA(The)24 b(reference)f(to)i
Fs(*cont*)e FA(will)i(in)g(this)g(case)g(get)g(the)f(global)g(binding.)
41 b(The)24 b Fs(=values)555 1485 y FA(e)o(xpression)19
b(will)i(thus)f(macroe)o(xpand)c(into)k(the)h(equi)n(v)n(alent)d(of:)
555 1667 y Fs(\(funcall)40 b(#'identity)g(\(1+)i(n\)\))555
1855 y FA(which)20 b(just)g(adds)g Fs(1)h FA(to)f Fs(n)g
FA(and)g(returns)f(the)i(result.)680 1955 y(In)26 b(functions)g(lik)o
(e)h Fs(add1)p FA(,)g(we)h(go)e(through)f(all)j(this)f(trouble)f(just)i
(to)f(simulate)g(what)555 2054 y(Lisp)20 b(function)f(call)h(and)g
(return)f(do)h(an)o(yw)o(ay:)555 2220 y Fs(>)43 b(\(=defun)e(bar)h
(\(x\))729 2320 y(\(=values)f(\(list)g('a)i(\(add1)e(x\)\)\)\))555
2420 y(BAR)555 2519 y(>)i(\(bar)f(5\))555 2619 y(\(A)h(6\))555
2790 y FA(The)17 b(point)f(is,)j(we)e(ha)n(v)o(e)g(no)n(w)f(brought)f
(function)g(call)j(and)f(return)e(under)h(our)g(o)n(wn)h(control,)555
2894 y(and)j(can)g(do)f(other)h(things)g(if)g(we)h(wish.)680
2999 y(It)32 b(is)h(by)f(manipulating)e Fs(*cont*)h FA(that)h(we)h
(will)g(get)f(the)g(ef)n(fect)g(of)g(continuations.)555
3104 y(Although)15 b Fs(*cont*)f FA(has)i(a)h(global)e(v)n(alue,)i
(this)f(will)h(rarely)f(be)g(the)g(one)g(used:)27 b Fs(*cont*)15
b FA(will)555 3208 y(nearly)25 b(al)o(w)o(ays)i(be)f(a)g(parameter)m(,)
g(captured)e(by)i Fs(=values)e FA(and)h(the)h(macros)g(de\002ned)f(by)
555 3313 y Fs(=defun)p FA(.)h(W)m(ithin)14 b(the)h(body)f(of)h
Fs(add1)p FA(,)g(for)f(e)o(xample,)g Fs(*cont*)f FA(is)j(a)g(parameter)
d(and)i(not)g(the)555 3418 y(global)g(v)n(ariable.)26
b(This)16 b(distinction)f(is)i(important)d(because)h(these)h(macros)f
(w)o(ouldn')o(t)e(w)o(ork)555 3522 y(if)22 b Fs(*cont*)e
FA(were)h(not)g(a)i(local)e(v)n(ariable.)32 b(That')-5
b(s)22 b(why)f Fs(*cont*)f FA(is)i(gi)n(v)o(en)f(its)h(initial)g(v)n
(alue)555 3627 y(in)e(a)h Fs(setq)e FA(instead)h(of)g(a)h
Fs(defvar)p FA(:)27 b(the)20 b(latter)h(w)o(ould)e(also)i(proclaim)e
(it)h(to)h(be)f Fs(special)p FA(.)680 3731 y(The)d(third)f(macro)h(in)g
(Figure)g(20.4,)g Fs(=bind)p FA(,)f(is)i(intended)e(to)i(be)f(used)g
(in)h(the)f(same)h(w)o(ay)555 3836 y(as)29 b Fs(multiple-value-b)o(in)o
(d)p FA(.)47 b(It)29 b(tak)o(es)f(a)h(list)g(of)f(parameters,)g(an)g(e)
o(xpression,)h(and)e(a)555 3941 y(body)19 b(of)h(code:)30
b(the)20 b(parameters)g(are)g(bound)f(to)h(the)h(v)n(alues)f(returned)f
(by)h(the)g(e)o(xpression,)555 4045 y(and)j(the)h(code)g(body)e(is)j(e)
n(v)n(aluated)d(with)i(those)g(bindings.)39 b(This)24
b(macro)f(should)g(be)h(used)555 4150 y(whene)n(v)o(er)32
b(additional)g(e)o(xpressions)h(ha)n(v)o(e)g(to)i(be)e(e)n(v)n(aluated)
g(after)g(calling)h(a)g(function)555 4254 y(de\002ned)19
b(with)i Fs(=defun)p FA(.)555 4437 y Fs(>)43 b(\(=defun)e(message)g
(\(\))729 4537 y(\(=values)g('hello)g('there\)\))555
4636 y(MESSAGE)p eop
%%Page: 269 282
269 281 bop 555 538 a Ft(20.2)725 b Fu(CONTINU)n(A)-7
b(TION)p Fv(\255)p Fu(P)i(ASSING)19 b(MA)n(CR)n(OS)707
b FA(269)555 801 y Fs(>)43 b(\(=defun)e(baz)h(\(\))729
900 y(\(=bind)f(\(m)i(n\))g(\(message\))817 1000 y(\(=values)d(\(list)h
(m)i(n\)\)\)\))555 1100 y(BAZ)555 1199 y(>)g(\(baz\))555
1299 y(\(HELLO)e(THERE\))555 1485 y FA(Notice)18 b(that)h(the)g(e)o
(xpansion)d(of)i(an)h Fs(=bind)e FA(creates)h(a)h(ne)n(w)f(v)n(ariable)
g(called)g Fs(*cont*)p FA(.)27 b(The)555 1590 y(body)19
b(of)h Fs(baz)f FA(macroe)o(xpands)e(into:)555 1772 y
Fs(\(let)42 b(\(\(*cont*)e(#'\(lambda)g(\(m)j(n\))1340
1871 y(\(=values)d(\(list)h(m)j(n\)\)\)\)\))642 1971
y(\(message\)\))555 2157 y FA(which)20 b(in)g(turn)g(becomes:)555
2339 y Fs(\(let)42 b(\(\(*cont*)e(#'\(lambda)g(\(m)j(n\))1340
2439 y(\(funcall)d(*cont*)h(\(list)g(m)j(n\)\)\)\)\))642
2538 y(\(=message)c(*cont*\)\))555 2725 y FA(The)18 b(ne)n(w)g(v)n
(alue)g(of)g Fs(*cont*)f FA(is)i(the)g(body)e(of)h(the)g
Fs(=bind)f FA(e)o(xpression,)g(so)i(when)f Fs(message)555
2830 y FA(\223returns\224)24 b(by)h(funcalling)e Fs(*cont*)p
FA(,)h(the)h(result)g(will)h(be)f(to)g(e)n(v)n(aluate)f(the)h(body)f
(of)h(code.)555 2934 y(Ho)n(we)n(v)o(er)19 b(\(and)g(this)i(is)g(the)f
(k)o(e)o(y)g(point\),)e(within)i(the)h(body)d(of)i(the)g
Fs(=bind)p FA(:)555 3116 y Fs(#'\(lambda)40 b(\(m)j(n\))729
3215 y(\(funcall)e(*cont*)g(\(list)g(m)i(n\)\)\))555
3402 y FA(the)24 b Fs(*cont*)e FA(that)j(w)o(as)g(passed)f(as)h(an)f
(ar)o(gument)e(to)i Fs(=baz)f FA(is)i(still)h(visible,)e(so)h(when)f
(the)555 3507 y(body)17 b(of)h(code)g(in)h(turn)f(e)n(v)n(aluates)g(an)
g Fs(=values)p FA(,)f Ft(it)i FA(will)g(be)g(able)f(to)h(return)e(to)i
(the)g(original)555 3611 y(calling)j(function.)35 b(The)22
b(closures)h(are)f(knitted)g(together:)33 b(each)22 b(binding)f(of)i
Fs(*cont*)e FA(is)i(a)555 3716 y(closure)e(containing)f(the)i(pre)n
(vious)e(binding)g(of)i Fs(*cont*)p FA(,)e(forming)g(a)i(chain)f(which)
g(leads)555 3820 y(all)g(the)f(w)o(ay)g(back)g(up)g(to)g(the)g(global)f
(v)n(alue.)680 3925 y(W)-7 b(e)21 b(can)f(see)h(the)f(same)g
(phenomenon)d(on)j(a)g(smaller)g(scale)h(here:)555 4107
y Fs(>)43 b(\(let)f(\(\(f)g(#'identity\)\))729 4206 y(\(let)g(\(\(g)h
(#'\(lambda)c(\(x\))k(\(funcall)d(f)j(\(list)f('a)h(x\)\)\)\)\))817
4306 y(#'\(lambda)c(\(x\))k(\(funcall)d(g)j(\(list)f('b)g(x\)\)\)\)\))
555 4406 y(#<Interpreted-Fu)o(nct)o(io)o(n)37 b(BF6326>)555
4505 y(>)43 b(\(funcall)d(*)k(2\))555 4605 y(\(A)f(\(B)g(2\)\))555
4791 y FA(This)27 b(e)o(xample)e(creates)i(a)g(function)e(which)h(is)h
(a)g(closure)f(containing)f(a)i(reference)e(to)i Fs(g)p
FA(,)555 4896 y(which)e(is)i(itself)f(a)g(closure)f(containing)f(a)i
(reference)e(to)i Fs(f)p FA(.)45 b(Similar)26 b(chains)g(of)f(closures)
555 5001 y(were)20 b(b)n(uilt)g(by)g(the)g(netw)o(ork)f(compiler)g(on)h
(page)g(80.)p eop
%%Page: 270 283
270 282 bop 555 538 a FA(270)977 b Fu(CONTINU)n(A)-7
b(TIONS)p 555 745 2678 4 v 553 2926 4 2181 v 605 886
a FA(1.)41 b(The)25 b(parameter)e(list)k(of)e(a)h(function)d(de\002ned)
h(with)i Fs(=defun)d FA(must)j(consist)f(solely)605 986
y(of)20 b(parameter)e(names.)605 1146 y(2.)41 b(Functions)23
b(which)g(mak)o(e)g(use)h(of)g(continuations,)e(or)i(call)g(other)f
(functions)g(which)605 1245 y(do,)c(must)i(be)f(de\002ned)f(with)h
Fs(=lambda)e FA(or)i Fs(=defun)p FA(.)605 1405 y(3.)41
b(Such)18 b(functions)g(must)g(terminate)g(either)h(by)f(returning)f(v)
n(alues)i(with)g Fs(=values)p FA(,)d(or)605 1505 y(by)k(calling)f
(another)g(function)g(which)g(obe)o(ys)g(this)i(restriction.)605
1664 y(4.)41 b(If)23 b(an)g Fs(=bind)p FA(,)g Fs(=values)p
FA(,)e Fs(=apply)p FA(,)i(or)g Fs(=funcall)d FA(e)o(xpression)i(occurs)
h(in)h(a)f(se)o(g\255)605 1764 y(ment)f(of)h(code,)g(it)g(must)g(be)g
(a)h(tail)f(call.)38 b(An)o(y)22 b(code)h(to)g(be)g(e)n(v)n(aluated)e
(after)i(an)g Fs(=bind)605 1863 y FA(should)28 b(be)i(put)f(in)h(its)g
(body)-5 b(.)56 b(So)29 b(if)h(we)g(w)o(ant)g(to)f(ha)n(v)o(e)g(se)n(v)
o(eral)g Fs(=bind)p FA(s)f(one)h(after)605 1963 y(another)m(,)18
b(the)o(y)h(must)i(be)f(nested:)605 2146 y Fs(\(=defun)41
b(foo)h(\(x\))692 2245 y(\(=bind)f(\(y\))h(\(bar)g(x\))779
2345 y(\(format)f(t)i("Ho)f("\))779 2445 y(\(=bind)f(\(z\))i(\(baz)f
(x\))866 2544 y(\(format)f(t)i("Hum."\))866 2644 y(\(=values)e(x)i(y)g
(z\)\)\)\))929 2848 y FA(Figure)19 b(20.5:)28 b(Restrictions)21
b(on)f(continuation\255passing)c(macros.)p 3231 2926
V 555 2929 2678 4 v 680 3136 a(The)30 b(remaining)f(macros,)j
Fs(=apply)d FA(and)h Fs(=funcall)p FA(,)g(are)h(for)f(use)h(with)g
(functions)555 3240 y(de\002ned)25 b(by)g Fs(=lambda)p
FA(.)43 b(Note)26 b(that)g(\223functions\224)e(de\002ned)g(with)i
Fs(=defun)p FA(,)f(because)g(the)o(y)555 3345 y(are)i(actually)g
(macros,)h(cannot)e(be)h(gi)n(v)o(en)f(as)i(ar)o(guments)e(to)h
Fs(apply)f FA(or)h Fs(funcall)p FA(.)48 b(The)555 3450
y(w)o(ay)19 b(around)e(this)j(problem)d(is)j(analogous)d(to)i(the)g
(trick)g(mentioned)e(on)i(page)f(110.)28 b(It)19 b(is)h(to)555
3554 y(package)f(up)h(the)g(call)g(inside)g(another)f
Fs(=lambda)p FA(:)555 3715 y Fs(>)43 b(\(=defun)e(add1)h(\(x\))729
3814 y(\(=values)f(\(1+)h(x\)\)\))555 3914 y(ADD1)555
4013 y(>)h(\(let)f(\(\(fn)g(\(=lambda)e(\(n\))j(\(add1)e(n\)\)\)\))729
4113 y(\(=bind)g(\(y\))i(\(=funcall)d(fn)i(9\))817 4213
y(\(format)e(nil)j("9)f(+)h(1)h(=)f(~A")f(y\)\)\))555
4312 y("9)h(+)g(1)g(=)g(10")680 4478 y FA(Figure)36 b(20.5)g
(summarizes)g(all)i(the)f(restrictions)g(imposed)f(by)h(the)g
(continuation\255)555 4582 y(passing)21 b(macros.)30
b(Functions)20 b(which)g(neither)g(sa)n(v)o(e)i(continuations,)c(nor)i
(call)i(other)e(func\255)555 4687 y(tions)j(which)f(do,)h(need)f(not)g
(use)i(these)e(special)h(macros.)37 b(Built\255in)22
b(functions)g(lik)o(e)h Fs(list)p FA(,)555 4791 y(for)d(e)o(xample,)e
(are)i(e)o(x)o(empt.)680 4896 y(Figure)g(20.6)h(contains)g(the)g(code)g
(from)f(Figure)h(20.3,)g(translated)f(from)h(Scheme)g(into)555
5001 y(Common)32 b(Lisp,)k(and)d(using)g(the)g(continuation\255passing)
d(macros)i(instead)h(of)g(Scheme)p eop
%%Page: 271 284
271 283 bop 555 538 a Ft(20.2)725 b Fu(CONTINU)n(A)-7
b(TION)p Fv(\255)p Fu(P)i(ASSING)19 b(MA)n(CR)n(OS)707
b FA(271)p 555 745 2678 4 v 553 3661 4 2916 v 605 888
a Fs(\(defun)41 b(dft)h(\(tree\))692 988 y(\(cond)g(\(\(null)f(tree\))g
(nil\))954 1087 y(\(\(atom)g(tree\))g(\(princ)g(tree\)\))954
1187 y(\(t)h(\(dft)g(\(car)g(tree\)\))1084 1287 y(\(dft)g(\(cdr)g
(tree\)\)\)\)\))605 1486 y(\(setq)f(*saved*)g(nil\))605
1685 y(\(=defun)g(dft-node)f(\(tree\))692 1785 y(\(cond)i(\(\(null)f
(tree\))g(\(restart\)\))954 1884 y(\(\(atom)g(tree\))g(\(=values)f
(tree\)\))954 1984 y(\(t)i(\(push)g(#'\(lambda)e(\(\))i(\(dft-node)e
(\(cdr)i(tree\)\)\))1346 2084 y(*saved*\))1084 2183 y(\(dft-node)e
(\(car)i(tree\)\)\)\)\))605 2383 y(\(=defun)f(restart)f(\(\))692
2482 y(\(if)i(*saved*)866 2582 y(\(funcall)f(\(pop)h(*saved*\)\))866
2681 y(\(=values)f('done\)\)\))605 2881 y(\(=defun)g(dft2)g(\(tree\))
692 2980 y(\(setq)h(*saved*)e(nil\))692 3080 y(\(=bind)h(\(node\))g
(\(dft-node)f(tree\))779 3180 y(\(cond)i(\(\(eq)g(node)g('done\))f
(\(=values)f(nil\)\))1041 3279 y(\(t)i(\(princ)g(node\))1171
3379 y(\(restart\)\)\)\)\))852 3583 y FA(Figure)20 b(20.6:)28
b(T)m(ree)20 b(tra)n(v)o(ersal)f(using)h(continuation\255passing)d
(macros.)p 3231 3661 V 555 3664 2678 4 v 555 3889 a(continuations.)27
b(W)m(ith)21 b(the)f(same)g(e)o(xample)f(tree,)h Fs(dft2)f
FA(w)o(orks)h(just)h(as)g(before:)555 4071 y Fs(>)43
b(\(setq)f(t1)g('\(a)h(\(b)g(\(d)f(h\)\))h(\(c)f(e)i(\(f)e(i\))h(g\)\))
904 4171 y(t2)f('\(1)h(\(2)g(\(3)f(6)h(7\))g(4)g(5\)\)\))555
4271 y(\(1)g(\(2)g(\(3)f(6)h(7\))g(4)g(5\)\))555 4370
y(>)g(\(dft2)f(t1\))555 4470 y(ABDHCEFIG)555 4569 y(NIL)555
4757 y FA(Sa)n(ving)19 b(states)i(of)f(multiple)f(tra)n(v)o(ersals)h
(also)g(w)o(orks)f(as)i(in)f(Scheme,)f(though)f(the)i(e)o(xample)555
4862 y(becomes)f(a)i(bit)f(longer:)p eop
%%Page: 272 285
272 284 bop 555 538 a FA(272)977 b Fu(CONTINU)n(A)-7
b(TIONS)555 801 y Fs(>)43 b(\(=bind)e(\(node1\))g(\(dft-node)f(t1\))729
905 y(\(if)j(\(eq)f(node1)g('done\))904 1010 y('done)904
1114 y(\(=bind)f(\(node2\))f(\(dft-node)g(t2\))991 1219
y(\(list)h(node1)h(node2\)\)\)\))555 1324 y(\(A)h(1\))555
1428 y(>)g(\(restart\))555 1533 y(\(A)g(2\))555 1624
y(.)555 1658 y(.)555 1691 y(.)555 1796 y(>)g(\(restart\))555
1900 y(\(B)g(1\))555 1992 y(.)555 2025 y(.)555 2058 y(.)555
2262 y FA(By)34 b(knitting)e(together)f(a)j(chain)e(of)h(le)o(xical)g
(closures,)j(Common)31 b(Lisp)j(programs)d(can)555 2366
y(b)n(uild)26 b(their)h(o)n(wn)f(continuations.)47 b(F)o(ortunately)-5
b(,)26 b(the)h(closures)f(are)h(knitted)f(together)f(by)555
2471 y(the)i(macros)f(in)h(the)g(sweatshop)g(of)f(Figure)h(20.4,)g(and)
f(the)h(user)g(can)g(ha)n(v)o(e)f(the)h(\002nished)555
2575 y(garment)18 b(without)i(gi)n(ving)f(a)h(thought)f(to)h(its)h
(origins.)680 2680 y(Chapters)26 b(21\22624)e(all)j(rely)f(on)g
(continuations)f(in)h(some)g(w)o(ay)-5 b(.)48 b(These)26
b(chapters)g(will)555 2785 y(sho)n(w)g(that)h(continuations)e(are)i(an)
f(abstraction)g(of)g(unusual)g(po)n(wer)-5 b(.)48 b(The)o(y)26
b(may)g(not)h(be)555 2889 y(o)o(v)o(erly)22 b(f)o(ast,)k(especially)d
(when)g(implemented)g(on)g(top)h(of)g(the)g(language)e(as)j(macros,)f
(b)n(ut)555 2994 y(the)i(abstractions)g(we)h(can)f(b)n(uild)g(upon)f
(them)g(mak)o(e)h(certain)g(programs)f(much)g(f)o(aster)h(to)555
3098 y(write,)20 b(and)g(there)f(is)j(a)e(place)g(for)g(that)g(kind)f
(of)h(speed)g(too.)555 3351 y Fw(20.3)99 b(Code\255W)-6
b(alk)o(ers)25 b(and)g(CPS)g(Con)l(v)o(ersion)555 3542
y FA(The)19 b(macros)g(described)g(in)g(the)h(pre)n(vious)e(section)h
(represent)g(a)h(compromise.)27 b(The)o(y)18 b(gi)n(v)o(e)555
3646 y(us)h(the)g(po)n(wer)f(of)h(continuations,)e(b)n(ut)i(only)f(if)h
(we)g(write)g(our)f(programs)f(in)i(a)h(certain)e(w)o(ay)-5
b(.)555 3751 y(Rule)21 b(4)f(in)g(Figure)g(20.5)f(means)h(that)g(we)g
(al)o(w)o(ays)h(ha)n(v)o(e)f(to)g(write)555 3933 y Fs(\(=bind)41
b(\(x\))h(\(fn)h(y\))642 4032 y(\(list)f('a)g(x\)\))555
4219 y FA(rather)19 b(than)555 4401 y Fs(\(list)42 b('a)2004
b(;)43 b(wrong)817 4500 y(\(=bind)e(\(x\))h(\(fn)g(y\))h(x\)\))555
4687 y FA(A)18 b(true)e Fs(call/cc)f FA(imposes)i(no)g(such)f
(restrictions)h(on)g(the)g(programmer)-5 b(.)25 b(A)18
b Fs(call/cc)d FA(can)555 4791 y(grab)g(the)h(continuation)e(at)i(an)o
(y)f(point)g(in)h(a)h(program)d(of)h(an)o(y)g(shape.)28
b(W)-7 b(e)17 b(could)e(implement)555 4896 y(an)i(operator)f(with)h
(the)g(full)g(po)n(wer)f(of)h Fs(call/cc)p FA(,)f(b)n(ut)h(it)h(w)o
(ould)e(be)h(a)h(lot)f(more)g(w)o(ork.)27 b(This)555
5001 y(section)20 b(outlines)g(ho)n(w)f(it)i(could)e(be)i(done.)p
eop
%%Page: 273 286
273 285 bop 555 538 a Ft(20.3)642 b Fu(CODE)p Fv(\255)p
Fu(W)-7 b(ALKERS)18 b(AND)h(CPS)g(CONVERSION)625 b FA(273)680
801 y(A)22 b(Lisp)g(program)d(can)j(be)f(transformed)f(into)h(a)h(form)
f(called)g(\223continuation\255passing)555 905 y(style.)-6
b(\224)33 b(Programs)20 b(which)h(ha)n(v)o(e)g(under)o(gone)d(complete)
i Fr(CPS)i FA(con)m(v)o(ersion)d(are)i(impossible)555
1010 y(to)h(read,)g(b)n(ut)g(one)f(can)h(grasp)f(the)h(spirit)g(of)g
(this)g(process)g(by)f(looking)f(at)j(code)e(which)g(has)555
1114 y(been)f(partially)f(transformed.)27 b(The)20 b(follo)n(wing)e
(function)h(to)h(re)n(v)o(erse)f(lists:)529 b Fq(\016)555
1297 y Fs(\(defun)41 b(rev)h(\(x\))642 1397 y(\(if)h(\(null)e(x\))817
1496 y(nil)817 1596 y(\(append)f(\(rev)i(\(cdr)g(x\)\))g(\(list)g
(\(car)g(x\)\)\)\)\))555 1784 y FA(yields)20 b(an)g(equi)n(v)n(alent)f
(continuation\255passing)d(v)o(ersion:)555 1966 y Fs(\(defun)41
b(rev2)h(\(x\))642 2066 y(\(revc)g(x)h(#'identity\)\))555
2265 y(\(defun)e(revc)h(\(x)h(k\))642 2365 y(\(if)g(\(null)e(x\))817
2464 y(\(funcall)f(k)j(nil\))817 2564 y(\(revc)e(\(cdr)h(x\))1078
2664 y(#'\(lambda)e(\(w\))1252 2763 y(\(funcall)h(k)i(\(append)e(w)i
(\(list)e(\(car)h(x\)\)\)\)\)\)\)\))680 2951 y FA(In)12
b(the)g(continuation\255passing)g(style,)d(functions)j(get)g(an)g
(additional)g(parameter)g(\(here)g Fs(k)p FA(\))555 3056
y(whose)22 b(v)n(alue)f(will)i(be)f(the)h(continuation.)33
b(The)21 b(continuation)f(is)j(a)g(closure)f(representing)555
3160 y(what)c(should)f(be)h(done)f(with)h(the)g(current)f(v)n(alue)g
(of)h(the)g(function.)27 b(On)18 b(the)g(\002rst)g(recursion,)555
3265 y(the)27 b(continuation)f(is)i Fs(identity)p FA(;)g(what)g(should)
e(be)h(done)g(is)h(that)f(the)h(function)e(should)555
3369 y(just)i(return)f(its)i(current)d(v)n(alue.)52 b(On)28
b(the)g(second)f(recursion,)h(the)g(continuation)d(will)k(be)555
3474 y(equi)n(v)n(alent)18 b(to:)555 3657 y Fs(#'\(lambda)40
b(\(w\))729 3756 y(\(identity)g(\(append)h(w)i(\(list)f(\(car)g
(x\)\)\)\)\))555 3944 y FA(which)20 b(says)h(that)f(what)h(should)e(be)
h(done)g(is)h(to)g(append)d(the)j(car)f(of)g(the)g(list)i(to)e(the)h
(current)555 4048 y(v)n(alue,)e(and)h(return)f(it.)680
4153 y(Once)24 b(you)f(can)h(do)g Fr(CPS)h FA(con)m(v)o(ersion,)d(it)j
(is)h(easy)e(to)g(write)h Fs(call/cc)p FA(.)39 b(In)24
b(a)h(program)555 4258 y(which)k(has)g(under)o(gone)d
Fr(CPS)j FA(con)m(v)o(ersion,)g(the)g(entire)g(current)e(continuation)g
(is)j(al)o(w)o(ays)555 4362 y(present,)25 b(and)g Fs(call/cc)d
FA(can)j(be)g(implemented)e(as)i(a)h(simple)f(macro)f(which)g(calls)i
(some)555 4467 y(function)18 b(with)j(it)g(as)g(an)f(ar)o(gument.)680
4572 y(T)-7 b(o)29 b(do)h Fr(CPS)g FA(con)m(v)o(ersion)d(we)j(need)f(a)
i Ft(code\255walk)o(er)-9 b(,)30 b FA(a)h(program)c(that)j(tra)n(v)o
(erses)g(the)555 4676 y(trees)36 b(representing)d(the)i(source)g(code)f
(of)i(a)f(program.)73 b(Writing)35 b(a)h(code\255w)o(alk)o(er)d(for)555
4781 y(Common)26 b(Lisp)i(is)h(a)f(serious)f(undertaking.)49
b(T)-7 b(o)27 b(be)h(useful,)h(a)f(code\255w)o(alk)o(er)d(has)j(to)g
(do)57 b Fq(\016)555 4885 y FA(more)24 b(than)h(simply)f(tra)n(v)o
(erse)h(e)o(xpressions.)42 b(It)26 b(also)f(has)g(to)g(kno)n(w)f(a)i(f)
o(air)f(amount)f(about)555 4990 y(what)f(the)g(e)o(xpressions)e(mean.)
37 b(A)23 b(code\255w)o(alk)o(er)e(can')o(t)h(just)i(think)e(in)h
(terms)g(of)f(symbols,)p eop
%%Page: 274 287
274 286 bop 555 538 a FA(274)977 b Fu(CONTINU)n(A)-7
b(TIONS)555 801 y FA(for)22 b(e)o(xample.)35 b(A)23 b(symbol)f(could)g
(represent,)g(among)f(other)h(things,)g(itself,)i(a)f(function,)e(a)555
905 y(v)n(ariable,)d(a)i(block)f(name,)g(or)g(a)h(tag)g(for)f
Fs(go)p FA(.)28 b(The)19 b(code\255w)o(alk)o(er)f(has)i(to)g(use)g(the)
f(conte)o(xt)f(to)555 1010 y(distinguish)h(one)h(kind)f(of)h(symbol)f
(from)h(another)m(,)e(and)h(act)i(accordingly)-5 b(.)680
1114 y(Since)32 b(writing)f(a)i(code\255w)o(alk)o(er)d(w)o(ould)h(be)h
(be)o(yond)e(the)i(scope)g(of)g(this)g(book,)i(the)555
1219 y(macros)25 b(described)g(in)h(this)g(chapter)f(are)h(the)g(most)g
(practical)f(alternati)n(v)o(e.)45 b(The)25 b(macros)555
1324 y(in)f(this)g(chapter)e(split)i(the)f(w)o(ork)g(of)g(b)n(uilding)f
(continuations)g(with)h(the)h(user)-5 b(.)39 b(If)23
b(the)h(user)555 1428 y(writes)31 b(programs)d(in)i(something)f(suf)n
(\002ciently)g(close)i(to)f Fr(CPS)p FA(,)j(the)d(macros)g(can)g(do)g
(the)555 1533 y(rest.)62 b(That')-5 b(s)30 b(what)h(rule)g(4)g(really)f
(amounts)g(to:)51 b(if)31 b(e)n(v)o(erything)d(follo)n(wing)h(an)i
Fs(=bind)555 1638 y FA(e)o(xpression)d(is)j(within)e(its)i(body)-5
b(,)30 b(then)f(between)g(the)h(v)n(alue)f(of)h Fs(*cont*)d
FA(and)j(the)f(code)555 1742 y(in)d(the)g(body)e(of)h(the)h
Fs(=bind)p FA(,)g(the)f(program)f(has)i(enough)e(information)f(to)j
(construct)f(the)555 1847 y(current)19 b(continuation.)680
1951 y(The)24 b Fs(=bind)g FA(macro)g(is)i(deliberately)e(written)g(to)
i(mak)o(e)e(this)i(style)f(of)g(programming)555 2056
y(feel)34 b(natural.)70 b(In)34 b(practice)g(the)g(restrictions)f
(imposed)g(by)h(the)g(continuation\255passing)555 2161
y(macros)20 b(are)g(bearable.)p eop
%%Page: 275 288
275 287 bop 555 1610 a Fn(21)p 555 1872 2686 3 v 555
2131 a Fx(Multiple)42 b(Pr)m(ocesses)555 2568 y FA(The)23
b(pre)n(vious)f(chapter)g(sho)n(wed)g(ho)n(w)h(continuations)f(allo)n
(w)h(a)h(running)d(program)g(to)j(get)555 2672 y(hold)h(of)h(its)h(o)n
(wn)e(state,)j(and)e(store)g(it)g(a)o(w)o(ay)g(to)g(be)g(restarted)f
(later)-5 b(.)47 b(This)27 b(chapter)d(deals)555 2777
y(with)g(a)g(model)f(of)h(computation)e(in)i(which)f(a)h(computer)e
(runs)i(not)f(one)h(single)f Ft(pr)l(o)o(gr)o(am,)555
2882 y FA(b)n(ut)f(a)g(collection)f(of)g(independent)e
Ft(pr)l(ocesses.)35 b FA(The)21 b(concept)g(of)g(a)i(process)e
(corresponds)555 2986 y(closely)e(with)h(our)e(concept)h(of)g(the)g
(state)h(of)f(a)h(program.)27 b(By)20 b(writing)f(an)g(additional)f
(layer)555 3091 y(of)i(macros)f(on)h(top)f(of)h(those)g(in)g(the)g(pre)
n(vious)e(chapter)m(,)h(we)h(can)g(embed)f(multiprocessing)555
3195 y(in)h(Common)f(Lisp)i(programs.)555 3448 y Fw(21.1)99
b(The)26 b(Pr)n(ocess)f(Abstraction)555 3639 y FA(Multiple)e(processes)
g(are)g(a)g(con)m(v)o(enient)e(w)o(ay)i(of)g(e)o(xpressing)f(programs)f
(which)i(must)g(do)555 3743 y(se)n(v)o(eral)d(things)h(at)g(once.)31
b(A)22 b(traditional)e(processor)g(e)o(x)o(ecutes)f(one)i(instruction)f
(at)h(a)h(time.)555 3848 y(T)-7 b(o)25 b(say)g(that)g(multiple)f
(processes)g(do)g(more)g(than)g(one)h(thing)e(at)j(once)e(is)h(not)g
(to)g(say)f(that)555 3953 y(the)o(y)15 b(someho)n(w)f(o)o(v)o(ercome)f
(this)j(hardw)o(are)e(limitation:)27 b(what)15 b(it)i(means)e(is)h
(that)g(the)o(y)f(allo)n(w)555 4057 y(us)j(to)g(think)f(at)i(a)f(ne)n
(w)g(le)n(v)o(el)f(of)h(abstraction,)f(in)h(which)f(we)i(don')o(t)d(ha)
n(v)o(e)h(to)h(specify)f(e)o(xactly)555 4162 y(what)h(the)g(computer)f
(is)i(doing)d(at)j(an)o(y)e(gi)n(v)o(en)g(time.)29 b(Just)19
b(as)g(virtual)e(memory)g(allo)n(ws)h(us)g(to)555 4266
y(act)j(as)h(though)d(the)h(computer)f(had)h(more)g(memory)f(than)i(it)
g(actually)f(does,)h(the)f(notion)g(of)555 4371 y(a)h(process)g(allo)n
(ws)g(us)g(to)h(act)f(as)h(if)f(the)g(computer)e(could)h(run)g(more)g
(than)h(one)f(program)f(at)555 4476 y(a)i(time.)680 4580
y(The)14 b(study)h(of)g(processes)g(is)h(traditionally)e(in)h(the)g
(domain)f(of)h(operating)e(systems.)28 b(But)555 4685
y(the)23 b(usefulness)f(of)g(processes)h(as)g(an)g(abstraction)f(is)h
(not)g(limited)f(to)h(operating)e(systems.)555 4789 y(The)o(y)e(are)h
(equally)f(useful)h(in)g(other)g(real\255time)f(applications,)g(and)h
(in)g(simulations.)680 4894 y(Much)k(of)h(the)g(w)o(ork)g(done)f(on)g
(multiple)h(processes)g(has)g(been)g(de)n(v)n(oted)e(to)j(a)n(v)n
(oiding)555 4999 y(certain)h(types)g(of)g(problems.)49
b(Deadlock)26 b(is)j(one)e(classic)h(problem)d(with)j(multiple)f
(pro\255)1835 5229 y(275)p eop
%%Page: 276 289
276 288 bop 555 538 a FA(276)899 b Fu(MUL)-5 b(TIPLE)17
b(PR)n(OCESSES)555 801 y FA(cesses:)35 b(tw)o(o)23 b(processes)f(both)f
(stand)i(w)o(aiting)f(for)g(the)g(other)g(to)g(do)g(something,)g(lik)o
(e)g(tw)o(o)555 905 y(people)d(who)h(each)g(refuse)g(to)g(cross)g(a)h
(threshold)e(before)g(the)h(other)-5 b(.)29 b(Another)19
b(problem)g(is)555 1010 y(the)c(query)e(which)h(catches)h(the)f(system)
h(in)g(an)g(inconsistent)f(state\227say)-5 b(,)15 b(a)g(balance)f
(inquiry)555 1114 y(which)19 b(arri)n(v)o(es)h(while)g(the)g(system)g
(is)h(transferring)d(funds)h(from)g(one)g(account)g(to)h(another)-5
b(.)555 1219 y(This)17 b(chapter)e(deals)h(only)g(with)g(the)h(process)
f(abstraction)f(itself;)j(the)e(code)g(presented)f(here)555
1324 y(could)h(be)h(used)g(to)g(test)h(algorithms)d(for)i(pre)n(v)o
(enting)d(deadlock)h(or)i(inconsistent)f(states,)j(b)n(ut)555
1428 y(it)i(does)f(not)g(itself)h(pro)o(vide)d(an)o(y)h(protection)f
(against)i(these)g(problems.)680 1533 y(The)f(implementation)f(in)i
(this)h(chapter)e(follo)n(ws)g(a)i(rule)f(implicit)g(in)g(all)g(the)g
(programs)555 1638 y(in)26 b(this)h(book:)40 b(disturb)25
b(Lisp)i(as)g(little)g(as)g(possible.)46 b(In)26 b(spirit,)i(a)e
(program)e(ought)h(to)i(be)555 1742 y(as)i(much)e(as)h(possible)g(lik)o
(e)g(a)h(modi\002cation)d(of)i(the)g(language,)g(rather)f(than)h(a)g
(separate)555 1847 y(application)i(written)i(in)f(it.)65
b(Making)30 b(programs)g(harmonize)g(with)i(Lisp)f(mak)o(es)h(them)555
1951 y(more)27 b(rob)n(ust,)j(lik)o(e)e(a)h(machine)e(whose)h(parts)g
(\002t)h(together)d(well.)54 b(It)28 b(also)h(sa)n(v)o(es)g(ef)n(fort;)
555 2056 y(sometimes)20 b(you)f(can)h(mak)o(e)g(Lisp)g(do)g(a)h
(surprising)e(amount)f(of)i(your)f(w)o(ork)h(for)f(you.)680
2161 y(The)25 b(aim)g(of)g(this)h(chapter)f(is)h(to)g(mak)o(e)f(a)h
(language)e(which)g(supports)h(multiple)g(pro\255)555
2265 y(cesses.)45 b(Our)25 b(strate)o(gy)f(will)i(be)f(to)g(turn)g
(Lisp)g(into)g(such)g(a)g(language,)g(by)f(adding)g(a)i(fe)n(w)555
2370 y(ne)n(w)20 b(operators.)28 b(The)20 b(basic)g(elements)g(of)g
(our)f(language)g(will)i(be)f(as)h(follo)n(ws:)763 2557
y Ft(Functions)k FA(will)j(be)g(de\002ned)e(with)h(the)h
Fs(=defun)d FA(or)i Fs(=lambda)e FA(macros)h(from)h(the)763
2662 y(pre)n(vious)18 b(chapter)-5 b(.)763 2833 y Ft(Pr)l(ocesses)22
b FA(will)g(be)f(instantiated)g(from)f(function)g(calls.)33
b(There)21 b(is)h(no)f(limit)h(on)f(the)763 2938 y(number)j(of)h(acti)n
(v)o(e)g(processes,)i(or)f(the)f(number)f(of)i(processes)f
(instantiated)h(from)763 3042 y(an)o(y)g(one)g(function.)48
b(Each)27 b(process)f(will)i(ha)n(v)o(e)e(a)i(priority)-5
b(,)26 b(initially)h(gi)n(v)o(en)f(as)i(an)763 3147 y(ar)o(gument)17
b(when)j(it)h(is)g(created.)763 3318 y Ft(W)-8 b(ait)24
b(e)n(xpr)m(essions)f FA(may)g(occur)f(within)h(functions.)37
b(A)24 b(w)o(ait)g(e)o(xpression)e(will)i(tak)o(e)763
3422 y(a)h(v)n(ariable,)g(a)h(test)g(e)o(xpression,)f(and)g(a)g(body)f
(of)h(code.)44 b(If)25 b(a)h(process)e(encounters)763
3527 y(a)e(w)o(ait,)h(the)f(process)g(will)h(be)f(suspended)f(at)h
(that)h(point)e(until)h(the)g(test)h(e)o(xpression)763
3632 y(returns)d(true.)32 b(Once)22 b(the)f(process)g(restarts,)h(the)f
(body)f(of)h(code)g(will)h(be)f(e)n(v)n(aluated,)763
3736 y(with)c(the)h(v)n(ariable)e(bound)g(to)h(the)h(v)n(alue)f(of)g
(the)h(test)g(e)o(xpression.)27 b(T)-6 b(est)18 b(e)o(xpressions)763
3841 y(should)31 b(not)h(ordinarily)e(ha)n(v)o(e)i(side\255ef)n(fects,)
i(because)e(there)g(are)g(no)g(guarantees)763 3946 y(about)19
b(when,)g(or)h(ho)n(w)g(often,)f(the)o(y)g(will)i(be)f(e)n(v)n
(aluated.)763 4117 y Ft(Sc)o(heduling)c FA(will)21 b(be)e(done)f(by)i
(priority)-5 b(.)27 b(Of)19 b(all)h(the)g(processes)f(able)g(to)h
(restart,)g(the)763 4221 y(system)g(will)h(run)e(the)i(one)e(with)i
(the)f(highest)f(priority)-5 b(.)763 4392 y Ft(The)22
b(default)g(pr)l(ocess)g FA(will)h(run)f(if)h(no)e(other)h(process)g
(can.)35 b(It)23 b(is)g(a)g(read\255e)n(v)n(al\255print)763
4497 y(loop.)763 4668 y Ft(Cr)m(eation)16 b(and)h(deletion)f
FA(of)h(most)g(objects)g(will)h(be)f(possible)g(on)g(the)g(\003y)-5
b(.)28 b(From)17 b(run\255)763 4772 y(ning)g(processes)h(it)h(will)g
(be)f(possible)g(to)h(de\002ne)e(ne)n(w)i(functions,)e(and)g(to)i
(instantiate)763 4877 y(and)g(kill)i(processes.)p eop
%%Page: 277 290
277 289 bop 555 538 a Ft(21.2)954 b Fu(IMPLEMENT)-6 b(A)f(TION)936
b FA(277)p 555 745 2678 4 v 553 3661 4 2916 v 605 888
a Fs(\(defstruct)39 b(proc)86 b(pri)42 b(state)g(wait\))605
1087 y(\(proclaim)e('\(special)g(*procs*)g(*proc*\)\))605
1287 y(\(defvar)h(*halt*)g(\(gensym\)\))605 1486 y(\(defvar)g
(*default-proc*)954 1586 y(\(make-proc)e(:state)i(#'\(lambda)f(\(x\))
1912 1685 y(\(format)h(t)i("~\045>>)f("\))1912 1785 y(\(princ)g(\(eval)
f(\(read\)\)\))1912 1884 y(\(pick-process\)\)\)\))605
2084 y(\(defmacro)f(fork)i(\(expr)f(pri\))692 2183 y(`\(prog1)g(',expr)
1041 2283 y(\(push)g(\(make-proc)1389 2383 y(:state)g(#'\(lambda)f
(\(,\(gensym\)\))1869 2482 y(,expr)1869 2582 y(\(pick-process\)\))1389
2681 y(:pri)129 b(,pri\))1302 2781 y(*procs*\)\)\))605
2980 y(\(defmacro)40 b(program)g(\(name)i(args)g(&body)f(body\))692
3080 y(`\(=defun)f(,name)i(,args)823 3180 y(\(setq)f(*procs*)g(nil\))
823 3279 y(,@body)823 3379 y(\(catch)g(*halt*)g(\(loop)g
(\(pick-process\)\)\)\))o(\))1097 3583 y FA(Figure)19
b(21.1:)29 b(Process)20 b(structure)f(and)h(instantiation.)p
3231 3661 V 555 3664 2678 4 v 555 3889 a(Continuations)e(mak)o(e)g(it)i
(possible)f(to)g(store)g(the)g(state)h(of)f(a)h(Lisp)f(program.)26
b(Being)19 b(able)g(to)555 3993 y(store)d(se)n(v)o(eral)f(states)i(at)g
(once)e(is)i(not)f(v)o(ery)f(f)o(ar)g(from)g(ha)n(ving)g(multiple)h
(processes.)27 b(Starting)555 4098 y(with)16 b(the)h(macros)e
(de\002ned)h(in)g(the)g(pre)n(vious)f(chapter)m(,)g(we)i(need)f(less)h
(than)f(60)g(lines)g(of)g(code)555 4202 y(to)k(implement)f(multiple)h
(processes.)555 4455 y Fw(21.2)99 b(Implementation)680
4646 y FA(Figures)13 b(21.1)g(and)g(21.)o(2)f(con)o(tain)g(all)h(the)f
(co)o(de)g(nee)o(ded)g(to)g(sup)o(po)o(rt)h(m)o(ultiple)f(pr)o
(ocesses.)555 4750 y(Figure)17 b(21.1)f(contains)h(code)f(for)h(the)g
(basic)h(data)f(structures,)g(the)h(def)o(ault)e(process,)i
(initial\255)555 4855 y(ization,)26 b(and)f(instantiation)f(of)i
(processes.)44 b(Processes,)27 b(or)e Fs(proc)p FA(s,)h(ha)n(v)o(e)f
(the)g(follo)n(wing)555 4960 y(structure:)p eop
%%Page: 278 291
278 290 bop 555 538 a FA(278)899 b Fu(MUL)-5 b(TIPLE)17
b(PR)n(OCESSES)555 801 y Fs(pri)40 b FA(is)21 b(the)g(priority)d(of)i
(the)h(process,)e(which)h(should)f(be)h(a)h(positi)n(v)o(e)e(number)-5
b(.)555 972 y Fs(state)39 b FA(is)20 b(a)g(continuation)c(representing)
h(the)i(state)g(of)g(a)g(suspended)e(process.)29 b(A)19
b(process)763 1076 y(is)i(restarted)e(by)h(funcalling)e(its)k
Fs(state)p FA(.)555 1247 y Fs(wait)40 b FA(is)24 b(usually)f(a)i
(function)c(which)j(must)f(return)g(true)g(in)h(order)e(for)h(the)h
(process)f(to)h(be)763 1352 y(restarted,)15 b(b)n(ut)g(initially)h(the)
f Fs(wait)g FA(of)g(a)g(ne)n(wly)g(created)g(process)g(is)h
Fs(nil)p FA(.)27 b(A)16 b(process)763 1457 y(with)k(a)h(null)e
Fs(wait)h FA(can)g(al)o(w)o(ays)g(be)g(restarted.)680
1644 y(The)j(program)f(uses)i(three)f(global)g(v)n(ariables:)36
b Fs(*procs*)p FA(,)22 b(the)i(list)h(of)e(currently)f(sus\255)555
1749 y(pended)d(processes;)j Fs(*proc*)p FA(,)d(the)i(process)g(no)n(w)
g(running;)e(and)i Fs(*default-proc*)p FA(,)16 b(the)555
1853 y(def)o(ault)j(process.)680 1958 y(The)28 b(def)o(ault)g(process)g
(runs)g(only)g(when)h(no)f(other)g(process)g(can.)55
b(It)29 b(simulates)g(the)555 2063 y(Lisp)18 b(tople)n(v)o(el.)28
b(W)m(ithin)18 b(this)g(loop,)g(the)g(user)g(can)g(halt)h(the)f
(program,)e(or)i(type)g(e)o(xpressions)555 2167 y(which)h(enable)g
(suspended)f(processes)h(to)h(restart.)28 b(Notice)20
b(that)f(the)h(def)o(ault)f(process)g(calls)555 2272
y Fs(eval)e FA(e)o(xplicitly)-5 b(.)27 b(This)18 b(is)h(one)e(of)h(the)
g(fe)n(w)g(situations)f(in)i(which)e(it)i(is)f(le)o(gitimate)g(to)g(do)
f(so.)555 2376 y(Generally)i(it)i(is)g(not)f(a)h(good)d(idea)j(to)f
(call)g Fs(eval)g FA(at)g(runtime,)f(for)h(tw)o(o)g(reasons:)659
2564 y(1.)41 b(It')-5 b(s)18 b(inef)n(\002cient:)27 b
Fs(eval)16 b FA(is)i(handed)e(a)i(ra)o(w)f(list,)h(and)f(either)g(has)h
(to)f(compile)g(it)h(on)f(the)763 2669 y(spot,)26 b(or)f(e)n(v)n
(aluate)f(it)i(in)g(an)f(interpreter)-5 b(.)43 b(Either)25
b(w)o(ay)g(is)h(slo)n(wer)f(than)g(compiling)763 2773
y(the)20 b(code)f(beforehand,)e(and)j(just)h(calling)e(it.)659
2944 y(2.)41 b(It')-5 b(s)22 b(less)g(po)n(werful,)e(because)h(the)g(e)
o(xpression)f(is)j(e)n(v)n(aluated)d(with)h(no)g(le)o(xical)g(con\255)
763 3049 y(te)o(xt.)75 b(Among)34 b(other)h(things,)k(this)d(means)f
(that)h(you)e(can')o(t)h(refer)g(to)h(ordinary)763 3153
y(v)n(ariables)19 b(visible)h(outside)g(the)g(e)o(xpression)f(being)g
(e)n(v)n(aluated.)555 3341 y(Usually)-5 b(,)23 b(calling)f
Fs(eval)g FA(e)o(xplicitly)g(is)i(lik)o(e)f(b)n(uying)f(something)g(in)
h(an)g(airport)e(gift\255shop.)555 3446 y(Ha)n(ving)30
b(w)o(aited)h(till)h(the)f(last)g(moment,)h(you)e(ha)n(v)o(e)g(to)h
(pay)g(high)f(prices)g(for)g(a)i(limited)555 3550 y(selection)20
b(of)g(second\255rate)e(goods.)680 3655 y(Cases)g(lik)o(e)f(this)h(are)
f(rare)g(instances)g(when)f(neither)g(of)h(the)g(tw)o(o)h(preceding)d
(ar)o(guments)555 3760 y(applies.)28 b(W)-7 b(e)20 b(couldn')o(t)d
(possibly)h(ha)n(v)o(e)g(compiled)g(the)h(e)o(xpressions)e(beforehand.)
26 b(W)-7 b(e)20 b(are)555 3864 y(just)29 b(no)n(w)e(reading)g(them;)k
(there)d(is)h(no)f(beforehand.)49 b(Lik)o(e)n(wise,)30
b(the)e(e)o(xpression)f(can')o(t)555 3969 y(refer)e(to)h(surrounding)d
(le)o(xical)i(v)n(ariables,)h(because)f(e)o(xpressions)g(typed)g(at)h
(the)g(tople)n(v)o(el)555 4073 y(are)c(in)g(the)g(null)g(le)o(xical)f
(en)m(vironment.)32 b(In)21 b(f)o(act,)i(the)f(de\002nition)f(of)g
(this)i(function)d(simply)555 4178 y(re\003ects)h(its)g(English)e
(description:)28 b(it)21 b(reads)f(and)g(e)n(v)n(aluates)f(what)h(the)h
(user)f(types.)680 4283 y(The)28 b(macro)f Fs(fork)h
FA(instantiates)g(a)h(process)f(from)g(a)h(function)d(call.)55
b(Functions)28 b(are)555 4387 y(de\002ned)19 b(as)i(usual)f(with)g
Fs(=defun)p FA(:)555 4570 y Fs(\(=defun)41 b(foo)h(\(x\))642
4669 y(\(format)f(t)i("Foo)f(was)g(called)f(with)h(~A.~\045")f(x\))642
4769 y(\(=values)f(\(1+)j(x\)\)\))555 4957 y FA(No)n(w)20
b(when)g(we)g(call)h Fs(fork)e FA(with)h(a)h(function)d(call)j(and)f(a)
g(priority)f(number:)p eop
%%Page: 279 292
279 291 bop 555 538 a Ft(21.2)954 b Fu(IMPLEMENT)-6 b(A)f(TION)936
b FA(279)555 801 y Fs(\(fork)42 b(\(foo)f(2\))i(25\))555
979 y FA(a)24 b(ne)n(w)f(process)g(is)h(pushed)e(onto)g
Fs(*procs*)p FA(.)37 b(The)22 b(ne)n(w)i(process)e(has)i(a)g(priority)e
(of)h Fs(25)p FA(,)g(a)555 1084 y Fs(proc-wait)15 b FA(of)j
Fs(nil)p FA(,)f(since)h(it)h(hasn')o(t)e(been)h(started)g(yet,)g(and)f
(a)i Fs(proc-state)14 b FA(consisting)555 1188 y(of)20
b(a)h(call)f(to)h Fs(foo)e FA(with)h(the)h(ar)o(gument)c
Fs(2)p FA(.)680 1293 y(The)26 b(macro)f Fs(program)g
FA(allo)n(ws)i(us)g(to)f(create)h(a)g(group)d(of)j(processes)f(and)g
(run)g(them)555 1398 y(together)-5 b(.)28 b(The)20 b(de\002nition:)555
1571 y Fs(\(program)40 b(two-foos)h(\(a)h(b\))642 1671
y(\(fork)g(\(foo)g(a\))g(99\))642 1770 y(\(fork)g(\(foo)g(b\))g(99\)\))
555 1949 y FA(macroe)o(xpands)23 b(into)j(the)g(tw)o(o)h
Fs(fork)e FA(e)o(xpressions,)h(sandwiched)f(between)h(code)f(which)555
2053 y(clears)i(out)g(the)f(suspended)g(processes,)i(and)e(other)g
(code)g(which)h(repeatedly)e(chooses)h(a)555 2158 y(process)17
b(to)h(run.)28 b(Outside)18 b(this)g(loop,)f(the)h(macro)f(establishes)
h(a)g(tag)g(to)g(which)f(control)g(can)555 2263 y(be)24
b(thro)n(wn)f(to)h(end)g(the)g(program.)40 b(As)25 b(a)f(gensym,)g
(this)h(tag)f(will)h(not)f(con\003ict)g(with)g(tags)555
2367 y(established)e(by)f(user)h(code.)34 b(A)23 b(group)d(of)i
(processes)g(de\002ned)f(as)i(a)f Fs(program)e FA(returns)h(no)555
2472 y(particular)e(v)n(alue,)g(and)h(is)h(only)e(meant)h(to)g(be)g
(called)g(from)g(the)g(tople)n(v)o(el.)680 2576 y(After)25
b(the)g(processes)h(are)f(instantiated,)h(the)g(process)f(scheduling)f
(code)h(tak)o(es)h(o)o(v)o(er)-5 b(.)555 2681 y(This)20
b(code)e(is)j(sho)n(wn)e(in)g(Figure)g(21.2.)28 b(The)19
b(function)f Fs(pick-process)d FA(selects)20 b(and)f(runs)555
2786 y(the)k(highest)f(priority)g(process)h(which)f(is)i(able)f(to)g
(restart.)38 b(Selecting)22 b(this)i(process)f(is)h(the)555
2890 y(job)g(of)g Fs(most-urgent-proce)o(ss)p FA(.)36
b(A)25 b(suspended)e(process)h(is)i(eligible)e(to)h(run)e(if)i(it)g
(has)555 2995 y(no)h Fs(wait)e FA(function,)i(or)g(its)h
Fs(wait)d FA(function)h(returns)g(true.)46 b(Among)25
b(eligible)g(processes,)555 3099 y(the)h(one)g(with)g(the)h(highest)e
(priority)g(is)i(chosen.)47 b(The)26 b(winning)f(process)g(and)h(the)g
(v)n(alue)555 3204 y(returned)i(by)h(its)i Fs(wait)d
FA(function)g(\(if)i(there)f(is)h(one\))f(are)h(returned)d(to)j
Fs(pick-process)p FA(.)555 3309 y(There)23 b(will)h(al)o(w)o(ays)g(be)f
(some)h(winning)e(process,)i(because)f(the)g(def)o(ault)g(process)g(al)
o(w)o(ays)555 3413 y(w)o(ants)e(to)f(run.)680 3518 y(The)f(remainder)e
(of)j(the)f(code)g(in)h(Figure)f(21.2)f(de\002nes)i(the)f(operators)f
(used)i(to)f(switch)555 3623 y(control)i(between)h(processes.)35
b(The)22 b(standard)g(w)o(ait)h(e)o(xpression)e(is)i
Fs(wait)p FA(,)f(as)h(used)f(in)h(the)555 3727 y(function)28
b Fs(pedestrian)d FA(in)30 b(Figure)e(21.3.)56 b(In)29
b(this)g(e)o(xample,)h(the)g(process)e(w)o(aits)j(until)555
3832 y(there)20 b(is)h(something)e(in)h(the)g(list)h
Fs(*open-doors*)p FA(,)16 b(then)k(prints)g(a)g(message:)555
4005 y Fs(>)43 b(\(ped\))555 4105 y(>>)g(\(push)e('door2)g
(*open-doors*\))555 4204 y(Entering)f(DOOR2)555 4304
y(>>)j(\(halt\))555 4404 y(NIL)680 4582 y FA(A)33 b Fs(wait)f
FA(is)i(similar)f(in)g(spirit)h(to)f(an)g Fs(=bind)e
FA(\(page)h(267\),)j(and)e(carries)f(the)h(same)555 4687
y(restriction)28 b(that)h(it)h(must)e(be)h(the)g(last)h(thing)e(to)h
(be)g(e)n(v)n(aluated.)53 b(An)o(ything)27 b(we)i(w)o(ant)g(to)555
4791 y(happen)18 b(after)h(the)g Fs(wait)f FA(must)h(be)h(put)f(in)g
(its)h(body)-5 b(.)28 b(Thus,)18 b(if)i(we)g(w)o(ant)f(to)h(ha)n(v)o(e)
e(a)i(process)555 4896 y(w)o(ait)h(se)n(v)o(eral)e(times,)i(the)f(w)o
(ait)g(e)o(xpressions)f(must)h(be)g(nested.)29 b(By)21
b(asserting)f(f)o(acts)g(aimed)555 5001 y(at)h(one)f(another)m(,)f
(processes)i(can)f(cooperate)f(in)i(reaching)e(some)i(goal,)f(as)h(in)g
(Figure)f(21.4.)p eop
%%Page: 280 293
280 292 bop 555 538 a FA(280)899 b Fu(MUL)-5 b(TIPLE)17
b(PR)n(OCESSES)p 555 745 2678 4 v 553 5056 4 4311 v 605
888 a Fs(\(defun)41 b(pick-process)e(\(\))692 988 y(\(multiple-value-)o
(bin)o(d)e(\(p)43 b(val\))f(\(most-urgent-pro)o(ces)o(s\))779
1087 y(\(setq)g(*proc*)84 b(p)1041 1187 y(*procs*)40
b(\(delete)h(p)i(*procs*\)\))779 1287 y(\(funcall)d(\(proc-state)f(p\))
k(val\)\)\))605 1486 y(\(defun)e(most-urgent-proc)o(es)o(s)d(\(\))692
1586 y(\(let)k(\(\(proc1)f(*default-proc*\))c(\(max)42
b(-1\))g(\(val1)g(t\)\))779 1685 y(\(dolist)f(\(p)i(*procs*\))866
1785 y(\(let)f(\(\(pri)g(\(proc-pri)e(p\)\)\))954 1884
y(\(if)i(\(>)h(pri)f(max\))1128 1984 y(\(let)g(\(\(val)f(\(or)i(\(not)f
(\(proc-wait)d(p\)\))1782 2084 y(\(funcall)h(\(proc-wait)f(p\)\)\)\)\))
1215 2183 y(\(when)j(val)1302 2283 y(\(setq)g(proc1)f(p)1564
2383 y(max)129 b(pri)1564 2482 y(val1)85 b(val\)\)\)\)\)\))779
2582 y(\(values)41 b(proc1)g(val1\)\)\))605 2781 y(\(defun)g
(arbitrator)e(\(test)j(cont\))692 2881 y(\(setf)g(\(proc-state)d
(*proc*\))h(cont)954 2980 y(\(proc-wait)f(*proc*\))84
b(test\))692 3080 y(\(push)42 b(*proc*)f(*procs*\))692
3180 y(\(pick-process\)\))605 3379 y(\(defmacro)f(wait)i(\(parm)f(test)
h(&body)g(body\))692 3478 y(`\(arbitrator)d(#'\(lambda)g(\(\))k
(,test\))1259 3578 y(#'\(lambda)c(\(,parm\))i(,@body\)\)\))605
3777 y(\(defmacro)f(yield)h(\(&body)g(body\))692 3877
y(`\(arbitrator)e(nil)j(#'\(lambda)e(\(,\(gensym\)\))f(,@body\)\)\))605
4076 y(\(defun)i(setpri)g(\(n\))h(\(setf)g(\(proc-pri)e(*proc*\))g
(n\)\))605 4275 y(\(defun)h(halt)h(\(&optional)d(val\))j(\(throw)f
(*halt*)g(val\)\))605 4475 y(\(defun)g(kill)h(\(&optional)d(obj)k
(&rest)e(args\))692 4574 y(\(if)h(obj)866 4674 y(\(setq)g(*procs*)f
(\(apply)g(#'delete)f(obj)i(*procs*)f(args\)\))866 4774
y(\(pick-process\)\)\))1348 4978 y FA(Figure)20 b(21.2:)28
b(Process)21 b(scheduling.)p 3231 5056 V 555 5059 2678
4 v eop
%%Page: 281 294
281 293 bop 555 538 a Ft(21.2)954 b Fu(IMPLEMENT)-6 b(A)f(TION)936
b FA(281)p 555 745 2678 4 v 553 1868 4 1123 v 605 888
a Fs(\(defvar)41 b(*open-doors*)d(nil\))605 1087 y(\(=defun)j
(pedestrian)e(\(\))692 1187 y(\(wait)j(d)h(\(car)f(*open-doors*\))779
1287 y(\(format)f(t)i("Entering)d(~A~\045")h(d\)\)\))605
1486 y(\(program)f(ped)i(\(\))692 1586 y(\(fork)g(\(pedestrian\))c
(1\)\))1225 1790 y FA(Figure)20 b(21.3:)28 b(One)20 b(process)g(with)g
(one)g(w)o(ait.)p 3231 1868 V 555 1871 2678 4 v 555 2079
a(Processes)33 b(instantiated)f(from)f Fs(visitor)f FA(and)i
Fs(host)p FA(,)i(if)f(gi)n(v)o(en)e(the)i(same)g Fs(door)p
FA(,)h(will)555 2184 y(e)o(xchange)18 b(control)h(via)h(messages)g(on)g
(a)h(blackboard:)555 2346 y Fs(>)43 b(\(ballet\))555
2446 y(Approach)d(DOOR2.)h(Open)h(DOOR2.)f(Enter)h(DOOR2.)f(Close)h
(DOOR2.)555 2546 y(Approach)e(DOOR1.)h(Open)h(DOOR1.)f(Enter)h(DOOR1.)f
(Close)h(DOOR1.)555 2645 y(>>)680 2813 y FA(There)16
b(is)h(another)m(,)f(simpler)g(type)h(of)f(w)o(ait)i(e)o(xpression:)26
b Fs(yield)p FA(,)16 b(whose)g(only)g(purpose)555 2917
y(is)i(to)f(gi)n(v)o(e)g(other)f(higher)n(\255priority)e(processes)i(a)
i(chance)e(to)h(run.)28 b(A)17 b(process)g(might)f(w)o(ant)h(to)555
3022 y(yield)h(after)g(e)o(x)o(ecuting)e(a)i Fs(setpri)f
FA(e)o(xpression,)f(which)i(resets)h(the)f(priority)f(of)h(the)g
(current)555 3126 y(process.)56 b(As)31 b(with)e(a)h
Fs(wait)p FA(,)g(an)o(y)f(code)g(to)g(be)h(e)o(x)o(ecuted)d(after)i(a)h
Fs(yield)e FA(must)i(be)f(put)555 3231 y(within)20 b(its)h(body)-5
b(.)680 3336 y(The)23 b(program)f(in)h(Figure)h(21.5)e(illustrates)i
(ho)n(w)g(the)f(tw)o(o)h(operators)f(w)o(ork)g(together)-5
b(.)555 3440 y(Initially)g(,)16 b(the)f(barbarians)g(ha)n(v)o(e)g(tw)o
(o)h(aims:)28 b(to)16 b(capture)e(Rome)i(and)g(to)g(plunder)e(it.)28
b(Captur)n(\255)555 3545 y(ing)20 b(the)h(city)g(has)g(\(slightly\))e
(higher)h(priority)-5 b(,)19 b(and)h(so)h(will)g(run)f(\002rst.)32
b(Ho)n(we)n(v)o(er)m(,)18 b(after)j(the)555 3650 y(city)i(has)g(been)f
(reduced,)f(the)i(priority)e(of)h(the)h Fs(capture)d
FA(process)j(decreases)f(to)h Fs(1)p FA(.)36 b(Then)555
3754 y(there)20 b(is)h(a)f(v)n(ote,)g(and)g Fs(plunder)p
FA(,)e(as)i(the)h(highest\255priority)c(process,)i(starts)i(running.)
555 3917 y Fs(>)43 b(\(barbarians\))555 4016 y(Liberating)c(ROME.)555
4116 y(Nationalizing)f(ROME.)555 4216 y(Refinancing)h(ROME.)555
4315 y(Rebuilding)g(ROME.)555 4415 y(>>)555 4582 y FA(Only)15
b(after)g(the)g(barbarians)e(ha)n(v)o(e)i(looted)f(Rome')-5
b(s)15 b(palaces)g(and)g(ransomed)e(the)i(patricians,)555
4687 y(does)k(the)h Fs(capture)d FA(process)i(resume,)f(and)h(the)h
(barbarians)d(turn)i(to)h(fortifying)d(their)i(o)n(wn)555
4791 y(position.)680 4896 y(Underlying)f(w)o(ait)j(e)o(xpressions)f(is)
h(the)g(more)f(general)f Fs(arbitrator)p FA(.)27 b(This)21
b(function)555 5001 y(stores)28 b(the)g(current)f(process,)i(and)e
(then)h(calls)g Fs(pick-process)c FA(to)k(start)g(some)g(process)p
eop
%%Page: 282 295
282 294 bop 555 538 a FA(282)899 b Fu(MUL)-5 b(TIPLE)17
b(PR)n(OCESSES)p 555 745 2678 4 v 553 3960 4 3215 v 605
888 a Fs(\(defvar)41 b(*bboard*)f(nil\))605 1087 y(\(defun)h(claim)129
b(\(&rest)41 b(f\))h(\(push)g(f)h(*bboard*\)\))605 1287
y(\(defun)e(unclaim)g(\(&rest)g(f\))h(\(pull)g(f)h(*bboard*)d(:test)i
(#'equal\)\))605 1486 y(\(defun)f(check)129 b(\(&rest)41
b(f\))h(\(find)g(f)h(*bboard*)d(:test)i(#'equal\)\))605
1685 y(\(=defun)f(visitor)f(\(door\))692 1785 y(\(format)h(t)i
("Approach)d(~A.)i(")h(door\))692 1884 y(\(claim)e('knock)g(door\))692
1984 y(\(wait)h(d)h(\(check)e('open)g(door\))779 2084
y(\(format)g(t)i("Enter)e(~A.)h(")i(door\))779 2183 y(\(unclaim)c
('knock)i(door\))779 2283 y(\(claim)f('inside)g(door\)\)\))605
2482 y(\(=defun)g(host)g(\(door\))692 2582 y(\(wait)h(k)h(\(check)e
('knock)g(door\))779 2681 y(\(format)g(t)i("Open)f(~A.)g(")h(door\))779
2781 y(\(claim)e('open)h(door\))779 2881 y(\(wait)g(g)h(\(check)e
('inside)g(door\))866 2980 y(\(format)g(t)i("Close)e(~A.~\045")g
(door\))866 3080 y(\(unclaim)g('open)g(door\)\)\)\))605
3279 y(\(program)f(ballet)h(\(\))692 3379 y(\(fork)h(\(visitor)e
('door1\))g(1\))692 3478 y(\(fork)i(\(host)f('door1\))g(1\))692
3578 y(\(fork)h(\(visitor)e('door2\))g(1\))692 3678 y(\(fork)i(\(host)f
('door2\))g(1\)\))1085 3882 y FA(Figure)20 b(21.4:)28
b(Synchronization)17 b(with)k(a)f(blackboard.)p 3231
3960 V 555 3963 2678 4 v 555 4188 a(\(perhaps)28 b(the)i(same)f(one\))g
(running)e(again.)57 b(It)30 b(will)g(be)f(gi)n(v)o(en)g(tw)o(o)h(ar)o
(guments:)46 b(a)30 b(test)555 4292 y(function)g(and)h(a)h
(continuation.)61 b(The)31 b(former)f(will)j(be)e(stored)g(as)i(the)e
Fs(proc-wait)e FA(of)555 4397 y(the)24 b(process)g(being)f(suspended,)h
(and)g(called)g(later)g(to)h(determine)e(if)h(it)h(can)f(be)g
(restarted.)555 4501 y(The)d(latter)h(will)g(become)e(the)h
Fs(proc-state)p FA(,)d(and)j(calling)g(it)h(will)g(restart)g(the)f
(suspended)555 4606 y(process.)680 4711 y(The)16 b(macros)h
Fs(wait)f FA(and)h Fs(yield)f FA(b)n(uild)g(this)i(continuation)d
(function)h(simply)h(by)f(wrap\255)555 4815 y(ping)j(their)h(bodies)g
(in)g(lambda\255e)o(xpressions.)26 b(F)o(or)20 b(e)o(xample,)555
4998 y Fs(\(wait)42 b(d)h(\(car)f(*bboard*\))d(\(=values)i(d\)\))p
eop
%%Page: 283 296
283 295 bop 555 538 a Ft(21.2)954 b Fu(IMPLEMENT)-6 b(A)f(TION)936
b FA(283)p 555 745 2678 4 v 553 2864 4 2119 v 605 888
a Fs(\(=defun)41 b(capture)f(\(city\))692 988 y(\(take)i(city\))692
1087 y(\(setpri)f(1\))692 1187 y(\(yield)779 1287 y(\(fortify)f
(city\)\)\))605 1486 y(\(=defun)h(plunder)f(\(city\))692
1586 y(\(loot)i(city\))692 1685 y(\(ransom)f(city\)\))605
1884 y(\(defun)g(take)h(\(c\))173 b(\(format)41 b(t)i("Liberating)c
(~A.~\045")i(c\)\))605 1984 y(\(defun)g(fortify)g(\(c\))h(\(format)f(t)
i("Rebuilding)c(~A.~\045")i(c\)\))605 2084 y(\(defun)g(loot)h(\(c\))173
b(\(format)41 b(t)i("Nationalizing)38 b(~A.~\045")j(c\)\))605
2183 y(\(defun)g(ransom)g(\(c\))86 b(\(format)41 b(t)i("Refinancing)38
b(~A.~\045")k(c\)\))605 2383 y(\(program)e(barbarians)g(\(\))692
2482 y(\(fork)i(\(capture)e('rome\))h(100\))692 2582
y(\(fork)h(\(plunder)e('rome\))h(98\)\))1197 2786 y FA(Figure)20
b(21.5:)28 b(Ef)n(fect)20 b(of)f(changing)g(priorities.)p
3231 2864 V 555 2867 2678 4 v 555 3078 a(e)o(xpands)g(into:)555
3244 y Fs(\(arbitrator)39 b(#'\(lambda)h(\(\))j(\(car)f(*bboard*\)\))
1078 3343 y(#'\(lambda)e(\(d\))i(\(=values)f(d\)\)\))555
3514 y FA(If)27 b(the)g(code)f(obe)o(ys)f(the)i(restrictions)g(listed)g
(in)g(Figure)f(20.5,)h(making)f(a)h(closure)f(of)h(the)555
3618 y Fs(wait)p FA(')-5 b(s)31 b(body)g(will)i(preserv)o(e)d(the)i
(whole)g(current)e(continuation.)63 b(W)m(ith)32 b(its)h
Fs(=values)555 3723 y FA(e)o(xpanded)18 b(the)i(second)f(ar)o(gument)f
(becomes:)555 3889 y Fs(#'\(lambda)40 b(\(d\))i(\(funcall)e(*cont*)i
(d\)\))555 4059 y FA(Since)31 b(the)f(closure)g(contains)g(a)h
(reference)e(to)i Fs(*cont*)p FA(,)g(the)g(suspended)e(process)h(with)
555 4164 y(this)d(w)o(ait)f(function)f(will)i(ha)n(v)o(e)e(a)i(handle)d
(on)i(where)g(it)g(w)o(as)h(headed)e(at)i(the)f(time)g(it)h(w)o(as)555
4268 y(suspended.)680 4373 y(The)21 b Fs(halt)f FA(operator)g(stops)h
(the)h(whole)f(program,)e(by)i(thro)n(wing)f(control)g(back)h(to)h(the)
555 4478 y(tag)32 b(established)g(by)g(the)h(e)o(xpansion)d(of)i
Fs(program)p FA(.)63 b(It)33 b(tak)o(es)g(an)f(optional)f(ar)o(gument,)
555 4582 y(which)17 b(will)h(be)g(returned)e(as)i(the)f(v)n(alue)g(of)h
(the)f(program.)26 b(Because)18 b(the)g(def)o(ault)f(process)g(is)555
4687 y(al)o(w)o(ays)j(willing)g(to)h(run,)e(the)h(only)f(w)o(ay)h
(programs)e(end)h(is)i(by)f(e)o(xplicit)f Fs(halt)p FA(s.)29
b(It)20 b(doesn')o(t)555 4791 y(matter)g(what)g(code)g(follo)n(ws)f(a)i
Fs(halt)p FA(,)e(since)h(it)h(w)o(on')o(t)e(be)h(e)n(v)n(aluated.)680
4896 y(Indi)n(vidual)25 b(processes)i(can)g(be)g(killed)h(by)f(calling)
g Fs(kill)p FA(.)49 b(If)28 b(gi)n(v)o(en)e(no)h(ar)o(guments,)555
5001 y(this)21 b(operator)d(kills)j(the)f(current)f(process.)29
b(In)20 b(this)g(case,)h Fs(kill)e FA(is)i(lik)o(e)g(a)f(w)o(ait)h(e)o
(xpression)p eop
%%Page: 284 297
284 296 bop 555 538 a FA(284)899 b Fu(MUL)-5 b(TIPLE)17
b(PR)n(OCESSES)555 801 y FA(which)30 b(ne)o(glects)g(to)h(store)f(the)h
(current)e(process.)60 b(If)30 b Fs(kill)g FA(is)h(gi)n(v)o(en)e(ar)o
(guments,)i(the)o(y)555 905 y(become)22 b(the)g(ar)o(guments)f(to)i(a)g
Fs(delete)e FA(on)h(the)h(list)h(of)e(processes.)37 b(In)22
b(the)h(current)f(code,)555 1010 y(there)16 b(is)h(not)f(much)f(one)h
(can)g(say)g(in)h(a)g Fs(kill)e FA(e)o(xpression,)g(because)g
(processes)h(do)g(not)g(ha)n(v)o(e)555 1114 y(man)o(y)24
b(properties)f(to)i(refer)f(to.)43 b(Ho)n(we)n(v)o(er)m(,)24
b(a)h(more)f(elaborate)f(system)i(w)o(ould)f(associate)555
1219 y(more)f(information)e(with)j(processes\227time)f(stamps,)h(o)n
(wners,)g(and)f(so)h(on.)39 b(The)23 b(def)o(ault)555
1324 y(process)d(can')o(t)f(be)h(killed,)g(because)f(it)i(isn')o(t)f(k)
o(ept)g(in)g(the)g(list)i Fs(*procs*)p FA(.)555 1574
y Fw(21.3)99 b(The)26 b(Less\255than\255Rapid)g(Pr)n(ototype)555
1765 y FA(Processes)e(simulated)f(with)h(continuations)d(are)i(not)h
(going)e(to)i(be)f(nearly)g(as)h(ef)n(\002cient)f(as)555
1869 y(real)h(operating)f(system)h(processes.)41 b(What')-5
b(s)26 b(the)e(use,)h(then,)g(of)f(programs)e(lik)o(e)j(the)f(one)555
1974 y(in)c(this)h(chapter?)680 2079 y(Such)j(programs)f(are)h(useful)h
(in)f(the)h(same)g(w)o(ay)g(that)g(sk)o(etches)f(are.)43
b(In)25 b Ft(e)n(xplor)o(atory)555 2183 y(pr)l(o)o(gr)o(amming)g
FA(or)h Ft(r)o(apid)f(pr)l(ototyping)o(,)h FA(the)h(program)d(is)j(not)
f(an)h(end)e(in)i(itself)g(so)g(much)555 2288 y(as)d(a)f(v)o(ehicle)f
(for)h(w)o(orking)e(out)i(one')-5 b(s)23 b(ideas.)38
b(In)23 b(man)o(y)e(other)i(\002elds,)h(something)d(which)555
2392 y(serv)o(es)h(this)g(purpose)e(is)j(called)f(a)g(sk)o(etch.)34
b(An)22 b(architect)g(could,)f(in)h(principle,)e(design)i(an)555
2497 y(entire)k(b)n(uilding)f(in)h(his)h(head.)46 b(Ho)n(we)n(v)o(er)m
(,)25 b(most)i(architects)f(seem)g(to)g(think)g(better)f(with)555
2602 y(pencils)f(in)f(their)h(hands:)36 b(the)24 b(design)f(of)g(a)h(b)
n(uilding)f(is)i(usually)e(w)o(ork)o(ed)f(out)i(in)g(a)g(series)555
2706 y(of)c(preparatory)d(sk)o(etches.)680 2811 y(Rapid)29
b(prototyping)d(is)k(sk)o(etching)e(softw)o(are.)56 b(Lik)o(e)29
b(an)g(architect')-5 b(s)29 b(\002rst)h(sk)o(etches,)555
2915 y(softw)o(are)15 b(prototypes)e(tend)h(to)h(be)g(dra)o(wn)f(with)h
(a)g(fe)n(w)g(sweeping)g(strok)o(es.)27 b(Considerations)555
3020 y(of)21 b(cost)g(and)g(ef)n(\002cienc)o(y)e(are)j(ignored)d(in)i
(an)g(initial)h(push)e(to)h(de)n(v)o(elop)f(an)h(idea)g(to)g(the)g
(full.)555 3125 y(The)27 b(result,)i(at)e(this)h(stage,)h(is)f(lik)o
(ely)f(to)h(be)f(an)g(unb)n(uildable)e(b)n(uilding)h(or)h(a)g
(hopelessly)555 3229 y(inef)n(\002cient)19 b(piece)h(of)g(softw)o(are.)
29 b(But)21 b(the)f(sk)o(etches)g(are)g(v)n(aluable)f(all)i(the)f
(same,)g(because)659 3404 y(1.)41 b(The)o(y)19 b(con)m(v)o(e)o(y)e
(information)h(brie\003y)-5 b(.)659 3570 y(2.)41 b(The)o(y)19
b(of)n(fer)g(a)h(chance)g(to)g(e)o(xperiment.)555 3745
y(The)31 b(program)e(described)g(in)j(this)f(chapter)f(is,)35
b(lik)o(e)c(those)g(in)g(succeeding)e(chapters,)k(a)555
3850 y(sk)o(etch.)41 b(It)24 b(suggests)g(the)g(outlines)g(of)f
(multiprocessing)g(in)h(a)g(fe)n(w)-5 b(,)25 b(broad)d(strok)o(es.)41
b(And)555 3955 y(though)23 b(it)j(w)o(ould)e(not)h(be)g(ef)n(\002cient)
g(enough)e(for)h(use)i(in)f(production)d(softw)o(are,)k(it)g(could)555
4059 y(be)g(quite)g(useful)g(for)f(e)o(xperimenting)e(with)k(other)e
(aspects)i(of)f(multiple)f(processes,)i(lik)o(e)555 4164
y(scheduling)18 b(algorithms.)680 4268 y(Chapters)j(22\22624)f(present)
i(other)f(applications)g(of)g(continuations.)33 b(None)21
b(of)h(them)g(is)555 4373 y(ef)n(\002cient)k(enough)e(for)h(use)i(in)f
(production)e(softw)o(are.)46 b(Because)27 b(Lisp)f(and)g(rapid)f
(proto\255)555 4478 y(typing)f(e)n(v)n(olv)o(ed)f(together)m(,)i(Lisp)g
(includes)g(a)g(lot)g(of)g(features)g(speci\002cally)g(intended)e(for)
555 4582 y(prototypes:)j(inef)n(\002cient)16 b(b)n(ut)h(con)m(v)o
(enient)d(features)i(lik)o(e)h(property)d(lists,)19 b(k)o(e)o(yw)o(ord)
c(param\255)555 4687 y(eters,)25 b(and,)f(for)g(that)g(matter)m(,)g
(lists.)42 b(Continuations)22 b(probably)g(belong)g(in)j(this)f(cate)o
(gory)-5 b(.)555 4791 y(The)o(y)18 b(sa)n(v)o(e)i(more)f(state)h(than)f
(a)h(program)e(is)i(lik)o(ely)g(to)f(need.)29 b(So)19
b(our)g(continuation\255based)555 4896 y(implementation)14
b(of)j(Prolog,)f(for)g(e)o(xample,)g(is)h(a)g(good)f(w)o(ay)g(to)h
(understand)e(the)i(language,)555 5001 y(b)n(ut)j(an)g(inef)n
(\002cient)g(w)o(ay)g(to)g(implement)f(it.)p eop
%%Page: 285 298
285 297 bop 555 538 a Ft(21.3)703 b Fu(THE)17 b(LESS)p
Fv(\255)p Fu(THAN)p Fv(\255)p Fu(RAPID)i(PR)n(O)n(T)o(O)n(TYPE)683
b FA(285)680 801 y(This)31 b(book)f(is)i(concerned)d(more)h(with)h(the)
h(kinds)e(of)h(abstractions)f(one)h(can)g(b)n(uild)555
905 y(in)e(Lisp)g(than)f(with)g(ef)n(\002cienc)o(y)g(issues.)55
b(It')-5 b(s)29 b(important)e(to)i(realize,)h(though,)f(that)f(Lisp)555
1010 y(is)g(a)f(language)e(for)i(writing)f(production)e(softw)o(are)j
(as)g(well)h(as)f(a)h(language)d(for)h(writing)555 1114
y(prototypes.)43 b(If)26 b(Lisp)g(has)f(a)h(reputation)e(for)h(slo)n
(wness,)i(it)f(is)h(lar)o(gely)d(because)h(so)h(man)o(y)555
1219 y(programmers)d(stop)j(with)f(the)h(prototype.)44
b(It)26 b(is)g(easy)g(to)g(write)g(f)o(ast)g(programs)e(in)i(Lisp.)555
1324 y(Unfortunately)-5 b(,)27 b(it)i(is)g Ft(very)f
FA(easy)h(to)f(write)g(slo)n(w)h(ones.)53 b(The)28 b(initial)g(v)o
(ersion)f(of)h(a)g(Lisp)555 1428 y(program)20 b(can)j(be)f(lik)o(e)h(a)
g(diamond:)32 b(small,)24 b(clear)m(,)e(and)g(v)o(ery)g(e)o(xpensi)n(v)
o(e.)34 b(There)22 b(may)g(be)555 1533 y(a)f(great)e(temptation)g(to)i
(lea)n(v)o(e)f(it)h(that)f(w)o(ay)-5 b(.)680 1638 y(In)33
b(other)f(languages,)j(once)d(you)h(succeed)f(in)i(the)f(arduous)f
(task)h(of)g(getting)g(your)555 1742 y(program)g(to)j(w)o(ork,)i(it)e
(may)f(already)g(be)g(acceptably)f(ef)n(\002cient.)74
b(If)36 b(you)e(tile)i(a)g(\003oor)555 1847 y(with)27
b(tiles)h(the)e(size)i(of)e(your)g(thumbnail,)g(you)g(don')o(t)f(w)o
(aste)i(man)o(y)-5 b(.)48 b(Someone)25 b(used)h(to)555
1951 y(de)n(v)o(eloping)e(softw)o(are)i(on)h(this)g(principle)e(may)i
(\002nd)f(it)i(dif)n(\002cult)e(to)h(o)o(v)o(ercome)d(the)j(idea)555
2056 y(that)22 b(when)f(a)i(program)d(w)o(orks,)i(it')-5
b(s)23 b(\002nished.)34 b(\223In)21 b(Lisp)i(you)e(can)h(write)g
(programs)e(in)i(no)555 2161 y(time)k(at)g(all,)-6 b(\224)27
b(he)e(may)g(think,)h(\223b)n(ut)f(bo)o(y)-5 b(,)25 b(are)h(the)o(y)e
(slo)n(w)-5 b(.)f(\224)45 b(In)25 b(f)o(act,)i(neither)e(is)h(the)f
(case.)555 2265 y(Y)-9 b(ou)22 b(can)g(get)g(f)o(ast)h(programs,)d(b)n
(ut)i(you)g(ha)n(v)o(e)f(to)i(w)o(ork)e(for)h(them.)34
b(In)22 b(this)h(respect,)f(using)555 2370 y(Lisp)c(is)h(lik)o(e)f(li)n
(ving)f(in)h(a)g(rich)f(country)f(instead)i(of)f(a)h(poor)f(one:)28
b(it)18 b(may)f(seem)h(unfortunate)555 2474 y(that)28
b(one)f(has)i(to)f(w)o(ork)f(to)h(stay)g(thin,)i(b)n(ut)e(surely)f
(this)i(is)g(better)e(than)h(w)o(orking)e(to)i(stay)555
2579 y(ali)n(v)o(e,)20 b(and)f(being)g(thin)h(as)h(a)g(matter)f(of)g
(course.)680 2684 y(In)k(less)h(abstract)f(languages,)g(you)f(w)o(ork)h
(for)g(functionality)-5 b(.)39 b(In)24 b(Lisp)g(you)g(w)o(ork)f(for)555
2788 y(speed.)37 b(F)o(ortunately)-5 b(,)21 b(w)o(orking)g(for)i(speed)
f(is)i(easier:)35 b(most)23 b(programs)e(only)h(ha)n(v)o(e)g(a)i(fe)n
(w)555 2893 y(critical)c(sections)h(in)f(which)g(speed)f(matters.)p
eop
%%Page: 286 299
286 298 bop 555 1610 a Fn(22)p 555 1872 2686 3 v 555
2131 a Fx(Nondeterminism)555 2568 y FA(Programming)16
b(languages)g(sa)n(v)o(e)j(us)g(from)e(being)g(sw)o(amped)h(by)g(a)h
(mass)f(of)h(detail.)28 b(Lisp)19 b(is)555 2672 y(a)i(good)e(language)g
(because)g(it)i(handles)f(so)h(man)o(y)e(details)i(itself,)f(enabling)f
(programmers)555 2777 y(to)f(mak)o(e)f(the)h(most)g(of)g(their)g
(limited)f(tolerance)g(for)g(comple)o(xity)-5 b(.)26
b(This)18 b(chapter)f(describes)555 2882 y(ho)n(w)k(macros)h(can)f(mak)
o(e)h(Lisp)g(handle)f(another)f(important)h(class)h(of)g(details:)33
b(the)22 b(details)555 2986 y(of)e(transforming)e(a)i(nondeterministic)
e(algorithm)h(into)h(a)g(deterministic)f(one.)680 3091
y(This)d(chapter)f(is)i(di)n(vided)e(into)h(\002v)o(e)g(parts.)28
b(The)16 b(\002rst)h(e)o(xplains)e(what)h(nondeterminism)555
3195 y(is.)27 b(The)13 b(second)g(describes)g(a)g(Scheme)g(implemen)o
(tation)f(of)g(no)o(nd)o(eterm)o(inistic)h Ft(c)o(h)o(oo)o(se)g
FA(an)o(d)555 3300 y Ft(fail)23 b FA(which)f(uses)i(continuations.)35
b(The)22 b(third)h(part)f(presents)h(Common)e(Lisp)i(v)o(ersions)f(of)
555 3405 y Ft(c)o(hoose)c FA(and)h Ft(fail)g FA(which)g(b)n(uild)g
(upon)f(the)h(continuation\255passing)d(macros)j(of)g(Chapter)f(20.)555
3509 y(The)32 b(fourth)f(part)i(sho)n(ws)f(ho)n(w)g(the)h(cut)g
(operator)d(can)j(be)f(understood)f(independently)555
3614 y(of)d(Prolog.)52 b(The)28 b(\002nal)g(part)g(suggests)g
(re\002nements)f(of)h(the)g(original)f(nondeterministic)555
3718 y(operators.)680 3823 y(The)21 b(nondeterministic)f(choice)i
(operators)e(de\002ned)h(in)i(this)f(chapter)f(will)i(be)g(used)e(to)
555 3928 y(write)f(an)g Fr(A)-7 b(TN)20 b FA(compiler)f(in)i(Chapter)e
(23)h(and)g(an)g(embedded)e(Prolog)h(in)h(Chapter)g(24.)555
4180 y Fw(22.1)99 b(The)26 b(Concept)555 4371 y FA(A)20
b(nondeterministic)c(algorithm)i(is)i(one)f(which)f(relies)i(on)e(a)i
(certain)f(sort)g(of)g(supernatural)555 4476 y(foresight.)25
b(Why)13 b(talk)g(about)g(such)g(algo)o(rithm)o(s)g(whe)o(n)f(we)h(d)o
(on)o(')n(t)g(ha)m(v)o(e)f(access)h(to)f(com)o(pu)o(ters)555
4580 y(with)i(supernatural)d(po)n(wers?)27 b(Because)14
b(a)g(nondeterministic)d(algorithm)h(can)i(be)f Ft(simulated)555
4685 y FA(by)35 b(a)i(deterministic)e(one.)75 b(F)o(or)35
b(purely)g(functional)f(programs\227that)f(is,)41 b(those)35
b(with)555 4789 y(no)29 b(side\255ef)n(fects\227simulating)f
(nondeterminism)e(is)31 b(particularly)d(straightforw)o(ard.)55
b(In)555 4894 y(purely)19 b(functional)h(programs,)e(nondeterminism)g
(can)j(be)g(implemented)e(by)h(search)g(with)555 4999
y(backtracking.)1835 5229 y(286)p eop
%%Page: 287 300
287 299 bop 555 538 a Ft(22.1)1012 b Fu(THE)17 b(CONCEPT)994
b FA(287)680 801 y(This)21 b(chapter)g(sho)n(ws)h(ho)n(w)f(to)h
(simulate)g(nondeterminism)d(in)j(functional)e(programs.)555
905 y(If)26 b(we)h(ha)n(v)o(e)e(a)i(simulator)e(for)h(nondeterminism,)e
(we)j(can)f(e)o(xpect)f(it)i(to)f(produce)e(results)555
1010 y(whene)n(v)o(er)31 b(a)j(truly)f(nondeterministic)e(machine)i(w)o
(ould.)68 b(In)34 b(man)o(y)e(cases,)37 b(writing)c(a)555
1114 y(program)19 b(which)i(depends)g(on)g(supernatural)e(insight)i(to)
h(solv)o(e)f(a)h(problem)e(is)i(easier)g(than)555 1219
y(writing)e(one)f(which)h(doesn')o(t,)e(so)j(such)f(a)g(simulator)g(w)o
(ould)f(be)h(a)h(good)e(thing)g(to)i(ha)n(v)o(e.)680
1324 y(In)f(this)i(section)f(we)g(will)h(de\002ne)e(the)h(class)h(of)f
(po)n(wers)f(that)h(nondeterminism)d(allo)n(ws)555 1428
y(us;)37 b(the)31 b(ne)o(xt)f(section)h(demonstrates)e(their)i(utility)
g(in)g(some)g(sample)f(programs.)60 b(The)555 1533 y(e)o(xamples)28
b(in)h(these)f(\002rst)i(tw)o(o)f(sections)g(are)g(written)f(in)h
(Scheme.)54 b(\(Some)28 b(dif)n(ferences)555 1638 y(between)19
b(Scheme)h(and)g(Common)e(Lisp)j(are)f(summarized)f(on)g(page)h(259.\))
680 1742 y(A)i(nondeterministic)e(algorithm)h(dif)n(fers)h(from)f(a)i
(deterministic)e(one)h(because)g(it)h(can)555 1847 y(use)e(the)f(tw)o
(o)g(special)h(operators)e Ft(c)o(hoose)g FA(and)h Ft(fail.)29
b(Choose)20 b FA(is)h(a)g(function)e(which)h(tak)o(es)g(a)555
1951 y(\002nite)i(set)g(and)f(returns)f(one)h(element.)33
b(T)-7 b(o)21 b(e)o(xplain)f(ho)n(w)h Ft(c)o(hoose)g
FA(chooses,)g(we)g(must)h(\002rst)555 2056 y(introduce)c(the)j(concept)
d(of)i(a)h(computational)d Ft(futur)m(e)o(.)680 2161
y FA(Here)27 b(we)h(will)g(represent)e Ft(c)o(hoose)h
FA(as)h(a)g(function)d Fs(choose)h FA(which)h(tak)o(es)h(a)g(list)g
(and)555 2265 y(returns)23 b(one)g(element.)40 b(F)o(or)23
b(each)h(element,)g(there)f(is)i(a)f(set)h(of)e(futures)g(the)h
(computation)555 2370 y(could)19 b(ha)n(v)o(e)h(if)g(that)h(element)e
(were)h(chosen.)29 b(In)19 b(the)i(follo)n(wing)d(e)o(xpression)555
2552 y Fs(\(let)42 b(\(\(x)g(\(choose)f('\(1)h(2)h(3\)\)\)\))642
2652 y(\(if)g(\(odd?)e(x\))817 2752 y(\(+)h(x)h(1\))817
2851 y(x\)\))555 3039 y FA(there)24 b(are)f(three)h(possible)g(futures)
f(for)g(the)h(computation)e(when)h(it)i(reaches)f(the)g(point)f(of)555
3144 y(the)d Fs(choose)p FA(:)659 3331 y(1.)41 b(If)18
b Fs(choose)e FA(returns)i Fs(1)p FA(,)h(the)f(computation)e(will)j(go)
g(through)d(the)i(then\255clause)f(of)i(the)763 3436
y Fs(if)p FA(,)g(and)h(will)h(return)e Fs(2)p FA(.)659
3607 y(2.)41 b(If)19 b Fs(choose)f FA(returns)g Fs(2)p
FA(,)i(the)g(computation)d(will)j(go)g(through)d(the)j(else\255clause)f
(of)h(the)763 3711 y Fs(if)p FA(,)f(and)h(will)h(return)e
Fs(2)p FA(.)659 3882 y(3.)41 b(If)18 b Fs(choose)e FA(returns)i
Fs(3)p FA(,)h(the)f(computation)e(will)j(go)g(through)d(the)i
(then\255clause)f(of)i(the)763 3987 y Fs(if)p FA(,)g(and)h(will)h
(return)e Fs(4)p FA(.)555 4175 y(In)i(this)i(case,)f(we)g(kno)n(w)f(e)o
(xactly)f(what)i(the)g(future)e(of)i(the)f(computation)f(will)i(be)g
(as)g(soon)555 4279 y(as)17 b(we)f(see)h(what)f Fs(choose)f
FA(returns.)27 b(In)16 b(the)g(general)f(case,)i(each)f(choice)f(is)i
(associated)f(with)555 4384 y(a)27 b Ft(set)f FA(of)g(possible)g
(futures,)h(because)e(within)h(some)g(futures)f(there)h(could)f(be)h
(additional)555 4488 y Fs(choose)p FA(s.)i(F)o(or)19
b(e)o(xample,)g(with)555 4671 y Fs(\(let)42 b(\(\(x)g(\(choose)f('\(2)h
(3\)\)\)\))642 4771 y(\(if)h(\(odd?)e(x\))817 4870 y(\(choose)f('\(a)j
(b\)\))817 4970 y(x\)\))p eop
%%Page: 288 301
288 300 bop 555 538 a FA(288)944 b Fu(NONDETERMINISM)555
801 y FA(there)20 b(are)g(tw)o(o)g(sets)i(of)e(futures)f(at)i(the)f
(time)g(of)g(the)g(\002rst)h Fs(choose)p FA(:)659 977
y(1.)41 b(If)19 b Fs(choose)f FA(returns)g Fs(2)p FA(,)i(the)g
(computation)d(will)j(go)g(through)d(the)j(else\255clause)f(of)h(the)
763 1082 y Fs(if)p FA(,)f(and)h(will)h(return)e Fs(2)p
FA(.)659 1248 y(2.)41 b(If)29 b Fs(choose)e FA(returns)h
Fs(3)p FA(,)k(the)d(computation)e(will)j(go)f(through)e(the)i
(then\255clause)f(of)763 1353 y(the)c Fs(if)p FA(.)41
b(At)25 b(this)g(point,)g(the)f(path)g(of)g(the)h(computation)d(splits)
j(into)f(tw)o(o)h(possible)763 1457 y(futures,)19 b(one)g(in)i(which)e
Fs(a)i FA(is)g(returned,)d(and)i(one)f(in)i(which)e Fs(b)i
FA(is.)555 1634 y(The)26 b(\002rst)h(set)g(has)g(one)f(future)f(and)h
(the)g(second)g(set)h(has)f(tw)o(o,)i(so)f(the)f(computation)e(has)555
1738 y(three)c(possible)g(futures.)680 1843 y(The)j(point)f(to)i
(remember)d(is,)k(if)f Ft(c)o(hoose)e FA(is)i(gi)n(v)o(en)f(a)g(choice)
g(of)g(se)n(v)o(eral)g(alternati)n(v)o(es,)555 1948 y(each)d(one)f(is)i
(associated)f(with)h(a)f(set)h(of)f(possible)g(futures.)28
b(Which)20 b(choice)f(will)i(it)g(return?)555 2052 y(W)-7
b(e)21 b(can)f(assume)h(that)f Ft(c)o(hoose)f FA(w)o(orks)h(as)h(follo)
n(ws:)659 2229 y(1.)41 b(It)19 b(will)i(only)d(return)h(a)g(choice)g
(for)g(which)g(some)g(future)g(does)g(not)g(contain)g(a)g(call)h(to)763
2333 y Ft(fail)p FA(.)659 2500 y(2.)41 b(A)20 b Ft(c)o(hoose)f
FA(o)o(v)o(er)g(zero)h(alternati)n(v)o(es)f(is)i(equi)n(v)n(alent)e(to)
h(a)g Ft(fail)p FA(.)555 2676 y(So,)g(for)g(e)o(xample,)e(in)555
2848 y Fs(\(let)42 b(\(\(x)g(\(choose)f('\(1)h(2\)\)\)\))642
2947 y(\(if)h(\(odd?)e(x\))817 3047 y(\(fail\))817 3146
y(x\)\))555 3323 y FA(each)21 b(of)g(the)g(possible)h(choices)e(has)i
(e)o(xactly)f(one)f(future.)32 b(Since)21 b(the)h(future)e(for)h(a)g
(choice)555 3427 y(of)g Fs(1)h FA(contains)f(a)h(call)h(to)e
Fs(fail)p FA(,)g(only)g Fs(2)h FA(can)f(be)h(chosen.)33
b(So)22 b(the)f(e)o(xpression)g(as)h(a)g(whole)555 3532
y(is)f(deterministic:)29 b(it)21 b(al)o(w)o(ays)f(returns)g
Fs(2)p FA(.)680 3637 y(Ho)n(we)n(v)o(er)m(,)e(the)i(follo)n(wing)e(e)o
(xpression)h(is)i(not)f(deterministic:)555 3808 y Fs(\(let)42
b(\(\(x)g(\(choose)f('\(1)h(2\)\)\)\))642 3908 y(\(if)h(\(odd?)e(x\))
817 4007 y(\(let)g(\(\(y)i(\(choose)d('\(a)j(b\)\)\)\))904
4107 y(\(if)f(\(eq?)g(y)h('a\))1078 4207 y(\(fail\))1078
4306 y(y\)\))817 4406 y(x\)\))555 4582 y FA(At)20 b(the)f(\002rst)h
Fs(choose)p FA(,)e(there)g(are)i(tw)o(o)f(possible)g(futures)g(for)f(a)
i(choice)f(of)g Fs(1)p FA(,)g(and)g(one)f(for)h(a)555
4687 y(choice)g(of)g Fs(2)p FA(.)29 b(W)m(ithin)19 b(the)h(former)m(,)d
(though,)h(the)h(future)f(is)j(really)e(deterministic,)f(because)555
4791 y(a)23 b(choice)f(of)h Fs(a)f FA(w)o(ould)g(result)h(in)g(a)g
(call)g(to)g Fs(fail)p FA(.)36 b(So)23 b(the)g(e)o(xpression)e(as)i(a)g
(whole)g(could)555 4896 y(return)c(either)h Fs(b)g FA(or)g
Fs(2)p FA(.)680 5001 y(Finally)-5 b(,)19 b(there)h(is)h(only)e(one)h
(possible)g(v)n(alue)f(for)h(the)g(e)o(xpression)p eop
%%Page: 289 302
289 301 bop 555 538 a Ft(22.2)1012 b Fu(THE)17 b(CONCEPT)994
b FA(289)555 801 y Fs(\(let)42 b(\(\(x)g(\(choose)f('\(1)h(2\)\)\)\))
642 900 y(\(if)h(\(odd?)e(x\))817 1000 y(\(choose)f('\(\)\))817
1100 y(x\)\))555 1287 y FA(because)24 b(if)g Fs(1)g FA(is)h(chosen,)g
(the)f(future)f(goes)h(through)e(a)i Fs(choose)f FA(with)h(no)g
(choices.)40 b(This)555 1392 y(e)o(xample)19 b(is)i(thus)f(equi)n(v)n
(alent)f(to)h(the)g(last)h(b)n(ut)f(one.)680 1496 y(It)29
b(may)f(not)h(be)g(clear)f(yet)h(from)f(the)h(preceding)e(e)o(xamples,)
j(b)n(ut)f(we)g(ha)n(v)o(e)f(just)i(got)555 1601 y(ourselv)o(es)19
b(an)h(abstraction)f(of)h(astounding)e(po)n(wer)-5 b(.)29
b(In)20 b(nondeterministic)d(algorithms)i(we)555 1706
y(are)d(allo)n(wed)f(to)i(say)f(\223choose)f(an)h(element)f(such)h
(that)g(nothing)f(we)h(do)g(later)g(will)h(result)f(in)g(a)555
1810 y(call)h(to)g Ft(fail)p FA(.)-6 b(\224)29 b(F)o(or)16
b(e)o(xample,)g(this)i(is)f(a)h(perfectly)d(le)o(gitimate)i
(nondeterministic)d(algorithm)555 1915 y(for)20 b(disco)o(v)o(ering)d
(whether)i(you)h(ha)n(v)o(e)f(a)i(kno)n(wn)e(ancestor)g(called)h(Igor:)
555 2127 y(Function)f(Ig\(n\))643 2232 y(if)h(name\(n\))f(=)h(`Igor')
714 2337 y(then)g(return)f(n)643 2441 y(else)i(if)f(parents\(n\))714
2546 y(then)g(return)f(Ig\()p Ft(c)o(hoose)p FA(\(parents\(n\)\)\))643
2650 y(else)i Ft(fail)680 2863 y FA(The)29 b Ft(fail)i
FA(operator)d(is)j(used)e(to)i(in\003uence)e(the)h(v)n(alue)f(returned)
f(by)i Ft(c)o(hoose)p FA(.)57 b(If)30 b(we)555 2968 y(e)n(v)o(er)17
b(encounter)e(a)j Ft(fail)p FA(,)g Ft(c)o(hoose)e FA(w)o(ould)h(ha)n(v)
o(e)g(chosen)f(incorrectly)-5 b(.)26 b(By)18 b(de\002nition)f
Ft(c)o(hoose)555 3072 y FA(guesses)30 b(correctly)-5
b(.)54 b(So)30 b(if)g(we)f(w)o(ant)h(to)f(guarantee)f(that)h(the)h
(computation)d(will)j(ne)n(v)o(er)555 3177 y(pursue)23
b(a)h(certain)f(path,)h(all)g(we)g(need)f(do)g(is)i(put)e(a)h
Ft(fail)g FA(some)n(where)e(in)i(it,)h(and)e(that)h(path)555
3281 y(will)33 b(ne)n(v)o(er)f(be)g(follo)n(wed.)65 b(Thus,)36
b(as)d(it)g(w)o(orks)g(recursi)n(v)o(ely)d(through)h(generations)g(of)
555 3386 y(ancestors,)23 b(the)g(function)e(Ig)i(is)h(able)f(to)g
(choose)f(at)h(each)g(step)g(a)g(path)g(which)f(leads)i(to)f(an)555
3491 y(Igor)n(\227to)c(guess)h(whether)f(to)i(follo)n(w)e(the)h
(mother')-5 b(s)20 b(or)g(f)o(ather')-5 b(s)20 b(line.)680
3595 y(It)i(is)h(as)h(if)e(a)h(program)d(can)i(specify)g(that)h
Ft(c)o(hoose)e FA(pick)h(some)g(element)g(from)f(a)i(set)g(of)555
3700 y(alternati)n(v)o(es,)28 b(use)g(the)g(v)n(alue)f(returned)f(by)i
Ft(c)o(hoose)e FA(for)h(as)i(long)e(as)h(it)h(w)o(ants,)h(and)d(then)
555 3804 y(retroacti)n(v)o(ely)19 b(decide,)h(by)g(using)g
Ft(fail)h FA(as)h(a)f(v)o(eto,)f(what)h(it)h(w)o(ants)f
Ft(c)o(hoose)f FA(to)h(ha)n(v)o(e)f(pick)o(ed.)555 3909
y(And,)h(presto,)g(it)h(turns)f(out)g(that)g(that')-5
b(s)22 b(just)g(what)f Ft(c)o(hoose)f FA(did)h(return.)31
b(Hence)21 b(the)g(model)555 4014 y(in)f(which)g Ft(c)o(hoose)f
FA(has)h(foresight.)680 4118 y(In)27 b(reality)f Ft(c)o(hoose)h
FA(cannot)f(ha)n(v)o(e)g(supernatural)g(po)n(wers.)49
b(An)o(y)27 b(implementation)e(of)555 4223 y Ft(c)o(hoose)13
b FA(must)g(simulate)g(correct)g(guessing)g(by)g(back)o(track)o(ing)f
(when)h(it)g(disco)n(v)n(ers)g(mistak)o(es,)555 4327
y(lik)o(e)24 b(a)h(rat)f(\002nding)f(its)i(w)o(ay)g(through)d(a)i
(maze.)41 b(But)25 b(all)f(this)h(backtracking)d(can)i(be)g(done)555
4432 y(beneath)15 b(the)h(surf)o(ace.)27 b(Once)16 b(you)g(ha)n(v)o(e)f
(some)h(form)g(of)g Ft(c)o(hoose)f FA(and)g Ft(fail)p
FA(,)i(you)f(get)g(to)g(write)555 4537 y(algorithms)j(lik)o(e)i(the)f
(one)g(abo)o(v)o(e,)e(as)j(if)g(it)g(really)f(were)g(possible)g(to)h
(guess)f(what)g(ancestor)555 4641 y(to)28 b(follo)n(w)-5
b(.)51 b(By)28 b(using)g Ft(c)o(hoose)e FA(it)j(is)g(possible)e(to)h
(write)g(an)g(algorithm)e(to)i(search)g(some)555 4746
y(problem)18 b(space)j(just)f(by)g(writing)g(an)g(algorithm)e(to)j(tra)
n(v)o(erse)e(it.)p eop
%%Page: 290 303
290 302 bop 555 538 a FA(290)944 b Fu(NONDETERMINISM)p
555 745 2678 4 v 553 2167 4 1422 v 605 888 a Fs(\(define)41
b(\(descent)f(n1)j(n2\))692 988 y(\(if)f(\(eq?)g(n1)h(n2\))866
1087 y(\(list)f(n2\))866 1187 y(\(let)g(\(\(p)h(\(try-paths)c(\(kids)j
(n1\))g(n2\)\)\))954 1287 y(\(if)g(p)h(\(cons)f(n1)g(p\))h(#f\)\)\)\))
605 1486 y(\(define)e(\(try-paths)e(ns)k(n2\))692 1586
y(\(if)f(\(null?)f(ns\))866 1685 y(#f)866 1785 y(\(or)i(\(descent)d
(\(car)i(ns\))g(n2\))1041 1884 y(\(try-paths)d(\(cdr)j(ns\))g
(n2\)\)\)\))1250 2089 y FA(Figure)20 b(22.1:)28 b(Deterministic)20
b(tree)g(search.)p 3231 2167 V 555 2170 2678 4 v 555
2297 V 553 3021 4 725 v 605 2440 a Fs(\(define)41 b(\(descent)f(n1)j
(n2\))692 2540 y(\(cond)f(\(\(eq?)f(n1)i(n2\))f(\(list)g(n2\)\))954
2640 y(\(\(null?)e(\(kids)i(n1\)\))g(\(fail\)\))954 2739
y(\(else)f(\(cons)h(n1)g(\(descent)f(\(choose)f(\(kids)i(n1\)\))g
(n2\)\)\)\)\))1188 2943 y FA(Figure)20 b(22.2:)28 b(Nondeterministic)18
b(tree)i(search.)p 3231 3021 V 555 3025 2678 4 v 555
3249 a Fw(22.2)99 b(Sear)n(ch)555 3440 y FA(Man)o(y)19
b(classic)i(problems)d(can)i(be)f(formulated)f(as)j(search)e(problems,)
f(and)h(for)h(such)f(prob\255)555 3544 y(lems)24 b(nondeterminism)c
(often)j(turns)g(out)g(to)g(be)h(a)f(useful)g(abstraction.)38
b(Suppose)22 b Fs(nodes)555 3649 y FA(is)28 b(bound)d(to)i(a)g(list)h
(of)f(nodes)f(in)h(a)g(tree,)h(and)f Fs(\(kids)41 b Ft(n)p
Fs(\))27 b FA(is)h(a)f(function)e(which)h(returns)555
3753 y(the)e(descendants)f(of)h(node)f Ft(n)p FA(,)i(or)f
Fs(#f)g FA(if)h(there)f(are)g(none.)40 b(W)-7 b(e)25
b(w)o(ant)g(to)f(write)h(a)f(function)555 3858 y Fs(\(descent)40
b Ft(n)989 3870 y Fm(1)1066 3858 y Ft(n)1108 3870 y Fm(2)1140
3858 y Fs(\))24 b FA(which)f(returns)f(a)i(list)g(of)f(nodes)g(on)g
(some)g(path)g(from)f Ft(n)2886 3870 y Fm(1)2943 3858
y FA(to)i(its)g(de\255)555 3963 y(scendant)k Ft(n)917
3975 y Fm(2)950 3963 y FA(,)k(if)d(there)g(is)h(one.)56
b(Figure)28 b(22.1)g(sho)n(ws)h(a)h(deterministic)e(v)o(ersion)g(of)h
(this)555 4067 y(function.)680 4172 y(Nondeterminism)13
b(allo)n(ws)i(the)h(programmer)c(to)k(ignore)e(the)h(details)h(of)f
(\002nding)f(a)i(path.)555 4276 y(It')-5 b(s)22 b(possible)f(simply)h
(to)f(tell)i Fs(choose)c FA(to)j(\002nd)f(a)h(node)f
Ft(n)g FA(such)g(that)h(there)f(is)i(a)f(path)f(from)555
4381 y Ft(n)i FA(to)h(our)e(destination.)37 b(Using)23
b(nondeterminism)d(we)k(can)f(write)g(the)g(simpler)g(v)o(ersion)f(of)
555 4486 y Fs(descent)c FA(sho)n(wn)h(in)i(Figure)e(22.2.)680
4590 y(The)g(v)o(ersion)f(sho)n(wn)h(in)h(Figure)g(22.2)e(does)i(not)f
(e)o(xplicitly)g(search)g(for)g(a)h(node)f(on)h(the)555
4695 y(right)i(path.)36 b(It)23 b(is)h(written)e(on)g(the)h(assumption)
e(that)i Fs(choose)e FA(has)i(chosen)e(an)i Fs(n)g FA(with)g(the)555
4799 y(desired)g(properties.)36 b(If)23 b(we)h(are)f(used)g(to)g
(looking)f(at)h(deterministic)g(programs,)e(we)j(may)555
4904 y(not)g(percei)n(v)o(e)f(that)h Fs(choose)f FA(has)h(to)h(w)o(ork)
e(as)i(if)g(it)g(could)e Ft(guess)i FA(what)f Fs(n)g
FA(w)o(ould)g(mak)o(e)g(it)p eop
%%Page: 291 304
291 303 bop 555 538 a Ft(22.2)1097 b Fu(SEARCH)1080 b
FA(291)p 555 745 2678 4 v 553 1968 4 1223 v 605 888 a
Fs(\(define)41 b(\(two-numbers\))692 988 y(\(list)h(\(choose)e('\(0)j
(1)g(2)g(3)g(4)g(5\)\))954 1087 y(\(choose)d('\(0)j(1)g(2)g(3)g(4)g
(5\)\)\)\))605 1287 y(\(define)e(\(parlor-trick)d(sum\))692
1386 y(\(let)k(\(\(nums)f(\(two-numbers\)\)\))779 1486
y(\(if)i(\(=)f(\(apply)f(+)j(nums\))d(sum\))954 1586
y(`\(the)g(sum)h(of)h(,@nums\))954 1685 y(\(fail\)\)\)\))1291
1889 y FA(Figure)19 b(22.3:)28 b(Choice)20 b(in)h(a)f(subroutine.)p
3231 1968 V 555 1971 2678 4 v 555 2195 a(through)e(the)i(computation)e
(which)i(follo)n(ws)g(without)f(f)o(ailing.)680 2300
y(Perhaps)26 b(a)i(more)e(con)m(vincing)e(e)o(xample)i(of)h(the)g(po)n
(wer)f(of)g Ft(c)o(hoose)g FA(is)i(its)h(ability)d(to)555
2404 y(guess)k(what)f(will)i(happen)d(e)n(v)o(en)h(in)h(calling)f
(functions.)56 b(Figure)29 b(22.3)g(contains)g(a)h(pair)555
2509 y(of)d(functions)e(to)i(guess)g(tw)o(o)h(numbers)d(which)i(sum)f
(to)i(a)f(number)e(gi)n(v)o(en)h(by)g(the)h(caller)-5
b(.)555 2613 y(The)18 b(\002rst)i(function,)d Fs(two-numbers)p
FA(,)d(nondeterministically)i(chooses)i(tw)o(o)h(numbers)e(and)555
2718 y(returns)j(them)h(in)g(a)h(list.)33 b(When)21 b(we)h(call)g
Fs(parlor-trick)p FA(,)16 b(it)22 b(calls)g Fs(two-numbers)c
FA(for)i(a)555 2823 y(list)k(of)e(tw)o(o)h(inte)o(gers.)37
b(Note)22 b(that,)i(in)e(making)g(its)i(choice,)e Fs(two-numbers)d
FA(doesn')o(t)i(ha)n(v)o(e)555 2927 y(access)g(to)f(the)g(number)f
(entered)g(by)h(the)g(user)-5 b(.)680 3032 y(If)15 b(the)h(tw)o(o)f
(numbers)f(guessed)h(by)h Fs(choose)d FA(don')o(t)h(sum)i(to)g(the)f
(number)f(entered)g(by)i(the)555 3136 y(user)m(,)g(the)g(computation)d
(f)o(ails.)29 b(W)-7 b(e)17 b(can)e(rely)h(on)f Fs(choose)f
FA(ha)n(ving)h(a)n(v)n(oided)g(computational)555 3241
y(paths)27 b(which)g(f)o(ail,)i(if)f(there)e(are)i(an)o(y)e(which)h
(don')o(t.)49 b(Thus)27 b(we)g(can)g(assume)h(that)f(if)h(the)555
3346 y(caller)16 b(gi)n(v)o(es)g(a)g(number)e(in)j(the)f(right)f
(range,)h Fs(choose)e FA(will)j(ha)n(v)o(e)e(guessed)h(right,)g(as)h
(indeed)555 3450 y(it)k(does:)798 3420 y Fm(1)555 3633
y Fs(>)43 b(\(parlor-trick)38 b(7\))555 3733 y(\(THE)k(SUM)g(OF)h(2)g
(5\))680 3920 y FA(In)28 b(simple)h(searches,)h(the)f(b)n(uilt\255in)f
(Common)g(Lisp)g(function)g Fs(find-if)e FA(w)o(ould)i(do)555
4025 y(just)e(as)g(well.)46 b(Where)25 b(is)h(the)g(adv)n(antage)d(of)j
(nondeterministic)d(choice?)44 b(Why)25 b(not)g(just)555
4129 y(iterate)j(through)d(the)j(list)h(of)f(alternati)n(v)o(es)f(in)g
(search)h(of)f(the)h(element)f(with)h(the)g(desired)555
4234 y(properties?)41 b(The)24 b(crucial)g(dif)n(ference)f(between)h
Ft(c)o(hoose)f FA(and)h(con)m(v)o(entional)e(iteration)i(is)555
4339 y(that)j(its)h(e)o(xtent)e(with)h(respect)f(to)h
Ft(fails)h FA(is)g(unbounded.)45 b(Nondeterministic)25
b Ft(c)o(hoose)h FA(can)555 4443 y(see)d(arbitrarily)e(f)o(ar)h(into)g
(the)g(future;)h(if)f(something)f(is)i(going)e(to)i(happen)d(at)j(an)o
(y)f(point)f(in)555 4548 y(the)g(future)g(which)f(w)o(ould)h(ha)n(v)o
(e)g(in)m(v)n(alidated)e(some)j(guess)f Ft(c)o(hoose)f
FA(might)h(mak)o(e,)g(we)h(can)555 4652 y(assume)k(that)h
Ft(c)o(hoose)e FA(kno)n(ws)g(to)i(a)n(v)n(oid)f(guessing)f(it.)48
b(As)27 b(we)g(sa)o(w)g(in)f Fs(parlor-trick)p FA(,)p
555 4724 1074 4 v 645 4779 a Fl(1)675 4803 y Fr(Since)21
b(the)g(order)g(of)f(ar)o(gument)h(e)n(v)n(aluation)k(is)20
b(unspeci\002ed)i(in)e(Scheme)h(\(as)g(opposed)g(to)f(Common)g(Lisp,)
555 4885 y(which)e(speci\002es)g(left\255to\255right\),)j(this)c(call)i
(might)e(also)h(return)g Fk(\(THE)36 b(SUM)h(OF)e(5)h(2\))p
Fr(.)p eop
%%Page: 292 305
292 304 bop 555 538 a FA(292)944 b Fu(NONDETERMINISM)555
801 y FA(the)18 b Ft(fail)g FA(operator)e(w)o(orks)h(e)n(v)o(en)g
(after)g(we)h(return)f(from)f(the)i(function)e(in)i(which)f(the)h
Ft(c)o(hoose)555 905 y FA(occurs.)680 1010 y(This)36
b(kind)f(of)h(f)o(ailure)g(happens)f(in)h(the)h(search)f(done)f(by)h
(Prolog,)j(for)c(e)o(xample.)555 1114 y(Nondeterminism)26
b(is)k(useful)e(in)h(Prolog)f(because)g(one)g(of)h(the)f(central)h
(features)f(of)g(this)555 1219 y(language)c(is)j(its)g(ability)e(to)h
(return)f(answers)h(to)f(a)i(query)d(one)h(at)i(a)f(time.)46
b(By)26 b(follo)n(wing)555 1324 y(this)f(course)f(instead)g(of)h
(returning)d(all)j(the)g(v)n(alid)f(answers)h(at)g(once,)g(Prolog)e
(can)i(handle)555 1428 y(recursi)n(v)o(e)19 b(rules)h(which)g(w)o(ould)
f(otherwise)h(yield)f(in\002nitely)h(lar)o(ge)f(sets)i(of)f(answers.)
680 1533 y(The)c(initial)g(reaction)g(to)g Fs(descent)e
FA(may)i(be)h(lik)o(e)f(the)h(initial)g(reaction)e(to)i(a)f(mer)o(ge)f
(sort:)555 1638 y(where)k(does)g(the)g(w)o(ork)g(get)h(done?)27
b(As)21 b(in)e(a)h(mer)o(ge)e(sort,)h(the)h(w)o(ork)f(gets)g(done)g
(implicitly)-5 b(,)555 1742 y(b)n(ut)16 b(it)h(does)f(get)g(done.)27
b(Section)16 b(22.3)f(describes)h(an)g(implementation)e(of)i
Ft(c)o(hoose)f FA(in)h(which)555 1847 y(all)21 b(the)f(code)f(e)o
(xamples)h(presented)e(so)j(f)o(ar)f(are)g(real)g(running)e(programs.)
680 1951 y(These)d(e)o(xamples)g(sho)n(w)h(the)g(v)n(alue)f(of)g
(nondeterminism)f(as)i(an)g(abstraction.)27 b(The)15
b(best)555 2056 y(programming)e(language)h(abstractions)i(sa)n(v)o(e)g
(not)g(just)h(typing,)e(b)n(ut)i(thought.)26 b(In)16
b(automata)555 2161 y(theory)-5 b(,)26 b(some)g(proofs)g(are)g(dif)n
(\002cult)g(e)n(v)o(en)g(to)g(concei)n(v)o(e)f(of)h(without)g(relying)f
(on)h(nonde\255)555 2265 y(terminism.)43 b(A)25 b(language)e(which)i
(allo)n(ws)g(nondeterminism)d(may)j(gi)n(v)o(e)f(programmers)e(a)555
2370 y(similar)e(adv)n(antage.)555 2623 y Fw(22.3)99
b(Scheme)26 b(Implementation)555 2813 y FA(This)21 b(section)f(e)o
(xplains)f(ho)n(w)h(to)g(use)h(continuations)d(to)j(simulate)f
(nondeterminism.)27 b(Fig\255)555 2918 y(ure)13 b(22.4)g(contains)g
(Scheme)g(implemen)o(tation)o(s)g(of)g Ft(c)n(ho)o(ose)g
FA(an)o(d)g Ft(fail)p FA(.)21 b(Beneath)13 b(the)g(surf)o(ace,)-2788
b Fq(\016)555 3022 y Fs(choose)29 b FA(and)i Fs(fail)g
FA(simulate)g(nondeterminism)d(by)j(backtracking.)60
b(A)32 b(backtracking)555 3127 y(search)20 b(program)e(must)i(someho)n
(w)e(store)i(enough)e(information)g(to)i(pursue)f(other)g(alterna\255)
555 3232 y(ti)n(v)o(es)c(if)f(the)h(chosen)f(one)g(f)o(ails.)27
b(This)15 b(information)d(is)k(stored)e(in)g(the)h(form)e(of)i
(continuations)555 3336 y(on)20 b(the)g(global)f(list)j
Fs(*paths*)p FA(.)680 3441 y(The)15 b(function)f Fs(choose)g
FA(is)i(passed)g(a)g(list)h(of)e(alternati)n(v)o(es)g(in)g
Fs(choices)p FA(.)26 b(If)15 b Fs(choices)f FA(is)555
3545 y(empty)-5 b(,)15 b(then)h Fs(choose)e FA(calls)i
Fs(fail)p FA(,)g(which)f(sends)h(the)g(computation)e(back)h(to)h(the)g
(pre)n(vious)555 3650 y Fs(choose)p FA(.)70 b(If)35 b
Fs(choices)d FA(is)j Fs(\()p Ft(\002r)o(st)44 b Fs(.)f
Ft(r)m(est)p Fs(\))p FA(,)38 b Fs(choose)33 b FA(\002rst)i(pushes)f
(onto)g Fs(*paths*)e FA(a)555 3755 y(continuation)18
b(in)i(which)g Fs(choose)e FA(is)j(called)f(on)g Ft(r)m(est)p
FA(,)h(then)f(returns)f Ft(\002r)o(st)p FA(.)680 3859
y(The)27 b(function)f Fs(fail)h FA(is)i(simpler:)44 b(it)29
b(just)f(pops)g(a)g(continuation)d(of)n(f)j Fs(*paths*)d
FA(and)555 3964 y(calls)32 b(it.)64 b(If)31 b(there)g(aren')o(t)f(an)o
(y)h(sa)n(v)o(ed)g(paths)g(left,)k(then)c Fs(fail)f FA(returns)h(the)g
(symbol)g Fs(@)p FA(.)555 4068 y(Ho)n(we)n(v)o(er)m(,)17
b(it)j(w)o(on')o(t)d(do)i(simply)f(to)h(return)f(it)i(as)f(a)g
(function)f(ordinarily)e(returns)i(v)n(alues,)h(or)555
4173 y(it)f(will)g(be)g(returned)d(as)j(the)g(v)n(alue)e(of)h(the)h
(most)f(recent)g Fs(choose)p FA(.)26 b(What)18 b(we)g(really)f(w)o(ant)
g(to)555 4278 y(do)22 b(is)h(return)e Fs(@)i FA(right)f(to)g(the)h
(tople)n(v)o(el.)34 b(W)-7 b(e)23 b(do)f(this)h(by)f(binding)f
Fs(cc)h FA(to)h(the)f(continuation)555 4382 y(where)k
Fs(fail)f FA(is)j(de\002ned,)f(which)f(presumably)e(is)k(the)e(tople)n
(v)o(el.)47 b(By)27 b(calling)f Fs(cc)p FA(,)i Fs(fail)555
4487 y FA(can)20 b(return)f(straight)h(there.)680 4591
y(The)29 b(implementation)e(in)j(Figure)f(22.4)g(treats)h
Fs(*paths*)d FA(as)j(a)g(stack,)i(al)o(w)o(ays)f(f)o(ail\255)555
4696 y(ing)23 b(back)g(to)h(the)f(most)h(recent)f(choice)g(point.)38
b(This)24 b(strate)o(gy)-5 b(,)23 b(kno)n(wn)f(as)i Ft(c)o(hr)l(onolo)o
(gical)555 4801 y(bac)n(ktr)o(ac)n(king)o(,)d FA(results)h(in)g
(depth\255\002rst)f(search)h(of)f(the)h(problem)f(space.)34
b(The)22 b(w)o(ord)f(\223non\255)555 4905 y(determinism\224)i(is)j
(often)d(used)i(as)g(if)g(it)g(were)g(synon)o(ymous)c(with)k(the)g
(depth\255\002rst)e(imple\255)p eop
%%Page: 293 306
293 305 bop 555 538 a Ft(22.4)823 b Fu(SCHEME)19 b(IMPLEMENT)-6
b(A)f(TION)805 b FA(293)p 555 745 2678 4 v 553 3562 4
2817 v 605 888 a Fs(\(define)41 b(*paths*)f(\(\)\))605
988 y(\(define)h(failsym)f('@\))605 1187 y(\(define)h(\(choose)f
(choices\))692 1287 y(\(if)i(\(null?)f(choices\))866
1386 y(\(fail\))866 1486 y(\(call-with-curren)o(t-)o(con)o(ti)o(nua)o
(ti)o(on)954 1586 y(\(lambda)f(\(cc\))1041 1685 y(\(set!)h(*paths*)1302
1785 y(\(cons)h(\(lambda)e(\(\))1651 1884 y(\(cc)i(\(choose)f(\(cdr)h
(choices\)\)\)\))1564 1984 y(*paths*\)\))954 2084 y(\(car)f
(choices\)\)\)\)\))605 2283 y(\(define)g(fail\))605 2482
y(\(call-with-curre)o(nt)o(-co)o(nt)o(in)o(uat)o(io)o(n)692
2582 y(\(lambda)g(\(cc\))779 2681 y(\(set!)h(fail)1041
2781 y(\(lambda)e(\(\))1128 2881 y(\(if)i(\(null?)f(*paths*\))1302
2980 y(\(cc)i(failsym\))1302 3080 y(\(let)f(\(\(p1)g(\(car)g
(*paths*\)\)\))1389 3180 y(\(set!)g(*paths*)f(\(cdr)h(*paths*\)\))1389
3279 y(\(p1\)\)\)\)\)\)\))957 3483 y FA(Figure)19 b(22.4:)29
b(Scheme)19 b(implementation)f(of)i Ft(c)o(hoose)f FA(and)h
Ft(fail)p FA(.)p 3231 3562 V 555 3565 2678 4 v 555 3789
a(mentation.)29 b(Flo)o(yd')-5 b(s)20 b(classic)i(paper)d(on)h
(nondeterministic)e(algorithms)i(uses)h(the)f(term)g(in)58
b Fq(\016)555 3894 y FA(this)26 b(sense,)h(and)e(this)h(is)g(also)g
(the)g(kind)e(of)h(nondeterminism)e(we)j(\002nd)f(in)h(nondetermin\255)
555 3998 y(istic)d(parsers)g(and)f(in)g(Prolog.)35 b(Ho)n(we)n(v)o(er)m
(,)21 b(it)i(should)f(be)g(noted)g(that)g(the)h(implementation)555
4103 y(gi)n(v)o(en)g(in)h(Figure)f(22.4)g(is)i(not)f(the)g(only)f
(possible)h(implementation,)f(nor)g(e)n(v)o(en)g(a)i(correct)555
4207 y(one.)41 b(In)24 b(principle,)g Ft(c)o(hoose)f
FA(ought)h(to)g(be)g(able)h(to)f(choose)g(an)g(object)g(which)g(meets)g
(an)o(y)555 4312 y(computable)g(speci\002cation.)46 b(But)27
b(a)f(program)e(which)i(used)f(these)i(v)o(ersions)e(of)g
Fs(choose)555 4417 y FA(and)20 b Fs(fail)f FA(to)h(search)g(a)g(graph)f
(might)h(not)g(terminate,)f(if)h(the)g(graph)f(contained)g(c)o(ycles.)
680 4521 y(In)d(practice,)g(nondeterminism)e(usually)i(means)g(using)g
(a)g(depth\255\002rst)g(implementation)555 4626 y(equi)n(v)n(alent)23
b(to)i(the)g(one)f(in)h(Figure)f(22.4,)h(and)f(lea)n(ving)g(it)h(to)g
(the)g(user)g(to)g(a)n(v)n(oid)f(loops)g(in)555 4730
y(the)d(search)f(space.)31 b(Ho)n(we)n(v)o(er)m(,)19
b(for)h(readers)h(who)f(are)h(interested,)f(the)h(last)g(section)g(in)g
(this)555 4835 y(chapter)e(describes)h(ho)n(w)f(to)i(implement)e(true)h
Ft(c)o(hoose)f FA(and)g Ft(fail)p FA(.)p eop
%%Page: 294 307
294 306 bop 555 538 a FA(294)944 b Fu(NONDETERMINISM)555
801 y Fw(22.4)99 b(Common)25 b(Lisp)g(Implementation)555
991 y FA(This)f(section)g(describes)g(ho)n(w)g(to)g(write)h(a)g(form)e
(of)h Ft(c)o(hoose)f FA(and)h Ft(fail)g FA(in)h(Common)e(Lisp.)555
1096 y(As)18 b(the)f(pre)n(vious)f(section)h(sho)n(wed,)g
Fs(call/cc)e FA(mak)o(es)i(it)h(easy)f(to)h(simulate)f(nondetermin\255)
555 1200 y(ism)25 b(in)f(Scheme.)40 b(Continuations)22
b(pro)o(vide)g(the)i(direct)g(embodiment)e(of)h(our)h(theoretical)555
1305 y(concept)30 b(of)i(a)g(computational)d(future.)62
b(In)31 b(Common)g(Lisp,)j(we)e(can)f(use)h(instead)g(the)555
1410 y(continuation\255passing)15 b(macros)i(of)h(Chapter)g(20.)28
b(W)m(ith)19 b(these)f(macros)g(we)h(will)g(be)f(able)g(to)555
1514 y(pro)o(vide)f(a)j(form)e(of)h Ft(c)o(hoose)g FA(slightly)g
(uglier)f(than)h(the)g(Scheme)g(v)o(ersion)f(presented)g(in)i(the)555
1619 y(pre)n(vious)f(section,)g(b)n(ut)i(equi)n(v)n(alent)d(in)i
(practice.)680 1723 y(Figure)15 b(22.5)g(contains)h(a)h(Common)e(Lisp)i
(implementation)d(of)i Ft(fail)p FA(,)h(and)f(tw)o(o)h(v)o(ersions)555
1828 y(of)24 b Ft(c)o(hoose)p FA(.)41 b(The)25 b(syntax)f(of)g(a)h
(Common)e(Lisp)i Fs(choose)d FA(is)k(slightly)e(dif)n(ferent)f(from)h
(the)555 1933 y(Scheme)d(v)o(ersion.)31 b(The)21 b(Scheme)g
Fs(choose)e FA(took)h(one)h(ar)o(gument:)30 b(a)21 b(list)i(of)e
(choices)g(from)555 2037 y(which)k(to)h(select)h(a)f(v)n(alue.)46
b(The)25 b(Common)g(Lisp)h(v)o(ersion)e(has)i(the)g(syntax)f(of)h(a)g
Fs(progn)p FA(.)555 2142 y(It)f(can)g(be)g(follo)n(wed)e(by)i(an)o(y)f
(number)f(of)i(e)o(xpressions,)g(from)f(which)g(it)i(chooses)e(one)g
(to)555 2246 y(e)n(v)n(aluate:)555 2395 y Fs(>)43 b(\(defun)e(do2)i
(\(x\))729 2494 y(\(choose)e(\(+)i(x)g(2\))g(\(*)f(x)i(2\))e(\(expt)g
(x)h(2\)\)\))555 2594 y(DO2)555 2693 y(>)g(\(do2)f(3\))555
2793 y(5)555 2893 y(>)h(\(fail\))555 2992 y(6)555 3145
y FA(At)24 b(the)f(tople)n(v)o(el,)f(we)i(see)g(more)e(clearly)h(the)g
(backtracking)e(which)h(underlies)h(nondeter)n(\255)555
3250 y(ministic)g(search.)35 b(The)22 b(v)n(ariable)f
Fs(*paths*)f FA(is)k(used)e(to)g(store)h(paths)f(which)g(ha)n(v)o(e)f
(not)i(yet)555 3355 y(been)d(follo)n(wed.)28 b(When)20
b(the)h(computation)d(reaches)i(a)g Fs(choose)f FA(e)o(xpression)g
(with)h(se)n(v)o(eral)555 3459 y(alternati)n(v)o(es,)d(the)h(\002rst)h
(alternati)n(v)o(e)e(is)i(e)n(v)n(aluated,)e(and)g(the)h(remaining)e
(choices)i(are)g(stored)555 3564 y(on)26 b Fs(*paths*)p
FA(.)47 b(If)27 b(the)f(program)f(later)i(on)f(encounters)f(a)j
Fs(fail)p FA(,)f(the)f(last)i(stored)e(choice)555 3668
y(will)d(be)g(popped)d(of)n(f)i Fs(*paths*)e FA(and)i(restarted.)36
b(When)22 b(there)g(are)h(no)f(more)f(paths)i(left)f(to)555
3773 y(restart,)e Fs(fail)f FA(returns)g(a)i(special)f(v)n(alue:)555
3921 y Fs(>)43 b(\(fail\))555 4021 y(9)555 4120 y(>)g(\(fail\))555
4220 y(@)555 4373 y FA(In)26 b(Figure)h(22.5)e(the)i(constant)f
Fs(failsym)p FA(,)g(which)g(represents)g(f)o(ailure,)h(is)h(de\002ned)e
(to)h(be)555 4478 y(the)20 b(symbol)g Fs(@)p FA(.)29
b(If)20 b(you)f(w)o(anted)h(to)g(be)h(able)f(to)g(ha)n(v)o(e)g
Fs(@)g FA(as)h(an)f(ordinary)e(return)h(v)n(alue,)g(you)555
4582 y(could)g(mak)o(e)h Fs(failsym)e FA(a)i(gensym)f(instead.)680
4687 y(The)35 b(other)f(nondeterministic)f(choice)i(operator)m(,)i
Fs(choose-bind)p FA(,)d(has)i(a)g(slightly)555 4791 y(dif)n(ferent)18
b(form.)28 b(It)21 b(should)e(be)h(gi)n(v)o(en)e(a)j(symbol,)e(a)h
(list)h(of)f(choices,)f(and)h(a)g(body)f(of)h(code.)555
4896 y(It)f(will)g(do)f(a)g Ft(c)o(hoose)g FA(on)g(the)g(list)i(of)e
(choices,)g(bind)f(the)i(symbol)e(to)h(the)h(v)n(alue)f(chosen,)f(and)
555 5001 y(e)n(v)n(aluate)i(the)h(body)f(of)h(code:)p
eop
%%Page: 295 308
295 307 bop 555 538 a Ft(22.4)736 b Fu(COMMON)19 b(LISP)g(IMPLEMENT)-6
b(A)f(TION)718 b FA(295)p 555 745 2678 4 v 553 3860 4
3116 v 605 888 a Fs(\(defparameter)38 b(*paths*)j(nil\))605
988 y(\(defconstant)d(failsym)j('@\))605 1187 y(\(defmacro)f(choose)h
(\(&rest)g(choices\))692 1287 y(\(if)h(choices)866 1386
y(`\(progn)997 1486 y(,@\(mapcar)e(#'\(lambda)g(\(c\))1607
1586 y(`\(push)h(#'\(lambda)f(\(\))j(,c\))f(*paths*\)\))1433
1685 y(\(reverse)e(\(cdr)i(choices\)\)\))997 1785 y(,\(car)g
(choices\)\))866 1884 y('\(fail\)\)\))605 2084 y(\(defmacro)e
(choose-bind)f(\(var)j(choices)e(&body)i(body\))692 2183
y(`\(cb)g(#'\(lambda)e(\(,var\))h(,@body\))g(,choices\)\))605
2383 y(\(defun)g(cb)i(\(fn)f(choices\))692 2482 y(\(if)g(choices)823
2582 y(\(progn)910 2681 y(\(if)g(\(cdr)g(choices\))1084
2781 y(\(push)g(#'\(lambda)e(\(\))i(\(cb)h(fn)g(\(cdr)e(choices\)\)\))
1346 2881 y(*paths*\)\))910 2980 y(\(funcall)f(fn)j(\(car)f
(choices\)\)\))823 3080 y(\(fail\)\)\))605 3279 y(\(defun)f(fail)h
(\(\))692 3379 y(\(if)g(*paths*)866 3478 y(\(funcall)f(\(pop)h
(*paths*\)\))866 3578 y(failsym\)\))920 3782 y FA(Figure)20
b(22.5:)28 b(Nondeterministic)19 b(operators)f(in)j(Common)d(Lisp.)p
3231 3860 V 555 3864 2678 4 v 555 4069 a Fs(>)43 b(\(choose-bind)c(x)k
('\(marrakesh)c(strasbourg)g(vegas\))729 4169 y(\(format)i(nil)h
("Let's)f(go)i(to)g(~A.")f(x\)\))555 4269 y("Let's)f(go)i(to)g
(MARRAKESH.")555 4368 y(>)g(\(fail\))555 4468 y("Let's)e(go)i(to)g
(STRASBOURG.")555 4632 y FA(It)28 b(is)h(only)e(for)g(con)m(v)o
(enience)e(that)j(the)f(Common)g(Lisp)h(implementation)d(pro)o(vides)h
(tw)o(o)555 4737 y(choice)k(operators.)60 b(Y)-9 b(ou)30
b(could)g(get)h(the)g(ef)n(fect)f(of)g Fs(choose)f FA(from)h
Fs(choose-bind)d FA(by)555 4841 y(al)o(w)o(ays)21 b(translating)555
5001 y Fs(\(choose)41 b(\(foo\))g(\(bar\)\))p eop
%%Page: 296 309
296 308 bop 555 538 a FA(296)944 b Fu(NONDETERMINISM)555
801 y FA(into)555 980 y Fs(\(choose-bind)39 b(x)k('\(1)f(2\))642
1079 y(\(case)g(x)729 1179 y(\(1)h(\(foo\)\))729 1279
y(\(2)g(\(bar\)\)\)\))555 1463 y FA(b)n(ut)20 b(programs)f(are)h
(easier)g(to)g(read)g(if)g(we)h(ha)n(v)o(e)f(a)g(separate)g(operator)e
(for)i(this)h(case.)3034 1432 y Fm(2)680 1567 y FA(The)26
b(Common)f(Lisp)h(choice)g(operators)f(store)h(the)h(bindings)e(of)h
(rele)n(v)n(ant)f(v)n(ariables)555 1672 y(using)f(closures)g(and)g(v)n
(ariable)f(capture.)40 b(As)26 b(macros,)e Fs(choose)e
FA(and)i Fs(choose-bind)d FA(get)555 1776 y(e)o(xpanded)j(within)j(the)
g(le)o(xical)f(en)m(vironment)e(of)i(the)h(containing)e(e)o
(xpressions.)48 b(Notice)555 1881 y(that)16 b(what)h(the)o(y)e(push)h
(onto)f Fs(*paths*)f FA(is)k(a)e(closure)g(o)o(v)o(er)f(the)h(choice)g
(to)g(be)g(sa)n(v)o(ed,)h(locking)555 1986 y(in)25 b(all)g(the)g
(bindings)f(of)g(the)h(le)o(xical)g(v)n(ariables)f(referred)f(to)i
(within)g(it.)44 b(F)o(or)24 b(e)o(xample,)g(in)555 2090
y(the)c(e)o(xpression)555 2269 y Fs(\(let)42 b(\(\(x)g(2\)\))642
2369 y(\(choose)729 2469 y(\(+)h(x)g(1\))729 2568 y(\(+)g(x)g
(100\)\)\))555 2752 y FA(the)24 b(v)n(alue)f(of)g Fs(x)h
FA(will)h(be)e(needed)g(when)g(the)g(sa)n(v)o(ed)h(choices)f(are)h
(restarted.)39 b(This)24 b(is)g(why)555 2857 y Fs(choose)d
FA(is)j(written)f(to)h(wrap)f(its)h(ar)o(guments)d(in)i(lambda\255e)o
(xpressions.)35 b(The)23 b(e)o(xpression)555 2961 y(abo)o(v)o(e)c(gets)
h(macroe)o(xpanded)c(into:)555 3141 y Fs(\(let)42 b(\(\(x)g(2\)\))642
3240 y(\(progn)729 3340 y(\(push)g(#'\(lambda)e(\(\))i(\(+)h(x)g
(100\)\))991 3439 y(*paths*\))729 3539 y(\(+)g(x)g(1\)\)\))555
3723 y FA(The)18 b(object)f(which)h(gets)g(stored)g(on)g
Fs(*paths*)e FA(is)j(a)f(closure)g(containing)e(a)i(pointer)f(to)i
Fs(x)p FA(.)28 b(It)555 3828 y(is)19 b(the)f(need)f(to)i(preserv)o(e)d
(v)n(ariables)i(in)g(closures)f(which)h(dictates)g(the)g(dif)n(ference)
e(between)555 3932 y(the)k(syntax)g(of)g(the)g(Scheme)f(and)h(Common)f
(Lisp)h(choice)g(operators.)680 4037 y(If)28 b(we)g(use)h
Fs(choose)e FA(and)g Fs(fail)h FA(together)f(with)h(the)g
(continuation\255passing)d(macros)555 4141 y(of)j(Chapter)f(20,)j(a)e
(pointer)f(to)h(our)f(continuation)f(v)n(ariable)h Fs(*cont*)f
FA(will)j(get)f(sa)n(v)o(ed)g(as)555 4246 y(well.)42
b(By)24 b(de\002ning)f(functions)g(with)h Fs(=defun)p
FA(,)f(calling)h(them)f(with)i Fs(=bind)p FA(,)e(and)h(ha)n(ving)555
4351 y(them)e(return)f(v)n(alues)h(with)g Fs(=values)p
FA(,)e(we)j(will)g(be)f(able)g(to)g(use)h(nondeterminism)c(in)j(an)o(y)
555 4455 y(Common)d(Lisp)h(program.)680 4560 y(W)m(ith)h(these)g
(macros,)f(we)h(can)g(successfully)f(run)g(the)h(e)o(xample)e(in)i
(which)g(the)f(nonde\255)555 4665 y(terministic)25 b(choice)f(occurs)g
(in)h(a)g(subroutine.)41 b(Figure)24 b(22.6)g(sho)n(ws)h(the)g(Common)e
(Lisp)555 4769 y(v)o(ersion)c(of)h Fs(parlor-trick)p
FA(,)15 b(which)20 b(w)o(orks)g(as)h(it)g(did)f(in)g(Scheme:)p
555 4839 1074 4 v 645 4894 a Fl(2)675 4918 y Fr(If)25
b(desired,)j(the)e(e)o(xported)i(interf)o(ace)g(to)e(this)g(code)g
(could)h(consist)f(of)f(just)h(a)g(single)g(operator)m(,)k(because)555
5001 y Fk(\(fail\))18 b Fr(is)f(equi)n(v)n(alent)k(to)c
Fk(\(choose\))p Fr(.)p eop
%%Page: 297 310
297 309 bop 555 538 a Ft(22.4)736 b Fu(COMMON)19 b(LISP)g(IMPLEMENT)-6
b(A)f(TION)718 b FA(297)p 555 745 2678 4 v 553 2067 4
1322 v 605 888 a Fs(\(=defun)41 b(two-numbers)e(\(\))692
988 y(\(choose-bind)g(n1)j('\(0)h(1)g(2)g(3)g(4)g(5\))779
1087 y(\(choose-bind)c(n2)k('\(0)f(1)h(2)g(3)g(4)h(5\))866
1187 y(\(=values)d(n1)h(n2\)\)\)\))605 1386 y(\(=defun)f(parlor-trick)d
(\(sum\))692 1486 y(\(=bind)j(\(n1)h(n2\))h(\(two-numbers\))779
1586 y(\(if)g(\(=)f(\(+)h(n1)g(n2\))f(sum\))954 1685
y(`\(the)f(sum)h(of)h(,n1)f(,n2\))954 1785 y(\(fail\)\)\)\))1051
1989 y FA(Figure)19 b(22.6:)29 b(Common)18 b(Lisp)j(choice)e(in)i(a)f
(subroutine.)p 3231 2067 V 555 2070 2678 4 v 555 2295
a Fs(>)43 b(\(parlor-trick)38 b(7\))555 2394 y(\(THE)k(SUM)g(OF)h(2)g
(5\))555 2582 y FA(This)20 b(w)o(orks)g(because)g(the)g(e)o(xpression)
555 2765 y Fs(\(=values)40 b(n1)j(n2\))555 2947 y FA(gets)21
b(macroe)o(xpanded)16 b(into)555 3113 y Fs(\(funcall)40
b(*cont*)h(n1)i(n2\))555 3284 y FA(within)23 b(the)g
Fs(choose-bind)p FA(s.)33 b(Each)23 b Fs(choose-bind)c
FA(is)k(in)g(turn)g(macroe)o(xpanded)18 b(into)23 b(a)555
3389 y(closure,)17 b(which)f(k)o(eeps)h(pointers)f(to)i(all)f(the)g(v)n
(ariables)g(referred)e(to)i(in)h(the)f(body)-5 b(,)15
b(including)555 3493 y Fs(*cont*)p FA(.)680 3598 y(The)k(restrictions)h
(on)g(the)g(use)g(of)g Fs(choose)p FA(,)e Fs(choose-bind)p
FA(,)e(and)j Fs(fail)g FA(are)h(the)g(same)555 3703 y(as)33
b(the)f(restrictions)g(gi)n(v)o(en)f(in)h(Figure)g(20.5)f(for)h(code)f
(which)h(uses)h(the)f(continuation\255)555 3807 y(passing)26
b(macros.)47 b(Where)26 b(a)g(choice)g(e)o(xpression)e(occurs,)j(it)g
(must)f(be)h(the)f(last)h(thing)e(to)555 3912 y(be)e(e)n(v)n(aluated.)
37 b(Thus)23 b(if)g(we)h(w)o(ant)f(to)g(mak)o(e)g(sequential)g
(choices,)g(in)g(Common)f(Lisp)i(the)555 4017 y(choices)c(ha)n(v)o(e)f
(to)i(be)f(nested:)555 4199 y Fs(>)43 b(\(choose-bind)c(first-name)g
('\(henry)i(william\))729 4299 y(\(choose-bind)e(last-name)h('\(james)h
(higgins\))817 4398 y(\(=values)f(\(list)h(first-name)f
(last-name\)\)\)\))555 4498 y(\(HENRY)h(JAMES\))555 4598
y(>)i(\(fail\))555 4697 y(\(HENRY)e(HIGGINS\))555 4797
y(>)i(\(fail\))555 4897 y(\(WILLIAM)d(JAMES\))p eop
%%Page: 298 311
298 310 bop 555 538 a FA(298)944 b Fu(NONDETERMINISM)555
801 y FA(which)20 b(will,)g(as)h(usual,)f(result)g(in)h
(depth\255\002rst)e(search.)680 905 y(The)14 b(operators)f(de\002ned)h
(in)h(Chapter)g(20)f(claimed)g(the)h(right)f(to)h(be)g(the)g(last)h(e)o
(xpressions)555 1010 y(e)n(v)n(aluated.)31 b(This)22
b(right)e(is)j(no)n(w)e(preempted)e(by)i(the)g(ne)n(w)g(layer)g(of)g
(macros;)h(an)f Fs(=values)555 1114 y FA(e)o(xpression)i(should)g
(appear)g(within)h(a)h Fs(choose)d FA(e)o(xpression,)i(and)g(not)g
(vice)g(v)o(ersa.)41 b(That)555 1219 y(is,)555 1402 y
Fs(\(choose)g(\(=values)f(1\))j(\(=values)d(2\)\))555
1584 y FA(will)21 b(w)o(ork,)e(b)n(ut)555 1750 y Fs(\(=values)40
b(\(choose)h(1)i(2\)\))1394 b(;)43 b(wrong)555 1921 y
FA(will)31 b(not.)57 b(\(In)30 b(the)f(latter)h(case,)j(the)d(e)o
(xpansion)d(of)j(the)g Fs(choose)e FA(w)o(ould)h(be)h(unable)e(to)555
2026 y(capture)19 b(the)h(instance)g(of)g Fs(*cont*)e
FA(in)j(the)f(e)o(xpansion)e(of)i(the)g Fs(=values)p
FA(.\))680 2131 y(As)k(long)f(as)h(we)g(respect)f(the)h(restrictions)f
(outlined)f(here)h(and)g(in)h(Figure)f(20.5,)g(non\255)555
2235 y(deterministic)f(choice)g(in)h(Common)f(Lisp)h(will)g(no)n(w)g(w)
o(ork)f(as)i(it)f(does)g(in)g(Scheme.)37 b(Fig\255)555
2340 y(ure)23 b(22.7)f(sho)n(ws)i(a)g(Common)e(Lisp)h(v)o(ersion)g(of)g
(the)g(nondeterministic)e(tree)j(search)f(pro\255)555
2444 y(gram)i(gi)n(v)o(en)g(in)i(Figure)e(22.2.)46 b(The)26
b(Common)f(Lisp)h Fs(descent)e FA(is)j(a)g(direct)f(translation,)555
2549 y(though)18 b(it)j(comes)f(out)g(slightly)g(longer)f(and)g(uglier)
-5 b(.)680 2654 y(W)e(e)24 b(no)n(w)f(ha)n(v)o(e)g(Common)f(Lisp)h
(utilities)h(which)f(mak)o(e)g(it)h(possible)f(to)h(do)f(nondeter)n
(\255)555 2758 y(ministic)f(search)g(without)g(e)o(xplicit)g
(backtracking.)33 b(Ha)n(ving)21 b(tak)o(en)h(trouble)f(to)i(write)f
(this)555 2863 y(code,)17 b(we)h(can)g(reap)f(the)h(bene\002ts)f(by)h
(writing)f(in)h(v)o(ery)e(fe)n(w)i(lines)g(programs)e(which)h(w)o(ould)
555 2968 y(otherwise)29 b(be)h(lar)o(ge)f(and)g(messy)-5
b(.)57 b(By)31 b(b)n(uilding)d(another)g(layer)i(of)f(macros)g(on)g
(top)h(of)555 3072 y(those)17 b(presented)e(here,)i(we)g(will)h(be)f
(able)g(to)g(write)g(an)g Fr(A)-7 b(TN)16 b FA(compiler)g(in)h(one)f
(page)h(of)f(code)555 3177 y(\(Chapter)j(23\),)g(and)h(a)h(sk)o(etch)f
(of)g(Prolog)f(in)h(tw)o(o)h(\(Chapter)e(24\).)680 3281
y(Common)30 b(Lisp)i(programs)e(which)i(use)g Fs(choose)e
FA(should)h(be)h(compiled)e(with)i(tail\255)555 3386
y(recursion)19 b(optimization\227not)f(just)j(to)g(mak)o(e)f(them)g(f)o
(aster)m(,)g(b)n(ut)g(to)h(a)n(v)n(oid)f(running)f(out)h(of)555
3491 y(stack)27 b(space.)50 b(Programs)26 b(which)h(\223return\224)f(v)
n(alues)h(by)f(calling)h(continuation)e(functions)555
3595 y(ne)n(v)o(er)d(actually)h(return)f(until)i(the)f(\002nal)h
Fs(fail)p FA(.)38 b(W)m(ithout)23 b(the)g(optimization)f(of)h
(tail\255calls,)555 3700 y(the)d(stack)h(w)o(ould)e(just)i(gro)n(w)e
(and)h(gro)n(w.)-1303 b Fq(\016)555 3953 y Fw(22.5)99
b(Cuts)555 4143 y FA(This)22 b(section)g(sho)n(ws)g(ho)n(w)g(to)g(use)h
(cuts)f(in)g(Scheme)g(programs)e(which)i(do)g(nondetermin\255)555
4248 y(istic)30 b(choice.)54 b(Though)26 b(the)j(w)o(ord)f
Ft(cut)h FA(comes)f(from)g(Prolog,)i(the)e(concept)g(belongs)f(to)555
4352 y(nondeterminism)17 b(generally)-5 b(.)27 b(Y)-9
b(ou)20 b(might)f(w)o(ant)h(to)g(use)g(cuts)g(in)g(an)o(y)f(program)f
(that)i(made)555 4457 y(nondeterministic)e(choices.)680
4562 y(Cuts)g(are)g(easier)h(to)f(understand)e(when)h(considered)g
(independently)e(of)j(Prolog.)27 b(Let')-5 b(s)555 4666
y(imagine)16 b(a)h(real\255life)f(e)o(xample.)27 b(Suppose)16
b(that)h(the)g(manuf)o(acturer)d(of)i(Chocoblob)f(candies)555
4771 y(decides)26 b(to)h(run)e(a)i(promotion.)46 b(A)27
b(small)g(number)d(of)j(box)o(es)e(of)h(Chocoblobs)f(will)i(also)555
4875 y(contain)f(tok)o(ens)h(entitling)f(the)h(recipient)g(to)g(v)n
(aluable)f(prizes.)50 b(T)-7 b(o)27 b(ensure)f(f)o(airness,)j(no)555
4980 y(tw)o(o)20 b(of)g(the)h(winning)d(box)o(es)i(are)g(sent)g(to)h
(the)f(same)g(city)-5 b(.)p eop
%%Page: 299 312
299 311 bop 555 538 a Ft(22.5)1139 b Fu(CUTS)1121 b FA(299)p
555 745 2678 4 v 553 3661 4 2916 v 605 888 a Fs(>)43
b(\(=defun)e(descent)f(\(n1)j(n2\))779 988 y(\(cond)f(\(\(eq)g(n1)g
(n2\))h(\(=values)d(\(list)i(n2\)\)\))1041 1087 y(\(\(kids)f(n1\))h
(\(choose-bind)d(n)k(\(kids)e(n1\))1607 1187 y(\(=bind)g(\(p\))i
(\(descent)d(n)j(n2\))1738 1287 y(\(=values)d(\(cons)i(n1)h
(p\)\)\)\)\))1041 1386 y(\(t)f(\(fail\)\)\)\))605 1486
y(DESCENT)605 1586 y(>)h(\(defun)e(kids)h(\(n\))779 1685
y(\(case)g(n)866 1785 y(\(a)h('\(b)f(c\)\))866 1884 y(\(b)h('\(d)f
(e\)\))866 1984 y(\(c)h('\(d)f(f\)\))866 2084 y(\(f)h('\(g\)\)\)\))605
2183 y(KIDS)605 2283 y(>)g(\(descent)d('a)j('g\))605
2383 y(\(A)g(C)g(F)g(G\))605 2482 y(>)g(\(fail\))605
2582 y(@)605 2681 y(>)g(\(descent)d('a)j('d\))605 2781
y(\(A)g(B)g(D\))605 2881 y(>)g(\(fail\))605 2980 y(\(A)g(C)g(D\))605
3080 y(>)g(\(fail\))605 3180 y(@)605 3279 y(>)g(\(descent)d('a)j('h\))
605 3379 y(@)979 3583 y FA(Figure)20 b(22.7:)28 b(Nondeterministic)18
b(search)i(in)h(Common)d(Lisp)p 3231 3661 V 555 3664
2678 4 v 680 3889 a(After)g(the)h(promotion)d(has)j(be)o(gun,)e(it)j
(emer)o(ges)d(that)i(the)g(tok)o(ens)f(are)g(small)i(enough)c(to)555
3993 y(be)25 b(sw)o(allo)n(wed)f(by)h(children.)42 b(Hounded)22
b(by)j(visions)f(of)h(la)o(wsuits,)h(Chocoblob)d(la)o(wyers)555
4098 y(be)o(gin)15 b(a)i(frantic)e(search)h(for)g(all)g(the)h(special)f
(box)o(es.)27 b(W)m(ithin)16 b(each)g(city)-5 b(,)16
b(there)g(are)g(multiple)555 4202 y(stores)24 b(that)f(sell)i
(Chocoblobs;)e(within)g(each)g(store,)h(there)f(are)h(multiple)f(box)o
(es.)38 b(But)24 b(the)555 4307 y(la)o(wyers)19 b(may)h(not)f(ha)n(v)o
(e)h(to)g(open)f(e)n(v)o(ery)f(box:)29 b(once)19 b(the)o(y)g(\002nd)h
(a)g(coin\255containing)c(box)j(in)555 4412 y(a)g(gi)n(v)o(en)e(city)-5
b(,)18 b(the)o(y)g(do)f(not)h(ha)n(v)o(e)g(to)h(search)f(an)o(y)f(of)h
(the)g(other)g(box)o(es)f(in)i(that)f(city)-5 b(,)18
b(because)555 4516 y(each)i(city)g(has)h(at)f(most)g(one)g(special)g
(box.)29 b(T)-7 b(o)20 b(realize)g(this)h(is)g(to)f(do)g(a)h(cut.)680
4621 y(What')-5 b(s)28 b Ft(cut)g FA(is)h(a)f(portion)e(of)h(the)h
(search)g(tree.)51 b(F)o(or)28 b(Chocoblobs,)f(the)h(search)g(tree)555
4726 y(e)o(xists)15 b(physically:)26 b(the)15 b(root)f(node)g(is)i(at)g
(the)f(compan)o(y')-5 b(s)13 b(head)h(of)n(\002ce;)j(the)e(children)e
(of)i(this)555 4830 y(node)k(are)h(the)g(cities)h(where)e(the)h
(special)h(box)o(es)e(were)g(sent;)i(the)f(children)f(of)g(those)h
(nodes)555 4935 y(are)25 b(the)g(stores)g(in)g(each)g(city;)i(and)e
(the)g(children)e(of)i(each)g(store)g(represent)e(the)i(box)o(es)f(in)p
eop
%%Page: 300 313
300 312 bop 555 538 a FA(300)944 b Fu(NONDETERMINISM)p
555 745 2678 4 v 553 2466 4 1721 v 605 888 a Fs(\(define)41
b(\(find-boxes\))692 988 y(\(set!)h(*paths*)e(\(\)\))692
1087 y(\(let)i(\(\(city)f(\(choose)g('\(la)h(ny)g(bos\)\)\)\))779
1187 y(\(newline\))779 1287 y(\(let*)g(\(\(store)e(\(choose)h('\(1)h
(2\)\)\))1084 1386 y(\(box)g(\(choose)f('\(1)h(2\)\)\)\))866
1486 y(\(let)g(\(\(triple)f(\(list)g(city)h(store)g(box\)\)\))954
1586 y(\(display)e(triple\))954 1685 y(\(if)i(\(coin?)f(triple\))1128
1785 y(\(display)f('c\)\))954 1884 y(\(fail\)\)\)\)\))605
2084 y(\(define)h(\(coin?)g(x\))692 2183 y(\(member)g(x)i('\(\(la)e(1)j
(2\))e(\(ny)h(1)g(1\))g(\(bos)f(2)h(2\)\)\)\))1174 2388
y FA(Figure)19 b(22.8:)28 b(Exhausti)n(v)o(e)19 b(Chocoblob)f(search.)p
3231 2466 V 555 2469 2678 4 v 555 2684 a(that)j(store.)33
b(When)21 b(the)h(la)o(wyers)e(searching)h(this)g(tree)h(\002nd)f(one)g
(of)g(the)g(box)o(es)f(containing)555 2789 y(a)25 b(coin,)g(the)o(y)g
(can)f(prune)g(of)n(f)g(all)h(the)g(une)o(xplored)d(branches)h
(descending)g(from)h(the)g(city)555 2894 y(the)o(y')l(re)18
b(in)j(no)n(w)-5 b(.)680 2998 y(Cuts)21 b(actually)g(tak)o(e)g(tw)o(o)h
(operations:)29 b(you)21 b(can)f(do)h(a)h(cut)f(when)f(you)h(kno)n(w)f
(that)h(part)555 3103 y(of)f(the)h(search)f(tree)g(is)i(useless,)f(b)n
(ut)g(\002rst)g(you)e(ha)n(v)o(e)h(to)h Ft(mark)g FA(the)f(tree)h(at)g
(the)f(point)g(where)555 3207 y(it)25 b(can)g(be)g(cut.)42
b(In)25 b(the)g(Chocoblob)d(e)o(xample,)j(common)d(sense)k(tells)f(us)g
(that)g(the)g(tree)g(is)555 3312 y(mark)o(ed)17 b(as)i(we)f(enter)g
(each)g(city)-5 b(.)28 b(It')-5 b(s)19 b(hard)e(to)h(describe)g(in)g
(abstract)g(terms)g(what)g(a)h(Prolog)555 3417 y(cut)c(does,)h(because)
f(the)g(marks)g(are)g(implicit.)28 b(W)m(ith)15 b(an)h(e)o(xplicit)e
(mark)h(operator)m(,)f(the)h(ef)n(fect)555 3521 y(of)20
b(a)h(cut)f(will)h(be)f(more)f(easily)i(understood.)680
3626 y(Figure)32 b(22.8)g(sho)n(ws)i(a)g(program)d(that)i
(nondeterministically)e(searches)i(a)h(smaller)555 3731
y(v)o(ersion)18 b(of)g(the)h(Chocoblob)e(tree.)29 b(As)20
b(each)e(box)g(is)i(opened,)e(the)h(program)d(displays)j(a)g(list)555
3835 y(of)h Fs(\()p Ft(city)43 b(stor)m(e)h(box)p Fs(\))p
FA(.)28 b(If)20 b(the)g(box)f(contains)h(a)g(coin,)g(a)g
Fs(c)h FA(is)g(printed)e(after)h(it:)555 4007 y Fs(>)43
b(\(find-boxes\))555 4107 y(\(LA)f(1)i(1\)\(LA)d(1)i(2\)C\(LA)e(2)i
(1\)\(LA)f(2)h(2\))555 4206 y(\(NY)f(1)i(1\)C\(NY)d(1)i(2\)\(NY)e(2)i
(1\)\(NY)f(2)h(2\))555 4306 y(\(BOS)f(1)h(1\)\(BOS)e(1)i(2\)\(BOS)e(2)j
(1\)\(BOS)d(2)i(2\)C)555 4405 y(@)680 4582 y FA(T)-7
b(o)26 b(implement)g(the)h(optimized)e(search)h(technique)f(disco)o(v)o
(ered)g(by)h(the)h(Chocoblob)555 4687 y(la)o(wyers,)20
b(we)g(need)g(tw)o(o)h(ne)n(w)f(operators:)28 b Fs(mark)20
b FA(and)f Fs(cut)p FA(.)29 b(Figure)20 b(22.9)f(sho)n(ws)i(one)f(w)o
(ay)555 4791 y(to)h(de\002ne)f(them.)30 b(Whereas)21
b(nondeterminism)d(itself)j(can)g(be)f(understood)f(independently)555
4896 y(of)g(an)o(y)g(particular)f(implementation,)f(pruning)h(the)h
(search)h(tree)f(is)i(an)e(optimization)f(tech\255)555
5001 y(nique,)26 b(and)f(depends)g(v)o(ery)f(much)h(on)h(ho)n(w)f
Fs(choose)f FA(is)j(implemented.)44 b(The)25 b Fs(mark)g
FA(and)p eop
%%Page: 301 314
301 313 bop 555 538 a Ft(22.5)1139 b Fu(CUTS)1121 b FA(301)p
555 745 2678 4 v 553 1968 4 1223 v 605 888 a Fs(\(define)41
b(\(mark\))g(\(set!)g(*paths*)g(\(cons)g(fail)h(*paths*\)\)\))605
1087 y(\(define)f(\(cut\))692 1187 y(\(cond)h(\(\(null?)e(*paths*\)\))
954 1287 y(\(\(equal?)g(\(car)i(*paths*\))e(fail\))997
1386 y(\(set!)i(*paths*)e(\(cdr)i(*paths*\)\)\))954 1486
y(\(else)997 1586 y(\(set!)g(*paths*)e(\(cdr)i(*paths*\)\))997
1685 y(\(cut\)\)\)\))1107 1889 y FA(Figure)20 b(22.9:)28
b(Marking)19 b(and)h(pruning)e(search)h(trees.)p 3231
1968 V 555 1971 2678 4 v 555 2098 V 553 3619 4 1522 v
605 2241 a Fs(\(define)41 b(\(find-boxes\))692 2341 y(\(set!)h(*paths*)
e(\(\)\))692 2440 y(\(let)i(\(\(city)f(\(choose)g('\(la)h(ny)g
(bos\)\)\)\))779 2540 y(\(mark\))2133 b(;)779 2640 y(\(newline\))779
2739 y(\(let*)42 b(\(\(store)e(\(choose)h('\(1)h(2\)\)\))1084
2839 y(\(box)g(\(choose)f('\(1)h(2\)\)\)\))866 2938 y(\(let)g
(\(\(triple)f(\(list)g(city)h(store)g(box\)\)\))954 3038
y(\(display)e(triple\))954 3138 y(\(if)i(\(coin?)f(triple\))1128
3237 y(\(begin)g(\(cut\))g(\(display)g('c\)\)\))869 b(;)954
3337 y(\(fail\)\)\)\)\))1218 3541 y FA(Figure)20 b(22.10:)27
b(Pruned)19 b(Chocoblob)f(search.)p 3231 3619 V 555 3623
2678 4 v 555 3847 a Fs(cut)e FA(de\002ned)f(in)i(Figure)f(22.9)f(are)h
(suitable)h(for)f(use)g(with)h(the)f(depth\255\002rst)g(implementation)
555 3951 y(of)k Fs(choose)e FA(\(Figure)h(22.4\).)680
4056 y(The)14 b(general)g(idea)g(is)g(for)g Fs(mar)o(k)g
FA(to)f(store)g(mar)o(k)o(ers)h(in)f Fs(*p)o(at)o(hs*)o
FA(,)c(the)14 b(list)g(of)g(une)o(xplored)555 4161 y(choice\255points.)
46 b(Calling)26 b Fs(cut)g FA(pops)g Fs(*paths*)e FA(all)j(the)f(w)o
(ay)g(do)n(wn)g(to)g(the)h(most)f(recent)555 4265 y(mark)o(er)-5
b(.)41 b(What)25 b(should)e(we)i(use)f(as)i(a)e(mark)o(er?)41
b(W)-7 b(e)26 b(could)d(use)i(e.g.)e(the)i(symbol)e Fs(m)p
FA(,)j(b)n(ut)555 4370 y(that)21 b(w)o(ould)f(require)g(us)h(to)g(re)n
(write)g Fs(fail)e FA(to)i(ignore)f(the)h Fs(m)p FA(s)g(when)f(it)i
(encountered)c(them.)555 4474 y(F)o(ortunately)-5 b(,)20
b(since)i(functions)f(are)h(data)g(objects)f(too,)h(there)g(is)h(at)f
(least)h(one)f(mark)o(er)e(that)555 4579 y(will)25 b(allo)n(w)e(us)i
(to)f(use)g Fs(fail)e FA(as)j(is:)38 b(the)24 b(function)e
Fs(fail)g FA(itself.)41 b(Then)23 b(if)h Fs(fail)f FA(happens)555
4684 y(on)d(a)g(mark)o(er)m(,)f(it)i(will)g(just)f(call)h(itself.)680
4788 y(Figure)26 b(22.10)f(sho)n(ws)h(ho)n(w)g(these)h(operators)e(w)o
(ould)h(be)h(used)f(to)h(prune)e(the)i(search)555 4893
y(tree)18 b(in)h(the)f(Chocoblob)e(case.)29 b(\(Changed)17
b(lines)i(are)f(indicated)f(by)h(semicolons.\))28 b(W)-7
b(e)19 b(call)555 4997 y Fs(mark)27 b FA(upon)f(choosing)g(a)i(city)-5
b(.)51 b(At)28 b(this)g(point,)h Fs(*paths*)c FA(contains)i(one)g
(continuation,)p eop
%%Page: 302 315
302 314 bop 555 538 a FA(302)944 b Fu(NONDETERMINISM)p
555 745 2678 4 v 553 1835 4 1090 v 646 1641 a @beginspecial
@setspecial @endspecial 1168 1757 a FA(Figure)20 b(22.11:)28
b(A)21 b(directed)e(graph)f(with)j(a)f(loop.)p 3231 1835
V 555 1838 2678 4 v 555 2062 a(representing)e(the)i(search)g(of)g(the)g
(remaining)f(cities.)680 2167 y(If)e(we)i(\002nd)f(a)g(box)f(with)h(a)h
(coin)e(in)h(it,)h(we)g(call)f Fs(cut)p FA(,)g(which)f(sets)i
Fs(*paths*)d FA(back)h(to)i(the)555 2272 y(v)n(alue)f(it)i(had)f(at)g
(the)g(time)h(of)e(the)i Fs(mark)p FA(.)27 b(The)19 b(ef)n(fects)g(of)g
(the)g(cut)g(are)g(not)g(visible)g(until)g(the)555 2376
y(ne)o(xt)f(call)h(to)g Fs(fail)p FA(.)28 b(But)19 b(when)g(it)g
(comes,)g(after)f(the)h Fs(display)p FA(,)e(the)i(ne)o(xt)f
Fs(fail)g FA(sends)h(the)555 2481 y(search)h(all)i(the)e(w)o(ay)h(up)g
(to)g(the)f(topmost)g Fs(choose)p FA(,)f(e)n(v)o(en)h(if)h(there)f(w)o
(ould)g(otherwise)g(ha)n(v)o(e)555 2585 y(been)e(li)n(v)o(e)h
(choice\255points)e(lo)n(wer)h(in)h(the)g(search)f(tree.)29
b(The)19 b(upshot)e(is,)j(as)g(soon)e(as)i(we)f(\002nd)555
2690 y(a)i(box)e(with)h(a)h(coin)f(in)g(it,)h(we)f(resume)g(the)g
(search)g(at)g(the)h(ne)o(xt)e(city:)555 2873 y Fs(>)43
b(\(find-boxes\))555 2972 y(\(LA)f(1)i(1\)\(LA)d(1)i(2\)C)555
3072 y(\(NY)f(1)i(1\)C)555 3172 y(\(BOS)e(1)h(1\)\(BOS)e(1)i(2\)\(BOS)e
(2)j(1\)\(BOS)d(2)i(2\)C)555 3271 y(@)555 3459 y FA(In)20
b(this)h(case,)f(we)h(open)e(se)n(v)o(en)g(box)o(es)g(instead)h(of)g
(twelv)o(e.)555 3712 y Fw(22.6)99 b(T)-7 b(rue)26 b(Nondeterminism)555
3902 y FA(A)33 b(deterministic)f(graph\255searching)e(program)g(w)o
(ould)i(ha)n(v)o(e)h(to)g(tak)o(e)g(e)o(xplicit)f(steps)h(to)555
4007 y(a)n(v)n(oid)f(getting)g(caught)f(in)i(a)g(circular)f(path.)65
b(Figure)32 b(22.11)f(sho)n(ws)i(a)f(directed)g(graph)555
4111 y(containing)23 b(a)i(loop.)43 b(A)25 b(program)e(searching)g(for)
i(a)g(path)f(from)g(node)g Fs(a)h FA(to)g(node)f Fs(e)h
FA(risks)555 4216 y(getting)20 b(caught)g(in)h(the)f(circular)g(path)g
Fq(h)p Fs(a)p FA(,)i Fs(b)p FA(,)e Fs(c)p Fq(i)p FA(.)32
b(Unless)21 b(a)g(deterministic)f(searcher)g(used)555
4321 y(randomization,)25 b(breadth\255\002rst)f(search,)j(or)f(check)o
(ed)f(e)o(xplicitly)g(for)h(circular)f(paths,)j(the)555
4425 y(search)15 b(might)g(ne)n(v)o(er)f(terminate.)26
b(The)15 b(implementation)e(of)i Fs(path)g FA(sho)n(wn)f(in)i(Figure)e
(22.12)555 4530 y(a)n(v)n(oids)20 b(circular)g(paths)g(by)f(searching)g
(breadth\255\002rst.)680 4634 y(In)24 b(principle,)f(nondeterminism)f
(should)h(sa)n(v)o(e)h(us)h(the)f(trouble)f(of)h(e)n(v)o(en)g
(considering)555 4739 y(circular)i(paths.)48 b(The)26
b(depth\255\002rst)g(implementation)e(of)j Ft(c)o(hoose)e
FA(and)h Ft(fail)h FA(gi)n(v)o(en)f(in)g(Sec\255)555
4844 y(tion)31 b(22.3)f(is)i(vulnerable)d(to)i(the)g(problem)e(of)i
(circular)f(paths,)k(b)n(ut)d(if)g(we)h(were)f(being)555
4948 y(pick)o(y)-5 b(,)30 b(we)g(w)o(ould)f(e)o(xpect)f
(nondeterministic)g Ft(c)o(hoose)g FA(to)i(be)f(able)h(to)f(select)i
(an)e(object)p eop
%%Page: 303 316
303 315 bop 555 538 a Ft(22.6)857 b Fu(TR)n(UE)17 b(NONDETERMINISM)839
b FA(303)p 555 745 2678 4 v 553 2565 4 1820 v 605 888
a Fs(\(define)41 b(\(path)g(node1)h(node2\))692 988 y(\(bf-path)e
(node2)i(\(list)f(\(list)h(node1\)\)\)\))605 1187 y(\(define)f
(\(bf-path)f(dest)i(queue\))692 1287 y(\(if)g(\(null?)f(queue\))866
1386 y('@)866 1486 y(\(let*)h(\(\(path)f(\(car)h(queue\)\))1171
1586 y(\(node)g(\(car)g(path\)\)\))954 1685 y(\(if)g(\(eq?)g(node)g
(dest\))1128 1785 y(\(cdr)g(\(reverse)e(path\)\))1128
1884 y(\(bf-path)g(dest)1520 1984 y(\(append)h(\(cdr)h(queue\))1869
2084 y(\(map)g(\(lambda)e(\(n\))2174 2183 y(\(cons)h(n)j(path\)\))2087
2283 y(\(neighbors)39 b(node\)\)\)\)\)\)\)\))1302 2487
y FA(Figure)20 b(22.12:)28 b(Deterministic)19 b(search.)p
3231 2565 V 555 2569 2678 4 v 555 2696 V 553 3520 4 824
v 605 2839 a Fs(\(define)41 b(\(path)g(node1)h(node2\))692
2938 y(\(cond)g(\(\(null?)e(\(neighbors)g(node1\)\))g(\(fail\)\))954
3038 y(\(\(memq)h(node2)g(\(neighbors)f(node1\)\))g(\(list)i(node2\)\))
954 3138 y(\(else)f(\(let)h(\(\(n)g(\(true-choose)d(\(neighbors)g
(node1\)\)\)\))1302 3237 y(\(cons)j(n)h(\(path)e(n)j(node2\)\)\)\)\)\))
1240 3442 y FA(Figure)19 b(22.13:)28 b(Nondeterministic)19
b(search.)p 3231 3520 V 555 3523 2678 4 v 555 3747 a(which)f(meets)h
(an)o(y)f(computable)f(speci\002cation,)h(and)h(this)g(case)g(is)h(no)f
(e)o(xception.)26 b(Using)19 b(a)555 3852 y(correct)f
Ft(c)o(hoose)p FA(,)f(we)i(should)f(be)h(able)f(to)h(write)g(the)g
(shorter)f(and)g(clearer)g(v)o(ersion)f(of)i Fs(path)555
3956 y FA(sho)n(wn)g(in)i(Figure)e(22.13.)680 4061 y(This)g(section)g
(sho)n(ws)g(ho)n(w)g(to)h(implement)e(v)o(ersions)g Ft(c)o(hoose)g
FA(and)h Ft(fail)g FA(which)g(are)g(safe)555 4166 y(e)n(v)o(en)f(from)f
(circular)h(paths.)28 b(Figure)18 b(22.14)f(contains)h(a)h(Scheme)f
(implementation)f(of)h(true)555 4270 y(nondeterministic)k
Ft(c)o(hoose)i FA(and)g Ft(fail)p FA(.)43 b(Programs)23
b(which)h(use)h(these)g(v)o(ersions)e(of)i Ft(c)o(hoose)56
b Fq(\016)555 4375 y FA(and)13 b Ft(fail)h FA(should)f(\002nd)g
(solutions)g(whene)n(v)o(er)f(the)i(equi)n(v)n(alent)e
(nondeterministic)f(algorithms)555 4479 y(w)o(ould,)19
b(subject)h(to)h(hardw)o(are)d(limitations.)680 4584
y(The)g(implementation)e(of)i Fs(true-choose)c FA(de\002ned)j(in)i
(Figure)e(22.14)g(w)o(orks)h(by)g(treat\255)555 4689
y(ing)i(the)h(list)h(of)e(stored)g(paths)g(as)i(a)f(queue.)29
b(Programs)19 b(using)h Fs(true-choose)d FA(will)k(search)555
4793 y(their)g(state\255space)f(breadth\255\002rst.)30
b(When)21 b(the)g(program)e(reaches)h(a)h(choice\255point,)e
(contin\255)555 4898 y(uations)j(to)h(follo)n(w)f(each)h(choice)f(are)h
(appended)d(to)j(the)g(end)g(of)f(the)h(list)h(of)f(stored)f(paths.)p
eop
%%Page: 304 317
304 316 bop 555 538 a FA(304)944 b Fu(NONDETERMINISM)p
555 745 2678 4 v 553 3362 4 2617 v 605 888 a Fs(\(define)41
b(*paths*)f(\(\)\))605 988 y(\(define)h(failsym)f('@\))605
1187 y(\(define)h(\(true-choose)d(choices\))692 1287
y(\(call-with-curre)o(nt-)o(co)o(nt)o(inu)o(at)o(ion)779
1386 y(\(lambda)j(\(cc\))866 1486 y(\(set!)h(*paths*)f(\(append)f
(*paths*)1825 1586 y(\(map)i(\(lambda)f(\(choice\))2130
1685 y(\(lambda)g(\(\))i(\(cc)f(choice\)\)\))2043 1785
y(choices\)\)\))866 1884 y(\(fail\)\)\)\))605 2084 y(\(define)f(fail\))
605 2283 y(\(call-with-curre)o(nt)o(-co)o(nt)o(in)o(uat)o(io)o(n)692
2383 y(\(lambda)g(\(cc\))779 2482 y(\(set!)h(fail)1041
2582 y(\(lambda)e(\(\))1128 2681 y(\(if)i(\(null?)f(*paths*\))1302
2781 y(\(cc)i(failsym\))1302 2881 y(\(let)f(\(\(p1)g(\(car)g
(*paths*\)\)\))1389 2980 y(\(set!)g(*paths*)f(\(cdr)h(*paths*\)\))1389
3080 y(\(p1\)\)\)\)\)\)\))1211 3284 y FA(Figure)19 b(22.14:)28
b(Correct)20 b Ft(c)o(hoose)f FA(in)h(Scheme.)p 3231
3362 V 555 3366 2678 4 v 555 3590 a(\(Scheme')-5 b(s)25
b Fs(map)g FA(returns)g(the)h(same)g(v)n(alues)f(as)h(Common)f(Lisp')-5
b(s)26 b Fs(mapcar)p FA(.\))44 b(After)25 b(this)555
3694 y(there)20 b(is)h(a)f(call)h(to)f Fs(fail)p FA(,)f(which)h(is)h
(unchanged.)680 3799 y(This)27 b(v)o(ersion)f(of)h Ft(c)o(hoose)f
FA(w)o(ould)h(allo)n(w)g(the)h(implementation)d(of)i
Fs(path)f FA(de\002ned)g(in)555 3904 y(Figure)c(22.13)f(to)i(\002nd)g
(a)g(path\227indeed,)f(the)g(shortest)h(path\227from)e
Fs(a)i FA(to)g Fs(e)g FA(in)g(the)g(graph)555 4008 y(displayed)c(in)h
(Figure)g(22.11.)680 4113 y(Although)g(for)i(the)h(sak)o(e)g(of)f
(completeness)g(this)h(chapter)f(has)g(pro)o(vided)f(correct)g(v)o(er)n
(\255)555 4217 y(sions)26 b(of)g Ft(c)o(hoose)f FA(and)g
Ft(fail)p FA(,)i(the)f(original)f(implementations)f(will)j(usually)e
(suf)n(\002ce.)46 b(The)555 4322 y(v)n(alue)25 b(of)h(a)h(programming)
22 b(language)j(abstraction)g(is)i(not)f(diminished)e(just)j(because)f
(its)555 4427 y(implementation)g(isn')o(t)i(formally)f(correct.)53
b(In)28 b(some)h(languages)e(we)i(act)f(as)i(if)e(we)h(had)555
4531 y(access)g(to)f(all)g(the)g(inte)o(gers,)h(e)n(v)o(en)e(though)f
(the)j(lar)o(gest)e(one)g(may)h(be)g(only)f(32767.)51
b(As)555 4636 y(long)25 b(as)i(we)f(kno)n(w)e(ho)n(w)i(f)o(ar)f(we)i
(can)e(push)g(the)h(illusion,)h(there)e(is)i(little)g(danger)d(to)i
(it\227)555 4740 y(little)33 b(enough,)g(at)f(least,)k(to)c(mak)o(e)g
(the)g(abstraction)f(a)h(bar)o(gain.)63 b(The)31 b(conciseness)h(of)555
4845 y(the)f(programs)e(presented)h(in)h(the)g(ne)o(xt)g(tw)o(o)g
(chapters)f(is)i(due)f(lar)o(gely)f(to)h(their)g(use)g(of)555
4950 y(nondeterministic)18 b Ft(c)o(hoose)h FA(and)h
Ft(fail)p FA(.)p eop
%%Page: 305 318
305 317 bop 555 1610 a Fn(23)p 555 1872 2686 3 v 555
2131 a Fx(P)n(arsing)42 b(with)g(A)-16 b(TNs)555 2568
y FA(This)24 b(chapter)f(sho)n(ws)h(ho)n(w)g(to)g(write)g(a)h
(nondeterministic)d(parser)h(as)i(an)f(embedded)e(lan\255)555
2672 y(guage.)68 b(The)33 b(\002rst)i(part)e(e)o(xplains)f(what)i
Fr(A)-7 b(TN)33 b FA(parsers)g(are,)k(and)c(ho)n(w)g(the)o(y)g
(represent)555 2777 y(grammar)19 b(rules.)30 b(The)20
b(second)f(part)h(presents)g(an)h Fr(A)-7 b(TN)20 b FA(compiler)f
(which)h(uses)h(the)f(nonde\255)555 2882 y(terministic)h(operators)e
(de\002ned)h(in)g(the)h(pre)n(vious)e(chapter)-5 b(.)31
b(The)20 b(\002nal)h(sections)g(present)f(a)555 2986
y(small)h Fr(A)-7 b(TN)20 b FA(grammar)m(,)d(and)j(sho)n(w)g(it)h(in)f
(action)g(parsing)f(sample)h(input.)555 3239 y Fw(23.1)99
b(Backgr)n(ound)555 3430 y FA(Augmented)32 b(T)m(ransition)i(Netw)o
(orks,)j(or)d Fr(A)-7 b(TN)p FA(s,)38 b(are)c(a)h(form)f(of)g(parser)g
(described)f(by)555 3534 y(Bill)26 b(W)-7 b(oods)25 b(in)f(1970.)42
b(Since)24 b(then)h(the)o(y)e(ha)n(v)o(e)i(become)e(a)i(widely)f(used)h
(formalism)e(for)57 b Fq(\016)555 3639 y FA(parsing)18
b(natural)g(language.)27 b(In)18 b(an)h(hour)e(you)h(can)h(write)g(an)g
Fr(A)-7 b(TN)18 b FA(grammar)f(which)i(parses)555 3743
y(interesting)k(English)h(sentences.)40 b(F)o(or)24 b(this)h(reason,)f
(people)f(are)h(often)f(held)h(in)g(a)h(sort)f(of)555
3848 y(spell)d(when)e(the)o(y)h(\002rst)h(encounter)d(them.)680
3953 y(In)25 b(the)h(1970s,)h(some)f(people)f(thought)f(that)i
Fr(A)-7 b(TN)p FA(s)26 b(might)g(one)f(day)h(be)g(components)555
4057 y(of)19 b(truly)f(intelligent\255seeming)f(programs.)27
b(Though)17 b(fe)n(w)i(hold)f(this)i(position)e(today)-5
b(,)18 b Fr(A)-7 b(TN)p FA(s)555 4162 y(ha)n(v)o(e)23
b(found)f(a)j(niche.)39 b(The)o(y)23 b(aren')o(t)f(as)j(good)d(as)j
(you)e(are)h(at)g(parsing)f(English,)g(b)n(ut)h(the)o(y)555
4266 y(can)c(still)h(parse)f(an)g(impressi)n(v)o(e)g(v)n(ariety)f(of)h
(sentences.)680 4371 y(A)-7 b Fr(TN)p FA(s)20 b(are)g(useful)f(if)i
(you)e(observ)o(e)g(the)h(follo)n(wing)f(four)g(restrictions:)659
4542 y(1.)41 b(Use)24 b(them)f(in)g(a)h(semantically)f(limited)g
(domain\227in)f(a)i(front\255end)c(to)k(a)g(particular)763
4647 y(database,)19 b(for)g(e)o(xample.)659 4818 y(2.)41
b(Don')o(t)29 b(feed)h(them)g(v)o(ery)g(dif)n(\002cult)g(input.)60
b(Among)29 b(other)h(things,)j(don')o(t)c(e)o(xpect)763
4922 y(them)19 b(to)i(understand)d(wildly)i(ungrammatical)e(sentences)h
(the)i(w)o(ay)f(people)f(can.)1835 5229 y(305)p eop
%%Page: 306 319
306 318 bop 555 538 a FA(306)920 b Fu(P)-5 b(ARSING)19
b(WITH)g(A)-7 b(TNS)659 801 y FA(3.)41 b(Only)22 b(use)i(them)f(for)g
(English,)g(or)g(other)f(languages)g(in)i(which)e(w)o(ord)h(order)f
(deter)n(\255)763 905 y(mines)17 b(grammatical)f(structure.)27
b(A)-7 b Fr(TN)p FA(s)17 b(w)o(ould)g(not)g(be)g(useful)g(in)h(parsing)
e(in\003ected)763 1010 y(languages)i(lik)o(e)j(Latin.)659
1181 y(4.)41 b(Don')o(t)16 b(e)o(xpect)h(them)h(to)g(w)o(ork)f(all)i
(the)f(time.)28 b(Use)19 b(them)e(in)h(applications)f(where)g(it')-5
b(s)763 1285 y(helpful)19 b(if)h(the)o(y)g(w)o(ork)g(ninety)f(percent)h
(of)g(the)g(time,)h(not)f(those)g(where)g(it')-5 b(s)21
b(critical)763 1390 y(that)f(the)o(y)f(w)o(ork)h(a)g(hundred)e(percent)
h(of)h(the)h(time.)555 1561 y(W)m(ithin)c(these)f(limits)i(there)e(are)
h(plenty)f(of)g(useful)g(applications.)27 b(The)17 b(canonical)e(e)o
(xample)555 1666 y(is)28 b(as)g(the)f(front\255end)d(of)j(a)g
(database.)50 b(If)26 b(you)h(attach)f(an)h Fr(A)-7 b(TN)p
FA(\255dri)n(v)o(en)24 b(interf)o(ace)j(to)g(such)555
1770 y(a)j(system,)i(then)d(instead)g(of)g(making)g(a)h(formal)e(query)
-5 b(,)30 b(users)g(can)f(ask)h(questions)e(in)i(a)555
1875 y(constrained)18 b(form)i(of)g(English.)555 2128
y Fw(23.2)99 b(The)26 b(F)n(ormalism)555 2318 y FA(T)-7
b(o)20 b(understand)f(what)h Fr(A)-7 b(TN)p FA(s)20 b(do,)g(we)g
(should)f(recall)i(their)f(full)g(name:)29 b(augmented)18
b(transi\255)555 2423 y(tion)k(netw)o(orks.)34 b(A)23
b(transition)e(netw)o(ork)g(is)j(a)e(set)h(of)f(nodes)g(joined)f
(together)g(by)h(directed)555 2528 y(arcs\227essentially)-5
b(,)23 b(a)g(\003o)n(w\255chart.)36 b(One)23 b(node)f(is)h(designated)f
(the)h(start)g(node,)f(and)h(some)555 2632 y(other)h(nodes)f(are)h
(designated)f(terminal)h(nodes.)41 b(Conditions)23 b(are)i(attached)e
(to)i(each)f(arc,)555 2737 y(which)30 b(ha)n(v)o(e)f(to)h(be)g(met)g
(before)f(the)h(arc)g(can)g(be)g(follo)n(wed.)57 b(There)30
b(will)g(be)g(an)g(input)555 2841 y(sentence,)21 b(with)i(a)f(pointer)f
(to)h(the)g(current)e(w)o(ord.)34 b(F)o(ollo)n(wing)20
b(some)i(arcs)g(will)h(cause)f(the)555 2946 y(pointer)i(to)h(be)g(adv)n
(anced.)41 b(T)-7 b(o)25 b(parse)f(a)i(sentence)e(on)h(a)g(transition)f
(netw)o(ork)g(is)h(to)h(\002nd)e(a)555 3051 y(path)i(from)g(the)h
(start)h(node)d(to)i(some)g(terminal)f(node,)h(along)f(which)h(all)g
(the)g(conditions)555 3155 y(can)20 b(be)g(met.)680 3260
y(A)-7 b Fr(TN)p FA(s)20 b(add)f(tw)o(o)i(features)e(to)i(this)f
(model:)659 3447 y(1.)41 b(A)-7 b Fr(TN)p FA(s)16 b(ha)n(v)o(e)h(re)o
(gisters\227named)e(slots)j(for)e(storing)g(a)o(w)o(ay)h(information)d
(as)k(the)f(parse)763 3552 y(proceeds.)31 b(As)23 b(well)f(as)g
(performing)d(tests,)k(arcs)e(can)h(modify)e(the)h(contents)g(of)h(the)
763 3657 y(re)o(gisters.)659 3828 y(2.)41 b(A)-7 b Fr(TN)p
FA(s)29 b(are)g(recursi)n(v)o(e.)56 b(Arcs)30 b(may)f(require)f(that,)k
(in)e(order)e(to)i(follo)n(w)e(them,)k(the)763 3932 y(parse)19
b(must)i(successfully)e(mak)o(e)h(it)h(through)d(some)i(sub\255netw)o
(ork.)555 4120 y(T)-6 b(erminal)30 b(nodes)g(use)h(the)g(information)d
(which)i(has)h(accumulated)e(in)i(the)g(re)o(gisters)f(to)555
4224 y(b)n(uild)17 b(list)i(structures,)e(which)g(the)o(y)g(return)g
(in)h(much)e(the)i(same)g(w)o(ay)g(that)g(functions)e(return)555
4329 y(v)n(alues.)41 b(In)25 b(f)o(act,)g(with)g(the)f(e)o(xception)e
(of)j(being)e(nondeterministic,)g Fr(A)-7 b(TN)p FA(s)24
b(beha)n(v)o(e)f(a)i(lot)555 4434 y(lik)o(e)20 b(a)h(functional)d
(programming)f(language.)680 4538 y(The)g Fr(A)-7 b(TN)17
b FA(de\002ned)f(in)i(Figure)f(23.1)f(is)i(nearly)f(the)g(simplest)h
(possible.)28 b(It)18 b(parses)f(noun\255)555 4643 y(v)o(erb)h
(sentences)g(of)g(the)h(form)f(\223Spot)g(runs.)-6 b(\224)28
b(The)19 b(netw)o(ork)e(representation)g(of)h(this)h
Fr(A)-7 b(TN)19 b FA(is)555 4748 y(sho)n(wn)g(in)i(Figure)e(23.2.)680
4852 y(What)c(does)g(this)h Fr(A)-7 b(TN)14 b FA(do)h(when)g(gi)n(v)o
(en)e(the)j(input)e Fs(\(spot)42 b(runs\))p FA(?)26 b(The)14
b(\002rst)i(node)e(has)555 4957 y(one)23 b(outgoing)f(arc,)i(a)g(cat,)h
(or)e(cate)o(gory)f(arc,)i(leading)f(to)h(node)f Fs(s2)p
FA(.)39 b(It)24 b(says,)h(ef)n(fecti)n(v)o(ely)-5 b(,)p
eop
%%Page: 307 320
307 319 bop 555 538 a Ft(23.2)970 b Fu(THE)18 b(FORMALISM)953
b FA(307)p 555 745 2678 4 v 553 2266 4 1522 v 605 888
a Fs(\(defnode)40 b(s)692 988 y(\(cat)i(noun)g(s2)779
1087 y(\(setr)g(subj)g(*\)\)\))605 1287 y(\(defnode)e(s2)692
1386 y(\(cat)i(verb)g(s3)779 1486 y(\(setr)g(v)h(*\)\)\))605
1685 y(\(defnode)d(s3)692 1785 y(\(up)i(`\(sentence)997
1884 y(\(subject)e(,\(getr)h(subj\)\))997 1984 y(\(verb)h(,\(getr)f
(v\)\)\)\)\))1360 2188 y FA(Figure)20 b(23.1:)28 b(A)21
b(v)o(ery)e(small)i(A)-9 b(TN.)p 3231 2266 V 555 2270
2678 4 v 555 2392 V 553 3121 4 730 v 605 2927 a @beginspecial
@setspecial @endspecial 1296 3043 a(Figure)20 b(23.2:)28
b(Graph)19 b(of)h(a)h(small)g(A)-9 b(TN.)p 3231 3121
V 555 3125 2678 4 v 555 3328 a(you)25 b(can)g(follo)n(w)g(me)g(if)h
(the)g(current)e(w)o(ord)h(is)h(a)g(noun,)g(and)f(if)g(you)g(do,)h(you)
f(must)h(store)555 3432 y(the)19 b(current)f(w)o(ord)g(\(indicated)f
(by)i Fs(*)p FA(\))g(in)g(the)g Fs(subj)e FA(re)o(gister)-5
b(.)29 b(So)19 b(we)g(lea)n(v)o(e)g(this)h(node)d(with)555
3537 y Fs(spot)i FA(stored)h(in)g(the)g Fs(subj)f FA(re)o(gister)-5
b(.)680 3642 y(There)26 b(is)i(al)o(w)o(ays)g(a)f(pointer)f(to)h(the)h
(current)e(w)o(ord.)49 b(Initially)27 b(it)h(points)e(to)i(the)f
(\002rst)555 3746 y(w)o(ord)21 b(in)h(the)g(sentence.)33
b(When)22 b(cat)g(arcs)g(are)f(follo)n(wed,)g(this)h(pointer)f(is)h(mo)
o(v)o(ed)e(forw)o(ard)555 3851 y(one.)56 b(So)29 b(when)g(we)g(get)h
(to)f(node)f Fs(s2)p FA(,)j(the)e(current)f(w)o(ord)h(is)h(the)f
(second,)i Fs(runs)p FA(.)55 b(The)555 3956 y(second)21
b(arc)i(is)g(just)g(lik)o(e)f(the)h(\002rst,)g(e)o(xcept)e(that)i(it)g
(is)g(looking)e(for)g(a)i(v)o(erb)m(.)34 b(It)23 b(\002nds)f
Fs(runs)p FA(,)555 4060 y(stores)e(it)h(in)g(re)o(gister)e
Fs(v)p FA(,)h(and)g(proceeds)f(to)h Fs(s3)p FA(.)680
4165 y(The)15 b(\002nal)i(node,)e Fs(s3)p FA(,)i(has)f(only)f(a)i(pop,)
e(or)h(terminal,)g(arc.)28 b(\(Nodes)15 b(with)i(pop)e(arcs)h(ha)n(v)o
(e)555 4269 y(dashed)k(borders.\))28 b(Because)20 b(we)h(arri)n(v)o(e)e
(at)i(the)g(pop)e(arc)i(just)g(as)g(we)g(run)e(out)i(of)f(input,)f(we)
555 4374 y(ha)n(v)o(e)g(a)h(successful)g(parse.)28 b(The)20
b(pop)e(arc)i(returns)f(the)g(backquoted)e(e)o(xpression)h(within)i
(it:)555 4635 y Fs(\(sentence)40 b(\(subject)g(spot\))991
4735 y(\(verb)h(runs\)\))680 4896 y FA(An)18 b Fr(A)-7
b(TN)18 b FA(corresponds)e(to)j(the)f(grammar)f(of)h(the)g(language)f
(it)i(is)g(designed)e(to)i(parse.)28 b(A)555 5001 y(decent\255sized)c
Fr(A)-7 b(TN)25 b FA(for)f(parsing)g(English)h(will)h(ha)n(v)o(e)e(a)i
(main)f(netw)o(ork)f(for)g(parsing)h(sen\255)p eop
%%Page: 308 321
308 320 bop 555 538 a FA(308)920 b Fu(P)-5 b(ARSING)19
b(WITH)g(A)-7 b(TNS)555 801 y FA(tences,)23 b(and)e(sub\255netw)o(orks)
g(for)g(parsing)g(noun\255phrases,)f(prepositional)h(phrases,)h
(modi\255)555 905 y(\002er)h(groups,)e(and)h(so)h(on.)36
b(The)23 b(need)f(for)g(recursion)f(is)i(ob)o(vious)e(when)h(we)h
(consider)e(that)555 1010 y(noun\255phrases)12 b(may)h(contain)h
(prepositional)e(phrases)i(which)g(may)f(contain)h(noun\255phrases,)555
1114 y Ft(ad)20 b(in\002nitum,)f FA(as)h(in)968 1302
y(\223the)g(k)o(e)o(y)g(on)g(the)g(table)g(in)g(the)g(hall)h(of)f(the)g
(house)f(on)h(the)g(hill\224)555 1555 y Fw(23.3)99 b(Nondeterminism)555
1745 y FA(Although)25 b(we)j(didn')o(t)e(see)i(it)g(in)f(this)h(small)f
(e)o(xample,)h Fr(A)-7 b(TN)p FA(s)27 b(are)g(nondeterministic.)48
b(A)555 1850 y(node)22 b(can)h(ha)n(v)o(e)g(se)n(v)o(eral)g(outgoing)e
(arcs,)j(more)f(than)g(one)f(of)h(which)g(could)g(be)g(follo)n(wed)555
1955 y(with)g(a)g(gi)n(v)o(en)f(input.)36 b(F)o(or)23
b(e)o(xample,)f(a)h(reasonably)e(good)h Fr(A)-7 b(TN)22
b FA(should)g(be)h(able)g(to)g(parse)555 2059 y(both)13
b(imperati)n(v)o(e)g(and)g(declarati)n(v)o(e)g(sentences.)27
b(Thus)13 b(the)h(\002rst)h(node)e(could)g(ha)n(v)o(e)h(outgoing)555
2164 y(cat)21 b(arcs)f(for)g(both)f(nouns)g(\(in)h(statements\))g(and)g
(v)o(erbs)f(\(in)h(commands\).)680 2268 y(What)25 b(if)h(the)f(\002rst)
h(w)o(ord)f(of)g(the)g(sentence)g(is)i(\223time,)-6 b(\224)26
b(which)f(is)h(both)f(a)g(noun)f(and)h(a)555 2373 y(v)o(erb?)31
b(Ho)n(w)21 b(does)g(the)g(parser)f(kno)n(w)h(which)f(arc)h(to)g(follo)
n(w?)32 b(When)21 b Fr(A)-7 b(TN)p FA(s)21 b(are)g(described)555
2478 y(as)i(nondeterministic,)c(it)k(means)e(that)h(users)g(can)g
(assume)g(that)g(the)g(parser)f(will)h Ft(corr)m(ectly)555
2582 y(guess)g FA(which)g(arc)h(to)f(follo)n(w)-5 b(.)35
b(If)22 b(some)h(arcs)f(lead)g(only)g(to)h(f)o(ailed)f(parses,)h(the)o
(y)e(w)o(on')o(t)h(be)555 2687 y(follo)n(wed.)680 2792
y(In)e(reality)h(the)g(parser)g(cannot)f(look)g(into)h(the)g(future.)31
b(It)21 b(simulates)g(correct)f(guessing)555 2896 y(by)31
b(backtracking)f(when)h(it)i(runs)e(out)h(of)f(arcs,)k(or)d(input.)63
b(But)33 b(all)f(the)g(machinery)e(of)555 3001 y(backtracking)14
b(is)g(inserted)g(automatically)f(into)g(th)o(e)h(co)o(de)f(gen)o
(erated)g(b)o(y)h(th)o(e)g Fr(A)-8 b(TN)14 b FA(co)o(mp)o(iler)-5
b(.)555 3105 y(W)e(e)21 b(can)f(write)h Fr(A)-7 b(TN)p
FA(s)20 b(as)h(if)f(the)g(parser)g(really)g(could)f(guess)h(which)g
(arcs)g(to)h(follo)n(w)-5 b(.)680 3210 y(Lik)o(e)31 b(man)o(y)f
(\(perhaps)g(most\))h(programs)f(which)h(use)h(nondeterminism,)f
Fr(A)-7 b(TN)p FA(s)31 b(use)555 3315 y(the)24 b(depth\255\002rst)f
(implementation.)39 b(Experience)22 b(parsing)i(English)f(quickly)g
(teaches)h(one)555 3419 y(that)k(an)o(y)e(gi)n(v)o(en)h(sentence)g(has)
g(a)h(sle)n(w)h(of)e(le)o(gal)g(parsings,)h(most)g(of)f(them)g(junk.)51
b(On)27 b(a)555 3524 y(con)m(v)o(entional)16 b(single\255processor)h
(machine,)h(one)h(is)h(better)f(of)n(f)f(trying)g(to)i(get)f(good)f
(parses)555 3628 y(quickly)-5 b(.)40 b(Instead)24 b(of)g(getting)g(all)
h(the)f(parses)h(at)g(once,)f(we)h(get)f(just)h(the)g(most)f(lik)o(ely)
-5 b(.)42 b(If)555 3733 y(it)25 b(has)g(a)h(reasonable)d
(interpretation,)g(then)h(we)i(ha)n(v)o(e)e(sa)n(v)o(ed)g(the)h(ef)n
(fort)e(of)i(\002nding)e(other)555 3838 y(parses;)d(if)h(not,)e(we)i
(can)f(call)h Ft(fail)f FA(to)g(get)h(more.)680 3942
y(T)-7 b(o)22 b(control)g(the)g(order)f(in)i(which)f(parses)h(are)f
(generated,)f(the)i(programmer)c(needs)j(to)555 4047
y(ha)n(v)o(e)j(some)h(w)o(ay)g(of)g(controlling)e(the)i(order)f(in)h
(which)f Ft(c)o(hoose)g FA(tries)h(alternati)n(v)o(es.)46
b(The)555 4151 y(depth\255\002rst)13 b(implementation)f(isn')o(t)i(the)
g(only)f(w)o(ay)h(of)g(controlling)e(the)i(order)f(of)h(the)g(search.)
555 4256 y(An)o(y)h(implementation)e(e)o(xcept)h(a)i(randomizing)d(one)
h(imposes)h(some)h(kind)e(of)h(order)-5 b(.)27 b(Ho)n(w\255)555
4361 y(e)n(v)o(er)m(,)18 b Fr(A)-7 b(TN)p FA(s,)18 b(lik)o(e)h(Prolog,)
f(ha)n(v)o(e)g(the)h(depth\255\002rst)e(implementation)g(conceptually)f
(b)n(uilt\255in.)555 4465 y(In)g(an)f Fr(A)-7 b(TN)p
FA(,)17 b(the)f(arcs)g(lea)n(ving)f(a)h(node)f(are)h(tried)g(in)g(the)g
(order)e(in)i(which)g(the)o(y)f(were)h(de\002ned.)555
4570 y(This)k(con)m(v)o(ention)e(allo)n(ws)i(the)g(programmer)d(to)k
(order)e(arcs)h(by)g(priority)-5 b(.)p eop
%%Page: 309 322
309 321 bop 555 538 a Ft(23.4)944 b Fu(AN)19 b(A)-7 b(TN)19
b(COMPILER)926 b FA(309)555 801 y Fw(23.4)99 b(An)25
b(A)-9 b(TN)25 b(Compiler)555 991 y FA(Ordinarily)-5
b(,)19 b(an)h Fr(A)-7 b(TN)p FA(\255based)19 b(parser)h(needs)h(three)f
(components:)28 b(the)21 b Fr(A)-7 b(TN)20 b FA(itself,)h(an)g(inter)n
(\255)555 1096 y(preter)d(for)h(tra)n(v)o(ersing)e(it,)j(and)f(a)g
(dictionary)e(which)i(can)g(tell)g(it,)h(for)f(e)o(xample,)e(that)i
(\223runs\224)555 1200 y(is)g(a)f(v)o(erb)m(.)27 b(Dictionaries)18
b(are)g(a)g(separate)g(topic\227here)f(we)h(will)h(use)f(a)h
(rudimentary)c(hand\255)555 1305 y(made)22 b(one.)37
b(Nor)22 b(will)i(we)f(need)f(to)h(deal)g(with)f(a)i(netw)o(ork)d
(interpreter)m(,)h(because)g(we)h(will)555 1410 y(translate)c(the)f
Fr(A)-7 b(TN)19 b FA(directly)f(into)g(Lisp)h(code.)28
b(The)19 b(program)e(described)g(here)h(is)i(called)f(an)555
1514 y Fr(A)-7 b(TN)15 b FA(compiler)g(because)g(it)h(transforms)e(a)i
(whole)f Fr(A)-7 b(TN)16 b FA(into)f(code.)27 b(Nodes)15
b(are)h(transformed)555 1619 y(into)k(functions,)e(and)i(arcs)h(become)
d(blocks)i(of)g(code)f(within)h(them.)680 1723 y(Chapter)25
b(6)g(introduced)f(the)i(use)f(of)h(functions)e(as)j(a)f(form)e(of)i
(representation.)43 b(This)555 1828 y(practice)34 b(usually)g(mak)o(es)
g(programs)e(f)o(aster)-5 b(.)73 b(Here)34 b(it)h(means)f(that)h(there)
f(will)h(be)f(no)555 1933 y(o)o(v)o(erhead)17 b(of)j(interpreting)d
(the)j(netw)o(ork)f(at)h(runtime.)28 b(The)19 b(disadv)n(antage)f(is)j
(that)e(there)h(is)555 2037 y(less)g(to)e(inspect)g(when)g(something)f
(goes)h(wrong,)g(especially)g(if)h(you')l(re)d(using)i(a)h(Common)555
2142 y(Lisp)h(implementation)e(which)i(doesn')o(t)f(pro)o(vide)f
Fs(function-lambda-)o(ex)o(pre)o(ss)o(io)o(n)p FA(.)680
2246 y(Figure)j(23.3)h(contains)g(all)h(the)f(code)g(for)g
(transforming)e Fr(A)-7 b(TN)23 b FA(nodes)e(into)i(Lisp)g(code.)555
2351 y(The)f(macro)g Fs(defnode)e FA(is)j(used)f(to)h(de\002ne)f
(nodes.)35 b(It)23 b(generates)f(little)h(code)f(itself,)h(just)g(a)555
2456 y Fs(choose)d FA(o)o(v)o(er)g(the)h(e)o(xpressions)g(generated)e
(for)i(each)h(of)f(the)g(arcs.)34 b(The)21 b(tw)o(o)h(parameters)555
2560 y(of)h(a)h(node\255function)19 b(get)k(the)h(follo)n(wing)d(v)n
(alues:)36 b Fs(pos)22 b FA(is)i(the)g(current)d(input)i(pointer)f
(\(an)555 2665 y(inte)o(ger\),)c(and)i Fs(regs)f FA(is)i(the)g(current)
d(set)j(of)f(re)o(gisters)g(\(a)g(list)i(of)e(assoc\255lists\).)680
2770 y(The)15 b(macro)f Fs(defnode)g FA(de\002nes)h(a)h(macro)f(with)h
(the)f(same)h(name)f(as)h(the)g(corresponding)555 2874
y(node.)34 b(Node)22 b Fs(s)g FA(will)h(be)f(de\002ned)f(as)i(macro)e
Fs(s)p FA(.)36 b(This)22 b(con)m(v)o(ention)d(enables)j(arcs)g(to)h
(kno)n(w)555 2979 y(ho)n(w)f(to)h(refer)f(to)h(their)f(destination)g
(nodes\227the)o(y)e(just)j(call)g(the)g(macro)f(with)h(that)f(name.)555
3083 y(It)28 b(also)h(means)e(that)h(you)f(shouldn')o(t)f(gi)n(v)o(e)h
(nodes)h(the)g(names)f(of)h(e)o(xisting)f(functions)g(or)555
3188 y(macros,)19 b(or)h(these)h(will)f(be)h(rede\002ned.)680
3293 y(Deb)n(ugging)g Fr(A)-7 b(TN)p FA(s)23 b(requires)g(some)g(sort)h
(of)f(trace)g(f)o(acility)-5 b(.)38 b(Because)24 b(nodes)f(become)555
3397 y(functions,)d(we)i(don')o(t)e(ha)n(v)o(e)h(to)g(write)h(our)e(o)n
(wn.)33 b(W)-7 b(e)22 b(can)g(use)f(the)h(b)n(uilt\255in)f(Lisp)g
(function)555 3502 y Fs(trace)p FA(.)28 b(As)22 b(mentioned)c(on)i
(page)g(266,)f(using)h Fs(=defun)e FA(to)j(de\002ne)f(nodes)g(means)g
(that)g(we)555 3606 y(can)g(trace)g(parses)g(going)f(through)f(node)h
Fs(mods)g FA(by)h(saying)g Fs(\(trace)41 b(=mods\))p
FA(.)680 3711 y(The)13 b(arcs)g(within)g(the)g(body)f(of)g(a)h(n)o(od)o
(e)g(a)o(re)g(simp)o(ly)f(macr)o(o)g(calls,)d(returning)k(code)g(which)
555 3816 y(gets)28 b(embedded)d(in)i(the)g(node)g(function)e(being)i
(made)f(by)h Fs(defnode)p FA(.)48 b(The)27 b(parser)g(uses)555
3920 y(nondeterminism)20 b(at)j(each)g(node)e(by)i(e)o(x)o(ecuting)d(a)
k Fs(choose)c FA(o)o(v)o(er)i(the)h(code)f(representing)555
4025 y(each)e(of)g(the)g(arcs)g(lea)n(ving)g(that)g(node.)28
b(A)21 b(node)e(with)i(se)n(v)o(eral)e(outgoing)f(arcs,)i(say)555
4188 y Fs(\(defnode)40 b(foo)642 4288 y(<arc)i(1>)642
4388 y(<arc)g(2>\))555 4551 y FA(gets)21 b(translated)e(into)h(a)h
(function)d(de\002nition)h(of)h(the)g(follo)n(wing)f(form:)555
4702 y Fs(\(=defun)41 b(foo)h(\(pos)g(regs\))642 4801
y(\(choose)729 4901 y(<translation)d(of)k(arc)f(1>)729
5001 y(<translation)d(of)k(arc)f(2>\)\))p eop
%%Page: 310 323
310 322 bop 555 538 a FA(310)920 b Fu(P)-5 b(ARSING)19
b(WITH)g(A)-7 b(TNS)p 555 745 2678 4 v 553 5051 4 4306
v 605 888 a Fs(\(defmacro)40 b(defnode)g(\(name)i(&rest)f(arcs\))692
983 y(`\(=defun)f(,name)i(\(pos)g(regs\))f(\(choose)g(,@arcs\)\)\))605
1172 y(\(defmacro)f(down)i(\(sub)g(next)f(&rest)h(cmds\))692
1267 y(`\(=bind)f(\(*)h(pos)h(regs\))e(\(,sub)h(pos)g(\(cons)g(nil)g
(regs\)\))823 1361 y(\(,next)f(pos)h(,\(compile-cmds)c(cmds\)\)\)\))605
1551 y(\(defmacro)i(cat)i(\(cat)g(next)g(&rest)f(cmds\))692
1645 y(`\(if)h(\(=)h(\(length)d(*sent*\))h(pos\))910
1740 y(\(fail\))910 1835 y(\(let)h(\(\(*)g(\(nth)g(pos)g(*sent*\)\)\))
997 1929 y(\(if)g(\(member)f(',cat)h(\(types)f(*\)\))1171
2024 y(\(,next)h(\(1+)g(pos\))g(,\(compile-cmds)c(cmds\)\))1171
2119 y(\(fail\)\)\)\)\))605 2308 y(\(defmacro)i(jump)i(\(next)f(&rest)h
(cmds\))692 2402 y(`\(,next)f(pos)h(,\(compile-cmds)c(cmds\)\)\))605
2592 y(\(defun)j(compile-cmds)e(\(cmds\))692 2686 y(\(if)j(\(null)g
(cmds\))866 2781 y('regs)866 2876 y(`\(,@\(car)f(cmds\))g
(,\(compile-cmds)d(\(cdr)k(cmds\)\)\)\)\))605 3065 y(\(defmacro)e(up)i
(\(expr\))692 3160 y(`\(let)g(\(\(*)g(\(nth)g(pos)g(*sent*\)\)\))823
3254 y(\(=values)e(,expr)i(pos)g(\(cdr)g(regs\)\)\)\))605
3444 y(\(defmacro)e(getr)i(\(key)g(&optional)d(\(regs)j('regs\)\))692
3538 y(`\(let)g(\(\(result)e(\(cdr)i(\(assoc)f(',key)g(\(car)h
(,regs\)\)\)\)\))823 3633 y(\(if)g(\(cdr)g(result\))f(result)g(\(car)h
(result\)\)\)\))605 3822 y(\(defmacro)e(set-register)e(\(key)k(val)h
(regs\))692 3917 y(`\(cons)e(\(cons)h(\(cons)f(,key)h(,val\))g(\(car)g
(,regs\)\))997 4011 y(\(cdr)g(,regs\)\)\))605 4201 y(\(defmacro)e(setr)
i(\(key)g(val)g(regs\))692 4295 y(`\(set-register)c(',key)j(\(list)h
(,val\))f(,regs\)\))605 4485 y(\(defmacro)f(pushr)h(\(key)h(val)g
(regs\))692 4579 y(`\(set-register)c(',key)1346 4674
y(\(cons)j(,val)h(\(cdr)g(\(assoc)f(',key)h(\(car)g(,regs\)\)\)\))1346
4769 y(,regs\)\))1158 4973 y FA(Figure)20 b(23.3:)28
b(Compilation)19 b(of)h(nodes)f(and)h(arcs.)p 3231 5051
V 555 5054 2678 4 v eop
%%Page: 311 324
311 323 bop 555 538 a Ft(23.4)944 b Fu(AN)19 b(A)-7 b(TN)19
b(COMPILER)926 b FA(311)p 555 745 2678 4 v 553 3794 4
3049 v 605 888 a Fs(\(defnode)40 b(s)692 988 y(\(down)i(np)g(s/subj)779
1087 y(\(setr)g(mood)g('decl\))779 1187 y(\(setr)g(subj)g(*\)\))692
1287 y(\(cat)g(v)h(v)779 1386 y(\(setr)f(mood)g('imp\))779
1486 y(\(setr)g(subj)g('\(np)g(\(pron)f(you\)\)\))779
1586 y(\(setr)h(aux)g(nil\))779 1685 y(\(setr)g(v)h(*\)\)\))605
1868 y FA(is)21 b(macroe)o(xpanded)16 b(into:)605 2034
y Fs(\(=defun)41 b(s)i(\(pos)f(regs\))692 2134 y(\(choose)779
2233 y(\(=bind)f(\(*)i(pos)f(regs\))g(\(np)g(pos)h(\(cons)e(nil)h
(regs\)\))866 2333 y(\(s/subj)f(pos)1215 2432 y(\(setr)h(mood)f('decl)
1477 2532 y(\(setr)g(subj)h(*)h(regs\)\)\)\))779 2632
y(\(if)g(\(=)f(\(length)f(*sent*\))g(pos\))954 2731 y(\(fail\))954
2831 y(\(let)g(\(\(*)i(\(nth)f(pos)g(*sent*\)\)\))1041
2931 y(\(if)g(\(member)f('v)h(\(types)g(*\)\))1215 3030
y(\(v)h(\(1+)f(pos\))1346 3130 y(\(setr)f(mood)h('imp)1607
3229 y(\(setr)g(subj)g('\(np)g(\(pron)f(you\)\))1869
3329 y(\(setr)g(aux)i(nil)2130 3429 y(\(setr)f(v)h(*)g(regs\)\)\)\)\))
1215 3528 y(\(fail\)\)\)\)\)\))1076 3716 y FA(Figure)19
b(23.4:)29 b(Macroe)o(xpansion)16 b(of)k(a)h(node)e(function.)p
3231 3794 V 555 3797 2678 4 v 555 4021 a(Figure)30 b(23.4)h(sho)n(ws)g
(the)g(macroe)o(xpansion)c(of)k(the)h(\002rst)f(node)g(in)g(the)g
(sample)g Fr(A)-7 b(TN)31 b FA(of)555 4126 y(Figure)18
b(23.11.)27 b(When)19 b(called)g(at)g(runtime,)f(node)g(functions)f
(lik)o(e)i Fs(s)g FA(nondeterministically)555 4231 y(choose)26
b(an)h(arc)g(to)h(follo)n(w)-5 b(.)48 b(The)27 b(parameter)f
Fs(pos)g FA(will)i(be)f(the)g(current)f(position)g(in)i(the)555
4335 y(input)19 b(sentence,)h(and)f Fs(regs)h FA(the)g(current)f(re)o
(gisters.)680 4440 y(Cat)27 b(arcs,)i(as)e(we)h(sa)o(w)f(in)g(our)f
(original)g(e)o(xample,)h(insist)g(that)g(the)g(current)f(w)o(ord)g(of)
555 4545 y(input)21 b(belong)f(to)i(a)g(certain)f(grammatical)g(cate)o
(gory)-5 b(.)31 b(W)m(ithin)22 b(the)g(body)e(of)h(a)i(cat)f(arc,)g
(the)555 4649 y(symbol)d Fs(*)i FA(will)g(be)f(bound)e(to)i(the)h
(current)d(w)o(ord)i(of)g(input.)680 4754 y(Push)h(arcs,)g(de\002ned)f
(with)h Fs(down)p FA(,)f(require)g(successful)h(calls)h(to)f
(sub\255netw)o(orks.)30 b(The)o(y)555 4858 y(tak)o(e)c(tw)o(o)f
(destination)g(nodes,)g(the)h(sub\255netw)o(ork)d(destination)i
Fs(sub)p FA(,)g(and)g(the)h(ne)o(xt)f(node)555 4963 y(in)h(the)g
(current)f(netw)o(ork,)h Fs(next)p FA(.)45 b(Notice)26
b(that)g(whereas)g(the)g(code)f(generated)f(for)i(a)g(cat)p
eop
%%Page: 312 325
312 324 bop 555 538 a FA(312)920 b Fu(P)-5 b(ARSING)19
b(WITH)g(A)-7 b(TNS)555 801 y FA(arc)33 b(simply)f(calls)i(the)f(ne)o
(xt)f(node)g(in)h(the)g(netw)o(ork,)h(the)f(code)f(generated)g(for)g(a)
h(push)555 905 y(arc)d(uses)i Fs(=bind)p FA(.)58 b(The)30
b(push)g(arc)h(must)f(successfully)g(return)g(from)f(the)i(sub\255netw)
o(ork)555 1010 y(before)21 b(continuing)e(on)j(to)g(the)g(node)f(which)
g(follo)n(ws)h(it.)35 b(A)22 b(clean)g(set)h(of)e(re)o(gisters)h(\()p
Fs(nil)p FA(\))555 1114 y(gets)30 b(consed)e(onto)h(the)g(front)f(of)i
Fs(regs)e FA(before)g(the)o(y)h(are)g(passed)g(to)h(the)f(sub\255netw)o
(ork.)555 1219 y(In)e(the)h(bodies)f(of)g(other)g(types)h(of)f(arcs,)j
(the)d(symbol)g Fs(*)h FA(will)g(be)g(bound)d(to)j(the)g(current)555
1324 y(w)o(ord)21 b(of)g(input,)g(b)n(ut)g(in)h(push)f(arcs)g(it)i
(will)f(be)f(bound)f(to)h(the)h(e)o(xpression)e(returned)f(by)j(the)555
1428 y(sub\255netw)o(ork.)680 1533 y(Jump)13 b(arcs)g(are)g(lik)o(e)g
(short\255circu)o(its.)22 b(The)13 b(parser)g(skips)g(right)g(acro)o
(ss)g(to)g(th)o(e)g(d)o(estinatio)o(n)555 1638 y(node\227no)18
b(tests)k(are)e(required,)e(and)h(the)i(input)e(pointer)g(isn')o(t)h
(adv)n(anced.)680 1742 y(The)h(\002nal)i(type)f(of)g(arc)g(is)h(the)g
(pop)e(arc,)i(de\002ned)e(with)h Fs(up)p FA(.)35 b(Pop)23
b(arcs)f(are)g(unusual)f(in)555 1847 y(that)e(the)o(y)e(don')o(t)g(ha)n
(v)o(e)h(a)h(destination.)28 b(Just)19 b(as)g(a)g(Lisp)g
Fs(return)d FA(leads)j(not)f(to)h(a)f(subroutine)555
1951 y(b)n(ut)e(the)h(calling)f(function,)f(a)i(pop)f(arc)g(leads)h
(not)f(to)g(a)h(ne)n(w)g(node)e(b)n(ut)h(back)g(to)h(the)f
(\223calling\224)555 2056 y(push)24 b(arc.)41 b(The)24
b Fs(=values)e FA(in)i(a)h(pop)e(arc)h(\223returns\224)f(a)i(v)n(alue)f
(to)g(the)g Fs(=bind)f FA(in)h(the)h(most)555 2161 y(recent)18
b(push)g(arc.)29 b(But,)19 b(as)g(Section)g(20.2)e(e)o(xplained,)g
(what')-5 b(s)19 b(happening)d(is)j(not)g(a)g(normal)555
2265 y(Lisp)e Fs(return)p FA(:)26 b(the)18 b(body)d(of)i(the)h
Fs(=bind)d FA(has)j(been)e(wrapped)g(up)h(into)g(a)g(continuation)e
(and)555 2370 y(passed)j(do)n(wn)f(as)h(a)h(parameter)d(through)g(an)o
(y)h(number)f(of)i(arcs,)g(until)g(the)g Fs(=values)e
FA(of)i(the)555 2474 y(pop)h(arc)h(\002nally)g(calls)h(it)g(on)f(the)g
(\223return\224)f(v)n(alues.)680 2579 y(Chapter)e(22)h(described)g(tw)o
(o)g(v)o(ersions)g(of)g(nondeterministic)e Ft(c)o(hoose)p
FA(:)28 b(a)18 b(f)o(ast)h Fs(choose)555 2684 y FA(\(page)14
b(293\))f(that)i(w)o(asn')o(t)f(guaranteed)e(to)j(terminate)f(when)g
(there)g(were)g(loops)h(in)f(the)h(search)555 2788 y(space,)26
b(and)f(a)g(slo)n(wer)g Fs(true-choose)c FA(\(page)j(304\))g(which)g(w)
o(as)i(safe)g(from)e(such)g(loops.)555 2893 y(There)g(can)g(be)g(c)o
(ycles)g(in)h(an)f Fr(A)-7 b(TN)p FA(,)25 b(of)f(course,)h(b)n(ut)f(as)
h(long)f(as)h(at)g(least)g(one)f(arc)g(in)h(each)555
2997 y(c)o(ycle)c(adv)n(ances)f(the)i(input)f(pointer)m(,)f(the)i
(parser)f(will)h(e)n(v)o(entually)e(run)h(of)n(f)g(the)g(end)g(of)h
(the)555 3102 y(sentence.)34 b(The)21 b(problem)f(arises)j(with)f(c)o
(ycles)g(which)f(don')o(t)f(adv)n(ance)h(the)g(input)h(pointer)-5
b(.)555 3207 y(Here)20 b(we)h(ha)n(v)o(e)e(tw)o(o)i(alternati)n(v)o
(es:)659 3394 y(1.)41 b(Use)32 b(the)f(slo)n(wer)m(,)i(correct)e
(nondeterministic)e(choice)h(operator)g(\(the)h(depth\255\002rst)763
3499 y(v)o(ersion)18 b(gi)n(v)o(en)h(on)h(page)g(396\).)659
3670 y(2.)41 b(Use)34 b(the)g(f)o(ast)g Fs(choose)p FA(,)h(and)e
(specify)g(that)h(it)g(is)h(an)f(error)e(to)i(de\002ne)f(netw)o(orks)
763 3775 y(containing)18 b(c)o(ycles)i(which)f(could)h(be)g(tra)n(v)o
(ersed)f(by)h(follo)n(wing)e(just)j(jump)e(arcs.)555
3962 y(The)h(code)f(de\002ned)h(in)g(Figure)f(23.3)g(tak)o(es)i(the)f
(second)f(approach.)680 4067 y(The)28 b(last)h(four)e(de\002nitions)h
(in)g(Figure)g(23.3)f(de\002ne)h(the)h(macros)f(used)g(to)g(read)g(and)
555 4171 y(set)f(re)o(gisters)f(within)g(arc)g(bodies.)47
b(In)26 b(this)h(program,)e(re)o(gister)h(sets)h(are)f(represented)f
(as)555 4276 y(assoc\255lists.)45 b(An)25 b Fr(A)-7 b(TN)25
b FA(deals)g(not)g(with)h(sets)g(of)f(re)o(gisters,)h(b)n(ut)f(sets)h
(of)f(sets)h(of)f(re)o(gisters.)555 4381 y(When)k(the)g(parser)f(mo)o
(v)o(es)g(do)n(wn)g(to)h(a)h(sub\255netw)o(ork,)e(it)i(gets)f(a)h
(clean)e(set)i(of)f(re)o(gisters)555 4485 y(pushed)20
b(on)g(top)g(of)h(the)g(e)o(xisting)f(ones.)30 b(Thus)21
b(the)f(whole)h(collection)e(of)i(re)o(gisters,)f(at)h(an)o(y)555
4590 y(gi)n(v)o(en)e(time,)h(is)h(a)g(list)g(of)f(assoc\255lists.)680
4694 y(The)c(prede\002ned)e(re)o(gister)i(operators)f(w)o(ork)h(on)h
(the)f(current,)g(or)g(topmost,)g(set)i(of)e(re)o(gis\255)555
4799 y(ters:)26 b Fs(getr)13 b FA(reads)g(a)g(re)o(gister;)h
Fs(setr)f FA(sets)g(one;)h(and)f Fs(pushr)g FA(pushes)g(a)g(v)n(alue)g
(into)g(one.)23 b(Both)-2786 b Fq(\016)555 4904 y Fs(getr)23
b FA(and)h Fs(pushr)e FA(use)j(the)f(primiti)n(v)o(e)f(re)o(gister)g
(manipulation)f(macro)h Fs(set-register)p FA(.)p eop
%%Page: 313 326
313 325 bop 555 538 a Ft(23.4)944 b Fu(AN)19 b(A)-7 b(TN)19
b(COMPILER)926 b FA(313)555 801 y(Note)23 b(that)f(re)o(gisters)h(don')
o(t)e(ha)n(v)o(e)h(to)h(be)f(declared.)36 b(If)22 b Fs(set-register)c
FA(is)24 b(sent)f(a)g(certain)555 905 y(name,)c(it)i(will)g(create)f(a)
h(re)o(gister)e(with)i(that)f(name.)680 1010 y(The)26
b(re)o(gister)h(operators)f(are)h(all)h(completely)e(nondestructi)n(v)o
(e.)47 b(Cons,)29 b(cons,)g(cons,)555 1114 y(says)22
b Fs(set-register)p FA(.)30 b(This)23 b(mak)o(es)e(them)h(slo)n(w)g
(and)g(generates)f(a)h(lot)g(of)g(garbage,)e(b)n(ut,)555
1219 y(as)e(e)o(xplained)e(on)h(page)g(261,)g(objects)g(used)g(in)h(a)g
(part)f(of)g(a)h(program)e(where)h(continuations)555
1324 y(are)h(made)g(should)f(not)h(be)g(destructi)n(v)o(ely)f
(modi\002ed.)27 b(An)18 b(object)g(in)h(one)e(thread)h(of)g(control)555
1428 y(may)23 b(be)g(shared)g(by)g(another)f(thread)h(which)f(is)j
(currently)d(suspended.)37 b(In)23 b(this)h(case,)h(the)555
1533 y(re)o(gisters)c(found)f(in)i(one)f(parse)g(will)h(share)f
(structure)g(with)h(the)f(re)o(gisters)g(in)h(man)o(y)e(of)i(the)555
1638 y(other)c(parses.)29 b(If)18 b(speed)h(became)f(an)g(issue,)i(we)f
(could)f(store)h(re)o(gisters)f(in)h(v)o(ectors)f(instead)555
1742 y(of)i(assoc\255lists,)h(and)e(rec)o(ycle)h(used)f(v)o(ectors)h
(into)g(a)g(common)f(pool.)680 1847 y(Push,)30 b(cat,)i(and)c(jump)g
(arcs)h(can)g(all)g(contain)f(bodies)h(of)f(e)o(xpressions.)54
b(Ordinarily)555 1951 y(these)15 b(will)i(be)e(just)h
Fs(setr)p FA(s.)26 b(By)16 b(calling)f Fs(compile-cmds)c
FA(on)k(their)g(bodies,)g(the)h(e)o(xpansion)555 2056
y(functions)j(of)h(these)g(arc)g(types)g(string)g(a)h(series)f(of)g
Fs(setr)p FA(s)g(into)g(a)g(single)g(e)o(xpression:)555
2239 y Fs(>)43 b(\(compile-cmds)38 b('\(\(setr)j(a)i(b\))g(\(setr)f(c)h
(d\)\)\))555 2338 y(\(SETR)f(A)h(B)g(\(SETR)e(C)j(D)f(REGS\)\))555
2526 y FA(Each)22 b(e)o(xpression)g(has)h(the)g(ne)o(xt)f(e)o
(xpression)f(inserted)h(as)i(its)g(last)g(ar)o(gument,)d(e)o(xcept)h
(the)555 2630 y(last,)29 b(which)d(gets)h Fs(regs)p FA(.)48
b(So)27 b(a)g(series)g(of)f(e)o(xpressions)g(in)h(the)f(body)g(of)g(an)
h(arc)f(will)i(be)555 2735 y(transformed)18 b(into)i(a)g(single)h(e)o
(xpression)d(returning)g(the)i(ne)n(w)g(re)o(gisters.)680
2840 y(This)d(approach)e(allo)n(ws)j(users)g(to)f(insert)h(arbitrary)e
(Lisp)h(code)g(into)g(the)g(bodies)g(of)g(arcs)555 2944
y(by)j(wrapping)e(it)j(in)f(a)h Fs(progn)p FA(.)28 b(F)o(or)19
b(e)o(xample:)555 3127 y Fs(>)43 b(\(compile-cmds)38
b('\(\(setr)j(a)i(b\))1340 3227 y(\(progn)e(\(princ)g("ek!"\)\))1340
3326 y(\(setr)g(c)i(d\)\)\))555 3426 y(\(SETR)f(A)h(B)g(\(PROGN)e
(\(PRINC)g("ek!"\))g(\(SETR)h(C)h(D)g(REGS\)\)\))680
3613 y FA(Certain)17 b(v)n(ariables)g(are)g(left)h(visible)f(to)h(code)
e(occurring)g(in)h(arc)g(bodies.)28 b(The)17 b(sentence)555
3718 y(will)29 b(be)g(in)f(the)h(global)f Fs(*sent*)p
FA(.)52 b(T)-7 b(w)o(o)29 b(le)o(xical)f(v)n(ariables)g(will)h(also)g
(be)f(visible:)46 b Fs(pos)p FA(,)555 3823 y(containing)24
b(the)j(current)e(input)g(pointer)m(,)h(and)g Fs(regs)p
FA(,)h(containing)d(the)i(current)f(re)o(gisters.)555
3927 y(This)j(is)i(another)c(e)o(xample)h(of)h(intentional)f(v)n
(ariable)g(capture.)53 b(If)28 b(it)h(were)f(desirable)f(to)555
4032 y(pre)n(v)o(ent)h(the)h(user)g(from)f(referring)g(to)h(these)h(v)n
(ariables,)g(the)o(y)f(could)f(be)h(replaced)f(with)555
4136 y(gensyms.)680 4241 y(The)13 b(macro)g Fs(with-parse)o(s)p
FA(,)8 b(de\002ned)13 b(in)g(Figure)g(23.5,)d(gi)n(v)o(es)j(us)g(a)g(w)
o(ay)g(of)g(in)m(v)n(oking)g(an)555 4346 y Fr(A)-7 b(TN)p
FA(.)28 b(It)19 b(should)e(be)i(called)f(with)g(the)h(name)e(of)i(a)f
(start)h(node,)f(an)g(e)o(xpression)f(to)h(be)h(parsed,)555
4450 y(and)j(a)h(body)f(of)g(code)g(describing)f(what)i(to)g(do)f(with)
h(the)g(returned)d(parses.)37 b(The)23 b(body)e(of)555
4555 y(code)15 b(within)g(a)h Fs(with-parses)c FA(e)o(xpression)i(will)
i(be)g(e)n(v)n(aluated)e(once)h(for)g(each)g(successful)555
4660 y(parse.)53 b(W)m(ithin)28 b(the)h(body)-5 b(,)28
b(the)g(symbol)g Fs(parse)f FA(will)i(be)f(bound)e(to)j(the)f(current)f
(parse.)555 4764 y(Super\002cially)e Fs(with-parses)d
FA(resembles)k(operators)e(lik)o(e)j Fs(dolist)p FA(,)e(b)n(ut)h
(underneath)e(it)555 4869 y(uses)19 b(backtracking)e(search)h(instead)h
(of)f(simple)h(iteration.)28 b(A)19 b Fs(with-parses)c
FA(e)o(xpression)555 4973 y(will)21 b(return)e Fs(@)p
FA(,)h(because)g(that')-5 b(s)20 b(what)g Fs(fail)f FA(returns)h(when)f
(it)i(runs)f(out)g(of)g(choices.)p eop
%%Page: 314 327
314 326 bop 555 538 a FA(314)920 b Fu(P)-5 b(ARSING)19
b(WITH)g(A)-7 b(TNS)p 555 745 2678 4 v 553 1968 4 1223
v 605 888 a Fs(\(defmacro)40 b(with-parses)f(\(node)i(sent)h(&body)g
(body\))692 988 y(\(with-gensyms)c(\(pos)k(regs\))779
1087 y(`\(progn)910 1187 y(\(setq)f(*sent*)h(,sent\))910
1287 y(\(setq)f(*paths*)g(nil\))910 1386 y(\(=bind)g(\(parse)g(,pos)h
(,regs\))f(\(,node)g(0)i('\(nil\)\))997 1486 y(\(if)f(\(=)h(,pos)f
(\(length)f(*sent*\)\))1171 1586 y(\(progn)h(,@body)f(\(fail\)\))1171
1685 y(\(fail\)\)\)\)\)\))1409 1889 y FA(Figure)19 b(23.5:)28
b(T)-7 b(ople)n(v)o(el)19 b(macro.)p 3231 1968 V 555
1971 2678 4 v 680 2195 a(Before)k(going)f(on)i(to)g(look)f(at)h(a)h
(more)e(representati)n(v)o(e)f Fr(A)-7 b(TN)p FA(,)24
b(let')-5 b(s)25 b(look)e(at)h(a)h(parsing)555 2300 y(generated)31
b(from)g(the)i(tin)o(y)f Fr(A)-7 b(TN)33 b FA(de\002ned)e(earlier)-5
b(.)67 b(The)32 b Fr(A)-7 b(TN)32 b FA(compiler)f(\(Figure)h(23.3\))555
2404 y(generates)21 b(code)g(which)h(calls)h Fs(types)d
FA(to)i(determine)f(the)h(grammatical)e(roles)i(of)g(a)g(w)o(ord,)555
2509 y(so)f(\002rst)g(we)f(ha)n(v)o(e)g(to)g(gi)n(v)o(e)f(it)i(some)f
(de\002nition:)555 2691 y Fs(\(defun)41 b(types)h(\(w\))642
2791 y(\(cdr)g(\(assoc)f(w)i('\(\(spot)e(noun\))h(\(runs)f
(verb\)\)\)\)\))555 2979 y FA(No)n(w)35 b(we)h(just)h(call)f
Fs(with-parses)31 b FA(with)36 b(the)f(name)g(of)h(the)f(start)h(node)f
(as)h(the)g(\002rst)555 3083 y(ar)o(gument:)555 3266
y Fs(>)43 b(\(with-parses)c(s)k('\(spot)e(runs\))729
3366 y(\(format)g(t)i("Parsing:)d(~A~\045")i(parse\)\))555
3465 y(Parsing:)e(\(SENTENCE)g(\(SUBJECT)g(SPOT\))i(\(VERB)f(RUNS\)\))
555 3565 y(@)555 3818 y Fw(23.5)99 b(A)25 b(Sample)g(A)-9
b(TN)555 4008 y FA(No)n(w)28 b(that)f(the)h(whole)f Fr(A)-7
b(TN)27 b FA(compiler)g(has)h(been)f(described,)h(we)g(can)f(go)g(on)h
(to)f(try)h(out)555 4113 y(some)e(parses)h(using)f(a)h(sample)f(netw)o
(ork.)47 b(In)27 b(order)e(to)i(mak)o(e)f(an)g Fr(A)-7
b(TN)27 b FA(parser)f(handle)f(a)555 4217 y(richer)18
b(v)n(ariety)h(of)f(sentences,)h(you)g(mak)o(e)f(the)h
Fr(A)-7 b(TN)p FA(s)20 b(themselv)o(es)e(more)g(complicated,)g(not)555
4322 y(the)24 b Fr(A)-7 b(TN)24 b FA(compiler)-5 b(.)39
b(The)24 b(compiler)e(presented)h(here)g(is)i(a)f(to)o(y)g(mainly)f(in)
h(the)g(sense)g(that)555 4427 y(it')-5 b(s)21 b(slo)n(w)-5
b(,)20 b(not)g(in)g(the)h(sense)f(of)g(ha)n(ving)f(limited)h(po)n(wer)
-5 b(.)680 4531 y(The)27 b(po)n(wer)f(\(as)i(distinct)g(from)f(speed\))
g(of)g(a)h(parser)f(is)h(in)g(the)g(grammar)m(,)f(and)g(here)555
4636 y(limited)19 b(space)g(really)f(will)i(force)e(us)h(to)g(use)g(a)g
(to)o(y)g(v)o(ersion.)27 b(Figures)19 b(23.8)f(through)e(23.11)555
4740 y(de\002ne)25 b(the)g Fr(A)-7 b(TN)25 b FA(\(or)f(set)i(of)f
Fr(A)-7 b(TN)p FA(s\))25 b(represented)f(in)h(Figure)f(23.6.)44
b(This)25 b(netw)o(ork)f(is)i(just)555 4845 y(big)21
b(enough)e(to)j(yield)f(se)n(v)o(eral)g(parsings)f(for)h(the)g(classic)
i(parser)d(fodder)g(\223T)m(ime)h(\003ies)h(lik)o(e)555
4950 y(an)e(arro)n(w)-5 b(.)f(\224)p eop
%%Page: 315 328
315 327 bop 555 538 a Ft(23.5)999 b Fu(A)19 b(SAMPLE)f(A)-7
b(TN)982 b FA(315)p 555 745 2678 4 v 553 2945 4 2200
v 605 2751 a @beginspecial @setspecial @endspecial 1290
2867 a(Figure)20 b(23.6:)28 b(Graph)19 b(of)h(a)h(lar)o(ger)e(A)-9
b(TN.)p 3231 2945 V 555 2948 2678 4 v 555 3075 V 553
4397 4 1322 v 605 3218 a Fs(\(defun)41 b(types)g(\(word\))692
3318 y(\(case)h(word)779 3418 y(\(\(do)g(does)g(did\))g('\(aux)f(v\)\))
779 3517 y(\(\(time)g(times\))g('\(n)i(v\)\))779 3617
y(\(\(fly)f(flies\))f('\(n)h(v\)\))779 3716 y(\(\(like\))f('\(v)h
(prep\)\))779 3816 y(\(\(liked)f(likes\))g('\(v\)\))779
3916 y(\(\(a)i(an)f(the\))g('\(det\)\))779 4015 y(\(\(arrow)f(arrows\))
g('\(n\)\))779 4115 y(\(\(i)i(you)f(he)h(she)f(him)g(her)h(it\))f
('\(pron\)\)\)\))1344 4319 y FA(Figure)20 b(23.7:)28
b(Nominal)19 b(dictionary)-5 b(.)p 3231 4397 V 555 4401
2678 4 v 680 4625 a(W)e(e)15 b(need)e(a)h(slightly)g(lar)o(ger)f
(dictionary)f(to)i(parse)g(more)f(comple)o(x)f(input.)27
b(The)13 b(function)555 4729 y Fs(types)19 b FA(\(Figure)h(23.7\))g
(pro)o(vides)f(a)i(dictionary)e(of)i(the)g(most)g(primiti)n(v)o(e)f
(sort.)31 b(It)21 b(de\002nes)g(a)555 4834 y(22\255w)o(ord)h(v)n(ocab)n
(ulary)-5 b(,)21 b(and)i(associates)h(each)f(w)o(ord)g(with)h(a)g(list)
h(of)e(one)g(or)g(more)g(simple)555 4939 y(grammatical)c(roles.)p
eop
%%Page: 316 329
316 328 bop 555 538 a FA(316)920 b Fu(P)-5 b(ARSING)19
b(WITH)g(A)-7 b(TNS)p 555 745 2678 4 v 553 1868 4 1123
v 605 888 a Fs(\(defnode)40 b(mods)692 988 y(\(cat)i(n)h(mods/n)779
1087 y(\(setr)f(mods)g(*\)\)\))605 1287 y(\(defnode)e(mods/n)692
1386 y(\(cat)i(n)h(mods/n)779 1486 y(\(pushr)e(mods)h(*\)\))692
1586 y(\(up)g(`\(n-group)e(,\(getr)h(mods\)\)\)\))1059
1790 y FA(Figure)20 b(23.8:)28 b(Sub\255netw)o(ork)18
b(for)h(strings)i(of)f(modi\002ers.)p 3231 1868 V 555
1871 2678 4 v 680 2082 a(The)h(components)f(of)h(an)h
Fr(A)-7 b(TN)22 b FA(are)g(themselv)o(es)f Fr(A)-7 b(TN)p
FA(s.)34 b(The)21 b(smallest)i Fr(A)-7 b(TN)22 b FA(in)g(our)f(set)555
2186 y(is)h(the)f(one)g(in)g(Figure)f(23.8.)31 b(It)21
b(parses)g(strings)g(of)g(modi\002ers,)f(which)h(in)g(this)g(case)h
(means)555 2291 y(just)28 b(strings)f(of)g(nouns.)49
b(The)26 b(\002rst)i(node,)g Fs(mods)p FA(,)g(accepts)f(a)g(noun.)49
b(The)27 b(second)f(node,)555 2396 y Fs(mods/n)p FA(,)18
b(can)i(either)g(look)f(for)h(more)f(nouns,)g(or)h(return)f(a)i
(parsing.)680 2500 y(Section)e(3.4)f(e)o(xplained)g(ho)n(w)h(writing)f
(programs)g(in)i(a)f(functional)f(style)i(mak)o(es)f(them)555
2605 y(easier)h(to)h(test:)659 2775 y(1.)41 b(In)19 b(a)i(functional)d
(program,)g(components)g(can)i(be)g(tested)h(indi)n(vidually)-5
b(.)659 2940 y(2.)41 b(In)19 b(Lisp,)i(functions)d(can)i(be)g(tested)h
(interacti)n(v)o(ely)-5 b(,)18 b(in)i(the)g(tople)n(v)o(el)f(loop.)555
3110 y(T)-7 b(ogether)33 b(these)i(tw)o(o)g(principles)f(allo)n(w)g
Ft(inter)o(active)g(de)o(velopment:)56 b FA(when)34 b(we)h(write)555
3215 y(functional)18 b(programs)h(in)h(Lisp,)g(we)h(can)f(test)h(each)f
(piece)g(as)h(we)f(write)g(it.)680 3319 y(A)-7 b Fr(TN)p
FA(s)18 b(are)h(so)g(lik)o(e)g(functional)e(programs\227in)g(this)i
(implementation,)e(the)o(y)h(macroe)o(x\255)555 3424
y(pand)29 b Ft(into)h FA(functional)f(programs\227that)f(the)i
(possibility)g(of)g(interacti)n(v)o(e)f(de)n(v)o(elopment)555
3529 y(applies)d(to)g(them)f(as)i(well.)47 b(W)-7 b(e)27
b(can)f(test)g(an)g Fr(A)-7 b(TN)26 b FA(starting)f(from)g(an)o(y)g
(node,)h(simply)g(by)555 3633 y(gi)n(ving)19 b(its)i(name)f(as)h(the)f
(\002rst)h(ar)o(gument)d(to)i Fs(with-parses)p FA(:)555
3799 y Fs(>)43 b(\(with-parses)c(mods)j('\(time)f(arrow\))729
3899 y(\(format)g(t)i("Parsing:)d(~A~\045")i(parse\)\))555
3998 y(Parsing:)e(\(N-GROUP)h(\(ARROW)g(TIME\)\))555
4098 y(@)680 4268 y FA(The)13 b(ne)o(xt)g(tw)o(o)g(netw)o(orks)g(ha)n
(v)o(e)g(to)g(b)o(e)g(d)o(iscussed)g(tog)o(ether)l(,)8
b(because)13 b(the)o(y)g(are)g(mutually)555 4373 y(recursi)n(v)o(e.)44
b(The)25 b(netw)o(ork)f(de\002ned)h(in)g(Figure)g(23.9,)h(which)f(be)o
(gins)f(with)i(the)g(node)e Fs(np)p FA(,)555 4478 y(is)37
b(used)f(to)g(parse)g(noun)f(phrases.)76 b(The)36 b(netw)o(ork)f
(de\002ned)g(in)i(Figure)e(23.10)g(parses)555 4582 y(prepositional)20
b(phrases.)36 b(Noun)21 b(phrases)h(may)g(contain)f(prepositional)g
(phrases)h(and)g(vice)555 4687 y(v)o(ersa,)d(so)i(the)f(tw)o(o)h(netw)o
(orks)e(each)h(contain)f(a)i(push)e(arc)h(which)g(calls)h(the)f(other)
-5 b(.)680 4791 y(The)28 b(noun)g(phrase)g(netw)o(ork)g(contains)h(six)
g(nodes.)55 b(The)29 b(\002rst)h(node,)g Fs(np)f FA(has)g(three)555
4896 y(choices.)j(If)21 b(it)h(reads)f(a)h(pronoun,)d(then)h(it)i(can)g
(mo)o(v)o(e)d(to)j(node)e Fs(pron)p FA(,)g(which)h(pops)g(out)g(of)555
5001 y(the)f(netw)o(ork:)p eop
%%Page: 317 330
317 329 bop 555 538 a Ft(23.5)999 b Fu(A)19 b(SAMPLE)f(A)-7
b(TN)982 b FA(317)p 555 745 2678 4 v 553 4359 4 3614
v 605 888 a Fs(\(defnode)40 b(np)692 988 y(\(cat)i(det)g(np/det)779
1087 y(\(setr)g(det)g(*\)\))692 1187 y(\(jump)g(np/det)779
1287 y(\(setr)g(det)g(nil\)\))692 1386 y(\(cat)g(pron)85
b(pron)779 1486 y(\(setr)42 b(n)h(*\)\)\))605 1685 y(\(defnode)d(pron)
692 1785 y(\(up)i(`\(np)g(\(pronoun)f(,\(getr)g(n\)\)\)\)\))605
1984 y(\(defnode)f(np/det)692 2084 y(\(down)i(mods)f(np/mods)779
2183 y(\(setr)h(mods)g(*\)\))692 2283 y(\(jump)g(np/mods)779
2383 y(\(setr)g(mods)g(nil\)\)\))605 2582 y(\(defnode)e(np/mods)692
2681 y(\(cat)i(n)h(np/n)779 2781 y(\(setr)f(n)h(*\)\)\))605
2980 y(\(defnode)d(np/n)692 3080 y(\(up)i(`\(np)g(\(det)g(,\(getr)f
(det\)\))1084 3180 y(\(modifiers)f(,\(getr)h(mods\)\))1084
3279 y(\(noun)h(,\(getr)f(n\)\)\)\))692 3379 y(\(down)h(pp)g(np/pp)779
3478 y(\(setr)g(pp)g(*\)\)\))605 3678 y(\(defnode)e(np/pp)692
3777 y(\(up)i(`\(np)g(\(det)g(,\(getr)f(det\)\))1084
3877 y(\(modifiers)f(,\(getr)h(mods\)\))1084 3977 y(\(noun)h(,\(getr)f
(n\)\))1084 4076 y(,\(getr)g(pp\)\)\)\))1237 4280 y FA(Figure)19
b(23.9:)29 b(Noun)19 b(phrase)g(sub\255netw)o(ork.)p
3231 4359 V 555 4362 2678 4 v 555 4586 a Fs(>)43 b(\(with-parses)c(np)k
('\(it\))729 4686 y(\(format)e(t)i("Parsing:)d(~A~\045")i(parse\)\))555
4785 y(Parsing:)e(\(NP)j(\(PRONOUN)d(IT\)\))555 4885
y(@)p eop
%%Page: 318 331
318 330 bop 555 538 a FA(318)920 b Fu(P)-5 b(ARSING)19
b(WITH)g(A)-7 b(TNS)p 555 745 2678 4 v 553 2167 4 1422
v 605 888 a Fs(\(defnode)40 b(pp)692 988 y(\(cat)i(prep)g(pp/prep)779
1087 y(\(setr)g(prep)g(*\)\)\))605 1287 y(\(defnode)e(pp/prep)692
1386 y(\(down)i(np)g(pp/np)779 1486 y(\(setr)g(op)g(*\)\)\))605
1685 y(\(defnode)e(pp/np)692 1785 y(\(up)i(`\(pp)g(\(prep)g(,\(getr)f
(prep\)\))1084 1884 y(\(obj)h(,\(getr)f(op\)\)\)\)\))1089
2089 y FA(Figure)20 b(23.10:)28 b(Prepositional)19 b(phrase)g
(sub\255netw)o(ork.)p 3231 2167 V 555 2170 2678 4 v 555
2394 a(Both)i(the)f(other)g(arcs)h(lead)f(to)h(node)e
Fs(np/det)p FA(:)28 b(one)20 b(arc)h(reads)f(a)h(determiner)e(\(e.g.)g
(\223the\224\),)555 2499 y(and)28 b(the)h(other)f(arc)g(simply)h
(jumps,)h(reading)d(no)h(input.)54 b(At)29 b(node)f Fs(np/det)p
FA(,)g(both)g(arcs)555 2603 y(lead)20 b(to)h Fs(np/mods)p
FA(;)e Fs(np/det)f FA(has)j(the)g(option)e(of)i(pushing)e(to)h
(sub\255netw)o(ork)f Fs(mods)g FA(to)i(pick)555 2708
y(up)g(a)i(string)e(of)h(modi\002ers,)f(or)h(jumping.)32
b(Node)22 b Fs(np-mods)d FA(reads)j(a)g(noun)e(and)i(continues)555
2813 y(to)27 b Fs(np/n)p FA(.)47 b(This)27 b(node)e(can)h(either)h(pop)
e(a)i(result,)h(or)e(push)g(to)h(the)g(prepositional)d(phrase)555
2917 y(netw)o(ork)f(to)i(try)f(to)g(pick)g(up)g(a)g(prepositional)f
(phrase.)40 b(The)24 b(\002nal)h(node,)f Fs(np/pp)p FA(,)f(pops)h(a)555
3022 y(result.)680 3126 y(Dif)n(ferent)c(types)h(of)g(noun)f(phrases)h
(will)h(ha)n(v)o(e)f(dif)n(ferent)e(parse)i(paths.)33
b(Here)21 b(are)g(tw)o(o)555 3231 y(parsings)e(on)h(the)g(noun)f
(phrase)h(netw)o(ork:)555 3413 y Fs(>)43 b(\(with-parses)c(np)k
('\(arrows\))729 3513 y(\(pprint)e(parse\)\))555 3613
y(\(NP)h(\(DET)g(NIL\))729 3712 y(\(MODIFIERS)e(NIL\))729
3812 y(\(NOUN)i(ARROWS\)\))555 3912 y(@)555 4011 y(>)h(\(with-parses)c
(np)k('\(a)f(time)g(fly)g(like)g(him\))729 4111 y(\(pprint)f(parse\)\))
555 4210 y(\(NP)h(\(DET)g(A\))729 4310 y(\(MODIFIERS)e(\(N-GROUP)g
(TIME\)\))729 4410 y(\(NOUN)i(FLY\))729 4509 y(\(PP)h(\(PREP)e(LIKE\))
904 4609 y(\(OBJ)h(\(NP)g(\(PRONOUN)e(HIM\)\)\)\)\))555
4709 y(@)555 4896 y FA(The)35 b(\002rst)i(parse)e(succeeds)h(by)f
(jumping)f(to)i Fs(np/det)p FA(,)h(jumping)e(again)f(to)i
Fs(np/mods)p FA(,)555 5001 y(reading)19 b(a)j(noun,)d(then)h(popping)f
(at)i Fs(np/n)p FA(.)30 b(The)21 b(second)f(ne)n(v)o(er)f(jumps,)h
(pushing)g(\002rst)h(for)p eop
%%Page: 319 332
319 331 bop 555 538 a Ft(23.5)999 b Fu(A)19 b(SAMPLE)f(A)-7
b(TN)982 b FA(319)p 555 745 2678 4 v 553 3960 4 3215
v 605 888 a Fs(\(defnode)40 b(s)692 988 y(\(down)i(np)g(s/subj)779
1087 y(\(setr)g(mood)g('decl\))779 1187 y(\(setr)g(subj)g(*\)\))692
1287 y(\(cat)g(v)h(v)779 1386 y(\(setr)f(mood)g('imp\))779
1486 y(\(setr)g(subj)g('\(np)g(\(pron)f(you\)\)\))779
1586 y(\(setr)h(aux)g(nil\))779 1685 y(\(setr)g(v)h(*\)\)\))605
1884 y(\(defnode)d(s/subj)692 1984 y(\(cat)i(v)h(v)779
2084 y(\(setr)f(aux)g(nil\))779 2183 y(\(setr)g(v)h(*\)\)\))605
2383 y(\(defnode)d(v)692 2482 y(\(up)i(`\(s)h(\(mood)e(,\(getr)g
(mood\)\))1041 2582 y(\(subj)g(,\(getr)g(subj\)\))1041
2681 y(\(vcl)h(\(aux)g(,\(getr)f(aux\)\))1259 2781 y(\(v)h(,\(getr)f
(v\)\)\)\)\))692 2881 y(\(down)h(np)g(s/obj)779 2980
y(\(setr)g(obj)g(*\)\)\))605 3180 y(\(defnode)e(s/obj)692
3279 y(\(up)i(`\(s)h(\(mood)e(,\(getr)g(mood\)\))1041
3379 y(\(subj)g(,\(getr)g(subj\)\))1041 3478 y(\(vcl)h(\(aux)g(,\(getr)
f(aux\)\))1259 3578 y(\(v)h(,\(getr)f(v\)\)\))1041 3678
y(\(obj)h(,\(getr)f(obj\)\)\)\)\))1349 3882 y FA(Figure)19
b(23.11:)28 b(Sentence)20 b(netw)o(ork.)p 3231 3960 V
555 3963 2678 4 v 555 4188 a(a)26 b(string)f(of)h(modi\002ers,)g(and)f
(again)g(for)g(a)h(prepositional)e(phrase.)44 b(As)27
b(is)g(often)d(the)i(case)555 4292 y(with)c(parsers,)g(e)o(xpressions)f
(which)g(are)h(syntactically)f(well\255formed)f(are)i(such)g(nonsense)
555 4397 y(semantically)k(that)h(it')-5 b(s)27 b(dif)n(\002cult)f(for)g
(humans)g(e)n(v)o(en)g(to)g(detect)h(the)f(syntactic)h(structure.)555
4501 y(Here)c(the)h(noun)e(phrase)h(\223a)h(time)f(\003y)h(lik)o(e)g
(him\224)f(has)h(the)g(same)f(form)g(as)h(\223a)g(Lisp)g(hack)o(er)555
4606 y(lik)o(e)c(him.)-6 b(\224)680 4711 y(No)n(w)16
b(all)h(we)f(need)g(is)h(a)g(netw)o(ork)e(for)h(recognizing)e(sentence)
i(structure.)27 b(The)16 b(netw)o(ork)555 4815 y(sho)n(wn)29
b(in)h(Figure)f(23.11)f(parses)i(both)f(commands)f(and)i(statements.)58
b(The)29 b(start)i(node)555 4920 y(is)f(con)m(v)o(entionally)25
b(called)j Fs(s)p FA(.)55 b(The)28 b(\002rst)i(node)d(lea)n(ving)h(it)i
(pushes)e(for)g(a)h(noun)f(phrase,)p eop
%%Page: 320 333
320 332 bop 555 538 a FA(320)920 b Fu(P)-5 b(ARSING)19
b(WITH)g(A)-7 b(TNS)p 555 745 2678 4 v 553 3562 4 2817
v 605 888 a Fs(>)43 b(\(with-parses)c(s)k('\(time)e(flies)g(like)h(an)h
(arrow\))779 988 y(\(pprint)e(parse\)\))605 1187 y(\(S)i(\(MOOD)e
(DECL\))736 1287 y(\(SUBJ)g(\(NP)h(\(DET)g(NIL\))1171
1386 y(\(MODIFIERS)e(\(N-GROUP)g(TIME\)\))1171 1486 y(\(NOUN)i
(FLIES\)\)\))736 1586 y(\(VCL)g(\(AUX)f(NIL\))954 1685
y(\(V)h(LIKE\)\))736 1785 y(\(OBJ)g(\(NP)g(\(DET)g(AN\))1128
1884 y(\(MODIFIERS)d(NIL\))1128 1984 y(\(NOUN)i(ARROW\)\)\)\))605
2183 y(\(S)i(\(MOOD)e(IMP\))736 2283 y(\(SUBJ)g(\(NP)h(\(PRON)g
(YOU\)\)\))736 2383 y(\(VCL)g(\(AUX)f(NIL\))954 2482
y(\(V)h(TIME\)\))736 2582 y(\(OBJ)g(\(NP)g(\(DET)g(NIL\))1128
2681 y(\(MODIFIERS)d(NIL\))1128 2781 y(\(NOUN)i(FLIES\))1128
2881 y(\(PP)h(\(PREP)g(LIKE\))1302 2980 y(\(OBJ)g(\(NP)g(\(DET)g(AN\))
1694 3080 y(\(MODIFIERS)e(NIL\))1694 3180 y(\(NOUN)i
(ARROW\)\)\)\)\)\)\))605 3279 y(@)1183 3483 y FA(Figure)19
b(23.12:)28 b(T)-7 b(w)o(o)20 b(parsings)g(for)f(a)i(sentence.)p
3231 3562 V 555 3565 2678 4 v 555 3789 a(which)g(will)i(be)f(the)g
(subject)g(of)g(the)g(sentence.)34 b(The)21 b(second)g(outgoing)f(arc)i
(reads)g(a)g(v)o(erb)m(.)555 3894 y(When)f(a)h(sentence)e(is)i
(syntactically)f(ambiguous,)e(both)h(arcs)i(could)e(succeed,)g
(ultimately)555 3998 y(yielding)g(tw)o(o)i(or)f(more)g(parsings,)g(as)h
(in)g(Figure)f(23.12.)31 b(The)21 b(\002rst)h(parsing)f(is)h(analogous)
555 4103 y(to)c(\223Island)f(nations)g(lik)o(e)h(a)h(na)n(vy)-5
b(,)f(\224)17 b(and)g(the)h(second)f(is)h(analogous)e(to)i(\223Find)g
(someone)e(lik)o(e)555 4207 y(a)j(policeman.)-6 b(\224)26
b(More)18 b(comple)o(x)e Fr(A)-7 b(TN)p FA(s)18 b(are)g(able)g(to)h
(\002nd)e(six)i(or)f(more)f(parsings)g(for)h(\223T)m(ime)555
4312 y(\003ies)j(lik)o(e)g(an)f(arro)n(w)-5 b(.)f(\224)680
4417 y(The)17 b Fr(A)-7 b(TN)18 b FA(compiler)f(in)i(this)g(chapter)e
(is)i(presented)e(more)h(as)h(a)f(distillation)g(of)g(the)h(idea)555
4521 y(of)j(an)h Fr(A)-7 b(TN)22 b FA(than)g(as)h(production)d(softw)o
(are.)36 b(A)23 b(fe)n(w)f(ob)o(vious)f(changes)g(w)o(ould)h(mak)o(e)g
(this)555 4626 y(code)17 b(much)g(more)g(ef)n(\002cient.)28
b(When)18 b(speed)g(is)h(important,)d(the)i(whole)g(idea)g(of)f
(simulating)555 4730 y(nondeterminism)22 b(with)k(closures)e(may)h(be)g
(too)g(slo)n(w)-5 b(.)43 b(But)26 b(when)e(it)i(isn')o(t)f(essential,)i
(the)555 4835 y(programming)17 b(techniques)i(described)f(here)i(lead)g
(to)h(v)o(ery)e(concise)g(programs.)p eop
%%Page: 321 334
321 333 bop 555 1610 a Fn(24)p 555 1872 2686 3 v 555
2131 a Fx(Pr)m(olog)555 2568 y FA(This)18 b(chapter)f(describes)g(ho)n
(w)g(to)h(write)g(Prolog)f(as)i(an)e(embedded)f(language.)27
b(Chapter)17 b(19)555 2672 y(sho)n(wed)24 b(ho)n(w)g(to)g(write)h(a)g
(program)e(which)h(answered)f(comple)o(x)g(queries)h(on)g(databases.)
555 2777 y(Here)18 b(we)g(add)g(one)f(ne)n(w)h(ingredient:)26
b(rules,)18 b(which)g(mak)o(e)f(it)i(possible)f(to)g(infer)f(f)o(acts)i
(from)555 2882 y(those)g(already)g(kno)n(wn.)27 b(A)20
b(set)h(of)e(rules)h(de\002nes)f(a)h(tree)g(of)f(implications.)28
b(In)19 b(order)g(to)g(use)555 2986 y(rules)i(which)g(w)o(ould)g
(otherwise)f(imply)h(an)g(unlimited)g(number)e(of)i(f)o(acts,)h(we)g
(will)g(search)555 3091 y(this)f(implication)e(tree)h
(nondeterministically)-5 b(.)680 3195 y(Prolog)25 b(mak)o(es)h(an)h(e)o
(xcellent)e(e)o(xample)h(of)g(an)g(embedded)f(language.)46
b(It)27 b(combines)555 3300 y(three)33 b(ingredients:)53
b(pattern\255matching,)33 b(nondeterminism,)g(and)g(rules.)67
b(Chapters)33 b(18)555 3405 y(and)e(22)f(gi)n(v)o(e)h(us)g(the)g
(\002rst)h(tw)o(o)g(independently)-5 b(.)58 b(By)32 b(b)n(uilding)e
(Prolog)g(on)h(top)g(of)g(the)555 3509 y(pattern\255matching)16
b(and)j(nondeterministic)d(choice)j(operators)f(we)h(ha)n(v)o(e)g
(already)-5 b(,)17 b(we)j(will)555 3614 y(ha)n(v)o(e)i(an)g(e)o(xample)
e(of)i(a)h(real,)f(multi\255layer)f(bottom\255up)f(system.)35
b(Figure)21 b(24.1)g(sho)n(ws)i(the)555 3718 y(layers)d(of)g
(abstraction)f(in)m(v)n(olv)o(ed.)680 3823 y(The)k(secondary)g(aim)h
(of)g(this)h(chapter)e(is)i(to)g(study)e(Prolog)g(itself.)42
b(F)o(or)24 b(e)o(xperienced)555 3928 y(programmers,)f(the)i(most)f
(con)m(v)o(enient)f(e)o(xplanation)f(of)j(Prolog)e(may)i(be)f(a)h(sk)o
(etch)g(of)g(its)555 4032 y(implementation.)63 b(Writing)33
b(Prolog)e(in)h(Lisp)h(is)g(particularly)e(interesting,)j(because)e(it)
555 4137 y(brings)19 b(out)h(the)g(similarities)h(between)f(the)g(tw)o
(o)g(languages.)555 4390 y Fw(24.1)99 b(Concepts)555
4580 y FA(Chapter)20 b(19)g(sho)n(wed)f(ho)n(w)h(to)h(write)f(a)h
(database)f(system)h(which)f(w)o(ould)f(accept)h(comple)o(x)555
4685 y(queries)g(containing)e(v)n(ariables,)i(and)g(generate)f(all)i
(the)g(bindings)e(which)h(made)f(the)i(query)555 4789
y(true)c(in)g(the)g(database.)27 b(In)17 b(the)g(follo)n(wing)f(e)o
(xample,)g(\(after)g(calling)h Fs(clear-db)p FA(\))d(we)j(assert)555
4894 y(tw)o(o)j(f)o(acts)h(and)f(then)f(query)g(the)h(database:)1835
5229 y(321)p eop
%%Page: 322 335
322 334 bop 555 538 a FA(322)1098 b Fu(PR)n(OLOG)p 555
745 2678 4 v 553 1745 4 1000 v 605 1551 a @beginspecial
@setspecial @endspecial 1315 1667 a FA(Figure)19 b(24.1:)29
b(Layers)19 b(of)h(abstraction.)p 3231 1745 V 555 1748
2678 4 v 555 1969 a Fs(>)43 b(\(fact)f(painter)e(reynolds\))555
2069 y(\(REYNOLDS\))555 2168 y(>)j(\(fact)f(painter)e(gainsborough\))
555 2268 y(\(GAINSBOROUGH\))555 2368 y(>)j(\(with-answer)c(\(painter)h
(?x\))729 2467 y(\(print)h(?x\)\))555 2567 y(GAINSBOROUGH)555
2666 y(REYNOLDS)555 2766 y(NIL)555 2950 y FA(Conceptually)-5
b(,)26 b(Prolog)f(is)j(the)e(database)g(program)f(with)h(the)h
(addition)e(of)i Ft(rules,)h FA(which)555 3054 y(mak)o(e)18
b(it)i(possible)e(to)h(satisfy)g(a)g(query)f(not)g(just)h(by)g(looking)
e(it)i(up)f(in)h(the)g(database,)f(b)n(ut)h(by)555 3159
y(inferring)f(it)j(from)e(other)h(kno)n(wn)e(f)o(acts.)30
b(F)o(or)20 b(e)o(xample,)e(if)j(we)f(ha)n(v)o(e)g(a)h(rule)e(lik)o(e:)
555 3368 y(If)145 b Fs(\(hungry)40 b(?x\))20 b FA(and)f
Fs(\(smells-of)40 b(?x)j(turpentine\))555 3473 y FA(Then)29
b Fs(\(painter)40 b(?x\))555 3682 y FA(then)17 b(the)g(query)f
Fs(\(painter)40 b(?x\))17 b FA(will)h(be)g(satis\002ed)g(for)e
Fs(?x)h FA(=)h Fs(raoul)e FA(when)h(the)g(database)555
3787 y(contains)26 b(both)f Fs(\(hungry)41 b(raoul\))24
b FA(and)i Fs(\(smells-of)39 b(raoul)j(turpentine\))p
FA(,)24 b(e)n(v)o(en)555 3891 y(if)c(it)h(doesn')o(t)e(contain)g
Fs(\(painter)41 b(raoul\))p FA(.)680 3996 y(In)23 b(Prolog,)h(the)f
(if\255part)g(of)h(a)g(rule)g(is)g(called)g(the)g Ft(body)-5
b(,)24 b FA(and)f(the)h(then\255part)e(the)i Ft(head.)555
4101 y FA(\(In)e(logic,)i(the)f(names)f(are)i Ft(antecedent)d
FA(and)h Ft(consequent,)g FA(b)n(ut)h(it)h(is)g(just)g(as)f(well)h(to)f
(ha)n(v)o(e)555 4205 y(separate)31 b(names,)i(to)e(emphasize)f(that)h
(Prolog)f(inference)f(is)j(not)f(the)g(same)g(as)h(logical)555
4310 y(implication.\))39 b(When)23 b(trying)g(to)h(establish)g
(bindings)2160 4280 y Fm(1)2216 4310 y FA(for)f(a)i(query)-5
b(,)22 b(the)i(program)e(looks)555 4414 y(\002rst)e(at)g(the)f(head)f
(of)h(a)h(rule.)28 b(If)19 b(the)g(head)g(matches)f(the)h(query)f(that)
h(the)h(program)d(is)j(trying)555 4519 y(to)f(answer)m(,)g(the)g
(program)e(will)i(then)g(try)g(to)g(establish)g(bindings)f(for)g(the)i
(body)d(of)i(the)g(rule.)555 4624 y(Bindings)h(which)f(satisfy)i(the)f
(body)f(will,)i(by)e(de\002nition,)g(satisfy)i(the)f(head.)680
4728 y(The)d(f)o(acts)h(used)g(in)f(the)h(body)f(of)g(the)h(rule)f(may)
g(in)h(turn)f(be)h(inferred)e(from)h(other)g(rules:)p
555 4839 1074 4 v 645 4894 a Fl(1)675 4918 y Fr(Man)o(y)26
b(of)f(the)i(concepts)g(used)f(in)g(this)g(chapter)m(,)k(including)e
(this)e(sense)g(of)g(bindings,)j(are)d(e)o(xplained)i(in)555
5001 y(Section)19 b(18.4.)p eop
%%Page: 323 336
323 335 bop 555 538 a Ft(24.2)963 b Fu(AN)19 b(INTERPRETER)944
b FA(323)555 801 y(If)145 b Fs(\(gaunt)41 b(?x\))19 b
FA(or)h Fs(\(eats-ravenously)37 b(?x\))555 905 y FA(Then)29
b Fs(\(hungry)40 b(?x\))555 1113 y FA(and)20 b(rules)g(may)g(be)g
(recursi)n(v)o(e,)e(as)j(in:)555 1321 y(If)145 b Fs(\(surname)40
b(?f)j(?n\))19 b FA(and)h Fs(\(father)40 b(?f)j(?c\))555
1426 y FA(Then)29 b Fs(\(surname)40 b(?c)j(?n\))680 1634
y FA(Prolog)23 b(will)h(be)g(able)g(to)h(establish)f(bindings)f(for)g
(a)i(query)d(if)j(it)f(can)g(\002nd)g(some)g(path)555
1739 y(through)j(the)h(rules)h(which)f(leads)h(e)n(v)o(entually)e(to)h
(kno)n(wn)f(f)o(acts.)56 b(So)28 b(it)i(is)f(essentially)g(a)555
1843 y(search)e(engine:)43 b(it)28 b(tra)n(v)o(erses)f(the)h(tree)f(of)
g(logical)g(implications)g(formed)e(by)i(the)h(rules,)555
1948 y(looking)18 b(for)i(a)h(successful)f(path.)680
2052 y(Though)c(rules)i(and)g(f)o(acts)h(sound)e(lik)o(e)i(distinct)f
(types)g(of)g(objects,)h(the)o(y)e(are)i(conceptu\255)555
2157 y(ally)j(interchangeable.)30 b(Rules)23 b(can)e(be)g(seen)h(as)g
(virtual)f(f)o(acts.)34 b(If)22 b(we)g(w)o(ant)f(our)g(database)555
2262 y(to)h(re\003ect)g(the)g(disco)o(v)o(ery)d(that)j(big,)g(\002erce)
f(animals)h(are)g(rare,)f(we)h(could)f(look)g(for)g(all)i(the)555
2366 y Ft(x)h FA(such)f(that)g(there)g(are)g(f)o(acts)h
Fs(\(species)41 b Ft(x)p Fs(\))p FA(,)23 b Fs(\(big)42
b Ft(x)p Fs(\))p FA(,)24 b(and)f Fs(\(fierce)41 b Ft(x)p
Fs(\))p FA(,)24 b(and)e(add)h(a)555 2471 y(ne)n(w)d(f)o(act)g
Fs(\(rare)42 b Ft(x)p Fs(\))p FA(.)29 b(Ho)n(we)n(v)o(er)m(,)18
b(by)i(de\002ning)f(a)h(rule)g(to)h(say)555 2679 y(If)145
b Fs(\(species)40 b(?x\))19 b FA(and)h Fs(\(big)42 b(?x\))19
b FA(and)h Fs(\(fierce)41 b(?x\))555 2784 y FA(Then)29
b Fs(\(rare)41 b(?x\))555 2992 y FA(we)27 b(get)h(the)f(same)g(ef)n
(fect,)h(without)e(actually)h(ha)n(ving)f(to)h(add)g(all)h(the)f
Fs(\(rare)41 b Ft(x)p Fs(\))27 b FA(to)h(the)555 3096
y(database.)g(W)-7 b(e)19 b(can)e(e)n(v)o(en)g(de\002ne)h(rules)f
(which)h(imply)f(an)h(in\002nite)f(number)g(of)g(f)o(acts.)29
b(Thus)555 3201 y(rules)19 b(mak)o(e)g(the)g(database)g(smaller)g(at)h
(the)g(e)o(xpense)e(of)h(e)o(xtra)f(processing)g(when)h(it)h(comes)555
3305 y(time)g(to)h(answer)f(questions.)680 3410 y(F)o(acts,)31
b(meanwhile,)e(are)g(a)g(de)o(generate)e(case)i(of)f(rules.)55
b(The)29 b(ef)n(fect)f(of)g(an)o(y)g(f)o(act)h Ft(F)555
3515 y FA(could)19 b(be)h(duplicated)f(by)h(a)g(rule)g(whose)g(body)f
(w)o(as)i(al)o(w)o(ays)g(true:)555 3723 y(If)145 b(true)555
3827 y(Then)29 b Ft(F)555 4035 y FA(T)-7 b(o)33 b(simplify)f(our)g
(implementation,)h(we)g(will)g(tak)o(e)g(adv)n(antage)d(of)j(this)g
(principle)e(and)555 4140 y(represent)19 b(f)o(acts)i(as)g(bodyless)e
(rules.)1657 b Fq(\016)555 4392 y Fw(24.2)99 b(An)25
b(Inter)o(pr)n(eter)555 4582 y FA(Section)30 b(18.4)f(sho)n(wed)g(tw)o
(o)h(w)o(ays)g(to)h(de\002ne)e Fs(if-match)p FA(.)56
b(The)30 b(\002rst)h(w)o(as)g(simple)f(b)n(ut)555 4687
y(inef)n(\002cient.)41 b(Its)26 b(successor)e(w)o(as)h(f)o(aster)g
(because)f(it)h(did)f(much)g(of)g(its)i(w)o(ork)e(at)h(compile\255)555
4791 y(time.)45 b(W)-7 b(e)27 b(will)f(follo)n(w)e(a)i(similar)g
(strate)o(gy)e(here.)45 b(In)25 b(order)f(to)i(introduce)d(some)i(of)h
(the)555 4896 y(topics)21 b(in)m(v)n(olv)o(ed,)d(we)k(will)f(be)o(gin)f
(with)h(a)g(simple)g(interpreter)-5 b(.)30 b(Later)21
b(we)g(will)h(sho)n(w)e(ho)n(w)555 5001 y(to)g(write)h(the)f(same)g
(program)e(much)i(more)f(ef)n(\002ciently)-5 b(.)p eop
%%Page: 324 337
324 336 bop 555 538 a FA(324)1098 b Fu(PR)n(OLOG)p 555
745 2678 4 v 553 3562 4 2817 v 605 888 a Fs(\(defmacro)40
b(with-inference)d(\(query)42 b(&body)f(body\))648 988
y(`\(progn)779 1087 y(\(setq)h(*paths*)e(nil\))779 1187
y(\(=bind)h(\(binds\))g(\(prove-query)e(',\(rep_)h(query\))h(nil\))866
1287 y(\(let)h(,\(mapcar)f(#'\(lambda)e(\(v\))1651 1386
y(`\(,v)j(\(fullbind)e(',v)i(binds\)\)\))1477 1486 y(\(vars-in)e(query)
h(#'atom\)\))954 1586 y(,@body)954 1685 y(\(fail\)\)\)\)\))605
1884 y(\(defun)g(rep_)h(\(x\))692 1984 y(\(if)g(\(atom)g(x\))866
2084 y(\(if)h(\(eq)f(x)h('_\))g(\(gensym)d("?"\))i(x\))866
2183 y(\(cons)g(\(rep_)f(\(car)h(x\)\))h(\(rep_)e(\(cdr)h(x\)\)\)\)\))
605 2383 y(\(defun)f(fullbind)f(\(x)j(b\))692 2482 y(\(cond)f
(\(\(varsym?)d(x\))k(\(aif2)f(\(binding)e(x)j(b\))1782
2582 y(\(fullbind)d(it)i(b\))1782 2681 y(\(gensym\)\)\))954
2781 y(\(\(atom)f(x\))h(x\))954 2881 y(\(t)g(\(cons)g(\(fullbind)e
(\(car)i(x\))g(b\))1346 2980 y(\(fullbind)e(\(cdr)i(x\))g(b\)\)\)\)\))
605 3180 y(\(defun)f(varsym?)g(\(x\))692 3279 y(\(and)h(\(symbolp)e
(x\))j(\(eq)f(\(char)g(\(symbol-name)c(x\))43 b(0\))g(#\\?\)\)\))1409
3483 y FA(Figure)19 b(24.2:)28 b(T)-7 b(ople)n(v)o(el)19
b(macro.)p 3231 3562 V 555 3565 2678 4 v 680 3789 a(Figures)31
b(24.2\22624.4)d(contain)j(the)g(code)g(for)g(a)h(simple)g(Prolog)e
(interpreter)-5 b(.)63 b(It)32 b(ac\255)555 3894 y(cepts)e(the)h(same)f
(queries)g(as)h(the)f(query)f(interpreter)g(of)h(Section)g(19.3,)h(b)n
(ut)g(uses)g(rules)555 3998 y(instead)24 b(of)f(the)h(database)g(to)g
(generate)f(bindings.)39 b(The)24 b(query)e(interpreter)g(w)o(as)j(in)m
(v)n(ok)o(ed)555 4103 y(through)j(a)i(macro)f(called)g
Fs(with-answer)p FA(.)54 b(The)30 b(interf)o(ace)f(to)h(the)f(Prolog)g
(interpreter)555 4207 y(will)c(be)f(through)f(a)h(similar)h(macro,)f
(called)g Fs(with-inference)p FA(.)37 b(Lik)o(e)24 b
Fs(with-answer)p FA(,)555 4312 y Fs(with-inference)16
b FA(is)22 b(gi)n(v)o(en)d(a)j(query)d(and)i(a)g(series)h(of)f(Lisp)g
(e)o(xpressions.)30 b(V)-9 b(ariables)20 b(in)555 4417
y(the)g(query)f(are)h(symbols)g(be)o(ginning)d(with)k(a)f(question)f
(mark:)555 4599 y Fs(\(with-inference)37 b(\(painter)k(?x\))642
4699 y(\(print)g(?x\)\))555 4887 y FA(A)21 b(call)g(to)g
Fs(with-inference)16 b FA(e)o(xpands)j(into)h(code)g(that)h(will)h(e)n
(v)n(aluate)d(the)i(Lisp)g(e)o(xpres\255)555 4991 y(sions)16
b(for)f(each)h(set)h(of)e(bindings)g(generated)f(by)h(the)h(query)-5
b(.)26 b(The)16 b(call)g(abo)o(v)o(e,)f(for)g(e)o(xample,)p
eop
%%Page: 325 338
325 337 bop 555 538 a Ft(24.2)963 b Fu(AN)19 b(INTERPRETER)944
b FA(325)555 801 y(will)21 b(print)f(each)f Ft(x)i FA(for)f(which)f(it)
i(is)g(possible)f(to)h(infer)e Fs(\(painter)40 b Ft(x)p
Fs(\))p FA(.)651 b Fq(\016)680 905 y FA(Figure)16 b(24.2)g(sho)n(ws)h
(the)g(de\002nition)f(of)h Fs(with-inference)p FA(,)12
b(together)k(with)h(the)g(func\255)555 1010 y(tion)24
b(it)h(calls)f(to)g(retrie)n(v)o(e)f(bindings.)39 b(One)24
b(notable)f(dif)n(ference)f(between)i Fs(with-answer)555
1114 y FA(and)f Fs(with-inference)c FA(is)24 b(that)g(the)g(former)e
(simply)h(collected)g(all)h(the)g(v)n(alid)f(bindings.)555
1219 y(The)f(ne)n(w)h(program)e(searches)h(nondeterministically)-5
b(.)34 b(W)-7 b(e)24 b(see)f(this)g(in)g(the)g(de\002nition)f(of)555
1324 y Fs(with-inference)p FA(:)28 b(instead)22 b(of)g(e)o(xpanding)e
(into)i(a)g(loop,)g(it)h(e)o(xpands)e(into)h(code)f(which)555
1428 y(will)29 b(return)e(one)g(set)i(of)f(bindings,)g(follo)n(wed)f
(by)h(a)g Fs(fail)f FA(to)i(restart)f(the)g(search.)52
b(This)555 1533 y(gi)n(v)o(es)20 b(us)g(iteration)g(implicitly)-5
b(,)19 b(as)i(in:)555 1715 y Fs(>)43 b(\(choose-bind)c(x)k('\(0)f(1)h
(2)h(3)f(4)g(5)g(6)g(7)h(8)f(9\))729 1814 y(\(princ)e(x\))729
1914 y(\(if)i(\(=)f(x)i(6\))e(x)i(\(fail\)\)\))555 2014
y(0123456)555 2113 y(6)680 2300 y FA(The)23 b(function)g
Fs(fullbind)f FA(points)h(to)i(another)e(dif)n(ference)f(between)i
Fs(with-answer)555 2405 y FA(and)13 b Fs(with-inference)p
FA(.)22 b(T)m(racing)13 b(back)g(through)f(a)i(series)g(of)g(rules)g
(can)f(b)n(uild)h(up)f(binding)555 2509 y(lists)22 b(in)e(which)f(the)h
(binding)f(of)h(a)g(v)n(ariable)f(is)i(a)g(list)g(of)f(other)f(v)n
(ariables.)29 b(T)-7 b(o)20 b(mak)o(e)g(use)g(of)555
2614 y(the)25 b(results)h(of)f(a)h(query)e(we)i(no)n(w)f(need)g(a)h
(recursi)n(v)o(e)e(function)g(for)g(retrie)n(ving)g(bindings.)555
2719 y(This)c(is)i(the)e(purpose)e(of)i Fs(fullbind)p
FA(:)555 2901 y Fs(>)43 b(\(setq)f(b)h('\(\(?x)e(.)j(\(?y)e(.)h(?z\)\))
f(\(?y)g(.)i(foo\))d(\(?z)i(.)g(nil\)\)\))555 3000 y(\(\(?X)f(?Y)h(.)g
(?Z\))f(\(?Y)h(.)g(FOO\))f(\(?Z\)\))555 3100 y(>)h(\(values)e
(\(binding)f('?x)i(b\)\))555 3200 y(\(?Y)g(.)i(?Z\))555
3299 y(>)f(\(fullbind)d('?x)i(b\))555 3399 y(\(FOO\))680
3586 y FA(Bindings)13 b(for)g(the)g(query)f(are)g(gen)o(era)o(ted)g(by)
g(a)h(c)o(all)g(to)f Fs(pr)o(ove)o(-q)o(uer)o(y)g FA(in)h(th)o(e)g(e)n
(xp)o(ansio)o(n)555 3690 y(of)26 b Fs(with-inference)p
FA(.)40 b(Figure)25 b(24.3)g(sho)n(ws)h(the)g(de\002nition)e(of)i(this)
g(function)e(and)i(the)555 3795 y(functions)h(it)i(calls.)55
b(This)28 b(code)g(is)h(structurally)f(isomorphic)e(to)j(the)f(query)f
(interpreter)555 3900 y(described)c(in)i(Section)f(19.3.)41
b(Both)25 b(programs)d(use)j(the)g(same)f(functions)f(for)h(matching,)
555 4004 y(b)n(ut)f(where)g(the)g(query)f(interpreter)g(used)h(mapping)
e(or)i(iteration,)h(the)f(Prolog)f(interpreter)555 4109
y(uses)f(equi)n(v)n(alent)d Ft(c)o(hoose)p FA(s.)680
4213 y(Using)13 b(nondeterministic)f(search)i(instead)f(of)h(iteration)
f(does)h(mak)o(e)g(the)g(interpretation)555 4318 y(of)20
b(ne)o(gated)e(queries)i(a)g(bit)h(more)e(comple)o(x.)28
b(Gi)n(v)o(en)19 b(a)i(query)d(lik)o(e)555 4500 y Fs(\(not)42
b(\(painter)e(?x\)\))555 4687 y FA(the)c(query)g(interpreter)e(could)i
(just)h(try)f(to)h(establish)f(bindings)f(for)h Fs(\(painter)k(?x\))p
FA(,)555 4791 y(returning)27 b Fs(nil)h FA(if)h(an)o(y)f(were)g(found.)
54 b(W)m(ith)29 b(nondeterministic)d(search)i(we)i(ha)n(v)o(e)e(to)h
(be)555 4896 y(more)g(careful:)49 b(we)30 b(don')o(t)f(w)o(ant)h(the)h
(interpretation)d(of)i Fs(\(painter)40 b(?x\))29 b FA(to)i(f)o(ail)f
(back)555 5001 y(outside)25 b(the)g(scope)h(of)f(the)g
Fs(not)p FA(,)h(nor)f(do)g(we)h(w)o(ant)g(it)g(to)g(lea)n(v)o(e)f(sa)n
(v)o(ed)g(paths)h(that)f(might)p eop
%%Page: 326 339
326 338 bop 555 538 a FA(326)1098 b Fu(PR)n(OLOG)p 555
745 2678 4 v 553 4060 4 3315 v 605 888 a Fs(\(=defun)41
b(prove-query)e(\(expr)i(binds\))692 988 y(\(case)h(\(car)f(expr\))779
1087 y(\(and)86 b(\(prove-and)39 b(\(cdr)j(expr\))g(binds\)\))779
1187 y(\(or)130 b(\(prove-or)40 b(\(cdr)h(expr\))h(binds\)\))779
1287 y(\(not)86 b(\(prove-not)39 b(\(cadr)j(expr\))f(binds\)\))779
1386 y(\(t)174 b(\(prove-simple)38 b(expr)k(binds\)\)\)\))605
1586 y(\(=defun)f(prove-and)e(\(clauses)i(binds\))692
1685 y(\(if)h(\(null)g(clauses\))866 1785 y(\(=values)f(binds\))866
1884 y(\(=bind)g(\(binds\))g(\(prove-query)e(\(car)j(clauses\))e
(binds\))954 1984 y(\(prove-and)f(\(cdr)j(clauses\))e(binds\)\)\)\))605
2183 y(\(=defun)h(prove-or)f(\(clauses)g(binds\))692
2283 y(\(choose-bind)f(c)k(clauses)779 2383 y(\(prove-query)c(c)k
(binds\)\)\))605 2582 y(\(=defun)e(prove-not)e(\(expr)j(binds\))692
2681 y(\(let)g(\(\(save-paths)d(*paths*\)\))779 2781
y(\(setq)j(*paths*)e(nil\))779 2881 y(\(choose)h(\(=bind)g(\(b\))h
(\(prove-query)d(expr)j(binds\))1215 2980 y(\(setq)g(*paths*)e
(save-paths\))1215 3080 y(\(fail\)\))1128 3180 y(\(progn)1215
3279 y(\(setq)i(*paths*)e(save-paths\))1215 3379 y(\(=values)g
(binds\)\)\)\)\))605 3578 y(\(=defun)h(prove-simple)d(\(query)j
(binds\))692 3678 y(\(choose-bind)e(r)k(*rlist*)779 3777
y(\(implies)d(r)k(query)d(binds\)\)\))1264 3982 y FA(Figure)20
b(24.3:)28 b(Interpretation)18 b(of)i(queries.)p 3231
4060 V 555 4063 2678 4 v 555 4287 a(be)i(restarted)f(later)-5
b(.)34 b(So)23 b(no)n(w)e(the)h(test)g(for)f Fs(\(painter)41
b(?x\))21 b FA(is)i(done)d(with)i(a)h(temporarily)555
4392 y(empty)c(list)j(of)e(sa)n(v)o(ed)f(states,)i(and)f(the)g(old)g
(list)h(is)h(restored)d(on)g(the)i(w)o(ay)f(out.)680
4496 y(Another)25 b(dif)n(ference)f(between)i(this)h(program)e(and)h
(the)g(query)f(interpreter)g(is)j(in)f(the)555 4601 y(interpretation)12
b(of)j(simple)f(patterns\227e)o(xpressions)e(such)i(as)h
Fs(\(painter)41 b(?x\))14 b FA(which)f(con\255)555 4706
y(sist)19 b(just)f(of)f(a)h(predicate)e(and)h(some)g(ar)o(guments.)26
b(When)17 b(the)h(query)e(interpreter)f(generated)555
4810 y(bindings)f(for)h(a)h(simple)g(pattern,)f(it)i(called)e
Fs(lookup)f FA(\(page)g(251\).)27 b(No)n(w)-5 b(,)15
b(instead)h(of)f(calling)555 4915 y Fs(lookup)p FA(,)j(we)j(ha)n(v)o(e)
e(to)i(get)f(an)o(y)f(bindings)g(implied)g(by)h(the)g(rules.)p
eop
%%Page: 327 340
327 339 bop 555 538 a Ft(24.2)963 b Fu(AN)19 b(INTERPRETER)944
b FA(327)p 555 745 2678 4 v 553 2964 4 2219 v 605 888
a Fs(\(defvar)41 b(*rlist*)f(nil\))605 1087 y(\(defmacro)g(<-)i(\(con)g
(&rest)g(ant\))692 1187 y(\(let)g(\(\(ant)f(\(if)i(\(=)g(\(length)d
(ant\))i(1\))1346 1287 y(\(car)g(ant\))1346 1386 y(`\(and)f
(,@ant\)\)\)\))779 1486 y(`\(length)f(\(conc1f)h(*rlist*)g(\(rep_)g
(\(cons)h(',ant)f(',con\)\)\)\)\)\))605 1685 y(\(=defun)g(implies)f
(\(r)j(query)e(binds\))692 1785 y(\(let)h(\(\(r2)g(\(change-vars)c
(r\)\)\))779 1884 y(\(aif2)k(\(match)f(query)g(\(cdr)h(r2\))h(binds\))
1041 1984 y(\(prove-query)38 b(\(car)k(r2\))h(it\))1041
2084 y(\(fail\)\)\)\))605 2283 y(\(defun)e(change-vars)e(\(r\))692
2383 y(\(sublis)i(\(mapcar)f(#'\(lambda)g(\(v\))1564
2482 y(\(cons)h(v)i(\(symb)f('?)h(\(gensym\)\)\)\))1389
2582 y(\(vars-in)e(r)i(#'atom\)\))1041 2681 y(r\)\))1320
2886 y FA(Figure)19 b(24.4:)28 b(Code)20 b(in)m(v)n(olving)f(rules.)p
3231 2964 V 555 2967 2678 4 v 555 3094 V 553 4423 4 1329
v 605 3249 a Fq(h)p FA(rule)p Fq(i)224 b FA(:)30 b Fs(\(<-)42
b Fq(h)p FA(sentence)p Fq(i)21 b(h)p FA(query)p Fq(i)p
Fs(\))605 3349 y Fq(h)p FA(query)p Fq(i)163 b FA(:)30
b Fs(\(not)42 b Fq(h)p FA(query)p Fq(i)p Fs(\))1023 3449
y FA(:)30 b Fs(\(and)42 b Fq(h)p FA(query)p Fq(i)p FA(*)p
Fs(\))1023 3548 y FA(:)30 b Fs(\(or)42 b Fq(h)p FA(query)p
Fq(i)p FA(*)p Fs(\))1023 3648 y FA(:)30 b Fq(h)p FA(sentence)p
Fq(i)605 3747 y(h)p FA(sentence)p Fq(i)67 b FA(:)30 b
Fs(\()p Fq(h)p FA(symbol)p Fq(i)19 b(h)p FA(ar)o(gument)p
Fq(i)p FA(*)p Fs(\))605 3847 y Fq(h)p FA(ar)o(gument)p
Fq(i)39 b FA(:)30 b Fq(h)p FA(v)n(ariable)p Fq(i)1023
3947 y FA(:)g Fq(h)p FA(symbol)p Fq(i)1023 4046 y FA(:)g
Fq(h)p FA(number)p Fq(i)605 4146 y(h)p FA(v)n(ariable)p
Fq(i)87 b FA(:)30 b Fs(?)p Fq(h)p FA(symbol)p Fq(i)1414
4345 y FA(Figure)19 b(24.5:)29 b(Syntax)19 b(of)h(rules.)p
3231 4423 V 555 4427 2678 4 v 680 4651 a(Code)g(for)g(de\002ning)f(and)
h(using)g(rules)g(is)h(sho)n(wn)f(in)h(Figure)e(24.4.)29
b(The)20 b(rules)h(are)f(k)o(ept)555 4755 y(in)25 b(a)g(global)f(list,)
i Fs(*rlist*)p FA(.)40 b(Each)24 b(rule)h(is)g(represented)e(as)i(a)h
(dotted)d(pair)i(of)f(body)f(and)555 4860 y(head.)38
b(At)24 b(the)f(time)h(a)g(rule)f(is)h(de\002ned,)f(all)h(the)g
(underscores)d(are)i(replaced)f(with)i(unique)555 4965
y(v)n(ariables.)p eop
%%Page: 328 341
328 340 bop 555 538 a FA(328)1098 b Fu(PR)n(OLOG)680
801 y FA(The)20 b(de\002nition)g(of)g Fs(<-)h FA(follo)n(ws)f(three)h
(con)m(v)o(entions)d(often)i(used)g(in)h(programs)e(of)i(this)555
905 y(type:)659 1093 y(1.)41 b(Ne)n(w)21 b(rules)g(are)f(added)g(to)h
(the)g(end)f(rather)g(than)h(the)g(front)f(of)g(the)h(list,)h(so)f
(that)g(the)o(y)763 1197 y(will)f(be)h(applied)e(in)h(the)g(order)f
(that)i(the)o(y)e(were)h(de\002ned.)659 1369 y(2.)41
b(Rules)23 b(are)f(e)o(xpressed)f(head)h(\002rst,)i(since)e(that')-5
b(s)23 b(the)g(order)e(in)h(which)g(the)h(program)763
1473 y(e)o(xamines)c(them.)659 1644 y(3.)41 b(Multiple)19
b(e)o(xpressions)g(in)i(the)f(body)f(are)h(within)g(an)g(implicit)g
Fs(and)p FA(.)555 1832 y(The)f(outermost)e(call)j(to)f
Fs(length)e FA(in)i(the)g(e)o(xpansion)e(of)i Fs(<-)f
FA(is)i(simply)f(to)g(a)n(v)n(oid)g(printing)e(a)555
1936 y(huge)i(list)i(when)f Fs(<-)g FA(is)h(called)f(from)f(the)h
(tople)n(v)o(el.)680 2041 y(The)14 b(syntax)g(of)g(rules)h(is)h(gi)n(v)
o(en)d(in)i(Figure)f(24.5.)26 b(The)14 b(head)g(of)h(a)g(rule)f(must)h
(be)f(a)h(pattern)555 2146 y(for)26 b(a)g(f)o(act:)42
b(a)26 b(list)h(of)f(a)h(predicate)e(follo)n(wed)g(by)g(zero)h(or)g
(more)f(ar)o(guments.)45 b(The)26 b(body)555 2250 y(may)e(be)g(an)o(y)g
(query)f(that)i(could)e(be)i(handled)e(by)h(the)g(query)f(interpreter)g
(of)h(Chapter)g(19.)555 2355 y(Here)c(is)h(the)f(rule)g(from)f(earlier)
h(in)h(this)f(chapter:)555 2537 y Fs(\(<-)42 b(\(painter)f(?x\))h
(\(and)g(\(hungry)f(?x\))1514 2637 y(\(smells-of)e(?x)k
(turpentine\)\)\))555 2825 y FA(or)20 b(just)555 3007
y Fs(\(<-)42 b(\(painter)f(?x\))h(\(hungry)f(?x\))1296
3107 y(\(smells-of)e(?x)k(turpentine\)\))555 3295 y FA(As)23
b(in)f(the)g(query)e(interpreter)m(,)h(ar)o(guments)f(lik)o(e)i
Fs(turpentine)c FA(do)k(not)f(get)h(e)n(v)n(aluated,)f(so)555
3399 y(the)o(y)e(don')o(t)g(ha)n(v)o(e)h(to)g(be)g(quoted.)680
3504 y(When)j Fs(prove-simple)c FA(is)24 b(ask)o(ed)f(to)g(generate)f
(bindings)g(for)h(a)g(query)-5 b(,)23 b(it)h(nondeter)n(\255)555
3608 y(ministically)c(chooses)g(a)h(rule)f(and)g(sends)h(both)e(rule)i
(and)f(query)f(to)h Fs(implies)p FA(.)28 b(The)20 b(latter)555
3713 y(function)28 b(then)h(tries)h(to)f(match)g(the)h(query)e(with)i
(the)f(head)g(of)g(the)h(rule.)56 b(If)30 b(the)f(match)555
3818 y(succeeds,)k Fs(implies)28 b FA(will)j(call)g Fs(prove-query)c
FA(to)k(establish)g(bindings)e(for)h(the)h(body)-5 b(.)555
3922 y(Thus)20 b(we)g(recursi)n(v)o(ely)f(search)g(the)i(tree)f(of)g
(implications.)680 4027 y(The)c(function)e Fs(change-vars)f
FA(replaces)j(all)h(the)f(v)n(ariables)g(in)h(a)f(rule)g(with)h(fresh)f
(ones.)555 4131 y(An)h Fs(?x)g FA(used)f(in)h(one)g(rule)f(is)i(meant)e
(to)h(be)g(independent)e(of)h(one)g(used)h(in)g(another)-5
b(.)27 b(In)17 b(order)555 4236 y(to)j(a)n(v)n(oid)f(con\003icts)h
(with)g(e)o(xisting)f(bindings,)f Fs(change-vars)d FA(is)21
b(called)f(each)f(time)h(a)g(rule)555 4341 y(is)h(used.)680
4445 y(F)o(or)13 b(the)g(con)m(v)o(enience)e(of)i(the)g(user)m(,)h(it)h
(is)f(possible)f(to)h(use)p 2342 4445 27 4 v 59 w(\(underscore\))c(as)
15 b(a)f(wildcard)555 4550 y(v)n(ariable)25 b(in)h(rules.)47
b(When)26 b(a)g(rule)g(is)h(de\002ned,)f(the)g(function)e
Fs(rep)p 2555 4550 V 57 w FA(is)j(called)f(to)g(change)555
4655 y(each)21 b(underscore)e(into)h(a)i(real)f(v)n(ariable.)30
b(Underscores)20 b(can)h(also)g(be)g(used)g(in)g(the)g(queries)555
4759 y(gi)n(v)o(en)e(to)h Fs(with-inference)p FA(.)p
eop
%%Page: 329 342
329 341 bop 555 538 a Ft(24.3)1122 b Fu(R)n(ULES)1103
b FA(329)555 801 y Fw(24.3)99 b(Rules)555 991 y FA(This)23
b(section)g(sho)n(ws)g(ho)n(w)f(to)h(write)g(rules)g(for)f(our)g
(Prolog.)36 b(T)-7 b(o)24 b(start)f(with,)g(here)g(are)g(the)555
1096 y(tw)o(o)d(rules)h(from)e(Section)h(24.1:)555 1268
y Fs(\(<-)42 b(\(painter)f(?x\))h(\(hungry)f(?x\))1296
1368 y(\(smells-of)e(?x)k(turpentine\)\))555 1567 y(\(<-)f(\(hungry)f
(?x\))h(\(or)h(\(gaunt)e(?x\))h(\(eats-ravenously)37
b(?x\)\)\))555 1739 y FA(If)20 b(we)h(also)f(assert)h(the)f(follo)n
(wing)f(f)o(acts:)555 1897 y Fs(\(<-)42 b(\(gaunt)f(raoul\)\))555
1996 y(\(<-)h(\(smells-of)e(raoul)h(turpentine\)\))555
2096 y(\(<-)h(\(painter)f(rubens\)\))555 2253 y FA(Then)20
b(we)h(will)h(get)e(the)h(bindings)f(the)o(y)g(generate)f(according)g
(to)i(the)g(order)e(in)i(which)f(the)o(y)555 2353 y(were)g(de\002ned:)
555 2511 y Fs(>)43 b(\(with-inference)38 b(\(painter)i(?x\))729
2610 y(\(print)h(?x\)\))555 2710 y(RAOUL)555 2810 y(RUBENS)555
2909 y(@)555 3072 y FA(The)14 b Fs(with-inference)8 b
FA(macro)14 b(has)g(e)o(xactly)f(the)h(same)g(restrictions)g(on)f(v)n
(ariable)g(binding)555 3176 y(as)21 b Fs(with-answer)p
FA(.)k(\(See)20 b(Section)g(19.4.\))680 3281 y(W)-7 b(e)31
b(can)g(write)g(rules)f(which)g(imply)h(that)f(f)o(acts)h(of)g(a)g(gi)n
(v)o(en)e(form)h(are)h(true)f(for)g(all)555 3386 y(possible)22
b(bindings.)34 b(This)22 b(happens,)f(for)h(e)o(xample,)f(when)h(some)g
(v)n(ariable)f(occurs)g(in)i(the)555 3490 y(head)d(of)f(a)i(rule)f(b)n
(ut)g(not)g(in)g(the)g(body)-5 b(.)28 b(The)20 b(rule)555
3662 y Fs(\(<-)42 b(\(eats)g(?x)h(?f\))f(\(glutton)e(?x\)\))555
3839 y FA(Says)21 b(that)g(if)g Fs(?x)f FA(is)i(a)f(glutton,)f(then)g
Fs(?x)h FA(eats)g(e)n(v)o(erything.)28 b(Because)21 b
Fs(?f)f FA(doesn')o(t)g(occur)f(in)555 3944 y(the)g(body)-5
b(,)17 b(we)i(can)f(pro)o(v)o(e)f(an)o(y)h(f)o(act)h(of)f(the)h(form)f
Fs(\(eats)41 b(?x)i Ft(y)p Fs(\))19 b FA(simply)f(by)g(establishing)555
4049 y(a)k(binding)e(for)g Fs(?x)p FA(.)33 b(If)21 b(we)h(mak)o(e)f(a)h
(query)e(with)i(a)f(literal)h(v)n(alue)f(as)h(the)f(second)g(ar)o
(gument)555 4153 y(to)f Fs(eats)p FA(,)555 4325 y Fs(>)43
b(\(<-)g(\(glutton)d(hubert\)\))555 4425 y(7)555 4525
y(>)j(\(with-inference)38 b(\(eats)j(?x)i(spinach\))729
4624 y(\(print)e(?x\)\))555 4724 y(HUBERT)555 4824 y(@)555
5001 y FA(then)17 b(an)o(y)f(literal)h(v)n(alue)g(will)h(w)o(ork.)27
b(When)17 b(we)h(gi)n(v)o(e)e(a)i(v)n(ariable)e(as)h(the)h(second)e(ar)
o(gument:)p eop
%%Page: 330 343
330 342 bop 555 538 a FA(330)1098 b Fu(PR)n(OLOG)555
801 y Fs(>)43 b(\(with-inference)38 b(\(eats)j(?x)i(?y\))729
900 y(\(print)e(\(list)h(?x)h(?y\)\)\))555 1000 y(\(HUBERT)e(#:G229\))
555 1100 y(@)555 1287 y FA(we)27 b(get)f(a)h(gensym)e(back.)47
b(Returning)25 b(a)i(gensym)e(as)i(the)f(binding)f(of)h(a)h(v)n
(ariable)e(in)i(the)555 1392 y(query)19 b(is)j(a)e(w)o(ay)h(of)f
(signifying)f(that)h Ft(any)g FA(v)n(alue)g(w)o(ould)g(be)g(true)h
(there.)29 b(Programs)19 b(can)i(be)555 1496 y(written)f(e)o(xplicitly)
f(to)h(tak)o(e)h(adv)n(antage)d(of)i(this)h(con)m(v)o(ention:)555
1679 y Fs(>)43 b(\(progn)729 1779 y(\(<-)g(\(eats)e(monster)g
(bad-children\)\))729 1878 y(\(<-)i(\(eats)e(warhol)g(candy\)\)\))555
1978 y(9)555 2078 y(>)i(\(with-inference)38 b(\(eats)j(?x)i(?y\))729
2177 y(\(format)e(t)i("~A)g(eats)e(~A.~\045")1078 2277
y(?x)1078 2376 y(\(if)h(\(gensym?)f(?y\))h('everything)d(?y\)\)\))555
2476 y(HUBERT)i(eats)h(EVERYTHING.)555 2576 y(MONSTER)f(eats)h
(BAD-CHILDREN.)555 2675 y(WARHOL)f(eats)h(CANDY.)555
2775 y(@)555 2963 y FA(Finally)-5 b(,)32 b(if)e(we)h(w)o(ant)f(to)h
(specify)e(that)i(f)o(acts)f(of)g(a)h(certain)e(form)h(will)h(be)f
(true)g(for)f Ft(any)555 3067 y FA(ar)o(guments,)21 b(we)i(mak)o(e)f
(the)g(body)g(a)h(conjunction)d(with)j(no)f(ar)o(guments.)34
b(The)22 b(e)o(xpression)555 3172 y Fs(\(and\))d FA(will)i(al)o(w)o
(ays)g(beha)n(v)o(e)f(as)h(a)g(true)f(f)o(act.)30 b(In)21
b(the)f(macro)g Fs(<-)g FA(\(Figure)g(24.4\),)e(the)j(body)555
3276 y(def)o(aults)f(to)g Fs(\(and\))p FA(,)f(so)h(for)g(such)g(rules)g
(we)g(can)g(simply)g(omit)g(the)g(body:)555 3459 y Fs(>)43
b(\(<-)g(\(identical)c(?x)k(?x\)\))555 3559 y(10)555
3658 y(>)g(\(with-inference)38 b(\(identical)h(a)k(?x\))729
3758 y(\(print)e(?x\)\))555 3858 y(A)555 3957 y(@)680
4145 y FA(F)o(or)16 b(readers)g(with)h(some)f(kno)n(wledge)f(of)h
(Prolog,)g(Figure)g(24.6)g(sho)n(ws)h(the)f(translation)555
4249 y(from)i(Prolog)g(syntax)h(into)g(that)g(of)g(our)g(program.)26
b(The)19 b(traditional)g(\002rst)g(Prolog)g(program)555
4354 y(is)i Fs(append)p FA(,)c(which)i(w)o(ould)g(be)h(written)f(as)i
(at)f(the)f(end)g(of)h(Figure)f(24.6.)28 b(In)19 b(an)h(instance)f(of)
555 4459 y(appending,)h(tw)o(o)j(shorter)f(lists)h(are)g(joined)e
(together)g(to)i(form)e(a)i(single)g(lar)o(ger)e(one.)35
b(An)o(y)555 4563 y(tw)o(o)17 b(of)g(these)h(lists)g(de\002ne)f(what)g
(the)g(third)g(should)f(be.)28 b(The)17 b(Lisp)g(function)f
Fs(append)f FA(tak)o(es)555 4668 y(the)24 b(tw)o(o)h(shorter)e(lists)j
(as)e(ar)o(guments)f(and)g(returns)h(the)g(longer)f(one.)40
b(Prolog)23 b Fs(append)g FA(is)555 4772 y(more)18 b(general;)f(the)i
(tw)o(o)f(rules)h(in)f(Figure)g(24.6)f(de\002ne)h(a)h(program)d(which,)
i(gi)n(v)o(en)f(an)o(y)g(tw)o(o)555 4877 y(of)j(the)g(lists)i(in)m(v)n
(olv)o(ed,)c(can)i(\002nd)f(the)i(third.)p eop
%%Page: 331 344
331 343 bop 555 538 a Ft(24.3)1122 b Fu(R)n(ULES)1103
b FA(331)p 555 745 2678 4 v 553 3311 4 2566 v 605 886
a(Our)20 b(syntax)f(dif)n(fers)h(from)f(traditional)g(Prolog)g(syntax)g
(as)i(follo)n(ws:)709 1069 y(1.)40 b(V)-9 b(ariables)31
b(are)g(represented)f(by)h(symbols)f(be)o(ginning)f(with)i(question)g
(marks)812 1169 y(instead)20 b(of)f(capital)h(letters.)29
b(Common)18 b(Lisp)i(is)h(not)e(case\255sensiti)n(v)o(e)g(by)g(def)o
(ault,)812 1268 y(so)i(it)g(w)o(ould)e(be)h(more)g(trouble)f(than)g
(it')-5 b(s)22 b(w)o(orth)d(to)i(use)f(capitals.)709
1434 y(2.)40 b Fs([)k(])20 b FA(becomes)f Fs(nil)p FA(.)709
1600 y(3.)40 b(Expressions)19 b(of)h(the)g(form)g Fs([)p
Ft(x)43 b Fs(|)g Ft(y)p Fs(])20 b FA(become)f Fs(\()p
Ft(x)43 b Fs(.)g Ft(y)p Fs(\))p FA(.)709 1766 y(4.)d(Expressions)19
b(of)h(the)g(form)g Fs([)p Ft(x)p Fs(,)42 b Ft(y)p Fs(,)h(...])29
b FA(become)19 b Fs(\()p Ft(x)43 b(y)g Fs(...\))p FA(.)709
1932 y(5.)d(Predicates)19 b(are)f(mo)o(v)o(ed)f(inside)h(parentheses,)g
(and)g(no)g(commas)g(separate)g(ar)o(gu\255)812 2032
y(ments:)30 b Ft(pr)m(ed)p Fs(\()p Ft(x)p Fs(,)41 b Ft(y)p
Fs(,)j(...\))28 b FA(becomes)19 b Fs(\()p Ft(pr)m(ed)h(x)g(y)44
b Fs(...\))p FA(.)605 2215 y(Thus)20 b(the)g(Prolog)f(de\002nition)g
(of)h Fs(append)p FA(:)605 2397 y Fs(append\([)40 b(],)j(Xs,)f(Xs\).)
605 2497 y(append\([X)e(|)j(Xs],)f(Ys,)g([X)h(|)g(Zs]\))f(<-)h
(append\(Xs,)c(Ys,)k(Zs\).)605 2680 y FA(becomes:)605
2846 y Fs(\(<-)f(\(append)f(nil)h(?xs)h(?xs\)\))605 2945
y(\(<-)f(\(append)f(\(?x)h(.)h(?xs\))f(?ys)h(\(?x)f(.)h(?zs\)\))779
3045 y(\(append)e(?xs)h(?ys)h(?zs\)\))1229 3233 y FA(Figure)20
b(24.6:)28 b(Prolog)19 b(syntax)h(equi)n(v)n(alence.)p
3231 3311 V 555 3314 2678 4 v 555 3535 a Fs(>)43 b(\(with-inference)38
b(\(append)i(?x)j(\(c)g(d\))g(\(a)f(b)h(c)h(d\)\))729
3635 y(\(format)d(t)i("Left:)e(~A~\045")h(?x\)\))555
3735 y(Left:)g(\(A)g(B\))555 3834 y(@)555 3934 y(>)h(\(with-inference)
38 b(\(append)i(\(a)j(b\))g(?x)g(\(a)f(b)h(c)h(d\)\))729
4034 y(\(format)d(t)i("Right:)e(~A~\045")g(?x\)\))555
4133 y(Right:)g(\(C)i(D\))555 4233 y(@)555 4332 y(>)g(\(with-inference)
38 b(\(append)i(\(a)j(b\))g(\(c)g(d\))f(?x\))729 4432
y(\(format)f(t)i("Whole:)e(~A~\045")g(?x\)\))555 4532
y(Whole:)g(\(A)i(B)g(C)g(D\))555 4631 y(@)555 4815 y
FA(Not)26 b(only)f(that,)i(b)n(ut)f(gi)n(v)o(en)e(only)h(the)h(last)h
(list,)h(it)f(can)e(\002nd)h(all)g(the)g(possibilities)g(for)g(the)555
4920 y(\002rst)21 b(tw)o(o:)p eop
%%Page: 332 345
332 344 bop 555 538 a FA(332)1098 b Fu(PR)n(OLOG)555
801 y Fs(>)43 b(\(with-inference)38 b(\(append)i(?x)j(?y)g(\(a)g(b)g
(c\)\))729 900 y(\(format)e(t)i("Left:)e(~A)87 b(Right:)41
b(~A~\045")g(?x)i(?y\)\))555 1000 y(Left:)f(NIL)85 b(Right:)42
b(\(A)g(B)h(C\))555 1100 y(Left:)f(\(A\))85 b(Right:)42
b(\(B)g(C\))555 1199 y(Left:)g(\(A)g(B\))87 b(Right:)41
b(\(C\))555 1299 y(Left:)h(\(A)g(B)h(C\))87 b(Right:)41
b(NIL)555 1398 y(@)680 1586 y FA(The)29 b(case)h(of)g
Fs(append)e FA(points)h(to)h(a)g(great)g(dif)n(ference)d(between)i
(Prolog)g(and)g(other)555 1691 y(languages.)f(A)21 b(collection)e(of)h
(Prolog)f(rules)h(does)g(not)g(ha)n(v)o(e)g(to)h(yield)e(a)i
(speci\002c)g(v)n(alue.)28 b(It)555 1795 y(can)23 b(instead)h(yield)f
Ft(constr)o(aints,)g FA(which,)h(when)f(combined)f(with)h(constraints)g
(generated)555 1900 y(by)h(other)h(parts)f(of)h(the)g(program,)e(yield)
i(a)g(speci\002c)g(v)n(alue.)43 b(F)o(or)24 b(e)o(xample,)h(if)g(we)g
(de\002ne)555 2004 y Fs(member)18 b FA(thus:)555 2187
y Fs(\(<-)42 b(\(member)f(?x)i(\(?x)f(.)h(?rest\)\)\))555
2287 y(\(<-)f(\(member)f(?x)i(\(_)g(.)g(?rest\)\))d(\(member)h(?x)i
(?rest\)\))555 2474 y FA(then)21 b(we)h(can)f(use)h(it)h(to)e(test)i
(for)e(list)h(membership,)e(as)i(we)g(w)o(ould)f(use)h(the)g(Lisp)f
(function)555 2579 y Fs(member)p FA(:)555 2762 y Fs(>)43
b(\(with-inference)38 b(\(member)i(a)j(\(a)g(b\)\))g(\(print)e(t\)\))
555 2861 y(T)555 2961 y(@)555 3149 y FA(b)n(ut)23 b(we)g(can)g(also)g
(use)g(it)h(to)f(establish)g(a)h(constraint)e(of)g(membership,)g
(which,)h(combined)555 3253 y(with)d(other)g(constraints,)f(yields)h(a)
h(speci\002c)f(list.)30 b(If)20 b(we)h(also)f(ha)n(v)o(e)g(a)h
(predicate)e Fs(cara)555 3436 y(\(<-)42 b(\(cara)g(\(a)h(_\)\)\))555
3623 y FA(which)15 b(is)h(true)e(of)h(an)o(y)f(tw)o(o\255element)g
(list)i(whose)f(car)g(is)h Fs(a)p FA(,)g(then)f(between)f(that)h(and)f
Fs(member)555 3728 y FA(we)21 b(ha)n(v)o(e)e(enough)f(constraint)i(for)
f(Prolog)g(to)i(construct)e(a)h(de\002nite)g(answer:)555
3911 y Fs(>)43 b(\(with-inference)38 b(\(and)j(\(cara)h(?lst\))g
(\(member)e(b)j(?lst\)\))729 4010 y(\(print)e(?lst\)\))555
4110 y(\(A)i(B\))555 4210 y(@)680 4397 y FA(This)17 b(is)i(a)f(rather)f
(tri)n(vial)h(e)o(xample,)f(b)n(ut)g(bigger)g(programs)f(can)h(be)h
(constructed)e(on)i(the)555 4502 y(same)26 b(principle.)45
b(Whene)n(v)o(er)25 b(we)h(w)o(ant)g(to)h(program)c(by)j(combining)e
(partial)h(solutions,)555 4606 y(Prolog)20 b(may)h(be)h(useful.)32
b(Indeed,)20 b(a)i(surprising)e(v)n(ariety)h(of)g(problems)f(can)h(be)h
(e)o(xpressed)555 4711 y(in)d(such)g(terms:)29 b(Figure)19
b(24.14,)f(for)g(e)o(xample,)g(sho)n(ws)h(a)h(sorting)e(algorithm)g(e)o
(xpressed)g(as)555 4816 y(a)j(collection)e(of)h(constraints)f(on)h(the)
g(solution.)p eop
%%Page: 333 346
333 345 bop 555 538 a Ft(24.4)719 b Fu(THE)18 b(NEED)g(FOR)h
(NONDETERMINISM)701 b FA(333)555 801 y Fw(24.4)99 b(The)26
b(Need)g(f)n(or)e(Nondeterminism)555 991 y FA(Chapter)33
b(22)g(e)o(xplained)f(the)i(relation)f(between)g(deterministic)g(and)g
(nondeterministic)555 1096 y(search.)45 b(A)26 b(deterministic)e
(search)h(program)e(could)i(tak)o(e)g(a)h(query)e(and)h(generate)g(all)
h(the)555 1200 y(solutions)d(which)h(satis\002ed)h(it.)41
b(A)25 b(nondeterministic)c(search)j(program)e(will)i(use)h
Ft(c)o(hoose)555 1305 y FA(to)20 b(generate)e(solutions)h(one)g(at)i(a)
f(time,)f(and)h(if)g(more)e(are)i(needed,)e(will)j(call)f
Ft(fail)g FA(to)g(restart)555 1410 y(the)g(search.)680
1514 y(When)f(we)g(ha)n(v)o(e)g(rules)g(which)g(all)h(yield)f(\002nite)
g(sets)h(of)f(bindings,)f(and)h(we)h(w)o(ant)f(all)h(of)555
1619 y(them)e(at)i(once,)e(there)g(is)i(no)f(reason)f(to)h(prefer)e
(nondeterministic)g(search.)28 b(The)19 b(dif)n(ference)555
1723 y(between)f(the)h(tw)o(o)g(strate)o(gies)g(becomes)f(apparent)g
(when)g(we)h(ha)n(v)o(e)g(queries)f(which)g(w)o(ould)555
1828 y(generate)26 b(an)g(in\002nite)h(number)e(of)i(bindings,)g(of)f
(which)h(we)g(w)o(ant)g(a)g(\002nite)h(subset.)49 b(F)o(or)555
1933 y(e)o(xample,)19 b(the)h(rules)555 2115 y Fs(\(<-)42
b(\(all-elements)d(?x)j(nil\)\))555 2214 y(\(<-)g(\(all-elements)d(?x)j
(\(?x)h(.)g(?rest\)\))729 2314 y(\(all-elements)c(?x)j(?rest\)\))555
2501 y FA(imply)21 b(all)h(the)f(f)o(acts)h(of)g(the)f(form)g
Fs(\(all-elements)38 b Ft(x)43 b(y)p Fs(\))p FA(,)22
b(where)f(e)n(v)o(ery)f(member)g(of)h Ft(y)555 2606 y
FA(is)g(equal)f(to)g Ft(x)p FA(.)30 b(W)m(ithout)19 b(backtracking)f
(we)i(could)g(handle)f(queries)g(lik)o(e:)555 2788 y
Fs(\(all-elements)38 b(a)87 b(\(a)43 b(a)g(a\)\))555
2888 y(\(all-elements)38 b(a)87 b(\(a)43 b(a)g(b\)\))555
2987 y(\(all-elements)38 b(?x)43 b(\(a)g(a)g(a\)\))555
3175 y FA(Ho)n(we)n(v)o(er)m(,)17 b(the)h(query)f Fs(\(all-elements)38
b(a)43 b(?x\))18 b FA(is)h(satis\002ed)g(for)f(an)g(in\002nite)g
(number)f(of)555 3279 y(possible)23 b Fs(?x)p FA(:)36
b Fs(nil)p FA(,)23 b Fs(\(a\))p FA(,)g Fs(\(a)43 b(a\))p
FA(,)23 b(and)g(so)h(on.)38 b(If)23 b(we)h(try)f(to)h(generate)e
(answers)h(for)g(this)555 3384 y(query)18 b(by)h(iteration,)g(the)g
(iteration)g(will)h(ne)n(v)o(er)e(terminate.)28 b(Ev)o(en)18
b(if)i(we)g(only)e(w)o(anted)h(one)555 3488 y(of)f(the)h(answers,)g(we)
g(w)o(ould)f(ne)n(v)o(er)f(get)i(a)g(result)g(from)f(an)h
(implementation)d(which)i(had)g(to)555 3593 y(generate)h(all)h(the)g
(bindings)f(for)g(the)i(query)d(before)h(it)i(could)e(be)o(gin)f(to)j
(iterate)f(through)e(the)555 3698 y(Lisp)i(e)o(xpressions)f(follo)n
(wing)g(it.)680 3802 y(This)f(is)i(why)e Fs(with-inference)13
b FA(interlea)n(v)o(es)18 b(the)h(generation)d(of)j(bindings)e(with)i
(the)555 3907 y(e)n(v)n(aluation)c(of)i(its)h(body)-5
b(.)27 b(Where)17 b(queries)f(could)g(lead)h(to)h(an)f(in\002nite)g
(number)e(of)i(answers,)555 4011 y(the)h(only)g(successful)g(approach)f
(will)i(be)f(to)h(generate)e(answers)h(one)g(at)h(a)g(time,)g(and)f
(return)555 4116 y(to)24 b(pick)f(up)h(ne)n(w)g(ones)f(by)h(restarting)
f(the)h(suspended)e(search.)40 b(Because)24 b(it)g(uses)h
Ft(c)o(hoose)555 4221 y FA(and)20 b Ft(fail)p FA(,)g(our)f(program)f
(can)i(handle)f(this)i(case:)555 4403 y Fs(>)43 b(\(block)e(nil)729
4503 y(\(with-inference)d(\(all-elements)g(a)43 b(?x\))817
4602 y(\(if)f(\(=)h(\(length)d(?x\))j(3\))991 4702 y(\(return)e(?x\))
991 4801 y(\(princ)g(?x\)\)\)\))555 4901 y(NIL\(A\)\(A)f(A\))555
5001 y(\(A)j(A)g(A\))p eop
%%Page: 334 347
334 346 bop 555 538 a FA(334)1098 b Fu(PR)n(OLOG)680
801 y FA(Lik)o(e)33 b(an)o(y)g(other)g(Prolog)f(implementation,)j(ours)
e(simulates)h(nondeterminism)d(by)555 905 y(doing)17
b(depth\255\002rst)f(search)i(with)g(backtracking.)26
b(In)17 b(theory)-5 b(,)17 b(\223logic)g(programs\224)f(run)h(under)555
1010 y(true)35 b(nondeterminism.)70 b(In)35 b(f)o(act,)j(Prolog)c
(implementations)f(al)o(w)o(ays)j(use)f(depth\255\002rst)555
1114 y(search.)44 b(F)o(ar)25 b(from)g(being)f(incon)m(v)o(enienced)d
(by)k(this)h(choice,)f(typical)g(Prolog)f(programs)555
1219 y(depend)19 b(on)g(it.)30 b(In)20 b(a)h(truly)e(nondeterministic)f
(w)o(orld,)i(the)g(query)555 1399 y Fs(\(and)42 b(\(all-elements)c(a)43
b(?x\))g(\(length)d(?x)j(3\)\))555 1583 y FA(has)20 b(an)h(answer)m(,)e
(b)n(ut)h(it)h(tak)o(es)g(you)e(arbitrarily)g(long)g(to)h(\002nd)g(out)
g(what)g(it)h(is.)680 1688 y(Not)h(only)g(does)h(Prolog)f(use)h(the)g
(depth\255\002rst)e(implementation)g(of)i(nondeterminism,)555
1793 y(it)g(uses)g(a)g(v)o(ersion)e(equi)n(v)n(alent)g(to)h(that)g
(de\002ned)g(on)g(page)f(293.)35 b(As)23 b(e)o(xplained)e(there,)h
(this)555 1897 y(implementation)i(is)i(not)g(al)o(w)o(ays)g(guaranteed)
e(to)i(terminate.)45 b(So)26 b(Prolog)f(programmers)555
2002 y(must)d(tak)o(e)f(deliberate)g(steps)h(to)f(a)n(v)n(oid)h(loops)f
(in)g(the)h(search)f(space.)33 b(F)o(or)21 b(e)o(xample,)f(if)i(we)555
2106 y(had)e(de\002ned)f Fs(member)f FA(in)i(the)h(re)n(v)o(erse)e
(order)555 2286 y Fs(\(<-)42 b(\(member)f(?x)i(\(_)g(.)g(?rest\)\))d
(\(member)h(?x)i(?rest\)\))555 2386 y(\(<-)f(\(member)f(?x)i(\(?x)f(.)h
(?rest\)\)\))555 2570 y FA(then)20 b(logically)g(it)i(w)o(ould)e(ha)n
(v)o(e)g(the)h(same)g(meaning,)e(b)n(ut)i(as)h(a)f(Prolog)f(program)f
(it)i(w)o(ould)555 2675 y(ha)n(v)o(e)g(a)h(dif)n(ferent)e(ef)n(fect.)34
b(The)21 b(original)g(de\002nition)f(of)i Fs(member)e
FA(w)o(ould)h(yield)g(an)h(in\002nite)555 2780 y(stream)27
b(of)f(answers)h(in)g(response)f(to)h(the)f(query)g Fs(\(member)40
b('a)j(?x\))p FA(,)28 b(b)n(ut)e(the)h(re)n(v)o(ersed)555
2884 y(de\002nition)19 b(will)i(yield)f(an)g(in\002nite)g(recursion,)e
(and)i(no)g(answers.)555 3136 y Fw(24.5)99 b(New)25 b(Implementation)
555 3327 y FA(In)20 b(this)h(section)f(we)h(will)g(see)g(another)e
(instance)i(of)f(a)h(f)o(amiliar)f(pattern.)29 b(In)20
b(Section)g(18.4,)555 3432 y(we)30 b(found)e(after)i(writing)f(the)g
(initial)i(v)o(ersion)d(that)i Fs(if-match)d FA(could)i(be)g(made)h
(much)555 3536 y(f)o(aster)-5 b(.)70 b(By)34 b(taking)e(adv)n(antage)g
(of)h(information)e(kno)n(wn)h(at)i(compile\255time,)h(we)f(were)555
3641 y(able)27 b(to)h(write)g(a)g(ne)n(w)f(v)o(ersion)f(which)h(did)g
(less)i(w)o(ork)e(at)h(runtime.)49 b(W)-7 b(e)29 b(sa)o(w)f(the)f(same)
555 3745 y(phenomenon)18 b(on)j(a)g(lar)o(ger)f(scale)i(in)g(Chapter)e
(19.)32 b(Our)21 b(query)f(interpreter)g(w)o(as)i(replaced)555
3850 y(by)29 b(an)f(equi)n(v)n(alent)g(b)n(ut)h(f)o(aster)g(v)o
(ersion.)54 b(The)29 b(same)g(thing)f(is)i(about)e(to)h(happen)e(to)i
(our)555 3955 y(Prolog)19 b(interpreter)-5 b(.)680 4059
y(Figures)27 b(24.7,)g(24.8,)i(and)f(24.10)f(de\002ne)g(Prolog)h(in)g
(a)h(dif)n(ferent)d(w)o(ay)-5 b(.)54 b(The)28 b(macro)555
4164 y Fs(with-inference)18 b FA(used)23 b(to)g(be)g(just)h(the)f
(interf)o(ace)f(to)h(a)h(Prolog)e(interpreter)-5 b(.)37
b(No)n(w)23 b(it)h(is)555 4268 y(most)17 b(of)f(the)h(program.)26
b(The)16 b(ne)n(w)h(program)d(has)j(the)g(same)g(general)e(shape)i(as)g
(the)g(old)f(one,)555 4373 y(b)n(ut)22 b(of)f(the)g(functions)g
(de\002ned)f(in)i(Figure)f(24.8,)f(only)h Fs(prove)f
FA(is)i(called)g(at)g(runtime.)32 b(The)555 4478 y(others)20
b(are)g(called)g(by)g Fs(with-inference)15 b FA(in)20
b(order)f(to)h(generate)f(its)i(e)o(xpansion.)680 4582
y(Figure)f(24.7)h(sho)n(ws)g(the)g(ne)n(w)h(de\002nition)e(of)h
Fs(with-inference)p FA(.)28 b(As)22 b(in)f Fs(if-match)555
4687 y FA(or)33 b Fs(with-answer)p FA(,)e(pattern)h(v)n(ariables)g(are)
h(initially)g(bound)e(to)i(gensyms)f(to)h(indicate)555
4791 y(that)26 b(the)o(y)f(ha)n(v)o(en')o(t)f(yet)i(been)f(assigned)h
(real)g(v)n(alues)f(by)h(matching.)45 b(Thus)25 b(the)h(function)555
4896 y Fs(varsym?)p FA(,)18 b(which)h Fs(match)g FA(and)g
Fs(fullbind)e FA(use)k(to)f(detect)g(v)n(ariables,)f(has)h(to)g(be)g
(changed)555 5001 y(to)g(look)g(for)f(gensyms.)p eop
%%Page: 335 348
335 347 bop 555 538 a Ft(24.5)877 b Fu(NEW)18 b(IMPLEMENT)-6
b(A)f(TION)859 b FA(335)p 555 745 2678 4 v 553 2366 4
1621 v 605 888 a Fs(\(defmacro)40 b(with-inference)d(\(query)42
b(&rest)f(body\))692 988 y(\(let)h(\(\(vars)f(\(vars-in)f(query)i
(#'simple?\)\))d(\(gb)j(\(gensym\)\)\))779 1087 y(`\(with-gensyms)c
(,vars)910 1187 y(\(setq)j(*paths*)g(nil\))910 1287 y(\(=bind)g
(\(,gb\))h(,\(gen-query)d(\(rep_)i(query\)\))997 1386
y(\(let)h(,\(mapcar)e(#'\(lambda)g(\(v\))1782 1486 y(`\(,v)i
(\(fullbind)d(,v)k(,gb\)\)\))1607 1586 y(vars\))1084
1685 y(,@body\))997 1785 y(\(fail\)\)\)\)\))605 1984
y(\(defun)e(varsym?)g(\(x\))692 2084 y(\(and)h(\(symbolp)e(x\))j(\(not)
f(\(symbol-package)37 b(x\)\)\)\))1331 2288 y FA(Figure)20
b(24.7:)28 b(Ne)n(w)21 b(tople)n(v)o(el)e(macro.)p 3231
2366 V 555 2369 2678 4 v 680 2594 a(T)-7 b(o)27 b(generate)f(the)i
(code)e(to)i(establish)f(bindings)f(for)h(the)h(query)-5
b(,)27 b Fs(with-inference)555 2698 y FA(calls)h Fs(gen-query)c
FA(\(Figure)i(24.8\).)48 b(The)27 b(\002rst)h(thing)e
Fs(gen-query)e FA(does)j(is)h(look)f(to)g(see)555 2803
y(whether)17 b(its)i(\002rst)g(ar)o(gument)d(is)j(a)g(comple)o(x)d
(query)h(be)o(ginning)f(with)i(an)g(operator)f(lik)o(e)h
Fs(and)555 2907 y FA(or)24 b Fs(or)p FA(.)42 b(This)25
b(process)f(continues)f(recursi)n(v)o(ely)g(until)i(it)g(reaches)f
(simple)g(queries,)h(which)555 3012 y(are)i(e)o(xpanded)e(into)i(calls)
h(to)g Fs(prove)p FA(.)49 b(In)27 b(the)h(original)e(implementation,)h
(such)g(logical)555 3117 y(structure)c(w)o(as)h(analyzed)f(at)h
(runtime.)39 b(A)24 b(comple)o(x)e(e)o(xpression)g(occurring)f(in)j
(the)g(body)555 3221 y(of)f(a)h(rule)g(had)f(to)h(be)f(analyzed)g(ane)n
(w)g(each)g(time)h(the)g(rule)f(w)o(as)i(used.)39 b(This)24
b(is)h(w)o(asteful)555 3326 y(because)c(the)g(logical)g(structure)g(of)
g(rules)g(and)g(queries)g(is)h(kno)n(wn)e(beforehand.)30
b(The)21 b(ne)n(w)555 3430 y(implementation)d(decomposes)h(comple)o(x)f
(e)o(xpressions)h(at)i(compile\255time.)680 3535 y(As)k(in)g(the)g(pre)
n(vious)e(implementation,)h(a)h Fs(with-inference)20
b FA(e)o(xpression)j(e)o(xpands)555 3640 y(into)15 b(code)f(which)g
(iterates)i(through)c(the)j(Lisp)g(code)g(follo)n(wing)e(the)i(query)e
(with)j(the)e(pattern)555 3744 y(v)n(ariables)23 b(bound)g(to)h
(successi)n(v)o(e)g(v)n(alues)f(established)h(by)g(the)g(rules.)41
b(The)24 b(e)o(xpansion)e(of)555 3849 y Fs(with-inference)15
b FA(concludes)k(with)h(a)h Fs(fail)p FA(,)e(which)g(will)i(restart)f
(an)o(y)g(sa)n(v)o(ed)g(states.)680 3953 y(The)35 b(remaining)f
(functions)h(in)h(Figure)f(24.8)g(generate)g(e)o(xpansions)f(for)h
(comple)o(x)555 4058 y(queries\227queries)21 b(joined)g(together)g(by)h
(operators)f(lik)o(e)i Fs(and)p FA(,)f Fs(or)p FA(,)g(and)g
Fs(not)p FA(.)35 b(If)22 b(we)h(ha)n(v)o(e)555 4163 y(a)e(query)d(lik)o
(e)555 4345 y Fs(\(and)42 b(\(big)g(?x\))g(\(red)g(?x\)\))555
4533 y FA(then)27 b(we)g(w)o(ant)h(the)f(Lisp)g(code)g(to)g(be)g(e)n(v)
n(aluated)f(only)h(with)g(those)g Fs(?x)g FA(for)g(which)f(both)555
4638 y(conjuncts)35 b(can)h(be)g(pro)o(v)o(ed.)75 b(So)37
b(to)f(generate)f(the)i(e)o(xpansion)d(of)i(an)g Fs(and)p
FA(,)k(we)c(nest)555 4742 y(the)27 b(e)o(xpansion)e(of)i(the)h(second)e
(conjunct)g(within)h(that)g(of)g(the)g(\002rst.)51 b(When)27
b Fs(\(big)42 b(?x\))555 4847 y FA(succeeds)15 b(we)h(try)f
Fs(\(red)42 b(?x\))p FA(,)16 b(and)f(if)h(that)f(succeeds,)h(we)g(e)n
(v)n(aluate)f(the)g(Lisp)h(e)o(xpressions.)555 4951 y(So)k(the)h(whole)
e(e)o(xpression)g(e)o(xpands)f(as)j(in)g(Figure)e(24.9.)p
eop
%%Page: 336 349
336 348 bop 555 538 a FA(336)1098 b Fu(PR)n(OLOG)p 555
745 2678 4 v 553 4956 4 4212 v 605 888 a Fs(\(defun)41
b(gen-query)f(\(expr)h(&optional)f(binds\))692 988 y(\(case)i(\(car)f
(expr\))779 1087 y(\(and)h(\(gen-and)e(\(cdr)i(expr\))g(binds\)\))779
1187 y(\(or)86 b(\(gen-or)e(\(cdr)42 b(expr\))g(binds\)\))779
1287 y(\(not)g(\(gen-not)e(\(cadr)i(expr\))f(binds\)\))779
1386 y(\(t)130 b(`\(prove)41 b(\(list)g(',\(car)g(expr\))1607
1486 y(,@\(mapcar)f(#'form)h(\(cdr)h(expr\)\)\))1346
1586 y(,binds\)\)\)\))605 1785 y(\(defun)f(gen-and)g(\(clauses)f
(binds\))692 1884 y(\(if)i(\(null)g(clauses\))866 1984
y(`\(=values)e(,binds\))866 2084 y(\(let)i(\(\(gb)g(\(gensym\)\)\))954
2183 y(`\(=bind)e(\(,gb\))i(,\(gen-query)d(\(car)j(clauses\))e(binds\))
1084 2283 y(,\(gen-and)g(\(cdr)i(clauses\))e(gb\)\)\)\)\))605
2482 y(\(defun)h(gen-or)g(\(clauses)f(binds\))692 2582
y(`\(choose)823 2681 y(,@\(mapcar)g(#'\(lambda)f(\(c\))k(\(gen-query)c
(c)k(binds\)\))1259 2781 y(clauses\)\)\))605 2980 y(\(defun)e(gen-not)g
(\(expr)g(binds\))692 3080 y(\(let)h(\(\(gpaths)e(\(gensym\)\)\))779
3180 y(`\(let)i(\(\(,gpaths)e(*paths*\)\))910 3279 y(\(setq)h(*paths*)g
(nil\))910 3379 y(\(choose)g(\(=bind)g(\(b\))h(,\(gen-query)d(expr)j
(binds\))1346 3478 y(\(setq)f(*paths*)g(,gpaths\))1346
3578 y(\(fail\)\))1259 3678 y(\(progn)1346 3777 y(\(setq)g(*paths*)g
(,gpaths\))1346 3877 y(\(=values)f(,binds\)\)\)\)\)\))605
4076 y(\(=defun)h(prove)g(\(query)g(binds\))736 4176
y(\(choose-bind)d(r)43 b(*rules*)e(\(=funcall)f(r)j(query)f
(binds\)\)\))605 4375 y(\(defun)f(form)h(\(pat\))692
4475 y(\(if)g(\(simple?)f(pat\))866 4574 y(pat)866 4674
y(`\(cons)g(,\(form)h(\(car)f(pat\)\))h(,\(form)f(\(cdr)h
(pat\)\)\)\)\))1283 4878 y FA(Figure)19 b(24.8:)28 b(Compilation)19
b(of)h(queries.)p 3231 4956 V 555 4960 2678 4 v eop
%%Page: 337 350
337 349 bop 555 538 a Ft(24.6)813 b Fu(ADDING)19 b(PR)n(OLOG)f(FEA)-7
b(TURES)795 b FA(337)p 555 745 2678 4 v 553 2341 4 1596
v 605 888 a Fs(\(with-inference)37 b(\(and)42 b(\(big)g(?x\))g(\(red)g
(?x\)\))692 988 y(\(print)f(?x\)\))605 1212 y FA(e)o(xpands)18
b(into:)605 1378 y Fs(\(with-gensyms)38 b(\(?x\))692
1478 y(\(setq)k(*paths*)e(nil\))692 1577 y(\(=bind)h(\(#:g1\))g
(\(=bind)g(\(#:g2\))g(\(prove)h(\(list)f('big)h(?x\))g(nil\))1389
1677 y(\(=bind)f(\(#:g3\))h(\(prove)f(\(list)g('red)h(?x\))g(#:g2\))
1477 1777 y(\(=values)e(#:g3\)\)\))823 1876 y(\(let)i(\(\(?x)g
(\(fullbind)d(?x)k(#:g1\)\)\))910 1976 y(\(print)e(?x\)\))823
2075 y(\(fail\)\)\))1210 2263 y FA(Figure)19 b(24.9:)29
b(Expansion)18 b(of)i(a)h(conjunction.)p 3231 2341 V
555 2344 2678 4 v 680 2569 a(An)f Fs(and)f FA(means)h(nesting;)g(an)g
Fs(or)g FA(means)g(a)g Ft(c)o(hoose)p FA(.)28 b(Gi)n(v)o(en)20
b(a)g(query)f(lik)o(e)555 2751 y Fs(\(or)42 b(\(big)g(?x\))h(\(red)f
(?x\)\))555 2939 y FA(we)16 b(w)o(ant)g(the)g(Lisp)h(e)o(xpressions)d
(to)i(be)g(e)n(v)n(aluated)f(for)g(v)n(alues)h(of)f Fs(?x)h
FA(established)f(by)h(either)555 3043 y(subquery)-5 b(.)39
b(The)24 b(function)f Fs(gen-or)f FA(e)o(xpands)h(into)h(a)h
Fs(choose)d FA(o)o(v)o(er)h(the)i Fs(gen-query)c FA(of)555
3148 y(each)k(of)g(the)g(ar)o(guments.)43 b(As)26 b(for)f
Fs(not)p FA(,)h Fs(gen-not)d FA(is)j(almost)f(identical)g(to)h
Fs(prove-not)555 3253 y FA(\(Figure)19 b(24.3\).)680
3357 y(Figure)j(24.10)f(sho)n(ws)j(the)f(code)f(for)h(de\002ning)e
(rules.)38 b(Rules)24 b(are)f(translated)f(directly)555
3462 y(into)15 b(Lisp)h(code)f(generated)e(by)i Fs(rule-fn)p
FA(.)26 b(Since)15 b Fs(<-)g FA(no)n(w)g(e)o(xpands)f(rules)i(into)f
(Lisp)h(code,)555 3567 y(compiling)i(a)j(\002le)g(full)f(of)g(rule)g
(de\002nitions)f(will)i(cause)f(rules)g(to)h(be)f(compiled)f
(functions.)680 3671 y(When)28 b(a)h(rule\255function)c(is)k(sent)g(a)g
(pattern,)g(it)h(tries)e(to)h(match)f(it)h(with)g(the)f(head)g(of)555
3776 y(the)h(rule)f(it)i(represents.)54 b(If)29 b(the)g(match)f
(succeeds,)j(the)e(rule\255function)d(will)j(then)g(try)f(to)555
3880 y(establish)22 b(bindings)f(for)h(the)g(body)-5
b(.)33 b(This)22 b(task)h(is)g(essentially)f(the)g(same)h(as)g(that)f
(done)f(by)555 3985 y Fs(with-inference)p FA(,)g(and)k(in)h(f)o(act)f
Fs(rule-fn)e FA(ends)j(by)f(calling)g Fs(gen-query)p
FA(.)41 b(The)25 b(rule\255)555 4090 y(function)18 b(e)n(v)o(entually)f
(returns)i(the)g(bindings)f(established)h(for)g(the)h(v)n(ariables)e
(occurring)f(in)555 4194 y(the)j(head)g(of)g(the)g(rule.)555
4447 y Fw(24.6)99 b(Adding)25 b(Pr)n(olog)g(F)n(eatur)n(es)555
4638 y FA(The)20 b(code)g(already)f(presented)g(can)i(run)e(most)i
(\223pure\224)e(Prolog)g(programs.)29 b(The)20 b(\002nal)g(step)555
4742 y(is)h(to)f(add)g(e)o(xtras)g(lik)o(e)g(cuts,)h(arithmetic,)e(and)
g Fr(I)p FA(/)p Fr(O)p FA(.)680 4847 y(Putting)h(a)i
Ft(cut)g FA(in)f(a)h(Prolog)f(rule)g(causes)h(the)f(search)g(tree)h(to)
f(be)h(pruned.)31 b(Ordinarily)-5 b(,)555 4951 y(when)21
b(our)g(program)f(encounters)f(a)k Fs(fail)p FA(,)d(it)j(backtracks)d
(to)i(the)f(last)i(choice)e(point.)33 b(The)p eop
%%Page: 338 351
338 350 bop 555 538 a FA(338)1098 b Fu(PR)n(OLOG)p 555
745 2678 4 v 553 3263 4 2518 v 605 888 a Fs(\(defvar)41
b(*rules*)f(nil\))605 1087 y(\(defmacro)g(<-)i(\(con)g(&rest)g(ant\))
692 1187 y(\(let)g(\(\(ant)f(\(if)i(\(=)g(\(length)d(ant\))i(1\))1346
1287 y(\(car)g(ant\))1346 1386 y(`\(and)f(,@ant\)\)\)\))779
1486 y(`\(length)f(\(conc1f)h(*rules*)1520 1586 y(,\(rule-fn)f(\(rep_)i
(ant\))f(\(rep_)h(con\)\)\)\)\)\))605 1785 y(\(defun)f(rule-fn)g(\(ant)
h(con\))692 1884 y(\(with-gensyms)c(\(val)k(win)g(fact)g(binds\))779
1984 y(`\(=lambda)e(\(,fact)h(,binds\))910 2084 y(\(with-gensyms)d
(,\(vars-in)i(\(list)i(ant)g(con\))g(#'simple?\))997
2183 y(\(multiple-value-)o(bin)o(d)1171 2283 y(\(,val)g(,win\))1171
2383 y(\(match)g(,fact)1477 2482 y(\(list)f(',\(car)g(con\))1738
2582 y(,@\(mapcar)f(#'form)h(\(cdr)h(con\)\)\))1477 2681
y(,binds\))1084 2781 y(\(if)h(,win)1259 2881 y(,\(gen-query)c(ant)j
(val\))1259 2980 y(\(fail\)\)\)\)\)\)\))1261 3185 y FA(Figure)19
b(24.10:)28 b(Code)20 b(for)g(de\002ning)e(rules.)p 3231
3263 V 555 3266 2678 4 v 555 3490 a(implementation)13
b(of)g Ft(c)o(hoose)g FA(in)g(Sectio)o(n)g(2)o(2.)o(4)g(stor)o(es)g
(cho)o(ice)g(p)o(oin)o(ts)g(in)g(the)f(glo)o(bal)h(v)m(ariab)o(le)555
3595 y Fs(*paths*)p FA(.)27 b(Calling)19 b Fs(fail)g
FA(restarts)g(the)h(search)f(at)h(the)f(most)h(recent)f(choice)f
(point,)h(which)555 3699 y(is)27 b(the)f(car)f(of)h Fs(*paths*)p
FA(.)44 b(Cuts)26 b(introduce)e(a)i(ne)n(w)g(complication.)44
b(When)26 b(the)g(program)555 3804 y(encounters)16 b(a)j
Fs(cut)p FA(,)f(it)h(will)g(thro)n(w)e(a)o(w)o(ay)h(some)g(of)g(the)h
(most)f(recent)g(choice)f(points)h(stored)555 3909 y(on)i
Fs(*paths*)p FA(\227speci\002cally)-5 b(,)16 b(all)21
b(those)f(stored)g(since)g(the)g(last)h(call)g(to)f Fs(prove)p
FA(.)680 4013 y(The)27 b(ef)n(fect)g(is)i(to)f(mak)o(e)g(rules)g
(mutually)e(e)o(xclusi)n(v)o(e.)51 b(W)-7 b(e)29 b(can)f(use)g(cuts)h
(to)f(get)g(the)555 4118 y(ef)n(fect)16 b(of)h(a)h(case)f(statement)g
(in)g(Prolog)f(programs.)26 b(F)o(or)17 b(e)o(xample,)f(if)h(we)g
(de\002ne)g Fs(minimum)555 4222 y FA(this)k(w)o(ay:)555
4405 y Fs(\(<-)42 b(\(minimum)f(?x)h(?y)h(?x\))f(\(lisp)g(\(<=)g(?x)h
(?y\)\)\))555 4505 y(\(<-)f(\(minimum)f(?x)h(?y)h(?y\))f(\(lisp)g(\(>)h
(?x)g(?y\)\)\))555 4692 y FA(it)21 b(will)g(w)o(ork)e(correctly)-5
b(,)19 b(b)n(ut)h(inef)n(\002ciently)-5 b(.)27 b(Gi)n(v)o(en)20
b(the)g(query)555 4875 y Fs(\(minimum)40 b(1)j(2)h(?x\))p
eop
%%Page: 339 352
339 351 bop 555 538 a Ft(24.6)813 b Fu(ADDING)19 b(PR)n(OLOG)f(FEA)-7
b(TURES)795 b FA(339)555 801 y(Prolog)19 b(will)h(immediately)f
(establish)h(that)f Fs(?x)h FA(=)g(1)g(from)f(the)g(\002rst)i(rule.)29
b(A)20 b(human)e(w)o(ould)555 905 y(stop)28 b(here,)i(b)n(ut)f(the)f
(program)e(will)k(w)o(aste)f(time)f(looking)f(for)h(more)g(answers)g
(from)g(the)555 1010 y(second)15 b(rule,)g(because)g(it)h(has)g(been)e
(gi)n(v)o(en)h(no)g(indication)f(that)h(the)g(tw)o(o)h(rules)f(are)h
(mutually)555 1114 y(e)o(xclusi)n(v)o(e.)30 b(On)21 b(the)g(a)n(v)o
(erage,)f(this)h(v)o(ersion)f(of)h Fs(minimum)d FA(will)k(do)f(50\045)g
(more)f(w)o(ork)g(than)555 1219 y(it)h(needs)f(to.)29
b(W)-7 b(e)21 b(can)f(\002x)h(the)f(problem)e(by)i(adding)f(a)i(cut)f
(after)g(the)g(\002rst)h(test:)555 1402 y Fs(\(<-)42
b(\(minimum)f(?x)h(?y)h(?x\))f(\(lisp)g(\(<=)g(?x)h(?y\)\))f(\(cut\)\))
555 1501 y(\(<-)g(\(minimum)f(?x)h(?y)h(?y\)\))555 1689
y FA(No)n(w)19 b(when)g(Prolog)f(has)i(\002nished)f(with)g(the)h
(\002rst)g(rule,)f(it)h(will)g(f)o(ail)g(all)g(the)f(w)o(ay)g(out)g(of)
h(the)555 1794 y(query)f(instead)h(of)g(mo)o(ving)e(on)i(to)g(the)g(ne)
o(xt)g(rule.)680 1898 y(It)31 b(is)h(tri)n(vially)e(easy)h(to)g(modify)
e(our)h(program)f(to)i(handle)f(cuts.)62 b(On)31 b(each)f(call)h(to)555
2003 y Fs(prove)p FA(,)f(the)f(current)e(state)j(of)f
Fs(*paths*)e FA(is)j(passed)f(as)g(a)h(parameter)-5 b(.)55
b(If)29 b(the)g(program)555 2107 y(encounters)13 b(a)i(cut,)g(it)h
(just)f(sets)g Fs(*paths*)e FA(back)h(to)g(the)h(old)f(v)n(alue)g
(passed)h(in)f(the)h(parameter)-5 b(.)555 2212 y(Figures)22
b(24.11)e(and)i(24.12)f(sho)n(w)h(the)g(code)f(which)h(has)g(to)h(be)f
(modi\002ed)f(to)h(handle)g(cuts.)555 2317 y(\(Changed)c(lines)i(are)f
(mark)o(ed)f(with)i(semicolons.)28 b(Not)19 b(all)h(the)g(changes)e
(are)h(due)g(to)h(cuts.\))680 2421 y(Cuts)h(which)g(merely)f(mak)o(e)g
(a)h(program)e(more)h(ef)n(\002cient)g(are)h(called)g
Ft(gr)m(een)f(cuts.)32 b FA(The)555 2526 y(cut)22 b(in)h
Fs(minimum)c FA(w)o(as)k(a)g(green)e(cut.)36 b(Cuts)23
b(which)e(mak)o(e)h(a)h(program)d(beha)n(v)o(e)h(dif)n(ferently)555
2630 y(are)f(called)g Ft(r)m(ed)g(cuts.)30 b FA(F)o(or)20
b(e)o(xample,)e(if)j(we)f(de\002ne)g(the)g(predicate)f
Fs(artist)g FA(as)h(follo)n(ws:)555 2813 y Fs(\(<-)42
b(\(artist)f(?x\))h(\(sculptor)e(?x\))j(\(cut\)\))555
2913 y(\(<-)f(\(artist)f(?x\))h(\(painter)f(?x\)\))555
3100 y FA(the)21 b(result)h(is)g(that,)g(if)g(there)f(are)g(an)o(y)g
(sculptors,)g(then)g(the)g(query)f(can)h(end)g(there.)33
b(If)21 b(there)555 3205 y(are)f(no)g(sculptors)f(then)h(painters)g
(get)g(to)g(be)g(considered)f(as)i(artists:)555 3388
y Fs(>)43 b(\(progn)e(\(<-)i(\(painter)d('klee\)\))947
3487 y(\(<-)j(\(painter)d('soutine\)\)\))555 3587 y(4)555
3686 y(>)j(\(with-inference)38 b(\(artist)i(?x\))729
3786 y(\(print)h(?x\)\))555 3886 y(KLEE)555 3985 y(SOUTINE)555
4085 y(@)555 4268 y FA(But)21 b(if)f(there)g(are)g(sculptors,)f(the)i
(cut)f(stops)g(inference)f(with)h(the)g(\002rst)h(rule:)555
4434 y Fs(>)43 b(\(<-)g(\(sculptor)c('hepworth\)\))555
4533 y(5)555 4633 y(>)k(\(with-inference)38 b(\(artist)i(?x\))729
4733 y(\(print)h(?x\)\))555 4832 y(HEPWORTH)555 4932
y(@)p eop
%%Page: 340 353
340 352 bop 555 538 a FA(340)1098 b Fu(PR)n(OLOG)p 555
745 2678 4 v 553 5036 4 4291 v 605 888 a Fs(\(defun)41
b(rule-fn)g(\(ant)h(con\))692 985 y(\(with-gensyms)c(\(val)k(win)g
(fact)g(binds)g(paths\))738 b(;)779 1081 y(`\(=lambda)40
b(\(,fact)h(,binds)g(,paths\))1043 b(;)910 1178 y(\(with-gensyms)38
b(,\(vars-in)i(\(list)i(ant)g(con\))g(#'simple?\))997
1275 y(\(multiple-value-)o(bin)o(d)1171 1371 y(\(,val)g(,win\))1171
1468 y(\(match)g(,fact)1477 1565 y(\(list)f(',\(car)g(con\))1738
1661 y(,@\(mapcar)f(#'form)h(\(cdr)h(con\)\)\))1477 1758
y(,binds\))1084 1855 y(\(if)h(,win)1259 1951 y(,\(gen-query)c(ant)j
(val)g(paths\))782 b(;)1259 2048 y(\(fail\)\)\)\)\)\)\))605
2241 y(\(defmacro)40 b(with-inference)d(\(query)42 b(&rest)f(body\))692
2338 y(\(let)h(\(\(vars)f(\(vars-in)f(query)i(#'simple?\)\))d(\(gb)j
(\(gensym\)\)\))779 2434 y(`\(with-gensyms)c(,vars)910
2531 y(\(setq)j(*paths*)g(nil\))910 2628 y(\(=bind)g(\(,gb\))h
(,\(gen-query)d(\(rep_)i(query\))g(nil)i('*paths*\))c(;)997
2724 y(\(let)j(,\(mapcar)e(#'\(lambda)g(\(v\))1782 2821
y(`\(,v)i(\(fullbind)d(,v)k(,gb\)\)\))1607 2918 y(vars\))1084
3014 y(,@body\))997 3111 y(\(fail\)\)\)\)\))605 3304
y(\(defun)e(gen-query)f(\(expr)h(binds)h(paths\))1043
b(;)692 3401 y(\(case)42 b(\(car)f(expr\))779 3497 y(\(and)86
b(\(gen-and)40 b(\(cdr)i(expr\))f(binds)h(paths\)\))694
b(;)779 3594 y(\(or)130 b(\(gen-or)84 b(\(cdr)42 b(expr\))f(binds)h
(paths\)\))694 b(;)779 3691 y(\(not)86 b(\(gen-not)40
b(\(cadr)h(expr\))h(binds)g(paths\)\))650 b(;)779 3787
y(\(lisp)42 b(\(gen-lisp)e(\(cadr)h(expr\))h(binds\)\))868
b(;)779 3884 y(\(is)130 b(\(gen-is)40 b(\(cadr)i(expr\))f(\(third)h
(expr\))f(binds\)\))389 b(;)779 3981 y(\(cut)86 b(`\(progn)40
b(\(setq)i(*paths*)f(,paths\))868 b(;)1389 4077 y(\(=values)41
b(,binds\)\)\))998 b(;)779 4174 y(\(t)174 b(`\(prove)40
b(\(list)i(',\(car)f(expr\))1651 4270 y(,@\(mapcar)f(#'form)h(\(cdr)h
(expr\)\)\))1389 4367 y(,binds)f(*paths*\)\)\)\))998
b(;)605 4560 y(\(=defun)41 b(prove)g(\(query)g(binds)h(paths\))1130
b(;)736 4657 y(\(choose-bind)38 b(r)43 b(*rules*)823
4754 y(\(=funcall)d(r)j(query)e(binds)h(paths\)\)\))955
b(;)1083 4958 y FA(Figure)20 b(24.11:)27 b(Adding)19
b(support)g(for)h(ne)n(w)g(operators.)p 3231 5036 V 555
5039 2678 4 v eop
%%Page: 341 354
341 353 bop 555 538 a Ft(24.6)813 b Fu(ADDING)19 b(PR)n(OLOG)f(FEA)-7
b(TURES)795 b FA(341)p 555 803 2678 4 v 553 4857 4 4054
v 605 988 a Fs(\(defun)41 b(gen-and)g(\(clauses)f(binds)h(paths\))1000
b(;)692 1087 y(\(if)42 b(\(null)g(clauses\))866 1187
y(`\(=values)e(,binds\))866 1287 y(\(let)i(\(\(gb)g(\(gensym\)\)\))910
1386 y(`\(=bind)f(\(,gb\))g(,\(gen-query)e(\(car)j(clauses\))e(binds)i
(paths\);)1041 1486 y(,\(gen-and)e(\(cdr)h(clauses\))g(gb)i
(paths\)\)\)\)\))518 b(;)605 1685 y(\(defun)41 b(gen-or)g(\(clauses)f
(binds)i(paths\))1043 b(;)692 1785 y(`\(choose)823 1884
y(,@\(mapcar)40 b(#'\(lambda)f(\(c\))k(\(gen-query)c(c)k(binds)f
(paths\)\))171 b(;)1259 1984 y(clauses\)\)\))605 2183
y(\(defun)41 b(gen-not)g(\(expr)g(binds)h(paths\))1130
b(;)692 2283 y(\(let)42 b(\(\(gpaths)e(\(gensym\)\)\))779
2383 y(`\(let)i(\(\(,gpaths)e(*paths*\)\))910 2482 y(\(setq)h(*paths*)g
(nil\))910 2582 y(\(choose)g(\(=bind)g(\(b\))h(,\(gen-query)d(expr)j
(binds)g(paths\))171 b(;)1346 2681 y(\(setq)41 b(*paths*)g(,gpaths\))
1346 2781 y(\(fail\)\))1259 2881 y(\(progn)1346 2980
y(\(setq)g(*paths*)g(,gpaths\))1346 3080 y(\(=values)f
(,binds\)\)\)\)\)\))605 3279 y(\(defmacro)g(with-binds)f(\(binds)i
(expr\))692 3379 y(`\(let)h(,\(mapcar)e(#'\(lambda)g(\(v\))i(`\(,v)g
(\(fullbind)e(,v)j(,binds\)\)\))1346 3478 y(\(vars-in)d(expr\)\))823
3578 y(,expr\)\))605 3777 y(\(defun)h(gen-lisp)f(\(expr)i(binds\))692
3877 y(`\(if)g(\(with-binds)d(,binds)i(,expr\))910 3977
y(\(=values)f(,binds\))910 4076 y(\(fail\)\)\))605 4275
y(\(defun)h(gen-is)g(\(expr1)g(expr2)h(binds\))692 4375
y(`\(aif2)f(\(match)g(,expr1)g(\(with-binds)e(,binds)i(,expr2\))g
(,binds\))997 4475 y(\(=values)f(it\))997 4574 y(\(fail\)\)\))1083
4779 y FA(Figure)20 b(24.12:)27 b(Adding)19 b(support)g(for)h(ne)n(w)g
(operators.)p 3231 4857 V 555 4860 2678 4 v eop
%%Page: 342 355
342 354 bop 555 538 a FA(342)1098 b Fu(PR)n(OLOG)p 555
745 2678 4 v 553 2274 4 1529 v 605 900 a Fq(h)p FA(rule)p
Fq(i)224 b FA(:)30 b Fs(\(<-)42 b Fq(h)p FA(sentence)p
Fq(i)21 b(h)p FA(query)p Fq(i)p Fs(\))605 1000 y Fq(h)p
FA(query)p Fq(i)163 b FA(:)30 b Fs(\(not)42 b Fq(h)p
FA(query)p Fq(i)p Fs(\))1023 1100 y FA(:)30 b Fs(\(and)42
b Fq(h)p FA(query)p Fq(i)p FA(*)p Fs(\))1023 1199 y FA(:)30
b Fs(\(lisp)42 b Fq(h)p FA(lisp)21 b(e)o(xpression)p
Fq(i)p Fs(\))1023 1299 y FA(:)30 b Fs(\(is)42 b Fq(h)p
FA(v)n(ariable)p Fq(i)h(h)p FA(lisp)21 b(e)o(xpression)p
Fq(i)p Fs(\))1023 1398 y FA(:)30 b Fs(\(cut\))1023 1498
y FA(:)g Fs(\(fail\))1023 1598 y FA(:)g Fq(h)p FA(sentence)p
Fq(i)605 1697 y(h)p FA(sentence)p Fq(i)67 b FA(:)30 b
Fs(\()p Fq(h)p FA(symbol)p Fq(i)19 b(h)p FA(ar)o(gument)p
Fq(i)p FA(*)p Fs(\))605 1797 y Fq(h)p FA(ar)o(gument)p
Fq(i)39 b FA(:)30 b Fq(h)p FA(v)n(ariable)p Fq(i)1023
1897 y FA(:)g Fq(h)p FA(lisp)21 b(e)o(xpression)p Fq(i)605
1996 y(h)p FA(v)n(ariable)p Fq(i)87 b FA(:)30 b Fs(?)p
Fq(h)p FA(symbol)p Fq(i)1312 2195 y FA(Figure)20 b(24.13:)28
b(Ne)n(w)20 b(syntax)g(of)g(rules.)p 3231 2274 V 555
2277 2678 4 v 680 2501 a(The)j(cut)h(is)g(sometimes)g(used)f(in)h
(conjunction)e(with)i(the)f(Prolog)g(f)o(ail)h(operator)-5
b(.)39 b(Our)555 2606 y(function)19 b Fs(fail)h FA(does)g(e)o(xactly)g
(the)h(same)g(thing.)31 b(Putting)20 b(a)h(cut)g(in)g(a)g(rule)g(mak)o
(es)f(it)i(lik)o(e)f(a)555 2710 y(one\255w)o(ay)d(street:)29
b(once)19 b(you)f(enter)m(,)h(you')l(re)e(committed)h(to)i(using)f
(only)f(that)i(rule.)28 b(Putting)555 2815 y(a)j(cut\255f)o(ail)f
(combination)f(in)i(a)g(rule)f(mak)o(es)h(it)g(lik)o(e)g(a)g(one\255w)o
(ay)f(street)h(in)g(a)g(dangerous)555 2919 y(neighborhood:)48
b(once)31 b(you)g(enter)m(,)j(you')l(re)c(committed)g(to)i(lea)n(ving)f
(with)h(nothing.)62 b(A)555 3024 y(typical)20 b(e)o(xample)f(is)i(in)f
(the)g(implementation)e(of)i(not\255equal:)555 3207 y
Fs(\(<-)42 b(\(not-equal)e(?x)j(?x\))f(\(cut\))f(\(fail\)\))555
3306 y(\(<-)h(\(not-equal)e(?x)j(?y\)\))555 3494 y FA(The)25
b(\002rst)i(rule)e(here)h(is)g(a)g(trap)g(for)f(impostors.)45
b(If)25 b(we')l(re)h(trying)e(to)i(pro)o(v)o(e)e(a)i(f)o(act)g(of)g
(the)555 3599 y(form)20 b Fs(\(not-equal)39 b(1)k(1\))p
FA(,)21 b(it)g(will)h(match)e(with)h(the)g(head)f(of)h(the)g(\002rst)g
(rule)g(and)f(thus)h(be)555 3703 y(doomed.)47 b(The)27
b(query)e Fs(\(not-equal)40 b(1)j(2\))p FA(,)28 b(on)e(the)h(other)f
(hand,)h(will)h(not)e(match)h(the)555 3808 y(head)20
b(of)f(the)i(\002rst)g(rule,)e(and)h(will)h(go)f(on)f(to)i(the)f
(second,)f(where)h(it)g(succeeds:)555 3990 y Fs(>)43
b(\(with-inference)38 b(\(not-equal)h('a)k('a\))729 4090
y(\(print)e(t\)\))555 4190 y(@)555 4289 y(>)i(\(with-inference)38
b(\(not-equal)h('\(a)j(a\))h('\(a)f(b\)\))729 4389 y(\(print)f(t\)\))
555 4489 y(T)555 4588 y(@)680 4776 y FA(The)15 b(code)g(sho)n(wn)h(in)g
(Figures)f(24.11)f(and)i(24.12)e(also)i(gi)n(v)o(es)g(our)f(program)f
(arithmetic,)555 4880 y Fr(I)p FA(/)p Fr(O)p FA(,)21
b(and)f(the)h(Prolog)f Fs(is)g FA(operator)-5 b(.)29
b(Figure)20 b(24.13)f(sho)n(ws)i(the)g(complete)e(syntax)h(of)h(rules)
555 4985 y(and)f(queries.)p eop
%%Page: 343 356
343 355 bop 555 538 a Ft(24.6)813 b Fu(ADDING)19 b(PR)n(OLOG)f(FEA)-7
b(TURES)795 b FA(343)680 801 y(W)-7 b(e)15 b(add)f(arithmetic)f(\(and)g
(more\))h(by)f(including)g(a)h(trapdoor)f(to)h(Lisp.)27
b(No)n(w)14 b(in)h(addition)555 905 y(to)23 b(operators)f(lik)o(e)h
Fs(and)g FA(and)f Fs(or)p FA(,)i(we)f(ha)n(v)o(e)g(the)g
Fs(lisp)f FA(operator)-5 b(.)37 b(This)23 b(may)g(be)g(follo)n(wed)555
1010 y(by)16 b(an)o(y)g(Lisp)h(e)o(xpression,)e(which)h(will)i(be)e(e)n
(v)n(aluated)f(with)i(the)g(v)n(ariables)f(within)g(it)h(bound)555
1114 y(to)24 b(the)g(bindings)e(established)h(for)g(them)h(by)f(the)h
(query)-5 b(.)38 b(If)23 b(the)h(e)o(xpression)e(e)n(v)n(aluates)h(to)
555 1219 y Fs(nil)p FA(,)d(then)g(the)h Fs(lisp)f FA(e)o(xpression)f
(as)j(a)f(whole)f(is)i(equi)n(v)n(alent)d(to)i(a)g Fs(\(fail\))p
FA(;)f(otherwise)g(it)555 1324 y(is)h(equi)n(v)n(alent)e(to)h
Fs(\(and\))p FA(.)680 1428 y(As)g(an)g(e)o(xample)f(of)g(the)h(use)h
(of)e(the)h Fs(lisp)f FA(operator)m(,)f(consider)h(the)h(Prolog)f
(de\002nition)555 1533 y(of)c Fs(ordered)p FA(,)f(which)g(is)i(true)f
(of)g(lists)i(whose)d(elements)h(are)g(arranged)f(in)h(ascending)f
(order:)555 1694 y Fs(\(<-)42 b(\(ordered)f(\(?x\)\)\))555
1794 y(\(<-)h(\(ordered)f(\(?x)h(?y)h(.)g(?ys\)\))729
1894 y(\(lisp)f(\(<=)g(?x)h(?y\)\))729 1993 y(\(ordered)e(\(?y)h(.)h
(?ys\)\)\))555 2160 y FA(In)21 b(English,)h(a)g(list)h(of)e(one)g
(element)g(is)i(ordered,)d(and)h(a)h(list)h(of)f(tw)o(o)g(or)f(more)g
(elements)h(is)555 2264 y(ordered)f(if)j(the)f(\002rst)h(element)f(of)f
(the)i(list)g(is)g(less)g(than)f(or)g(equal)g(to)g(the)g(second,)g(and)
g(the)555 2369 y(list)e(from)e(the)i(second)e(element)h(on)f(is)i
(ordered.)555 2531 y Fs(>)43 b(\(with-inference)38 b(\(ordered)i('\(1)i
(2)h(3\)\))729 2630 y(\(print)e(t\)\))555 2730 y(T)555
2829 y(@)555 2929 y(>)i(\(with-inference)38 b(\(ordered)i('\(1)i(3)h
(2\)\))729 3029 y(\(print)e(t\)\))555 3128 y(@)680 3295
y FA(By)34 b(means)f(of)h(the)f Fs(lisp)g FA(operator)f(we)i(can)f(pro)
o(vide)f(other)h(features)g(of)n(fered)f(by)555 3400
y(typical)13 b(Prolog)g(implementations.)25 b(Prolog)12
b Fr(I)p FA(/)p Fr(O)i FA(predicates)f(can)g(be)h(duplicated)e(by)h
(putting)555 3504 y(Lisp)30 b Fr(I)p FA(/)p Fr(O)h FA(calls)f(within)g
Fs(lisp)e FA(e)o(xpressions.)57 b(The)30 b(Prolog)e Fs(assert)p
FA(,)j(which)e(as)h(a)h(side\255)555 3609 y(ef)n(fect)23
b(de\002nes)g(ne)n(w)g(rules,)h(can)g(be)f(duplicated)f(by)h(calling)g
(the)h Fs(<-)f FA(macro)f(within)i Fs(lisp)555 3713 y
FA(e)o(xpressions.)680 3818 y(The)16 b Fs(is)g FA(operator)f(of)n(fers)
h(a)h(form)f(of)h(assignment.)27 b(It)17 b(tak)o(es)g(tw)o(o)g(ar)o
(guments,)e(a)i(pattern)555 3923 y(and)e(a)i(Lisp)f(e)o(xpression,)f
(and)g(tries)i(to)f(match)g(the)g(pattern)f(with)h(the)g(result)g
(returned)e(by)i(the)555 4027 y(e)o(xpression.)27 b(If)19
b(the)h(match)e(f)o(ails,)i(then)f(the)h(program)d(calls)j
Fs(fail)p FA(;)e(otherwise)h(it)h(proceeds)555 4132 y(with)h(the)g(ne)n
(w)g(bindings.)30 b(Thus,)20 b(the)h(e)o(xpression)f
Fs(\(is)42 b(?x)h(1\))20 b FA(has)i(the)f(ef)n(fect)f(of)h(setting)555
4236 y Fs(?x)i FA(to)h Fs(1)p FA(,)g(or)f(more)g(precisely)-5
b(,)22 b(insisting)i(that)f Fs(?x)g FA(be)h Fs(1)p FA(.)39
b(W)-7 b(e)24 b(need)f Fs(is)g FA(to)h Ft(calculate)p
FA(\227for)555 4341 y(e)o(xample,)19 b(to)h(calculate)g(f)o(actorials:)
555 4503 y Fs(\(<-)42 b(\(factorial)e(0)j(1\)\))555 4602
y(\(<-)f(\(factorial)e(?n)j(?f\))729 4702 y(\(lisp)f(\(>)h(?n)f(0\)\))
729 4801 y(\(is)h(?n1)f(\(-)h(?n)g(1\)\))729 4901 y(\(factorial)d(?n1)i
(?f1\))729 5001 y(\(is)h(?f)f(\(*)h(?n)g(?f1\)\)\))p
eop
%%Page: 344 357
344 356 bop 555 538 a FA(344)1098 b Fu(PR)n(OLOG)555
801 y FA(W)-7 b(e)26 b(use)f(this)g(de\002nition)e(by)i(making)e(a)i
(query)e(with)i(a)g(number)e Ft(n)i FA(as)g(the)g(\002rst)g(ar)o
(gument)555 900 y(and)20 b(a)g(v)n(ariable)f(as)i(the)f(second:)555
1066 y Fs(>)43 b(\(with-inference)38 b(\(factorial)h(8)k(?x\))729
1166 y(\(print)e(?x\)\))555 1266 y(40320)555 1365 y(@)555
1536 y FA(Note)25 b(that)f(the)h(v)n(ariables)f(used)h(in)f(a)i
Fs(lisp)d FA(e)o(xpression,)h(or)h(in)g(the)f(second)g(ar)o(gument)e
(to)555 1641 y Fs(is)p FA(,)33 b(must)e(ha)n(v)o(e)f(established)g
(bindings)f(for)i(the)f(e)o(xpression)g(to)g(return)g(a)h(v)n(alue.)60
b(This)555 1745 y(restriction)19 b(holds)h(in)g(an)o(y)g(Prolog.)28
b(F)o(or)20 b(e)o(xample,)e(the)j(query:)555 1928 y Fs
(\(with-inference)37 b(\(factorial)j(?x)j(120\))870 b(;)43
b(wrong)642 2028 y(\(print)e(?x\)\))555 2215 y FA(w)o(on')o(t)16
b(w)o(ork)g(with)h(this)h(de\002nition)e(of)h Fs(factorial)p
FA(,)d(because)i Fs(?n)h FA(will)h(be)f(unkno)n(wn)d(when)555
2320 y(the)26 b Fs(lisp)g FA(e)o(xpression)e(is)j(e)n(v)n(aluated.)47
b(So)26 b(not)g(all)h(Prolog)e(programs)g(are)h(lik)o(e)g
Fs(append)p FA(:)555 2425 y(man)o(y)19 b(insist,)i(lik)o(e)f
Fs(factorial)p FA(,)d(that)j(certain)g(of)g(their)g(ar)o(guments)e(be)i
(real)g(v)n(alues.)555 2677 y Fw(24.7)99 b(Examples)680
2868 y FA(This)23 b(\002nal)g(section)g(sho)n(ws)g(ho)n(w)f(to)h(write)
h(some)e(e)o(xample)g(Prolog)g(programs)f(in)i(our)-2786
b Fq(\016)555 2973 y FA(implementation.)42 b(The)25 b(rules)h(in)f
(Figure)g(24.14)f(de\002ne)h(quicksort.)43 b(These)25
b(rules)g(imply)555 3077 y(f)o(acts)f(of)f(the)h(form)e
Fs(\(quicksort)40 b Ft(x)j(y)p Fs(\))p FA(,)24 b(where)f
Ft(x)h FA(is)h(a)f(list)g(and)f Ft(y)h FA(is)h(a)f(list)h(of)e(the)g
(same)555 3182 y(elements)18 b(sorted)g(in)g(ascending)f(order)-5
b(.)27 b(V)-9 b(ariables)18 b(may)g(appear)f(in)h(the)h(second)e(ar)o
(gument)555 3286 y(position:)555 3469 y Fs(>)43 b(\(with-inference)38
b(\(quicksort)h('\(3)j(2)i(1\))e(?x\))729 3569 y(\(print)f(?x\)\))555
3668 y(\(1)i(2)g(3\))555 3768 y(@)680 3955 y FA(An)16
b Fr(I)p FA(/)p Fr(O)h FA(loop)f(is)i(a)f(test)g(for)f(our)g(Prolog,)g
(because)g(it)h(mak)o(es)f(use)h(of)f(the)h Fs(cut)p
FA(,)f Fs(lisp)p FA(,)g(and)555 4060 y Fs(is)21 b FA(operators.)30
b(The)21 b(code)f(is)i(sho)n(wn)e(in)h(Figure)g(24.15.)30
b(These)20 b(rules)h(should)f(be)h(in)m(v)n(ok)o(ed)555
4165 y(by)26 b(trying)f(to)h(pro)o(v)o(e)f Fs(\(echo\))p
FA(,)g(with)h(no)g(ar)o(guments.)45 b(That)26 b(query)f(will)i(match)f
(the)g(\002rst)555 4269 y(rule,)d(which)f(will)i(bind)e
Fs(?x)h FA(to)g(the)f(result)h(returned)e(by)i Fs(read)p
FA(,)f(and)g(then)h(try)f(to)h(establish)555 4374 y Fs(\(echo)42
b(?x\))p FA(.)k(The)25 b(ne)n(w)h(query)f(can)h(match)f(either)h(of)f
(the)h(second)g(tw)o(o)g(rules.)47 b(If)25 b Fs(?x)h
FA(=)555 4479 y Fs(done)p FA(,)21 b(then)h(the)g(query)e(will)j
(terminate)e(in)h(the)g(second)f(rule.)34 b(Otherwise)22
b(the)g(query)f(will)555 4583 y(only)f(match)g(the)h(third)g(rule,)f
(which)h(prints)f(the)h(v)n(alue)f(read,)h(and)f(starts)i(the)f
(process)f(o)o(v)o(er)555 4688 y(again.)p eop
%%Page: 345 358
345 357 bop 555 538 a Ft(24.7)1057 b Fu(EXAMPLES)1040
b FA(345)p 555 832 2678 4 v 553 3151 4 2319 v 605 975
a Fs(\(setq)41 b(*rules*)g(nil\))605 1175 y(\(<-)h(\(append)f(nil)h
(?ys)h(?ys\)\))605 1274 y(\(<-)f(\(append)f(\(?x)h(.)h(?xs\))f(?ys)h
(\(?x)f(.)h(?zs\)\))779 1374 y(\(append)e(?xs)h(?ys)h(?zs\)\))605
1573 y(\(<-)f(\(quicksort)e(\(?x)i(.)h(?xs\))f(?ys\))779
1673 y(\(partition)e(?xs)i(?x)h(?littles)d(?bigs\))779
1772 y(\(quicksort)g(?littles)g(?ls\))779 1872 y(\(quicksort)g(?bigs)h
(?bs\))779 1972 y(\(append)g(?ls)h(\(?x)h(.)g(?bs\))f(?ys\)\))605
2071 y(\(<-)g(\(quicksort)e(nil)i(nil\)\))605 2270 y(\(<-)g
(\(partition)e(\(?x)i(.)h(?xs\))f(?y)h(\(?x)f(.)h(?ls\))f(?bs\))779
2370 y(\(lisp)g(\(<=)g(?x)h(?y\)\))779 2470 y(\(partition)d(?xs)i(?y)h
(?ls)f(?bs\)\))605 2569 y(\(<-)g(\(partition)e(\(?x)i(.)h(?xs\))f(?y)h
(?ls)f(\(?x)h(.)g(?bs\)\))779 2669 y(\(lisp)f(\(>)g(?x)h(?y\)\))779
2769 y(\(partition)d(?xs)i(?y)h(?ls)f(?bs\)\))605 2868
y(\(<-)g(\(partition)e(nil)i(?y)h(nil)f(nil\)\))1481
3072 y FA(Figure)19 b(24.14:)28 b(Quicksort.)p 3231 3151
V 555 3154 2678 4 v 555 3505 V 553 4827 4 1322 v 605
3648 a Fs(\(<-)42 b(\(echo\))779 3748 y(\(is)h(?x)f(\(read\)\))779
3847 y(\(echo)g(?x\)\))605 3947 y(\(<-)g(\(echo)g('done\))779
4047 y(\(cut\)\))605 4146 y(\(<-)g(\(echo)g(?x\))779
4246 y(\(lisp)g(\(prog1)f(t)i(\(format)e(t)i("~A~\045")e(?x\)\)\))779
4346 y(\(is)i(?y)f(\(read\)\))779 4445 y(\(cut\))779
4545 y(\(echo)g(?y\)\))1289 4749 y FA(Figure)19 b(24.15:)28
b(An)21 b Fr(I)p FA(/)p Fr(O)f FA(loop)g(in)g(Prolog.)p
3231 4827 V 555 4830 2678 4 v eop
%%Page: 346 359
346 358 bop 555 538 a FA(346)1098 b Fu(PR)n(OLOG)680
801 y FA(Collecti)n(v)o(ely)-5 b(,)25 b(the)g(rules)g(de\002ne)g(a)h
(program)d(that)i(will)h(continue)e(to)i(echo)e(what)h(you)555
900 y(type,)19 b(until)h(you)g(type)g Fs(done)p FA(:)555
1050 y Fs(>)43 b(\(with-inference)38 b(\(echo\)\))555
1150 y(hi)555 1249 y(HI)555 1349 y(ho)555 1449 y(HO)555
1548 y(done)555 1648 y(@)555 1803 y FA(Programs)19 b(lik)o(e)i(this)f
(are)h(dif)n(\002cult)e(to)i(read)e(because)h(the)o(y)f(sub)o(v)o(ert)g
(the)h(abstract)g(model)g(of)555 1907 y(Prolog.)26 b(It)15
b(might)f(be)g(easier)h(to)g(understand)d Fs(echo)i FA(if)g(we)h(look)f
(at)h(a)g(literal)g(Lisp)f(translation)555 2069 y Fs(\(defun)41
b(echo)h(\(&rest)f(args\))642 2169 y(\(cond)h(\(\(null)f(args\))g
(\(echo)h(\(read\)\)\))904 2269 y(\(\(eq)g(\(car)g(args\))f('done\))g
(nil\))904 2368 y(\(t)h(\(format)f(t)i("~A~\045")e(\(car)h(args\)\))
1034 2468 y(\(echo)g(\(read\)\)\)\)\))555 2635 y FA(which)20
b(in)g(idiomatic)f(Common)g(Lisp)i(w)o(ould)e(be:)555
2798 y Fs(\(defun)41 b(echo)h(\(&optional)d(\(arg)j(\(read\)\)\))642
2897 y(\(unless)f(\(eq)h(arg)h('done\))729 2997 y(\(format)e(t)i
("~A~\045")e(arg\))729 3096 y(\(echo\)\)\))555 3346 y
Fw(24.8)99 b(The)26 b(Senses)g(of)f(Compile)555 3536
y FA(The)d(w)o(ord)f(\223compile\224)f(has)j(se)n(v)o(eral)e(senses.)35
b(In)21 b(the)h(most)g(general)f(sense,)i(to)f(compile)f(is)555
3641 y(to)k(transform)f(some)h(abstract)f(description)g(of)h(a)g
(program)e(into)i(lo)n(wer)n(\255le)n(v)o(el)f(code.)43
b(The)555 3745 y(program)19 b(described)h(in)i(this)g(chapter)e(is)i
(certainly)e(a)i(compiler)e(in)i(this)f(sense,)h(because)f(it)555
3850 y(translates)f(rules)g(into)g(Lisp)h(functions.)680
3955 y(In)j(a)h(more)e(speci\002c)i(sense,)g(to)g(compile)f(is)h(to)g
(transform)d(a)j(program)e(into)h(machine)555 4059 y(language.)29
b(Good)20 b(Common)g(Lisps)h(compile)f(functions)f(into)i(nati)n(v)o(e)
f(machine)f(code.)31 b(As)555 4164 y(mentioned)18 b(on)i(page)f(25,)h
(if)g(code)f(which)h(generates)f(closures)h(is)h(compiled,)d(it)j(will)
g(yield)555 4268 y(compiled)g(closures.)35 b(Thus)22
b(the)h(program)d(described)h(here)h(is)h(a)g(compiler)e(in)i(the)f
(stricter)555 4373 y(sense)15 b(as)g(well.)27 b(In)14
b(a)h(good)e(Lisp,)i(our)f(Prolog)f(programs)g(will)i(get)f(translated)
g(into)g(machine)555 4478 y(language.)680 4582 y(Ho)n(we)n(v)o(er)m(,)
35 b(the)g(program)d(described)h(here)h Ft(is)h(still)h(not)e(a)h(Pr)l
(olo)o(g)f(compiler)-9 b(.)71 b FA(F)o(or)555 4687 y(programming)29
b(languages)i(there)i(is)g(a)g(still)h(more)e(speci\002c)h(sense)g(of)g
(\223compile,)-6 b(\224)34 b(and)555 4791 y(merely)12
b(generating)g(machine)g(code)g(is)g(not)g(enoug)o(h)g(to)g(satisfy)g
(this)g(de\002nition)o(.)21 b(A)12 b(compiler)555 4896
y(for)18 b(a)h(programming)d(language)h(must)i(optimize)e(as)j(well)f
(as)h(translate.)28 b(F)o(or)19 b(e)o(xample,)e(if)i(a)555
5001 y(Lisp)h(compiler)f(is)i(ask)o(ed)f(to)h(compile)e(an)h(e)o
(xpression)f(lik)o(e)p eop
%%Page: 347 360
347 359 bop 555 538 a Ft(24.8)852 b Fu(THE)18 b(SENSES)g(OF)h(COMPILE)
834 b FA(347)555 801 y Fs(\(+)43 b(x)g(\(+)g(2)g(5\)\))555
988 y FA(it)24 b(should)f(be)g(smart)h(enough)d(to)j(realize)f(that)h
(there)f(is)i(no)e(reason)f(to)i(w)o(ait)g(until)g(runtime)555
1093 y(to)f(e)n(v)n(aluate)e Fs(\(+)43 b(2)g(5\))p FA(.)37
b(The)22 b(program)e(can)j(be)f(optimized)g(by)g(replacing)f(it)i(with)
g Fs(7)p FA(,)g(and)555 1197 y(instead)d(compiling)555
1380 y Fs(\(+)43 b(x)g(7\))680 1568 y FA(In)32 b(our)g(program,)i(all)f
(the)g(compiling)e(is)j(done)e(by)h(the)f(Lisp)i(compiler)m(,)g(and)e
(it)i(is)555 1672 y(looking)23 b(for)i(Lisp)g(optimizations,)f(not)h
(Prolog)f(optimizations.)42 b(Its)25 b(optimizations)f(will)555
1777 y(be)h(v)n(alid)f(ones,)i(b)n(ut)f(too)f(lo)n(w\255le)n(v)o(el.)42
b(The)25 b(Lisp)g(compiler)e(doesn')o(t)h(kno)n(w)f(that)i(the)g(code)
555 1882 y(it')-5 b(s)21 b(compiling)d(is)i(meant)f(to)h(represent)e
(rules.)29 b(While)20 b(a)g(real)g(Prolog)e(compiler)h(w)o(ould)g(be)
555 1986 y(looking)e(for)i(rules)g(that)g(could)g(be)g(transformed)e
(into)i(loops,)f(our)h(program)e(is)j(looking)d(for)555
2091 y(e)o(xpressions)i(that)h(yield)g(constants,)f(or)h(closures)g
(that)h(could)e(be)h(allocated)f(on)h(the)g(stack.)680
2195 y(Embedded)k(languages)i(allo)n(w)h(you)g(to)g(mak)o(e)g(the)g
(most)g(of)g(a)n(v)n(ailable)g(abstractions,)555 2300
y(b)n(ut)i(the)o(y)e(are)i(not)f(magic.)54 b(If)28 b(you)g(w)o(ant)h
(to)f(tra)n(v)o(el)h(all)g(the)f(w)o(ay)h(from)e(a)i(v)o(ery)f
(abstract)555 2405 y(representation)17 b(to)h(f)o(ast)i(machine)d
(code,)h(someone)g(still)i(has)f(to)f(tell)i(the)e(computer)f(ho)n(w)h
(to)555 2509 y(do)24 b(it.)45 b(In)24 b(this)i(chapter)d(we)j(tra)n(v)o
(elled)e(a)h(good)f(part)g(of)h(that)g(distance)f(with)h(surprisingly)
555 2614 y(little)c(code,)e(b)n(ut)h(that)h(is)g(not)f(the)g(same)g(as)
h(writing)f(a)g(true)g(Prolog)f(compiler)-5 b(.)p eop
%%Page: 348 361
348 360 bop 555 1610 a Fn(25)p 555 1872 2686 3 v 555
2131 a Fx(Object\255Oriented)43 b(Lisp)555 2568 y FA(This)37
b(chapter)e(discusses)j(object\255oriented)33 b(programming)h(in)i
(Lisp.)79 b(Common)35 b(Lisp)555 2672 y(includes)16 b(a)h(set)g(of)g
(operators)e(for)h(writing)g(object\255oriented)d(programs.)27
b(Collecti)n(v)o(ely)15 b(the)o(y)555 2777 y(are)k(called)g(the)g
(Common)f(Lisp)h(Object)g(System,)g(or)g Fr(CLOS)p FA(.)29
b(Here)19 b(we)h(consider)d Fr(CLOS)j FA(not)555 2882
y(just)27 b(as)g(a)f(w)o(ay)h(of)e(writing)h(object\255oriented)d
(programs,)j(b)n(ut)g(as)h(a)g(Lisp)f(program)e(itself.)555
2986 y(Seeing)16 b Fr(CLOS)i FA(in)f(this)g(light)g(is)g(the)g(k)o(e)o
(y)f(to)h(understanding)d(the)j(relation)f(between)g(Lisp)h(and)555
3091 y(object\255oriented)g(programming.)555 3344 y Fw(25.1)99
b(Plus)25 b(c)-39 b(\270)6 b(a)25 b(Change)555 3534 y
FA(Object\255oriented)13 b(programming)g(means)i(a)h(change)f(in)h(the)
f(w)o(ay)h(programs)e(are)i(or)o(ganized.)555 3639 y(This)30
b(change)e(is)i(analogous)d(to)j(the)f(one)g(that)g(has)h(tak)o(en)f
(place)g(in)g(the)h(distrib)n(ution)e(of)555 3743 y(processor)d(po)n
(wer)-5 b(.)47 b(In)26 b(1970,)g(a)h(multi\255user)e(computer)f(system)
j(meant)f(one)f(or)h(tw)o(o)h(big)555 3848 y(mainframes)15
b(connected)f(to)i(a)h(lar)o(ge)e(number)f(of)i(dumb)f(terminals.)27
b(No)n(w)16 b(it)h(is)g(more)f(lik)o(ely)555 3953 y(to)24
b(mean)e(a)i(lar)o(ge)e(number)g(of)h(w)o(orkstations)g(connected)e(to)
j(one)e(another)g(by)h(a)h(netw)o(ork.)555 4057 y(The)k(processing)e
(po)n(wer)h(of)h(the)g(system)g(is)g(no)n(w)g(distrib)n(uted)f(among)f
(indi)n(vidual)g(users)555 4162 y(instead)20 b(of)g(centralized)f(in)h
(one)g(big)g(computer)-5 b(.)680 4266 y(Object\255oriented)32
b(programming)f(breaks)j(up)g(traditional)g(programs)f(in)i(much)f(the)
555 4371 y(same)25 b(w)o(ay:)40 b(instead)25 b(of)g(ha)n(ving)f(a)i
(single)f(program)e(which)i(operates)f(on)h(an)g(inert)g(mass)555
4476 y(of)h(data,)g(the)g(data)g(itself)h(is)f(told)g(ho)n(w)f(to)h
(beha)n(v)o(e,)g(and)f(the)h(program)e(is)j(implicit)f(in)g(the)555
4580 y(interactions)19 b(of)h(these)g(ne)n(w)g(data)g(\223objects.)-6
b(\224)680 4685 y(F)o(or)26 b(e)o(xample,)g(suppose)g(we)h(w)o(ant)f
(to)h(write)g(a)g(program)d(to)j(\002nd)f(the)h(areas)f(of)h(tw)o
(o\255)555 4789 y(dimensional)16 b(shapes.)28 b(One)17
b(w)o(ay)g(to)g(do)g(this)g(w)o(ould)g(be)g(to)g(write)g(a)h(single)f
(function)e(which)555 4894 y(look)o(ed)k(at)i(the)f(type)g(of)f(its)j
(ar)o(gument)17 b(and)j(beha)n(v)o(ed)f(accordingly:)1835
5229 y(348)p eop
%%Page: 349 362
349 361 bop 555 538 a Ft(25.2)880 b Fu(OBJECTS)18 b(IN)h(PLAIN)g(LISP)
862 b FA(349)555 801 y Fs(\(defun)41 b(area)h(\(x\))642
900 y(\(cond)g(\(\(rectangle-p)c(x\))43 b(\(*)f(\(height)f(x\))i
(\(width)e(x\)\)\))904 1000 y(\(\(circle-p)e(x\))k(\(*)g(pi)f(\(expt)g
(\(radius)f(x\))h(2\)\)\)\)\))555 1188 y FA(The)16 b
(object\255oriented)d(approach)h(is)k(to)e(mak)o(e)g(each)g(object)g
(able)g(to)g(calculate)g(its)h(o)n(wn)f(area.)555 1292
y(The)22 b Fs(area)g FA(function)e(is)k(brok)o(en)d(apart)h(and)g(each)
g(clause)g(distrib)n(uted)g(to)g(the)h(appropriate)555
1397 y(class)e(of)f(object;)g(the)g Fs(area)f FA(method)g(of)h(the)g
Fs(rectangle)d FA(class)k(might)f(be)555 1579 y Fs(#'\(lambda)40
b(\(x\))i(\(*)h(\(height)e(x\))h(\(width)g(x\)\)\))555
1767 y FA(and)20 b(for)f(the)h Fs(circle)f FA(class,)555
1950 y Fs(#'\(lambda)40 b(\(x\))i(\(*)h(pi)g(\(expt)e(\(radius)g(x\))i
(2\)\)\))555 2137 y FA(In)22 b(this)h(model,)f(we)h(ask)g(an)f(object)g
(what)h(its)g(area)f(is,)i(and)e(it)h(responds)e(according)g(to)i(the)
555 2242 y(method)c(pro)o(vided)e(for)j(its)h(class.)680
2347 y(The)j(arri)n(v)n(al)h(of)g Fr(CLOS)g FA(might)g(seem)g(a)h(sign)
f(that)g(Lisp)h(is)g(changing)d(to)j(embrace)e(the)555
2451 y(object\255oriented)g(paradigm.)46 b(Actually)-5
b(,)27 b(it)g(w)o(ould)f(be)g(more)g(accurate)f(to)i(say)g(that)f(Lisp)
555 2556 y(is)f(staying)e(the)h(same)g(to)g(embrace)e(the)i
(object\255oriented)d(paradigm.)38 b(But)25 b(the)f(principles)555
2660 y(underlying)h(Lisp)k(don')o(t)d(ha)n(v)o(e)i(a)h(name,)g(and)e
(object\255oriented)f(programming)f(does,)k(so)58 b Fq(\016)555
2765 y FA(there)19 b(is)h(a)g(tendenc)o(y)e(no)n(w)h(to)h(describe)e
(Lisp)i(as)g(an)g(object\255oriented)c(language.)27 b(It)20
b(w)o(ould)555 2870 y(be)d(closer)g(to)g(the)g(truth)g(to)g(say)g(that)
h(Lisp)f(is)h(an)f(e)o(xtensible)f(language)g(in)h(which)f(constructs)
555 2974 y(for)k(object\255oriented)d(programming)g(can)j(easily)g(be)g
(written.)680 3079 y(Since)25 b Fr(CLOS)h FA(comes)f(pre\255written,)g
(it)i(is)f(not)g(f)o(alse)g(adv)o(ertising)e(to)h(describe)g(Lisp)h(as)
555 3183 y(an)20 b(object\255oriented)d(language.)27
b(Ho)n(we)n(v)o(er)m(,)18 b(it)j(w)o(ould)e(be)h(limiting)f(to)h(see)h
(Lisp)f(as)g(merely)555 3288 y(that.)61 b(Lisp)31 b(is)g(an)g
(object\255oriented)d(language,)j(yes,)j(b)n(ut)c(not)h(because)f(it)h
(has)g(adopted)555 3393 y(the)j(object\255oriented)d(model.)70
b(Rather)m(,)37 b(that)d(model)g(turns)f(out)h(to)g(be)g(just)h(one)e
(more)555 3497 y(permutation)17 b(of)i(the)h(abstractions)f(underlying)
d(Lisp.)29 b(And)19 b(to)h(pro)o(v)o(e)e(it)i(we)g(ha)n(v)o(e)e
Fr(CLOS)p FA(,)i(a)555 3602 y(program)e(written)i(in)g(Lisp,)g(which)g
(mak)o(es)g(Lisp)h(an)f(object\255oriented)d(language.)680
3706 y(The)34 b(aim)h(of)g(this)g(chapter)f(is)i(to)f(bring)f(out)h
(the)g(connection)e(between)h(Lisp)h(and)555 3811 y(object\255oriented)
24 b(programming)g(by)i(studying)g Fr(CLOS)h FA(as)h(an)f(e)o(xample)e
(of)i(an)g(embedded)555 3916 y(language.)33 b(This)22
b(is)h(also)f(a)g(good)f(w)o(ay)h(to)g(understand)e Fr(CLOS)i
FA(itself:)34 b(in)22 b(the)g(end,)f(nothing)555 4020
y(e)o(xplains)f(a)i(language)e(feature)g(more)h(ef)n(fecti)n(v)o(ely)e
(than)i(a)h(sk)o(etch)g(of)f(its)h(implementation.)555
4125 y(In)f(Section)h(7.6,)f(macros)g(were)g(e)o(xplained)f(this)i(w)o
(ay)-5 b(.)33 b(The)22 b(ne)o(xt)f(section)g(gi)n(v)o(es)g(a)h(similar)
555 4229 y(sk)o(etch)f(of)g(ho)n(w)g(to)h(b)n(uild)f
(object\255oriented)d(abstractions)j(on)g(top)g(of)g(Lisp.)33
b(This)22 b(program)555 4334 y(pro)o(vides)c(a)j(reference)e(point)g
(from)g(which)h(to)g(describe)g Fr(CLOS)g FA(in)g(Sections)h
(25.3\22625.6.)555 4587 y Fw(25.2)99 b(Objects)25 b(in)g(Plain)g(Lisp)
555 4777 y FA(W)-7 b(e)21 b(can)f(mold)f(Lisp)h(into)g(man)o(y)f(dif)n
(ferent)f(kinds)h(of)h(languages.)28 b(There)19 b(is)i(a)f
(particularly)555 4882 y(direct)31 b(mapping)f(between)h(the)h
(concepts)f(of)h(object\255oriented)d(programming)f(and)k(the)555
4987 y(fundamental)18 b(abstractions)h(of)h(Lisp.)30
b(The)19 b(size)i(of)f Fr(CLOS)h FA(tends)f(to)g(obscure)f(this)i(f)o
(act.)29 b(So)p eop
%%Page: 350 363
350 362 bop 555 538 a FA(350)877 b Fu(OBJECT)-5 b Fv(\255)p
Fu(ORIENTED)16 b(LISP)555 801 y FA(before)k(looking)f(at)j(what)g(we)f
(can)g(do)g(with)h Fr(CLOS)p FA(,)f(let')-5 b(s)23 b(see)f(what)f(we)g
(can)h(do)e(with)i(plain)555 905 y(Lisp.)680 1010 y(Much)h(of)h(what)g
(we)g(w)o(ant)g(from)f(object\255oriented)e(programming,)h(we)i(ha)n(v)
o(e)g(already)555 1114 y(in)e(Lisp.)34 b(W)-7 b(e)23
b(can)f(get)f(the)h(rest)g(with)g(surprisingly)e(little)j(code.)33
b(In)22 b(this)g(section,)g(we)g(will)555 1219 y(de\002ne)17
b(an)g(object)g(system)h(suf)n(\002cient)f(for)f(man)o(y)h(real)g
(applications)f(in)i(tw)o(o)f(pages)g(of)h(code.)555
1324 y(Object\255oriented)g(programming,)e(at)21 b(a)g(minimum,)d
(implies)659 1508 y(1.)41 b(objects)20 b(which)f(ha)n(v)o(e)h
(properties)659 1678 y(2.)41 b(and)19 b(respond)g(to)h(messages,)659
1848 y(3.)41 b(and)19 b(which)h(inherit)f(properties)g(and)h(methods)f
(from)g(their)h(parents.)680 2033 y(In)35 b(Lisp,)k(there)c(are)h
(already)f(se)n(v)o(eral)g(w)o(ays)h(to)f(store)h(collections)f(of)g
(properties.)555 2138 y(One)24 b(w)o(ay)f(w)o(ould)g(be)h(to)f
(represent)g(objects)g(as)i(hash\255tables,)e(and)g(store)h(their)f
(properties)555 2242 y(as)33 b(entries)e(within)h(them.)63
b(W)-7 b(e)33 b(then)f(ha)n(v)o(e)f(access)h(to)g(indi)n(vidual)e
(properties)h(through)555 2347 y Fs(gethash)p FA(:)555
2526 y Fs(\(gethash)40 b('color)h(obj\))555 2711 y FA(Since)19
b(functions)f(are)i(data)f(objects,)g(we)g(can)h(store)f(them)g(as)h
(properties)e(too.)28 b(This)20 b(means)555 2816 y(that)e(we)h(can)f
(also)h(ha)n(v)o(e)f(methods;)g(to)g(in)m(v)n(ok)o(e)f(a)i(gi)n(v)o(en)
e(method)g(of)h(an)h(object)f(is)h(to)f(funcall)555 2920
y(the)i(property)e(of)i(that)g(name:)555 3100 y Fs(\(funcall)40
b(\(gethash)h('move)g(obj\))h(obj)g(10\))555 3285 y FA(W)-7
b(e)21 b(can)f(de\002ne)g(a)h(Smalltalk)f(style)g(message\255passing)f
(syntax)h(upon)e(this)j(idea:)555 3465 y Fs(\(defun)41
b(tell)h(\(obj)g(message)f(&rest)g(args\))642 3564 y(\(apply)g
(\(gethash)g(message)f(obj\))i(obj)h(args\)\))555 3749
y FA(so)21 b(that)f(to)g(tell)h(obj)f(to)g(mo)o(v)o(e)f(10)h(we)g(can)g
(say)555 3929 y Fs(\(tell)42 b(obj)g('move)f(10\))680
4114 y FA(In)18 b(f)o(act,)g(the)h(only)e(ingredient)g(plain)h(Lisp)h
(lacks)f(is)i(inheritance,)d(and)h(we)g(can)h(pro)o(vide)555
4218 y(a)j(rudimentary)c(v)o(ersion)i(of)h(that)g(in)g(six)h(lines)g
(of)e(code,)h(by)g(de\002ning)f(a)h(recursi)n(v)o(e)f(v)o(ersion)555
4323 y(of)g Fs(gethash)p FA(:)555 4503 y Fs(\(defun)41
b(rget)h(\(obj)g(prop\))642 4602 y(\(multiple-value-b)o(in)o(d)37
b(\(val)42 b(win\))g(\(gethash)f(prop)h(obj\))729 4702
y(\(if)h(win)904 4801 y(\(values)d(val)j(win\))904 4901
y(\(let)f(\(\(par)f(\(gethash)f('parent)h(obj\)\)\))991
5001 y(\(and)h(par)g(\(rget)g(par)g(prop\)\)\)\)\)\))p
eop
%%Page: 351 364
351 363 bop 555 538 a Ft(25.2)880 b Fu(OBJECTS)18 b(IN)h(PLAIN)g(LISP)
862 b FA(351)p 555 745 2678 4 v 553 3063 4 2319 v 605
888 a Fs(\(defun)41 b(rget)h(\(obj)g(prop\))692 988 y(\(some2)f
(#'\(lambda)f(\(a\))i(\(gethash)f(prop)h(a\)\))997 1087
y(\(get-ancestors)c(obj\)\)\))605 1287 y(\(defun)j(get-ancestors)d
(\(obj\))692 1386 y(\(labels)j(\(\(getall)f(\(x\))1171
1486 y(\(append)h(\(list)h(x\))1520 1586 y(\(mapcan)f(#'getall)1869
1685 y(\(gethash)f('parents)g(x\)\)\)\)\))779 1785 y(\(stable-sort)f
(\(delete-duplicat)o(es)e(\(getall)k(obj\)\))1346 1884
y(#'\(lambda)f(\(x)i(y\))1520 1984 y(\(member)f(y)i(\(gethash)d
('parents)h(x\)\)\)\)\)\))605 2183 y(\(defun)g(some2)g(\(fn)i(lst\))692
2283 y(\(if)f(\(atom)g(lst\))866 2383 y(nil)866 2482
y(\(multiple-value-b)o(in)o(d)c(\(val)k(win\))g(\(funcall)e(fn)j(\(car)
e(lst\)\))954 2582 y(\(if)h(\(or)g(val)h(win\))1128 2681
y(\(values)e(val)h(win\))1128 2781 y(\(some2)f(fn)i(\(cdr)f
(lst\)\)\)\)\)\))1327 2985 y FA(Figure)20 b(25.1:)28
b(Multiple)20 b(inheritance.)p 3231 3063 V 555 3067 2678
4 v 555 3291 a(If)29 b(we)h(just)f(use)h Fs(rget)e FA(in)h(place)g(of)g
Fs(gethash)p FA(,)g(we)g(will)h(get)f(inherited)f(properties)g(and)555
3396 y(methods.)g(W)-7 b(e)21 b(specify)f(an)g(object')-5
b(s)20 b(parent)f(thus:)555 3578 y Fs(\(setf)42 b(\(gethash)e('parent)g
(obj\))i(obj2\))555 3766 y FA(So)34 b(f)o(ar)g(we)g(ha)n(v)o(e)f(only)g
(single)g(inheritance\227an)f(object)h(can)h(only)e(ha)n(v)o(e)i(one)f
(parent.)555 3870 y(But)23 b(we)g(can)f(ha)n(v)o(e)f(multiple)h
(inheritance)f(by)h(making)f(the)h Fs(parent)e FA(property)h(a)h(list,)
i(and)555 3975 y(de\002ning)19 b Fs(rget)g FA(as)i(in)f(Figure)g(25.1.)
680 4080 y(W)m(ith)33 b(single)g(inheritance,)i(when)e(we)g(w)o(anted)g
(to)g(retrie)n(v)o(e)f(some)i(property)d(of)i(an)555
4184 y(object,)27 b(we)f(just)h(searched)e(recursi)n(v)o(ely)f(up)i
(its)h(ancestors.)46 b(If)26 b(the)g(object)g(itself)g(had)g(no)555
4289 y(information)g(about)i(the)g(property)f(we)i(w)o(anted,)h(we)f
(look)o(ed)e(at)i(its)h(parent,)f(and)f(so)h(on.)555
4393 y(W)m(ith)17 b(multiple)f(inheritance)g(we)h(w)o(ant)g(to)g
(perform)e(the)h(same)i(kind)e(of)g(search,)h(b)n(ut)g(our)f(job)555
4498 y(is)21 b(complicated)c(by)j(the)f(f)o(act)h(that)g(an)f(object')
-5 b(s)19 b(ancestors)h(can)f(form)f(a)i(graph)f(instead)g(of)g(a)555
4603 y(simple)j(list.)34 b(W)-7 b(e)23 b(can')o(t)d(just)i(search)f
(this)h(graph)f(depth\255\002rst.)32 b(W)m(ith)21 b(multiple)g(parents)
g(we)555 4707 y(can)e(ha)n(v)o(e)f(the)h(hierarchy)d(sho)n(wn)i(in)h
(Figure)f(25.2:)28 b Fs(a)18 b FA(is)i(descended)d(from)h
Fs(b)h FA(and)f Fs(c)p FA(,)h(which)555 4812 y(are)k(both)f(descended)f
(from)h Fs(d)p FA(.)38 b(A)23 b(depth\255\002rst)f(\(or)g(rather)m(,)g
(height\255\002rst\))g(tra)n(v)o(ersal)g(w)o(ould)555
4916 y(go)h Fs(a)p FA(,)i Fs(b)p FA(,)f Fs(d)p FA(,)h
Fs(c)p FA(,)f Fs(d)p FA(.)40 b(If)24 b(the)g(desired)f(property)e(were)
j(present)f(in)h(both)f Fs(d)h FA(and)f Fs(c)p FA(,)h(we)g(w)o(ould)p
eop
%%Page: 352 365
352 364 bop 555 538 a FA(352)877 b Fu(OBJECT)-5 b Fv(\255)p
Fu(ORIENTED)16 b(LISP)p 555 745 2678 4 v 553 1805 4 1060
v 605 1611 a @beginspecial @setspecial @endspecial 1172
1727 a FA(Figure)j(25.2:)29 b(Multiple)19 b(paths)h(to)h(a)f
(superclass.)p 3231 1805 V 555 1808 2678 4 v 555 2032
a(get)g(the)g(v)n(alue)f(stored)g(in)h Fs(d)p FA(,)g(not)g(the)g(one)f
(stored)g(in)h Fs(c)p FA(.)29 b(This)20 b(w)o(ould)g(violate)f(the)h
(principle)555 2137 y(that)g(subclasses)h(o)o(v)o(erride)d(the)i(def)o
(ault)f(v)n(alues)h(pro)o(vided)e(by)i(their)g(parents.)680
2242 y(If)13 b(we)g(w)o(ant)g(to)g(implement)g(the)g(usual)g(idea)g(of)
g(inheritance,)c(we)k(should)g(ne)n(v)o(er)g(e)o(xamine)555
2346 y(an)i(object)g(before)f(one)h(of)g(its)i(descendants.)26
b(In)15 b(this)h(case,)h(the)e(proper)f(search)h(order)f(w)o(ould)555
2451 y(be)24 b Fs(a)p FA(,)g Fs(b)p FA(,)h Fs(c)p FA(,)f
Fs(d)p FA(.)40 b(Ho)n(w)24 b(can)g(we)g(ensure)f(that)h(the)g(search)f
(al)o(w)o(ays)h(tries)g(descendants)f(\002rst?)555 2555
y(The)g(simplest)h(w)o(ay)g(is)h(to)f(assemble)f(a)h(list)h(of)f(all)g
(the)g(ancestors)f(of)g(the)h(original)e(object,)555
2660 y(sort)e(the)g(list)h(so)f(that)g(no)g(object)f(appears)g(before)g
(one)g(of)h(its)h(descendants,)e(and)g(then)g(look)555
2765 y(at)i(each)f(element)f(in)i(turn.)680 2869 y(This)14
b(strate)o(gy)g(is)h(used)f(by)h Fs(get-ancestors)p FA(,)10
b(which)k(returns)g(a)h(properly)d(ordered)g(list)555
2974 y(of)h(an)g(object)g(and)g(its)g(ancestors.)24 b(T)-7
b(o)13 b(sort)g(the)g(list,)h Fs(get-ancestors)f FA(calls)g
Fs(stabl)o(e-s)o(or)o(t)-2791 b Fq(\016)555 3078 y FA(instead)17
b(of)f Fs(sort)p FA(,)h(to)g(a)n(v)n(oid)f(the)h(possibility)g(of)g
(reordering)d(parallel)i(ancestors.)28 b(Once)17 b(the)555
3183 y(list)24 b(is)f(sorted,)g Fs(rget)e FA(merely)h(searches)h(for)f
(the)g(\002rst)i(object)e(with)h(the)f(desired)g(property)-5
b(.)555 3288 y(\(The)21 b(utility)h Fs(some2)f FA(is)i(a)f(v)o(ersion)f
(of)g Fs(some)g FA(for)h(use)g(with)g(functions)f(lik)o(e)h
Fs(gethash)d FA(that)555 3392 y(indicate)h(success)g(or)g(f)o(ailure)g
(in)g(the)g(second)g(return)f(v)n(alue.\))680 3497 y(The)24
b(list)i(of)e(an)h(object')-5 b(s)24 b(ancestors)h(goes)f(from)g(most)g
(speci\002c)h(to)g(least)h(speci\002c:)38 b(if)555 3601
y Fs(orange)28 b FA(is)i(a)g(child)f(of)h Fs(citrus)p
FA(,)f(which)g(is)i(a)f(child)f(of)g Fs(fruit)p FA(,)h(then)f(the)h
(list)h(will)f(go)555 3706 y Fs(\(orange)41 b(citrus)g(fruit\))p
FA(.)680 3811 y(When)17 b(an)h(object)f(has)h(multiple)f(parents,)h
(their)f(precedence)f(goes)i(left\255to\255right.)26
b(That)555 3915 y(is,)21 b(if)f(we)h(say)555 4098 y Fs(\(setf)42
b(\(gethash)e('parents)g(x\))j(\(list)e(y)j(z\)\))555
4286 y FA(then)24 b Fs(y)h FA(will)g(be)g(considered)e(before)g
Fs(z)i FA(when)f(we)h(look)e(for)h(an)h(inherited)e(property)-5
b(.)40 b(F)o(or)555 4390 y(e)o(xample,)27 b(we)g(can)f(say)h(that)g(a)g
(patriotic)f(scoundrel)f(is)i(a)h(scoundrel)d(\002rst)i(and)f(a)h
(patriot)555 4495 y(second:)555 4677 y Fs(>)43 b(\(setq)f(scoundrel)e
(\(make-hash-tabl)o(e\))904 4777 y(patriot)g(\(make-hash-table\))904
4877 y(patriotic-scoun)o(dre)o(l)d(\(make-hash-table\))o(\))555
4976 y(#<Hash-Table)i(C4219E>)p eop
%%Page: 353 366
353 365 bop 555 538 a Ft(25.2)880 b Fu(OBJECTS)18 b(IN)h(PLAIN)g(LISP)
862 b FA(353)p 555 745 2678 4 v 553 2366 4 1621 v 605
888 a Fs(\(defun)41 b(obj)h(\(&rest)f(parents\))692 988
y(\(let)h(\(\(obj)f(\(make-hash-table\))o(\)\))779 1087
y(\(setf)h(\(gethash)e('parents)g(obj\))i(parents\))779
1187 y(\(ancestors)e(obj\))779 1287 y(obj\)\))605 1486
y(\(defun)h(ancestors)f(\(obj\))692 1586 y(\(or)i(\(gethash)f
('ancestors)e(obj\))866 1685 y(\(setf)j(\(gethash)e('ancestors)g(obj\))
i(\(get-ancestors)37 b(obj\)\)\)\))605 1884 y(\(defun)k(rget)h(\(obj)g
(prop\))692 1984 y(\(some2)f(#'\(lambda)f(\(a\))i(\(gethash)f(prop)h
(a\)\))997 2084 y(\(ancestors)e(obj\)\)\))1206 2288 y
FA(Figure)20 b(25.3:)28 b(A)21 b(function)e(to)h(create)g(objects.)p
3231 2366 V 555 2369 2678 4 v 555 2572 a Fs(>)43 b(\(setf)f(\(gethash)e
('serves)h(scoundrel\))e('self)904 2671 y(\(gethash)h('serves)h
(patriot\))127 b('country)904 2771 y(\(gethash)40 b('parents)g
(patriotic-scoundr)o(el)o(\))1296 2871 y(\(list)h(scoundrel)f
(patriot\)\))555 2970 y(\(#<Hash-Table)e(C41C7E>)j(#<Hash-Table)e
(C41F0E>\))555 3070 y(>)k(\(rget)f(patriotic-scoun)o(dre)o(l)37
b('serves\))555 3169 y(SELF)555 3269 y(T)680 3430 y FA(Let')-5
b(s)17 b(mak)o(e)f(some)g(impro)o(v)o(ements)e(to)j(this)g(sk)o(eletal)
g(system.)28 b(W)-7 b(e)18 b(could)e(be)o(gin)f(with)i(a)555
3534 y(function)d(to)i(create)f(objects.)27 b(This)16
b(function)e(should)g(b)n(uild)h(a)h(list)h(of)e(an)h(object')-5
b(s)15 b(ancestors)555 3639 y(at)21 b(the)g(time)g(the)g(object)f(is)i
(created.)30 b(The)21 b(current)e(code)h(b)n(uilds)h(these)g(lists)h
(when)e(queries)555 3743 y(are)f(made,)f(b)n(ut)g(there)h(is)g(no)g
(reason)f(not)g(to)h(do)f(it)h(earlier)-5 b(.)29 b(Figure)18
b(25.3)g(de\002nes)g(a)h(function)555 3848 y(called)i
Fs(obj)f FA(which)h(creates)g(a)g(ne)n(w)g(object,)g(storing)f(within)h
(it)h(a)f(list)h(of)f(its)h(ancestors.)31 b(T)-7 b(o)555
3953 y(tak)o(e)20 b(adv)n(antage)e(of)i(stored)g(ancestors,)g(we)g
(also)h(rede\002ne)e Fs(rget)p FA(.)680 4057 y(Another)14
b(place)i(for)f(impro)o(v)o(ement)e(is)k(the)e(syntax)h(of)f(message)h
(calls.)29 b(The)15 b Fs(tell)g FA(itself)555 4162 y(is)20
b(unnecessary)d(clutter)m(,)h(and)g(because)g(it)h(mak)o(es)g(v)o(erbs)
f(come)g(second,)g(it)h(means)g(that)f(our)555 4266 y(programs)g(can)i
(no)g(longer)f(be)h(read)g(lik)o(e)g(normal)f(Lisp)i(pre\002x)e(e)o
(xpressions:)555 4422 y Fs(\(tell)42 b(\(tell)f(obj)h('find-owner\))d
('find-owner\))680 4582 y FA(W)-7 b(e)14 b(can)f(get)h(rid)f(of)g(the)g
Fs(tell)g FA(syntax)f(by)h(de\002ning)g(each)g(property)e(name)i(as)h
(a)g(function,)555 4687 y(as)19 b(in)g(Figure)f(25.4.)27
b(The)19 b(optional)e(ar)o(gument)f Fs(meth?)p FA(,)h(if)i(true,)f
(signals)h(that)g(this)g(property)555 4791 y(should)f(be)g(treated)g
(as)h(a)g(method.)28 b(Otherwise)18 b(it)h(will)h(be)e(treated)g(as)h
(a)g(slot,)h(and)e(the)g(v)n(alue)555 4896 y(retrie)n(v)o(ed)26
b(by)g Fs(rget)g FA(will)i(simply)f(be)g(returned.)49
b(Once)27 b(we)g(ha)n(v)o(e)g(de\002ned)f(the)h(name)g(of)555
5001 y(either)20 b(kind)f(of)h(property)-5 b(,)p eop
%%Page: 354 367
354 366 bop 555 538 a FA(354)877 b Fu(OBJECT)-5 b Fv(\255)p
Fu(ORIENTED)16 b(LISP)p 555 745 2678 4 v 553 2466 4 1721
v 605 888 a Fs(\(defmacro)40 b(defprop)g(\(name)i(&optional)e(meth?\))
692 988 y(`\(progn)823 1087 y(\(defun)h(,name)g(\(obj)h(&rest)g(args\))
910 1187 y(,\(if)g(meth?)1128 1287 y(`\(run-methods)c(obj)k(',name)g
(args\))1128 1386 y(`\(rget)f(obj)h(',name\)\)\))823
1486 y(\(defsetf)e(,name)i(\(obj\))f(\(val\))910 1586
y(`\(setf)g(\(gethash)f(',',name)h(,obj\))g(,val\)\)\)\))605
1785 y(\(defun)g(run-methods)e(\(obj)j(name)g(args\))692
1884 y(\(let)g(\(\(meth)f(\(rget)h(obj)g(name\)\)\))779
1984 y(\(if)h(meth)954 2084 y(\(apply)e(meth)h(obj)g(args\))954
2183 y(\(error)f("No)h(~A)h(method)e(for)h(~A.")g(name)g(obj\)\)\)\))
1369 2388 y FA(Figure)19 b(25.4:)29 b(Functional)19 b(syntax.)p
3231 2466 V 555 2469 2678 4 v 555 2688 a Fs(\(defprop)40
b(find-owner)g(t\))555 2868 y FA(we)21 b(can)f(refer)f(to)h(it)h(with)g
(a)f(function)f(call,)h(and)g(our)f(code)h(will)h(read)e(lik)o(e)i
(Lisp)f(again:)555 3044 y Fs(\(find-owner)39 b(\(find-owner)g(obj\)\))
555 3225 y FA(Our)20 b(pre)n(vious)e(e)o(xample)h(no)n(w)h(becomes)f
(some)n(what)g(more)h(readable:)555 3400 y Fs(>)43 b(\(progn)729
3500 y(\(setq)f(scoundrel)e(\(obj\)\))729 3600 y(\(setq)i(patriot)f
(\(obj\)\))729 3699 y(\(setq)h(patriotic-scound)o(re)o(l)c(\(obj)k
(scoundrel)d(patriot\)\))729 3799 y(\(defprop)i(serves\))729
3898 y(\(setf)h(\(serves)f(scoundrel\))e('self\))729
3998 y(\(setf)j(\(serves)f(patriot\))f('country\))729
4098 y(\(serves)h(patriotic-scound)o(rel)o(\)\))555 4197
y(SELF)555 4297 y(T)680 4478 y FA(In)27 b(the)g(current)f
(implementation,)h(an)h(object)e(can)i(ha)n(v)o(e)f(at)g(most)h(one)f
(method)f(of)h(a)555 4582 y(gi)n(v)o(en)e(name.)46 b(An)26
b(object)f(either)h(has)g(its)h(o)n(wn)f(method,)g(or)f(inherits)h
(one.)46 b(It)26 b(w)o(ould)g(be)555 4687 y(con)m(v)o(enient)19
b(to)j(ha)n(v)o(e)g(more)f(\003e)o(xibility)g(on)h(this)g(point,)f(so)i
(that)f(we)g(could)f(combine)g(local)555 4791 y(and)k(inherited)f
(methods.)44 b(F)o(or)25 b(e)o(xample,)g(we)h(might)e(w)o(ant)i(the)f
Fs(move)g FA(method)f(of)h(some)555 4896 y(object)e(to)h(be)g(the)g
Fs(move)f FA(method)f(of)i(its)h(parent,)e(b)n(ut)h(with)g(some)g(e)o
(xtra)f(code)g(run)g(before)555 5001 y(or)d(afterw)o(ards.)p
eop
%%Page: 355 368
355 367 bop 555 538 a Ft(25.2)880 b Fu(OBJECTS)18 b(IN)h(PLAIN)g(LISP)
862 b FA(355)680 801 y(T)-7 b(o)16 b(allo)n(w)g(for)f(such)g
(possibilities,)i(we)g(will)f(modify)f(our)g(program)f(to)i(include)f
(before\255,)555 905 y(after)n(\255,)23 b(and)g(around\255methods.)34
b(Before\255methods)21 b(allo)n(w)i(us)h(to)f(say)g(\223But)h(\002rst,)
g(do)f(this.)-6 b(\224)555 1010 y(The)o(y)27 b(are)g(called,)j(most)e
(speci\002c)f(\002rst,)k(as)d(a)g(prelude)f(to)h(the)f(rest)i(of)e(the)
h(method)e(call.)555 1114 y(After)n(\255methods)20 b(allo)n(w)j(us)f
(to)h(say)g(\223P)-9 b(.S.)35 b(Do)23 b(this)g(too.)-6
b(\224)35 b(The)o(y)21 b(are)i(called,)f(most)g(speci\002c)555
1219 y(last,)e(as)f(an)f(epilogue)f(to)i(the)g(method)e(call.)29
b(Between)19 b(them,)f(we)h(run)f(what)g(used)g(to)h(be)g(the)555
1324 y(whole)f(method,)e(and)i(is)h(no)n(w)f(called)g(the)g
Ft(primary)g(method.)27 b FA(The)18 b(v)n(alue)f(of)h(this)h(call)g(is)
g(the)555 1428 y(one)h(returned,)e(e)n(v)o(en)h(if)h(after)n
(\255methods)f(are)h(called)g(later)-5 b(.)680 1533 y(Before\255)23
b(and)h(after)n(\255methods)e(allo)n(w)j(us)f(to)h(wrap)f(ne)n(w)g
(beha)n(vior)f(around)f(the)j(call)f(to)555 1638 y(the)i(primary)e
(method.)44 b(Around\255methods)22 b(pro)o(vide)i(a)i(more)f(drastic)h
(w)o(ay)g(of)f(doing)g(the)555 1742 y(same)g(thing.)42
b(If)24 b(an)h(around\255method)c(e)o(xists,)26 b(it)f(will)h(be)e
(called)h Ft(instead)f FA(of)g(the)h(primary)555 1847
y(method.)54 b(Then,)31 b(at)e(its)h(o)n(wn)f(discretion,)h(the)f
(around\255method)c(may)j(itself)i(in)m(v)n(ok)o(e)e(the)555
1951 y(primary)19 b(method)f(\(via)i Fs(call-next)p FA(,)d(which)j
(will)h(be)f(pro)o(vided)d(in)k(Figure)e(25.7\).)680
2056 y(T)-7 b(o)27 b(allo)n(w)h(auxiliary)e(methods,)j(we)f(modify)e
Fs(run-methods)e FA(and)j Fs(rget)f FA(as)j(in)f(Fig\255)555
2161 y(ures)h(25.5)f(and)g(25.6.)54 b(In)29 b(the)g(pre)n(vious)f(v)o
(ersion,)h(when)g(we)g(ran)g(some)f(method)g(of)h(an)555
2265 y(object,)24 b(we)h(ran)f(just)h(one)e(function:)36
b(the)24 b(most)h(speci\002c)f(primary)f(method.)39 b(W)-7
b(e)26 b(ran)e(the)555 2370 y(\002rst)e(method)d(we)i(encountered)e
(when)h(searching)f(the)i(list)h(of)f(ancestors.)31 b(W)m(ith)21
b(auxiliary)555 2474 y(methods,)e(the)h(calling)g(sequence)f(no)n(w)g
(goes)h(as)h(follo)n(ws:)659 2662 y(1.)41 b(The)19 b(most)i(speci\002c)
f(around\255method,)c(if)k(there)g(is)h(one.)659 2833
y(2.)41 b(Otherwise,)19 b(in)i(order:)812 3021 y(\(a\))40
b(All)21 b(before\255methods,)c(from)i(most)h(speci\002c)g(to)h(least)g
(speci\002c.)807 3158 y(\(b\))40 b(The)20 b(most)g(speci\002c)h
(primary)d(method)h(\(what)h(we)g(used)g(to)h(call\).)812
3296 y(\(c\))40 b(All)21 b(after)n(\255methods,)d(from)h(least)i
(speci\002c)f(to)h(most)f(speci\002c.)680 3484 y(Notice)h(also)g(that)g
(instead)g(of)g(being)f(a)h(single)g(function,)f(a)h(method)f(becomes)g
(a)i(four)n(\255)555 3589 y(part)e(structure.)28 b(T)-7
b(o)20 b(de\002ne)g(a)h(\(primary\))d(method,)g(instead)i(of)g(saying:)
555 3771 y Fs(\(setf)42 b(\(gethash)e('move)h(obj\))h(#'\(lambda)e
(...\)\))555 3959 y FA(we)21 b(say:)555 4141 y Fs(\(setf)42
b(\(meth-primary)c(\(gethash)i('move)i(obj\)\))f(#'\(lambda)f(...\)\))
555 4329 y FA(F)o(or)21 b(this)g(and)g(other)f(reasons,)g(our)h(ne)o
(xt)f(step)h(should)f(be)h(to)g(de\002ne)g(a)g(macro)f(for)h
(de\002ning)555 4434 y(methods.)680 4538 y(Figure)26
b(25.7)g(sho)n(ws)h(the)g(de\002nition)f(of)h(such)g(a)g(macro.)49
b(The)27 b(b)n(ulk)g(of)g(this)g(code)g(is)555 4643 y(tak)o(en)22
b(up)f(with)h(implementing)e(tw)o(o)i(functions)f(that)h(methods)f(can)
h(use)g(to)g(refer)f(to)h(other)555 4748 y(methods.)42
b(Around\255)22 b(and)i(primary)g(methods)f(can)i(use)g
Fs(call-next)c FA(to)k(in)m(v)n(ok)o(e)f(the)g Ft(ne)n(xt)555
4852 y(method,)c FA(which)g(is)h(the)g(code)f(that)h(w)o(ould)f(ha)n(v)
o(e)g(run)g(if)h(the)g(current)e(method)h(didn')o(t)f(e)o(xist.)555
4957 y(F)o(or)g(e)o(xample,)e(if)j(the)f(currently)e(running)g(method)g
(is)j(the)f(only)f(around\255method,)d(the)k(ne)o(xt)p
eop
%%Page: 356 369
356 368 bop 555 538 a FA(356)877 b Fu(OBJECT)-5 b Fv(\255)p
Fu(ORIENTED)16 b(LISP)p 555 745 2678 4 v 553 4259 4 3514
v 605 888 a Fs(\(defstruct)39 b(meth)86 b(around)41 b(before)g(primary)
g(after\))605 1087 y(\(defmacro)f(meth-)h(\(field)g(obj\))692
1187 y(\(let)h(\(\(gobj)f(\(gensym\)\)\))779 1287 y(`\(let)h(\(\(,gobj)
e(,obj\)\))910 1386 y(\(and)i(\(meth-p)f(,gobj\))1128
1486 y(\(,\(symb)g('meth-)g(field\))g(,gobj\)\)\)\)\))605
1685 y(\(defun)g(run-methods)e(\(obj)j(name)g(args\))692
1785 y(\(let)g(\(\(pri)f(\(rget)h(obj)g(name)g(:primary\)\)\))779
1884 y(\(if)h(pri)954 1984 y(\(let)e(\(\(ar)h(\(rget)g(obj)g(name)g
(:around\)\)\))1041 2084 y(\(if)g(ar)1215 2183 y(\(apply)f(ar)i(obj)f
(args\))1215 2283 y(\(run-core-method)o(s)c(obj)k(name)g(args)g
(pri\)\)\))954 2383 y(\(error)f("No)h(primary)f(~A)h(method)g(for)g
(~A.")g(name)g(obj\)\)\)\))605 2582 y(\(defun)f(run-core-methods)c
(\(obj)42 b(name)g(args)g(&optional)e(pri\))692 2681
y(\(multiple-value-)o(pro)o(g1)779 2781 y(\(progn)h(\(run-befores)e
(obj)j(name)g(args\))1084 2881 y(\(apply)f(\(or)i(pri)f(\(rget)g(obj)g
(name)g(:primary\)\))1389 2980 y(obj)h(args\)\))779 3080
y(\(run-afters)c(obj)k(name)e(args\)\)\))605 3279 y(\(defun)g(rget)h
(\(obj)g(prop)g(&optional)e(meth)i(\(skip)f(0\)\))692
3379 y(\(some2)g(#'\(lambda)f(\(a\))1171 3478 y(\(multiple-value-b)o
(ind)d(\(val)42 b(win\))g(\(gethash)e(prop)i(a\))1259
3578 y(\(if)g(win)1433 3678 y(\(case)f(meth)h(\(:around)84
b(\(meth-)41 b(around)g(val\)\))1912 3777 y(\(:primary)f(\(meth-)h
(primary)g(val\)\))1912 3877 y(\(t)i(\(values)e(val)h(win\)\)\)\)\)\))
997 3977 y(\(nthcdr)f(skip)h(\(ancestors)d(obj\)\)\)\))1355
4181 y FA(Figure)20 b(25.5:)28 b(Auxiliary)19 b(methods.)p
3231 4259 V 555 4262 2678 4 v 555 4486 a(method)f(w)o(ould)h(be)g(the)g
(usual)h(sandwich)e(of)h(before\255,)f(most)h(speci\002c)h(primary)-5
b(,)17 b(and)i(after)n(\255)555 4591 y(methods.)27 b(W)m(ithin)17
b(the)h(most)f(speci\002c)h(primary)e(method,)g(the)i(ne)o(xt)e(method)
g(w)o(ould)h(be)h(the)555 4696 y(second)f(most)i(speci\002c)f(primary)f
(method.)27 b(Since)18 b(the)g(beha)n(vior)f(of)h Fs(call-next)d
FA(depends)555 4800 y(on)29 b(where)g(it)h(is)g(called,)h(it)f(is)g(ne)
n(v)o(er)e(de\002ned)g(globally)g(with)i(a)f Fs(defun)p
FA(,)h(b)n(ut)f(is)i(de\002ned)555 4905 y(locally)20
b(within)g(each)g(method)e(de\002ned)i(by)f Fs(defmeth)p
FA(.)p eop
%%Page: 357 370
357 369 bop 555 538 a Ft(25.2)880 b Fu(OBJECTS)18 b(IN)h(PLAIN)g(LISP)
862 b FA(357)p 555 745 2678 4 v 553 2366 4 1621 v 605
888 a Fs(\(defun)41 b(run-befores)e(\(obj)j(prop)g(args\))692
988 y(\(dolist)f(\(a)h(\(ancestors)e(obj\)\))779 1087
y(\(let)i(\(\(bm)g(\(meth-)f(before)g(\(gethash)g(prop)g(a\)\)\)\))866
1187 y(\(if)i(bm)f(\(apply)g(bm)g(obj)h(args\)\)\)\)\))605
1386 y(\(defun)e(run-afters)e(\(obj)j(prop)g(args\))692
1486 y(\(labels)f(\(\(rec)g(\(lst\))1171 1586 y(\(when)h(lst)1259
1685 y(\(rec)g(\(cdr)f(lst\)\))1259 1785 y(\(let)h(\(\(am)f(\(meth-)h
(after)2000 1884 y(\(gethash)e(prop)i(\(car)g(lst\)\)\)\)\))1346
1984 y(\(if)g(am)h(\(apply)e(am)i(\(car)f(lst\))g(args\)\)\)\)\)\))779
2084 y(\(rec)g(\(ancestors)e(obj\)\)\)\))1153 2288 y
FA(Figure)20 b(25.6:)28 b(Auxiliary)19 b(methods)g(\(continued\).)p
3231 2366 V 555 2369 2678 4 v 680 2594 a(An)26 b(around\255)e(or)i
(primary)e(method)h(can)h(use)h Fs(next-p)d FA(to)j(check)e(whether)g
(there)h(is)h(a)555 2698 y(ne)o(xt)e(method.)43 b(If)25
b(the)h(current)e(method)g(is)i(the)f(primary)f(method)g(of)h(an)h
(object)e(with)i(no)555 2803 y(parents,)g(for)e(e)o(xample,)h(there)g
(w)o(ould)g(be)g(no)g(ne)o(xt)f(method.)43 b(Since)26
b Fs(call-next)c FA(yields)555 2907 y(an)k(error)e(when)i(there)f(is)i
(no)e(ne)o(xt)g(method,)h Fs(next-p)d FA(should)i(usually)g(be)h
(called)g(to)g(test)555 3012 y(the)j(w)o(aters)g(\002rst.)55
b(Lik)o(e)28 b Fs(call-next)p FA(,)f Fs(next-p)g FA(is)i(de\002ned)f
(locally)g(within)g(indi)n(vidual)555 3117 y(methods.)680
3221 y(The)15 b(ne)n(w)h(macro)f Fs(defmeth)f FA(is)j(used)f(as)h
(follo)n(ws.)27 b(If)16 b(we)h(just)f(w)o(ant)h(to)f(de\002ne)g(the)g
Fs(area)555 3326 y FA(method)j(of)h(the)g Fs(rectangle)d
FA(object,)i(we)i(say)555 3508 y Fs(\(setq)42 b(rectangle)d(\(obj\)\))
555 3608 y(\(defprop)h(height\))555 3708 y(\(defprop)g(width\))555
3807 y(\(defmeth)g(\(area\))h(rectangle)f(\(r\))642 3907
y(\(*)j(\(height)e(r\))h(\(width)f(r\)\)\))555 4095 y
FA(No)n(w)20 b(the)g(area)g(of)g(an)g(instance)g(is)h(calculated)f
(according)e(to)i(the)g(method)f(of)h(the)g(class:)555
4277 y Fs(>)43 b(\(let)f(\(\(myrec)f(\(obj)h(rectangle\)\)\))729
4377 y(\(setf)g(\(height)f(myrec\))g(2)991 4476 y(\(width)g(myrec\))85
b(3\))729 4576 y(\(area)42 b(myrec\)\))555 4676 y(6)p
eop
%%Page: 358 371
358 370 bop 555 538 a FA(358)877 b Fu(OBJECT)-5 b Fv(\255)p
Fu(ORIENTED)16 b(LISP)p 555 745 2678 4 v 553 4956 4 4212
v 605 888 a Fs(\(defmacro)40 b(defmeth)g(\(\(name)h(&optional)f(\(type)
i(:primary\)\))1433 988 y(obj)g(parms)g(&body)f(body\))692
1087 y(\(let)h(\(\(gobj)f(\(gensym\)\)\))779 1187 y(`\(let)h(\(\(,gobj)
e(,obj\)\))910 1287 y(\(defprop)g(,name)i(t\))910 1386
y(\(unless)f(\(meth-p)f(\(gethash)h(',name)g(,gobj\)\))997
1486 y(\(setf)h(\(gethash)e(',name)h(,gobj\))g(\(make-meth\)\)\))910
1586 y(\(setf)g(\(,\(symb)g('meth-)g(type\))h(\(gethash)e(',name)h
(,gobj\)\))1171 1685 y(,\(build-meth)e(name)j(type)g(gobj)g(parms)f
(body\)\)\)\)\))605 1884 y(\(defun)g(build-meth)e(\(name)j(type)g(gobj)
g(parms)f(body\))692 1984 y(\(let)h(\(\(gargs)f(\(gensym\)\)\))779
2084 y(`#'\(lambda)f(\(&rest)h(,gargs\))1041 2183 y(\(labels)1128
2283 y(\(\(call-next)e(\(\))1259 2383 y(,\(if)j(\(or)g(\(eq)g(type)g
(:primary\))1651 2482 y(\(eq)g(type)g(:around\)\))1477
2582 y(`\(cnm)f(,gobj)h(',name)f(\(cdr)h(,gargs\))e(,type\))1477
2681 y('\(error)g("Illegal)h(call-next."\)\)\))1171 2781
y(\(next-p)g(\(\))1259 2881 y(,\(case)g(type)1389 2980
y(\(:around)1433 3080 y(`\(or)h(\(rget)f(,gobj)h(',name)f(:around)g
(1\))1651 3180 y(\(rget)g(,gobj)h(',name)f(:primary\)\)\))1389
3279 y(\(:primary)1433 3379 y(`\(rget)g(,gobj)h(',name)f(:primary)f
(1\)\))1389 3478 y(\(t)j(nil\)\)\)\))1128 3578 y(\(apply)e(#'\(lambda)f
(,parms)h(,@body\))g(,gargs\)\)\)\)\))605 3777 y(\(defun)g(cnm)h(\(obj)
g(name)g(args)g(type\))692 3877 y(\(case)g(type)779 3977
y(\(:around)84 b(\(let)42 b(\(\(ar)g(\(rget)f(obj)i(name)f(:around)e
(1\)\)\))1302 4076 y(\(if)j(ar)1477 4176 y(\(apply)e(ar)h(obj)h(args\))
1477 4275 y(\(run-core-metho)o(ds)37 b(obj)42 b(name)g(args\)\)\)\))779
4375 y(\(:primary)e(\(let)i(\(\(pri)f(\(rget)h(obj)g(name)g(:primary)f
(1\)\)\))1302 4475 y(\(if)i(pri)1477 4574 y(\(apply)e(pri)h(obj)g
(args\))1477 4674 y(\(error)f("No)h(next)g(method."\)\)\)\)\)\))1369
4878 y FA(Figure)19 b(25.7:)29 b(De\002ning)19 b(methods.)p
3231 4956 V 555 4960 2678 4 v eop
%%Page: 359 372
359 371 bop 555 538 a Ft(25.2)880 b Fu(OBJECTS)18 b(IN)h(PLAIN)g(LISP)
862 b FA(359)p 555 745 2678 4 v 553 1370 4 625 v 605
888 a Fs(\(defmacro)40 b(undefmeth)g(\(\(name)h(&optional)f(\(type)h
(:primary\)\))e(obj\))692 988 y(`\(setf)i(\(,\(symb)g('meth-)g(type\))g
(\(gethash)g(',name)g(,obj\)\))997 1087 y(nil\)\))1342
1292 y FA(Figure)19 b(25.8:)29 b(Remo)o(ving)18 b(methods.)p
3231 1370 V 555 1373 2678 4 v 555 1586 a(In)24 b(a)g(more)f
(complicated)f(e)o(xample,)i(suppose)f(we)h(ha)n(v)o(e)f(de\002ned)g(a)
i Fs(backup)d FA(method)g(for)555 1691 y(the)e Fs(filesystem)d
FA(object:)555 1860 y Fs(\(setq)42 b(filesystem)d(\(obj\)\))555
1959 y(\(defmeth)h(\(backup)h(:before\))f(filesystem)g(\(fs\))642
2059 y(\(format)h(t)i("Remember)d(to)j(mount)e(the)i(tape.~\045"\)\))
555 2159 y(\(defmeth)d(\(backup\))h(filesystem)e(\(fs\))642
2258 y(\(format)i(t)i("Oops,)e(deleted)g(all)h(your)g(files.~\045"\))
642 2358 y('done\))555 2458 y(\(defmeth)e(\(backup)h(:after\))g
(filesystem)e(\(fs\))642 2557 y(\(format)i(t)i("Well,)e(that)h(was)g
(easy.~\045"\)\))555 2731 y FA(The)20 b(normal)f(sequence)g(of)h(calls)
h(will)g(be)f(as)h(follo)n(ws:)555 2900 y Fs(>)43 b(\(backup)e(\(obj)h
(filesystem\)\))555 3000 y(Remember)e(to)j(mount)f(the)g(tape.)555
3099 y(Oops,)g(deleted)e(all)j(your)e(files.)555 3199
y(Well,)h(that)f(was)i(easy.)555 3299 y(DONE)555 3473
y FA(Later)16 b(we)g(w)o(ant)g(to)g(kno)n(w)f(ho)n(w)h(long)f(backups)g
(tak)o(e,)h(so)h(we)f(de\002ne)f(the)h(follo)n(wing)f(around\255)555
3577 y(method:)555 3746 y Fs(\(defmeth)40 b(\(backup)h(:around\))f
(filesystem)g(\(fs\))642 3846 y(\(time)i(\(call-next\)\)\))555
4020 y FA(No)n(w)19 b(whene)n(v)o(er)f Fs(backup)f FA(is)k(called)e(on)
g(a)h(child)f(of)h Fs(filesystem)15 b FA(\(unless)20
b(more)e(speci\002c)555 4124 y(around\255methods)24 b(interv)o(ene\))h
(our)i(around\255method)c(will)28 b(be)g(called.)51 b(It)27
b(calls)i(the)e(code)555 4229 y(that)18 b(w)o(ould)f(ordinarily)f(run)h
(in)i(a)f(call)g(to)g Fs(backup)p FA(,)f(b)n(ut)h(within)f(a)i(call)f
(to)g Fs(time)p FA(.)28 b(The)17 b(v)n(alue)555 4334
y(returned)h(by)i Fs(time)f FA(will)i(be)f(returned)f(as)i(the)f(v)n
(alue)f(of)h(the)g(call)h(to)f Fs(backup)p FA(:)555 4503
y Fs(>)43 b(\(backup)e(\(obj)h(filesystem\)\))555 4602
y(Remember)e(to)j(mount)f(the)g(tape.)555 4702 y(Oops,)g(deleted)e(all)
j(your)e(files.)555 4801 y(Well,)h(that)f(was)i(easy.)555
4901 y(Elapsed)e(Time)h(=)h(.01)f(seconds)555 5001 y(DONE)p
eop
%%Page: 360 373
360 372 bop 555 538 a FA(360)877 b Fu(OBJECT)-5 b Fv(\255)p
Fu(ORIENTED)16 b(LISP)555 801 y FA(Once)28 b(we)h(are)g(\002nished)f
(timing)g(the)g(backups,)h(we)g(will)g(w)o(ant)g(to)g(remo)o(v)o(e)d
(the)j(around\255)555 905 y(method.)35 b(That)23 b(can)f(be)h(done)f
(by)g(calling)g Fs(undefmeth)e FA(\(Figure)i(25.8\),)f(which)h(tak)o
(es)i(the)555 1010 y(same)c(\002rst)h(tw)o(o)g(ar)o(guments)d(as)j
Fs(defmeth)p FA(:)555 1172 y Fs(\(undefmeth)39 b(\(backup)i(:around\))f
(filesystem\))680 1339 y FA(Another)22 b(thing)h(we)h(might)g(w)o(ant)g
(to)g(alter)g(is)h(an)e(object')-5 b(s)24 b(list)h(of)f(parents.)39
b(But)25 b(after)555 1444 y(an)o(y)20 b(such)h(change,)f(we)i(should)e
(also)i(update)e(the)h(list)i(of)e(ancestors)f(of)h(the)h(object)e(and)
h(all)555 1548 y(its)j(children.)36 b(So)24 b(f)o(ar)m(,)f(we)g(ha)n(v)
o(e)g(no)f(w)o(ay)h(of)g(getting)f(from)g(an)h(object)g(to)g(its)h
(children,)e(so)555 1653 y(we)f(must)f(also)g(add)g(a)h
Fs(children)c FA(property)-5 b(.)680 1757 y(Figure)34
b(25.9)g(contains)g(code)h(for)f(operating)f(on)i(objects')f(parents)h
(and)f(children.)555 1862 y(Instead)f(of)f(getting)h(at)h(parents)e
(and)h(children)f(via)h Fs(gethash)p FA(,)h(we)f(use)h(the)f(operators)
555 1967 y Fs(parents)e FA(and)j Fs(children)p FA(.)67
b(The)33 b(latter)h(is)h(a)f(macro,)i(and)d(therefore)f(transparent)g
(to)555 2071 y Fs(setf)p FA(.)56 b(The)29 b(former)f(is)j(a)e(function)
f(whose)h(in)m(v)o(ersion)f(is)i(de\002ned)f(by)g Fs(defsetf)e
FA(to)j(be)555 2176 y Fs(set-parents)p FA(,)15 b(which)k(does)g(e)n(v)o
(erything)e(needed)h(to)h(maintain)g(consistenc)o(y)f(in)h(the)h(ne)n
(w)555 2280 y(doubly\255link)o(ed)d(w)o(orld.)680 2385
y(T)-7 b(o)29 b(update)f(the)i(ancestors)e(of)h(all)h(the)g(objects)f
(in)g(a)h(subtree,)h Fs(set-parents)25 b FA(calls)555
2490 y Fs(maphier)p FA(,)35 b(which)f(is)h(lik)o(e)g(a)g
Fs(mapc)e FA(for)h(inheritance)e(hierarchies.)71 b(As)35
b Fs(mapc)e FA(calls)i(a)555 2594 y(function)26 b(on)h(e)n(v)o(ery)g
(element)g(of)g(a)h(list,)j Fs(maphier)25 b FA(calls)k(a)f(function)e
(on)h(an)h(object)f(and)555 2699 y(all)c(its)g(descendants.)34
b(Unless)23 b(the)o(y)f(form)f(a)i(proper)e(tree,)h(the)g(function)f
(could)g(get)i(called)555 2804 y(more)17 b(than)h(once)g(on)g(some)g
(objects.)28 b(Here)18 b(this)h(is)h(harmless,)e(because)f
Fs(get-ancestors)555 2908 y FA(does)j(the)g(same)h(thing)e(when)h
(called)g(multiple)f(times.)680 3013 y(No)n(w)h(we)i(can)f(alter)g(the)
g(inheritance)f(hierarchy)e(just)k(by)f(using)f Fs(setf)g
FA(on)h(an)g(object')-5 b(s)555 3117 y Fs(parents)p FA(:)555
3279 y Fs(>)43 b(\(progn)e(\(pop)h(\(parents)e(patriotic-scoundr)o
(el\))o(\))947 3379 y(\(serves)h(patriotic-scound)o(rel)o(\)\))555
3479 y(COUNTRY)555 3578 y(T)555 3745 y FA(When)26 b(the)g(hierarchy)e
(is)k(modi\002ed,)e(af)n(fected)f(lists)j(of)e(children)f(and)h
(ancestors)g(will)h(be)555 3850 y(updated)19 b(automatically)-5
b(.)27 b(\(The)19 b Fs(children)f FA(are)i(not)g(meant)f(to)i(be)f
(manipulated)e(directly)-5 b(,)555 3955 y(b)n(ut)26 b(the)o(y)g(could)f
(be)h(if)h(we)f(de\002ned)g(a)g Fs(set-children)c FA(analogous)j(to)h
Fs(set-parents)p FA(.\))555 4059 y(The)20 b(last)h(function)d(in)j
(Figure)e(25.9)g(is)i Fs(obj)f FA(rede\002ned)f(to)h(use)g(the)h(ne)n
(w)f(code.)680 4164 y(As)30 b(a)f(\002nal)h(impro)o(v)o(ement)c(to)j
(our)f(system,)k(we)d(will)h(mak)o(e)f(it)h(possible)f(to)g(specify)555
4268 y(ne)n(w)c(w)o(ays)g(of)g(combining)d(methods.)42
b(Currently)-5 b(,)25 b(the)f(only)g(primary)g(method)f(that)i(gets)555
4373 y(called)c(is)h(the)f(most)g(speci\002c)h(\(though)d(it)j(can)f
(call)g(others)g(via)g Fs(call-next)p FA(\).)29 b(Instead)20
b(we)555 4478 y(might)g(lik)o(e)g(to)h(be)f(able)g(to)h(combine)d(the)j
(results)f(of)g(the)h(primary)d(methods)i(of)g(each)g(of)g(an)555
4582 y(object')-5 b(s)24 b(ancestors.)40 b(F)o(or)24
b(e)o(xample,)f(suppose)g(that)h Fs(my-orange)d FA(is)k(a)f(child)g(of)
g Fs(orange)p FA(,)555 4687 y(which)f(is)i(a)g(child)e(of)h
Fs(citrus)p FA(.)39 b(If)23 b(the)h Fs(props)f FA(method)f(returns)h
Fs(\(round)42 b(acidic\))21 b FA(for)555 4791 y Fs(citrus)p
FA(,)d Fs(\(orange)40 b(sweet\))18 b FA(for)h Fs(orange)p
FA(,)f(and)h Fs(\(dented\))e FA(for)i Fs(my-orange)p
FA(,)d(it)k(w)o(ould)555 4896 y(be)28 b(con)m(v)o(enient)d(to)j(be)f
(able)h(to)g(mak)o(e)f Fs(\(props)41 b(my-orange\))25
b FA(return)h(the)i Ft(union)e FA(of)i(all)555 5001 y(these)20
b(v)n(alues:)29 b Fs(\(dented)41 b(orange)g(sweet)h(round)f(acidic\))p
FA(.)p eop
%%Page: 361 374
361 373 bop 555 538 a Ft(25.2)880 b Fu(OBJECTS)18 b(IN)h(PLAIN)g(LISP)
862 b FA(361)p 555 745 2678 4 v 553 4060 4 3315 v 605
888 a Fs(\(defmacro)40 b(children)g(\(obj\))692 988 y(`\(gethash)g
('children)g(,obj\)\))605 1187 y(\(defun)h(parents)g(\(obj\))692
1287 y(\(gethash)f('parents)h(obj\)\))605 1486 y(\(defun)g(set-parents)
e(\(obj)j(pars\))692 1586 y(\(dolist)f(\(p)h(\(parents)f(obj\)\))779
1685 y(\(setf)h(\(children)e(p\))1041 1785 y(\(delete)g(obj)j
(\(children)d(p\)\)\)\))692 1884 y(\(setf)i(\(gethash)e('parents)g
(obj\))i(pars\))692 1984 y(\(dolist)f(\(p)h(pars\))779
2084 y(\(pushnew)e(obj)j(\(children)d(p\)\)\))692 2183
y(\(maphier)g(#'\(lambda)g(\(obj\))1259 2283 y(\(setf)h(\(gethash)f
('ancestors)g(obj\))1520 2383 y(\(get-ancestors)e(obj\)\)\))1084
2482 y(obj\))692 2582 y(pars\))605 2781 y(\(defsetf)i(parents)h
(set-parents\))605 2980 y(\(defun)g(maphier)g(\(fn)h(obj\))692
3080 y(\(funcall)e(fn)j(obj\))692 3180 y(\(dolist)e(\(c)h(\(children)e
(obj\)\))779 3279 y(\(maphier)g(fn)j(c\)\)\))605 3478
y(\(defun)e(obj)h(\(&rest)f(parents\))692 3578 y(\(let)h(\(\(obj)f
(\(make-hash-table\))o(\)\))779 3678 y(\(setf)h(\(parents)e(obj\))i
(parents\))779 3777 y(obj\)\))1093 3982 y FA(Figure)20
b(25.9:)28 b(Maintaining)19 b(parent)g(and)h(child)g(links.)p
3231 4060 V 555 4063 2678 4 v 680 4287 a(W)-7 b(e)16
b(could)f(ha)n(v)o(e)g(this)h(if)g(we)g(allo)n(wed)f(methods)g(to)g
(apply)g(some)h(function)e(to)h(the)h(v)n(alues)555 4392
y(of)h(all)h(the)g(primary)d(methods,)i(instead)g(of)g(just)h
(returning)e(the)h(v)n(alue)g(of)g(the)g(most)h(speci\002c.)555
4496 y(Figure)28 b(25.10)f(contains)h(a)h(macro)f(which)g(allo)n(ws)h
(us)g(to)g(de\002ne)f(the)g(w)o(ay)h(methods)f(are)555
4601 y(combined,)17 b(and)i(a)h(ne)n(w)f(v)o(ersion)f(of)h
Fs(run-core-methods)14 b FA(which)k(can)i(perform)d(method)555
4706 y(combination.)680 4810 y(W)-7 b(e)27 b(de\002ne)e(the)h(form)f
(of)g(combination)f(for)h(a)i(method)d(via)i Fs(defcomb)p
FA(,)f(which)g(tak)o(es)555 4915 y(a)f(method)e(name)i(and)f(a)h
(second)f(ar)o(gument)e(describing)h(the)i(desired)f(combination.)37
b(Or)n(\255)p eop
%%Page: 362 375
362 374 bop 555 538 a FA(362)877 b Fu(OBJECT)-5 b Fv(\255)p
Fu(ORIENTED)16 b(LISP)p 555 745 2678 4 v 553 4359 4 3614
v 605 888 a Fs(\(defmacro)40 b(defcomb)g(\(name)i(op\))692
988 y(`\(progn)823 1087 y(\(defprop)e(,name)i(t\))823
1187 y(\(setf)f(\(get)h(',name)f('mcombine\))1084 1287
y(,\(case)g(op)1215 1386 y(\(:standard)e(nil\))1215 1486
y(\(:progn)i('#'\(lambda)e(\(&rest)i(args\))1782 1586
y(\(car)h(\(last)f(args\)\)\)\))1215 1685 y(\(t)i(op\)\)\)\)\))605
1884 y(\(defun)e(run-core-methods)c(\(obj)42 b(name)g(args)g(&optional)
e(pri\))692 1984 y(\(let)i(\(\(comb)f(\(get)h(name)g('mcombine\)\)\))
779 2084 y(\(if)h(comb)954 2183 y(\(if)f(\(symbolp)e(comb\))1128
2283 y(\(funcall)g(\(case)i(comb)g(\(:and)f(#'comb-and\))2000
2383 y(\(:or)85 b(#'comb-or\)\))1520 2482 y(obj)42 b(name)g(args)g
(\(ancestors)e(obj\)\))1128 2582 y(\(comb-normal)e(comb)k(obj)h(name)f
(args\)\))954 2681 y(\(multiple-value)o(-p)o(rog)o(1)1041
2781 y(\(progn)f(\(run-befores)d(obj)43 b(name)f(args\))1346
2881 y(\(apply)f(\(or)h(pri)h(\(rget)e(obj)h(name)g(:primary\)\))1651
2980 y(obj)g(args\)\))1041 3080 y(\(run-afters)d(obj)j(name)g
(args\)\)\)\)\))605 3279 y(\(defun)f(comb-normal)e(\(comb)i(obj)i(name)
f(args\))692 3379 y(\(apply)f(comb)997 3478 y(\(mapcan)g(#'\(lambda)f
(\(a\))1520 3578 y(\(let*)i(\(\(pm)g(\(meth-)f(primary)2305
3678 y(\(gethash)f(name)i(a\)\)\))1825 3777 y(\(val)g(\(if)h(pm)2218
3877 y(\(apply)e(pm)h(obj)h(args\)\)\)\))1651 3977 y(\(if)f(val)h
(\(list)e(val\)\)\)\))1346 4076 y(\(ancestors)e(obj\)\)\)\))1297
4280 y FA(Figure)20 b(25.10:)28 b(Method)19 b(combination.)p
3231 4359 V 555 4362 2678 4 v 555 4586 a(dinarily)j(this)h(second)f(ar)
o(gument)f(should)h(be)g(a)i(function.)35 b(Ho)n(we)n(v)o(er)m(,)22
b(it)h(can)g(also)g(be)g(one)555 4691 y(of)29 b Fs(:progn)p
FA(,)h Fs(:and)p FA(,)h Fs(:or)p FA(,)h(or)d Fs(:standard)p
FA(.)55 b(W)m(ith)30 b(the)f(former)g(three,)i(primary)d(meth\255)555
4795 y(ods)d(will)i(be)e(combined)f(as)i(though)d(according)h(to)i(the)
f(corresponding)d(operator)m(,)j(while)555 4900 y Fs(:standard)17
b FA(indicates)j(that)g(we)h(w)o(ant)f(the)g(traditional)f(w)o(ay)i(of)
f(running)e(methods.)p eop
%%Page: 363 376
363 375 bop 555 538 a Ft(25.2)880 b Fu(OBJECTS)18 b(IN)h(PLAIN)g(LISP)
862 b FA(363)p 555 745 2678 4 v 553 2565 4 1820 v 605
888 a Fs(\(defun)41 b(comb-and)f(\(obj)i(name)g(args)g(ancs)g
(&optional)e(\(last)h(t\)\))692 988 y(\(if)h(\(null)g(ancs\))866
1087 y(last)866 1187 y(\(let)g(\(\(pm)g(\(meth-)f(primary)g(\(gethash)f
(name)i(\(car)g(ancs\)\)\)\)\))954 1287 y(\(if)g(pm)1128
1386 y(\(let)g(\(\(new)f(\(apply)g(pm)i(obj)g(args\)\)\))1215
1486 y(\(and)f(new)1433 1586 y(\(comb-and)e(obj)i(name)g(args)g(\(cdr)g
(ancs\))f(new\)\)\))1128 1685 y(\(comb-and)f(obj)i(name)g(args)g(\(cdr)
g(ancs\))f(last\)\)\)\)\))605 1884 y(\(defun)g(comb-or)g(\(obj)h(name)f
(args)h(ancs\))692 1984 y(\(and)g(ancs)910 2084 y(\(let)g(\(\(pm)g
(\(meth-)f(primary)g(\(gethash)f(name)i(\(car)g(ancs\)\)\)\)\))997
2183 y(\(or)g(\(and)g(pm)h(\(apply)e(pm)i(obj)f(args\)\))1171
2283 y(\(comb-or)f(obj)h(name)g(args)g(\(cdr)g(ancs\)\)\)\)\)\))1096
2487 y FA(Figure)19 b(25.11:)28 b(Method)19 b(combination)f
(\(continued\).)p 3231 2565 V 555 2569 2678 4 v 680 2793
a(The)24 b(central)g(function)e(in)j(Figure)f(25.10)e(is)k(the)e(ne)n
(w)g Fs(run-core-methods)p FA(.)36 b(If)25 b(the)555
2897 y(method)18 b(being)g(called)h(has)g(no)g Fs(mcombine)d
FA(property)-5 b(,)17 b(then)i(the)g(method)f(call)h(proceeds)f(as)555
3002 y(before.)38 b(Otherwise)23 b(the)h Fs(mcombine)d
FA(of)i(the)h(method)e(is)j(either)e(a)h(function)e(\(lik)o(e)h
Fs(+)p FA(\))h(or)f(a)555 3107 y(k)o(e)o(yw)o(ord)i(\(lik)o(e)i
Fs(:or)p FA(\).)48 b(In)27 b(the)g(former)e(case,)k(the)e(function)e
(is)j(just)f(applied)f(to)h(a)h(list)g(of)555 3211 y(the)19
b(v)n(alues)g(returned)e(by)i(all)h(the)f(primary)f(methods.)2116
3181 y Fm(1)2177 3211 y FA(In)h(the)g(latter)m(,)g(we)h(use)f(the)g
(function)555 3316 y(associated)h(with)g(the)h(k)o(e)o(yw)o(ord)d(to)i
(iterate)g(o)o(v)o(er)f(the)h(primary)f(methods.)680
3420 y(The)29 b(operators)f Fs(and)h FA(and)g Fs(or)g
FA(ha)n(v)o(e)g(to)g(be)h(treated)f(specially)-5 b(,)31
b(as)f(in)g(Figure)e(25.11.)555 3525 y(The)o(y)d(get)i(special)f
(treatment)g(not)g(just)h(because)f(the)o(y)g(are)g(special)h(forms,)g
(b)n(ut)f(because)555 3630 y(the)o(y)19 b(short\255circuit)g(e)n(v)n
(aluation:)555 3812 y Fs(>)43 b(\(or)g(1)g(\(princ)e("wahoo"\)\))555
3912 y(1)555 4100 y FA(Here)13 b(nothing)f(is)i(printed)e(because)h
(the)g Fs(or)g FA(returns)g(as)h(soon)e(as)i(it)g(sees)h(a)e
(non\255nil)f(ar)o(gument.)555 4204 y(Similarly)-5 b(,)20
b(a)h(primary)e(method)h(subject)h(to)f Fs(or)h FA(combination)e
(should)g(ne)n(v)o(er)h(get)h(called)f(if)555 4309 y(a)f(more)g
(speci\002c)g(method)e(returns)i(true.)28 b(T)-7 b(o)19
b(pro)o(vide)e(such)i(short\255circuiting)d(for)j Fs(and)f
FA(and)555 4413 y Fs(or)p FA(,)i(we)g(use)h(the)f(distinct)g(functions)
f Fs(comb-and)e FA(and)j Fs(comb-or)p FA(.)680 4518 y(T)-7
b(o)20 b(implement)f(our)g(pre)n(vious)g(e)o(xample,)f(we)j(w)o(ould)e
(write:)555 4701 y Fs(\(setq)42 b(citrus)f(\(obj\)\))555
4800 y(\(setq)h(orange)f(\(obj)h(citrus\)\))p 555 4872
1074 4 v 645 4928 a Fl(1)675 4951 y Fr(A)16 b(more)h(sophisticated)k(v)
o(ersion)d(of)f(this)g(code)h(could)g(use)g Fk(reduce)g
Fr(to)f(a)o(v)o(oid)h(consing)g(here.)p eop
%%Page: 364 377
364 376 bop 555 538 a FA(364)877 b Fu(OBJECT)-5 b Fv(\255)p
Fu(ORIENTED)16 b(LISP)555 801 y Fs(\(setq)42 b(my-orange)d(\(obj)j
(orange\)\))555 1000 y(\(defmeth)e(\(props\))h(citrus)g(\(c\))h
('\(round)f(acidic\)\))555 1100 y(\(defmeth)f(\(props\))h(orange)g
(\(o\))h('\(orange)f(sweet\)\))555 1199 y(\(defmeth)f(\(props\))h
(my-orange)f(\(m\))i('\(dented\)\))555 1398 y(\(defcomb)e(props)i
(#'\(lambda)e(\(&rest)h(args\))g(\(reduce)g(#'union)g(args\)\)\))555
1586 y FA(after)20 b(which)g Fs(props)e FA(w)o(ould)i(return)f(the)h
(union)f(of)h(all)g(the)h(primary)d(method)h(v)n(alues:)3072
1556 y Fm(2)555 1769 y Fs(>)43 b(\(props)e(my-orange\))555
1868 y(\(DENTED)g(ORANGE)g(SWEET)g(ROUND)h(ACIDIC\))555
2056 y FA(Incidentally)-5 b(,)14 b(this)h(e)o(xample)f(suggests)h(a)g
(choice)f(that)i(you)e(only)g(ha)n(v)o(e)g(when)h(doing)e(object\255)
555 2161 y(oriented)19 b(programming)e(in)j(Lisp:)30
b(whether)19 b(to)h(store)g(information)e(in)i(slots)h(or)f(methods.)
680 2265 y(Afterw)o(ard,)h(if)i(we)g(w)o(anted)g(the)f
Fs(props)g FA(method)f(to)i(return)e(to)i(the)g(def)o(ault)f(beha)n
(vior)m(,)555 2370 y(we)f(just)f(set)h(the)f(method)f(combination)f
(back)i(to)g(standard:)555 2552 y Fs(>)43 b(\(defcomb)d(props)i
(:standard\))555 2652 y(NIL)555 2752 y(>)h(\(props)e(my-orange\))555
2851 y(\(DENTED\))555 3039 y FA(Note)28 b(that)h(before\255)e(and)h
(after)n(\255methods)e(only)i(run)g(in)h(standard)e(method)g
(combination.)555 3144 y(Ho)n(we)n(v)o(er)m(,)18 b(around\255methods)e
(w)o(ork)k(the)g(same)g(as)h(before.)680 3248 y(The)27
b(program)f(presented)g(in)i(this)h(section)e(is)i(intended)e(as)h(a)g
(model,)h(not)f(as)g(a)h(real)555 3353 y(foundation)f(for)j
(object\255oriented)d(programming.)58 b(It)32 b(w)o(as)f(written)g(for)
g(bre)n(vity)e(rather)555 3457 y(than)20 b(ef)n(\002cienc)o(y)-5
b(.)28 b(Ho)n(we)n(v)o(er)m(,)19 b(it)i(is)h(at)f(least)g(a)g(w)o
(orking)e(model,)g(and)h(so)h(could)f(be)g(used)g(for)555
3562 y(e)o(xperiments)15 b(and)i(prototypes.)26 b(If)18
b(you)e(do)h(w)o(ant)g(to)h(use)f(the)g(program)e(for)i(such)g
(purposes,)555 3667 y(one)27 b(minor)f(change)g(w)o(ould)h(mak)o(e)g
(it)h(much)f(more)f(ef)n(\002cient:)44 b(don')o(t)25
b(calculate)i(or)h(store)555 3771 y(ancestor)19 b(lists)j(for)e
(objects)f(with)i(only)e(one)h(parent.)555 4024 y Fw(25.3)99
b(Classes)24 b(and)h(Instances)555 4215 y FA(The)f(program)d(in)j(the)g
(pre)n(vious)f(section)g(w)o(as)i(written)f(to)g(resemble)f
Fr(CLOS)h FA(as)h(closely)f(as)555 4319 y(such)14 b(a)h(small)g
(program)e(could.)26 b(By)15 b(understanding)d(it)j(we)g(are)f(already)
g(a)h(f)o(air)f(w)o(ay)h(to)n(w)o(ards)555 4424 y(understanding)i
Fr(CLOS)p FA(.)30 b(In)20 b(the)g(ne)o(xt)f(fe)n(w)h(sections)h(we)f
(will)h(e)o(xamine)e Fr(CLOS)h FA(itself.)680 4528 y(In)c(our)g(sk)o
(etch,)h(we)g(made)f(no)h(syntactic)f(distinction)g(between)g(classes)i
(and)e(instances,)555 4633 y(or)22 b(between)g(slots)h(and)f(methods.)
35 b(In)22 b Fr(CLOS)p FA(,)h(we)g(use)f(the)h Fs(defclass)c
FA(macro)j(to)g(de\002ne)g(a)555 4738 y(class,)f(and)f(we)g(declare)g
(the)g(slots)h(in)f(a)h(list)g(at)g(the)f(same)g(time:)p
555 4802 1074 4 v 645 4857 a Fl(2)675 4881 y Fr(Since)g(the)h
(combination)h(function)g(for)d Fk(props)i Fr(calls)g
Fk(union)p Fr(,)g(the)f(list)h(elements)g(will)g(not)f(necessarily)i
(be)555 4964 y(in)17 b(this)h(order)l(.)p eop
%%Page: 365 378
365 377 bop 555 538 a Ft(25.3)842 b Fu(CLASSES)19 b(AND)g(INST)-6
b(ANCES)825 b FA(365)555 801 y Fs(\(defclass)40 b(circle)h(\(\))642
900 y(\(radius)g(center\)\))555 1083 y FA(This)29 b(e)o(xpression)d
(says)j(that)g(the)f Fs(circle)f FA(class)i(has)g(no)f(superclasses,)i
(and)e(tw)o(o)h(slots,)555 1183 y Fs(radius)18 b FA(and)i
Fs(center)p FA(.)27 b(W)-7 b(e)22 b(can)d(mak)o(e)h(an)g(instance)g(of)
g(the)g(circle)g(class)i(by)d(saying:)555 1349 y Fs(\(make-instance)38
b('circle\))555 1515 y FA(Unfortunately)-5 b(,)22 b(we)i(ha)n(v)o(e)g
(de\002ned)f(no)h(w)o(ay)g(of)g(referring)e(to)i(the)h(slots)g(of)f(a)g
Fs(circle)p FA(,)f(so)555 1614 y(an)o(y)j(instance)g(we)h(mak)o(e)f(is)
h(going)f(to)g(be)h(rather)e(inert.)48 b(T)-7 b(o)27
b(get)g(at)g(a)g(slot)g(we)g(de\002ne)f(an)555 1714 y(accessor)20
b(function)e(for)i(it:)555 1880 y Fs(\(defclass)40 b(circle)h(\(\))642
1980 y(\(\(radius)f(:accessor)g(circle-radius\))686 2079
y(\(center)g(:accessor)g(circle-center\)\)\))555 2250
y FA(No)n(w)22 b(if)g(we)g(mak)o(e)g(an)f(instance)h(of)g(a)g(circle,)g
(we)g(can)g(set)h(its)f Fs(radius)e FA(and)i Fs(center)e
FA(slots)555 2355 y(by)g(using)f Fs(setf)h FA(with)g(the)g
(corresponding)d(accessor)j(functions:)555 2537 y Fs(>)43
b(\(setf)f(\(circle-radius)37 b(\(make-instance)h('circle\)\))i(2\))555
2637 y(2)555 2825 y FA(W)-7 b(e)29 b(can)f(do)g(this)g(kind)f(of)h
(initialization)f(right)h(in)g(the)g(call)h(to)f Fs(make-instance)23
b FA(if)28 b(we)555 2929 y(de\002ne)20 b(the)g(slots)h(to)f(allo)n(w)g
(it:)555 3112 y Fs(\(defclass)40 b(circle)h(\(\))642
3212 y(\(\(radius)f(:accessor)g(circle-radius)f(:initarg)h(:radius\))
686 3311 y(\(center)g(:accessor)g(circle-center)f(:initarg)h
(:center\)\)\))555 3499 y FA(The)13 b Fs(:initarg)g FA(k)o(e)o(yw)o
(ord)f(in)h(a)g(slot)g(de)o(\002nition)f(says)h(that)g(the)g(f)o(ollo)m
(wing)f(ar)n(gu)o(men)o(t)h(shou)o(ld)555 3603 y(become)30
b(a)i(k)o(e)o(yw)o(ord)e(parameter)g(in)i Fs(make-instance)p
FA(.)58 b(The)32 b(v)n(alue)f(of)g(the)g(k)o(e)o(yw)o(ord)555
3708 y(parameter)19 b(will)i(become)e(the)h(initial)g(v)n(alue)g(of)g
(the)g(slot:)555 3891 y Fs(>)43 b(\(circle-radius)38
b(\(make-instance)g('circle)1383 3990 y(:radius)j(2)1383
4090 y(:center)g('\(0)h(.)h(0\)\)\))555 4190 y(2)680
4377 y FA(By)24 b(declaring)f(an)h Fs(:initform)p FA(,)e(we)j(can)f
(also)h(de\002ne)f(slots)h(which)f(initialize)g(them\255)555
4482 y(selv)o(es.)29 b(The)20 b Fs(visible)e FA(slot)j(of)f(the)g
Fs(shape)f FA(class)555 4664 y Fs(\(defclass)40 b(shape)h(\(\))642
4764 y(\(\(color)128 b(:accessor)40 b(shape-color)126
b(:initarg)40 b(:color\))686 4864 y(\(visible)g(:accessor)g
(shape-visible)e(:initarg)i(:visible)1078 4963 y(:initform)g(t\)\)\))p
eop
%%Page: 366 379
366 378 bop 555 538 a FA(366)877 b Fu(OBJECT)-5 b Fv(\255)p
Fu(ORIENTED)16 b(LISP)555 801 y FA(will)21 b(be)f(set)h(to)f
Fs(t)h FA(by)f(def)o(ault:)555 951 y Fs(>)43 b(\(shape-visible)38
b(\(make-instance)g('shape\)\))555 1050 y(T)555 1205
y FA(If)22 b(a)h(slot)g(has)f(both)g(an)g(initar)o(g)f(and)h(an)g
(initform,)g(the)g(initar)o(g)f(tak)o(es)i(precedence)d(when)i(it)555
1310 y(is)f(speci\002ed:)555 1460 y Fs(>)43 b(\(shape-visible)38
b(\(make-instance)g('shape)j(:visible)f(nil\)\))555 1559
y(NIL)680 1714 y FA(Slots)34 b(are)f(inherited)g(by)g(instances)g(and)g
(subclasses.)70 b(If)34 b(a)g(class)g(has)g(more)f(than)555
1819 y(one)g(superclass,)k(it)e(inherits)e(the)h(union)f(of)g(their)h
(slots.)71 b(So)34 b(if)g(we)g(de\002ne)g(the)g(class)555
1923 y Fs(screen-circle)15 b FA(to)21 b(be)f(a)g(subclass)h(of)f(both)f
Fs(circle)f FA(and)i Fs(shape)p FA(,)555 2073 y Fs(\(defclass)40
b(screen-circle)e(\(circle)j(shape\))642 2173 y(nil\))555
2328 y FA(then)24 b(instances)g(of)g Fs(screen-circle)c
FA(will)25 b(ha)n(v)o(e)f(four)f(slots,)j(tw)o(o)f(inherited)e(from)g
(each)555 2432 y(grandparent.)i(Note)15 b(that)h(a)f(class)i(does)e
(not)g(ha)n(v)o(e)g(to)h(create)f(an)o(y)f(ne)n(w)i(slots)g(of)f(its)h
(o)n(wn;)h(this)555 2537 y(class)k(e)o(xists)f(just)h(to)f(pro)o(vide)e
(something)g(instantiable)i(that)g(inherits)f(from)g(both)g
Fs(circle)555 2642 y FA(and)h Fs(shape)p FA(.)680 2746
y(The)e(accessors)h(and)f(initar)o(gs)g(w)o(ork)g(for)g(instances)h(of)
f Fs(screen-circle)c FA(just)20 b(as)f(the)o(y)555 2851
y(w)o(ould)g(for)h(instances)g(of)g Fs(circle)e FA(or)i
Fs(shape)p FA(:)555 3001 y Fs(>)43 b(\(shape-color)c(\(make-instance)f
('screen-circle)1863 3100 y(:color)j('red)h(:radius)e(3\)\))555
3200 y(RED)555 3355 y FA(W)-7 b(e)38 b(can)f(cause)f(e)n(v)o(ery)g
Fs(screen-circle)c FA(to)37 b(ha)n(v)o(e)f(some)g(def)o(ault)h(initial)
g Fs(color)e FA(by)555 3460 y(specifying)19 b(an)h(initform)f(for)g
(this)i(slot)g(in)f(the)g Fs(defclass)p FA(:)555 3609
y Fs(\(defclass)40 b(screen-circle)e(\(circle)j(shape\))642
3709 y(\(\(color)g(:initform)f('purple\)\)\))555 3864
y FA(No)n(w)20 b(instances)g(of)g Fs(screen-circle)15
b FA(will)21 b(be)g(purple)d(by)i(def)o(ault,)555 4014
y Fs(>)43 b(\(shape-color)c(\(make-instance)f('screen-circle\))o(\))555
4113 y(PURPLE)555 4268 y FA(though)31 b(it)j(is)g(still)g(possible)f
(to)g(initialize)h(the)f(slot)g(otherwise)g(by)f(gi)n(ving)g(an)h(e)o
(xplicit)555 4373 y Fs(:color)18 b FA(initar)o(g.)680
4478 y(In)23 b(our)h(sk)o(etch)g(of)g(object\255oriented)d
(programming,)g(instances)j(inherited)f(v)n(alues)h(di\255)555
4582 y(rectly)f(from)f(the)h(slots)h(in)f(their)g(parent)f(classes.)38
b(In)23 b Fr(CLOS)p FA(,)h(instances)f(do)g(not)f(ha)n(v)o(e)h(slots)
555 4687 y(in)h(the)f(same)h(w)o(ay)f(that)h(classes)h(do.)38
b(W)-7 b(e)25 b(de\002ne)e(an)h(inherited)e(def)o(ault)h(for)g
(instances)g(by)555 4791 y(de\002ning)18 b(an)g(initform)g(in)h(the)g
(parent)e(class.)30 b(In)19 b(a)g(w)o(ay)-5 b(,)18 b(this)i(is)f(more)f
(\003e)o(xible,)h(because)f(as)555 4896 y(well)k(as)f(being)f(a)i
(constant,)e(an)h(initform)f(can)g(be)h(an)g(e)o(xpression)f(that)h
(returns)f(a)h(dif)n(ferent)555 5001 y(v)n(alue)f(each)f(time)i(it)g
(is)g(e)n(v)n(aluated:)p eop
%%Page: 367 380
367 379 bop 555 538 a Ft(25.3)842 b Fu(CLASSES)19 b(AND)g(INST)-6
b(ANCES)825 b FA(367)555 801 y Fs(\(defclass)40 b(random-dot)f(\(\))642
900 y(\(\(x)k(:accessor)c(dot-x)j(:initform)e(\(random)g(100\)\))686
1000 y(\(y)j(:accessor)c(dot-y)j(:initform)e(\(random)g(100\)\)\)\))555
1174 y FA(Each)23 b(time)g(we)g(mak)o(e)g(an)g(instance)g(of)f(a)i
Fs(random-dot)19 b FA(its)25 b(x\255)d(and)h(y\255position)e(will)j(be)
f(a)555 1278 y(random)18 b(inte)o(ger)h(between)h Fs(0)g
FA(and)g Fs(99)p FA(:)555 1447 y Fs(>)43 b(\(mapcar)e(#'\(lambda)f
(\(name\))1165 1547 y(\(let)i(\(\(rd)g(\(make-instance)c
('random-dot\)\)\))1252 1647 y(\(list)k(name)g(\(dot-x)f(rd\))h
(\(dot-y)f(rd\)\)\)\))991 1746 y('\(first)g(second)g(third\)\))555
1846 y(\(\(FIRST)g(25)h(8\))h(\(SECOND)e(26)i(15\))f(\(THIRD)f(75)i
(59\)\))680 2020 y FA(In)23 b(our)g(sk)o(etch,)h(we)g(also)g(made)f(no)
h(distinction)f(between)f(slots)j(whose)e(v)n(alues)h(were)555
2124 y(to)d(v)n(ary)e(from)h(instance)g(to)h(instance,)f(and)g(those)g
(which)g(were)h(to)g(be)f(constant)g(across)h(the)555
2229 y(whole)26 b(class.)50 b(In)27 b Fr(CLOS)g FA(we)g(can)g(specify)f
(that)h(some)g(slots)g(are)g(to)g(be)g Ft(shar)m(ed)p
FA(\227that)f(is,)555 2333 y(their)j(v)n(alue)f(is)h(the)g(same)g(for)g
(e)n(v)o(ery)e(instance.)55 b(W)-7 b(e)30 b(do)e(this)h(by)g(declaring)
e(the)i(slot)g(to)555 2438 y(ha)n(v)o(e)21 b Fs(:allocation)d(:class)p
FA(.)32 b(\(The)21 b(alternati)n(v)o(e)g(is)i(for)e(a)h(slot)g(to)g(ha)
n(v)o(e)g Fs(:allocation)555 2543 y(:instance)p FA(,)16
b(b)n(ut)k(since)f(this)h(is)h(the)e(def)o(ault)g(there)g(is)i(no)e
(need)g(to)g(say)h(so)g(e)o(xplicitly)-5 b(.\))27 b(F)o(or)555
2647 y(e)o(xample,)c(if)h(all)g(o)n(wls)g(are)g(nocturnal,)e(then)i(we)
g(can)f(mak)o(e)h(the)f Fs(nocturnal)e FA(slot)j(of)g(the)555
2752 y Fs(owl)c FA(class)h(a)f(shared)g(slot,)g(and)g(gi)n(v)o(e)f(it)i
(the)f(initial)h(v)n(alue)e Fs(t)p FA(:)555 2921 y Fs(\(defclass)40
b(owl)i(\(\))642 3020 y(\(\(nocturnal)d(:accessor)h(owl-nocturnal)1165
3120 y(:initform)g(t)1165 3220 y(:allocation)f(:class\)\)\))555
3394 y FA(No)n(w)20 b(e)n(v)o(ery)f(instance)h(of)g(the)g
Fs(owl)f FA(class)j(will)e(inherit)g(this)h(slot:)555
3562 y Fs(>)43 b(\(owl-nocturnal)38 b(\(make-instance)g('owl\)\))555
3662 y(T)555 3836 y FA(If)21 b(we)g(change)f(the)h(\223local\224)g(v)n
(alue)f(of)h(this)g(slot)h(in)f(an)g(instance,)g(we)g(are)g(actually)f
(altering)555 3941 y(the)g(v)n(alue)g(stored)f(in)i(the)f(class:)555
4109 y Fs(>)43 b(\(setf)f(\(owl-nocturnal)37 b(\(make-instance)h
('owl\)\))j('maybe\))555 4209 y(MAYBE)555 4309 y(>)i(\(owl-nocturnal)38
b(\(make-instance)g('owl\)\))555 4408 y(MAYBE)680 4582
y FA(This)21 b(could)g(cause)g(some)h(confusion,)d(so)j(we)g(might)f
(lik)o(e)h(to)f(mak)o(e)g(such)h(a)f(slot)h(read\255)555
4687 y(only)-5 b(.)47 b(When)26 b(we)g(de\002ne)g(an)h(accessor)f
(function)e(for)i(a)h(slot,)h(we)f(create)f(a)h(w)o(ay)f(of)g(both)555
4791 y(reading)k(and)h(writing)g(the)g(slot')-5 b(s)33
b(v)n(alue.)62 b(If)31 b(we)h(w)o(ant)g(the)f(v)n(alue)g(to)h(be)f
(readable)g(b)n(ut)555 4896 y(not)26 b(writable,)g(we)h(can)f(do)f(it)i
(by)e(gi)n(ving)g(the)h(slot)g(just)h(a)f(reader)f(function,)h(instead)
f(of)h(a)555 5001 y(full\255\003edged)18 b(accessor)i(function:)p
eop
%%Page: 368 381
368 380 bop 555 538 a FA(368)877 b Fu(OBJECT)-5 b Fv(\255)p
Fu(ORIENTED)16 b(LISP)555 801 y Fs(\(defclass)40 b(owl)i(\(\))642
900 y(\(\(nocturnal)d(:reader)i(owl-nocturnal)1165 1000
y(:initform)f(t)1165 1100 y(:allocation)f(:class\)\)\))555
1267 y FA(No)n(w)20 b(attempts)g(to)h(alter)f(the)g Fs(nocturnal)d
FA(slot)k(of)f(an)g(instance)g(will)h(generate)e(an)h(error:)555
1430 y Fs(>)43 b(\(setf)f(\(owl-nocturnal)37 b(\(make-instance)h
('owl\)\))j(nil\))555 1530 y(>>Error:)f(The)j(function)d(\(SETF)h
(OWL-NOCTURNAL\))d(is)43 b(undefined.)555 1779 y Fw(25.4)99
b(Methods)555 1970 y FA(Our)27 b(sk)o(etch)f(emphasized)g(the)g
(similarity)h(between)f(slots)i(and)e(methods)g(in)h(a)g(language)555
2074 y(which)f(pro)o(vides)f(le)o(xical)h(closures.)48
b(In)27 b(our)e(program,)h(a)h(primary)e(method)h(w)o(as)h(stored)555
2179 y(and)20 b(inherited)f(in)i(the)g(same)f(w)o(ay)h(as)g(a)g(slot)g
(v)n(alue.)30 b(The)20 b(only)g(dif)n(ference)e(between)i(a)h(slot)555
2284 y(and)f(a)g(method)f(w)o(as)i(that)f(de\002ning)f(a)i(name)e(as)i
(a)g(slot)g(by)555 2447 y Fs(\(defprop)40 b(area\))555
2615 y FA(made)31 b Fs(area)g FA(a)i(function)d(which)h(w)o(ould)h
(simply)f(retrie)n(v)o(e)g(and)g(return)g(a)i(v)n(alue,)h(while)555
2719 y(de\002ning)19 b(it)i(as)g(a)f(method)f(by)555
2882 y Fs(\(defprop)40 b(area)i(t\))555 3050 y FA(made)32
b Fs(area)g FA(a)h(function)e(which)i(w)o(ould,)i(after)d(retrie)n
(ving)f(a)j(v)n(alue,)h(funcall)d(it)h(on)g(its)555 3155
y(ar)o(guments.)680 3259 y(In)15 b Fr(CLOS)i FA(the)f(functional)e
(units)j(are)f(still)h(called)f(methods,)f(and)h(it)h(is)g(possible)f
(to)g(de\002ne)555 3364 y(them)25 b(so)g(that)g(the)o(y)g(each)f(seem)i
(to)f(be)g(a)g(property)e(of)i(some)g(class.)45 b(Here)25
b(we)g(de\002ne)g(an)555 3469 y Fs(area)19 b FA(method)g(for)g(the)i
Fs(circle)d FA(class:)555 3631 y Fs(\(defmethod)39 b(area)j(\(\(c)h
(circle\)\))642 3731 y(\(*)g(pi)g(\(expt)e(\(circle-radius)d(c\))43
b(2\)\)\))555 3899 y FA(The)17 b(parameter)f(list)j(for)d(this)i
(method)e(says)i(that)g(it)g(is)g(a)g(function)e(of)h(one)g(ar)o
(gument)e(which)555 4004 y(applies)20 b(to)g(instances)g(of)g(the)h
Fs(circle)d FA(class.)680 4108 y(W)-7 b(e)21 b(in)m(v)n(ok)o(e)e(this)i
(method)d(lik)o(e)j(a)f(function,)f(just)h(as)h(in)g(our)e(sk)o(etch:)
555 4271 y Fs(>)43 b(\(area)f(\(make-instance)37 b('circle)k(:radius)g
(1\)\))555 4371 y(3.14...)555 4539 y FA(W)-7 b(e)21 b(can)f(also)h
(de\002ne)f(methods)f(that)h(tak)o(e)g(additional)f(ar)o(guments:)555
4702 y Fs(\(defmethod)39 b(move)j(\(\(c)h(circle\))d(dx)j(dy\))642
4801 y(\(incf)f(\(car)g(\(circle-center)37 b(c\)\))43
b(dx\))642 4901 y(\(incf)f(\(cdr)g(\(circle-center)37
b(c\)\))43 b(dy\))642 5001 y(\(circle-center)38 b(c\)\))p
eop
%%Page: 369 382
369 381 bop 555 538 a Ft(25.4)1071 b Fu(METHODS)1053
b FA(369)555 801 y(If)30 b(we)g(call)h(this)f(method)f(on)h(an)g
(instance)f(of)h Fs(circle)p FA(,)g(its)h(center)f(will)g(be)g(shifted)
g(by)555 905 y Fq(h)p Fs(dx)p FA(,)p Fs(dy)p Fq(i)p FA(:)555
1088 y Fs(>)43 b(\(move)f(\(make-instance)37 b('circle)k(:center)g
('\(1)h(.)h(1\)\))g(2)g(3\))555 1188 y(\(3)g(.)g(4\))555
1375 y FA(The)20 b(v)n(alue)f(returned)g(by)h(the)g(method)f
(re\003ects)h(the)g(circle')-5 b(s)21 b(ne)n(w)f(position.)680
1480 y(As)30 b(in)g(our)e(sk)o(etch,)k(if)e(there)f(is)h(a)g(method)e
(for)h(the)h(class)g(of)f(an)h(instance,)h(and)e(for)555
1584 y(superclasses)e(of)g(that)h(class,)i(the)d(most)h(speci\002c)f
(one)g(runs.)50 b(So)28 b(if)f Fs(unit-circle)d FA(is)k(a)555
1689 y(subclass)20 b(of)g Fs(circle)p FA(,)e(with)j(the)f(follo)n(wing)
f Fs(area)g FA(method)555 1872 y Fs(\(defmethod)39 b(area)j(\(\(c)h
(unit-circle\)\))38 b(pi\))555 2059 y FA(then)24 b(this)g(method,)g
(rather)f(than)h(the)g(more)f(general)g(one,)i(will)g(run)e(when)h(we)g
(call)h Fs(area)555 2164 y FA(on)20 b(an)g(instance)g(of)g
Fs(unit-circle)p FA(.)680 2268 y(When)d(a)h(class)g(has)g(multiple)e
(superclasses,)i(their)f(precedence)e(runs)i(left)h(to)f(right.)28
b(By)555 2373 y(de\002ning)19 b(the)h(class)h Fs(patriotic-scoundr)o
(el)14 b FA(as)21 b(follo)n(ws)555 2556 y Fs(\(defclass)40
b(scoundrel)g(nil)i(nil\))555 2655 y(\(defclass)e(patriot)h(nil)h
(nil\))555 2755 y(\(defclass)e(patriotic-scound)o(re)o(l)e(\(scoundrel)
h(patriot\))h(nil\))555 2943 y FA(we)16 b(specify)e(that)i(patriotic)f
(scoundrels)f(are)h(scoundrels)f(\002rst)i(and)f(patriots)g(second.)27
b(When)555 3047 y(there)20 b(is)h(an)f(applicable)f(method)g(for)g
(both)h(superclasses,)555 3230 y Fs(\(defmethod)39 b(self-or-country?)e
(\(\(s)43 b(scoundrel\)\))642 3330 y('self\))555 3529
y(\(defmethod)c(self-or-country?)e(\(\(p)43 b(patriot\)\))642
3628 y('country\))555 3816 y FA(the)20 b(method)f(of)h(the)g
Fs(scoundrel)d FA(class)k(will)g(run:)555 3999 y Fs(>)43
b(\(self-or-country?)37 b(\(make-instance)h('patriotic-scou)o(nd)o(rel)
o(\)\))555 4098 y(SELF)680 4286 y FA(The)23 b(e)o(xamples)f(so)i(f)o
(ar)g(maintain)e(the)i(illusion)f(that)h Fr(CLOS)g FA(methods)e(are)i
(methods)e Ft(of)555 4391 y FA(some)j(object.)44 b(In)25
b(f)o(act,)h(the)o(y)e(are)i(something)d(more)i(general.)43
b(In)25 b(the)g(parameter)f(list)i(of)555 4495 y(the)e
Fs(move)g FA(method,)g(the)g(element)g Fs(\(c)43 b(circle\))22
b FA(is)j(called)g(a)g Ft(specialized)f FA(parameter;)h(it)555
4600 y(says)18 b(that)g(this)h(method)d(applies)i(when)f(the)h(\002rst)
g(ar)o(gument)d(to)j Fs(move)f FA(is)i(an)f(instance)f(of)h(the)555
4704 y Fs(circle)13 b FA(class.)25 b(In)13 b(a)g Fr(CLOS)g
FA(method,)e Ft(mor)m(e)i(than)g(one)g(par)o(ameter)g(can)g(be)g(spe)o
(cialized.)21 b FA(The)555 4809 y(follo)n(wing)e(method)f(has)j(tw)o(o)
f(specialized)g(and)g(one)f(optional)g(unspecialized)g(parameter:)p
eop
%%Page: 370 383
370 382 bop 555 538 a FA(370)877 b Fu(OBJECT)-5 b Fv(\255)p
Fu(ORIENTED)16 b(LISP)555 801 y Fs(\(defmethod)39 b(combine)i(\(\(ic)h
(ice-cream\))e(\(top)h(topping\))1427 900 y(&optional)f(\(where)h
(:here\)\))642 1000 y(\(append)g(\(list)g(\(name)h(ic\))g('ice-cream\))
991 1100 y(\(list)f('with)h(\(name)f(top\))h('topping\))991
1199 y(\(list)f('in)i('a)1252 1299 y(\(case)f(where)1340
1398 y(\(:here)84 b('glass\))1340 1498 y(\(:to-go)40
b('styrofoam\)\))1252 1598 y('dish\)\)\))555 1759 y FA(It)15
b(is)h(in)m(v)n(ok)o(ed)d(when)i(the)g(\002rst)g(tw)o(o)h(ar)o(guments)
d(to)i Fs(combine)d FA(are)j(instances)g(of)g Fs(ice-cream)555
1863 y FA(and)20 b Fs(topping)p FA(,)d(respecti)n(v)o(ely)-5
b(.)27 b(If)20 b(we)h(de\002ne)f(some)g(minimal)f(classes)j(to)e
(instantiate)555 2019 y Fs(\(defclass)40 b(stuff)h(\(\))i(\(\(name)e
(:accessor)f(name)i(:initarg)e(:name\)\)\))555 2119 y(\(defclass)g
(ice-cream)g(\(stuff\))g(nil\))555 2218 y(\(defclass)g(topping)h
(\(stuff\))f(nil\))555 2379 y FA(then)20 b(we)g(can)g(de\002ne)g(and)g
(run)f(this)i(method:)555 2535 y Fs(>)43 b(\(combine)d(\(make-instance)
e('ice-cream)i(:name)h('fig\))1034 2635 y(\(make-instance)d('topping)j
(:name)g('olive\))1034 2734 y(:here\))555 2834 y(\(FIG)h(ICE-CREAM)e
(WITH)i(OLIVE)f(TOPPING)g(IN)i(A)g(GLASS)e(DISH\))680
2995 y FA(When)30 b(methods)h(specialize)g(more)f(than)h(one)f(of)h
(their)g(parameters,)h(it)g(is)g(dif)n(\002cult)555 3099
y(to)26 b(continue)e(to)i(re)o(gard)e(them)h(as)i(properties)d(of)i
(classes.)47 b(Does)25 b(our)h Fs(combine)d FA(method)555
3204 y(belong)28 b(to)j(the)f Fs(ice-cream)c FA(class)31
b(or)f(the)g Fs(topping)d FA(class?)60 b(In)29 b Fr(CLOS)p
FA(,)k(the)d(model)f(of)555 3308 y(objects)22 b(responding)e(to)i
(messages)h(simply)f(e)n(v)n(aporates.)34 b(This)22 b(model)g(seems)h
(natural)e(so)555 3413 y(long)e(as)i(we)g(in)m(v)n(ok)o(e)e(methods)g
(by)h(saying)f(something)g(lik)o(e:)555 3569 y Fs(\(tell)42
b(obj)g('move)f(2)j(3\))555 3730 y FA(Then)26 b(we)i(are)f(clearly)f
(in)m(v)n(oking)f(the)i Fs(move)f FA(method)f(of)i Fs(obj)p
FA(.)49 b(But)28 b(once)e(we)h(drop)f(this)555 3834 y(syntax)20
b(in)g(f)o(a)n(v)n(or)g(of)g(a)g(functional)f(equi)n(v)n(alent:)555
3990 y Fs(\(move)42 b(obj)g(2)h(3\))555 4151 y FA(then)25
b(we)i(ha)n(v)o(e)e(to)h(de\002ne)f Fs(move)g FA(so)h(that)g(it)g
Ft(dispatc)o(hes)f FA(on)g(its)i(\002rst)g(ar)o(gument\227that)c(is,)
555 4256 y(looks)d(at)g(the)h(type)e(of)h(the)g(\002rst)h(ar)o(gument)d
(and)i(calls)h(the)f(appropriate)e(method.)680 4360 y(Once)f(we)h(ha)n
(v)o(e)f(tak)o(en)h(this)g(step,)g(the)g(question)f(arises:)29
b(why)17 b(only)f(allo)n(w)i(dispatching)555 4465 y(on)34
b(the)h(\002rst)h(ar)o(gument?)71 b(C)p Fr(LOS)35 b FA(answers:)59
b(why)34 b(indeed?)72 b(In)34 b Fr(CLOS)p FA(,)39 b(methods)34
b(can)555 4570 y(specialize)22 b(an)o(y)g(number)e(of)i(their)g
(parameters\227and)e(not)i(just)g(on)g(user)n(\255de\002ned)f(classes,)
555 4674 y(b)n(ut)h(on)g(Common)e(Lisp)i(types,)1486
4644 y Fm(3)1541 4674 y FA(and)g(e)n(v)o(en)f(on)g(indi)n(vidual)g
(objects.)34 b(Here)22 b(is)h(a)f Fs(combine)555 4779
y FA(method)d(that)h(applies)g(to)g(strings:)p 555 4839
1074 4 v 645 4894 a Fl(3)675 4918 y Fr(Or)g(more)g(precisely)l(,)j(on)d
(the)h(type\255lik)o(e)j(classes)d(that)h Fb(CLOS)f Fr(de\002nes)g(in)f
(parallel)j(with)f(the)f(Common)f(Lisp)555 5001 y(type)e(hierarchy)l(.)
p eop
%%Page: 371 384
371 383 bop 555 538 a Ft(25.4)1071 b Fu(METHODS)1053
b FA(371)555 801 y Fs(\(defmethod)39 b(combine)i(\(\(s1)h(string\))f
(\(s2)h(string\))f(&optional)f(int?\))642 900 y(\(let)i(\(\(str)g
(\(concatenate)c('string)j(s1)i(s2\)\)\))729 1000 y(\(if)g(int?)f
(\(intern)e(str\))i(str\)\)\))555 1188 y FA(Which)23
b(means)h(not)f(only)g(that)g(methods)g(are)g(no)g(longer)f(properties)
g(of)i(classes,)h(b)n(ut)e(that)555 1292 y(we)e(can)f(use)g(methods)f
(without)h(de\002ning)e(classes)k(at)e(all.)555 1475
y Fs(>)43 b(\(combine)d("I)j(am)g(not)f(a)h(")h("cook."\))555
1574 y("I)f(am)g(not)f(a)h(cook.")555 1762 y FA(Here)20
b(the)g(second)g(parameter)e(is)j(specialized)f(on)g(the)g(symbol)f
Fs(palindrome)p FA(:)555 1945 y Fs(\(defmethod)39 b(combine)i(\(\(s1)h
(sequence\))e(\(x)j(\(eql)f('palindrome\)\))1427 2044
y(&optional)e(\(length)g(:odd\)\))642 2144 y(\(concatenate)f(\(type-of)
h(s1\))1209 2244 y(s1)1209 2343 y(\(subseq)g(\(reverse)h(s1\))1557
2443 y(\(case)h(length)f(\(:odd)h(1\))g(\(:even)f(0\)\)\)\)\))555
2630 y FA(This)20 b(particular)f(method)g(mak)o(es)h(palindromes)e(of)i
(an)o(y)g(kind)f(of)h(sequence)f(elements:)3127 2600
y Fm(4)555 2813 y Fs(>)43 b(\(combine)d('\(able)i(was)g(i)h(ere\))f
('palindrome\))555 2913 y(\(ABLE)g(WAS)g(I)h(ERE)f(I)i(WAS)e(ABLE\))680
3100 y FA(At)21 b(this)h(point)e(we)h(no)g(longer)e(ha)n(v)o(e)i
(object\255oriented)d(programming,)f(b)n(ut)k(something)555
3205 y(more)29 b(general.)58 b(C)p Fr(LOS)30 b FA(is)h(designed)e(with)
h(the)g(understanding)d(that)j(beneath)f(methods)555
3310 y(there)21 b(is)i(this)f(concept)e(of)i(dispatch,)f(which)g(can)h
(be)f(done)g(on)g(more)g(than)g(one)g(ar)o(gument,)555
3414 y(and)c(can)g(be)g(based)g(on)g(more)f(than)h(an)g(ar)o(gument')-5
b(s)15 b(class.)29 b(When)17 b(methods)f(are)i(b)n(uilt)f(upon)555
3519 y(this)k(more)e(general)g(notion,)g(the)o(y)g(become)g
(independent)f(of)i(indi)n(vidual)e(classes.)30 b(Instead)555
3623 y(of)24 b(adhering)f(conceptually)f(to)j(classes,)i(methods)c(no)n
(w)h(adhere)f(to)i(other)f(methods)f(with)555 3728 y(the)17
b(same)h(name.)27 b(In)17 b Fr(CLOS)h FA(such)e(a)i(clump)e(of)h
(methods)f(is)j(called)e(a)g Ft(g)o(eneric)g(function.)27
b FA(All)555 3833 y(our)19 b Fs(combine)f FA(methods)h(implicitly)h
(de\002ne)g(the)g(generic)f(function)g Fs(combine)p FA(.)680
3937 y(W)-7 b(e)28 b(can)f(de\002ne)g(generic)g(functions)f(e)o
(xplicitly)g(with)i(the)f Fs(defgeneric)d FA(macro.)50
b(It)555 4042 y(is)24 b(not)e(necessary)h(to)g(call)g
Fs(defgeneric)d FA(to)j(de\002ne)f(a)h(generic)f(function,)g(b)n(ut)h
(it)h(can)e(be)h(a)555 4146 y(con)m(v)o(enient)15 b(place)i(to)g(put)g
(documentation,)e(or)i(some)h(sort)f(of)g(safety\255net)g(for)f
(errors.)28 b(Here)555 4251 y(we)21 b(do)e(both:)555
4434 y Fs(\(defgeneric)39 b(combine)i(\(x)h(y)i(&optional)c(z\))642
4533 y(\(:method)g(\(x)j(y)g(&optional)d(z\))773 4633
y("I)j(can't)e(combine)g(these)g(arguments."\))642 4733
y(\(:documentation)d("Combines)h(things."\)\))p 555 4804
1074 4 v 645 4859 a Fl(4)675 4883 y Fr(In)17 b(one)h(\(otherwise)h(e)o
(xcellent\))i(Common)c(Lisp)g(implementation,)k Fk(concatenate)f
Fr(will)e(not)g(accept)i Fk(cons)555 4966 y Fr(as)d(its)g(\002rst)g(ar)
o(gument,)h(so)f(this)g(call)i(will)f(not)f(w)o(ork.)p
eop
%%Page: 372 385
372 384 bop 555 538 a FA(372)877 b Fu(OBJECT)-5 b Fv(\255)p
Fu(ORIENTED)16 b(LISP)555 801 y FA(Since)i(the)g(method)f(gi)n(v)o(en)f
(here)i(for)f Fs(combine)f FA(doesn')o(t)g(specialize)i(an)o(y)f(of)h
(its)h(ar)o(guments,)555 905 y(it)i(will)g(be)f(the)g(one)g(called)g
(in)g(the)g(e)n(v)o(ent)g(no)f(other)h(method)f(is)i(applicable.)555
1080 y Fs(>)43 b(\(combine)d(#'expt)i("chocolate"\))555
1180 y("I)h(can't)e(combine)g(these)g(arguments.")555
1360 y FA(Before,)19 b(this)i(call)g(w)o(ould)e(ha)n(v)o(e)h(generated)
e(an)i(error)-5 b(.)680 1465 y(Generic)27 b(functions)f(impose)h(one)g
(restriction)g(that)h(we)g(don')o(t)e(ha)n(v)o(e)h(when)g(methods)555
1569 y(are)20 b(properties)f(of)h(objects:)29 b(when)20
b(all)h(methods)e(of)h(the)g(same)h(name)e(get)i(joined)e(into)h(one)
555 1674 y(generic)25 b(function,)g(their)h(parameter)f(lists)i(must)f
(agree.)46 b(That')-5 b(s)26 b(why)f(all)i(our)e Fs(combine)555
1778 y FA(methods)f(had)g(an)g(additional)f(optional)h(parameter)-5
b(.)41 b(After)25 b(de\002ning)e(the)i(\002rst)g Fs(combine)555
1883 y FA(method)14 b(to)g(tak)o(e)g(up)g(to)g(three)f(ar)n(gu)o(men)o
(ts,)d(it)k(w)o(ould)g(ha)n(v)o(e)g(caused)g(an)g(erro)o(r)g(if)f(we)h
(a)o(ttempte)o(d)555 1988 y(to)20 b(de\002ne)g(another)f(which)g(only)h
(took)f(tw)o(o.)680 2092 y(C)p Fr(LOS)k FA(requires)f(that)i(the)f
(parameter)f(lists)i(of)f(all)h(methods)e(with)h(the)h(same)f(name)g
(be)555 2197 y Ft(congruent.)45 b FA(T)-7 b(w)o(o)27
b(parameter)e(lists)i(are)f(congruent)e(if)j(the)o(y)e(ha)n(v)o(e)h
(the)g(same)g(number)f(of)555 2301 y(required)15 b(parameters,)g(the)i
(same)g(number)d(of)i(optional)g(parameters,)f(and)h(compatible)f(use)
555 2406 y(of)f Fs(&rest)g FA(and)g Fs(&key)p FA(.)21
b(The)14 b(actual)g(k)o(e)o(yw)o(ord)g(paramete)o(rs)g(accep)o(ted)f
(by)g(dif)m(fer)o(ent)h(m)o(etho)o(ds)555 2511 y(need)27
b(not)h(be)g(the)g(same,)j(b)n(ut)d Fs(defgeneric)c FA(can)k(insist)h
(that)f(all)h(its)g(methods)e(accept)h(a)555 2615 y(certain)20
b(minimal)f(set.)30 b(The)20 b(follo)n(wing)f(pairs)h(of)g(parameter)e
(lists)k(are)e(all)h(congruent:)555 2790 y Fs(\(x\))565
b(\(a\))555 2890 y(\(x)43 b(&optional)d(y\))i(\(a)h(&optional)d(b\))555
2990 y(\(x)j(y)g(&rest)e(z\))130 b(\(a)43 b(b)g(&rest)f(c\))555
3089 y(\(x)h(y)g(&rest)e(z\))130 b(\(a)43 b(b)g(&key)f(c)h(d\))555
3269 y FA(and)20 b(the)g(follo)n(wing)e(pairs)j(are)f(not:)555
3444 y Fs(\(x\))565 b(\(a)43 b(b\))555 3544 y(\(x)g(&optional)d(y\))i
(\(a)h(&optional)d(b)j(c\))555 3644 y(\(x)g(&optional)d(y\))i(\(a)h
(&rest)f(b\))555 3743 y(\(x)h(&key)f(x)h(y\))173 b(\(a\))680
3923 y FA(Rede\002ning)32 b(methods)g(is)i(just)g(lik)o(e)g
(rede\002ning)d(functions.)67 b(Since)34 b(only)e(required)555
4028 y(parameters)23 b(can)h(be)f(specialized,)i(each)e(method)g(is)i
(uniquely)d(identi\002ed)h(by)h(its)h(generic)555 4132
y(function)g(and)h(the)h(types)f(of)h(its)h(required)c(parameters.)48
b(If)26 b(we)i(de\002ne)e(another)f(method)555 4237 y(with)20
b(the)h(same)f(specializations,)f(it)i(o)o(v)o(erwrites)e(the)h
(original)f(one.)29 b(So)20 b(by)g(saying:)555 4412 y
Fs(\(defmethod)39 b(combine)i(\(\(x)h(string\))f(\(y)i(string\))1427
4512 y(&optional)d(ignore\))642 4611 y(\(concatenate)f('string)h(x)k(")
f(+)g(")g(y\)\))555 4791 y FA(we)21 b(rede\002ne)e(what)h
Fs(combine)e FA(does)i(when)f(its)i(\002rst)g(tw)o(o)g(ar)o(guments)d
(are)i(strings.)680 4896 y(Unfortunately)-5 b(,)22 b(if)i(instead)g(of)
g(rede\002ning)f(a)h(method)f(we)i(w)o(ant)f(to)h(remo)o(v)o(e)d(it,)k
(there)555 5001 y(is)f(no)e(b)n(uilt\255in)g(con)m(v)o(erse)f(of)h
Fs(defmethod)p FA(.)37 b(F)o(ortunately)-5 b(,)22 b(this)i(is)h(Lisp,)g
(so)f(we)g(can)f(write)p eop
%%Page: 373 386
373 385 bop 555 538 a Ft(25.5)1071 b Fu(METHODS)1053
b FA(373)p 555 745 2678 4 v 553 2366 4 1621 v 605 888
a Fs(\(defmacro)40 b(undefmethod)f(\(name)i(&rest)h(args\))692
988 y(\(if)g(\(consp)f(\(car)h(args\)\))866 1087 y(\(udm)g(name)g(nil)h
(\(car)e(args\)\))866 1187 y(\(udm)h(name)g(\(list)g(\(car)g(args\)\))f
(\(cadr)g(args\)\)\)\))605 1386 y(\(defun)g(udm)h(\(name)g(qual)g
(specs\))692 1486 y(\(let)g(\(\(classes)e(\(mapcar)g(#'\(lambda)g
(\(s\))1869 1586 y(`\(find-class)e(',s\)\))1694 1685
y(specs\)\)\))779 1785 y(`\(remove-method)g(\(symbol-functio)o(n)g
(',name\))1477 1884 y(\(find-method)g(\(symbol-function)f(',name\))2043
1984 y(',qual)2043 2084 y(\(list)42 b(,@classes\)\)\)\)\))1158
2288 y FA(Figure)19 b(25.12:)28 b(Macro)19 b(for)h(remo)o(ving)e
(methods.)p 3231 2366 V 555 2369 2678 4 v 555 2594 a(one.)61
b(The)31 b(details)g(of)g(ho)n(w)g(to)g(remo)o(v)o(e)e(a)j(method)d(by)
i(hand)f(are)h(summarized)e(in)j(the)555 2698 y(implementation)22
b(of)h Fs(undefmethod)d FA(in)k(Figure)g(25.12.)39 b(W)-7
b(e)25 b(use)f(this)g(macro)f(by)h(gi)n(ving)555 2803
y(ar)o(guments)f(similar)i(to)g(those)f(we)h(w)o(ould)f(gi)n(v)o(e)g
(to)h Fs(defmethod)p FA(,)e(e)o(xcept)g(that)i(instead)g(of)555
2907 y(gi)n(ving)g(a)j(whole)e(parameter)f(list)j(as)f(the)g(second)f
(or)g(third)g(ar)o(gument,)g(we)h(gi)n(v)o(e)f(just)i(the)555
3012 y(class\255names)d(of)g(the)g(required)e(parameters.)42
b(So)26 b(to)f(remo)o(v)o(e)e(the)i Fs(combine)e FA(method)g(for)555
3117 y(tw)o(o)d(strings,)g(we)h(say:)555 3299 y Fs(\(undefmethod)39
b(combine)h(\(string)h(string\)\))555 3487 y FA(Unspecialized)20
b(ar)o(guments)f(are)i(implicitly)f(of)h(class)h Fs(t)p
FA(,)f(so)g(if)g(we)g(had)g(de\002ned)f(a)h(method)555
3591 y(with)f(required)f(b)n(ut)h(unspecialized)f(parameters:)555
3774 y Fs(\(defmethod)39 b(combine)i(\(\(fn)h(function\))e(x)j
(&optional)d(y\))642 3874 y(\(funcall)g(fn)j(x)g(y\)\))555
4061 y FA(we)21 b(could)e(get)h(rid)g(of)g(it)h(by)f(saying)555
4244 y Fs(\(undefmethod)39 b(combine)h(\(function)g(t\)\))555
4432 y FA(If)26 b(we)h(w)o(ant)f(to)h(remo)o(v)o(e)d(a)j(whole)f
(generic)f(function,)h(we)h(can)f(do)g(it)h(the)f(same)h(w)o(ay)f(we)
555 4536 y(w)o(ould)19 b(remo)o(v)o(e)g(the)h(de\002nition)f(of)h(an)o
(y)f(function,)g(by)g(calling)h Fs(fmakunbound)p FA(:)555
4719 y Fs(\(fmakunbound)39 b('combine\))p eop
%%Page: 374 387
374 386 bop 555 538 a FA(374)877 b Fu(OBJECT)-5 b Fv(\255)p
Fu(ORIENTED)16 b(LISP)555 801 y Fw(25.5)99 b(A)-5 b(uxiliary)24
b(Methods)i(and)f(Combination)555 991 y FA(Auxiliary)c(methods)g(w)o
(ork)o(ed)g(in)h(our)g(sk)o(etch)g(basically)g(as)h(the)o(y)e(do)h(in)g
Fr(CLOS)p FA(.)36 b(So)22 b(f)o(ar)g(we)555 1096 y(ha)n(v)o(e)c(seen)h
(only)f(primary)f(methods,)g(b)n(ut)i(we)g(can)f(also)h(ha)n(v)o(e)f
(before\255,)f(after)n(\255)i(and)f(around\255)555 1200
y(methods.)52 b(Such)27 b(auxiliary)g(methods)g(are)h(de\002ned)f(by)g
(putting)g(a)i(qualifying)c(k)o(e)o(yw)o(ord)555 1305
y(after)f(the)g(method)f(name)h(in)h(the)f(call)h(to)f
Fs(defmethod)p FA(.)39 b(If)24 b(we)h(de\002ne)f(a)g(primary)f
Fs(speak)555 1410 y FA(method)c(for)g(the)i Fs(speaker)c
FA(class)22 b(as)f(follo)n(ws:)555 1592 y Fs(\(defclass)40
b(speaker)h(nil)h(nil\))555 1792 y(\(defmethod)d(speak)j(\(\(s)g
(speaker\))f(string\))642 1891 y(\(format)g(t)i("~A")f(string\)\))555
2079 y FA(Then)17 b(calling)h Fs(speak)e FA(with)i(an)g(instance)g(of)f
Fs(speaker)f FA(just)i(prints)g(the)g(second)f(ar)o(gument:)555
2261 y Fs(>)43 b(\(speak)e(\(make-instance)d('speaker\))947
2361 y("life)k(is)h(not)f(what)g(it)h(used)f(to)g(be"\))555
2461 y(life)g(is)h(not)f(what)g(it)h(used)f(to)g(be)555
2560 y(NIL)555 2748 y FA(By)29 b(de\002ning)e(a)h(subclass)h
Fs(intellectual)24 b FA(which)j(wraps)h(before\255)f(and)h(after)n
(\255methods)555 2853 y(around)18 b(the)j(primary)d Fs(speak)h
FA(method,)555 3035 y Fs(\(defclass)40 b(intellectual)e(\(speaker\))i
(nil\))555 3234 y(\(defmethod)f(speak)j(:before)f(\(\(i)h
(intellectual\))c(string\))642 3334 y(\(princ)j("Perhaps)g("\)\))555
3533 y(\(defmethod)e(speak)j(:after)f(\(\(i)h(intellectual\))d
(string\))642 3633 y(\(princ)i(")i(in)g(some)f(sense"\)\))555
3821 y FA(we)28 b(can)g(create)g(a)g(subclass)g(of)g(speak)o(ers)f
(which)h(al)o(w)o(ays)g(ha)n(v)o(e)f(the)h(last)h(\(and)e(the)h
(\002rst\))555 3925 y(w)o(ord:)555 4108 y Fs(>)43 b(\(speak)e
(\(make-instance)d('intellectual\))947 4207 y("life)k(is)h(not)f(what)g
(it)h(used)f(to)g(be"\))555 4307 y(Perhaps)f(life)h(is)g(not)h(what)f
(it)g(used)g(to)h(be)g(in)g(some)f(sense)555 4407 y(NIL)555
4594 y FA(In)36 b(standard)e(method)h(combination,)i(the)f(methods)f
(are)g(called)h(as)h(described)d(in)i(our)555 4699 y(sk)o(etch:)29
b(all)21 b(the)f(before\255methods,)d(most)j(speci\002c)g(\002rst,)h
(then)f(the)g(most)g(speci\002c)g(primary)555 4804 y(method,)h(then)h
(all)g(the)h(after)n(\255methods,)d(most)i(speci\002c)h(last.)35
b(So)23 b(if)f(we)h(de\002ne)e(before\255)g(or)555 4908
y(after)n(\255methods)d(for)i(the)g Fs(speaker)e FA(superclass,)p
eop
%%Page: 375 388
375 387 bop 555 538 a Ft(25.5)607 b Fu(A)m(UXILIAR)l(Y)19
b(METHODS)g(AND)g(COMBIN)n(A)-7 b(TION)590 b FA(375)555
801 y Fs(\(defmethod)39 b(speak)j(:before)f(\(\(s)h(speaker\))e
(string\))642 900 y(\(princ)h("I)i(think)f("\)\))555
1088 y FA(the)o(y)19 b(will)i(get)g(called)f(in)g(the)g(middle)g(of)f
(the)i(sandwich:)555 1271 y Fs(>)43 b(\(speak)e(\(make-instance)d
('intellectual\))947 1370 y("life)k(is)h(not)f(what)g(it)h(used)f(to)g
(be"\))555 1470 y(Perhaps)f(I)i(think)e(life)h(is)h(not)f(what)g(it)h
(used)f(to)h(be)g(in)f(some)g(sense)555 1569 y(NIL)555
1757 y FA(Re)o(gardless)21 b(of)g(what)g(before\255)e(or)i(after)n
(\255methods)f(get)h(called,)g(the)h(v)n(alue)e(returned)g(by)h(the)555
1862 y(generic)i(function)g(is)j(the)e(v)n(alue)g(of)g(the)h(most)f
(speci\002c)h(primary)e(method\227in)f(this)j(case,)555
1966 y(the)20 b Fs(nil)g FA(returned)e(by)i Fs(format)p
FA(.)680 2071 y(This)h(changes)e(if)j(there)e(are)h(around\255methods.)
27 b(If)21 b(one)f(of)h(the)g(classes)h(in)f(an)g(object')-5
b(s)555 2175 y(f)o(amily)14 b(tree)g(has)g(an)g(around\255m)o(etho)o
(d\227o)o(r)g(m)o(or)o(e)g(pr)o(ecisely)-6 b(,)9 b(if)14
b(there)g(is)g(an)g(around\255metho)o(d)555 2280 y(specialized)k(for)g
(the)h(ar)o(guments)e(passed)h(to)h(the)g(generic)e(function\227the)g
(around\255method)555 2385 y(will)h(get)f(called)g(\002rst,)h(and)f
(the)g(rest)h(of)e(the)i(methods)e(will)h(only)g(run)f(if)i(the)f
(around\255method)555 2489 y(decides)23 b(to)g(let)h(them.)38
b(As)24 b(in)f(our)g(sk)o(etch,)g(an)g(around\255)e(or)i(primary)f
(method)g(can)h(in)m(v)n(ok)o(e)555 2594 y(the)f(ne)o(xt)g(method)f(by)
h(calling)g(a)h(function:)33 b(the)22 b(function)f(we)i(de\002ned)e(as)
i Fs(call-next)d FA(is)555 2699 y(in)g Fr(CLOS)g FA(called)f
Fs(call-next-method)o FA(.)24 b(There)18 b(is)j(also)f(a)g
Fs(next-method-p)p FA(,)14 b(analogous)555 2803 y(to)k(our)f
Fs(next-p)p FA(.)26 b(W)m(ith)18 b(around\255methods)13
b(we)18 b(can)g(de\002ne)f(another)f(subclass)i(of)f
Fs(speaker)555 2908 y FA(which)j(is)h(more)e(circumspect:)555
3090 y Fs(\(defclass)40 b(courtier)g(\(speaker\))g(nil\))555
3290 y(\(defmethod)f(speak)j(:around)f(\(\(c)h(courtier\))e(string\))
642 3389 y(\(format)h(t)i("Does)f(the)g(King)g(believe)f(that)g(~A?)i
(")g(string\))642 3489 y(\(if)g(\(eq)f(\(read\))f('yes\))817
3589 y(\(if)h(\(next-method-p\))37 b(\(call-next-method)o(\)\))817
3688 y(\(format)j(t)j("Indeed,)e(it)h(is)h(a)g(preposterous)c
(idea.~\045"\)\))642 3788 y('bow\))555 3975 y FA(When)34
b(the)g(\002rst)h(ar)o(gument)c(to)j Fs(speak)f FA(is)i(an)f(instance)f
(of)h(the)g Fs(courtier)d FA(class,)39 b(the)555 4080
y(courtier')-5 b(s)19 b(tongue)g(is)i(no)n(w)f(guarded)e(by)i(the)g
(around\255method:)555 4263 y Fs(>)43 b(\(speak)e(\(make-instance)d
('courtier\))i("kings)h(will)h(last"\))555 4362 y(Does)g(the)g(King)g
(believe)f(that)h(kings)f(will)h(last?)g(yes)555 4462
y(I)h(think)f(kings)f(will)h(last)555 4562 y(BOW)555
4661 y(>)h(\(speak)e(\(make-instance)d('courtier\))i("the)h(world)h(is)
h(round"\))555 4761 y(Does)f(the)g(King)g(believe)f(that)h(the)g(world)
g(is)g(round?)g(no)555 4860 y(Indeed,)f(it)h(is)h(a)g(preposterous)c
(idea.)555 4960 y(BOW)p eop
%%Page: 376 389
376 388 bop 555 538 a FA(376)877 b Fu(OBJECT)-5 b Fv(\255)p
Fu(ORIENTED)16 b(LISP)555 801 y FA(Note)29 b(that,)j(unlik)o(e)c
(before\255)g(and)h(after)n(\255methods,)g(the)g(v)n(alue)g(returned)f
(by)g(the)i(around\255)555 905 y(method)19 b(is)i(returned)d(as)j(the)f
(v)n(alue)g(of)g(the)g(generic)f(function.)680 1010 y(Generally)-5
b(,)28 b(methods)g(are)g(run)g(as)h(in)g(this)g(outline,)g(which)f(is)h
(reprinted)e(from)g(Sec\255)555 1114 y(tion)20 b(25.2:)659
1295 y(1.)41 b(The)19 b(most)i(speci\002c)f(around\255method,)c(if)k
(there)g(is)h(one.)659 1464 y(2.)41 b(Otherwise,)19 b(in)i(order:)812
1647 y(\(a\))40 b(All)21 b(before\255methods,)c(from)i(most)h
(speci\002c)g(to)h(least)g(speci\002c.)807 1782 y(\(b\))40
b(The)20 b(most)g(speci\002c)h(primary)d(method.)812
1917 y(\(c\))40 b(All)21 b(after)n(\255methods,)d(from)h(least)i
(speci\002c)f(to)h(most)f(speci\002c.)555 2101 y(This)27
b(w)o(ay)f(of)g(combining)e(methods)h(is)j(called)e(standard)f(method)g
(combination.)45 b(As)27 b(in)555 2205 y(our)f(sk)o(etch,)j(it)e(is)h
(possible)f(to)g(de\002ne)g(methods)e(which)i(are)g(combined)e(in)i
(other)f(w)o(ays:)555 2310 y(for)18 b(e)o(xample,)g(for)g(a)h(generic)f
(function)f(to)i(return)f(the)h(sum)g(of)f(all)i(the)f(applicable)e
(primary)555 2415 y(methods.)680 2519 y(In)24 b(our)g(program,)f(we)i
(speci\002ed)g(ho)n(w)f(to)h(combine)e(methods)h(by)g(calling)g
Fs(defcomb)p FA(.)555 2624 y(By)j(def)o(ault,)h(methods)e(were)h
(combined)e(as)j(in)f(the)g(outline)f(abo)o(v)o(e,)h(b)n(ut)g(by)f
(saying,)i(for)555 2729 y(e)o(xample,)555 2904 y Fs(\(defcomb)40
b(price)i(#'+\))555 3085 y FA(we)19 b(could)e(cause)h(the)g(function)f
Fs(price)f FA(to)j(return)e(the)h(sum)g(of)g(all)h(the)f(applicable)f
(primary)555 3190 y(methods.)680 3294 y(In)i Fr(CLOS)h
FA(this)g(is)h(called)e Ft(oper)o(ator)g FA(method)f(combination.)26
b(As)21 b(in)f(our)e(program,)g(such)555 3399 y(method)f(combination)f
(can)j(be)f(understood)e(as)k(if)f(it)g(resulted)f(in)h(the)f(e)n(v)n
(aluation)f(of)h(a)h(Lisp)555 3504 y(e)o(xpression)27
b(whose)h(\002rst)h(element)f(w)o(as)h(some)f(operator)m(,)g(and)g
(whose)g(ar)o(guments)f(were)555 3608 y(calls)22 b(to)g(the)f
(applicable)f(primary)g(methods,)g(in)i(order)e(of)h(speci\002city)-5
b(.)32 b(If)21 b(we)h(de\002ned)f(the)555 3713 y Fs(price)i
FA(generic)g(function)g(to)i(combine)e(v)n(alues)h(with)h
Fs(+)p FA(,)g(and)f(there)g(were)h(no)f(applicable)555
3817 y(around\255methods,)16 b(it)21 b(w)o(ould)e(beha)n(v)o(e)g(as)i
(though)e(it)i(were)f(de\002ned:)555 4016 y Fs(\(defun)41
b(price)h(\(&rest)f(args\))642 4121 y(\(+)i(\(apply)e
Fq(h)p FA(most)21 b(speci\002c)f(primary)f(method)p Fq(i)41
b Fs(args\))773 4212 y(.)773 4246 y(.)773 4279 y(.)773
4383 y(\(apply)g Fq(h)p FA(least)21 b(speci\002c)g(primary)d(method)p
Fq(i)42 b Fs(args\)\)\))555 4582 y FA(If)22 b(there)g(are)g(applicable)
f(around\255methods,)e(the)o(y)j(tak)o(e)g(precedence,)e(just)j(as)g
(in)g(standard)555 4687 y(method)13 b(combination.)24
b(Under)13 b(operator)f(method)h(combination,)f(an)i(around\255method)c
(can)555 4791 y(still)28 b(call)f(the)f(ne)o(xt)g(method)g(via)g
Fs(call-next-method)p FA(.)43 b(Ho)n(we)n(v)o(er)m(,)26
b(primary)f(methods)555 4896 y(can)j(no)g(longer)e(use)j
Fs(call-next-metho)o(d)p FA(.)47 b(\(This)28 b(is)h(a)g(dif)n(ference)d
(from)h(our)g(sk)o(etch,)555 5001 y(where)20 b(we)g(left)h
Fs(call-next)c FA(a)n(v)n(ailable)i(to)i(such)f(methods.\))p
eop
%%Page: 377 390
377 389 bop 555 538 a Ft(25.6)994 b Fu(CLOS)18 b(AND)i(LISP)976
b FA(377)680 801 y(In)31 b Fr(CLOS)p FA(,)k(we)d(can)g(specify)f(the)h
(type)f(of)h(method)e(combination)f(to)j(be)g(used)g(by)f(a)555
905 y(generic)k(function)f(by)i(gi)n(ving)e(the)i(optional)f
Fs(:method-combinat)o(ion)30 b FA(ar)o(gument)j(to)555
1010 y Fs(defgeneric)p FA(:)555 1184 y Fs(\(defgeneric)39
b(price)j(\(x\))642 1284 y(\(:method-combinat)o(io)o(n)37
b(+\)\))555 1464 y FA(No)n(w)16 b(the)g Fs(price)f FA(method)f(will)j
(use)f Fs(+)h FA(method)d(combination.)26 b(If)16 b(we)g(de\002ne)g
(some)f(classes)555 1568 y(with)20 b(prices,)555 1743
y Fs(\(defclass)40 b(jacket)h(nil)h(nil\))555 1842 y(\(defclass)e
(trousers)g(nil)i(nil\))555 1942 y(\(defclass)e(suit)i(\(jacket)e
(trousers\))g(nil\))555 2141 y(\(defmethod)f(price)j(+)h(\(\(jk)f
(jacket\)\))e(350\))555 2241 y(\(defmethod)f(price)j(+)h(\(\(tr)f
(trousers\)\))e(200\))555 2421 y FA(then)28 b(when)g(we)h(ask)g(for)f
(the)h(price)f(of)g(an)h(instance)f(of)g Fs(suit)p FA(,)h(we)g(get)g
(the)g(sum)f(of)h(the)555 2525 y(applicable)19 b Fs(price)g
FA(methods:)555 2700 y Fs(>)43 b(\(price)e(\(make-instance)d('suit\)\))
555 2799 y(550)555 2979 y FA(The)23 b(follo)n(wing)e(symbols)i(can)g
(be)g(used)g(as)h(the)f(second)f(ar)o(gument)f(to)i Fs(defmethod)e
FA(or)h(in)555 3084 y(the)e Fs(:method-combinati)o(on)14
b FA(option)19 b(to)h Fs(defgeneric)p FA(:)686 3258 y
Fs(+)130 b(and)g(append)e(list)h(max)h(min)f(nconc)g(or)h(progn)555
3438 y FA(By)18 b(calling)f Fs(define-method-c)o(omb)o(in)o(ati)o(on)11
b FA(you)17 b(can)g(de\002ne)g(other)f(kinds)h(of)g(method)555
3542 y(combination;)h(see)j Fr(CL)-6 b(TL)p FA(2,)19
b(p.)h(830.)680 3647 y(Once)i(you)h(specify)f(the)h(method)f
(combination)f(a)i(generic)g(function)e(should)h(use,)i(all)555
3752 y(methods)18 b(for)h(that)g(function)e(must)j(use)f(the)g(same)h
(kind.)28 b(No)n(w)19 b(it)h(w)o(ould)e(cause)h(an)g(error)f(if)555
3856 y(we)i(tried)f(to)h(use)g(another)e(operator)g(\(or)h
Fs(:before)e FA(or)i Fs(:after)p FA(\))e(as)k(the)e(second)g(ar)o
(gument)555 3961 y(in)j(a)g Fs(defmethod)d FA(for)i Fs(price)p
FA(.)33 b(If)21 b(we)h(do)g(w)o(ant)g(to)g(change)e(the)i(method)e
(combination)g(of)555 4065 y Fs(price)f FA(we)h(must)g(remo)o(v)o(e)f
(the)h(whole)g(generic)f(function)f(by)i(calling)g Fs(fmakunbound)p
FA(.)555 4317 y Fw(25.6)99 b(CLOS)25 b(and)h(Lisp)555
4507 y FA(C)p Fr(LOS)i FA(mak)o(es)e(a)i(good)e(e)o(xample)f(of)i(an)g
(embedded)e(language.)48 b(This)28 b(kind)e(of)h(program)555
4612 y(usually)20 b(brings)f(tw)o(o)h(re)n(w)o(ards:)659
4791 y(1.)41 b(Embedded)22 b(languages)i(can)g(be)h(conceptually)e
(well\255inte)o(grated)g(with)i(their)g(en)m(vi\255)763
4896 y(ronment,)16 b(so)j(that)f(within)g(the)g(embedded)e(language)g
(we)j(can)f(continue)e(to)i(think)g(of)763 5001 y(programs)g(in)i(much)
f(the)i(same)f(terms.)p eop
%%Page: 378 391
378 390 bop 555 538 a FA(378)877 b Fu(OBJECT)-5 b Fv(\255)p
Fu(ORIENTED)16 b(LISP)659 801 y FA(2.)41 b(Embedded)22
b(languages)g(can)i(be)h(po)n(werful,)e(because)h(the)o(y)f(tak)o(e)i
(adv)n(antage)d(of)i(all)763 905 y(the)c(things)g(that)g(the)g(base)g
(language)f(already)g(kno)n(ws)g(ho)n(w)h(to)g(do.)555
1093 y(C)p Fr(LOS)31 b FA(wins)f(on)g(both)f(counts.)59
b(It)31 b(is)g(v)o(ery)e(well\255inte)o(grated)f(with)i(Lisp,)j(and)d
(it)h(mak)o(es)555 1197 y(good)20 b(use)h(of)g(the)g(abstractions)g
(that)g(Lisp)g(has)h(already)-5 b(.)30 b(Indeed,)20 b(we)h(can)g(often)
g(see)g(Lisp)555 1302 y(through)i Fr(CLOS)p FA(,)j(the)f(w)o(ay)h(we)f
(can)g(see)h(the)f(shapes)g(of)g(objects)f(through)f(a)j(sheet)f
(draped)555 1407 y(o)o(v)o(er)19 b(them.)680 1511 y(It)29
b(is)i(no)e(accident)f(that)i(we)f(usually)g(speak)g(to)h
Fr(CLOS)f FA(through)f(a)h(layer)g(of)g(macros.)555 1616
y(Macros)13 b(do)g(transformation,)c(and)k Fr(CLOS)g
FA(is)g(essentially)g(a)g(program)g(which)g(tak)n(es)g(pro)o(gr)o(ams)
555 1721 y(b)n(uilt)24 b(out)g(of)f(object\255oriented)f(abstractions,)
h(and)h(translates)g(them)g(into)f(programs)f(b)n(uilt)555
1825 y(out)e(of)g(Lisp)g(abstractions.)680 1930 y(As)29
b(the)f(\002rst)h(tw)o(o)f(sections)h(suggested,)g(the)f(abstractions)f
(of)h(object\255oriented)e(pro\255)555 2034 y(gramming)18
b(map)h(so)i(neatly)e(onto)g(those)h(of)f(Lisp)i(that)f(one)f(could)g
(almost)h(call)g(the)g(former)555 2139 y(a)d(special)g(case)h(of)e(the)
h(latter)-5 b(.)29 b(The)16 b(objects)h(of)f(object\255oriented)e
(programming)g(can)i(easily)555 2244 y(be)k(implemented)f(as)i(Lisp)f
(objects,)g(and)g(their)g(methods)f(as)i(le)o(xical)f(closures.)30
b(By)20 b(taking)555 2348 y(adv)n(antage)f(of)h(such)h(isomorphisms,)e
(we)i(were)g(able)f(to)h(pro)o(vide)e(a)i(rudimentary)d(form)i(of)555
2453 y(object\255oriented)f(programming)f(in)k(just)g(a)g(fe)n(w)g
(lines)g(of)f(code,)g(and)g(a)i(sk)o(etch)e(of)g Fr(CLOS)h
FA(in)555 2557 y(a)f(fe)n(w)f(pages.)680 2662 y(C)p Fr(LOS)d
FA(is)h(a)g(great)f(deal)g(lar)o(ger)f(and)h(more)f(po)n(werful)g(than)
h(our)f(sk)o(etch,)i(b)n(ut)f(not)g(so)h(lar)o(ge)555
2767 y(as)f(to)f(disguise)f(its)i(roots)f(as)g(an)g(embedded)e
(language.)26 b(T)-7 b(ak)o(e)16 b Fs(defmethod)d FA(as)j(an)g(e)o
(xample.)555 2871 y(Though)h Fr(CL)-6 b(TL)p FA(2)18
b(does)h(not)g(mention)f(it)i(e)o(xplicitly)-5 b(,)18
b Fr(CLOS)h FA(methods)f(ha)n(v)o(e)h(all)h(the)f(po)n(wer)f(of)555
2976 y(le)o(xical)i(closures.)29 b(If)20 b(we)g(de\002ne)g(se)n(v)o
(eral)f(methods)h(within)g(the)g(scope)g(of)f(some)h(v)n(ariable,)555
3158 y Fs(\(let)42 b(\(\(transactions)c(0\)\))642 3258
y(\(defmethod)i(withdraw)g(\(\(a)i(account\))f(amt\))729
3358 y(\(incf)h(transactions\))729 3457 y(\(decf)g(\(balance)e(a\))j
(amt\)\))642 3557 y(\(defmethod)d(deposit)g(\(\(a)j(account\))d(amt\))
729 3657 y(\(incf)i(transactions\))729 3756 y(\(incf)g(\(balance)e(a\))
j(amt\)\))642 3856 y(\(defun)e(transactions)e(\(\))729
3955 y(transactions\)\))555 4143 y FA(then)20 b(at)h(runtime)f(the)o(y)
g(will)h(share)g(access)g(to)g(the)g(v)n(ariable,)e(just)i(lik)o(e)g
(closures.)30 b(Methods)555 4248 y(can)25 b(do)f(this)i(because,)f
(underneath)d(the)j(syntax,)h(the)o(y)e Ft(ar)m(e)h FA(closures.)43
b(In)25 b(the)g(e)o(xpansion)555 4352 y(of)g(a)h Fs(defmethod)p
FA(,)d(its)k(body)d(appears)h(intact)g(in)h(the)f(body)f(of)i(a)f
(sharp\255quoted)e(lambda\255)555 4457 y(e)o(xpression.)680
4562 y(Section)c(7.6)h(suggested)f(that)h(it)h(w)o(as)g(easier)f(to)g
(concei)n(v)o(e)f(of)h(ho)n(w)f(macros)h(w)o(ork)f(than)555
4666 y(what)f(the)o(y)f(mean.)28 b(Lik)o(e)n(wise,)18
b(the)g(secret)h(to)f(understanding)d Fr(CLOS)j FA(is)h(to)f
(understand)e(ho)n(w)555 4771 y(it)21 b(maps)f(onto)f(the)i
(fundamental)c(abstractions)j(of)g(Lisp.)p eop
%%Page: 379 392
379 391 bop 555 538 a Ft(25.7)958 b Fu(WHEN)19 b(T)o(O)f(OBJECT)940
b FA(379)555 801 y Fw(25.7)99 b(When)26 b(to)e(Object)555
991 y FA(The)i(object\255oriented)e(style)j(pro)o(vides)e(se)n(v)o
(eral)i(distinct)f(bene\002ts.)49 b(Dif)n(ferent)25 b(programs)555
1096 y(need)i(these)h(bene\002ts)g(to)g(v)n(arying)e(de)o(grees.)51
b(At)29 b(one)e(end)g(of)h(the)g(continuum)d(there)j(are)555
1200 y(programs\227simulations,)18 b(for)i(e)o(xample\227which)f(are)h
(most)h(naturally)f(e)o(xpressed)g(in)h(the)555 1305
y(abstractions)34 b(of)g(object\255oriented)e(programming.)69
b(At)35 b(the)f(other)g(end)g(are)g(programs)555 1410
y(written)20 b(in)g(the)h(object\255oriented)c(style)j(mainly)g(to)g
(mak)o(e)g(them)g(e)o(xtensible.)680 1514 y(Extensibility)25
b(is)i(indeed)e(one)g(of)h(the)g(great)g(bene\002ts)g(of)g(the)g
(object\255oriented)d(style.)555 1619 y(Instead)h(of)g(being)f(a)i
(single)f(monolithic)f(blob)g(of)h(code,)g(a)h(program)d(is)k(written)e
(in)g(small)555 1723 y(pieces,)36 b(each)c(labelled)g(with)h(its)g
(purpose.)65 b(So)33 b(later)g(when)f(someone)f(else)i(w)o(ants)g(to)
555 1828 y(modify)22 b(the)i(program,)e(it)j(will)f(be)g(easy)g(to)g
(\002nd)f(the)h(part)g(that)g(needs)f(to)h(be)g(changed.)38
b(If)555 1933 y(we)18 b(w)o(ant)g(to)g(change)f(the)h(w)o(ay)g(that)g
(objects)g(of)f(type)h Fs(ob)f FA(are)h(displayed)f(on)h(the)f(screen,)
h(we)555 2037 y(change)k(the)h Fs(display)e FA(method)h(of)g(the)i
Fs(ob)e FA(class.)39 b(If)23 b(we)h(w)o(ant)f(to)h(mak)o(e)e(a)i(ne)n
(w)f(class)h(of)555 2142 y(objects)c(lik)o(e)h Fs(ob)p
FA(s)g(b)n(ut)f(dif)n(ferent)f(in)i(a)g(fe)n(w)g(respects,)f(we)h(can)f
(create)h(a)g(subclass)g(of)f Fs(ob)p FA(;)g(in)555 2246
y(the)i(subclass,)g(we)h(change)d(the)i(properties)f(we)h(w)o(ant,)g
(and)g(all)g(the)g(rest)g(will)h(be)f(inherited)555 2351
y(by)29 b(def)o(ault)f(from)g(the)h Fs(ob)g FA(class.)56
b(And)29 b(if)g(we)h(just)f(w)o(ant)g(to)g(mak)o(e)g(a)g(single)g
Fs(ob)g FA(which)555 2456 y(beha)n(v)o(es)19 b(dif)n(ferently)e(from)i
(the)g(rest,)h(we)g(can)f(create)h(a)g(ne)n(w)f(child)g(of)g
Fs(ob)h FA(and)f(modify)f(the)555 2560 y(child')-5 b(s)20
b(properties)e(directly)-5 b(.)28 b(If)19 b(the)h(program)e(w)o(as)i
(written)g(carefully)e(to)i(be)o(gin)e(with,)i(we)555
2665 y(can)j(mak)o(e)f(all)i(these)f(types)f(of)h(modi\002cations)e
(without)h(e)n(v)o(en)g(looking)f(at)j(the)f(rest)g(of)g(the)555
2770 y(code.)28 b(From)17 b(this)h(point)f(of)h(vie)n(w)-5
b(,)17 b(an)h(object\255oriented)d(program)h(is)j(a)f(program)e(or)o
(ganized)555 2874 y(lik)o(e)26 b(a)g(table:)40 b(we)26
b(can)f(change)f(it)j(quickly)d(and)h(safely)g(by)g(looking)f(up)h(the)
h(appropriate)555 2979 y(entry)-5 b(.)680 3083 y(Extensibility)32
b(demands)h(the)h(least)h(from)d(the)i(object\255oriented)d(style.)71
b(In)34 b(f)o(act,)j(it)555 3188 y(demands)18 b(so)i(little)h(that)e
(an)h(e)o(xtensible)f(program)e(might)i(not)g(need)g(to)h(be)f
(object\255oriented)555 3293 y(at)j(all.)34 b(If)21 b(the)h(preceding)d
(chapters)i(ha)n(v)o(e)g(sho)n(wn)g(an)o(ything,)e(the)o(y)i(ha)n(v)o
(e)g(sho)n(wn)g(that)g(Lisp)555 3397 y(programs)g(do)h(not)g(ha)n(v)o
(e)g(to)g(be)h(monolithic)d(blobs)i(of)g(code.)36 b(Lisp)22
b(of)n(fers)g(a)h(whole)f(range)555 3502 y(of)17 b(options)g(for)g(e)o
(xtensibility)-5 b(.)27 b(F)o(or)17 b(e)o(xample,)g(you)f(could)h
(quite)g(literally)h(ha)n(v)o(e)f(a)h(program)555 3606
y(or)o(ganized)e(lik)o(e)j(a)g(table:)29 b(a)19 b(program)d(which)i
(consisted)h(of)f(a)h(set)h(of)e(closures)h(stored)f(in)h(an)555
3711 y(array)-5 b(.)680 3816 y(If)26 b(it')-5 b(s)27
b(e)o(xtensibility)e(you)g(need,)i(you)e(don')o(t)g(ha)n(v)o(e)g(to)i
(choose)e(between)g(an)i(\223object\255)555 3920 y(oriented\224)32
b(and)h(a)h(\223traditional\224)e(program.)66 b(Y)-9
b(ou)33 b(can)g(gi)n(v)o(e)g(a)h(Lisp)f(program)e(e)o(xactly)555
4025 y(the)i(de)o(gree)f(of)h(e)o(xtensibility)g(it)h(needs,)i(often)c
(without)h(resorting)f(to)h(object\255oriented)555 4129
y(techniques.)47 b(A)27 b(slot)h(in)e(a)h(class)h(is)g(a)f(global)e(v)n
(ariable.)48 b(And)26 b(just)h(as)h(it)f(is)h(inele)o(gant)c(to)555
4234 y(use)j(a)g(global)e(v)n(ariable)g(where)h(you)g(could)f(use)i(a)g
(parameter)m(,)f(it)h(could)e(be)i(inele)o(gant)d(to)555
4339 y(b)n(uild)17 b(a)i(w)o(orld)e(of)g(classes)i(and)f(instances)f
(when)g(you)g(could)g(do)h(the)f(same)h(thing)f(with)h(less)555
4443 y(ef)n(fort)26 b(in)h(plain)f(Lisp.)50 b(W)m(ith)27
b(the)g(addition)e(of)i Fr(CLOS)p FA(,)h(Common)e(Lisp)h(has)g(become)f
(the)555 4548 y(most)f(po)n(werful)e(object\255oriented)g(language)g
(in)i(widespread)f(use.)44 b(Ironically)-5 b(,)24 b(it)h(is)h(also)555
4652 y(the)20 b(language)f(in)h(which)g(object\255oriented)d
(programming)g(is)k(least)g(necessary)-5 b(.)p eop
%%Page: 380 393
380 392 bop 555 538 a FA(380)877 b Fu(OBJECT)-5 b Fv(\255)p
Fu(ORIENTED)16 b(LISP)p eop
%%Page: 381 394
381 393 bop 555 1907 2686 3 v 555 2125 a Fx(A)l(ppendix:)61
b(P)n(ackages)555 2562 y FA(P)o(ackages)19 b(are)h(Common)f(Lisp')-5
b(s)21 b(w)o(ay)f(of)f(grouping)f(code)h(into)h(modules.)28
b(Early)19 b(dialects)555 2666 y(of)24 b(Lisp)h(contained)e(a)i
(symbol\255table,)f(called)h(the)f Ft(oblist)p FA(,)i(which)e(listed)h
(all)h(the)e(symbols)555 2771 y(read)19 b(so)g(f)o(ar)g(by)g(the)g
(system.)29 b(Through)17 b(a)i(symbol')-5 b(s)19 b(entry)f(on)h(the)g
(oblist,)h(the)f(system)g(had)555 2875 y(access)25 b(to)f(things)g(lik)
o(e)g(its)i(v)n(alue)d(and)h(its)h(property)d(list.)42
b(A)25 b(symbol)e(listed)i(in)f(the)g(oblist)555 2980
y(w)o(as)d(said)g(to)f(be)g Ft(interned.)680 3085 y FA(Recent)36
b(dialects)g(of)g(Lisp)h(ha)n(v)o(e)e(split)i(the)g(concept)e(of)h(the)
g(oblist)g(into)g(multiple)555 3189 y Ft(pac)n(ka)o(g)o(es.)66
b FA(No)n(w)33 b(a)g(symbol)f(is)h(not)g(merely)e(interned,)k(b)n(ut)d
(interned)g(in)h(a)g(particular)555 3294 y(package.)d(P)o(ackages)20
b(support)f(modularity)g(because)h(symbols)g(interned)g(in)h(one)f
(package)555 3398 y(are)26 b(only)f(accessible)h(in)g(other)g(packages)
e(\(e)o(xcept)h(by)h(cheating\))e(if)i(the)o(y)g(are)g(e)o(xplicitly)
555 3503 y(declared)19 b(to)h(be)g(so.)680 3608 y(A)30
b(package)e(is)j(a)g(kind)e(of)g(Lisp)h(object.)58 b(The)30
b(current)e(package)h(is)i(al)o(w)o(ays)f(stored)555
3712 y(in)g(the)f(global)g(v)n(ariable)g Fs(*package*)p
FA(.)54 b(When)29 b(Common)g(Lisp)g(starts)i(up,)g(the)f(current)555
3817 y(package)d(will)j(be)f(the)f(user)h(package:)45
b(either)28 b Fs(user)g FA(\(in)h Fr(CL)-6 b(TL)p FA(1)27
b(implementations\),)i(or)555 3921 y Fs(common-lisp-user)14
b FA(\(in)20 b Fr(CL)-6 b(TL)p FA(2)19 b(implementations\).)680
4026 y(P)o(ackages)h(are)g(usually)h(identi\002ed)f(by)g(their)h
(names,)f(which)g(are)h(strings.)31 b(T)-7 b(o)21 b(\002nd)g(the)555
4131 y(name)f(of)f(the)i(current)e(package,)f(try:)555
4292 y Fs(>)43 b(\(package-name)38 b(*package*\))555
4392 y("COMMON-LISP-USE)o(R")680 4553 y FA(Usually)c(a)h(symbol)f(is)i
(interned)d(in)i(the)g(package)e(that)i(w)o(as)g(current)e(at)j(the)e
(time)555 4652 y(it)g(w)o(as)f(read.)67 b(T)-7 b(o)33
b(\002nd)f(the)h(package)f(in)h(which)f(a)h(symbol)f(is)i(interned,)g
(we)g(can)e(use)555 4752 y Fs(symbol-package)p FA(:)555
4901 y Fs(>)43 b(\(symbol-package)38 b('foo\))555 5001
y(#<Package)i("COMMON-LISP-USE)o(R")d(4CD15E>)1835 5229
y FA(381)p eop
%%Page: 382 395
382 394 bop 555 538 a FA(382)1069 b Fu(APPENDIX)555 801
y FA(The)22 b(return)f(v)n(alue)h(here)f(is)j(the)e(actual)g(package)f
(object.)35 b(F)o(or)22 b(future)f(use,)i(let')-5 b(s)23
b(gi)n(v)o(e)e Fs(foo)555 905 y FA(a)g(v)n(alue:)555
1088 y Fs(>)43 b(\(setq)f(foo)g(99\))555 1188 y(99)680
1375 y FA(By)d(calling)f Fs(in-package)e FA(we)j(can)g(switch)g(to)g(a)
g(ne)n(w)g(package,)j(creating)c(it)h(if)555 1480 y(necessary:)902
1450 y Fm(1)555 1662 y Fs(>)k(\(in-package)c('mine)j(:use)g
('common-lisp\))555 1762 y(#<Package)e("MINE")h(63390E>)555
1950 y FA(At)17 b(this)h(point)e(there)g(should)g(be)h(eerie)f(music,)i
(because)e(we)h(are)g(in)g(a)g(dif)n(ferent)e(w)o(orld:)27
b Fs(foo)555 2054 y FA(here)20 b(is)h(not)f(what)g(it)h(used)f(to)g
(be.)555 2237 y Fs(MINE>)42 b(foo)555 2337 y(>>Error:)e(FOO)j(has)f(no)
h(global)e(value.)555 2524 y FA(Why)24 b(did)g(this)h(happen?)41
b(Because)25 b(the)f Fs(foo)g FA(we)h(set)h(to)e Fs(99)h
FA(abo)o(v)o(e)d(is)k(a)f(distinct)g(symbol)555 2629
y(from)13 b Fs(foo)f FA(here)i(in)f Fs(mine)p FA(.)1308
2599 y Fm(2)1367 2629 y FA(T)-7 b(o)14 b(refer)f(to)h(the)f(original)g
Fs(foo)g FA(from)f(outside)h(the)h(user)f(package,)555
2733 y(we)21 b(must)f(pre\002x)f(the)h(package)f(name)h(and)f(tw)o(o)i
(colons:)555 2916 y Fs(MINE>)42 b(common-lisp-use)o(r:)o(:fo)o(o)555
3016 y(99)680 3203 y FA(So)22 b(dif)n(ferent)e(symbols)h(with)h(the)g
(same)g(print\255name)d(can)j(coe)o(xist)f(in)h(dif)n(ferent)f
(pack\255)555 3308 y(ages.)34 b(There)21 b(can)h(be)f(one)h
Fs(foo)f FA(in)h(package)e Fs(common-lisp-user)c FA(and)21
b(another)f Fs(foo)h FA(in)555 3413 y(package)c Fs(mine)p
FA(,)h(and)g(the)o(y)f(will)j(be)e(distinct)h(symbols.)28
b(In)18 b(f)o(act,)h(that')-5 b(s)19 b(partly)f(the)g(point)g(of)555
3517 y(packages:)32 b(if)23 b(you')l(re)d(writing)i(your)f(program)f
(in)i(a)h(separate)e(package,)g(you)g(can)h(choose)555
3622 y(names)j(for)f(your)g(functions)f(and)i(v)n(ariables)f(without)g
(w)o(orrying)f(that)i(someone)f(will)h(use)555 3726 y(the)f(same)f
(name)g(for)g(something)g(else.)40 b(Ev)o(en)22 b(if)i(the)o(y)f(use)h
(the)f(same)h(name,)g(it)g(w)o(on')o(t)f(be)555 3831
y(the)d(same)h(symbol.)680 3936 y(P)o(ackages)c(also)h(pro)o(vide)e(a)i
(means)f(of)h(information\255hiding.)24 b(Programs)16
b(must)i(refer)f(to)555 4040 y(functions)h(and)g(v)n(ariables)g(by)h
(their)f(names.)29 b(If)19 b(you)f(don')o(t)f(mak)o(e)i(a)g(gi)n(v)o
(en)f(name)g(a)n(v)n(ailable)555 4145 y(outside)25 b(your)g(package,)g
(it)i(becomes)e(unlik)o(ely)f(that)i(code)f(in)h(another)f(package)f
(will)j(be)555 4249 y(able)20 b(to)g(use)h(or)f(modify)e(what)j(it)f
(refers)g(to.)680 4354 y(In)f(programs)e(it')-5 b(s)21
b(usually)e(bad)f(style)i(to)g(use)f(package)f(pre\002x)o(es)h(with)h
(double)d(colons.)555 4459 y(By)36 b(doing)e(so)i(you)f(are)h
(violating)e(the)i(modularity)d(that)j(packages)f(are)g(supposed)f(to)
555 4563 y(pro)o(vide.)59 b(If)31 b(you)e(ha)n(v)o(e)i(to)g(use)g(a)g
(double)e(colon)h(to)h(refer)f(to)h(a)g(symbol,)h(it')-5
b(s)32 b(because)555 4668 y(someone)19 b(didn')o(t)g(w)o(ant)h(you)f
(to.)p 555 4739 1074 4 v 645 4795 a Fl(1)675 4819 y Fr(In)d(older)j
(implementations)h(of)d(Common)g(Lisp,)f(omit)i(the)f
Fk(:use)h Fr(ar)o(gument.)645 4877 y Fl(2)675 4900 y
Fr(Some)27 b(implementations)k(of)d(Common)g(Lisp)f(print)i(the)g
(package)h(name)e(before)h(the)f(tople)n(v)o(el)j(prompt)555
4983 y(whene)n(v)o(er)19 b(we)e(are)h(not)f(in)h(the)f(user)h(package.)
26 b(This)17 b(is)f(not)i(required,)g(b)o(ut)g(it)f(is)g(a)g(nice)h
(touch.)p eop
%%Page: 383 396
383 395 bop 1745 538 a Fu(P)-5 b(A)n(CKA)n(GES)1064 b
FA(383)680 801 y(Usually)32 b(one)f(should)h(only)f(refer)h(to)g
(symbols)g(which)g(ha)n(v)o(e)g(been)f Ft(e)n(xported.)65
b FA(By)555 905 y(e)o(xporting)25 b(a)j(symbol)e(from)g(the)h(package)f
(in)i(which)f(it)h(is)g(interned,)f(we)h(cause)f(it)h(to)g(be)555
1010 y(visible)20 b(to)h(other)e(packages.)28 b(T)-7
b(o)20 b(e)o(xport)f(a)h(symbol)g(we)g(call)h(\(you)e(guessed)g(it\))i
Fs(export)p FA(:)555 1191 y Fs(MINE>)42 b(\(in-package)d
('common-lisp-us)o(er\))555 1291 y(#<Package)h("COMMON-LISP-USE)o(R")d
(4CD15E>)555 1390 y(>)43 b(\(export)e('bar\))555 1490
y(T)555 1589 y(>)i(\(setq)f(bar)g(5\))555 1689 y(5)555
1875 y FA(No)n(w)32 b(when)f(we)i(return)d(to)j Fs(mine)p
FA(,)g(we)g(can)e(refer)h(to)g Fs(bar)f FA(with)h(only)f(a)i(single)f
(colon,)555 1980 y(because)20 b(it)g(is)i(a)e(publicly)f(a)n(v)n
(ailable)h(name:)555 2161 y Fs(>)43 b(\(in-package)c('mine\))555
2260 y(#<Package)h("MINE")h(63390E>)555 2360 y(MINE>)h(common-lisp-use)
o(r:)o(bar)555 2460 y(5)555 2646 y FA(By)21 b Ft(importing)f
Fs(bar)g FA(into)h Fs(mine)e FA(we)i(can)g(go)f(one)g(step)h(further)m
(,)e(and)h(mak)o(e)h Fs(mine)e FA(actually)555 2750 y(share)h(the)g
(symbol)f Fs(bar)h FA(with)g(the)g(user)h(package:)555
2931 y Fs(MINE>)42 b(\(import)e('common-lisp-user)o(:b)o(ar\))555
3031 y(T)555 3131 y(MINE>)i(bar)555 3230 y(5)555 3416
y FA(After)24 b(importing)e Fs(bar)h FA(we)h(can)g(refer)f(to)h(it)g
(without)f(an)o(y)g(package)g(quali\002er)g(at)h(all.)41
b(The)555 3521 y(tw)o(o)20 b(packages)f(no)n(w)h(share)g(the)g(same)h
(symbol;)e(there)h(can')o(t)f(be)h(a)h(distinct)f Fs(mine:bar)p
FA(.)680 3626 y(What)k(if)h(there)f(already)g(w)o(as)h(one?)41
b(In)25 b(that)f(case,)i(the)e(call)h(to)g Fs(import)d
FA(w)o(ould)i(ha)n(v)o(e)555 3730 y(caused)c(an)g(error)m(,)e(as)j(we)g
(see)g(if)f(we)h(try)f(to)g(import)f Fs(foo)p FA(:)555
3911 y Fs(MINE>)42 b(\(import)e('common-lisp-user)o(::)o(foo)o(\))555
4011 y(>>Error:)g(FOO)j(is)f(already)f(present)g(in)i(MINE.)555
4197 y FA(Before,)18 b(when)f(we)h(tried)f(unsuccessfully)g(to)h(e)n(v)
n(aluate)e Fs(foo)i FA(in)g Fs(mine)p FA(,)f(we)h(thereby)e(caused)555
4302 y(a)k(symbol)e Fs(foo)h FA(to)h(be)f(interned)f(there.)29
b(It)19 b(had)g(no)g(global)g(v)n(alue)g(and)g(therefore)e(generated)
555 4406 y(an)k(error)m(,)g(b)n(ut)g(the)h(interning)e(happened)f
(simply)i(as)h(a)g(consequence)d(of)j(typing)e(its)i(name.)555
4511 y(So)c(no)n(w)e(when)h(we)h(try)f(to)g(import)f
Fs(foo)h FA(into)g Fs(mine)p FA(,)f(there)h(is)h(already)f(a)g(symbol)g
(there)f(with)555 4615 y(the)k(same)h(name.)680 4720
y(W)-7 b(e)18 b(can)f(also)g(import)f(symbols)g Ft(en)h(masse)h
FA(by)f(de\002ning)e(one)i(package)e(to)j Ft(use)f FA(another:)555
4901 y Fs(MINE>)42 b(\(use-package)c('common-lisp-user)o(\))555
5001 y(T)p eop
%%Page: 384 397
384 396 bop 555 538 a FA(384)1069 b Fu(APPENDIX)555 801
y FA(No)n(w)19 b(all)h(symbols)f(e)o(xported)e(by)i(the)h(user)f
(package)f(will)i(automatically)e(be)h(imported)f(by)555
905 y Fs(mine)p FA(.)39 b(\(If)24 b Fs(foo)f FA(had)g(been)h(e)o
(xported)d(by)j(the)g(user)g(package,)f(this)h(call)h(w)o(ould)e(also)h
(ha)n(v)o(e)555 1010 y(generated)18 b(an)j(error)-5 b(.\))680
1114 y(As)36 b(of)f Fr(CL)-6 b(TL)p FA(2,)38 b(the)d(package)f
(containing)f(the)j(names)f(of)g(b)n(uilt\255in)f(operators)g(and)555
1219 y(v)n(ariables)26 b(is)h(called)f Fs(common-lisp)d
FA(instead)j(of)g Fs(lisp)p FA(,)h(and)f(ne)n(w)g(packages)g(no)g
(longer)555 1324 y(use)e(it)h(by)e(def)o(ault.)40 b(Since)24
b(we)g Fs(use)p FA(d)f(this)i(package)d(in)i(the)g(call)h(to)f
Fs(in-package)c FA(which)555 1428 y(created)f Fs(mine)p
FA(,)g(all)i(of)f(Common)f(Lisp')-5 b(s)21 b(names)e(will)i(be)g
(visible)f(here:)555 1611 y Fs(MINE>)42 b(#'cons)555
1711 y(#<Compiled-Funct)o(ion)37 b(CONS)42 b(462A3E>)555
1898 y FA(Y)-9 b(ou')l(re)29 b(practically)g(compelled)g(to)i(mak)o(e)e
(an)o(y)h(ne)n(w)g(package)f(use)i Fs(common-lisp)26
b FA(\(or)555 2003 y(some)20 b(other)f(package)g(containing)f(Lisp)j
(operators\).)27 b(Otherwise)20 b(you)f(w)o(ouldn')o(t)f(e)n(v)o(en)i
(be)555 2107 y(able)g(to)g(get)h(out)e(of)h(the)h(ne)n(w)f(package.)680
2212 y(As)36 b(with)f(compilation,)j(operations)c(on)h(packages)f(are)h
(not)g(usually)g(done)g(at)h(the)555 2317 y(tople)n(v)o(el)25
b(lik)o(e)h(this.)47 b(More)25 b(often)h(the)g(calls)g(are)g(contained)
f(in)h(source)f(\002les.)48 b(Generally)555 2421 y(it)33
b(will)h(suf)n(\002ce)f(to)g(be)o(gin)e(a)i(\002le)h(with)f(an)f
Fs(in-package)e FA(and)i(a)h Fs(defpackage)p FA(.)63
b(\(The)555 2526 y Fs(defpackage)15 b FA(macro)j(is)i(ne)n(w)e(in)h
Fr(CL)-6 b(TL)p FA(2,)18 b(b)n(ut)h(some)f(older)g(implementations)f
(pro)o(vide)f(it.\))555 2630 y(Here)26 b(is)h(what)g(you)e(might)h(put)
g(at)h(the)f(top)g(of)g(a)h(\002le)g(containing)d(a)j(distinct)f
(package)f(of)555 2735 y(code:)555 2918 y Fs(\(in-package)39
b('my-application)e(:use)42 b('common-lisp\))555 3117
y(\(defpackage)d(my-application)1078 3217 y(\(:use)j(common-lisp)d
(my-utilities\))1078 3316 y(\(:nicknames)g(app\))1078
3416 y(\(:export)h(win)j(lose)f(draw\)\))555 3603 y FA(This)23
b(will)g(cause)f(the)h(code)e(in)i(the)f(\002le\227or)h(more)e
(precisely)-5 b(,)22 b(the)g(names)g(in)h(the)f(\002le\227to)555
3708 y(be)16 b(in)h(the)f(package)f Fs(my-application)p
FA(.)23 b(As)17 b(well)f(as)h Fs(common-lisp)p FA(,)c(this)k(package)e
(uses)555 3813 y Fs(my-utilities)p FA(,)f(so)k(an)o(y)f(symbols)g(e)o
(xported)f(thence)h(can)h(appear)f(without)g(an)o(y)g(package)555
3917 y(pre\002x)i(in)i(the)f(\002le.)680 4022 y(The)h
Fs(my-application)16 b FA(package)j(itself)j(e)o(xports)e(just)i(three)
f(symbols:)31 b Fs(win)p FA(,)21 b Fs(lose)p FA(,)555
4127 y(and)k Fs(draw)p FA(.)42 b(Since)26 b(the)f(call)g(to)h
Fs(in-package)21 b FA(ga)n(v)o(e)j Fs(my-application)c
FA(the)25 b(nickname)555 4231 y Fs(app)p FA(,)19 b(code)h(in)g(other)f
(packages)h(will)g(be)h(able)f(to)g(refer)f(to)i(them)f(as)g(e.g.)g
Fs(app:win)p FA(.)680 4336 y(The)i(kind)g(of)h(modularity)d(pro)o
(vided)h(by)h(packages)g(is)h(actually)g(a)g(bit)g(odd.)36
b(W)-7 b(e)24 b(ha)n(v)o(e)555 4440 y(modules)k(not)g(of)g(objects,)j
(b)n(ut)d(of)h(names.)54 b(Ev)o(ery)27 b(package)h(that)g(uses)i
Fs(common-lisp)555 4545 y FA(imports)j(the)i(name)e Fs(cons)p
FA(,)j(because)e Fs(common-lisp)c FA(includes)j(a)i(function)d(with)i
(that)555 4650 y(name.)55 b(But)29 b(in)g(consequence)e(a)i(v)n
(ariable)f(called)g Fs(cons)g FA(w)o(ould)g(also)h(be)g(visible)g(e)n
(v)o(ery)555 4754 y(package)23 b(that)h(used)g Fs(common-lisp)p
FA(.)37 b(And)24 b(the)g(same)g(thing)g(goes)g(for)f(Common)g(Lisp')-5
b(s)555 4859 y(other)14 b(name\255spaces.)27 b(If)15
b(packages)f(are)h(confusing,)f(this)i(is)g(the)g(main)f(reason)f(why;)
i(the)o(y')l(re)555 4963 y(not)k(based)g(on)f(objects,)h(b)n(ut)g(on)g
(names.)p eop
%%Page: 385 398
385 397 bop 1745 538 a Fu(P)-5 b(A)n(CKA)n(GES)1064 b
FA(385)680 801 y(Things)21 b(ha)n(ving)g(to)i(do)f(with)g(packages)f
(tend)h(to)g(happen)f(at)i(read\255time,)e(not)h(runtime,)555
905 y(which)e(can)g(lead)g(to)g(some)g(confusion.)27
b(The)20 b(second)f(e)o(xpression)g(we)i(typed:)555 1076
y Fs(\(symbol-package)37 b('foo\))555 1252 y FA(returned)13
b(the)i(v)n(alue)f(it)h(did)g(because)f Ft(r)m(eading)f(the)i(query)f
(cr)m(eated)g(the)h(answer)-9 b(.)28 b FA(T)-7 b(o)15
b(e)n(v)n(aluate)555 1357 y(this)21 b(e)o(xpression,)d(Lisp)i(had)g(to)
g(read)g(it,)h(which)e(meant)h(interning)f Fs(foo)p FA(.)680
1462 y(As)i(another)d(e)o(xample,)h(consider)g(this)i(e)o(xchange,)c
(which)j(appeared)e(abo)o(v)o(e:)555 1633 y Fs(MINE>)42
b(\(in-package)d('common-lisp-us)o(er\))555 1732 y(#<Package)h
("COMMON-LISP-USE)o(R")d(4CD15E>)555 1832 y(>)43 b(\(export)e('bar\))
555 2008 y FA(Usually)27 b(tw)o(o)h(e)o(xpressions)e(typed)g(into)h
(the)g(tople)n(v)o(el)f(are)i(equi)n(v)n(alent)d(to)j(the)f(same)g(tw)o
(o)555 2113 y(e)o(xpressions)19 b(enclosed)g(within)h(a)h(single)f
Fs(progn)p FA(.)27 b(Not)21 b(in)f(this)h(case.)29 b(If)20
b(we)h(try)f(saying)555 2284 y Fs(MINE>)42 b(\(progn)f(\(in-package)e
('common-lisp-us)o(er\))1122 2383 y(\(export)h('bar\)\))555
2483 y(>>Error:)g(MINE::BAR)g(is)j(not)f(accessible)e(in)i
(COMMON-LISP-USER.)555 2659 y FA(we)29 b(get)g(an)f(error)g(instead.)54
b(This)29 b(happens)f(because)g(the)g(whole)g Fs(progn)g
FA(e)o(xpression)f(is)555 2764 y(processed)j(by)h Fs(read)f
FA(before)g(being)h(e)n(v)n(aluated.)61 b(When)31 b Fs(read)f
FA(is)j(called,)h(the)d(current)555 2868 y(package)c(is)i
Fs(mine)p FA(,)g(so)f Fs(bar)g FA(is)h(tak)o(en)f(to)g(be)g
Fs(mine:bar)p FA(.)50 b(It)29 b(is)g(as)g(if)f(we)h(had)e(ask)o(ed)h
(to)555 2973 y(e)o(xport)19 b(this)h(symbol,)f(instead)h(of)g
Fs(common-lisp-user:)o(ba)o(r)p FA(,)14 b(from)20 b(the)g(user)g
(package.)680 3078 y(The)k(w)o(ay)h(packages)f(are)h(de\002ned)f(mak)o
(es)h(it)h(a)f(nuisance)f(to)i(write)f(programs)e(which)555
3182 y(use)d(symbols)g(as)h(data.)29 b(F)o(or)20 b(e)o(xample,)e(if)j
(we)f(de\002ne)g Fs(noise)f FA(as)i(follo)n(ws:)555 3353
y Fs(\(in-package)39 b('other)i(:use)h('common-lisp\))555
3453 y(\(defpackage)d(other)1078 3553 y(\(:use)j(common-lisp\))1078
3652 y(\(:export)e(noise\)\))555 3851 y(\(defun)h(noise)h(\(animal\))
642 3951 y(\(case)g(animal)729 4051 y(\(dog)g('woof\))729
4150 y(\(cat)g('meow\))729 4250 y(\(pig)g('oink\)\)\))555
4426 y FA(then)28 b(if)i(we)f(call)g Fs(noise)f FA(from)f(another)h
(package)f(with)i(an)g(unquali\002ed)e(symbol)h(as)i(an)555
4531 y(ar)o(gument,)18 b(it)j(will)f(usually)g(f)o(all)h(of)n(f)e(the)h
(end)g(of)g(the)g Fs(case)f FA(clauses)i(and)e(return)g
Fs(nil)p FA(:)555 4702 y Fs(OTHER>)41 b(\(in-package)e
('common-lisp-user)o(\))555 4801 y(#<Package)h("COMMON-LISP-USE)o(R")d
(4CD15E>)555 4901 y(>)43 b(\(other:noise)c('pig\))555
5001 y(NIL)p eop
%%Page: 386 399
386 398 bop 555 538 a FA(386)1069 b Fu(APPENDIX)555 801
y FA(That')-5 b(s)16 b(because)f(what)h(we)g(passed)g(as)h(an)f(ar)o
(gument)d(w)o(as)k Fs(common-lisp-user:)o(pi)o(g)10 b
FA(\(no)555 905 y(of)n(fense)25 b(intended\),)g(while)h(the)g
Fs(case)f FA(k)o(e)o(y)g(is)i Fs(other:pig)p FA(.)43
b(T)-7 b(o)27 b(mak)o(e)e Fs(noise)g FA(w)o(ork)g(as)555
1010 y(one)h(w)o(ould)g(e)o(xpect,)g(we)h(w)o(ould)f(ha)n(v)o(e)g(to)h
(e)o(xport)d(all)j(six)g(symbols)f(used)g(within)h(it,)h(and)555
1114 y(import)19 b(them)h(into)g(an)o(y)f(package)g(from)g(which)h(we)g
(intended)f(to)h(call)h Fs(noise)p FA(.)680 1219 y(In)13
b(this)i(case,)g(we)g(could)e(e)n(v)n(ade)g(the)h(problem)e(by)h(using)
h(k)o(e)o(yw)o(ords)e(instead)i(of)g(ordinary)555 1324
y(symbols.)29 b(If)20 b Fs(noise)e FA(had)i(been)f(de\002ned)555
1506 y Fs(\(defun)41 b(noise)h(\(animal\))642 1606 y(\(case)g(animal)
729 1706 y(\(:dog)g(:woof\))729 1805 y(\(:cat)g(:meow\))729
1905 y(\(:pig)g(:oink\)\)\))555 2092 y FA(then)20 b(we)g(could)g
(safely)g(call)g(it)h(from)e(an)o(y)h(package:)555 2275
y Fs(OTHER>)41 b(\(in-package)e('common-lisp-user)o(\))555
2375 y(#<Package)h("COMMON-LISP-USE)o(R")d(4CD15E>)555
2474 y(>)43 b(\(other:noise)c(:pig\))555 2574 y(:OINK)555
2762 y FA(K)n(e)o(yw)o(ords)26 b(are)h(lik)o(e)h(gold:)43
b(uni)n(v)o(ersal)26 b(and)h(self\255e)n(v)n(aluating.)49
b(The)o(y)26 b(are)i(visible)f(e)n(v)o(ery\255)555 2866
y(where,)14 b(and)f(the)o(y)g(ne)n(v)o(er)f(ha)n(v)o(e)h(to)h(be)g
(quoted.)25 b(A)14 b(symbol\255dri)n(v)o(en)d(function)g(lik)o(e)j
Fs(defanaph)555 2971 y FA(\(page)19 b(223\))g(should)g(nearly)g(al)o(w)
o(ays)i(be)f(written)g(to)h(use)f(k)o(e)o(yw)o(ords.)680
3075 y(P)o(ackages)h(are)h(a)h(rich)e(source)h(of)g(confusion.)33
b(This)22 b(introduction)e(to)i(the)g(subject)g(has)555
3180 y(barely)d(scratched)g(the)i(surf)o(ace.)28 b(F)o(or)20
b(all)h(the)f(details,)g(see)h Fr(CL)-6 b(TL)p FA(2,)19
b(Chapter)h(11.)p eop
%%Page: 387 400
387 399 bop 555 1897 2686 3 v 555 2104 a Fx(Notes)555
2528 y Fv(This)17 b(section)g(is)g(also)h(intended)g(as)f(a)g
(bibliography)-5 b(.)28 b(All)17 b(the)g(books)h(and)g(papers)g(listed)
f(here)h(should)555 2619 y(be)h(considered)i(recommended)g(reading.)684
2830 y(v)42 b(F)o(oderaro,)14 b(John)g(K.)25 b(Introduction)14
b(to)f(the)g(Special)g(Lisp)g(Section.)25 b Fa(CA)n(CM)12
b Fv(34,)i(9)g(\(September)763 2921 y(1991\),)19 b(p.)g(27.)621
3041 y(viii)42 b(The)16 b(\002nal)g(Prolog)g(implementation)h(is)f(94)h
(lines)f(of)g(code.)27 b(It)16 b(uses)g(90)h(lines)f(of)g(utilities)g
(from)763 3132 y(pre)n(vious)23 b(chapters.)38 b(The)22
b Fu(A)-7 b(TN)22 b Fv(compiler)h(adds)g(33)g(lines,)g(for)f(a)g(total)
g(of)g(217.)38 b(Since)22 b(Lisp)763 3224 y(has)d(no)g(formal)g(notion)
h(of)f(a)g(line,)f(there)h(is)g(a)g(lar)o(ge)f(mar)o(gin)h(for)g(error)
g(when)h(measuring)g(the)763 3315 y(length)f(of)g(a)g(Lisp)f(program)i
(in)f(lines.)663 3434 y(ix)42 b(Steele,)13 b(Guy)h(L.,)f(Jr)l(.)25
b Fa(Common)14 b(Lisp:)f(the)g(Langua)o(g)o(e)o(,)k Fv(2nd)d(Edition.)
25 b(Digital)12 b(Press,)i(Bedford)763 3526 y(\(MA\),)k(1990.)684
3645 y(5)42 b(Brooks,)22 b(Frederick)f(P.)34 b Fa(The)21
b(Mythical)h(Man\255Month.)35 b Fv(Addison\255W)-6 b(esle)o(y)h(,)23
b(Reading)f(\(MA\),)763 3736 y(1975,)d(p.)g(16.)646 3856
y(18)43 b(Abelson,)33 b(Harold,)h(and)d(Gerald)f(Jay)h(Sussman,)j(with)
c(Julie)g(Sussman.)62 b Fa(Structur)m(e)32 b(and)763
3947 y(Interpr)m(etation)20 b(of)f(Computer)g(Pr)m(o)o(gr)o(ams.)27
b Fv(MIT)19 b(Press,)f(Cambridge,)i(1985.)646 4066 y(21)43
b(More)11 b(precisely)-5 b(,)14 b(we)d(cannot)g(de\002ne)g(a)g(recursi)
n(v)o(e)g(function)g(with)g(a)g(single)g(lamb)q(da\255e)o(x)q(pression)
q(.)763 4158 y(W)-6 b(e)21 b(can,)i(ho)n(we)n(v)o(er)m(,)g(generate)g
(a)f(recursi)n(v)o(e)g(function)h(by)f(writing)g(a)g(function)g(to)g
(tak)o(e)h Fa(itself)763 4249 y Fv(as)18 b(an)i(additional)f(ar)o
(gument,)763 4397 y Fo(\(setq)40 b(fact)998 4488 y(#'\(lambda)h(\(f)f
(n\))1155 4579 y(\(if)g(\(=)f(n)h(0\))1312 4671 y(1)1312
4762 y(\(*)f(n)h(\(funcall)h(f)e(f)h(\(-)g(n)f(1\)\)\)\)\)\))763
4909 y Fv(and)18 b(then)f(passing)i(it)d(to)i(a)f(function)h(that)f
(will)g(return)g(a)g(closure)h(in)g(which)f(original)h(function)763
5001 y(is)g(called)h(on)h(itself:)1835 5229 y FA(387)p
eop
%%Page: 388 401
388 400 bop 555 538 a FA(388)1121 b Fu(NO)n(TES)763 801
y Fo(\(defun)40 b(recurser)h(\(fn\))841 892 y(#'\(lambda)g(\(&rest)g
(args\))998 983 y(\(apply)g(fn)e(fn)h(args\)\)\))763
1140 y Fv(P)o(assing)18 b Fo(fact)i Fv(to)f(this)g(function)g(yields)g
(a)g(re)o(gular)g(f)o(actorial)g(function,)763 1297 y
Fo(>)39 b(\(funcall)i(\(recurser)g(fact\))g(8\))763 1388
y(40320)763 1545 y Fv(which)19 b(could)h(ha)o(v)o(e)f(been)g(e)o
(xpressed)i(directly)e(as:)763 1702 y Fo(\(\(lambda)41
b(\(f\))f(#'\(lambda)h(\(n\))f(\(funcall)h(f)e(f)h(n\)\)\))802
1793 y(#'\(lambda)h(\(f)f(n\))959 1884 y(\(if)g(\(=)f(n)h(0\))1116
1976 y(1)1116 2067 y(\(*)f(n)h(\(funcall)h(f)e(f)h(\(-)f(n)h
(1\)\)\)\)\)\))763 2224 y Fv(Man)o(y)19 b(Common)h(Lisp)f(users)g(will)
f(\002nd)h Fo(labels)h Fv(or)f Fo(alambda)h Fv(more)f(con)m(v)o
(enient.)646 2348 y(23)43 b(Gabriel,)29 b(Richard)f(P.)52
b(Performance)28 b(and)g(Standardization.)54 b Fa(Pr)m(oceedings)29
b(of)e(the)h(F)m(ir)o(st)763 2439 y(International)20
b(W)-7 b(orkshop)20 b(on)g(Lisp)e(Evolution)h(and)h(Standar)m
(dization,)h Fv(1988,)f(p.)f(60.)763 2547 y(T)-5 b(esting)27
b Fo(triangle)j Fv(in)d(one)i(implementation,)h(Gabriel)e(found)h(that)
f(\223e)n(v)o(en)h(when)f(the)g(C)763 2638 y(compiler)21
b(is)g(pro)o(vided)i(with)e(hand\255generated)j(re)o(gister)d
(allocation)g(information,)i(the)e(Lisp)763 2730 y(code)e(is)f(17\045)h
(f)o(aster)g(than)g(an)g(iterati)n(v)o(e)f(C)g(v)o(ersion)h(of)g(this)f
(function.)-5 b(\224)28 b(His)18 b(paper)h(mentions)763
2821 y(se)n(v)o(eral)k(other)h(programs)h(which)f(ran)f(f)o(aster)h(in)
f(Lisp)g(than)h(in)g(C,)e(including)j(one)f(that)g(w)o(as)763
2912 y(42\045)19 b(f)o(aster)l(.)646 3036 y(24)43 b(If)19
b(you)i(w)o(anted)g(to)e(compile)i(all)e(the)h(named)h(functions)g
(currently)g(loaded,)f(you)h(could)g(do)f(it)763 3128
y(by)f(calling)g Fo(compall)p Fv(:)763 3268 y Fo(\(defun)40
b(compall)h(\(\))841 3359 y(\(do-symbols)h(\(s\))919
3451 y(\(when)f(\(fboundp)g(s\))998 3542 y(\(unless)g
(\(compiled-function-p)j(\(symbol-function)e(s\)\))1076
3633 y(\(print)f(s\))1076 3725 y(\(compile)g(s\)\)\)\)\))763
3865 y Fv(This)18 b(function)i(also)f(prints)g(the)g(name)g(of)g(each)h
(function)f(as)g(it)g(is)f(compiled.)646 3989 y(26)43
b(Y)-8 b(ou)23 b(may)g(be)g(able)g(to)f(see)h(whether)g
Fo(inline)h Fv(declarations)g(are)f(being)g(obe)o(yed)h(by)g(calling)
763 4081 y Fo(\(disassemble)42 b('foo\))p Fv(,)24 b(which)f(displays)h
(some)f(representation)h(of)f(the)g(object)g(code)h(of)763
4172 y(function)d Fo(foo)p Fv(.)33 b(This)20 b(is)h(also)g(one)g(w)o
(ay)g(to)g(check)h(whether)f(tail\255recursion)g(optimization)g(is)763
4263 y(being)e(done.)646 4387 y(31)43 b(One)19 b(could)g(imagine)h
Fo(nreverse)g Fv(de\002ned)g(as:)763 4544 y Fo(\(defun)40
b(our-nreverse)i(\(lst\))841 4635 y(\(if)e(\(null)g(\(cdr)g(lst\)\))998
4727 y(lst)998 4818 y(\(prog1)h(\(nr2)f(lst\))1273 4909
y(\(setf)g(\(cdr)g(lst\))g(nil\)\)\)\))p eop
%%Page: 389 402
389 401 bop 1802 538 a Fu(NO)n(TES)1122 b FA(389)763
801 y Fo(\(defun)40 b(nr2)g(\(lst\))841 892 y(\(let)g(\(\(c)g(\(cdr)g
(lst\)\)\))919 983 y(\(prog1)h(\(if)f(\(null)g(\(cdr)g(c\)\))1351
1075 y(c)1351 1166 y(\(nr2)g(c\)\))1194 1257 y(\(setf)g(\(cdr)h(c\))e
(lst\)\)\)\))646 1383 y Fv(43)k(Good)21 b(design)g(al)o(w)o(ays)g(puts)
g(a)f(premium)h(on)g(economy)-5 b(,)22 b(b)o(ut)f(there)f(is)g(an)h
(additional)g(reason)763 1475 y(that)d(programs)h(should)g(be)g(dense.)
28 b(When)18 b(a)h(program)g(is)f(dense,)h(you)g(can)g(see)f(more)h(of)
f(it)g(at)763 1566 y(once.)763 1666 y(People)24 b(kno)n(w)h(intuiti)n
(v)o(ely)g(that)f(design)h(is)f(easier)h(when)g(one)g(has)g(a)f(broad)h
(vie)n(w)g(of)f(one')l(s)763 1757 y(w)o(ork.)51 b(This)26
b(is)h(why)g(easel)g(painters)g(use)g(long\255handled)i(brushes,)g(and)
f(often)f(step)g(back)763 1849 y(from)20 b(their)g(w)o(ork.)31
b(This)20 b(is)f(why)i(generals)g(position)f(themselv)o(es)h(on)g(high)
g(ground,)g(e)n(v)o(en)g(if)763 1940 y(the)o(y)g(are)f(thereby)i(e)o
(xposed)g(to)f(enemy)h(\002re.)31 b(And)22 b(it)e(is)g(why)h
(programmers)h(spend)g(a)e(lot)h(of)763 2031 y(mone)o(y)f(to)e(look)i
(at)e(their)h(programs)h(on)f(lar)o(ge)g(displays)h(instead)f(of)g
(small)g(ones.)763 2131 y(Dense)i(programs)h(mak)o(e)g(the)e(most)h(of)
g(one')l(s)h(\002eld)e(of)h(vision.)33 b(A)21 b(general)h(cannot)f
(shrink)h(a)763 2223 y(battle)i(to)g(\002t)f(on)i(a)f(table\255top,)h
(b)o(ut)f(Lisp)g(allo)n(ws)g(you)i(to)e(perform)g(corresponding)j
(feats)d(of)763 2314 y(abstraction)g(in)g(programs.)42
b(And)24 b(the)g(more)g(you)h(can)f(see)g(of)g(your)g(program)h(at)e
(once,)j(the)763 2405 y(more)19 b(lik)o(ely)g(it)f(is)h(to)f(turn)i
(out)f(as)g(a)f(uni\002ed)i(whole.)763 2505 y(This)h(is)g(not)g(to)h
(say)f(that)h(one)g(should)g(mak)o(e)g(one')l(s)g(programs)h(shorter)e
(at)h(an)o(y)f(cost.)35 b(If)21 b(you)763 2597 y(tak)o(e)h(all)g(the)g
(ne)n(wlines)h(out)g(of)f(a)g(function,)i(you)f(can)f(\002t)g(it)f(on)i
(one)g(line,)g(b)o(ut)f(this)g(does)h(not)763 2688 y(mak)o(e)i(it)e
(easier)i(to)f(read.)43 b(Dense)25 b(code)g(means)g(code)g(which)g(has)
f(been)h(made)g(smaller)f(by)763 2779 y(abstraction,)19
b(not)g(te)o(xt\255editing.)763 2879 y(Imagine)28 b(ho)n(w)g(hard)g(it)
f(w)o(ould)i(be)f(to)g(program)g(if)f(you)i(had)f(to)g(look)g(at)g
(your)g(code)h(on)f(a)763 2971 y(display)c(half)f(the)h(size)f(of)h
(the)f(one)i(you')l(re)f(used)g(to.)41 b(Making)25 b(your)f(code)g
(twice)f(as)h(dense)763 3062 y(will)18 b(mak)o(e)h(programming)i(that)d
(much)i(easier)l(.)646 3171 y(44)43 b(Steele,)22 b(Guy)h(L.,)f(Jr)l(.)
37 b(Deb)o(unking)24 b(the)e(\223Expensi)n(v)o(e)i(Procedure)f
(Call\224)f(Myth)h(or)m(,)g(Procedu\255)763 3262 y(ral)j(Call)h
(Implementations)h(Considered)g(Harmful)f(or)m(,)i(L)p
Fu(AMBD)n(A)p Fv(:)e(The)g(Ultimate)f(G)p Fu(O)n(T)o(O)p
Fv(.)763 3353 y Fa(Pr)m(oceedings)19 b(of)g(the)g(National)g(Confer)m
(ence)i(of)e(the)g(A)n(CM,)e Fv(1977,)j(p.)f(157.)646
3462 y(48)43 b(F)o(or)22 b(reference,)h(here)g(are)g(simpler)f
(de\002nitions)h(of)g(some)g(of)g(the)f(functions)i(in)e(Figures)h(4.2)
763 3553 y(and)c(4.3.)27 b(All)18 b(are)h(substantially)h(\(at)e(least)
h(10\045\))g(slo)n(wer:)763 3679 y Fo(\(defun)40 b(filter)h(\(fn)f
(lst\))841 3771 y(\(delete)h(nil)f(\(mapcar)h(fn)e(lst\)\)\))763
3953 y(\(defun)h(filter)h(\(fn)f(lst\))841 4045 y(\(mapcan)h
(#'\(lambda)g(\(x\))1312 4136 y(\(let)f(\(\(val)g(\(funcall)h(fn)f
(x\)\)\))1390 4227 y(\(if)g(val)g(\(list)g(val\)\)\)\))1155
4319 y(lst\)\))763 4501 y(\(defun)g(group)h(\(source)f(n\))841
4593 y(\(if)g(\(endp)g(source\))998 4684 y(nil)998 4775
y(\(let)g(\(\(rest)h(\(nthcdr)f(n)g(source\)\)\))1076
4867 y(\(cons)h(\(if)f(\(consp)g(rest\))h(\(subseq)f(source)h(0)e(n\))h
(source\))1312 4958 y(\(group)g(rest)g(n\)\)\)\)\))p
eop
%%Page: 390 403
390 402 bop 555 538 a FA(390)1121 b Fu(NO)n(TES)763 801
y Fo(\(defun)40 b(flatten)h(\(x\))841 892 y(\(mapcan)g(#'\(lambda)g
(\(x\))1312 983 y(\(if)f(\(atom)g(x\))g(\(mklist)h(x\))e(\(flatten)i
(x\)\)\))1155 1075 y(x\)\))763 1257 y(\(defun)f(prune)h(\(test)f
(tree\))841 1349 y(\(if)g(\(atom)g(tree\))998 1440 y(tree)998
1531 y(\(mapcar)h(#'\(lambda)g(\(x\))1469 1623 y(\(prune)f(test)g
(x\)\))1312 1714 y(\(remove-if)h(#'\(lambda)h(\(y\))1900
1805 y(\(and)e(\(atom)h(y\))2096 1897 y(\(funcall)g(test)f(y\)\)\))1743
1988 y(tree\)\)\)\))646 2146 y Fv(49)j(Written)18 b(as)g(it)h(is,)f
Fo(find2)i Fv(will)e(generate)h(an)h(error)e(if)h(it)f(runs)h(of)n(f)g
(the)g(end)h(of)f(a)g(dotted)g(list:)763 2303 y Fo(>)39
b(\(find2)i(#'oddp)f('\(2)g(.)g(3\)\))763 2395 y(>>Error:)h(3)e(is)h
(not)g(a)f(list.)763 2552 y Fv(C)p Fu(L)-5 b(TL)p Fv(2)20
b(\(p.)i(31\))h(says)g(that)f(it)g(is)g(an)h(error)f(to)g(gi)n(v)o(e)h
(a)g(dotted)g(list)e(to)i(a)f(function)h(e)o(xpecting)h(a)763
2644 y(list.)i(Implementations)20 b(are)e(not)i(required)f(to)g(detect)
g(this)g(error;)f(some)i(do,)f(some)g(don')o(t.)763 2752
y(The)26 b(situation)g(gets)g(murk)o(y)h(with)f(functions)h(that)f(tak)
o(e)g(sequences)i(generally)-5 b(.)49 b(A)26 b(dotted)763
2843 y(list)21 b(is)g(a)h(cons,)i(and)e(conses)h(are)f(sequences,)j(so)
d(a)g(strict)f(reading)i(of)f Fu(CL)-5 b(TL)20 b Fv(w)o(ould)j(seem)f
(to)763 2934 y(require)d(that)763 3092 y Fo(\(find-if)41
b(#'oddp)f('\(2)g(.)g(3\)\))763 3250 y Fv(return)23 b
Fo(nil)i Fv(instead)f(of)g(generating)g(an)g(error)m(,)h(because)g
Fo(find-if)g Fv(is)e(supposed)j(to)e(tak)o(e)g(a)763
3341 y(sequence)c(as)f(an)g(ar)o(gument.)763 3449 y(Implementations)g
(v)n(ary)g(here.)27 b(Some)18 b(generate)i(an)e(error)h(an)o(yw)o(ay)-5
b(,)19 b(and)g(others)g(return)g Fo(nil)p Fv(.)763 3540
y(Ho)n(we)n(v)o(er)m(,)25 b(e)n(v)o(en)g(implementations)g(which)f
(follo)n(w)g(the)g(strict)f(reading)i(in)f(the)g(case)g(abo)o(v)o(e)763
3632 y(tend)c(to)g(de)n(viate)h(in)f(e.g.)f(the)h(case)h(of)f
Fo(\(concatenate)42 b('cons)e('\(a)g(.)g(b\))f('\(c)h(.)g(d\)\))p
Fv(,)763 3723 y(which)19 b(is)f(lik)o(ely)i(to)e(return)h
Fo(\(a)40 b(c)g(.)f(d\))19 b Fv(instead)h(of)e Fo(\(a)40
b(c\))p Fv(.)763 3831 y(In)15 b(this)h(book,)h(the)f(utilities)f(which)
h(e)o(xpect)h(lists)e(e)o(xpect)h(proper)h(lists.)25
b(Those)16 b(which)g(operate)763 3922 y(on)24 b(sequences)h(will)e
(accept)h(dotted)g(lists.)41 b(Ho)n(we)n(v)o(er)m(,)25
b(in)f(general)g(it)f(w)o(ould)h(be)g(asking)h(for)763
4014 y(trouble)c(to)f(pass)h(dotted)g(lists)f(to)g(an)o(y)h(function)h
(that)e(w)o(asn')o(t)h(speci\002cally)f(intended)i(for)e(use)763
4105 y(on)f(them.)646 4229 y(66)43 b(If)14 b(we)h(could)i(tell)d(ho)n
(w)i(man)o(y)g(parameters)g(each)g(function)g(had,)g(we)f(could)h
(write)f(a)g(v)o(ersion)h(of)763 4321 y Fo(compose)c
Fv(so)g(that,)i(in)e Fa(f)f Fe(\016)p Fa(g)o(,)j Fv(multiple)e(v)n
(alues)g(returned)g(by)g Fa(g)g Fv(w)o(ould)g(become)g(the)g
(correspond\255)763 4412 y(ing)24 b(ar)o(guments)g(to)g
Fa(f)o(.)40 b Fv(In)24 b Fu(CL)-5 b(TL)p Fv(2,)23 b(the)g(ne)n(w)i
(function)f Fo(function-lambda-expression)763 4503 y
Fv(returns)k(a)g(lambda\255e)o(xpression)j(representing)e(the)g
(original)f(source)h(code)h(of)e(a)g(function.)763 4595
y(Ho)n(we)n(v)o(er)m(,)23 b(it)e(has)h(the)h(option)f(of)g(returning)h
Fo(nil)p Fv(,)g(and)g(usually)f(does)h(so)f(for)g(b)o(uilt\255in)f
(func\255)763 4686 y(tions.)29 b(What)20 b(we)f(really)h(need)h(is)e(a)
h(function)g(that)g(w)o(ould)h(tak)o(e)f(a)g(function)g(as)g(an)g(ar)o
(gument)763 4777 y(and)f(return)g(its)g(parameter)g(list.)646
4902 y(73)43 b(A)29 b(v)o(ersion)i(of)f Fo(rfind-if)i
Fv(which)f(searches)g(for)f(whole)h(subtrees)f(could)h(be)g(de\002ned)g
(as)763 4993 y(follo)n(ws:)p eop
%%Page: 391 404
391 403 bop 1802 538 a Fu(NO)n(TES)1122 b FA(391)763
801 y Fo(\(defun)40 b(rfind-if)h(\(fn)f(tree\))841 892
y(\(if)g(\(funcall)h(fn)f(tree\))998 983 y(tree)998 1075
y(\(if)g(\(atom)g(tree\))1155 1166 y(nil)1155 1257 y(\(or)g(\(rfind-if)
h(fn)f(\(car)g(tree\)\))1312 1349 y(\(and)g(\(cdr)g(tree\))g
(\(rfind-if)i(fn)d(\(cdr)h(tree\)\)\)\)\)\)\))763 1506
y Fv(The)22 b(function)i(passed)g(as)e(the)h(\002rst)f(ar)o(gument)h(w)
o(ould)h(then)f(ha)o(v)o(e)g(to)g(apply)g(to)g(both)g(atoms)763
1598 y(and)c(lists:)763 1755 y Fo(>)39 b(\(rfind-if)i(\(fint)g(#'atom)f
(#'oddp\))h('\(2)f(\(3)g(4\))f(5\)\))763 1847 y(3)763
1938 y(>)g(\(rfind-if)i(\(fint)g(#'listp)f(#'cddr\))h('\(a)f(\(b)g(c)f
(d)h(e\)\)\))763 2029 y(\(B)f(C)h(D)f(E\))646 2187 y
Fv(95)k(McCarthy)-5 b(,)35 b(John,)i(P)o(aul)31 b(W)-7
b(.)32 b(Abrahams,)k(Daniel)c(J.)g(Edw)o(ards,)k(T)m(imothy)c(P)-8
b(.)31 b(Hart,)k(and)763 2278 y(Michael)22 b(I.)f(Le)n(vin.)35
b Fa(Lisp)21 b(1.5)g(Pr)m(o)o(gr)o(ammer')m(s)h(Manual,)h
Fv(2nd)g(Edition.)34 b(MIT)22 b(Press,)f(Cam\255)763
2370 y(bridge,)e(1965,)h(pp.)f(70\25571.)609 2494 y(106)43
b(When)15 b(Section)g(8.1)h(says)f(that)g(a)h(certain)f(kind)h(of)f
(operator)h(can)g(only)g(be)f(written)g(as)g(a)h(macro,)763
2586 y(it)c(means,)k(can)e(only)g(be)g(written)f(by)h(the)g(user)f(as)h
(a)g(macro.)25 b(Special)14 b(forms)f(can)h(do)g(e)n(v)o(erything)763
2677 y(macros)19 b(can,)g(b)o(ut)g(there)g(is)f(no)i(w)o(ay)f(to)g
(de\002ne)g(ne)n(w)h(ones.)763 2785 y(A)f(special)h(form)g(is)g(so)g
(called)g(because)h(its)f(e)n(v)n(aluation)h(is)e(treated)h(as)g(a)g
(special)g(case.)31 b(In)19 b(an)763 2876 y(interpreter)m(,)f(you)i
(could)g(imagine)f Fo(eval)h Fv(as)f(a)f(big)i Fo(cond)f
Fv(e)o(xpression:)763 3034 y Fo(\(defun)40 b(eval)g(\(expr)h(env\))841
3125 y(\(cond)f(...)1076 3217 y(\(\(eq)h(\(car)f(expr\))g('quote\))h
(\(cadr)f(expr\)\))1076 3308 y(...)1076 3399 y(\(t)g(\(apply)h
(\(symbol-function)i(\(car)d(expr\)\))1469 3491 y(\(mapcar)g
(#'\(lambda)i(\(x\))1939 3582 y(\(eval)f(x)e(env\)\))1782
3673 y(\(cdr)i(expr\)\)\)\)\)\))763 3831 y Fv(Most)21
b(e)o(xpressions)h(are)f(handled)h(by)g(the)f(def)o(ault)g(clause,)h
(which)f(says)g(to)g(get)g(the)g(function)763 3922 y(referred)g(to)g
(in)h(the)f(car)m(,)h(e)n(v)n(aluate)g(all)f(the)g(ar)o(guments)h(in)f
(the)h(cdr)m(,)g(and)g(return)f(the)h(result)f(of)763
4014 y(applying)i(the)f(former)g(to)g(the)h(latter)l(.)35
b(Ho)n(we)n(v)o(er)m(,)24 b(an)e(e)o(xpression)h(of)g(the)f(form)g
Fo(\(quote)41 b(x\))763 4105 y Fv(should)18 b(not)h(be)f(treated)g
(this)f(w)o(ay:)27 b(the)18 b(whole)g(point)h(of)f(a)f(quote)i(is)f
(that)f(its)h(ar)o(gument)g(is)g(not)763 4196 y(e)n(v)n(aluated.)28
b(So)18 b Fo(eval)i Fv(has)f(to)g(ha)o(v)o(e)g(one)h(clause)f(which)g
(deals)h(speci\002cally)f(with)f Fo(quote)p Fv(.)763
4304 y(Language)25 b(designers)g(re)o(gard)f(special)g(forms)g(as)g
(something)h(lik)o(e)f(constitutional)h(amend\255)763
4396 y(ments.)h(It)16 b(is)g(necessary)i(to)e(ha)o(v)o(e)h(a)f(certain)
h(number)m(,)g(b)o(ut)g(the)f(fe)n(wer)h(the)f(better)l(.)26
b(The)17 b(special)763 4487 y(forms)i(in)f(Common)i(Lisp)f(are)g
(listed)f(in)h Fu(CL)-5 b(TL)p Fv(2,)17 b(p.)h(73.)763
4595 y(The)23 b(preceding)i(sk)o(etch)g(of)e Fo(eval)h
Fv(is)f(inaccurate)i(in)e(that)h(it)f(retrie)n(v)o(es)g(the)h(function)
g(before)763 4686 y(e)n(v)n(aluating)12 b(the)g(ar)o(guments,)k
(whereas)c(in)g(Common)g(Lisp)g(the)g(order)g(of)g(these)g(tw)o(o)h
(ope)q(rations)763 4777 y(is)30 b(deliberately)i(unspeci\002ed.)64
b(F)o(or)30 b(a)h(sk)o(etch)h(of)f Fo(eval)h Fv(in)f(Scheme,)j(see)d
(Abelson)h(and)763 4869 y(Sussman,)19 b(p.)f(299.)p eop
%%Page: 392 405
392 404 bop 555 538 a FA(392)1121 b Fu(NO)n(TES)609 801
y Fv(115)43 b(It')l(s)26 b(reasonable)j(to)e(say)h(that)f(a)g(utility)g
(function)h(is)f(justi\002ed)g(when)h(it)e(pays)i(for)f(itself)g(in)763
892 y(bre)n(vity)-5 b(.)37 b(Utilities)20 b(written)i(as)g(macros)h
(may)f(ha)o(v)o(e)g(to)g(meet)g(a)g(stricter)g(standard.)37
b(Reading)763 983 y(macro)31 b(calls)f(can)h(be)g(more)f(dif)n
(\002cult)g(than)h(reading)h(function)f(calls,)i(because)e(the)o(y)g
(can)763 1075 y(violate)23 b(the)g(Lisp)g(e)n(v)n(aluation)h(rule.)39
b(In)23 b(Common)h(Lisp,)g(this)e(rule)h(says)h(that)f(the)g(v)n(alue)h
(of)763 1166 y(an)17 b(e)o(xpression)i(is)e(the)h(result)f(of)h
(calling)f(the)h(function)g(named)h(in)e(the)h(car)f(on)h(the)g(ar)o
(guments)763 1257 y(gi)n(v)o(en)i(in)g(the)f(cdr)m(,)h(e)n(v)n(aluated)
h(left\255to\255right.)29 b(Since)19 b(functions)i(all)e(follo)n(w)h
(this)f(rule,)h(it)f(is)g(no)763 1349 y(more)g(dif)n(\002cult)f(to)h
(understand)i(a)d(call)h(to)g Fo(find2)h Fv(than)f(to)g
Fo(find-books)i Fv(\(page)e(42\).)763 1457 y(Ho)n(we)n(v)o(er)m(,)26
b(macros)f(generally)h(do)f(not)g(preserv)o(e)g(the)g(Lisp)f(e)n(v)n
(aluation)i(rule.)44 b(\(If)24 b(one)h(did,)763 1548
y(you)e(could)g(ha)o(v)o(e)g(used)h(a)e(function)h(instead.\))39
b(In)22 b(principle,)i(each)f(macro)g(de\002nes)g(its)f(o)n(wn)763
1639 y(e)n(v)n(aluation)k(rule,)f(and)h(the)f(reader)g(can')o(t)f(kno)n
(w)i(what)f(it)f(is)g(without)h(reading)h(the)e(macro')l(s)763
1730 y(de\002nition.)31 b(So)20 b(a)g(macro,)h(depending)h(on)f(ho)n(w)
f(clear)h(it)e(is,)h(may)h(ha)o(v)o(e)f(to)g(sa)o(v)o(e)g(much)h(more)
763 1822 y(than)e(its)f(o)n(wn)i(length)f(in)g(order)g(to)g(justify)g
(its)f(e)o(xistence.)609 1946 y(126)43 b(The)22 b(de\002nition)g(of)h
Fo(for)f Fv(gi)n(v)o(en)i(in)e(Figure)g(9.2,)h(lik)o(e)f(se)n(v)o(eral)
h(others)g(de\002ned)g(in)f(this)g(book,)763 2038 y(is)d(correct)i(on)f
(the)g(assumption)i(that)e(the)g(initforms)g(in)g(a)g
Fo(do)g Fv(e)o(xpression)i(will)d(be)h(e)n(v)n(aluated)763
2129 y(left\255to\255right.)26 b(C)p Fu(L)-5 b(TL)p Fv(2)16
b(\(p.)j(165\))g(says)g(that)g(this)f(holds)h(for)g(the)f(stepforms,)h
(b)o(ut)g(says)g(nothing)763 2220 y(one)g(w)o(ay)h(or)e(the)h(other)h
(about)f(the)g(initforms.)763 2328 y(There)g(is)g(good)i(cause)f(to)f
(belie)n(v)o(e)h(that)g(this)f(is)g(merely)g(an)h(o)o(v)o(ersight.)29
b(Usually)20 b(if)f(the)g(order)763 2420 y(of)25 b(some)i(operations)g
(is)e(unspeci\002ed,)k Fu(CL)-5 b(TL)23 b Fv(will)i(say)h(so.)48
b(And)26 b(there)g(is)g(no)g(reason)h(that)763 2511 y(the)g(order)h(of)
g(e)n(v)n(aluation)g(of)g(the)f(initforms)h(of)f(a)g
Fo(do)h Fv(should)h(be)e(unspeci\002ed,)k(since)d(the)763
2602 y(e)n(v)n(aluation)23 b(of)f(a)h Fo(let)f Fv(is)g
(left\255to\255right,)h(and)g(so)f(is)g(the)g(e)n(v)n(aluation)i(of)e
(the)h(stepforms)f(in)h Fo(do)763 2694 y Fv(itself.)609
2818 y(128)43 b(Common)17 b(Lisp')l(s)g Fo(gentemp)h
Fv(is)e(lik)o(e)h Fo(gensym)h Fv(e)o(xcept)g(that)e(it)g(interns)h(the)
g(symbol)h(it)e(creates.)763 2909 y(Lik)o(e)23 b Fo(gensym)p
Fv(,)k Fo(gentemp)e Fv(maintains)f(an)g(internal)g(counter)h(which)g
(it)e(uses)h(to)g(mak)o(e)h(print)763 3001 y(names.)51
b(If)27 b(the)g(symbol)g(it)g(w)o(ants)g(to)g(create)g(already)g(e)o
(xists)g(in)g(the)g(current)g(package,)j(it)763 3092
y(increments)19 b(the)g(counter)h(and)f(tries)g(again:)763
3250 y Fo(>)39 b(\(gentemp\))763 3341 y(T1)763 3432 y(>)g(\(setq)h(t2)g
(1\))763 3524 y(1)763 3615 y(>)f(\(gentemp\))763 3706
y(T3)763 3864 y Fv(and)25 b(so)f(tries)g(to)h(ensure)g(that)f(the)h
(symbol)g(created)g(will)f(be)h(unique.)45 b(Ho)n(we)n(v)o(er)m(,)26
b(it)e(is)g(still)763 3955 y(possible)17 b(to)f(imagine)h(name)g
(con\003icts)f(in)m(v)o(olving)h(symbols)g(created)g(by)g
Fo(gentemp)p Fv(.)28 b(Though)763 4047 y Fo(gentemp)18
b Fv(can)f(guarantee)h(to)f(produce)h(a)f(symbol)h(not)f(seen)h
(before,)f(it)f(cannot)i(foresee)g(what)763 4138 y(symbols)26
b(might)f(be)g(encountered)i(in)e(the)g(future.)46 b(Since)25
b Fo(gensym)p Fv(s)h(w)o(ork)g(perfectly)f(well)763 4229
y(and)c(are)g(al)o(w)o(ays)h(safe,)g(why)f(use)g Fo(gentemp)p
Fv(?)36 b(Indeed,)22 b(for)f(macros)h(the)f(only)h(adv)n(antage)h(of)
763 4321 y Fo(gentemp)h Fv(is)f(that)g(the)g(symbols)h(it)e(mak)o(es)i
(can)g(be)f(written)g(out)g(and)h(read)f(back)h(in,)g(and)g(in)763
4412 y(such)19 b(cases)h(the)o(y)f(are)g(certainly)g(not)g(guaranteed)h
(to)f(be)g(unique.)609 4537 y(131)43 b(The)18 b(capture)h(of)g
(function)g(names)g(w)o(ould)g(be)g(a)g(more)f(serious)h(problem)h(in)e
(Scheme,)h(due)g(to)763 4628 y(its)f(single)i(name\255space.)30
b(Not)20 b(until)f(1991)i(did)f(the)f(Scheme)h(standard)h(suggest)f(an)
o(y)g(of)n(\002cial)763 4719 y(w)o(ay)26 b(of)g(de\002ning)h(macros.)48
b(Scheme')l(s)26 b(current)h(pro)o(vision)g(for)f(hygienic)g(macros)h
(dif)n(fers)763 4811 y(greatly)c(from)g Fo(defmacro)p
Fv(.)42 b(F)o(or)22 b(details,)i(and)g(a)f(bibliography)h(of)g(recent)f
(research)h(on)g(the)763 4902 y(subject,)19 b(see)g(the)g(most)g
(recent)g(Scheme)g(report.)p eop
%%Page: 393 406
393 405 bop 1802 538 a Fu(NO)n(TES)1122 b FA(393)609
801 y Fv(137)43 b(Miller)m(,)20 b(Molly)h(M.,)f(and)h(Eric)f(Benson.)33
b Fa(Lisp)20 b(Style)h(and)g(Design)p Fv(.)32 b(Digital)20
b(Press,)g(Bedford)763 892 y(\(MA\),)e(1990,)i(p.)f(86.)609
1017 y(158)43 b(Instead)20 b(of)f(writing)g Fo(mvpsetq)p
Fv(,)i(it)e(w)o(ould)h(be)g(cleaner)f(to)h(de\002ne)g(an)f(in)m(v)o
(ersion)i(for)e Fo(values)p Fv(.)763 1108 y(Then)g(instead)g(of)763
1266 y Fo(\(mvpsetq)41 b(\(w)e(x\))h(\(values)h(y)e(z\))h(...\))763
1423 y Fv(we)18 b(could)i(say)763 1581 y Fo(\(psetf)40
b(\(values)h(w)e(x\))h(\(values)h(y)e(z\))h(...\))763
1739 y Fv(De\002ning)23 b(an)h(in)m(v)o(ersion)g(for)f
Fo(values)h Fv(w)o(ould)g(also)f(render)h Fo(multiple-value-setq)j
Fv(un\255)763 1830 y(necessary)-5 b(.)27 b(Unfortunately)-5
b(,)18 b(as)g(things)f(stand)h(in)f(Common)h(Lisp)f(it)f(is)h
(impossible)g(to)g(de\002ne)763 1921 y(such)25 b(an)f(in)m(v)o(ersion;)
k Fo(get-setf-method)f Fv(w)o(on')o(t)d(return)h(more)g(than)f(one)h
(store)g(v)n(ariable,)763 2013 y(and)f(presumably)g(the)g(e)o(xpansion)
h(function)f(of)f Fo(psetf)i Fv(w)o(ouldn')o(t)e(kno)n(w)i(what)e(to)g
(do)h(with)763 2104 y(them)19 b(if)f(it)g(did.)609 2229
y(180)43 b(One)16 b(of)h(the)g(lessons)g(of)g Fo(setf)g
Fv(is)f(that)g(certain)h(classes)g(of)g(macros)g(can)g(hide)g(truly)f
(enormous)763 2320 y(amounts)26 b(of)f(computation)h(and)g(yet)g(lea)o
(v)o(e)e(the)i(source)g(code)g(perfectly)f(comprehensible.)763
2411 y(Ev)o(entually)34 b Fo(setf)g Fv(may)h(be)f(just)g(one)g(of)g(a)g
(class)g(of)g(macros)g(for)g(programming)h(with)763 2503
y(assertions.)763 2611 y(F)o(or)26 b(e)o(xample,)i(it)e(might)h(be)g
(useful)g(to)f(ha)o(v)o(e)h(a)f(macro)h Fo(insist)h Fv(which)f(took)g
(certain)g(e)o(x\255)763 2702 y(pressions)19 b(of)f(the)h(form)f
Fo(\()p Fa(pr)m(edicate)41 b Fo(.)e Fa(ar)m(guments)p
Fo(\))p Fv(,)20 b(and)f(w)o(ould)h(mak)o(e)f(them)f(true)h(if)e(the)o
(y)763 2793 y(weren')o(t)h(already)-5 b(.)28 b(As)19
b Fo(setf)g Fv(has)h(to)f(be)g(told)g(ho)n(w)h(to)e(in)m(v)o(ert)h
(references,)h(this)e(macro)i(w)o(ould)763 2884 y(ha)o(v)o(e)d(to)g(be)
g(told)h(ho)n(w)f(to)g(mak)o(e)h(e)o(xpressions)h(true.)26
b(In)17 b(the)g(general)h(case,)g(such)f(a)g(macro)h(call)763
2976 y(might)h(amount)g(to)g(a)g(call)g(to)g(Prolog.)609
3100 y(198)43 b(Gelernter)m(,)33 b(Da)o(vid)d(H.,)i(and)f(Suresh)g
(Jagannathan.)63 b Fa(Pr)m(o)o(gr)o(amming)32 b(Linguistics.)61
b Fv(MIT)763 3192 y(Press,)18 b(Cambridge,)h(1990,)h(p.)f(305.)609
3316 y(199)43 b(Norvig,)23 b(Peter)l(.)38 b Fa(P)-6 b(ar)o(adigms)24
b(of)e(Arti\002cial)g(Intellig)o(ence)i(Pr)m(o)o(gr)o(amming:)f(Case)g
(Studies)h(in)763 3408 y(Common)19 b(Lisp.)26 b Fv(Mor)o(gan)20
b(Kaufmann,)g(San)e(Mateo)i(\(CA\),)e(1992,)i(p.)e(856.)609
3532 y(213)43 b(The)12 b(constant)g Fo(least-negative-normalized-dou)q
(ble-f)q(loat)h Fv(and)f(its)g(three)g(cousins)763 3623
y(ha)o(v)o(e)25 b(the)g(longest)h(names)g(in)f(Common)h(Lisp,)g(with)f
(38)h(characters)g(each.)46 b(The)25 b(operator)763 3715
y(with)18 b(the)h(longest)h(name)f(is)g Fo
(get-setf-method-multiple-value)p Fv(,)25 b(with)18 b(30.)763
3823 y(The)h(follo)n(wing)i(e)o(xpression)g(returns)f(a)g(list,)f(from)
h(longest)g(to)g(shortest,)g(of)g(all)f(the)h(symbols)763
3914 y(visible)f(in)f(the)h(current)h(package:)763 4055
y Fo(\(let)40 b(\(\(syms)g(nil\)\))841 4146 y(\(do-symbols)i(\(s\))919
4238 y(\(push)f(s)e(syms\)\))841 4329 y(\(sort)h(syms)1076
4420 y(#'\(lambda)i(\(x)d(y\))1233 4512 y(\(>)h(\(length)h
(\(symbol-name)h(x\)\))1351 4603 y(\(length)f(\(symbol-name)h
(y\)\)\)\)\)\))609 4744 y Fv(217)h(As)25 b(of)h Fu(CL)-5
b(TL)p Fv(2,)24 b(the)i(e)o(xpansion)h(function)g(of)e(a)h(macro)g(is)f
(supposed)j(to)d(be)h(de\002ned)g(in)g(the)763 4836 y(en)m(vironment)17
b(where)g(the)f Fo(defmacro)i Fv(e)o(xpression)f(appears.)27
b(This)16 b(should)h(mak)o(e)h(it)d(possible)763 4927
y(to)j(gi)n(v)o(e)i Fo(propmacro)g Fv(the)f(cleaner)h(de\002nition:)p
eop
%%Page: 394 407
394 406 bop 555 538 a FA(394)1121 b Fu(NO)n(TES)763 801
y Fo(\(defmacro)41 b(propmacro)g(\(propname\))841 892
y(`\(defmacro)h(,propname)f(\(obj\))959 983 y(`\(get)f(,obj)g
(',propname\)\)\))763 1124 y Fv(But)16 b Fu(CL)-5 b(TL)p
Fv(2)15 b(does)i(not)g(e)o(xplicitly)g(state)g(whether)g(the)g
Fo(propname)h Fv(form)f(originally)g(passed)h(to)763
1215 y Fo(propmacro)i Fv(is)e(part)g(of)h(the)f(le)o(xical)h(en)m
(vironment)h(in)e(which)h(the)f(inner)h Fo(defmacro)h
Fv(occurs.)763 1307 y(In)29 b(principle,)j(it)d(seems)h(that)g(if)f
Fo(color)h Fv(were)f(de\002ned)i(with)e Fo(\(propmacro)41
b(color\))p Fv(,)33 b(it)763 1398 y(should)20 b(be)f(equi)n(v)n(alent)h
(to:)763 1538 y Fo(\(let)40 b(\(\(propname)h('color\)\))841
1630 y(\(defmacro)g(color)g(\(obj\))919 1721 y(`\(get)g(,obj)f
(',propname\)\)\))763 1862 y Fv(or)763 2002 y Fo(\(let)g(\(\(propname)h
('color\)\))841 2094 y(\(defmacro)g(color)g(\(obj\))919
2185 y(\(list)g('get)f(obj)g(\(list)g('quote)h(propname\)\)\)\))763
2326 y Fv(Ho)n(we)n(v)o(er)m(,)23 b(in)e(at)h(least)g(some)g
Fu(CL)-5 b(TL)p Fv(2)20 b(implementations,)j(the)f(ne)n(w)h(v)o(ersion)
f(of)g Fo(propmacro)763 2417 y Fv(does)d(not)g(w)o(ork.)763
2520 y(In)d Fu(CL)-5 b(TL)p Fv(1,)14 b(the)i(e)o(xpansion)i(function)f
(of)f(a)g(macro)g(w)o(as)g(considered)i(to)e(be)g(de\002ned)h(in)f(the)
g(null)763 2612 y(le)o(xical)23 b(en)m(vironment.)42
b(So)23 b(for)g(maximum)h(portability)-5 b(,)25 b(macro)f
(de\002nitions)g(should)g(a)o(v)o(oid)763 2703 y(using)19
b(the)g(enclosing)h(en)m(vironment)h(an)o(yw)o(ay)-5
b(.)609 2819 y(238)43 b(Functions)26 b(lik)o(e)g Fo(match)h
Fv(are)f(sometimes)g(described)h(as)f(doing)h(uni\002cation.)49
b(The)o(y)26 b(don')o(t,)763 2910 y(quite;)k Fo(match)e
Fv(will)d(successfully)j(match)f Fo(\(f)39 b(?x\))28
b Fv(and)f Fo(?x)p Fv(,)h(b)o(ut)f(those)g(tw)o(o)f(e)o(xpressions)763
3002 y(should)20 b(not)f(unify)-5 b(.)763 3105 y(F)o(or)20
b(a)h(description)h(of)f(uni\002cation,)h(see:)32 b(Nilsson,)22
b(Nils)e(J.)34 b Fa(Pr)m(oblem\255Solving)22 b(Methods)g(in)763
3197 y(Arti\002cial)c(Intellig)o(ence)o(.)27 b Fv(McGra)o(w\255Hill,)18
b(Ne)n(w)h(Y)-8 b(ork,)19 b(1971,)h(pp.)f(175\255178.)609
3313 y(244)43 b(It')l(s)18 b(not)h(really)f(necessary)i(to)f(set)g
(unbound)i(v)n(ariables)e(to)g(gensyms,)h(or)f(to)f(call)h
Fo(gensym?)h Fv(at)763 3404 y(runtime.)30 b(The)20 b(e)o
(xpansion\255generating)i(code)f(in)f(Figures)g(18.7)g(and)h(18.8)f
(could)h(be)f(written)763 3495 y(to)14 b(k)o(eep)i(track)f(of)g(the)f
(v)n(ariables)i(for)e(which)i(binding)f(code)h(had)f(already)h(been)f
(generated.)27 b(T)-6 b(o)763 3587 y(do)18 b(this)g(the)f(code)i(w)o
(ould)g(ha)o(v)o(e)f(to)g(be)g(turned)g(inside\255out,)h(ho)n(we)n(v)o
(er:)27 b(instead)19 b(of)f(generating)763 3678 y(the)23
b(e)o(xpansion)h(on)f(the)g(w)o(ay)h(back)g(up)f(the)g(recursion,)h(it)
f(w)o(ould)g(ha)o(v)o(e)g(to)g(be)g(accumulated)763 3769
y(on)c(the)g(w)o(ay)g(do)n(wn.)609 3885 y(244)43 b(A)23
b(symbol)i(lik)o(e)f Fo(?x)h Fv(occurring)g(in)f(the)g(pattern)g(of)g
(an)h Fo(if-match)g Fv(al)o(w)o(ays)g(denotes)g(a)f(ne)n(w)763
3977 y(v)n(ariable,)18 b(just)g(as)h(a)f(symbol)h(in)f(the)h(car)f(of)h
(a)f Fo(let)h Fv(binding)g(clause)g(does.)27 b(So)19
b(although)g(Lisp)763 4068 y(v)n(ariables)g(can)h(be)g(used)g(in)f
(patterns,)g(pattern)h(v)n(ariables)f(from)h(outer)f(queries)h
(cannot\227you)763 4159 y(can)25 b(use)f(the)h(same)g
Fa(symbol,)h Fv(b)o(ut)e(it)g(will)g(denote)h(a)g(ne)n(w)g(v)n
(ariable.)44 b(T)-6 b(o)24 b(test)h(that)f(tw)o(o)h(lists)763
4251 y(ha)o(v)o(e)19 b(the)g(same)g(\002rst)f(element,)h(it)f(w)o
(ouldn')o(t)h(w)o(ork)h(to)f(write:)763 4391 y Fo(\(if-match)41
b(\(?x)f(.)f(?rest1\))i(lst1)919 4482 y(\(if-match)h(\(?x)e(.)f
(?rest2\))i(lst2)1076 4574 y(?x\)\))763 4714 y Fv(In)16
b(this)h(case,)g(the)g(second)h Fo(?x)f Fv(is)g(a)f(ne)n(w)i(v)n
(ariable.)26 b(If)17 b(both)g Fo(lst1)h Fv(and)f Fo(lst2)h
Fv(had)f(at)g(least)f(one)763 4806 y(element,)i(this)h(e)o(xpression)h
(w)o(ould)g(al)o(w)o(ays)g(return)f(the)g(car)g(of)g
Fo(lst2)p Fv(.)763 4909 y(Ho)n(we)n(v)o(er)m(,)e(since)f(you)g(can)h
(use)f(\(non\255)p Fo(?)p Fv(ed\))h(Lisp)f(v)n(ariables)g(in)g(the)g
(pattern)g(of)g(an)h Fo(if-match)p Fv(,)763 5001 y(you)i(can)h(get)f
(the)g(desired)g(ef)n(fect)g(by)g(writing:)p eop
%%Page: 395 408
395 407 bop 1802 538 a Fu(NO)n(TES)1122 b FA(395)763
801 y Fo(\(if-match)41 b(\(?x)f(.)f(?rest1\))i(lst1)919
892 y(\(let)g(\(\(x)f(?x\)\))998 983 y(\(if-match)h(\(x)f(.)f(?rest2\))
i(lst2)1155 1075 y(?x\)\)\))763 1232 y Fv(The)17 b(restriction,)h(and)g
(the)g(solution,)h(apply)f(to)g(the)g Fo(with-answer)i
Fv(and)f Fo(with-inference)763 1324 y Fv(macros)g(de\002ned)h(in)e
(Chapters)i(19)f(and)h(24)f(as)g(well.)609 1448 y(254)43
b(If)26 b(it)g(were)g(a)h(problem)g(that)g(\223unbound\224)i(pattern)e
(v)n(ariables)g(were)g Fo(nil)p Fv(,)i(you)e(could)h(ha)o(v)o(e)763
1540 y(them)19 b(bound)h(to)f(a)g(distinct)g(gensym)i(by)e(saying)h
Fo(\(defconstant)42 b(unbound)f(\(gensym\)\))763 1631
y Fv(and)19 b(then)g(replacing)h(the)f(line)763 1789
y Fo(`\(,v)40 b(\(binding)h(',v)f(,binds\)\)\))763 1946
y Fv(in)18 b Fo(with-answer)k Fv(with:)763 2104 y Fo(`\(,v)40
b(\(aif2)g(\(binding)h(',v)f(,binds\))h(it)f(unbound\)\))609
2262 y Fv(258)j(Scheme)26 b(w)o(as)g(in)m(v)o(ented)i(by)e(Guy)h(L.)e
(Steele)h(Jr)l(.)f(and)i(Gerald)f(J.)g(Sussman)h(in)f(1975.)50
b(The)763 2353 y(language)25 b(is)f(currently)h(de\002ned)g(by:)39
b(Clinger)m(,)25 b(W)m(illiam,)f(and)h(Jonathan)h(A.)d(Rees)i
(\(Eds.\).)763 2444 y Fa(Re)o(vised)994 2413 y Fl(4)1042
2444 y Fa(Report)19 b(on)g(the)g(Algorithmic)g(Langua)o(g)o(e)i(Sc)o
(heme)o(.)27 b Fv(1991.)763 2552 y(This)c(report,)i(and)f(v)n(arious)g
(implementations)h(of)f(Scheme,)h(were)e(at)h(the)f(time)h(of)f
(printing)763 2644 y(a)o(v)n(ailable)c(by)g(anon)o(ymous)i
Fu(FTP)e Fv(from)g Fo(altdorf.ai.mit.edu:pub)p Fv(.)609
2768 y(266)43 b(As)17 b(another)i(e)o(xample)g(of)f(the)g(technique)h
(presented)g(in)f(Chapter)g(16,)h(here)f(is)g(the)g(deri)n(v)n(ation)
763 2860 y(of)g(the)h Fo(defmacro)i Fv(template)e(within)g(the)g
(de\002nition)g(of)g Fo(=defun)p Fv(:)763 3017 y Fo(\(defmacro)41
b(fun)f(\(x\))841 3109 y(`\(=fun)h(*cont*)f(,x\)\))763
3291 y(\(defmacro)h(fun)f(\(x\))841 3383 y(\(let)g(\(\(fn)g('=fun\)\))
919 3474 y(`\(,fn)h(*cont*)f(,x\)\)\))763 3657 y(`\(defmacro)h(,name)f
(,parms)880 3748 y(\(let)g(\(\(fn)h(',f\)\))959 3839
y(`\(,fn)f(*cont*)h(,,@parms\)\)\))763 4022 y(`\(defmacro)g(,name)f
(,parms)880 4113 y(`\(,',f)h(*cont*)f(,,@parms\)\))609
4271 y Fv(267)j(If)18 b(you)i(w)o(anted)f(to)g(see)g(multiple)g(return)
g(v)n(alues)h(in)f(the)g(tople)n(v)o(el,)g(you)h(could)f(say)h
(instead:)763 4429 y Fo(\(setq)40 b(*cont*)998 4520 y(#'\(lambda)h
(\(&rest)g(args\))1155 4611 y(\(if)f(\(cdr)g(args\))g(args)g(\(car)h
(args\)\)\)\))609 4769 y Fv(273)i(This)32 b(e)o(xample)i(is)e(based)i
(on)f(one)g(gi)n(v)o(en)h(in:)55 b(W)-6 b(and,)36 b(Mitchell.)68
b(Continuation\255Based)763 4860 y(Program)19 b(T)m(ransformation)g
(Strate)o(gies.)27 b Fa(J)m(A)n(CM)18 b Fv(27,)h(1)g(\(January)h
(1980\),)g(pp.)f(166.)p eop
%%Page: 396 409
396 408 bop 555 538 a FA(396)1121 b Fu(NO)n(TES)609 801
y Fv(273)43 b(A)25 b(program)i(to)f(transform)g(Scheme)g(code)h(into)f
(continuation\255passing)i(style)e(appears)h(in:)763
892 y(Steele,)17 b(Guy)j(L.,)d(Jr)l(.)27 b(L)p Fu(AMBD)n(A)p
Fv(:)18 b(The)h(Ultimate)f Fa(Declar)o(ative)o(.)27 b
Fv(MIT)19 b(Arti\002cial)e(Intelligence)763 983 y(Memo)i(379,)h(No)o(v)
o(ember)g(1976,)f(pp.)g(30\25538.)609 1104 y(292)43 b(These)28
b(implementations)i(of)e Fo(choose)i Fv(and)f Fo(fail)g
Fv(w)o(ould)g(be)g(clearer)g(in)f(T)-6 b(,)28 b(a)g(dialect)h(of)763
1195 y(Scheme)19 b(which)g(has)g Fo(push)h Fv(and)g Fo(pop)p
Fv(,)f(and)g(allo)n(ws)g Fo(define)h Fv(in)f(non\255tople)n(v)o(el)h
(conte)o(xts:)763 1345 y Fo(\(define)40 b(*paths*)h(\(\)\))763
1436 y(\(define)f(failsym)h('@\))763 1586 y(\(define)f(\(choose)h
(choices\))841 1677 y(\(if)f(\(null?)h(choices\))998
1768 y(\(fail\))998 1860 y(\(call-with-current-continuati)q(on)1076
1951 y(\(lambda)g(\(cc\))1155 2042 y(\(push)f(*paths*)1390
2134 y(\(lambda)h(\(\))f(\(cc)g(\(choose)g(\(cdr)h(choices\)\)\)\)\))
1155 2225 y(\(car)f(choices\)\)\)\)\))763 2408 y
(\(call-with-current-continuation)841 2499 y(\(lambda)h(\(cc\))919
2590 y(\(define)g(\(fail\))998 2682 y(\(if)f(\(null?)g(*paths*\))1155
2773 y(\(cc)g(failsym\))1155 2864 y(\(\(pop)g(*paths*\)\)\)\)\)\))763
3014 y Fv(F)o(or)21 b(more)h(on)g(T)-6 b(,)21 b(see:)33
b(Rees,)22 b(Jonathan)h(A.,)e(Norman)i(I.)e(Adams,)h(and)h(James)f(R.)f
(Meehan.)763 3105 y Fa(The)i(T)f(Manual)p Fv(,)k(5th)d(Edition.)40
b(Y)-7 b(ale)23 b(Uni)n(v)o(ersity)h(Computer)g(Science)f(Department,)i
(Ne)n(w)763 3196 y(Ha)o(v)o(en,)18 b(1988.)763 3302 y(The)e(T)g
(manual,)h(and)h(T)e(itself,)g(were)g(at)g(the)h(time)f(of)h(printing)g
(a)o(v)n(ailable)f(by)h(anon)o(ymous)i Fu(FTP)763 3394
y Fv(from)f Fo(hing.lcs.mit.edu:pub/t3.1)p Fv(.)609 3514
y(293)43 b(Flo)o(yd,)33 b(Robert)d(W.)61 b(Nondeterministic)31
b(Algorithms.)62 b Fa(J)m(A)n(CM)29 b Fv(14,)34 b(4)c(\(October)h
(1967\),)763 3606 y(pp.)19 b(636\255644.)609 3726 y(298)43
b(The)33 b(continuation\255passing)j(macros)e(de\002ned)g(in)g(Chapter)
g(20)g(depend)h(hea)o(vily)f(on)g(the)763 3817 y(optimization)25
b(of)g(tail)g(calls.)45 b(W)m(ithout)24 b(it)h(the)o(y)g(may)g(not)h(w)
o(ork)f(for)g(lar)o(ge)g(problems.)46 b(F)o(or)763 3909
y(e)o(xample,)21 b(at)g(the)g(time)f(of)h(printing,)g(fe)n(w)g
(computers)h(ha)o(v)o(e)f(enough)i(memory)e(to)g(allo)n(w)g(the)763
4000 y(Prolog)g(de\002ned)g(in)g(Chapter)g(24)h(to)f(run)g(the)g(zebra)
g(benchmark)i(without)e(the)g(optimization)763 4091 y(of)d(tail)h
(calls.)26 b(\(W)-6 b(arning:)27 b(some)20 b(Lisps)e(crash)i(when)f
(the)o(y)g(run)h(out)f(of)g(stack)g(space.\))609 4212
y(303)43 b(It')l(s)30 b(also)h(possible)h(to)f(de\002ne)h(a)f
(depth\255\002rst)g(correct)h Fa(c)o(hoose)g Fv(that)f(w)o(orks)h(by)g
(e)o(xplicitly)763 4303 y(a)o(v)o(oiding)19 b(circular)g(paths.)27
b(Here)19 b(is)f(a)h(de\002nition)g(in)g(T)l(:)763 4453
y Fo(\(define)40 b(*paths*)h(\(\)\))763 4544 y(\(define)f(failsym)h
('@\))763 4635 y(\(define)f(*choice-pts*)i(\(make-symbol-table\)\))763
4818 y(\(define-syntax)g(\(true-choose)g(choices\))841
4909 y(`\(choose-fn)g(,choices)f(',\(generate-symbol)i(t\)\)\))p
eop
%%Page: 397 410
397 409 bop 1802 538 a Fu(NO)n(TES)1122 b FA(397)763
801 y Fo(\(define)40 b(\(choose-fn)i(choices)f(tag\))841
892 y(\(if)f(\(null?)h(choices\))998 983 y(\(fail\))998
1075 y(\(call-with-current-continuati)q(on)1076 1166
y(\(lambda)g(\(cc\))1155 1257 y(\(push)f(*paths*)1390
1349 y(\(lambda)h(\(\))f(\(cc)g(\(choose-fn)h(\(cdr)f(choices\))2410
1440 y(tag\)\)\)\))1155 1531 y(\(if)g(\(mem)g(equal?)g(\(car)h
(choices\))1782 1623 y(\(table-entry)h(*choice-pts*)g(tag\)\))1312
1714 y(\(fail\))1312 1805 y(\(car)e(\(push)g(\(table-entry)i
(*choice-pts*)g(tag\))1743 1897 y(\(car)e(choices\)\)\)\)\)\)\)\))763
2031 y Fv(In)24 b(this)f(v)o(ersion,)j Fo(true-choose)g
Fv(becomes)f(a)f(macro.)42 b(\(The)24 b(T)f Fo(define-syntax)k
Fv(is)d(lik)o(e)763 2122 y Fo(defmacro)d Fv(e)o(xcept)g(that)f(the)h
(macro)g(name)f(is)g(put)h(in)f(the)g(car)h(of)f(the)g(parameter)h
(list.\))30 b(This)763 2213 y(macro)e(e)o(xpands)h(into)f(a)g(call)f
(to)h Fo(choose-fn)p Fv(,)j(a)d(function)g(lik)o(e)g(the)g
(depth\255\002rst)g Fo(choose)763 2305 y Fv(de\002ned)23
b(in)g(Figure)g(22.4,)h(e)o(xcept)g(that)e(it)h(tak)o(es)g(an)g
(additional)h Fo(tag)f Fv(ar)o(gument)h(to)f(identify)763
2396 y(choice\255points.)50 b(Each)27 b(v)n(alue)g(returned)g(by)g(a)f
Fo(true-choose)j Fv(is)d(recorded)h(in)g(the)f(global)763
2487 y(hash\255table)17 b Fo(*choice-pts*)p Fv(.)28 b(If)16
b(a)g(gi)n(v)o(en)h Fo(true-choose)h Fv(is)e(about)h(to)f(return)g(a)g
(v)n(alue)h(it)e(has)763 2579 y(already)i(returned,)h(it)e(f)o(ails)h
(instead.)27 b(There)17 b(is)g(no)g(need)h(to)f(change)i
Fo(fail)e Fv(itself;)g(we)g(can)g(use)763 2670 y(the)i
Fo(fail)g Fv(de\002ned)h(on)f(page)h(396.)763 2772 y(This)f
(implementation)h(assumes)h(that)e(paths)h(are)g(of)g(\002nite)f
(length.)30 b(F)o(or)19 b(e)o(xample,)h(it)f(w)o(ould)763
2863 y(allo)n(w)12 b Fo(path)i Fv(as)f(de\002ned)h(in)f(Figure)f(22.13)
i(to)f(\002nd)g(a)g(path)g(from)g Fo(a)g Fv(to)g Fo(e)g
Fv(in)g(the)g(graph)h(displayed)763 2955 y(in)h(Figure)g(22.11)h
(\(though)g(not)g(necessarily)g(a)f(direct)g(one\).)26
b(But)15 b(the)h Fo(true-choose)h Fv(de\002ned)763 3046
y(abo)o(v)o(e)i(w)o(ouldn')o(t)h(w)o(ork)f(for)g(programs)h(with)f(an)g
(in\002nite)f(search\255space:)763 3180 y Fo(\(define)40
b(\(guess)h(x\))841 3271 y(\(guess-iter)h(x)d(0\)\))763
3454 y(\(define)h(\(guess-iter)i(x)e(g\))841 3545 y(\(if)g(\(=)g(x)f
(g\))998 3637 y(g)998 3728 y(\(guess-iter)j(x)d(\(+)h(g)f
(\(true-choose)j('\(-1)e(0)g(1\)\)\)\)\)\))763 3862 y
Fv(W)m(ith)23 b Fo(true-choose)k Fv(de\002ned)f(as)f(abo)o(v)o(e,)h
Fo(\(guess)41 b Fa(n)p Fo(\))25 b Fv(w)o(ould)g(only)h(terminate)e(for)
h(non\255)763 3953 y(positi)n(v)o(e)19 b Fa(n)p Fv(.)763
4055 y(Ho)n(w)h(we)f(de\002ne)h(a)g(correct)g Fa(c)o(hoose)h
Fv(also)f(depends)i(on)e(what)g(we)f(call)h(a)g(choice)g(point.)30
b(This)763 4147 y(v)o(ersion)d(treats)e(each)i(\(te)o(xtual\))g(call)f
(to)g Fo(true-choose)i Fv(as)f(a)f(choice)h(point.)50
b(That)26 b(might)763 4238 y(be)21 b(too)g(restricti)n(v)o(e)f(for)g
(some)i(applications.)33 b(F)o(or)20 b(e)o(xample,)i(if)e
Fo(two-numbers)j Fv(\(page)e(291\))763 4329 y(used)h(this)f(v)o(ersion)
h(of)f Fa(c)o(hoose)p Fv(,)i(it)d(w)o(ould)j(ne)n(v)o(er)f(return)f
(the)h(same)f(pair)h(of)f(numbers)h(twice,)763 4421 y(e)n(v)o(en)c(if)e
(it)h(w)o(as)g(called)g(by)h(se)n(v)o(eral)g(dif)n(ferent)f(functions.)
27 b(That)17 b(might)g(or)h(might)f(not)g(be)h(what)763
4512 y(we)g(w)o(ant,)h(depending)i(on)f(the)f(application.)763
4614 y(Note)f(also)h(that)f(this)g(v)o(ersion)h(is)g(intended)g(for)f
(use)h(only)g(in)g(compiled)g(code.)28 b(In)18 b(interpreted)763
4705 y(code,)30 b(the)e(macro)g(call)g(might)g(be)g(e)o(xpanded)i
(repeatedly)-5 b(,)31 b(each)d(time)g(generating)h(a)e(ne)n(w)763
4797 y(gensymed)20 b(tag.)609 4909 y(305)43 b(W)-6 b(oods,)18
b(W)m(illiam)f(A.)27 b(T)m(ransition)18 b(Netw)o(ork)h(Grammars)g(for)f
(Natural)g(Language)i(Analysis.)763 5001 y Fa(CA)n(CM)e
Fv(3,)g(10)i(\(October)f(1970\),)h(pp.)f(591\255606.)p
eop
%%Page: 398 411
398 410 bop 555 538 a FA(398)1121 b Fu(NO)n(TES)609 801
y Fv(312)43 b(The)19 b(original)i Fu(A)-7 b(TN)19 b Fv(system)i
(included)g(operators)f(for)g(manipulating)h(re)o(gisters)f(on)g(the)g
(stack)763 892 y(while)14 b(in)g(a)g(sub\255netw)o(ork.)27
b(These)14 b(could)h(easily)f(be)h(added,)h(b)o(ut)e(there)g(is)g(also)
g(a)h(more)f(general)763 983 y(solution:)36 b(to)24 b(insert)f(a)h
(lambda\255e)o(xpression)h(to)f(be)f(applied)i(to)e(the)h(re)o(gister)f
(stack)h(directly)763 1075 y(into)h(the)h(code)g(of)f(an)h(arc)g(body)
-5 b(.)48 b(F)o(or)24 b(e)o(xample,)k(if)d(the)h(node)g
Fo(mods)g Fv(\(page)g(316\))h(had)f(the)763 1166 y(follo)n(wing)19
b(line)g(inserted)g(into)g(the)g(body)h(of)f(its)f(outgoing)j(arc,)763
1318 y Fo(\(defnode)41 b(mods)841 1409 y(\(cat)f(n)g(mods/n)919
1501 y(\(\(lambda)i(\(regs\))1037 1592 y(\(append)f(\(butlast)g(regs\))
f(\(setr)h(a)e(1)h(\(last)g(regs\)\)\)\)\))919 1683 y(\(setr)h(mods)f
(*\)\)\))763 1835 y Fv(then)27 b(follo)n(wing)g(the)f(arc)h(\(ho)n(we)n
(v)o(er)h(deep\))f(w)o(ould)h(set)e(the)h(the)g(topmost)g(instance)g
(of)g(the)763 1927 y(re)o(gister)18 b Fo(a)h Fv(\(the)g(one)h(visible)f
(when)g(tra)o(v)o(ersing)g(the)g(topmost)g Fu(A)-7 b(TN)p
Fv(\))19 b(to)g Fo(1)p Fv(.)609 2048 y(323)43 b(If)18
b(necessary)-5 b(,)20 b(it)e(w)o(ould)h(be)g(easy)g(to)g(modify)g(the)g
(Prolog)g(to)f(tak)o(e)h(adv)n(antage)i(of)e(an)f(e)o(xisting)763
2140 y(database)d(of)g(f)o(acts.)25 b(The)15 b(solution)g(w)o(ould)g
(be)g(to)g(mak)o(e)g Fo(prove)g Fv(\(page)h(336\))f(a)g(nested)g
Fa(c)o(hoose:)763 2292 y Fo(\(=defun)40 b(prove)h(\(query)f(binds\))841
2383 y(\(choose)959 2474 y(\(choose-bind)i(b2)d(\(lookup)i(\(car)f
(query\))h(\(cdr)f(query\))h(binds\))1037 2566 y(\(=values)g(b2\)\))959
2657 y(\(choose-bind)h(r)d(*rules*)1037 2748 y(\(=funcall)i(r)f(query)g
(binds\)\)\)\))609 2901 y Fv(325)j(T)-6 b(o)18 b(test)h(quickly)h
(whether)f(there)g(is)g(an)o(y)g(match)h(for)f(a)g(query)-5
b(,)19 b(you)h(could)g(use)f(the)g(follo)n(wing)763 2992
y(macro:)763 3144 y Fo(\(defmacro)41 b(check)f(\(expr\))841
3235 y(`\(block)h(nil)959 3327 y(\(with-inference)h(,expr)1037
3418 y(\(return)f(t\)\)\)\))609 3570 y Fv(344)i(The)19
b(e)o(xamples)i(in)e(this)g(section)h(are)g(translated)g(from)g(ones)g
(gi)n(v)o(en)g(in:)28 b(Sterling,)19 b(Leon,)h(and)763
3661 y(Ehud)f(Shapiro.)27 b Fa(The)18 b(Art)g(of)h(Pr)m(olo)o(g:)g
(Advanced)h(Pr)m(o)o(gr)o(amming)f(T)-7 b(ec)o(hniques.)28
b Fv(MIT)19 b(Press,)763 3753 y(Cambridge,)g(1986.)609
3874 y(349)43 b(The)30 b(lack)g(of)g(a)g(distinct)g(name)h(for)f(the)g
(concepts)i(underlying)f(Lisp)f(may)h(be)f(a)g(serious)763
3966 y(barrier)21 b(to)g(the)h(language')l(s)h(acceptance.)36
b(Someho)n(w)23 b(one)f(can)g(say)g(\223W)-6 b(e)21 b(need)h(to)g(use)g
(C++)763 4057 y(because)17 b(we)f(w)o(ant)g(to)g(do)g
(object\255oriented)h(programming,)-5 b(\224)18 b(b)o(ut)e(it)f(doesn')
o(t)h(sound)h(nearly)g(as)763 4148 y(con)m(vincing)i(to)e(say)h(\223W)
-6 b(e)17 b(need)h(to)g(use)g(Lisp)f(because)h(we)g(w)o(ant)f(to)h(do)g
(Lisp)f(programming.)-5 b(\224)763 4255 y(T)f(o)20 b(administrati)n(v)o
(e)i(ears,)f(this)g(sounds)h(lik)o(e)g(circular)f(reasoning.)34
b(Such)22 b(ears)f(w)o(ould)h(rather)763 4346 y(hear)f(that)f(Lisp')l
(s)h(v)n(alue)g(hinged)h(on)g(a)f(single,)g(easily)g(understood)h
(concept.)34 b(F)o(or)21 b(years)g(we)763 4438 y(ha)o(v)o(e)k(tried)g
(to)g(oblige)h(them,)g(with)f(little)f(success.)47 b(Lisp)24
b(has)i(been)g(described)g(as)f(a)h(\223list\255)763
4529 y(processing)19 b(language,)-5 b(\224)20 b(a)f(language)h(for)e
(\223symbolic)i(computation,)-5 b(\224)19 b(and)g(most)g(recently)-5
b(,)19 b(a)763 4620 y(\223dynamic)j(language.)-5 b(\224)35
b(None)22 b(of)f(these)h(phrases)g(captures)g(more)f(than)h(a)f
(fraction)h(of)f(what)763 4711 y(Lisp)16 b(is)g(about.)27
b(When)16 b(retailed)g(through)i(colle)o(ge)f(te)o(xtbooks)h(on)f
(programming)h(languages,)763 4803 y(the)o(y)h(become)h(positi)n(v)o
(ely)f(misleading.)763 4909 y(Ef)n(forts)14 b(to)h(sum)g(up)g(Lisp)g
(in)f(a)h(single)g(phrase)h(are)f(probably)h(doomed)g(to)f(f)o(ailure,)
h(because)g(the)763 5001 y(po)n(wer)22 b(of)f(Lisp)g(arises)h(from)f
(the)h(combination)h(of)f(at)f(least)g(\002v)o(e)g(or)h(six)f
(features.)35 b(Perhaps)p eop
%%Page: 399 412
399 411 bop 1802 538 a Fu(NO)n(TES)1122 b FA(399)763
801 y Fv(we)25 b(should)i(resign)f(ourselv)o(es)g(to)f(the)h(f)o(act)g
(that)f(the)h(only)g(accurate)g(name)g(for)g(what)f(Lisp)763
892 y(of)n(fers)19 b(is)f Fa(Lisp)p Fv(.)609 1017 y(352)43
b(F)o(or)21 b(ef)n(\002cienc)o(y)-5 b(,)23 b Fo(sort)g
Fv(doesn')o(t)g(guarantee)g(to)f(preserv)o(e)h(the)g(order)f(of)h
(sequence)g(elements)763 1108 y(judged)h(equal)g(by)g(the)f(function)i
(gi)n(v)o(en)f(as)f(the)h(second)g(ar)o(gument.)41 b(F)o(or)23
b(e)o(xample,)i(a)e(v)n(alid)763 1199 y(Common)c(Lisp)g(implementation)
h(could)f(do)h(this:)763 1357 y Fo(>)39 b(\(let)h(\(\(v)g(#\(\(2)g(.)g
(a\))f(\(3)h(.)f(b\))h(\(1)g(.)f(c\))h(\(1)g(.)f(d\)\)\)\))919
1448 y(\(sort)i(\(copy-seq)g(v\))f(#'<)g(:key)g(#'car\)\))763
1540 y(#\(\(1)g(.)f(D\))h(\(1)g(.)f(C\))h(\(2)f(.)h(A\))f(\(3)h(.)g
(B\)\))763 1697 y Fv(Note)18 b(that)h(the)g(relati)n(v)o(e)g(order)g
(of)g(the)g(\002rst)f(tw)o(o)h(elements)h(has)f(been)h(re)n(v)o(ersed.)
763 1805 y(The)27 b(b)o(uilt\255in)f Fo(stable-sort)j
Fv(pro)o(vides)g(a)e(w)o(ay)g(of)g(sorting)h(which)f(w)o(on')o(t)h
(reorder)f(equal)763 1897 y(elements:)763 2054 y Fo(>)39
b(\(let)h(\(\(v)g(#\(\(2)g(.)g(a\))f(\(3)h(.)f(b\))h(\(1)g(.)f(c\))h
(\(1)g(.)f(d\)\)\)\))919 2146 y(\(stable-sort)j(\(copy-seq)g(v\))d(#'<)
h(:key)g(#'car\)\))763 2237 y(#\(\(1)g(.)f(C\))h(\(1)g(.)f(D\))h(\(2)f
(.)h(A\))f(\(3)h(.)g(B\)\))763 2395 y Fv(It)30 b(is)h(a)h(common)g
(error)g(to)f(assume)h(that)f Fo(sort)h Fv(w)o(orks)g(lik)o(e)g
Fo(stable-sort)p Fv(.)66 b(Another)763 2486 y(common)28
b(error)f(is)g(to)g(assume)h(that)f Fo(sort)h Fv(is)f(nondestructi)n(v)
o(e.)54 b(In)27 b(f)o(act,)i(both)f Fo(sort)g Fv(and)763
2577 y Fo(stable-sort)21 b Fv(can)e(alter)g(the)g(sequence)i(the)o(y)e
(are)g(told)h(to)f(sort.)27 b(If)18 b(you)i(don')o(t)g(w)o(ant)f(this)g
(to)763 2669 y(happen,)25 b(you)g(should)f(sort)f(a)h(cop)o(y)-5
b(.)41 b(The)24 b(call)f(to)g Fo(stable-sort)j Fv(in)d
Fo(get-ancestors)j Fv(is)763 2760 y(safe)19 b(because)h(the)f(list)f
(to)h(be)g(sorted)g(has)g(been)h(freshly)f(made.)p eop
%%Page: 400 413
400 412 bop 555 538 a FA(400)1121 b Fu(NO)n(TES)p eop
%%Page: 401 414
401 413 bop 555 1608 2686 3 v 555 1816 a Fx(Index)555
2234 y Fo(aand)20 b Fv(191)555 2325 y Fo(abbrev)g Fv(214)555
2416 y Fo(abbrevs)g Fv(214)555 2508 y(abbre)n(viations)g(213)555
2599 y(Abelson,)f(Harold)h(18)555 2690 y(Abelson,)f(Julie)g(18)555
2782 y Fo(ablock)h Fv(193)555 2873 y(Abrahams,)f(P)o(aul)g(W)-7
b(.)18 b(391)555 2964 y Fo(:accessor)j Fv(365)555 3056
y(accumulators)f(23,)f(47,)g(394)555 3147 y Fo(acond)h
Fv(191)555 3238 y Fo(acond2)g Fv(198,)f(239)555 3330
y(Adams,)g(Norman)h(I.)e(396)555 3421 y Fo(after)i Fv(50)555
3512 y Fo(aif)f Fv(191)555 3604 y Fo(aif2)h Fv(198)555
3695 y Fo(alambda)g Fv(193)555 3786 y(Algol)f(8)555 3877
y Fo(allf)h Fv(169)555 3969 y Fo(:allocation)h Fv(367)555
4060 y Fo(always)f Fv(227)555 4151 y Fo(alrec)g Fv(205)555
4243 y(anaphora\227see)h(macros,)e(anaphoric)555 4334
y(A)p Fu(NSI)g Fv(Common)h(Lisp)e(ix)555 4425 y(antecedent)i(322)555
4517 y Fo(append)638 4608 y Fv(Prolog)f(implementation)h(331)555
4699 y Fo(append1)g Fv(45)555 4791 y Fo(apply)g Fv(13)638
4882 y(with)f(macros)g(110)638 4973 y(on)g Fo(&rest)h
Fv(parameters)g(137)2043 2234 y Fo(=apply)g Fv(267)2043
2325 y(arch)2126 2416 y(Lisp)e(as)h(8)2126 2508 y(bottom\255up)h
(program)g(as)f(4)2043 2599 y(architects)g(284)2043 2690
y(Armstrong,)g(Louis)g(vii)2043 2782 y(arti\002cial)f(intelligence)h(1)
2043 2873 y Fo(asetf)h Fv(223)2043 2964 y(assignment)2126
3056 y(macros)f(for)g(170)2126 3147 y(order)g(of)g(177)2126
3238 y(parallel)g(96)2126 3330 y(in)g(Prolog)g(343)2126
3421 y(and)g(referential)g(transparenc)o(y)h(198)2126
3512 y(see)f(also:)27 b(generalized)20 b(v)n(ariables)2043
3604 y Fo(assoc)g Fv(196)2043 3695 y Fu(A)-7 b(TN)p Fv(s)19
b(305)2126 3786 y(arc)g(types)g(311)2126 3877 y(correctness)h(of)f(312)
2126 3969 y(destructi)n(v)o(e)g(operations)h(in)f(313)2126
4060 y(lik)o(e)g(functional)g(programs)h(316)2126 4151
y(for)f(natural)g(language)h(305)2126 4243 y(nondeterminism)g(in)f(308)
2126 4334 y(operations)h(on)f(re)o(gister)g(stack)g(398)2126
4425 y(order)g(of)g(arcs)g(308)2126 4517 y(recursion)h(in)e(306)2126
4608 y(re)o(gisters)h(of)f(306,)i(312)2126 4699 y(represented)g(as)f
(functions)h(309)2126 4791 y(tracing)f(309)2043 4882
y Fo(atrec)h Fv(210)2043 4973 y(augmented)11 b(transition)g(netw)o
(orks\227see)g Fu(A)-7 b(TN)p Fv(s)1835 5229 y FA(401)p
eop
%%Page: 402 415
402 414 bop 555 538 a FA(402)1124 b Fu(INDEX)555 801
y Fv(Autocad)20 b(1,)f(5)555 892 y(automata)h(theory)f(292)555
983 y Fo(avg)g Fv(182)555 1075 y Fo(awhen)h Fv(191)555
1166 y Fo(awhen2)g Fv(198)555 1257 y Fo(awhile)g Fv(191)555
1349 y Fo(awhile2)g Fv(198)555 1560 y(backtraces)g(111)555
1651 y(backtracking)h(292)555 1743 y(backquote)g(\()p
Fo(`)p Fv(\))d(84)638 1834 y(in)h Fu(A)-7 b(TN)p Fv(s)19
b(307)638 1925 y(nested)h(214,)f(217,)g(395)555 2017
y Fo(bad-reverse)i Fv(29)555 2108 y(barbarians)f(283)555
2199 y(Basic)f(30,)g(33)555 2291 y(battle\002eld)g(8)555
2382 y Fo(before)h Fv(50)555 2473 y(Benson,)g(Eric)e(137)555
2564 y Fo(best)i Fv(52)555 2656 y(Bezier)f(curv)o(es)g(185)555
2747 y Fo(=bind)h Fv(267)555 2838 y Fo(binding)g Fv(239)555
2930 y(binding)g(lists)e(239)555 3021 y(bindings,)i(altering)f(107)555
3112 y(blackboards)i(281)555 3204 y Fo(block)f Fv(154)638
3295 y(implicit)e(131,)i(155)555 3386 y(block\255names)g(131)555
3478 y(body)g(\(of)f(e)o(xpressions\))h(87,)f(91,)g(87)555
3569 y(body)h(\(of)f(a)g(rule\))g(322)555 3660 y Fo(&body)h
Fv(87)555 3752 y(bookshops)h(41)555 3843 y(bottom\255up)f(design)g(v,)f
(3,)f(321)638 3934 y(and)i(functional)f(ar)o(guments)h(42)638
4026 y(and)g(incremental)f(testing)g(38)638 4117 y(and)h(shape)f(of)g
(programs)h(4)638 4208 y(multilayer)f(321)555 4300 y(bound\227see)i(v)n
(ariables,)e(bound)555 4391 y Fo(break-loop)i Fv(56)555
4482 y(bre)n(vity)e(viii,)g(43)555 4574 y(bricks,)g(furniture)g(made)h
(of)f(117)555 4665 y(Brooks,)g(Frederick)g(P)-8 b(.)18
b(5)555 4876 y(C)h(388)555 4968 y(C++)g(398)2043 801
y Fo(call-next-method)j Fv(200,)e(375)2126 892 y(sk)o(etch)g(of)f(358)
2043 983 y Fo(call-with-current-continuation)2292 1075
y Fv(\()p Fo(call/cc)p Fv(\))h(260)2126 1166 y(at)e(tople)n(v)o(el)i
(292)2043 1257 y(capital)f(e)o(xpenditures)h(43)2043
1349 y(capture)f(118)2126 1440 y(a)o(v)o(oiding)g(with)g(gensyms)h(128)
2126 1531 y(a)o(v)o(oiding)f(with)g(packages)h(130)2126
1623 y(a)o(v)o(oiding)f(by)g(prior)g(e)n(v)n(aluation)i(125)2126
1714 y(of)e(block)g(names)h(131)2126 1805 y(detecting)f(potential)h
(121)2126 1897 y(free)f(symbol)g(capture)h(119)2209 1988
y(a)o(v)o(oiding)f(125)2126 2079 y(of)g(function)g(names)h(131,)f(392)
2126 2171 y(intentional)g(190,)h(267,)f(313)2126 2262
y(macro)g(ar)o(gument)h(capture)f(118)2126 2353 y(of)g(tags)g(131)2043
2444 y Fo(case)g Fv(15)2043 2536 y Fo(>case)h Fv(152)2043
2627 y(case\255sensiti)n(vity)f(331)2043 2718 y(chains)g(of)g(closures)
h(76,)f(269)2043 2810 y(Chocoblobs)h(298)2043 2901 y
Fa(c)o(hoose)g Fv(287)2126 2992 y(e)o(xtent)f(of)g(291)2043
3084 y Fo(choose)2126 3175 y Fv(Common)h(Lisp)e(v)o(ersion)i(295)2126
3266 y(Scheme)f(v)o(ersion)h(293)2043 3358 y Fo(choose-bind)h
Fv(295)2043 3449 y(chronological)f(backtracking)h(292)2043
3540 y(classes)2126 3632 y(de\002ning)e(364)2126 3723
y(see)g(also:)27 b(superclasses)2043 3814 y(Clinger)m(,)18
b(W)m(illiam)g(395)2043 3906 y Fu(CLOS)g Fv(364)2126
3997 y(as)h(an)g(embedded)i(language)f(349,)g(377)2126
4088 y(see)29 b(also:)47 b(classes,)31 b(generic)e(functions,)2292
4180 y(methods,)19 b(slots)2043 4271 y(closed)g(w)o(orld)h(assumption)g
(249)2043 4362 y(closures)f(17,)g(62,)g(76)2043 4454
y Fu(CL)-5 b(TL)p Fv(\227see)13 b Fa(Common)j(Lisp:)25
b(the)16 b(Langua)o(g)o(e)2043 4545 y Fv(code\255w)o(alk)o(ers)k(237,)g
(273)2043 4636 y Fa(Common)f(Lisp:)27 b(the)19 b(Langua)o(g)o(e)i
Fv(ix)2043 4728 y(Common)f(Lisp)2126 4819 y(case\255sensiti)n(vity)f
(of)g(331)2126 4910 y(de\002nition)g(of)g(ix)p eop
%%Page: 403 416
403 415 bop 1805 538 a Fu(INDEX)1124 b FA(403)638 801
y Fv(dif)n(ferences)20 b(between)f(v)o(ersions)721 892
y(compilation)h(of)f(closures)g(25)721 983 y Fo(complement)i
Fv(62)721 1075 y Fo(defpackage)g Fv(384)721 1166 y Fo
(destructuring-bind)i Fv(93)721 1257 y Fo(dynamic-extent)f
Fv(150)721 1349 y(en)m(vironment)e(of)f(e)o(xpanders)i(96,)e(393)721
1440 y(no)14 b(e)o(xpansion)h(in)e(compiled)h(code)g(136)721
1531 y Fo(function-lambda-expression)d Fv(3)q(90)721
1623 y Fo(*gensym-counter*)22 b Fv(129)721 1714 y Fo(-if-not)e
Fv(deprecated)h(62)721 1805 y Fo(ignore-errors)h Fv(147)721
1897 y(in)m(v)o(ersions)e(from)f Fo(defun)h Fv(179)721
1988 y(Lisp)f(package)h(384)721 2079 y(name)g(of)e(user)i(package)g
(381)721 2171 y(rede\002ning)35 b(b)o(uilt\255in)e(operators)h(131,)804
2262 y(199)721 2353 y Fo(&rest)20 b Fv(parameters)f(not)h(fresh)f(137)
721 2444 y(symbol\255macros)h(205)721 2536 y Fo(with-slots)h
Fv(236)721 2627 y(see)e(also:)27 b Fu(CLOS)p Fv(,)18
b(series)638 2718 y(e)n(v)n(aluation)i(rule)f(392)638
2810 y(long)h(names)f(in)g(393)638 2901 y(vs.)27 b(Scheme)19
b(259)555 2992 y(Common)11 b(Lisp)g(Object)g(System\227see)g
Fu(CLOS)555 3084 y Fo(common-lisp)21 b Fv(384)555 3175
y Fo(common-lisp-user)h Fv(381)555 3266 y Fo(compall)e
Fv(388)555 3358 y(compilation)g(24)638 3449 y(bounds\255checking)i
(during)e(186)638 3540 y(computation)38 b(during)f(109,)k(181,)g(197,)
804 3632 y(254,)20 b(335)638 3723 y(of)f(embedded)i(languages)f(116,)g
(254)638 3814 y(errors)f(emer)o(ging)h(during)f(139)638
3906 y(inline)g(26,)g(109,)g(110)721 3997 y(testing)g(388)638
4088 y(of)g(local)g(functions)h(23,)f(25,)g(81,)g(346)638
4180 y(of)g(macro)g(calls)g(83,)g(101,)h(136)638 4271
y(of)f(netw)o(orks)h(79)638 4362 y(restrictions)f(on)g(25)638
4454 y(senses)h(of)f(346)638 4545 y(of)g(queries)g(254)638
4636 y(see)g(also:)27 b(tail\255recursion)19 b(optimization)555
4728 y Fo(compile)h Fv(24,)f(116,)h(388)555 4819 y Fo(compile-file)h
Fv(25)555 4910 y Fo(compiled-function-p)i Fv(24)2043
801 y Fo(complement)e Fv(62)2043 892 y Fo(compose)f Fv(66)2043
983 y(composition\227see)g(functions,)2292 1075 y(composition)g(of)2043
1166 y Fo(conc1)g Fv(45)2043 1257 y Fo(conc1f)g Fv(170,)f(174)2043
1349 y Fo(concf)h Fv(170)2043 1440 y Fo(concnew)g Fv(170)2043
1531 y(conditionals)g(108,)f(150)2043 1623 y Fo(condlet)h
Fv(146)2043 1714 y(congruent)g(parameter)g(lists)e(372)2043
1805 y(consequent)j(322)2043 1897 y(consing)2126 1988
y(a)o(v)o(oiding)e(31,)g(150,)h(197,)f(363)2043 2079
y(constitutional)g(amendments)i(391)2043 2171 y(constraints)e(332)2043
2262 y Fo(*cont*)h Fv(266)2043 2353 y(conte)o(xt)2126
2444 y(and)f(referential)g(transparenc)o(y)h(199)2126
2536 y(see)f(also:)27 b(en)m(vironments;)20 b(macros,)2292
2627 y(conte)o(xt\255creating)2043 2718 y(continuations)g(258)2126
2810 y(destructi)n(v)o(e)f(operations)h(in)f(261,)h(313)2126
2901 y(cost)f(of)g(284)2126 2992 y(see)11 b(also:)24
b Fo(call-with-current-con-)2292 3084 y(tinuation)2043
3175 y Fv(continuation\255passing)d(macros)f(266)2126
3266 y(use)f(in)g(multiprocessing)h(283)2126 3358 y(use)f(in)g
(nondeterministic)h(choice)g(296)2126 3449 y(restrictions)f(on)g(270)
2126 3540 y(and)g(tail\255recursion)g(optimization)h(298)2043
3632 y(continuation\255passing)h(style)e(\()p Fu(CPS)p
Fv(\))g(273)2043 3723 y(cookies)h(184)2043 3814 y Fo(copy-list)h
Fv(71,)e(206)2043 3906 y Fo(copy-tree)i Fv(71,)e(210)2043
3997 y(courtiers)g(375)2043 4088 y(cut)g(337)2126 4180
y(with)f Fa(fail)h Fv(342)2126 4271 y(green)g(339)2126
4362 y(red)g(339)2126 4454 y(in)g(Lisp)f(298)2043 4545
y Fo(cut)h Fv(301)2043 4756 y(databases)2126 4848 y(caching)h(updates)g
(to)f(179)2126 4939 y(locks)g(on)h(148)p eop
%%Page: 404 417
404 416 bop 555 538 a FA(404)1124 b Fu(INDEX)638 801
y Fv(natural)19 b(language)i(interf)o(aces)e(to)g(306)638
892 y(queries)g(on)39 b(246)638 983 y(representation)20
b(of)f(247)638 1075 y(with)g(Prolog)g(398)555 1166 y
Fo(dbind)h Fv(232)555 1257 y Fo(def!)28 b Fv(64)555 1349
y Fo(defanaph)21 b Fv(223)555 1440 y Fo(defclass)g Fv(364)555
1531 y Fo(defdelim)g Fv(228)555 1623 y Fo(defgeneric)g
Fv(371)555 1714 y Fo(define-modify-macro)i Fv(168)555
1805 y Fo(defmacro)e Fv(82,)e(95)555 1897 y Fo(defpackage)i
Fv(384)555 1988 y Fo(defprop)f Fv(354)555 2079 y Fo(defun)g
Fv(10,)f(113)638 2171 y(de\002ning)h(in)m(v)o(ersions)f(with)g(179)555
2262 y Fo(=defun)h Fv(267)555 2353 y Fo(defsetf)g Fv(178)555
2444 y Fo(delay)g Fv(211)555 2536 y Fo(delete-if)h Fv(64)555
2627 y(density)f(of)e(source)i(code)g(59,)f(389)555 2718
y Fo(destruc)h Fv(232)555 2810 y(destructi)n(v)o(e)g(operations)g(31,)f
(64)555 2901 y(destructuring)638 2992 y(on)g(arrays)h(234)638
3084 y(on)f(instances)h(236)638 3175 y(on)f(lists)g(230)638
3266 y(in)g(macros)g(93)638 3358 y(and)h(reference)f(236)638
3449 y(on)g(sequences)i(231)638 3540 y(on)e(structures)h(235)555
3632 y Fo(destructuring-bind)j Fv(93,)c(213,)g(230)555
3723 y Fo(differences)i Fv(207)555 3814 y Fo(disassemble)g
Fv(388)555 3906 y(dispatching)f(370,)g(371)555 3997 y
Fo(do)f Fv(98)638 4088 y(implicit)f Fo(block)i Fv(in)f(131)638
4180 y(multiple\255v)n(alued)h(v)o(ersion)g(162)638 4271
y(order)f(of)g(e)n(v)n(aluation)i(in)d(392)555 4362 y
Fo(do-file)i Fv(199)555 4454 y Fo(do-symbols)h Fv(388,)e(393)555
4545 y Fo(do-tuples/c)i Fv(156)555 4636 y Fo(do-tuples/o)g
Fv(156)555 4728 y Fo(do*)e Fv(97)638 4819 y(multiple\255v)n(alued)h(v)o
(ersion)g(159)555 4910 y Fo(dolist)g Fv(94)2126 801 y(generalization)g
(of)f(156)2043 892 y(Dolphin)g(Seafood)h(219)2043 983
y(dotted)f(lists)f(70,)h(390)2043 1075 y Fo(duplicate)i
Fv(50)2043 1166 y(dynamic)f(e)o(xtent)f(127,)g(150)2043
1257 y(dynamic)h(languages)g(398)2043 1349 y(dynamic)g(scope)g(16)2043
1560 y(Edw)o(ards,)f(Daniel)g(J.)f(391)2043 1651 y Fo(elt)h
Fv(244)2043 1743 y(Emacs\227see)g(Gnu)g(Emacs)2043 1834
y(embedded)i(languages)f(7,)f(188,)g(246)2126 1925 y
Fu(A)-7 b(TN)p Fv(s)19 b(as)g(309)2126 2017 y(bene\002ts)g(of)g
(110,116,)h(246,)g(377)2126 2108 y(borderline)g(of)f(246)2126
2199 y(compilation)h(of)e(116)2126 2291 y(not)h(quite)g(compilers)g
(346)2126 2382 y(implementation)h(of)f(116)2126 2473
y(for)g(multiprocessing)h(275)2126 2564 y(Prolog)f(as)g(321)2126
2656 y(query)h(languages)g(as)f(246)2126 2747 y(see)g(also:)27
b Fu(CLOS)2043 2838 y Fv(end\255of\255\002le)19 b(\(eof\))g(197,)g(225)
2043 2930 y(English)g(306)2043 3021 y(en)m(vironment)2126
3112 y(ar)o(gument)g(95)2126 3204 y(interacti)n(v)o(e)g(8)2126
3295 y(of)g(macro)g(e)o(xpanders)i(96,)e(393)2126 3386
y(of)g(macro)g(e)o(xpansions)i(108)2126 3478 y(null)e(96,)g(278,)g(394)
2043 3569 y Fo(error)h Fv(148)2043 3660 y(error)o(\255checking)g(45)
2043 3752 y Fo(eval)2126 3843 y Fv(e)o(xplicit)f(34,)g(163,)g(197,)g
(278)2126 3934 y(on)g(macroe)o(xpansions)j(92)2126 4026
y(sk)o(etch)e(of)f(391)2043 4117 y(e)n(v)n(aluation)2126
4208 y(a)o(v)o(oiding)g(151,)g(181)2126 4300 y(lazy)g(211)2126
4391 y(order)g(of)2209 4482 y(in)g(Common)h(Lisp)e(135)2209
4574 y(in)h(Scheme)g(259)2126 4665 y(sk)o(etch)h(of)f(391)2043
4756 y(e)n(v)n(aluation)h(rule)f(392)2043 4848 y Fo(evenp)h
Fv(14)2043 4939 y(e)n(v)o(olution)p eop
%%Page: 405 418
405 417 bop 1805 538 a Fu(INDEX)1124 b FA(405)638 801
y Fv(design)20 b(by)f(1)638 892 y(of)g(Lisp)f(158)638
983 y(of)h(programming)h(languages)h(8)555 1075 y(e)o(xpander)f(code)g
(99)555 1166 y(e)o(xpansion)h(code)e(99)555 1257 y Fo(explode)h
Fv(58)555 1349 y(e)o(xploratory)g(programming)g(1,)f(284)555
1440 y Fo(export)h Fv(383)555 1531 y Fo(:export)g Fv(384)555
1623 y Fo(expt)g Fv(32)555 1714 y(e)o(xtensibility)f(5)638
1805 y(of)g(object\255oriented)h(programs)g(16,)f(379)555
1897 y(e)o(xtent,)g(dynamic)h(127,)f(150)p 560 2108 24
4 v 583 2108 a Fo(f)g Fv(173,)h(222)555 2199 y(f)o(actions)f(167)555
2291 y(f)o(actorials)g(343,)g(387)555 2382 y Fa(fail)f
Fv(287)555 2473 y Fo(fail)638 2564 y Fv(Common)i(Lisp)e(v)o(ersion)i
(295)638 2656 y(Scheme)f(v)o(ersion)h(293)555 2747 y(f)o(ailure)f(195)
555 2838 y Fo(fboundp)h Fv(388)555 2930 y Fo(fif)f Fv(67)555
3021 y Fo(filter)h Fv(47)638 3112 y(simpler)f(v)o(ersion)g(389)555
3204 y Fo(find2)h Fv(50)638 3295 y(e)n(v)o(olution)g(of)f(41)555
3386 y Fo(find-if)h Fv(41,)f(195)638 3478 y(sk)o(etch)h(of)f(206)638
3569 y(v)o(ersion)h(for)e(trees)h(73)555 3660 y(\002nished)g(programs)h
(285)555 3752 y Fo(fint)g Fv(67)555 3843 y Fo(flatten)g
Fv(47,)f(72,)g(210)638 3934 y(simpler)g(v)o(ersion)g(389)555
4026 y(Flo)o(yd,)g(Robert)g(W)-7 b(.)18 b(293)555 4117
y Fo(fmakunbound)j Fv(373)555 4208 y Fo(fn)e Fv(202,)h(229)555
4300 y(F)o(oderaro,)f(John)h(K.)e(v)555 4391 y Fo(for)h
Fv(154)555 4482 y Fo(force)h Fv(211)555 4574 y(F)o(ortran)f(8)555
4665 y(free\227see)g(v)n(ariables,)g(free)555 4756 y
Fo(fullbind)i Fv(324)555 4848 y(fun)e(x)555 4939 y Fo(fun)g
Fv(67)2043 801 y Fo(funcall)h Fv(13,)f(259)2043 892 y
Fo(=funcall)h Fv(267)2043 983 y(function)g(calls,)e(a)o(v)o(oiding)2126
1075 y(by)h(inline)g(compilation)h(26)2126 1166 y(with)e(macros)i(109)
2126 1257 y(by)f(tail)f(recursion)i(23)2043 1349 y(functional)f(interf)
o(aces)h(35)2043 1440 y(functional)f(programs)h(28)2126
1531 y(almost)f(35)2126 1623 y(and)g(bottom\255up)h(programming)h(37)
2126 1714 y(from)e(imperati)n(v)o(e)g(ones)h(33)2126
1805 y(shape)g(of)f(30)2043 1897 y(functions)2126 1988
y(as)g(ar)o(guments)g(13,)g(42,)h(177)2126 2079 y(constant)g(226)2126
2171 y(closures)f(of)g(17,)g(62,)g(76)2209 2262 y(use)d(in)h
(nondeterministic)g(choice)g(296)2209 2353 y(stack)i(allocation)g(of)g
(150)2126 2444 y(combined)h(with)f(macros)g(141,)h(149,)f(266)2126
2536 y(compiled)h(24)2126 2627 y(composition)g(of)f(66,)g(201,)g(228)
2126 2718 y(as)g(a)g(data)g(type)g(9)2126 2810 y(de\002ning)g(10)2126
2901 y(\002lleting)f(115)2126 2992 y(generating)i(recursi)n(v)o(e)f
(68,)h(204)2126 3084 y(generic\227see)g(generic)f(functions)2126
3175 y(internal)g(172)2126 3266 y(interpreted)g(24)2126
3358 y(as)g(lists)f(27)2126 3449 y(literal)g(11)2209
3540 y(recursi)n(v)o(e)h(21,)g(193)2126 3632 y(local)g(21)2126
3723 y(vs.)27 b(macros)19 b(109)2126 3814 y(names)g(of)g(11,)g(213)2126
3906 y(as)g(properties)g(15)2126 3997 y(rede\002ning)g(b)o(uilt\255in)g
(131,)g(174)2126 4088 y(as)g(return)g(v)n(alues)h(17,)f(61,)g(76,)g
(201)2126 4180 y(set)g(operations)g(on)h(67,)f(201)2126
4271 y(with)f(state)h(18,)g(65)2126 4362 y(tail\255recursi)n(v)o(e)g
(23)2126 4454 y(transforming)g(into)g(macros)h(102)2126
4545 y(unde\002ning)g(373)2126 4636 y(see)k(also:)37
b(compilation;)27 b Fo(defgeneric)p Fv(;)2292 4728 y
Fo(defun)p Fv(;)19 b Fo(labels)2043 4819 y(function-lambda-expression)
24 b Fv(390)p eop
%%Page: 406 419
406 418 bop 555 538 a FA(406)1124 b Fu(INDEX)555 801
y Fv(Gabriel,)18 b(Richard)i(P)-8 b(.)17 b(23)555 892
y(garbage)638 983 y(a)o(v)o(oiding\227see)i(consing,)h(a)o(v)o(oiding)
638 1075 y(collection)f(8,)g(81)555 1166 y(generalized)h(v)n(ariables)g
(107,)f(165)638 1257 y(meaning)h(of)f(179)638 1349 y(see)g(also:)27
b(in)m(v)o(ersions)555 1440 y(generic)20 b(functions)f(371)638
1531 y(de\002ning)h(371)638 1623 y(remo)o(ving)g(373)638
1714 y(see)f(also:)27 b(methods)555 1805 y Fo(gensym)20
b Fv(128)638 1897 y(to)f(indicate)g(f)o(ailure)g(197)638
1988 y(as)g(unbound)i(244,)f(330)555 2079 y Fo(gensym?)g
Fv(243)555 2171 y Fo(*gensym-counter*)i Fv(129)555 2262
y Fo(gentemp)e Fv(392)555 2353 y(Gelernter)m(,)f(Da)o(vid)f(H.)h(198)
555 2444 y Fo(get)g Fv(63)555 2536 y Fo(gethash)h Fv(196)638
2627 y(recursi)n(v)o(e)g(v)o(ersion)f(350)555 2718 y
Fo(get-setf-method)j Fv(171)555 2810 y(gift\255shops,)d(airport)g(278)
555 2901 y(Gnu)g(Emacs)g(1,)g(5)555 2992 y Fo(go)g Fv(100,)h(155)555
3084 y(gods)g(8)555 3175 y(gold)g(386)555 3266 y Fo(good-reverse)h
Fv(30)555 3358 y Fo(group)f Fv(47)638 3449 y(simpler)f(v)o(ersion)g
(389)555 3660 y(Hart,)f(T)m(imothy)h(P)-8 b(.)18 b(391)555
3752 y(hash)i(tables)f(65,)g(247,)g(350)555 3843 y(head)h(322)555
3934 y(hiding)g(implementation)f(details)g(216,)h(382)555
4026 y(hygienic)g(macros)f(392)555 4237 y(ice\255cream)g(370)555
4328 y(ice\255skating)h(33)555 4420 y Fo(if3)f Fv(150)555
4511 y Fo(if-match)i Fv(242)555 4602 y Fo(ignore-errors)h
Fv(147)555 4694 y(Igor)d(289)555 4785 y(imperati)n(v)o(e)g(programming)
i(33)555 4876 y Fo(import)f Fv(383)555 4968 y Fo(in)f
Fv(152)2043 801 y Fo(incf)g Fv(171)2126 892 y(generalization)h(of)f
(173)2043 983 y(incremental)g(testing)g(37)2043 1075
y(inde)o(xing)h(249)2043 1166 y(inheritance)2126 1257
y(single)f(196)2126 1349 y(of)g(slots)f(366)2126 1440
y(multiple)h(366)2209 1531 y(sk)o(etch)h(of)f(351)2043
1623 y Fo(in-if)h Fv(152)2043 1714 y Fo(:initarg)g Fv(365)2043
1805 y Fo(:initform)h Fv(365)2043 1897 y Fo(in-package)g
Fv(382)2043 1988 y Fo(inq)e Fv(152)2043 2079 y(instances)g(365)2043
2171 y(intellectuals)g(374)2043 2262 y(interacti)n(v)o(e)g(de)n(v)o
(elopment)i(37,)e(316)2043 2353 y(interacti)n(v)o(e)g(en)m(vironment)h
(8)2043 2444 y(intercourse,)f(le)o(xical)g(108)2043 2536
y(Interleaf)g(1,)f(5)2043 2627 y Fo(intern)i Fv(128,)f(136,)h(266)2043
2718 y(interning)f(128,)h(136,)f(381)2043 2810 y Fo(intersection)i
Fv(207)2043 2901 y Fo(intersections)g Fv(207)2043 2992
y(in)m(v)o(ersions)2126 3084 y(asymmetric)e(179)2126
3175 y(de\002ning)g(178)2126 3266 y(see)g(also:)27 b(generalized)20
b(v)n(ariables)2043 3358 y(iteration)2126 3449 y(macros)f(for)g(108,)h
(154)2126 3540 y(vs.)f(nondeterministic)h(choice)f(291,)h(325)2126
3632 y(without)f(loops)g(264,)h(325)2043 3843 y(Jagannathan,)g(Suresh)f
(198)2043 3934 y(jazz)g(vii)2043 4026 y Fo(joiner)h Fv(62)2043
4117 y(jok)o(e,)f(practical\227see)g(Nitzber)o(g,)g(Mark)2043
4328 y(k)o(e)o(yw)o(ords)h(386)2043 4540 y Fo(labels)g
Fv(21)2043 4631 y Fo(lambda)g Fv(11)2043 4722 y Fo(=lambda)g
Fv(267)2043 4814 y(lambda\255e)o(xpressions)h(11,)e(21)2043
4905 y Fo(last)g Fv(45)2043 4996 y Fo(last1)h Fv(45)p
eop
%%Page: 407 420
407 419 bop 1805 538 a Fu(INDEX)1124 b FA(407)555 801
y Fv(Latin)18 b(306)555 892 y(la)o(wyers)h(298)555 983
y Fo(let)g Fv(144,)h(199)555 1075 y Fo(let*)g Fv(172)555
1166 y(lengths)g(of)e(programs)i(387)555 1257 y(Le)n(vin,)f(Michael)g
(I.)g(391)555 1349 y(le)o(xical)g(scope)h(16)555 1440
y(life,)e(meaning)i(of)f(197)555 1531 y(lions)g(37)555
1623 y(Lisp)638 1714 y(1.5)g(95)638 1805 y(de\002ning)h(features)f(of)g
(1,)f(8,)h(349,)h(398)638 1897 y(inte)o(gration)f(with)g(user)g
(programs)h(110)638 1988 y(slo)n(wness)g(of)f(285)638
2079 y(speed)h(of)f(388)638 2171 y(see)g(also)g(Common)h(Lisp,)e
(Scheme,)h(T)555 2262 y(lists)638 2353 y(accumulating)h(47)638
2444 y(as)f(binary)h(trees)e(70)638 2536 y(as)h(code)h(116)638
2627 y(decreased)g(role)f(of)g(44)638 2718 y(disambiguating)11
b(return)g(v)n(alues)g(with)g(196)638 2810 y(dotted)20
b(390)638 2901 y(as)f(f)o(acts)g(247)638 2992 y(\003at\227see)f
Fo(flatten)638 3084 y Fv(interlea)o(ving)h(160)638 3175
y(operating)h(on)f(end)h(of)f(170)638 3266 y(quoted)h(37)638
3358 y(recursers)f(on)h(68,)f(204)638 3449 y(as)g(trees)g(262)638
3540 y(uses)g(for)g(70)555 3632 y(list)f(processing)i(44,)f(398)555
3723 y(locality)g(36)555 3814 y(logic)g(programs)h(334)555
3906 y Fo(longer)g Fv(47)638 3997 y(simpler)f(v)o(ersion)g(389)555
4088 y Fo(loop)h Fv(154)555 4180 y(loops)638 4271 y(interrupting)g(154)
638 4362 y(see)f(also:)27 b(iteration)555 4454 y Fo(lrec)20
b Fv(69)555 4665 y(McCarthy)-5 b(,)19 b(John)h(1,)f(391)555
4756 y Fo(mac)g Fv(92)555 4848 y Fo(macroexpand)i Fv(91)555
4939 y Fo(macroexpand-1)h Fv(91)2043 801 y(macro\255characters\227see)e
(read\255macros)2043 892 y(macros)f(82)2126 983 y(as)g(abbre)n
(viations)h(213)2126 1075 y(access)f(167,)h(216)2126
1166 y(anaphoric)g(189)2209 1257 y(de\002ning)f(automatically)h(218)
2209 1349 y(for)f(distinguishing)i(f)o(ailure)f(from)g(f)o(al\255)2292
1440 y(sity)f(195)2209 1531 y(for)27 b(generating)g(recursi)n(v)o(e)h
(functions)2292 1623 y(204)2209 1714 y(multiple\255v)n(alued)20
b(198)2209 1805 y(and)f(referential)g(transparenc)o(y)h(198)2209
1897 y(see)f(also:)27 b Fo(call-next-method)2126 1988
y Fv(and)19 b Fo(apply)h Fv(110)2126 2079 y(applications)g(of)f(111)
2126 2171 y(ar)o(guments)g(to)g(107)2126 2262 y(for)g(b)o(uilding)g
(functions)h(201)2126 2353 y(calls)e(in)m(v)o(ertible)h(166,)h(216)2126
2444 y(clarity)e(99,)h(233)2126 2536 y(and)g Fu(CLOS)g
Fv(378)2126 2627 y(for)g(computation)h(at)f(compile\255time)g(181)2126
2718 y(conte)o(xt\255creating)h(143)2126 2810 y(combined)37
b(with)f(functions)h(141,)j(149,)2292 2901 y(266)2126
2992 y(compiled)20 b(83,)f(101,)g(136)2126 3084 y(comple)o(x)h(96)2126
3175 y(de\002ning)f(82)2126 3266 y(ef)n(\002cienc)o(y)g(99)2126
3358 y(en)m(vironment)h(ar)o(gument)g(to)f(95)2126 3449
y(en)m(vironment)h(of)f(e)o(xpander)i(96,)e(393)2126
3540 y(en)m(vironment)h(of)f(e)o(xpansion)i(108)2126
3632 y(errors)e(in)2209 3723 y(modifying)h(ar)o(guments)f(137)2209
3814 y(modifying)h(e)o(xpansions)g(139)2209 3906 y(non\255functional)g
(e)o(xpanders)h(136)2209 3997 y(nonterminating)f(e)o(xpansion)h(139)
2209 4088 y(number)f(of)f(e)n(v)n(aluations)h(133,)f(167)2209
4180 y(order)g(of)g(e)n(v)n(aluation)h(135)2209 4271
y(see)f(also:)27 b(capture)2126 4362 y(e)o(xpansion)20
b(of)f(83)2209 4454 y(in)g(compiled)g(code)h(136)2209
4545 y(multiple)f(136,)g(138)2209 4636 y(non\255terminating)h(139)2209
4728 y(testing)f(92)2209 4819 y(time)f(of)h(83)2126 4910
y(from)g(functions)h(102)p eop
%%Page: 408 421
408 420 bop 555 538 a FA(408)1124 b Fu(INDEX)638 801
y Fv(vs.)27 b(functions)20 b(109)638 892 y(hygienic)g(392)638
983 y(justi\002cation)f(of)g(392)638 1075 y(macro\255de\002ning)h(213,)
g(266)638 1166 y(parameter)f(lists)g(93)638 1257 y(position)h(in)e
(source)i(code)g(102,)f(266)638 1349 y(as)g(programs)h(96)638
1440 y(proportion)g(in)f(a)g(program)h(117)638 1531 y(recursion)g(in)f
(139)638 1623 y(rede\002ning)h(101,)f(138)721 1714 y(b)o(uilt\255in)f
(199)638 1805 y(simple)h(88)638 1897 y(sk)o(eletons)h(of)f(121)638
1988 y(style)g(for)g(99)638 2079 y(testing)g(91)638 2171
y(unique)h(po)n(wers)g(of)f(106)638 2262 y(when)h(to)e(use)i(106)638
2353 y(see)f(also:)27 b(backquote,)21 b(read\255macros,)804
2444 y(symbol\255macros)555 2536 y(mainframes)e(348)555
2627 y Fo(make-dispatch-macro-character)12 b Fv(22)q(6)555
2718 y Fo(make-instance)22 b Fv(365)555 2810 y Fo(make-hash-table)g
Fv(65)555 2901 y Fo(make-string)f Fv(58)555 2992 y Fo(map->)f
Fv(54)555 3084 y Fo(map0-n)g Fv(54)555 3175 y Fo(map1-n)g
Fv(54)555 3266 y Fo(mapa-b)g Fv(54,)f(228)555 3358 y
Fo(mapc)h Fv(163)555 3449 y Fo(mapcan)g Fv(41,)f(46)638
3540 y(nondestructi)n(v)o(e)i(v)o(ersion)e(55)638 3632
y(sk)o(etch)h(of)f(55)555 3723 y Fo(mapcar)h Fv(13)638
3814 y(v)o(ersion)g(for)e(multiple)h(lists)f(55)638 3906
y(v)o(ersion)i(for)e(trees)h(55)555 3997 y Fo(mapcars)h
Fv(54)555 4088 y Fo(mapcon)g Fv(176,)f(218)555 4180 y
Fo(mappend)h Fv(54)555 4271 y Fo(mappend)p Fv(\255)p
Fo(mklist)i Fv(idiom)d(160)555 4362 y(mapping)h(functions)g(53)555
4454 y Fo(mark)g Fv(301)555 4545 y Fo(match)g Fv(239)555
4636 y(matching\227see)g(pattern\255matching)555 4728
y Fo(maxmin)g Fv(207)555 4819 y(Meehan,)g(James)f(R.)g(396)555
4910 y Fo(member)h Fv(88)2126 801 y(misuse)f(of)g(151)2126
892 y(Prolog)g(implementation)h(332)2126 983 y(returns)f(a)g(cdr)g(50)
2043 1075 y(Miller)m(,)f(Molly)h(M.)g(137)2043 1166 y
Fo(member-if)i Fv(196)2043 1257 y Fo(memq)e Fv(88)2043
1349 y(memoizing)h(65,)f(174)2043 1440 y(message\255passing)i(350)2126
1531 y(vs.)e(Lisp)f(syntax)i(353)2043 1623 y(methods)2126
1714 y(adhere)g(to)e(one)i(another)g(369)2126 1805 y(after)o(\255)e
(374)2209 1897 y(sk)o(etch)i(of)f(357)2126 1988 y(around\255)h(375)2209
2079 y(sk)o(etch)g(of)f(356)2126 2171 y(auxiliary)g(374)2209
2262 y(sk)o(etch)h(of)f(356)2126 2353 y(before\255)g(374)2209
2444 y(sk)o(etch)h(of)f(357)2126 2536 y(of)g(classes)g(368)2126
2627 y(without)g(classes)g(371)2126 2718 y(as)g(closures)g(378)2126
2810 y(rede\002ning)g(372)2126 2901 y(remo)o(ving)h(373)2209
2992 y(sk)o(etch)g(of)f(359)2126 3084 y(isomorphic)h(to)f(slots)f(368)
2126 3175 y(specialization)h(of)g(369)2209 3266 y(on)g(objects)h(371)
2209 3358 y(on)f(types)h(370)2126 3449 y(see)f(also:)27
b(generic)20 b(functions)2043 3540 y(method)g(combination)2126
3632 y Fo(and)2209 3723 y Fv(sk)o(etch)g(of)f(363)2126
3814 y(operator)g(376)2209 3906 y(sk)o(etch)h(of)f(362)2126
3997 y Fo(or)2209 4088 y Fv(sk)o(etch)h(of)f(363)2126
4180 y Fo(progn)2209 4271 y Fv(sk)o(etch)h(of)f(362)2126
4362 y(standard)h(376)2209 4454 y(sk)o(etch)g(of)f(358)2043
4545 y Fo(:method-combination)k Fv(377)2043 4636 y(Michelangelo)d(11)
2043 4728 y(mines)f(264)2043 4819 y Fo(mklist)h Fv(45,)f(160)2043
4910 y Fo(mkstr)h Fv(58)p eop
%%Page: 409 422
409 421 bop 1805 538 a Fu(INDEX)1124 b FA(409)555 801
y Fv(modularity)20 b(167,)f(381,)h(382)555 892 y(de)f(Montaigne,)h
(Michel)g(2)555 983 y Fo(most)g Fv(52)555 1075 y Fo(most-of)g
Fv(182)555 1166 y Fo(mostn)g Fv(52)555 1257 y(mo)o(ving)g(parts)f(4)555
1349 y(multiple)g(inheritance\227see)h(inheritance,)804
1440 y(multiple)555 1531 y(multiple)f(v)n(alues)h(32)638
1623 y(to)f(a)o(v)o(oid)g(side\255ef)n(fects)g(32)638
1714 y(to)14 b(distinguish)i(f)o(ailure)e(from)h(f)o(alsity)f(196,)804
1805 y(239)638 1897 y(in)19 b(generalized)h(v)n(ariables)f(172)638
1988 y(iteration)g(with)f(158)638 2079 y(recei)n(ving\227see)11
b Fo(multiple-value-bind)638 2171 y Fv(returning\227see)20
b Fo(values)555 2262 y(multiple-value-bind)j Fv(32)638
2353 y(lefto)o(v)o(er)c(parameters)g Fo(nil)h Fv(234)555
2444 y(multiprocessing)g(275)555 2536 y Fo(mvdo)g Fv(162)555
2627 y Fo(mvdo*)g Fv(159)555 2718 y Fo(mvpsetq)g Fv(161)555
2810 y Fa(Mythical)f(Man\255Month,)i(The)d Fv(5)555 3021
y(name\255spaces)d(12,)g(205,)h(259,)f(273,)h(384,)f(392)555
3112 y(natural)k(language\227see)i Fu(A)-7 b(TN)p Fv(s)555
3204 y Fo(nconc)20 b Fv(31,)f(35,)g(137)555 3295 y(ne)o(gation)638
3386 y(of)g(f)o(acts)g(249)638 3478 y(in)g(Prolog)g(325)638
3569 y(in)g(queries)g(252)555 3660 y(netw)o(orks)638
3752 y(representing)h(76,)f(79)555 3843 y Fo(next-method-p)j
Fv(375)638 3934 y(sk)o(etch)e(of)f(358)555 4026 y Fo(:nicknames)i
Fv(384)555 4117 y Fo(nif)e Fv(150)555 4208 y Fo(nil)638
4300 y Fv(def)o(ault)g(block)h(name)g(131)638 4391 y(forbidden)g(in)f
Fo(case)h Fv(clauses)f(153)638 4482 y(multiple)g(roles)g(of)g(51,)g
(195)555 4574 y Fo(nilf)h Fv(169)555 4665 y(Nitzber)o(g,)e(Mark\227see)
i(jok)o(e,)f(practical)555 4756 y(nondeterministic)h(choice)g(286)638
4848 y(Common)g(Lisp)e(implementation)i(295)721 4939
y(need)g(for)f Fu(CPS)g Fv(macros)g(296)2209 801 y(restrictions)g(on)g
(297)2209 892 y(and)11 b(tail\255recursion)g(optimization)g(298,)2292
983 y(396)2126 1075 y(Scheme)19 b(implementation)h(293)2126
1166 y(appearance)h(of)d(foresight)i(289)2126 1257 y
(breadth\255\002rst)f(303)2126 1349 y(correct)g(302)2126
1440 y(depth\255\002rst)g(292)2209 1531 y(in)g Fu(A)-7
b(TN)p Fv(s)19 b(308)2209 1623 y(nonterminating)h(293)2209
1714 y(in)f(Prolog)g(334)2126 1805 y(in)g(functional)g(programs)h(286)
2126 1897 y(vs.)f(iteration)f(291,)i(325)2126 1988 y(optimizing)f(298)
2126 2079 y(and)g(parsing\227see)h Fu(A)-7 b(TN)p Fv(s)2126
2171 y(and)19 b(search)h(290)2126 2262 y(see)f(also:)27
b Fa(c)o(hoose)p Fv(,)20 b Fa(fail)2043 2353 y Fv(Norvig,)f(Peter)f
(199)2043 2444 y Fo(nreverse)i Fv(31)2126 2536 y(sk)o(etch)g(of)f(388)
2043 2627 y Fo(nthmost)h Fv(183)2043 2838 y(object\255oriented)g
(programming)2126 2930 y(dangers)g(of)f(379)2126 3021
y(de\002ning)g(features)h(of)f(350)2126 3112 y(lik)o(e)g(distrib)o
(uted)g(systems)g(348)2126 3204 y(and)g(e)o(xtensibility)g(16,)h(379)
2126 3295 y(name)f(of)g(349)2126 3386 y(in)g(plain)g(Lisp)f(349)2126
3478 y(see)h(also:)27 b(C++;)18 b(classes;)h Fu(CLOS)p
Fv(;)f(generic)2292 3569 y(functions;)c(inheritance;)h(methods;)2292
3660 y(message\255passing;)h(slots;)d(Smalltalk)2043
3752 y Fo(on-cdrs)20 b Fv(205)2043 3843 y Fo(on-trees)g
Fv(210)2043 3934 y(open)g(systems)f(6)2043 4026 y
(open\255coding\227see)i(compilation,)f(inline)2043 4117
y(orthogonality)g(63)2043 4328 y Fo(*package*)h Fv(125,)e(381)2043
4420 y(packages)h(381)2126 4511 y(aberrations)f(in)m(v)o(olving)h(384)
2126 4602 y(a)o(v)o(oiding)f(capture)h(with)e(130,)i(131)2126
4694 y(creating)f(382)2126 4785 y(current)g(381)2126
4876 y(using)g(distinct)g(131,)h(382)2126 4968 y(inheriting)f(symbols)h
(from)f(384)p eop
%%Page: 410 423
410 422 bop 555 538 a FA(410)1124 b Fu(INDEX)638 801
y Fv(nicknames)20 b(for)f(384)638 892 y(switching)g(382)638
983 y(user)g(381)638 1075 y(see)g(also:)27 b Fo(intern)p
Fv(;)20 b(interning)555 1166 y(parsers,)f(nondeterministic\227see)h
Fu(A)-7 b(TN)p Fv(s)555 1257 y(paths,)19 b(tra)o(v)o(ersing)g(155)555
1349 y Fo(pat-match)i Fv(242)555 1440 y(pattern\255matching)f(186,)g
(238)555 1531 y(pattern)f(v)n(ariables)h(238)555 1623
y(phrenology)h(30)555 1714 y(planning)f(2)555 1805 y(pointers)f(76)555
1897 y(pools)h(313)555 1988 y Fo(popn)g Fv(173)555 2079
y Fo(pop-symbol)h Fv(220)555 2171 y Fo(position)g Fv(49)555
2262 y Fo(*print-array*)h Fv(245)555 2353 y Fo(*print-circle*)g
Fv(70)555 2444 y(print\255names)e(57,)f(129,)g(382)555
2536 y(processes)h(275)638 2627 y(instantiation)f(of)g(278)638
2718 y(scheduling)h(of)f(279)638 2810 y(state)g(of)g(278)555
2901 y Fo(proclaim)i Fv(23,)e(45)555 2992 y(producti)n(vity)h(5)555
3084 y(programming)g(languages)638 3175 y(battle\002eld)f(of)g(8)638
3266 y(embedded\227see)f(embedded)f(languages)638 3358
y(e)o(xpressi)n(v)o(e)j(po)n(wer)g(of)e(vii)638 3449
y(e)o(xtensible)i(5)638 3540 y(high\255le)n(v)o(el)g(8)638
3632 y(see)c(also:)25 b(Algol;)16 b(Basic;)g(C;)f(C++;)h(Com\255)804
3723 y(mon)31 b(Lisp;)36 b(F)o(ortran;)h(Lisp;)f(Pro\255)804
3814 y(log;)19 b(Scheme;)g(Smalltalk;)f(T)555 3906 y(Prolog)h(321)638
3997 y(assignment)h(in)f(343)638 4088 y(calling)g(Lisp)g(from)g(343)638
4180 y(case\255sensiti)n(vity)h(of)e(331)638 4271 y(conceptual)i
(ingredients)g(321)638 4362 y(nondeterminism)g(in)f(333)638
4454 y(programming)h(techniques)h(332)638 4545 y(restrictions)e(on)g(v)
n(ariables)h(344)638 4636 y(rules)f(329)721 4728 y(bodyless)h(323,)g
(330)721 4819 y(implicit)e(conjunction)j(in)e(body)h(328)721
4910 y(left\255recursi)n(v)o(e)f(334)2209 801 y(order)g(of)g(329)2126
892 y(sub)o(v)o(erting)h(346)2126 983 y(syntax)g(of)f(331)2043
1075 y(promises)g(211)2043 1166 y Fo(prompt)h Fv(56)2043
1257 y(property)g(lists)e(15,)h(63,)g(216)2043 1349 y
Fo(propmacro)i Fv(216)2126 1440 y(alternati)n(v)o(e)e(de\002nition)g
(393)2043 1531 y Fo(propmacros)i Fv(216)2043 1623 y Fo(prune)f
Fv(47)2126 1714 y(simpler)f(v)o(ersion)g(389)2043 1805
y(pruning)h(search)f(trees\227see)g(cut)2043 1897 y Fo(psetq)h
Fv(96)2126 1988 y(multiple\255v)n(alued)g(v)o(ersion)f(161)2043
2079 y Fo(pull)g Fv(173,)h(223)2043 2171 y Fo(pull-if)g
Fv(173)2043 2262 y Fo(push)p Fv(\255)p Fo(nreverse)h
Fv(idiom)e(47)2043 2353 y Fo(pushnew)h Fv(174)2043 2564
y(queries)2126 2656 y(comple)o(x)g(249,)f(335)2126 2747
y(conditional)h(191)2043 2838 y(query)g(languages)g(249)2043
2930 y(quicksort)g(345)2043 3021 y Fo(quote)g Fv(84,)f(391)2126
3112 y(see)g(also:)27 b Fo(')2043 3204 y Fv(quoted)20
b(lists,)e(returning)h(37,)g(139)2043 3415 y(rapid)g(prototyping)h(1,)f
(284)2126 3506 y(of)g(indi)n(vidual)h(functions)f(24,)g(48)2043
3598 y Fo(read)g Fv(56,)g(128,)h(197,)f(224)2043 3689
y Fo(read-delimited-list)k Fv(227)2043 3780 y Fo(:reader)d
Fv(367)2043 3872 y Fo(read)p Fv(\255)p Fo(eval)p Fv(\255)p
Fo(print)h Fv(loop)f(57)2043 3963 y Fo(read-from-string)i
Fv(58)2043 4054 y Fo(read-line)f Fv(56)2043 4146 y Fo(readlist)f
Fv(56)2043 4237 y(read\255macros)g(224)2043 4328 y Fo(recurser)g
Fv(388)2043 4420 y(recursion)2126 4511 y(on)f(cdrs)g(68,)g(204)2126
4602 y(in)g(grammars)g(306)2126 4694 y(in)g(macros)g(139,)h(192)2126
4785 y(without)f(naming)h(388)2126 4876 y(on)f(subtrees)h(70,)f(208)
2126 4968 y(tail\255)f(23,)h(140)p eop
%%Page: 411 424
411 423 bop 1805 538 a Fu(INDEX)1124 b FA(411)555 801
y Fo(reduce)20 b Fv(207,)f(363)555 892 y(Rees,)g(Jonathan)h(A.)e(395,)i
(396)555 983 y(referential)f(transparenc)o(y)h(198)555
1075 y Fo(remove-duplicates)638 1166 y Fv(sk)o(etch)g(of)f(206)555
1257 y Fo(remove-if)i Fv(14)555 1349 y Fo(remove-if-not)h
Fv(40)555 1440 y Fo(rep)p 677 1440 24 4 v 48 w Fv(324)555
1531 y Fo(reread)e Fv(58)555 1623 y Fo(&rest)g Fv(parameters)f(87)638
1714 y(not)g(guaranteed)i(fresh)e(137)638 1805 y(in)g(utilities)f(174)
555 1897 y Fo(return)i Fv(131,)f(155)555 1988 y Fo(return-from)i
Fv(131,)f(154)555 2079 y(return)f(v)n(alues)638 2171
y(functions)f(as\227see)e(functions,)i(as)f(return)804
2262 y(v)n(alues)638 2353 y(multiple\227see)i(multiple)g(v)n(alues)555
2444 y(re\255use)g(of)g(softw)o(are)g(4)555 2536 y Fo(reverse)h
Fv(30)555 2627 y Fo(rfind-if)h Fv(73,)e(210)638 2718
y(alternate)g(v)o(ersion)g(390)555 2810 y Fo(rget)h Fv(351)555
2901 y(rich)f(countries)g(285)555 2992 y Fo(rmapcar)h
Fv(54)555 3084 y(Rome)f(283)555 3175 y Fo(rotatef)h Fv(29)555
3266 y Fo(rplaca)g Fv(166)555 3358 y(rules)638 3449 y(structure)f(of)g
(322)638 3540 y(as)g(virtual)g(f)o(acts)g(323)638 3632
y(see)g(also:)27 b(Prolog,)19 b(rules)g(in)555 3843 y(Scheme)638
3934 y(vs.)27 b(Common)20 b(Lisp)e(259)638 4026 y Fo(cond)i
Fv(192)638 4117 y(macros)f(in)g(392)638 4208 y(returning)h(functions)f
(in)g(62)555 4300 y(scope)h(16,)f(62)555 4391 y(scoundrels,)h
(patriotic)f(352)555 4482 y(scrod)h(219)555 4574 y(search)g(trees)e
(265)555 4665 y(sequence)j(operators)e(244)555 4756 y(series)g(55)555
4848 y Fo(set)g Fv(178)555 4939 y Fo(set-difference)j
Fv(207)2043 801 y Fo(setf)d Fv(165)2126 892 y(see)d(also:)26
b(generalized)17 b(v)n(ariables,)g(in)m(v)o(er)o(\255)2292
983 y(sions)2043 1075 y Fo(set-macro-character)23 b Fv(224)2043
1166 y Fo(setq)2126 1257 y Fv(destro)o(ys)d(referential)e(transparenc)o
(y)j(198)2126 1349 y(ok)e(in)g(e)o(xpansions)i(100)2126
1440 y(no)n(w)e(redundant)i(170)2043 1531 y(Shapiro,)e(Ehud)g(398)2043
1623 y(sharp)g(\()p Fo(#)p Fv(\))g(226)2043 1714 y Fo(shuffle)h
Fv(161)2043 1805 y(side\255ef)n(fects)f(28)2126 1897
y(destro)o(y)h(locality)f(36)2126 1988 y(in)g(macro)g(e)o(xpanders)i
(136)2126 2079 y(mitigating)d(35)2126 2171 y(on)h Fo(&rest)h
Fv(parameters)g(137)2126 2262 y(on)f(quoted)h(objects)g(37)2043
2353 y Fo(signum)g Fv(86)2043 2444 y Fo(simple?)g Fv(242)2043
2536 y Fo(single)g Fv(45)2043 2627 y(Sistine)e(Chapel)h(11)2043
2718 y(sk)o(eletons\227see)h(macros,)f(sk)o(eletons)h(of)2043
2810 y(sk)o(etches)g(284)2043 2901 y Fo(sleep)g Fv(65)2043
2992 y(slots)2126 3084 y(accessor)g(functions)f(for)g(365)2126
3175 y(declaring)h(364)2126 3266 y(as)f(global)g(v)n(ariables)h(379)
2126 3358 y(initializing)e(365)2126 3449 y(isomorphic)i(to)f(methods)g
(368)2126 3540 y(read\255only)h(367)2126 3632 y(shared)g(367)2043
3723 y(Smalltalk)e(350)2043 3814 y Fo(some)2126 3906
y Fv(sk)o(etch)i(of)f(206)2043 3997 y Fo(sort)g Fv(14,)g(352)2043
4088 y Fo(sortf)h Fv(176)2043 4180 y(sorting)2126 4271
y(of)f(ar)o(guments)g(176)2126 4362 y(partial)f(184)2126
4454 y(see)h(also:)27 b Fo(stable-sort)2043 4545 y(special)20
b Fv(17)2043 4636 y(special)f(forms)g(9,)g(391)2043 4728
y(specialization\227see)12 b(methods,)j(specializa\255)2292
4819 y(tion)k(of)2043 4910 y Fo(speed)h Fv(23)p eop
%%Page: 412 425
412 424 bop 555 538 a FA(412)1124 b Fu(INDEX)555 801
y Fv(splicing)19 b(86)555 892 y(splines\227see)g(Bezier)g(curv)o(es)555
983 y Fo(split-if)i Fv(50)555 1075 y Fo(sqrt)f Fv(32)555
1166 y(squash)g(160)555 1257 y Fo(stable-sort)h Fv(352,)f(399)555
1349 y(stacks)638 1440 y(allocation)f(on)h(150)638 1531
y(of)f Fu(A)-7 b(TN)19 b Fv(re)o(gisters)g(312)638 1623
y(in)g(continuations)h(260,)g(261)638 1714 y(use)f(for)g(iteration)g
(264)638 1805 y(o)o(v)o(er\003o)n(w)g(of)g(396)555 1897
y(Steele,)24 b(Guy)g(Le)n(wis)f(Jr)l(.)41 b(ix,)24 b(43,)h(213,)g(395,)
804 1988 y(396)555 2079 y(Sterling,)18 b(Leon)h(398)555
2171 y(strings)638 2262 y(b)o(uilding)g(57)638 2353 y(matching)h(231,)f
(244)638 2444 y(as)g(v)o(ectors)g(233)555 2536 y Fa(Structur)m(e)11
b(and)g(Interpr)m(etation)g(of)g(Computer)804 2627 y(Pr)m(o)o(gr)o(ams)
19 b Fv(18)555 2718 y(structured)g(programming)i(100)555
2810 y Fo(subseq)f Fv(244)555 2901 y(superclasses)638
2992 y(precedence)h(of)e(369)721 3084 y(sk)o(etch)h(of)f(352)555
3175 y(Sussman,)g(Gerald)g(Jay)g(18,)g(395)555 3266 y
Fo(symb)h Fv(58)555 3358 y(symbols)638 3449 y(b)o(uilding)f(57)638
3540 y(as)g(data)g(385)638 3632 y(e)o(xported)h(383)638
3723 y(imported)g(383)638 3814 y(interning\227see)g Fo(intern)638
3906 y Fv(names)g(of)f(57,)g(129,)g(382)638 3997 y(see)g(also:)27
b(k)o(e)o(yw)o(ords)555 4088 y Fo(symbol-function)22
b Fv(12,)d(388)555 4180 y(symbolic)h(computation)g(398)555
4271 y Fo(symbol-macrolet)i Fv(105,)e(205,)f(210)555
4362 y Fo(symbol-name)i Fv(58)555 4454 y Fo(symbol-package)h
Fv(381)555 4545 y Fo(symbol-value)f Fv(12,)e(178)555
4636 y(symbol\255macros)h(105,)g(205,)f(236,)h(237)555
4728 y(sw)o(apping)g(v)n(alues)g(29)555 4939 y(T)e(396)2043
801 y Fo(tagbody)i Fv(155)2043 892 y(tail\255recursion)f(optimization)g
(22)2126 983 y(needed)h(with)f Fu(CPS)g Fv(macros)g(298)2126
1075 y(testing)g(for)g(388,)g(396)2043 1166 y(taxable)g(operators)h(32)
2043 1257 y(testing)2126 1349 y(incremental)f(37)2126
1440 y(of)g(macros\227see)g(macros,)g(testing)2043 1531
y(T)2077 1548 y(E)2112 1531 y(X)g(vi,)f(5)2043 1623 y
Fo(tf)h Fv(169)2043 1714 y(Theodebert)h(236)2043 1805
y(three\255v)n(alued)g(logic)f(151)2043 1897 y Fo(till)g
Fv(154)2043 1988 y Fo(time)g Fv(65,)g(359)2043 2079 y(times)f(of)h(e)n
(v)n(aluation)i(224,)e(229)2043 2171 y Fo(toggle)h Fv(169)2043
2262 y(top\255do)n(wn)g(design)g(3)2043 2353 y Fo(trace)g
Fv(111,)f(266,)g(309)2043 2444 y(transition)g(netw)o(orks)h(306)2043
2536 y(transformation)2126 2627 y(embedded)c(languages)h(implemented)e
(by)2292 2718 y(116,)k(241)2126 2810 y(of)g(macro)g(ar)o(guments)h
(107,)f(112)2043 2901 y Fo(trec)g Fv(75)2043 2992 y(trees)g(70,)g(262)
2126 3084 y(cross\255products)h(of)f(265)2126 3175 y(lea)o(v)o(es)g(of)
g(72)2126 3266 y(recursers)g(on)h(70)2043 3358 y Fo(true-choose)2126
3449 y Fv(breadth\255\002rst)f(v)o(ersion)g(304)2209
3540 y(T)f(implementation)i(396)2126 3632 y(depth\255\002rst)f(v)o
(ersion)g(396)2043 3723 y Fo(truncate)h Fv(32)2043 3814
y Fo(ttrav)g Fv(74)2043 3906 y(T)m(uring)e(Machines)j(vii)2043
3997 y(twenty)e(questions)h(77)2043 4088 y Fo(typecase)g
Fv(62)2043 4180 y Fo(type-of)g Fv(371)2043 4271 y Fo(typep)g
Fv(243)2043 4362 y(types)2126 4454 y(declaration)f(of)g(23)2126
4545 y(specialization)g(on)h(370)2043 4636 y(typing)f(44,)h(112)2043
4848 y Fo(undefmethod)h Fv(373)2043 4939 y(uni\002cation)e(394)p
eop
%%Page: 413 426
413 425 bop 1805 538 a Fu(INDEX)1124 b FA(413)555 801
y Fo(union)20 b Fv(206)638 892 y(unspeci\002ed)g(order)f(of)g(result)g
(207,)g(364)555 983 y Fo(unions)h Fv(207)555 1075 y(unspecialized)g
(parameters)g(373)555 1166 y Fo(unwind-protect)i Fv(148)555
1257 y Fo(:use)e Fv(384)555 1349 y Fo(user)g Fv(381)555
1440 y(utilities)e(40)638 1531 y(as)h(an)g(in)m(v)o(estment)h(43,)f
(392)638 1623 y(become)h(languages)h(113)638 1714 y(mistak)o(en)f(ar)o
(gument)f(against)g(59)555 1925 y Fo(var?)h Fv(239)555
2017 y(v)n(ariable)f(capture\227see)h(capture)555 2108
y(v)n(ariables)638 2199 y(bound)h(16)638 2291 y(free)e(16,)g(121)638
2382 y(generalized\227see)11 b(generalized)g(v)n(ariables)638
2473 y(global)20 b(36,)f(125,)g(268,)g(379)555 2564 y
Fo(varsym?)h Fv(239)638 2656 y(rede\002ned)g(335)555
2747 y(v)o(ectors)638 2838 y(for)f Fu(A)-7 b(TN)19 b
Fv(re)o(gisters)f(313)638 2930 y(creating)h(with)g(backquote)i(86)638
3021 y(matching)f(231,)f(244)555 3112 y(visual)30 b(aspects)h(of)e
(source)i(code)g(30,)h(213,)804 3204 y(231)555 3295 y(v)o(oussoirs)19
b(8)555 3386 y Fo(values)h Fv(32)638 3478 y(in)m(v)o(ersion)g(for)f
(393)555 3569 y Fo(=values)h Fv(267)555 3780 y Fo(wait)g
Fv(280)555 3872 y(W)-6 b(and,)19 b(Mitchell)g(395)555
3963 y(W)-6 b(eick)o(er)m(,)19 b(Jacqueline)h(J.)27 b(x)555
4054 y Fo(when-bind)21 b Fv(145)555 4146 y Fo(when-bind*)g
Fv(145)555 4237 y Fo(while)f Fv(154)555 4328 y Fo(with-answer)h
Fv(251)638 4420 y(rede\002ned)f(255)555 4511 y Fo(with-array)h
Fv(234)555 4602 y Fo(with-gensyms)g Fv(145)555 4694 y
Fo(with-inference)h Fv(324)638 4785 y(rede\002ned)e(335,)f(340)555
4876 y Fo(with-matrix)i Fv(234)555 4968 y Fo(with-open-file)h
Fv(147)2043 801 y Fo(with-output-to-string)h Fv(58)2043
892 y Fo(with-places)e Fv(237)2043 983 y Fo(with-slots)g
Fv(236)2043 1075 y Fo(with-struct)g Fv(235)2043 1166
y(writer')l(s)d(cramp)h(44)2043 1257 y Fo(&whole)h Fv(95)2043
1349 y(W)-6 b(oods,)19 b(W)m(illiam)e(A.)i(305)2043 1440
y(w)o(orkstations)h(348)2043 1531 y(w)o(orld,)f(ideal)g(109)2043
1743 y(X)f(W)m(indo)n(ws)i(vi,)e(5)2043 1954 y(zebra)h(benchmark)i(396)
2043 2165 y Fo(#')e Fv(10,)g(226)2043 2257 y Fo(#\()g
Fv(233)2043 2348 y Fo(#.)27 b Fv(75)2043 2439 y Fo(#:)g
Fv(128)2043 2531 y Fo(#?)19 b Fv(226)2043 2622 y Fo(#[)g
Fv(227)2043 2713 y Fo(#\\)g Fv(233)2043 2804 y Fo(#)p
Fe(f)g Fv(229)2043 2896 y Fo(')g Fv(225)2126 2987 y(see)g(also:)27
b Fo(quote)2043 3078 y(,)19 b Fv(84)2043 3170 y Fo(,@)g
Fv(86,)g(138)2043 3261 y Fo(:)27 b Fv(383)2043 3352 y
Fo(::)g Fv(382)2043 3444 y Fo(@)19 b Fv(294)p 2047 3535
24 4 v 2090 3535 a(240,)g(252,)h(328)2043 3626 y Fo(`)f
Fv(see)g(backquote)2043 3718 y Fo(|)g Fv(58)p eop
%%Trailer
end
userdict /end-hook known{end-hook}if
%%EOF
